

// ==UserScript==
// @name           ThalKOC(english)
// @namespace      thal
// @include        *apps.facebook.com/kingdomsofcamelot/*
// @include        *kingdomsofcamelot.com/*main_src.php*
// @include        *kingdomsofcamelot.com/*fbLoginButton.php*
// @include        *kingdomsofcamelot.com/*standAlone.php*
// @include        *kingdomsofcamelot.com/*platforms/kabam*
// @include        *kingdomsofcamelot.com/*acceptToken_src.php*
// @include        *kingdomsofcamelot.com/*helpFriend_src.php*
// @include        *facebook.com/connect/uiserver.php*
// @include        *facebook.com/*/serverfbml*
// @include        *facebook.com/dialog/feed*
// @include        *facebook.com/dialog/stream.publish*
// @include        *facebook.com/dialog/apprequests*            
// @include        *kabam.com/*
// @resource       IMAGENES http://thorastur.99h.com.ar/powerkoc/imagenes.js
// @icon           http://img39.imageshack.us/img39/391/359097malkavian.jpg

  // @description  Automated features for Kingdoms of Camelot
// ==/UserScript==

var Version = '1.0';
// These switches are for testing, all should be set to false for released version:
var DEBUG_TRACE = false;
var DEBUG_SEARCH = false;
var ENABLE_TEST_TAB = false;
var DISABLE_BULKADD_LIST = false;
var ENABLE_GM_AJAX_TRACE = false;
var SEND_ALERT_AS_WHISPER = false;
var DEBUG_BUTTON = true;
var DEBUG_TRACE_DRAG = false;
var DEBUG_TRACE_AJAX = false;
var DISABLE_POST_KNIGHT_SKILLS = false;
var DISABLE_POST_DEFENSES = false;
var ENABLE_SEARCH_TAB = false;
var ENABLE_TEST_TAB = false;
var TEST_WIDE = false;
var TEST_WIDE_CITIES = 7;
var History=[];
var ENABLE_SEARCH_TAB = false;
var ENABLE_WILDS_TAB = false;
var ENABLE_KNIGHTS_TAB = false;
var ENABLE_INFO_TAB = false;

// end test switches

var MAP_DELAY = 1300;
var DEFAULT_ALERT_SOUND_URL = 'http://thorastur.99h.com.ar/powerkoc/fliegeralarmsire.mp3';
var SWF_PLAYER_URL = 'http://thorastur.99h.com.ar/dewplayer/alarmplayer.swf';
var DETECT_LEVEL_FS = false;
if (typeof SOUND_FILES == 'undefined') var SOUND_FILES = new Object();
if (typeof SOUND_FILES.whisper == 'undefined'){
	SOUND_FILES.whisper = new Object();
	SOUND_FILES.whisper.MP3 = 'data:audio/mpeg;base64,//IxxLuVAA2QWnDQeYYpw+1AqAU51E4QhtAYWwDTYgg4d4Bi4AEQ+GWERyw+AyPzaER3j4DI+G0IjtD4DJ+bRkfz4HT8/w/+vApBiTvX//IzxL53CAvIeojwyEZJ6WW8rWkITCFCEjARhRJMKQEKiigrY2Lk+XE2FkcKyOG9NKcOFZeFXwFK4AIAJZARDBvPJVgwBeCv/13ln///L//yMcTtIBgMsE6ntmiEKpRM0mCYcFhgLgyOLiaUJ8WGuYfWRchJxyD4DwXJJJIJBANyO4VbP0u99FMb5lb6/1mMW4a8jqckfABpokf5c//yMcQvlSQL+J6eWMGKTihxFNi0oXZ/od3NIAHLJJJJQACmT//cu4u38uHlNw4etCPVxzQbMk1hGRSu4Kn0Yk+2yPoyDNKD2goPfb/////yM8RhqDMLgSaeWHjEk/gGwb3Uyjr5uJhbmHFkYaimocRYu9Ig0/NZgjBc0oifArnpc551E9Ud67FfAkeAeGdt+PwCMhpZbNdaLlD/BGT/8jHE4IVFDBjCllhoxmySimRxiGelWBo+nQfpmXSpmhloIBn/5uk4z+TmW6YAWSCySSSwDj/mMSJmbTb5hIIAdlz1Sj/92pun9tH1+xz/8jPETWhTDHDCm+aYxGyQSUoWPRvylCYDqo0nFKJf//Yxm9M3PwmffcMZSYAIDQ/9Qf4jP5QH1BiXf/KGBOLznKHP/wQ76xOXZl9tudNg//IxxLrEYQpIdrO2aERKAGrostQgMBMS0AMrWnDhVgkEM8do5+cD3m1mTKWdOIZ5bwU5wECmeoOI0aj/nz/s6gx9H7vpIfq/rgB4TEAn//IxxDSzdgywdruHSzACpClr/qMq0US6xKgOAgY5YGqief//0m9TUdXo6k+pJJMLcBxxNGqL////62pFgyJ5AwAx6cAoCLJIqgFCoAAI//IzxJ+0gg9wvxZ/gjACglMgjtih3/j7MOG5uxRAoQA4W8NsWgn7f+Zsv99vR5W+ZkYCSQZpNNv///+dZSyNMkTAPIA1hFLE4ga1AAljU//yMcQ1b4QQUc7WedSgATCe2KIGf9S0OUDCaCgwPuUEnNH+3/rev7b/1n/rNA1UG8JpmCv///9b5QSUiPgBiEVQUe///0kAbJCII6Qogf/yMcS+IYEPecrPGD0olZ/6IowoouRwfKB7hwsk/fqb/1fVvtf61eyiyDUKHgNE0lf///63zpgUBzw5MDIJxJy057/+3lIDxIwCYjUa+P/yM8SOI4IOqcLX5i0olNgcCMZsSBqOQiAC2bf/RToLT6C09PqpsszSLiKen0ToVpv//6boJnCUMzdBBqH+pILsaokiMgASiIY1+xnMZyn/8jHElpeHD7HKz74tKJRmQgwLiJNC7P/9FBOukyloqb7tVpwAM05H+gXH//0OdCIA8wmubX+1BZb//vCqmkQDaAAWrEADfGdBj6EWGAL/8jPECDqHDunG7ngLWpRVJwfT3/7oLoKW9JtXQ+sRJazfqHE3//6qweSX3//UNz//+JlOLwAJYmBemmhV/kM5EsD8FXOjmAC82//RXRXS//IxxCXmiw7xwuu0E1SU1v+v5wBjFC36xDt//q+sKEM7W//kb//7VUEAfsyCHccY3+GMrsOagmCBa2Q0Y8BYMd0f9lHK1oo0la0eXuio//IxxCD/jg05wuZOE1qUxANqMiZfSphl0k2Un/9NbUbhhEKSPW/1dYhzAAhzQgeHW3AN/oVnYOoTeCuiAjGAZClzf/paLVt6T819kwBq//IzxNYgmAzpvu/eC1qUg/mh9vmQEIbf//6jgEW3/+sTl/6FAHbMgqFE2Gv//GqQ6FjOAhXgZ8EO0aIBXIhWc9/rRPMpDVY/vyv6ywEnQv/yMcQ1f6QP6b7eeBUmlLY6Vl+swBMUPGr/6u2bg5sndvfUvQBusaUPAAhSMgeKagM/xqotUAaFwGjA6g+UAKQO12f/tr663/Q92Dniqf/yMcRJuKMOIcLn5hTalDv9hzyW1f/X+RQK3//iOUf6fQAIUzMJl2Nh3+OOex5YiQEBYKxBZwmwDBoS8ue/1Jsoy6nW9S9RR1LOD7AIov/yM8RL46kRGcbOeEUolCC56q9aiyEjpFVX/+3XiRBRn/V9lnATBIIACFMyCacbQZ/jEWciwKAgGsJAhSYGFEF9V/+6q9emlQ829EyBuwP/8jHEb4mkDZHC0+QtIJR6NUP0xCEhWr/+r8pA9Mr/+sV9hwAIMzMJl1tBn/IeogPsGigAYaWx3AHWSQdkP9ban2r1JctemUAMOqFgTKn/8jHE7mysEWnCyxg9KJTXWZAQDEk1f/1/UGoBQUa//8QkAAhzMwmXW0Gf6kVCiSwQoAFJY6RBIAKOPSKS/9SOtCg+1DzfVUUQErRSpkb/8jPETqulDpHC1xgtIpS/WYAPAEhof/a/SCQQNKX//xSfAHjMwmZY1AGf6uWzlUOiB4ockWsAQcYqpf961dtvrMPY2AZAJmXH+o6BUpI6//IxxF02qg+Bvs8YLSiUn/9V9agkocT//6xjP9MACVMzCqkbQZ/lORyHUBUWA1uHJEcAY4STidH/n3rS0lKah1F31mAG4RBJ/3E+ltq///IzxFtWqw+pvs8YLSiU/r+gCaFEf//ODk0AdsjCZciQM/0PKUHx8Am7ACXFUkAUtD2ed/+g9LWjUjSR5b9RZAWUlM4b/WcAqGLi7N/6qv/yMcQfuKwOucLPvi0mlN0RxhdY///piAScAAhTNAqpY0Hf5SdRUASRgKMB9Bq0DMBiImyKv9BF6Lepe2subVk0AJoWJE+n8xBvOSPV///yMcRGcLAO6b7PGC0ilKdm0QhCIal//xglAAhCIwiJGkwDP8eNPY9jYEgYMeDqE2AgHmCak//0u1JOrqMdS3KIK+N5N3+4YpK//+1rzP/yM8TpJ7MP6cLCeD0olMJuXUP/60hR0uroAAlSNAinJGDP84g5h5ZIMgAp1FeEJwNiAHeaJpP/vo96k6keW/nQGQprP/oA3mQ7f+86pcz/8jHEM3azD5m+yxg9JpTC0gQ88/1+2PkZpeEACDIjCZkaQc/yqHoeQFkEBwBiiOUK+ANIIibIt/onKj+g1TsrrLnzAD1CoZpfnQhFu///8jHEWWWzD8HCw+Y9JJTt6ywELHF//6ImjQAKUiQKqQSUAz/HUHzDyhfCOhQKYfsEgnFqX/zW5qgyTqZ6uoq/OADp5b/xAT//vUuoxBv/8jPE0wqzEAnCwxg9JpQfHl//vi8Iqzs14wAJgzQKmwRhz/NLyil0QaugGnZGh04BWobZo6n/zySnZDa60mzhP/SAL5Nb/qDG///QneZg//IxxOctsg95wr8YVSSUBKPbfr98aw09AAljNAqrA2K3+XD5qkxeICBVgBd+LSGLwN0QGRNkUP84zy8q5rSTZTaY0n8pgdAprP/qCzn///IxxKxmsw+JvsfmPOCU/XuyyUBORQX+r+Xgyq0ACII0CqsFlAM/0dHkorYHVhXQyYAAWXE1L/76KVarvU2dKn4Cslf+JT//6qmdIxAF//IzxPI2sw9hvr8YVSSUxgpL/9sa44v6jwAJQiMKqsSCt/qTMKBfJgEIkC4YWa4FsRCnn/6LvNndBFklVK0B2+oogMnP/xBD//o1oZTACP/yMcQgl7UQ+b63GG0mlYo55/t7XFpEGIgAClI0C7skgJf56kCmEZcCHoDcidC/oH5hETZFTf07TVOg93UpHURN+5wAqmn/2FTPdX/pbv/yM8QEOLAOkb7D5j0glMspBLiLI/q/mAfVBwAJYiQLqyWBz/KkJkwqZBHIfAwoAAwqCaC/9Z5DTos6LoINrL3qJ4ATJvP/phdTf//RqXn/8jHE+a61D+nCtxhtIpSgJ0BEJt9f6zILm8EACEIkCqjkmAJf5p6UKlgEh4IpBHEBAYdEmaOl/qdtFkHUit1I8o+s4AtJLf9QqJdv/S3/8jHEXlK0ECHCuxhU5JR3RAL4Uql//zosvW7QAApSNAqdbICX+YYdcwzFyg7KKSE2gaQAO02RV/11I0FOpHU2oifWkYgJkqpv+sQuWtX/8jPE8rayD8nCvxhU2pT/1250GikTQ/V/QFKsAAlSEwqbbGK3+kozQTLhfBIUA1ZLwxwNQKS1L/3Uko4yPdGptZNeyQEwhTF/0xBUrtX///IxxPLlsg/5wrvmVRqU9VezitQ8bf/7jDcAC2IkC61FoQ/5KYRoeQGINOA3hNhKYHMBJmiaH+ykp2iupJloIah5bpoAFIqGbfqDJv/+//IxxKBusQ+5wrsYVSSUnT5kBSB9kf1+1RZEoNIASEETCaskgofvTRZ1nCyDVwEtlknwXQWnZf+yNzldKpBzi9RE9VRKgU5fW36Iy5LP//IzxKgusQ+BwrcYbSCU//a/UEMLlX1/4vX5AAphIwmrLYK3+x9nY/EdAxOLNFJAY0OTyKX/Qd3N70F0FKbWUPRKQN0CSRPfrFCm7IP/9P/yMcSk0bMQWcK3GFTilK96AQ4QI9//4vn9AAlREwqrbYK3+is0TQL5oGDwL6Lo6QIgWpbf601LMNdNmZZ7USvuYAS4OBz38QAjtWv/zv/yM8Q6tbAPEcKzGGzilP1BMgE4///EFfoACmIkDK12oJf5NHh5hGoIZhc8eGQAK6VDdn/0S5N3rQe1lGvJLoqLIQU6pH9Qlxp//Uh9YvD/8jHEEo2zD5HCsxhtIpQrf6v6hTHZAApiEwqdtqGX/NmVSMSkDSIF4HC0Dvltn/7oss1WgpSTaR7kg3Y2DCgmRgf/Yc4bydX/0lP1ihj/8jHETpazD1HCsxhs2pQqf6v8VujvAAlyJAuvvsK3+fYzZzRYrUKSSBDOgBADVJH/qNqCkkHWp1skjqIv1JlAEME459/rEvJFNkvb9f7/8jPEoba0DxHCtxhU4pRSBgf/X4oB2wAIYhAKr77Bq/3QM0Ey4XwSIA30vEOC9KH/11s6jy1LSUs42sh1Woohb+Ki5/tpiQkmgy//mH5w//IxxBKWtw+JwrMYbOKUHr/21dYt7QAJYSQLv77Bq/zpgZqWcWEmFpTGTALornn/7mCSjqSKJ9nXdDjl+TwAnSGi7fUHIG5Ctf/v9Yxw//IxxNrutw/RwrcYbSSUF1/19fisAAtyJAq//+K3+kYGNZkYg1ECozE+DsHnZ/9JbzjupBnUkkhyX1VlgGkE8Ymn6g/I0ur/5j3ohuw3//IzxIF1tg+5wrMYbOCUl/19XiZOAAthFAifvsEJ/sYIJoF9REgfYho6gbbmyKX/u7mb7OtrNrIg3UiFo5Vc9+iKTKupJer859YTpBVft//yMcRd6LcPeb6zGGyalF9YjRkBRABuNtsQIT+xsgy6aAf8FUiUQ9JP6n/0Nms22ox9SYDyU2PfU4mJag3/6f0wGqHG36v5wRt//+noaf/yMcQWLbgPmb63GGzklAcLgFuNhuQI3+pTLQTgLYmUoAJE8/3/09SqN7chP0TgA9Gk9+oO3//Q+kJYGZn+r+dE+X1lEvZoXfbohRw3G//yM8RqFbgPccKvGGzilIBEjbbkDV33Z1OtS1AwgmFFwDzdv/ZGyG/bbWafOgWUVN+sT89//v9QHwhN//sJT4tY96tC78xkHGCJAThKcjb/8jHErR26DuG+r7ZsWpbbkDV9krski64m0GWIcM6GOLUt9Fvp6Ouh7ajvuoFYPq/xyv//o/QB6KH9f9xffxTvyec/IR+ARI2G5Aanqzb/8jPEmaW9DzHCr45rWpZJlKN2TUmM4DxLxwMEnn/90q09Wku6HIWvUBnspuvUHK//3erogj42u31duVk71rEvij3qMxRkvoXwAcYCcrbb//IxxM2dwA7pvrOOa1qWlFb9mSNnQdCGAHKo2Bzu339epCynW9bI60Pw8Or+saW//2+mGyU2//2G13av/2OQsKGkKS/SpLIJLQS7XVN8//IxxL5Sww55vrO2bNqWxEJRMpDliEC1et61al09O7q0LqKOtqwQbK9T4mn//feicAYhSRV9rb5ELrOzFlISx5lK2Jvht8tRG4Bcjbbk//IzxJJ/yBDJvquObJqWCN99K7VLBiD2syBUoP66+69BBa/UtDSN/wyVerjv/9vb7C3LH//ycQ/Pr3UNsHpRdex5PgHIAnI3G5AjfdBSV//yMcSllMQOcb6ztmtalkGXDsBXMSSBVui/t/U/WtmVbWbfinU38cCq7LXtbr+sNk3//6x19CFIRo+5alINNgHGSpZHHJAjfTSp1WdiaP/yMcQ4VskQyb63jlQalipiiNcPyWr1I+ynWtktfW2dKFlcUGU38e/pM1uqv9QViX6+1sZy92HnGHdNtz71LAHYSpJJJLRW+npJHKBvFv/yM8T7vsQOYb6vjmtalrB6MTQLknn9K1t3qv/bQNfdQU6Fv45H//0eqgOpGfX3/nRkM/WAi6k2zssQc+qiWNsAVkqSSSS0Vv9E2VUmoDf/8jHEFY/KDsnCr7ZrWpaEsiTAPNJvv9t+/2qUb09UPLqar5Cb3V29LqrCJRf1V/zg9fONECou5JOp7Hi7lGcBxkqSSSSwI323qqTQCWL/8jPEY7TND7G+r7Zs2pbgODkh+S1e6n2ZegupbbuzqWZXsioCjMkgvVZES1NbVLf/RrVuMkW7f/6Qt3/95K2JWLyiYotIbp388zQByEqW//IxxLomzg/pwre2bFqWSSS0Vv1UE0q2cPoCgZGgKSz/Q9ltTt7Ovz2rWFamr/GhL//V9IQhSb//WSB3kluvJNMyS0gQJFROgaTIpgFG//IxxM0RzQ+xvre2a1qWAm5JJJAjfq3SU7WBApJB7dvUv77WXZbtpMkU/qBwJKXbXWS56+trfr21A9FD/VrqqHb9VX8l13OpAcZIkkkk//IzxBsNzRK5wq+2bBqXsCN+p2U6lmCweABlMh3gpiP0H067Mkr3rWzup2ZqATLJ9ahQvrV+3QzXMC6D56qmt99Qvk9q90wx3Vs9TVKtP//yMcSVdcIQMb63tmtalrre+t7EAcZIlkkktBL7JW89FhEEi5eBbUPrd77WTZXX22N74Bro/vhR/p/v3qB4t//8O+hT4GGVvQpxCG/RAP/yMcSCt8AOwb6vtmtallpKlkkktBL/zjmSH4HOibA/O3/Uvskrtrbl/VAnGd6dy3b/zfwZbv/+T/TelwNsXXJUUYwByEiWSW20Vv12ev/yM8Sgh8QSkcKvtmtUl2ifRNgrIrEGN+3d63drN/rNNXEnRb/Itn3ZCntc5apbBBn0GdaVV9qKcdElmuEKQt7RNDMGdFBdxAsB1khySST/8jHELQq5DjnCt7ZTTpaUI37PNrqTUHcCBGJMCvV+3vej79Nn1Z3VlByL77LdyxeYun31b1A0N9faiasL/br7r6mniYmJrgHWSpJJJLD/8jHEq8O/DUHCt7ZTVJYjf3RempNQNI+IF0FqTV6l2v6qCW+utzvoCI5ZrWfGBf12rS/asPRtN/b+PewRBwDCR4GNGHAZCPSmha4B2kv/8jPEtdrJERG+s7ZsGpaWW2W0Vv1VoJug0WIQiR4PLP926061/62Y9iLZxyg6Fnno6MKjEZHsbaZ0+4he99/peET9p+ODChdo4efjRxFL//IxxEgxxA9xvq+2a06WYs1UAEZIkkkkkCN/sp7s5cAIqSQKt/upd2WtqD17WW3L61UGTUpfzi06n9bL9g9J099kquovcVppizSd92zd//IzxL8WxRCJvq+2a1SWm6kASEiSSSSQGr/WgnTQWFACpSJ4TRf57tSZT+vZbckV7Y4Xvz0uM2ojO/Nbt2dgzdq216nNjDmjTIoxS31OYP/yMcQg8MIRab63tmtOlpGNur8AWFCSSSSQI3+tBNJFSwxDBnRxAOVD6SL3rVSb7a/XszBbfbVR12Z/3/9RCL//+4+j0Jyd3d7dNQG4SP/yMcSmb7sPccKvtmtUlpJJJLAZP03WyabG8TYBfMT4OZ/sm6361PrfunqpWorgvLZjO2o02X/2Nt46G2tovVpjRxOvOmmWPTdjCywkQP/yM8T/aLwQYcKrtmtUllrLzHfLogHISHJJJJAavqXdBbmKbEmApIogsG/etVak2Wi7O76qmO2dHBXW7ubiST7N2omj3nDgb5t769yO0PX/8jHE3vu6Ddm+r7ZrTpa/0LsW5CkBSJOSSSSQI3+ipNNAzUBvAcSI7AmalsnopMmq91sj+51DYujrNiMydUW5Xtf+l6+IDv515/jb77H/8jHEzCnBEeIaq7ZrTrco6Edi9a4BRkiSSSSQGr/dl61BpJBRiFWf6LMi7r60aKkVo1oUVHfSFXdOtXS23Oayq/6iAtWd7PXyLtAg0ab/8jPE0IO4D8l+q7ZrSpI9nU158Jl2rARISpJJJJAant+gmeU0QoPiRqGRn+asi1B0JrZd21tZS0syAIjMzS0QzJ/dk+mZIZ9P3c8furdf//IxxJy3uA+xvq+2a06W75KDedah9M0FRlCSSSSQGrb7rN2s6IIEyJwF+l9TWZdWkqi6oWbPzvHupOhqDdJvr0vZ8JirsTWtjBYpxr7O//IxxGUQuBAxvqu2a06W69zJSXk0pgFIk3JJJJAZP1s6CTLQWJAC5KRDw+JNDrd97LsvUgptNb6LSaC/QyHMIfat67fWAp67b6+w5D+///IzxNZstg/Jwqu2a0qWYf5CKrGKrTQFyEiSSSSQGptWn0mWYLD4PFJIPLfd9aFLVTelKrT1sgGd26Ni5G0+t/k4QePKF5BjBGuO+pYIFf/yMcTUQLYPSX6rtmtKknpcXfS6xDCWBcqTkktttFHfZdJFJRmlCCGWskgq6TdnZK/u/6qfTyYAl2xqVFamKd1a07MrUXcSI8yqvVuii//yM8RhGLcP2b6rtmxKlhjbcU130Gat2uZm3r9qjjr7CFiTkskltFbf6kEq0ofgZzpJiXJ31KZd9SdFf8rN/wLr+56a/t/VQbv/neWq0/r/8jHEuCq3D+l2q7ZrSpJ0xWZT3f/K7Qf9gpGx5Qi5CkiMttt22ABPkR+xVGeNsxrG+E6fmYOrcp02dP4FbR6S2mjpWMI8J0rGVhOjwyv/8jHE7GK2EgHCs7ZrSpcC6LaaurZGzZqy1QshfvpKdVbUm+x0v6v99q/n3TV2r7/bvWw9ak224DHoDqFTIVIgsEhcBBI0FSQFFQEEzIz/8jPEviytD7l2s7ZrRJMkBWmqReWFjQsgeytLtqLOr2dXs6ugKTTAEKpGWwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//IxxP81rhSg7qO2Y8ZxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//IxxMzrmg3IFoNeMMACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//IzxD2BoQAAAlwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRBR0Rvb3JiZWxsLUF2b24gbGFkeQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM';

	SOUND_FILES.whisper.OGG = 'data:audio/ogg;base64,T2dnUwACAAAAAAAAAAC5WgAAAAAAAA/qPuUBHgF2b3JiaXMAAAAAAiJWAAAAAAAAFi4BAAAAAACpAU9nZ1MAAAAAAAAAAAAAuVoAAAEAAAD9CjErEHr//////////////////xsDdm9yYmlzHQAAAFhpcGguT3JnIGxpYlZvcmJpcyBJIDIwMDMwOTA5BQAAAAkAAABDT01NRU5UPQwLAAAAR0VOUkU9T3RoZXIYAAAAVElUTEU9RG9vcmJlbGwtQXZvbiBsYWR5BwAAAEFSVElTVD0GAAAAQUxCVU09AQV2b3JiaXMiQkNWAQBAAAAYQhAqBa1jjjrIFSGMGaKgQsopxx1C0CGjJEOIOsY1xxhjR7lkikLJgdCQVQAAQAAApBxXUHJJLeecc6MYV8xx6CDnnHPlIGfMcQkl55xzjjnnknKOMeecc6MYVw5yKS3nnHOBFEeKcacY55xzpBxHinGoGOecc20xt5JyzjnnnHPmIIdScq4155xzpBhnDnILJeecc8YgZ8xx6yDnnHOMNbfUcs4555xzzjnnnHPOOeecc4wx55xzzjnnnHNuMecWc64555xzzjnnHHPOOeeccyA0ZBUAkAAAoKEoiuIoDhAasgoAyAAAEEBxFEeRFEuxHMvRJA0IDVkFAAABAAgAAKBIhqRIiqVYjmZpniZ6oiiaoiqrsmnKsizLsuu6LhAasgoASAAAUFEUxXAUBwgNWQUAZAAACGAoiqM4juRYkqVZngeEhqwCAIAAAAQAAFAMR7EUTfEkz/I8z/M8z/M8z/M8z/M8z/M8z/M8DQgNWQUAIAAAAIIoZBgDQkNWAQBAAAAIIRoZQ51SElwKFkIcEUMdQs5DqaWD4CmFJWPSU6xBCCF87z333nvvgdCQVQAAEAAAYRQ4iIHHJAghhGIUJ0RxpiAIIYTlJFjKeegkCN2DEEK4nHvLuffeeyA0ZBUAAAgAwCCEEEIIIYQQQggppJRSSCmmmGKKKcccc8wxxyCDDDLooJNOOsmkkk46yiSjjlJrKbUUU0yx5RZjrbXWnHOvQSljjDHGGGOMMcYYY4wxxhgjCA1ZBQCAAAAQBhlkkEEIIYQUUkgppphyzDHHHANCQ1YBAIAAAAIAAAAcRVIkR3IkR5IkyZIsSZM8y7M8y7M8TdRETRVV1VVt1/ZtX/Zt39Vl3/Zl29VlXZZl3bVtXdZdXdd1Xdd1Xdd1Xdd1Xdd1XdeB0JBVAIAEAICO5DiO5DiO5EiOpEgKEBqyCgCQAQAQAICjOIrjSI7kWI4lWZImaZZneZaneZqoiR4QGrIKAAAEABAAAAAAAICiKIqjOI4kWZamaZ6neqIomqqqiqapqqpqmqZpmqZpmqZpmqZpmqZpmqZpmqZpmqZpmqZpmqZpmqZpAqEhqwAACQAAHcdxHEdxHMdxJEeSJCA0ZBUAIAMAIAAAQ1EcRXIsx5I0S7M8y9NEz/RcUTZ1U1dtIDRkFQAACAAgAAAAAAAAx3M8x3M8yZM8y3M8x5M8SdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TdM0TQNCQ1YCAGQAAJACz0IpLUYCHIiYo9h777333ntlPJKISe0x9NQxB7FnxiNmlKPYKc8cQgxi6Dx0SjGIKfVSMsYgxthjDCGUGAgNWSEAhGYAGCQJkDQNkDQNAAAAAAAAACRPAzRRBDRPBAAAAAAAAABJ8wBN9ABNFAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkDwN8EQR0EQRAAAAAAAAADRRBERRBUTVBAAAAAAAAABNFAFPFQHRVAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkDQP0EQR8EQRAAAAAAAAADRRBETVBDxRBQAAAAAAAABNFAHRVAFRFQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAQ4AAAEWAiFhqwIAOIEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAADDgAAAQYEIZKDRkRQAQJwBgcBzLAgAAR5I0DQAAHEnSNAAA0DRNFAEAwNI0UQQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAMOAAABBgQhkoNGQlABAFAGAwFE0DWBbAsgCaBtA0gOcBPBFgmgBAAABAgQMAQIANmhKLAxQashIAiAIAMCiKJFmW50HTNE0UoWmaJorwPM8TRXie55kmRNHzTBOi6HmmCdMURdMEomiaAgAAChwAAAJs0JRYHKDQkJUAQEgAgEFRLMvzRFEUTVNVXRea5nmiKIqmqaquC03zPFEURdNUVdeF53miKZqmaaqq68LzRNE0TVNVVdd14XmiaJqmqaqu67rwPFE0TdNUVdeVZYiiKJqmaaqq68oyEEXTNE1VdV1ZBqJomqrquq4ry0AUTVNVXdd1ZRmYpmqqquvKsiwDTFNVXVeWZRmgqq7rurJs2wBVdV3XlWXbBriu68qyLNs2ANeVZVm2bQEAAAcOAAABRtBJRpVF2GjChQeg0JAVAUAUAABgjFKKKWUYk1BKCQ1jUkoqpZKSUkqlVBJSSqmUSkpKKZWSUUoptZYqKamUlFIlpaSSUioAAOzAAQDswEIoNGQlAJAHAEAQghRjjDknpVSKMeeck1IqxZhzzkkpGWPMOeeklIwx5pxzUkrGnHPOOSklY84555yU0jnnnINQSimlc85BKKWUEkLnIJRSSumccxAKAAAqcAAACLBRZHOCkaBCQ1YCAKkAAAbHsSxN0zTPE0VLkjTPEz1PFE3VkiTPE0XPE01T5XmeKIqiaJqqShRFTxRF0TRVlSyLommapqq6LlsWRdM0TVV1XZimKKqq68ouTFMUTdN1ZRmyrZqq6rqyDds2TVV1XVkGruu6smzrwHVdV5ZtXQAAeIIDAFCBDasjnBSNBRYashIAyAAAIAhBSCmFkFIKIaUUQkophAQAAAw4AAAEmFAGCg1ZCQCkAgAAEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYTOOeecc84555xzzjnnnHPOOeecc84555xzzjnnnHPOOeecc84555xzzjnnnHPOOeecc84555xzAgCxKxwAdiJsWB3hpGgssNCQlQBAOAAAYIwxzlmstdZaK6WUklBrrbXWmimklIQWY4wxxpgxCCm1GGOMMcaMOUctxhhjjDG2VkpsMcYYY4yxtVJijDHGGGOMMcYWW4wxxhhjjDG2GGOMMcYYY4wxxhhjjDHGGGOMMbYYY4wxxhhjjDHGGGOMMcYYY4wxxhhjjDHGGGNsMcYYY4wxxhhjjDHGGGMsAMDkwQEAKsHGGVaSzgpHgwsNWQkA5AYAAMYoxZhjzkEIoZQSSkmtdc45CCGUUkpJqbSUYsqYc85BCKWUEkpJqaXUOecglFJKSimllFpqrXMQQgillFJKSiml1FIIIZRSSioppZRSa62lEEIopZSUUkoppdRai6GUkEopJaWUUkkttZZaKqGUVFJKKaWUUmuptVZKSSWllFJKKaXUYmsplJJSSSm1lFJKrcXYYimtpJRSSiml1lJsrbXYUkoppZZaSim1FltqLaWUUksppZZSSy3G1lpLKaXUUmqppZRSbK21mFJqLaXUUmsttdhSai21lFJrqaWUWmsttthaaym1lFJKqbUWW4qxtdRKSim11FpqLbYWW2utpdZaaimlFluMMcYWY2sxpZRSS6mlAgCADhwAAAKMqLQQO8248ggcUcgwARUashIAIAMAIJBpkjlJqREmOcWglOacU0oppTRElmSQYlAdmYw5STlDpDGkIPVMkceUYhBDSCp0ijlsNflYQgexBmWMcCnFAAAACAIABIQEABggKJgBAAYHCCMHAh0BBA5tAICBCJkJDAqhwUEmADxAREgFAIkJitKFLgghgnQRZPHAhRM3nrjhhA5tIAAAAAAAIADwAQCQUAAREdHMVVhcYGRobHB0eHyAhAgAAAAAABAAfAAAJCJAREQ0cxUWFxgZGhscHR4fICEBAIAAAgAAAAAggAAEBAQAAAAAAAIAAAAEBE9nZ1MAAIBKAAAAAAAAuVoAAAIAAACizYiJLAF/U1ZtmXpvZoF1gUdYW1hLQllJT1ZyWFp+bGJeWF5ZVltbVVlZUFlaWFVYALKneZroJs74UFqX7GmeJrqJMz6U1iUDwdTd96JFlUioAkFBUTIeEQ9JBYDOScfGMHZIpk00E0mnT5/m5kqWYc51LtNmmJLC5FTpmGGus+1ca67tuq4NZGjSfNb6jGc38m/72dZGEiDLEp39B0yXRKmCqUaAWEEoFhVFIYJ4YQH0mps2Y0evuWkzdlwMUL2qwThhISLiBGCmE1OnTUxOHad2YtII6TKGDMnkKx+TkIwMWcaSqZOkkzPOGAA7mTLev5v24U6nO6bXy0NId05VwyIQAeyagdHsmoHR7OliBFTI1GCComQyAQAznZyYyZRMTk4fJRODOdepYzE2dK6WjHbOrm3GMrrOmSwjScw5LcbsZqOzm8vGxFCKh27qlHNtBP88NwTqdA8XFJvWAuCaYtNaAFzzFwBgTuJqAwCiUq3X1iuyUq2kSn1jWjaXKetC5igdM2kazRrNjI6ZGpvpMIwT4zhMn2FSJicmBzIOxmmTAdRo92trjMx1tu2UzvWsRa3RrxbxIT9+o6b9k/vuMXb3erj8ABqq+RAdbeIU78NkukI1H6KjTZzifZhM1y+TDoIIYX0W3qLFAlBUKJYIyUBqSmqkeIg7mZqSDEraNslI7uayZh1lHbXRyXGGMUwOEx07xZhxnDIx2UyZOtWUYXq008Z0otOHaCfmGGvDjMwO/b7Yx23GMdvCvikBSUvXMhuczIndXKM9XbsMQEaKtaRW9Y4BiLXAfG5SB1ApAB6a+fk6qaElDa+DCM38fJ3U0JKG10Hc68Lv01l+PwhSZjptYmIwfabDYOzMJstIbDbZnDar2WzNpFXKlBkGSMRYhgmrMtlHcM4xvL9nCV1rpEBPnngGGaYD8CjVNLNfuJnGIxNAVsAj1QKLYtQMHgBZRbo51BRZEEgAnvm5TbvAvsCtnqzMz23aBfYFbvVk/TclI2UQCdsDe0+vWQoAECIhKNomCGLxRJRiW47iMTSXDDGimWktCzIayZRms5CgZHYTCaASGV3TAbpZqRxRjcJIOPSedDsgTbExJrw4jpxc1snjXm1u7isA/tl5blpoXNBnUXx2npsWGhf0WRRfB4jteW48Q1UAJKKkQiJOII6Tcaa1k1OHTMTYwWCtYbTtyEhkGdHZUEnyzePUc2o+cwbP8o5iR8iBwhQ7Tz27ADKWEUCAdKxjUhFaJGkZFzUBvqjZpfUoCCMcrCwWNbu0HgVhhIOVxdfHEvdeeFt3okJFlIgcE0pNURQ5iqeGGafPZOo4kQzJ2OltqhNp09RG2lqr1dGOubaBtGljIyPRAlabTCZRO5HKeCbx0K3fAcjmBAC0c12LCFSCjJGuawE6ZwngpjOuGAaevBDvGGqViFgXXsk5sZYWxhlakeh9lZwTa2lhnKEVid73pzEzoQxB2HvhWXMVoAiwrBggODrEwDBmJhk72ZnVybTLmDWr7SjGhiyMSqsTSyaYAl02NA3AWugQGv6TckPX6PnueK8HGBFAhgV0SRIACLAMkDlHR2jbmgaqWCAC9gl6hB41yHRq0H6foEfoUYNMpwbt96caKTMRCc+zmOf0UgCIYIKiRBCOE1MyZdoMGTMTkxMZa9pEphnbppFOzCSJDhlHlcnBxOS0TG+bcYBOTs5gCLRtu5ptzbRt378vpwnWBg1sjCzAOD0APAQSmwWAfNlDn9Fpn85ZexrJ8P8CHB989QgcH3z1CPwHADAMUs9ZAKEGAKQ4JTUiSo2UkAWNaxqXETKVkVmtMfQv6Jiwdl3BEqgAyJhpAWAKK93Cp+bj10ELBQH8HMPSzzEs/QcAABH6Pl2Rg0SCITwSAKSkJokig4inIgWIpVhRAiAiXmlopoyQRNZmVEIly1iAqTMRHWd2nJzZQpaBAJBhhmEYxhYyFAt7ggiQdSlQCHABHJel0Jz5cVkKzZl/GyMhANkFgy6gXl8fgPXoAwBQIBhCDCEEBUiGICBKiQQgsEIgwpGSUTKKUgQAAAAgxWMhKQFopjM7oykzmWGiNQxDhpG25jo7Z+kyAQBjJUSpUPRdHKVC0XfxuigbMxKRJF30QRfUc7Z7PZMAAIgQHU2MkgIBcIpTY0QhlkikpABAPO5IJOMpAlBSiWABMF1NjKZNTk6b2injpHWYxjQm2BgAwExGAABELYzO6KWiFkZn9FLMAgAABgIAXAvAevU6yAMAZAMAAMjuVDAAAAAhJQ7xmA0ATM/YIU0hJrOmuaIsEgBU6gWq9ZpK1GD5l8C6jAJEryWT9m2IXksm7duwTtN6AAAMBAAoZg0AAAAAskMEAAAAQDfZAGBmJ8cKKKaCgKKhtvlGtZtzAADukYZmqk3UCwB66lrVxz+hj89X+iqsF5y6VvXxT+jj85W+CusFVxIcCKoRAIgDAEjVMlBxIETWKgAAAECIO4goRjCWQwzRwQIAAACsEKKIkh0jBAMAMztMDk0BIAFQKyJwAX7qWrHHn9Db77tcEkf1glPXij3+hN5+3+WSOKoXPC9sACEBAVAPwAvTAwAAYJQSBAAAAAA2UQASihkAYGZTAEDMMDAlUqCAnQBe2lrRx5/g7f2d20JUVmlrRR9/grf3d24LUVkHTMCBQA0AQgICoB4BHAhZNJYJAAUAQjAAAAAgBwIAAAAARIkoIESHAACA8p/DTWICPYMIXspa0T1fb59v71QL6w2lrBXd8/X2+fZOtbDe8LwwAaQSBxsQB4LMGgACAADJsbgAAABASA4kYgFJyBIAwIwpoGSYmDKM02c6fcapY4YhAPUZIKewUAA2ulqRzet7H8ieDAlZo6sV2by+94HsyZCQdc1YgwMRKhIAyYFgQx0IkU0CAKEAQIKIlEQ8nprqpIKkSAgYAABLgKUIJWJBRNsOAQBgxkxOTp2cbDvRGKchiSRjp5kWc8wNI5GiGdBa33rCCsxxp+65UwFEq9CstRGtQrPWxvUE9bpaNQGgy/YhLn3AtekB3QCAEI9AIopHIUmUGoNsAACJGKl2LKkAOFVRTEnFUmKyATseEikJAQAAJNqCZIkCMDE5U+DrZBhlWgAATDFO1vksphgn63wWtwMARK0KAJiJsg6QAYYBADwDyAMAAIAsiDEKAKzo6KAQbABjUQDAKTEDAAC0qFZDpYzMQoamaAC1wFyloWmlqJRZBrIIAGDJspm5LKMAekqr+0eHh7J3pDjTsz6l1f2jw0PZO1Kc6VlLYLC5AAAvSbB/2A7ABvGSPjiKIwCQjNlRIgpRSiqxyAIAMSCGErYBAACsKJGMUuMyAAAAKC4ZHBRPxAUGyCZRk5WiiGqoNNu0jjMp0dQ6KxDoOptiYIhp42QAsIrpUTqMhjEtfkrr1Ue4h/L33SRnPK3rlNarj3AP5e+7Sc54WtfByEhIQpMsX5LA/8PWARZeUAdHjgCAHSVigBAjIQIGAwAAACRTUwUAAAC2EgAgknEBApiqoJ2cyWSM6JvVntoDii5jgmZmC8AwOZECxmkjfkrr1cdn88A+QW0daO1TWq8+PpsH9glq60BrSyAAgNP/D8gGANjACzpgjB0AkADQAECyAgIAALBDqgCMUhMAAMyogJQkK1lkRlmEaByFkanTUwC4bOf2FC2YS4DNbgDgLQB+OuvVx7c9xN4toNZh69NZrz6+7SH2bgG1DltLIACAo+0fUNQSAAsv6IEjAAAAoDMAkOwgAAAAMCEFASJK2gAAMzUCSDNkc6FIIpTZTHNNy8yaAGCRtEA7PcA4MwkAXirr947P9pv4p5XqTM+6VNbvHZ/tN/FPK9WZnvV7ArIAIMomcZR+mAUHAmoAjAEAUIgAAMBCQjFEGVtyBADHksEAAAq2AADC1GkJgIUiAWBmZxgCY9kEAF4a6/WO3/bD7LOTtA4sS2O93vHbfph9dpLWgeV7ApRBAlGrlC8IYP0DNJUACLwgA44AAAQZAACjiBgJQQJClILAEQIAAABHiYAAAAAgVRJgSKYCAIAFwNwIqJlNAQBeGutVx2/7DXs3xZ3Z09qlsV51/LbfsHdT3Jk9rX2wSACy0phH88N2AARe0ANjOwBAVDQAdoAIACYekgYAAACIQwAgIjIAwExTAFplYmYaAKiw38JmFgCUAD4K6/WO783D7NMSbS1bjsJ6veN78zD7tERby5YHFQBktTGO0n9AWQsACBwIqAFwBADAQQhjsBwEAAEIAAAAAAgBCDsAAMxsRgDalGkTIwCgKBEzUwAAHvrq18f37k3803RvLSxDX/36+N69iX+a7q2F5XsCMgNAVCsxlv0DiloCQOAF/YAjAAAoMgAAYAc7RhtkOwCAQiQKAAAAIIVIgFFKKgAAYWOdBQBAFwHD9EkAAB766hfHb/vN5N0UaS10ZOirXxy/7TeTd1OktdCR7wmIBCCKJnmU/QFUygR4QQ8cAQAIsQgAAKFIEaQggwgGABGCjQEAh8gAAGGY2RYAAHMNAOhMZiIwznSiAAAe6upXx+/m4fLeRVsHWjvU1a+O383D5b2Ltg609sEIANTK8ij9A4hGAC8YMAYAIEYLGawQQwwA4KAYAQBIxiQAgJlNAUDpzKYAYGcJgM4wk4LNZQEAHurqF8ff2zf83RR1ptORoa5+cfy9fcPfTVFnOh15UCSAzKaOsj+Ash4AL1jwggAAAEQHHDCAcQDADsEGAHA8LgMAgBRZAADMbEYAVJk6fSgAACwAIJ1hJgUe2uoXx9/hzewdRE49rR3a6hfH3+HN7B1ETj2tLYEAAI7SP4BqBsAL6uCoAAAAoAUAJgoAAJF0JACAmc0IIKper1EIKKOZmmYxswYAwPsAQKfNTAPThhGACv7Z6lfH35uH2Yd3xrP8bPWr4+/Nw+zDO+NZvicgEoDIJsbSDxvgBX1wBAAgKAIAAGRjWwAYSQBYSScEAFgOwQAAYXMjAIB3ADCaGYFpkyMA/snqVcff24f5p0nSOrD8ZPWq4+/tw/zTJGkdWL4nIAIAtSKPsn9A1gBA4AV1cAQAAEUAACCI0ZaIQAgoAmAiCgAAAIBTIwSIWDISAEAYZyYBAIAFMMxUAQDeuepXx3frYf5pMjnjWXeu+tXx3XqYf5pMznjW7wkQAGSlab4ggOwPIGoAXpDgCABAFCIAAJAVJUUMIEVhCJEFAAAAyMQAAJjIMQAAAOgaAGhnOhOByRkHAADeuern4+/dQ/yTr844rdm56ufj791D/JOvzjit+Z6AFACyWo+j+WECYOEFAY4AADhEAABAJEWQbcAhBACQYvGkAAAAwA4pAEhKNQAAZcq0MQCwQAGmZwAAvknqF8d3+6HLZ0fkjNJPNkn94vhuP3T57IicUfrJewIkAOqVOIp/QAUALLwgwREAgChEAAAAGIMEEEN0AEAOIQIAAACWbQADBgAgzJARAA4wswMAAL5J6ufjt/VQ7cM7YxQ2Sf18/LYeqn14Z4yCBE4AAMBR+sMAkHhBgCMAAHFFAABIAgAoAIiUKA4CAAAglhpsQI4SAABQW4iMBLWVxuXAtMkCAH6omU4MAABPZ2dTAACApAAAAAAAALlaAAADAAAAgzLCkC1UVldZVVJXVlVXUlJUV1dQVFNUVFVTVFVVWGFbX15jYWdqbGlpamxra2tyanC+Oern4zc+8I8fOxX6ZHPUz8dvfOAfP3Yq9Ml7AgQAGqI8Sv8AKgngeFQAgFTFDQCAICIEgIIkARAUoi0ATJlpCwA8AZCJKTMNNDOdHgDaGacAIAC+OeoXx2/rTbX/zuKM0pObo35x/LbeVPvvLM4oPfmeAADISmMepf+AWgLAwPGoAADJWBwAALAdJWQBIUQHAAJRAAAAALIkKMPMKgDwB1M7EwAwUwUgC545mhTHd3hfCoPBqdGTmaNJcXyH96UwGJwaPfm3KgGABCDLpvGCBNI/gAqAviDAEQCAGIIBAMBRAADgECECAgYAAIDgEA0AIDkOAABgAgBTzQARMn0SAJ4p6hfHpz0s/8Hg1OjKTFG/OD7tYfkPBqdGV/6tRgKAAIDGKF6QQPoPqCQALLwgwREAgBiDAQAAW9EGgCjJQDzIAAAAEAghAgAAALYCAJYiAAAAZcDkdAUAfhnqV8dn+7k0NpE4VXryMtSvjs/2c2lsInGq9OTfqgQAAoDIBkfZH0AlARyPAADEEAwAAMLRAAA2EgCBEAwCwtTpKQAAlgKATszs9ELGKTMAQDodAH456hfHZ+u5NDWZnBF6fDnqF8dn67k0NZmcEXr8ty4BAACoVPIo/TDA8QgAgEIwAAACAzYAIQQBQHCKjTCEGScHAMAUAJmYyXRgmDJTADAxHQB+Gern47v9UOXfQqKadOVlqJ+P7/ZDlX8LiWrSlX/rEgBIAFSqeZT+A2oJAAMvSHAEAEBBFgAggRWRAQgxGABEVAQDAADIWAB2SAEAgDJjBgDAByamAwBeGeoXx+fmuXqwiUQ16cnKUL84PjfP1YNNJKpJT/6tRwKAAEBmo6P0wyR4QYAjAACOsgAAMCgGQAICCgCIRCxuEICIIgMAUKZOSwCABwCMMzNDQGZUAF4JmuTjW95XJYNBNWnNStAkH9/yvioZDKpJa/6tSwAgANCoeEEA8WESvCDBEQCAGGQBAACSJAAccQhAHAQAAAAimYyMADAhIQAA+AUAxmFmBDpjCgBeKerH4zu+r2oKBWcKXVkp6sfjO76vagoFZwpdeWDqkQAAAOAFAcQHCY5jAABilCUAQDIAUAIosgAAAABIJQIgssgE1NRbFLwBME7ODEhmZioA2NxMAQBeGerF47v1XNUUwqohUxnqxeO79VzVFMKqIfO3HgkAIgFQKfIo/bAJjmMAAGKUJQAAiMEGAQSFEAGARDIWYSBMmdYAAC8A6MzOAGqm0xIAbAoAPgnq5+O7/b6UaLE4Q5kE9fPx3X5fSrRYnKH8bYwEAACQRT2P0g8LvKAHxgAAyFhgAGRbAgCsEKIAME4mQACIKGYDAJRpwwgA+AcANbMDsG4EAD756fnje3NfUi0WZ4TU5Kfnj+/NfUm1WJwRUn/rkQAgAJBlPY7SHxbAwvEIAABRlgwgYiSGIADAARkA45SYEAAAgBUMlGmTIwBgkmCmM0kA0JkIAB4J6tvjc3NfVdRC6oyQiQT17fG5ua8qaiF1Rsj8N0oAGQBbP0o/COgLFhwBAFCQJQy2JSUtKwLAIelUAFBqCMIAQCzYAAAYZtoCAC8AyEwnUxUYpo0AAB4Z6tvjOz5Ue4eCU9VmZ5Ghvj2+40O1dyg4VW129rcxEgAAQESTfEEC2QcBjmMAABRlyQZiiMFREQwgoRACOGAAAABAsRAJBABYAQAznQyQmTQAWDYnAB4Z6unju7np8QlhZ0QrVWSop4/v5qbHJ4SdEa1UfxsjAUAAQC3Lo3g4HgEAUMSSDSBh2wAAiihg6owpAHZAzMyUqQQAmhmnAyanBwA6UwUAHgnq2eM33mjvoDmj2nAWCerZ4zfeaO+gOaPacHZgGiMBAADAUfpBgvEYAIBgIWwJwAEAaADgFOIGoFrKTKAhao3M2AEA8AoAaqaTA7DRFQDWsQEAHgnqyeO3eVA+IexUtWJFgnry+G0elE8IO1WtWH+bSgCIBIB6FkfpBwmORwAAQgiWbDBADCAwgA0GAKeSMACYOsMQABpfAFAzHQZgnIkAkGHaJAAeCarl8dvc8E+LyRnacikSVMvjt7nhnxaTM7Tl0t+mEgAiARDZJF4QQDwcxwAAhCBLNoBQDI4SAOBIFDiSAACgRsDMTpsWAQBmnAgwzjQFwNicAAAe+ank8du+kZ92JE5FK1bkp5LHb/tGftqROBWtWH+bRgJAJABUijxKPwgwPgIAEGxLNjKIGIWMABRCiAAgEhYGwjAzDQDwAgDTpyWFjUwAGKdPAAAe+an48du+SX7akTgjWnFEfip+/LZvkp92JM6IVhx/m0YCgAwAsqjnUfpwPAIAEGxLtgBkBWMZAAVFlWkTIwAW/wBkZqZMDQGATp2JgMlpCQA6QwIAHvmp+PG7uYn/2pE4Q1ueIj8VP343N/FfOxJnaMvTf9NIAABsjsWHSXAcAwAQoi3ZAgvL8RAhABx3agoAkAxxI6BsrBMA3hGATs4gwEwVAMvGBAAe6ank8ff2IflvR+qU1tuRnkoef28fkv92pE5pvf3fNBIAABtH2QcJjkcAAAJYsiUjpNRYkAHAsSiRAAATV4SBMMy0BQCABQDo5EwETExrADBMLwD+6Knk8R1vlv9wvB91/9FTyeM73iz/4Xg/6v7fphKAiACAKJrkCxJIP2yC4xEFABywZAtQdAxIgEGyQOCAAQAAwCQUbADwB4BOnwKYPhkA6IwpALQA/ugp5PFsbnr8NapR7z96Cnk8m5sef41q1Pt/m0oAlDIBUMk8ig8LehwLBQAIjpItgCAjEAahGGIEwIQoBgIwOT0FQAVAZ3YiEQHThgLA5poCQBaNAf7YKeTxjidrH41T0UbqsVPI4x1P1j4ap6KN1N+mkQAQSQKkpo7m4TgWGwCwoyWQUMDGChFbAERGZhwHAJDAC8DMzjAAAGpmAaY3ALCZAJBvaQOALgFkAQAe2cn82NuN8YkS1WgjFdnJ/NjbjfGJEtVoI/W3aSSyCpkZAKCexdF8EOB4GgsACBFLCsJgomJwJIAdidEAQGosCAOYPgwAVIbGB4BmplMBM6QAMDktAYDUQnD9N3ABQVcBHsmJ/JjjeaWxM0E1XHYkJ/JjjueVxs4E1XDZf5tGIpJMESABUTY4ig8CHI/JAIAQsYgYCYKiIgEDsuUAAMRikRAQJmdIALADoMP0GQHTEwAwQwOgBYcKAHOjBT7JifzY243xa1dQ1V/+SU7kx95ujF+7gqr+8v9tjEQmyhCSAIhKLY/mwwQ4ThcACNlRSFgYJGIMQWAUZQMAychCQOjMCAAkMAWACTMCZgIAOjYAgCjgmz1EeewJ7CsBHsnx9DjDTa1PbwVVuf6RHE+PM9zU+vRWUJXr/7cxEgpCCiQAtWoepQ/HcX4ABRyRY8RRAhRBxmDFKJdhJgJAJD9AzMxMGgqAZGYmQTN9BABjAwC4IcoAXS4AyGYsAP7IyXA8w3NlMDY4NV7dj5wMxzM8VwZjg1Pj1f23MRKBECETAJlNHaUP49kCQEC0Y1BEWJIcYjQ2AEihTJnWAAAvADOZKAAgZpKALhsAYNloAEgDvxsz+akkQMY65f03xz8HAN64yfjY203tt6QanvM3bjI+9nZT+y2phuf8f5tGQpAISAD1jKP0wwDjmR8BgKMtxQDEGBUtBQRABAIAIooZADDDMAJA8AcEJjMNGDYBwNgAABa7/5nU7Xqkz82YJmgtUAAeuYn4uIaH3nc5pBr9W4rcRHxcw0PvuxxSjf4t/W2MBDIKyAAgylocxcPxtPwACKJtyTGEGGUrxkBEAI4QE9NaAJ52QMzMlBIA0JkOBZ0+AQAdpwFglQRdoDOdWaGbfbVho2QjpUgA/rjx9Lg2J1nvckg12th63Hh6XJuTrHc5pBptbP1tGgmIzJQJAEUtj+bDgB5nG0AVO0bJVrCFgo1kABRiDACIKGFJQJg2tQCgx2IOAMOMU1UaEDMEALq5EQBEMOflcwE2i6ZJlqE6ZgARLv648fh4x/uqk2VANTyyHzceH+94X3WyDKiGR/bfppGAzCwFAKhlHs2HAR2fe4OigG3JRlawom0EAoItAyCimCUDmDJjCwBRRQEAE1Omp0SQzRUAOuMEAC4AgHXCkgJzDhjLVDCXZRShLQi4AP648XC8w03WOzZWDY/cjxsPxzvcZL1jY9XwyP23aSQAQQIgo9FR/DAABh2fxg8KEB2j5Kgo2QpGtgAgyBEAOUqxZAAAADmSYGSYWQWwDAro3ABAzYgCyK3QuhnZGWlnE6/EL4XZZWYBFR65sfj4u3Wz9e4KtF8euSM3Fh9/t2623l2B9ssj93/TSEBUA8B2jtJHx2d+QIHgGCVbiiEgE4vFZIFwFDm1dGYVgAxmgJjJRAEAxinToIAsmwqgpgsAhJA2uVMPh6PhzPtrmA2ZltnABR65sej40/Z5ZakrkKpcS+TGouNP2+eVpa5AqnIt/00jAREAbBzNhwE9nv4NACJgS7YUCYiQjAEAEKJYAkAQEYGAMDljCoBpu/QDgJicnAFCBNMnAMD0AQAWOKU9zdoKrMCMrDYKZHMBAFj+uLHk+GxuXt7djfbLg9bjxpLjs7l5eXc32i8PWn+bRgIyAwkAUTP2Hj1OYwGgOMYo2QohEGJUNBIACnYMm+sAQIDnBv4B6EwmWwoAZhySegPTRgCwuQSAWJTNZsx6R+zoyTq38owliTklSgD+uNHkWP7kremy38ZKjxtNjuVP3pou+22s9LdpJACRGRKASpZH84MEWHR8ehsAiERLtmSwQ1QAECAHBwAghcgYAADABAFq+jAAIHmXiUjmgM0lADDOIAGQho0+22YcW5xLJjoy5grajkhrLR65keR4hpO3FQftV1tXRG4kOZ7h5G3FQfvV1hV/GyMBUE0AoNHRfJDQeRo/CEBEO0qOklFwwLYMgGMQAIADBqBMTksArNrcyka+AMCMRW4Ay2YBYGGYoQEIEX7Zuj6n6ab6lUmqaamFRUIF/rjR7HjLKVuJjrerzTt73Gh2vOWUrUTH29Xmnf03jQQgM4DtvCCAeXROvwegYNuSLQmDBQEZwKQmkoAjCQAANDof+SPA9BlDABSmT6q1gLkBACI2MguhXicspxRVtCorPHmdlzd39kjHpQD+qNHkeNrJ2+6OwH7/lh41mhxPO3nb3RHY79/S38ZIQIaSAECUtTj2dJzeBlQjOlqyhWMItiPCACIGxTDMTAMArRvnIqVmtkMVQDFMzhicAwIYpisANtZZAGvMcp4vY/CeXRWEZNU0mcscTVMAkhKhBgD+qNHm+N6csvx7sNj2zPSo0eb43pyy/Huw2PbM9N8YCYiMBJgYm6fj6T8BBCLalmw52sHEQyQZAwpJx8OyTACQ9UxeAciMMxkAoQGZaVkBAjCDANBhRgVAjC2/GlgDXUMtAMPUaWPAjwsU/qiR6njHk7dPbybbntmPGqmOdzx5+/Rmsu2Z/d8YCSAkYHJsfRDonH6fkEAQbQfZEkQ7EgKAAUWOpwJgkCWAsjEnAFbMAdAVUgLSmaqwgwDG6SkAblgtQGCVTCdv80pb1AjrSBkAZMq0KQBUDMGFBU9nZ1MABADPAAAAAAAAuVoAAAQAAAAJYAxkF3Rycm9xcWx0d250enh1dHV3hE5iZpxq/qjh4njGk7VTx74HrEcNF8cznqydOvY9YP1tKgFEZBIAZD2OPZ2n5QdSgUKMki05WAqKUUgGHGNwmZjeAqg6/Ku7B5Uww0ymRqC0BDPVUJIFTEsBwYEOnUGAINMPnSnJWkFDM9/drrXWqK5zjBUAtV6QkAD+uKHqeNsps3XHYOsv/+OGquNtp8zWHYOtv/z/TSMBZCRg6y9IYJ7O6d+AAnaMkqNkoRhBYAAsOxUgYAAA/PppZ8IAMMPMTqVRjSSlZqo9uZutAhinDQRQFiSbAChj3rS3F1gJIKWRmWSytOaaAuZMJAD+uMHqeMctS0ZHttsQPW6wOt5xy5LRke02RH+bRgIIJQAQNUfzBonO020AyDFGyZZMVFBACAMQYoiAhCNiAChMTk8BKKF4ZvafQiHrOnj18NEVwTjjUKEwQGcMAH67tbGPU959aIJWkiSyMg0tyGYMDBH+uKHh+PhTyRKDbXnm/bih4fj4U8kSg2155v23aSQARUICqGR5lN1uTuMHACLRki0ZUHRUsEAgB0KZ0QAAXZCKgsBMp0xJEQbEtE7y6JRIF2Kjk5JQxXxq3QgUPE7nRq3W/2c8F4+5KEc9jGndDAAeuaHu+NN4GrajzNaPO3JD3fGn8TRsR5mtH/ffxkgAEABIdUfrDQLunM4GAEQ7So6SQdFGYAAUHAUCiYCMoEydFgCWeI4K6AYQiNgckROPRtwEjDMZUqChpAkZG7MoKt7Q+MY0VFbW0fvKMjF9ckYBAP64oe7462/FVlSw9QfrcUPd8dffiq2oYOsP1t+mkQBAAqCqeEEAc7vz0L8BADlGyZYM4GAFAUAkGlAEAgCgWuf48L4GKaZNTIaCSpB1Cft14wYUk9MDClFjOkxvgcorQdgTj/cAgBV0LEBGIh1LKwkA/rjByfFrpyYlCtuq248bnBy/dmpSorCtuv23aSQAkAkgssHR3Pa5mCsAYMco2RJIOCpAEAAxRIWJGRoAE2JM2FlmpZopM1ZGSBqSZt1ImgUIYmMpACoyN0cBIdE/wFiSDkABDeiyIZGmOh0A/rgBc1zlVHJr2/LAftyAOa5yKrm1bXlg/zeNEkAIwPSO5g0SnYuFH0AoiiFKtmRFRceipMEAUiyZwMGCuAChEKZNjAAUaTqfseOhdUqk1rnQ75ACZHoSFJ5Gq81cUiDYcPKhAbSrarcb9i1w32SFzmiAABH+uIHk2NvNsvQGsf+H63EDybG3m2XpDWL/D9ffplECREYJAETVNLu58DaAggiWbAmCAtGOIWKDY4ixbMxZAK5y927JD+eai4TU5hqhlUrBulEanTJqWkiWTQBW+/uxyMYMaMAaHjk5ftMUnYedAWCdOtagywIgAP64AXc87eSepYvtmv24AXc87eSepYvtmv3fNBIgMhKweVrbHc6xTwCAGKNkSzGGKEhRzAIBUYgnysSMLQDUGp9zOjcLNauQ1GYiQRhJaNeQLbaEURZqchoAFAOwsVEA1HgQa0ED4HsDGKebnAoA/rhB5vhTu0kjMlj21+lxg8zxp3aTRmSw7K/Tf9NIAABsnP7bHS6cB6ACiJZsyUZWQihCBhziISWYWQVgILb1PmoUxCLVVJk6DSkASTZpOzb9797Dgg7TC7TY9auwzAKAV0JMecR3NMDW52+Wo9h+3zdUKAA+uWHh+Duc3GMXgjW2sS6TGxaOv8PJPXYhWGMb6/K3MRKZABlIIKLm6B12ntsDVRDBRNkCDAhHEzBAJMQwOWMKQMsuv406bf9tFJ2BBnSf/+1ZlKa7tNppIkU5PDSipisA+RUAxKq6GFMCbQK/W7zLb/qYd/8CI6pcAH65EeH48yi3IRZpy/ijf7kR4fjzKLchFmnL+KP/X48kEgAwe/pvdy7WDQCEaAckZARBsVgy2AbklHgM0ycHADCtkPHVDktLlJjRlikzoJVioG1XRsfFFsmCdjoAReqOmmsA4IUpAGApkmESTDAd0CUZm6l2NVtYAz65Yclx3CmNOLqOfjImNyw5jjulEUfX0U/G38ZIIkBEBBJANDqahVts6wZQJRiMLUGUbDvEAIBilFvThwGAkaYcHr9zjKATWZKmgtEmpVunkGpsE2OjI0BR9DxHmWsBADZnCojQLIBpRgsYpzcZNrLKWgAIBN6oQe44+GaU2GCd1ahB7jj4ZpTYYJ31OgAAYDund9g59wqAoAEAUaRgAWDHldpc0bQaNERQbT4aMH1aAoBQEv+cr2/TVpEmpgWKja+fSamt0EYNma5RJTecQrsGg8IugnRzFnS2aAs2ywbaqrIm0yYBtJAAHrkh6fHX35qY3ybxwR25Ienx19+amN8m8cH9tzESskAEAKCsxWkeN523AVAco3EMQTYQHAQRAER0GGdGAFDcf787Hq9x0FGTzqQkAEOEGYaonuWuTlUTXRdptPRfKPY/NTdhgay8G6K081cEWQtSaUgkYxMEHqlh4djh1IKLJmfdkRoWjh1OLbhoctb9tzESiQhBJgBRNORLApjD5vRvUECACDKKMZqI5BBAADFaAYgQAAAi24o73gQlWmGGyQ4lmK1pzW89wZGfHLrMVKPVTrK0mzIJwMXmLONCM9u0WZc2bVgEBMRsN0cDiQJWqTHl8adyc21RwdZqV2pMefyp3FxbVLC12n+rkZlKApGkBIRa5uk/9E5n/IBAiBglQkCOipgoyQAKVgyxNTFDAwCb+gvoOWazBg3oRJPMzNQWxuzkTiIyp0SPMtEjHYeZTQmKn1+faZy9Tjc/0JGd3sjfGRu/YhTnGa8BmSOrCS0IoAD8Gu7sg7pfw519UPcfAGACGG4e0iEEADKUEnMAAIOstmkCiOZqLKAMYNiYpaWZHZ/7yHDfiJD7Mvmlp0eZxMyqS5izDHeUFXLJ5XBDCT0MG7A5dQ8bsDl1/wcAmAAyk7ohbQAgpSgeggSRI6MWlRbVMkTIlNH0Ufz/d+KMzTCjYeg4jJPDVCxGZ4xmZGHdUKMWnZmt+U2n8Yg2a1fGyMZM1kwdmFZTpVM6FSOwUAlcAPwYStj7x1DC3mdaplutTpk+ZVImJ9opM87MTGdmplPGTowTNUxOjDHHjI6ZdsxlyhxrWk1pZOloIo2kn2nmMX3ZOvOITGZsR1MZM32YnmmTM4wTE5022WRmRlSqulHrTdP0xHLHKvqHmWnZb+pAzmL/YWZa9ps6kLPYz/osTFkeiFSF0NH0DjOdPswwOTOTE1OHKVNm2mnj9A5TZjpkbHbpzMg6rFknpmecmByTyWnRmJg6LToxZeqQZhgmhsGQTpvaCYwT7ZwVZI51WUf+ZrMzO8ZXR4cxxngl2ZO9X58/h2dOx7Fjm9nJmLnMNE1Tauz+zm/Wr7dplCsSVS5IKxkCA/6XuRuLPgl6KmxI/mXuxqJPgp4KG5LrwstLZAQANKSybmwuM3OZOm3qYJwy4wzTJ4wTk4N2WUdljpnKnn473Xezc068pqlHboy306zP4fNxljOLkdh376JzA+9gcYiSG7ifQ0f6bH+zwAA=';
	SOUND_FILES.whisper.DEFAULT = '<span><object type="application/x-shockwave-flash" data="http://thorastur.99h.com.ar/dewplayer/dewplayer-mini.swf" width="160" height="20"><param name="wmode" value="transparent" /><param name="movie" value="http://thorastur.99h.com.ar/dewplayer/dewplayer-mini.swf" /><param name="flashvars" value="mp3=http://efectos-de-sonido.anuncios-radio.com/BELL1.mp3&amp;autostart=1&amp;showtime=1&amp;volume=100" /></object></span>';
}

if (typeof SOUND_FILES.alert == 'undefined'){
	SOUND_FILES.alert = new Object();
        SOUND_FILES.alert.MP3 = 'data:audio/mpeg;base64,/+IzxAXLABqycmGdTygA1GpkxRf/e+/SlKUvikSGnydo83AM4YaXUh0MkNXx1OfIHBQTAACMc5/9TvOfzn/kyN///qc///9SEbkY4cIynPkOd5CEY4cFFOeQihwOMJz4gB8Lg+D5cHz6gQB/gmflxwP4Prf/L+GP8H+mZ1BIBExyEshgMq6pTIVuFHN7pzY/oaPzTOp9jzoNZlHVpf/iMcRdWiMaCwcCXYNoAszWnfOv63/9qf1v/+6/1v/Q/ZTWdBClGgmpImokoUAsQ5PGYt2pgcjn0G/0KjMlzyK1tv9YyTH6efz+JNLKiHdvz/639P0ACMMSS3y3+atSDWPBT//qqJ49//6I/Jf/9aJBEv//Rf//qcpEn//1GQawe1Pbqeq9ZRE2gCJQLIhmidI1E8jt9SReCIwfj//iM8QxcEcYzCritcegADJO+tL9FEmEW/X/rLtv/+siH+r/OlT//6J//g7+Q/4EyjOrpOmy1pItUmB+Fp//6wiU///WEz/1v/UJ//3/UtD//5uIGf+/9QRNBp7al9a6JkyZoOIDFEAZHIQwF+ZtZm/SLoNzwyhQKSP/1OorJX3/+gJ2/1fu5YGVU///QFRb//1jF/7/rF2vVlhES6X/4jPEFSdxGvRyxexraNwl34RKuERK+zgQ//8xhwHBf//mREf/9Gzwi///b//50vf/tUgTANBQb+V2mZfL5um6RMDLjjNxyBQAegBB8FFZQFzjLmBcJg1TWmgh5TBADIueM0zM+YFxB0EEFpppyZ//61uLC//6dCkN9N1N//LBdV//8t///MT/E0oAhbnG0XnqqrzVV5nuVIT//+Hg/+IzxLtykx9sctoMQejcKJGb/9UWVH/+QxalESr+qz9KtL/0v5ia9aFaqLakjIWcKCHEkXS6yki8Xi8RYuj6ELCyi2LlC/QA+IkOaH5ETJQjyKqRpLRuTKBeJ4jRoG5UIcbLNTF6JrWoyN2S6/6+iXjZ/+tGki5sYoF51//zIvP/Ue/0yQB8CIw243JILv8xzqlJgnAWQdv93TJEIv/iMcTa26Mii97mNjFi2KPE4SaD/7y8bGrpJP/7ompr1Ja9VE2calKOyP+q/yHXVCITrJ+uk6c9WNOOONNNNBBGpOSkw8C+PN+6SgzPFUiITSIfHHXtSY5pe05/29zpprI//cQInOS2It2oCvx6rjNWQ679tyJTpdRMwswkqGwFTif+j0OIsAw04qnp6OLFlT7+l2YzoQz/QmNmq//iM8QSJ6Ud05bCXjtU2G/vr9/vVV9rGmxfRQdH3XFr/0vtd3fTdvCqx5NA6C0PTLS7+YpyDhECw8Rjoq0peJiSnV/+6+Z+onur3rvibZ2Yk00VHjoPEBYRkUmA8OE7QQYaJnWf+qAB1oxJf/HJAUn2jEZ1QEAwfGm0dCn3W5jLbTGdzzH8XbUn3D6Z3vv5++nOivRmI2/tltT8VPz/4jPEEFq7IROSpjZBUNjc3Fu2Rezl++Htt17t0RO9JdN8vd1XdR2y2iiTFV9iFfXb4iXJCMZkssOtZuhnMHTrFKLGvdHe1z3U7W21UU2oqpmjzLv7hmlrW+plGXSyTuINSpTs4FVmQH5JEIpPQyMJpTcTcbO62A2Nktc97M9Npi4+uJQLTgwDKN59BuKXL5MChAbuWzMkZMxmbnkH/+IzxOv9xCNTzp5XRVgBNTJbupaSTJrW4hEJIkgswfR7J3QQNJFFKNyGis0O//WboCpoFs0LhFhCEOPGcr7VNUxFDQkSSGYHAdNxzC6bifBSYn0AwAgYCEAGDQ+Fv4LAgLNgYfHgGTC+Bsk4gYgCLPu3qfjllcghibi3iAg0DyROE4Z0BCAwErGXD2AMLgQMJiCoZZD/BkMLsFkE+f/iMcTRWsQ/rIK+X4uoADyv66tv1uT6mZRoVzBA+mbpq1ICtQ98LlkGRTIcRcRgRUvkCICMYGABkEydJ4Un/0P8Wsd5vQIOT5gxAHhyaUz6HHLeaZmhOGv//sSr///Jtv//UTf//rY0//9Z0rJf/9ISwSdT6+z1WPyZD5QJiHOIqTKLIt9W5kM8QVSXd7fRRNSGLb/+ucIz//6l1//iM8RXg1IXtHLihcqYAP/6jI1b//rLKX//zNgQaGCWKpb6NlXZNCpIT4Iz//1OOAkFJv//cBh/6/8K3//zBr//8jTD//0Qakgc3SXUmktnU7nEnlIBZUDpxokPlNTpf8xAqBKqRk1dFv3xm0v//NwyDb9X+mLcl//5HDTf//x/f//4/tIkhlCXKlR52kzsinWlOIAhw7KTf/UpzAD/4jPE8uaBGhxyzqxqqNyVEBP/6uwQ57+v/OApv+r/SIf//qKIkjf/u0xBqGAUP6TKYpp01LsYF1JYvASQQDAqKbkBJM4pd/2IeAQBQuWQ8zV+2qtnFhNUv/+ahdL/t+xiKUZ//+Uw3p//t41TT//1i7K+UkZqRk6FboIJILToMmgDSdf/9J5oSxz//vAqn//+oFb//6nf//MB2of6/+IzxJHFph7scsKsg2rcC0+TZsDQACkscZgRcrlwnEy+kXDQwIIUxxlgQoBGUA0AHYShECfNicWnpvUgZmQEBhBjc0OpmDLTQdBlp0Fitje1a/+pBMQqu3/3zhGq//8smC///JUqN/t/I0t1D8DpH3GkDh/s1aqTH1gafNnHklNNvCMcGpY9f/sehxw2Jf/PZ3mjU3//0Uf/+rMk0f/iMcTfALghnHLN5Gqo3PM6VFTOs1H4C6Aowc5Jh3FMepRUZDmGcJ8JOCEiCATIQMD4AjwuoO4L6IkCZCelizZA8XlqTHqPwT4vjKLwmI4i+y5sXnMWdRuPU1SpWUipN/Vk0lknWv/o0jRAezt/9uYj1DP8ShoAfhLG5JG5BKf+k5JmC0AUqY//yEEERJGKh3/ScVKI335rTSI8ev/iM8Tj/b4mA9rdrhna2Erqg+JjdJyLNITVqyE3qzGzURegyOOopEPhsLRrTXfscqITKc6H0msYcQsBSIQXRMGxATHaJ7lSQlBdAKig0lNzbfY81HOt/6mkLOpppK7uuh0sFYwmJVS3/6kLJ+oFWhCuvckiLHS1tQ5v+6WlIAwmq//lAHCUOjg2U02mc800ajUVDU1jv/NNIm//S/n/4jPEr4G0IQPewj46lNhrXOh21vDWw727q3XBtf8JHkTra+v2nWw2nOuWtSNWwbSagdAJIxqCSAiPpKNj0tlE1NacqsO5Q3JsS1sHoSc7bTrva2odf/LWta3lrWwkujdOSNja2sRpK//2trdfutrf4dX+1E1b/////////////////////////////////////////////////////+IxxL01viW8FpY2WdbY/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+IzxIgHtBDAAlwAAAAA//////////////////////////////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/iM8RdAf8jgAJcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABUQUdDYXIgSG9ybiwgc21hbGwgY2FyIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA%3D%3D';

	SOUND_FILES.alert.OGG = 'data:audio/ogg;base64,T2dnUwACAAAAAAAAAAD+BwAAAAAAAFQdFb4BHgF2b3JiaXMAAAAAAhErAAAAAAAAcMYAAAAAAACZAU9nZ1MAAAAAAAAAAAAA/gcAAAEAAAC6FRvfDHr/////////////vwN2b3JiaXMdAAAAWGlwaC5PcmcgbGliVm9yYmlzIEkgMjAwMzA5MDkFAAAACAAAAENPTU1FTlQ9GQAAAFRJVExFPUNhciBIb3JuLCBzbWFsbCBjYXIHAAAAQVJUSVNUPQYAAABBTEJVTT0LAAAAR0VOUkU9T3RoZXIBBXZvcmJpcxJCQ1YBAAABAAxSFCElmUJKYymVUlIpJRljEEpooXPUOSedg9RBiMUY44MxLtZia2kRUlYhJRlTDFtolVJUKQUZY1JKaKFz1jlGnXMUQifFCGOMLr62YltJHWPWMSYdU4pKKJ1j1DEGnWNQSggldBZCRyV00DkGxRhjjDHC1yJbiq3FnkrprYWMW0q11tpSKraVVGSKxRghfA5G9+JbSsUYY4wxxghjZMuB0JBVAAABAABABAFCQ1YBAAoAAMIwFEVRgNCQVQBABgCAABRFcRTHcSRHkizHAkJDVgEAQAAAAgAAGI7iKI4jOZJkSZrlaaIniqar67qu67pu27Zt27YNhIasBADIAAAYJR51DkJpjEgQKeakGGOEEEIIDYFFFXPQWgiuc1BKzBBYziDlpEJgOWQQg4yBBxVCyjkHInVKKQYluFZCxhwQGrJCAAjNADBIEiBpGiBpGgAAAAAAAABIngZonghonggAAAAAAAAAkuYBmugBmugBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACB5HuCJIuCJIgAAAAAAAABoogh4ngmIpgkAAAAAAAAAmigCnikComkCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACB5HuCJIuCJIgAAAAAAAABoogiIpgl4ogkAAAAAAAAAmigComkCnukBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIcAAACLAQCg1ZEQDECQAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAABgwAEAIMCEMlBoyIoAIE4AwOE4kgQAAI7jWBYAADiOY1kAAGBZlqYBAIBlWZoGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAGDAAQAgwIQyUGjISgAgCgDAYCiaBrAsgGUBNA2gaQDPA4gewDQBgAAAgAIHAIAAGzQlFgcoNGQlABAFAGBQFEeyLM+D52maKMLzNE0UIZqeJ4owTc8TRaim55kmVNXzTBOuK4qmCUTRNAUAABQ4AAAE2KApsThAoSErAYCQAACDokiS53meKJqmqqoqPM/zRFEUTVNVXRee53miKIqmqaquC1H0PNM0TVV1XdeFKHqeaZqmqrqu68I0RdE0TVNVXVeWYZqiaJqmqaquK8tQVVE0TdNUVdeVZSCKpmmaquq6sgxE0TRV1XVdV5aBKJqmqrqq68oyME1VVVXXlV1ZBqimqrquLMsyQFVd13VlWbYBquq6rivLtgxwXdeVZVm2bQCuK8uybNsCAAAOHAAAAoygk4wqi7DRhAsPQKEhKwKAKAAAwBilFFPKMCYhlBAixiSEEkIlpZSSSqkglFBSKRWEEkIKJZOSUkqlVBBKKSmECkIppYRQAADYgQMA2IGFUGjISgAgDwCAIAQhxhhjTErIGGPOOQchZIwx55yTUjLGmHPOSSkZY8w556SUzjnnnHNSSuecc845KaVzzjnnnJRSSuecc05KKaVzzjknpZTSOeecEwAAVOAAABBgo8jmBCNBhYasBABSAQAMjmNZnud5omiamiRpmud5nmiqqiZJmuZ5omiaqsrzPE8URVE0VZXneZ4oiqJpqirXFUVRNEVTVVWyK3qiaJqq6qoQRVE0TVV1XZimKJqmqrouZNk0VdVVZRe2bZqqqaquC1xXVV1XloHrqqaryq4AAPAEBwCgAhtWRzgpGgssNGQlAJABAEAQgpBSCiGlFEJKKYSUUggJAAAYcAAACDChDBQashIASAUAAAiRUkoppZQSKSWllFJKKaViTkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllBJCCAUAYlc4AOxE2LA6wknRWGChISsBgHAAAMAYhBiDkFJrMVYIKQWhlNZazLVCiDEIpbTWYo1BY85JSanFGGMMGnNOSkoxxlhrUCmElFprMdYcg2shpNRajDHWHoRQrbUYY8015yCEaynFWGuuOQchdI6x1lxz7jkIoXOMsdacc+5BCOFrrjXXmnMOQghha68555xzEEII4XsOOteggw9CCJ9rzjnnXACAyYMDAFSCjTOsJJ0VjgYXGrISAMgNACCMUYox55yDDkIIIYSQUssYY85BCKGUUkopJaWUMcacgw5CCCGUUkpKrXPOOQchhFJKKaWUlFLGnHMOQgillFJKKSmlzjkHIYQQSimllFJSSp1zDkIIIZRSSimlpJZC6CCEEEoppZRSSkkppdQ5CCGUUkoppZSSWmophBBCKaWUUkopJaWUUgghlFJKKaWUUkpLLaUQQimllFJKKaWUllJKKZVSSimllFJKSSm1lFoqpZRSSimllFRSSimlVEoppZRSSimlpNRSS6mUUkoppZRSSkmppZZSSqWUUkoppZSSUkuppdRKSaWUUkopJaWUUkoplVJKKaWUUkprqaXUWkuplFJKKaWk1lJrqaWUUimllFJKKQUAAB04AAAEGFFpIXaaceUROKKQYQIKAAAAAQABJoDAAEHBKAQBwggIAAAAAAAIAHwAACQFQERENHMGBwgJCgsMDQ4PEBESAACAAAIAAAAAAAAAAAhPZ2dTAAAAJQAAAAAAAP4HAAACAAAAkgBOGSYBR1dcd3pvZ2l0cXVxcIWAdXFnb21zcHSGenF2bG1scG9wg3x4aQBqiIBTQwQchNkwVCf+dq29PWf/27D2DN/Ghya9Z3EW58HBFsjMJBDBZ08x2xatZIJg/SYeghIFoVrZJiR4yH8PGN/mOtp6Cm7I9gs3ZPuFVPNQVekASNm1S7VSzbmwYi62nYtzGczlruzKzmorIlYugigEe8AA4GAT7VS7m5AI+fxpRF0/fRXpBpci7CEPBNTbjAVSQvceFhGFHH/2B2rKrZ2qKbd2alhA0oYtq0tmpIASKBUsBYBYFCtsZAJyYNvmCsJIsLTgswre//NeZQ5WC8LMNJWB9HBfMpnuh/sShYM2X37VWQmxZbUAZGGVAUB0rRbd7XtRAgYvbtix5L5hx5J7rA1Q28cmESK5bDabsACwY4yYEGJCiWw6nU2aMZKFpaWFdqxY3epWWVheddXFds7KGDFXti1da63SrtmMKDCWVqxYzYoBACrW4eHhXiFm22LtJm0BoGtf8hXRehoAoPteANTSioUAJLNt0/1wyQCa4qSeKm2Kk3qqdL5eBwkAsOuAOZsNSMF2FmNMZxIkMdEJZ0uJAIDojLDByXTSiRQRS2kAwMGlMyeuUADA6kRXrKbL1Q7ACwAwB7OlBKshi4srl9uMmMuH+8rMTGYLgK61703SboSp2wSybdEAoI8F0MWVq65cXjmWBJ7m8e56mse7ax5YHQCASUY1AJhOHTgkYMBGAIsLAGUVSDmZSiaSiWTAZDKJaAIACgEDAIDJZhJOGQAAcAxEAwAAZBSFBQI5mGwqBAAAACOJIMCJC7VXAACrnX1WXaUaoSGQucqKBiium0NzCug9AJrmQ4qraT6kuD4JAJm1AgCsCyBrAoA5G6BvEBUAuNsGwJJB0LIAAAnSBgAATAQDAGBZJhgAAACIwQIA7BQAAAADAwBkLq1oAGD1loAALK9MATeyCoCuACTQrroaAYCxvHICQJeXVwSa50OC2TwfEsz5BAIA4AxgJbCoA4MFblBUARC9QRJkAAQQnW0BAEgpKwAAwKCEAQAASGQtAAAAnIlJAwAAcowOAAAAANEJA1ZFAABAYG0AILKaxQAAc6wCQAR4DQBYqaCBdvVLAIAVUwGW50Oia3k+JLrmAQMAcAawArhCZQYAJhBVAGwmQA5YWEEdAFRBWgYAIUjGlhUASJMSAAAAyWQGAADAxBgNAAYAOcYAAADIykQBABgAE4IAAADkmBUA2ABSEGCq1VQAADBwAwBdWP0iACBjVQUsAN0DAIwVApbnQ5preT6kuT4JALJWAIB1AWRVAMAlVQEAgwzYTIDwYeGABcgQCAAAEEIoLQCAdEgBAAAgOQYAAgBBEQsADIBxzAIAAIgUUQAAAAABAAAASEkYAAxAcBqwxbQDAAD0G8Di8goAQJdXAFgATwEA7HsAkufDwUyeDwfzAwAUNQAA1gUQFQkAMwkcAtAHN6iIBMDTChIAojIBASDIAA6NJgCQiWkDAACgEAKAbBBWNisAEACIKAEAADibTkYAAEAEBQAAAABHZwwAMoAdQwQnGFYAAEC/AUhWLAJYARArBAAcKADU6hsAludDomt5PiS65gNIAIAxgCtUSQB4QlQBcIMqCSDTAQGop2wQ2AIIcmxlAAAhJLICACFikEMAAABAkmMAAAACkQAAAACg6JQAAACUVUqgahUFAABZsbqVAaB4FABsPQQAatUAuAFgywIADicA0Kx+OQCa5+F2N8/D7Z7fAAEAMCaBK1QDgEEGLAyQaYAOImsDEkEhxkYAAMGOBgBQSICkAIABwMjpECRJUgghoUQ2aUAAAABKKQA2FkMEAEDEWLm6AUAsPK2AAytHAEAcRBJwDmAOC6DEdqgAqNWuBACW5qoBquVLqVktX0rNN4sMkZGRkVkzaq1ZAYCyPH1AAps5C+gFOdDdMYYYY4iKOARFK0QAAKOYDAIAgFQikTIZAAAFhUwyKJEGUIKkSQbFBM5k0yEhw1kHcAlhZZiVNGQuLa6YRXUBOnv2fTnYU3EuB6wJpF3Igqx2RQtQCysNAMQKSxMAySqWJoblOYmG5TmJvgEAAAAGMDra5V0EAKKWBICIEJUWAChYcurKhSmqaqJisZqqLhUAALG1d7U8J0CsbtUVXZirG6vAYrs0MzNWDkCNIpDVTZXo1lnSRjObdpWZlUtdUGg6FlfTZMwxo5WurSSsnwViYXGF0Y4AcIwASFeTAkCz+hkAfuXDLPzKh1n4BgAAAOg8b1tHIwFA1AoA0nRqAUzDKhZbW0McHbo0FQAE006crhIBak5jMVIgq64msyOLK5YHi2OOdKZbYBSjWjFXNJDXSWR0jjnMFSuHgEYsLa5mcWGmaNTaCuD6VOPQclWq8AtADxQArC0FdtyZpXbcmaW+AQAAAKpdQuSuRQKAaAYA4MyBnSggoioiVkcXThAAANOZzeKKFKBzKWtWCqL74WE0NmupHuwxsnCcTsfKCl3tQhrzs1XgcJbZA0KyV4o82vf3gvJKryCNpRVWjiKUVy4FGVtlTYPbPgF22kOC7LSHBPkDAFRXJEBQZNgudFgjASCqFCKAZFuWS6cCiBiCWsVq5HBDkEM2TVGsZNs39hi2ldWMrxUOfbTtpN23labhKbPQrpV1UAJINxtSwpuqsDQlzRzsWzVIB1Y6+xTU4aQAbtfDBON2PUww/gAARVUCJMrcdibVsJIAZA2sYCFFBQXJcHRoQQUTRFy60NUsL2AGY2GxCj9oW0h2FdZqxtbyefpRb41pOt12Fefh1Tw9DsLMWKm0eMflrs6IxvR78l2PMJlma9ba155WstbaVgEActgRRTnsiKKnOhNESjUzB4Ow1VDDGoQMioEYAoSYUbTtdCpJyCY6Vtcs3bfVQ1qriZXatQfSw65sbbNFxNefBaWPyxXe9hYidXiYUEB0n5kVbfSIFXVQqlDXZLWd6eyq021Tkz32NSJdW1YLAG7XDHS7ZqCnZgEQqWZVbMDStq6RrLYRwVHRjkGp6Jh0JBoplUk2WVhc7IIuZCmrrRUzRDo60hWztmZr1opMzW5fITku/XT06JWqqJWLS6EEIdn3qgZFDlvICt00qUbrADJs+9pWkzksLq5oppa1rcjaAABu1lGgm3UU6AcAMIBqq6FWawWAFGknISk7JJKpQHRqtbdiiBoWtcW0Olk5MmsUxYJkT7bVhkY77NNWSHOcgz4n6kvVaZXqwqnKrm2mbSul2YBQxvv39FJrF7tG5mjbmY6xsl1r38Za7UEGM7Oy7ysAch/dcu6jW/4DAFQUMhOkFLkdoW21AoCIoBCiIohgiE5dWS2GBUTEatiaTlZZJY1AO1svfD49de1tV5uVdu2VXgt4JLMNCZpKyNbVtk0nsbo3sywTLVvW6tpXFdJHvTV/wV+LMpXEvkeosOpx3gpu0V+9yyqe5wOK8TwfUIxPRSEzAVnWAgAw1IHkUweLTQKh1hhNDAKFgCIlAQBnYjoBAoMCshPRGVtBjg4pZZRIhkRCtgEnhq1VMBUxRNTi3OpXFtUamYtl7aWSrmxduerKxZIEEt2biWbUAG02q9Gd0zO4/BWA9k9F1DtvIbSi08IqSyNJYA4cHi4zAZboQ2gu0YfQnAdsAADOACaAm6IqAHAIQCfgGlRWBYCNH5CARcIGZGHsQKsCAAgIAABQyAYLAACkECAAAGAgEZNYBgBA6WwSARgQDkExyBgAkMFKJm0AsIycBMDi1ImJKKKIihqsWLmMAKDJIQBUdgDguwmwCUBXswAAlujDjLFEH2aMTyUAiFoBAMYAbiqrAWACagJwDdQAYDI2GBwNBhCI0CgAAM5mAQAAHOQQAQAAcCBGAAxgO0YHAAAAgJgxApeuTAsAAKiufmkVAIhk5aoAoFm5XABADwoAsADAagQAlAAgOTgAAKxurgqW6MNEY4k+TDQ+ZQCAKgCAswAS2OrABIqKBHANogqAkQ4IwCAMtgzCitkSAHAMEQAAwJkYIwACQA6ppAAAAKQQHAAAAOHgAAAAACCyAgAACE4RwM7GagsAAGLKWFoZALC42gUAgG0BAIcCgG12ACCHCoB0lVUKkujD0EiiD0PjkwCgrBUAYEhg2wCDTsA1KKoAmNIGSQCQDcJBNFsAAKTTigAIACsiAwAAWNFpAQAAAjsAAAAAhmjAzpVpBwAAsGLlqgBArAIApKtJAACHAQAOAQBj1RYA5AAA6NIqAgBWm9UAlufDBHN5Pkww5wF1AIAzgAXY6oAnqAZgYQJkmgCgGpKAAQBArZIAQCKRDgAAgFE6AwAGQKSSUQAAAESZCAAAiEAUAAAAgAlEcObMxhQAAMSgKwYAMNkBAA4C4BsA1uEAAGsHALqwOgGA5aXVAZrnQ4rZPB9SzHlABwBgrACuqUwAGNQTFgYYPgg6CgxgQCHTygoAEEgJAAAw0TIABgDJzggAABCpVBIAAADAISLA1qG9CQAAyKqrWyUAgNkAQLtaAACHCwB4AAD7NgDAlgKAjNWsNgBgNVk9AJLnw8FMng8H8wMAqAkAsC4AVQDgClUAwKcDFgbgPghWkACgCjBEgQwKcmkBAKSdigAAAMIEAASAHEMEAADACiEjAABApNJJAAAAACsiAADARgCABCChAPbOMAAAAJM0AGBtBwAA2wbgRoCsIgBgTwCO58PBPJ4PB/MDAEQNAICzEpgArlANACaQ1QAsTIJMBwQgg5AEGARQmgBAyhkDAACynRYAABAdFAAAAMDBIQIAAEKOBgAAAJSMGQGABECCCNg5M6wAAAjKZwAgWbEIAMg6BLCNAFsXADCHBQDt6gSO59OA63g+Dbi8AQCcSWAWcE1VAsAgEq5BUQnA1BMAVEPLAABSMSMDANiYbMYAABYBEQ0AACBCKgUAAAAxOgIAgAVgWYbMoWp21sLiSrE1RUVURQRAuwcAGKstAKAOAIADAJCVAAArAIB2NQIAI6sHnuYDCe6n+UCC+1OZQUZIEZnVAAAnAZMg9nQAnw7Y6IDwQZAiBkUbExUoAAAnFAAAJJxMkzIAoFQ2lchmZQAAQCglsg4ko4hOpWI2mYrZQEwaAABDjADYWa1YsJoYKJjOWFgJAES2VUQLkrFSxkC6vwCmVIC23Q8DAHKwbwUa6Cpz1QCK40PWVRwfsq5vAAAAgLOABYwlFmBXUe0AAFFrAIAgoygAwBmFBIoAAElLMSQSaRsAANS5WkyrqMU0MV3ZmM5sbKwqVlFBbMWxdgkAEvtBUyuErNwv2zTNwsoVC8uzY4agmm5pSjgcTxThcoBkaWWqAAbZFgCyb80AIO8lguTDkILkw5C+AQAAACJ3ScQUBI0MAEQpACASAMBp0gAWp64UiwgYalgcHZ05sXPEaoiAiI0rm+1wK8Dq4bLtoCvWnpUsrlgc2pJF6beiRTEralkHeytt7kNDkYPtMNZWBYzFpdUmbazsKpAilwL04DA7gCbaw4MAdt4FQzvvgqE/AEBWJ4CMyqiqXXUrGwkAGiYKAFCIAad2DgQEEBDTyViaAVhY7UK2YkjTdbC20nf8XedRVOeRzo6oPQ3AVI6mXVgVc4ECtrQrAE2lzTX7MUpZWHXF1ABpOuYqMxPgrbwET2dnUwAEwCoAAAAAAAD+BwAAAwAAAN6ujesGcm1wY0UBdtxDhnbcQ4Y+tVSSKUFR1gIAUG0X6oJJWG1LwUEQQ1RsBgAQcIwOMROiYgBbi70BACC2DozFFYC25sLiAaloI92T1SArK1Y2685r2ksPJ1ldB3s02/horqZ6GNmaEFRpN5Gk30oSGvF9f4LSrV0RsHYActZ0pJw1HWnPwHSqtp22rclsNhtlYZHMZrT6xdV0sUUsLK9mWmXVpcWluZB0WhXt2vZp6HKY7Ljfj1+Vmx/mNWssmtmn00fa87pns2bJvq0QOXxzV0KrqYSq3+rG7MnaVreVannfs65U6T4CAGrTqMRq06jEVkC/ZlUWACLDB4RhUiOsIZkyAdsYpYOiiAEAxagYhQGAqBhj9wO6ra4m+1QA/1HZVvdBVjtr3Tf1qqodqitHNUk1tBjqicXlgqd7JJ1KUqFBVqjZa8XM5vCgwZiVyTJro3PImnW4DwBmUEcuM6gjlxcAKKprlDIAiGSoqhpWYgBFGcAOjigCAIpEhwcr9qHp2Eco0GFpZQH49HTbs0Z1mnKlSld5lS2le3klk+J2puEV/O0J6zoM3rwXWfTgcGYhNOns00pndXRbKQBqCf+mlvBvWKiqc1qJ9TiHaAJXeuJepg6p45l39XyrmQFmhldSgaztcKxtiX7utWltJWsqhZOT+fW69088+TiYPWnJMgEA';
	SOUND_FILES.alert.DEFAULT = '<span><object type="application/x-shockwave-flash" data="http://thorastur.99h.com.ar/dewplayer/dewplayer-mini.swf" width="160" height="20"><param name="wmode" value="transparent" /><param name="movie" value="http://thorastur.99h.com.ar/dewplayer/dewplayer-mini.swf" /><param name="flashvars" value="mp3=http://efectos-de-sonido.anuncios-radio.com/CARHORN.mp3&amp;autostart=1&amp;showtime=1&amp;volume=100" /></object></span>';
}
  
var provMapCoords = {imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31, topMargin:19};  
var JSON;if(!JSON){JSON={}}(function(){function str(a,b){var c,d,e,f,g=gap,h,i=b[a];if(i&&typeof i==="object"&&typeof i.toJSON==="function"){i=i.toJSON(a)}if(typeof rep==="function"){i=rep.call(b,a,i)}switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i){return"null"}gap+=indent;h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1){h[c]=str(c,i)||"null"}e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]";gap=g;return e}if(rep&&typeof rep==="object"){f=rep.length;for(c=0;c<f;c+=1){if(typeof rep[c]==="string"){d=rep[c];e=str(d,i);if(e){h.push(quote(d)+(gap?": ":":")+e)}}}}else{for(d in i){if(Object.prototype.hasOwnProperty.call(i,d)){e=str(d,i);if(e){h.push(quote(d)+(gap?": ":":")+e)}}}}e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}";gap=g;return e}}function quote(a){escapable.lastIndex=0;return escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b==="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function f(a){return a<10?"0"+a:a}"use strict";if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;if(typeof JSON.stringify!=="function"){JSON.stringify=function(a,b,c){var d;gap="";indent="";if(typeof c==="number"){for(d=0;d<c;d+=1){indent+=" "}}else if(typeof c==="string"){indent=c}rep=b;if(b&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":a})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e==="object"){for(c in e){if(Object.prototype.hasOwnProperty.call(e,c)){d=walk(e,c);if(d!==undefined){e[c]=d}else{delete e[c]}}}}return reviver.call(a,b,e)}var j;text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}})()
var JSON2 = JSON;
var butON='<img align=absmiddle src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAACB0RVh0U29mdHdhcmUATWFjcm9tZWRpYSBGaXJld29ya3MgTVi7kSokAAAAFnRFWHRDcmVhdGlvbiBUaW1lADExLzA1LzA33bqJ2wAAAq1JREFUeJxlk09oVFcUxn/3vskkqZoJGRMXTgQpCga0qZkUChEtFjFg6giuVDAgbaQroV2WGgUXXQiudJlVyDJpKRVKwYR0YXVqtNrUP1SSOMYRJpjJjJn3Zubc08Uzk4n94HDh8N1zzvcdjlFV6rHn75P7oqbhkqc26WET4oTAlTOBq6QDV774oufmX/V8U1+ge/bUuGdsaiHI8kYKCAKAh2UzzcS1hYqrTix8cvPEhgLfZq41TRXuPctVlxNz5cVawVZvCwDLUqjl4rKFZolmtr9t23X78zHfAvy2cmes/nOq9RAAM12jzOwZBbeeW/IKFE0p8W9TdgyA5OyZ3v2zp5V0j5Lu0ZHcT6qqyvTHugZ+3quqqiPZH2u8rVMHte3WgV7ru/KVhSBb6zwYHwhnXaqsO1UNfRrc9gWpyAEAilGfipErttk0dr15p/Fs/BgAFx7+AMBceZG51VDWhRdXQ07HAJQcQUQwFe0yyUdnNO3/A4D2pEPzfvmU/CafWCwGr8vkq0Vi29tY7p4Mnf/1I4g3sDkXISJOeB8GAx945KUIbQDRMLeGkgNA1GGrTl56WAAmC3+GY3YeXyfbMNbkTebuvts/iJOX3qavdh4VdR8GVJgrLzIYH+Dotj7y/gqPK/M02UbOt5/kWuc3oZEz3zEvWaz1UHF/mN3p48mqyt3n5hUAFzu+ZLhz6H+yAIYfX+fSkxvQ3kAkr4iTXqOq7LjTP76Kn1rywm0ctN0Mdw5xaGtvbezhJ9eZyqWhJYLFoL5MuP4HJ4yqcnj6XNPTSOZZ0ZQSyw2rYbvAwYqEL0CjhRYPG4CuSkbnS7v066f+hmNq//2zcZymilGfICKo0ZphxgdbEAQ34fofbDymesSm+/YiellFk1p1CVGHIBkxLu2Mfu+O3H9Yz/8PLFlkbIqvT3MAAAAASUVORK5CYII%3D" alt="ON">';
var butOFF='<img align=absmiddle src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAACB0RVh0U29mdHdhcmUATWFjcm9tZWRpYSBGaXJld29ya3MgTVi7kSokAAAAFnRFWHRDcmVhdGlvbiBUaW1lADExLzA1LzA33bqJ2wAAAsFJREFUeJxlk09oVFcUxn/3zR9HaoJKgphMFGtCrH9alUTqRgWhJtDFjBRsNybURVWwFCqUUmgyghTcaKlLQXeiopOVIEhtNaDjaNVYiNXYjHGeDmhokpcw89677x4XL5lM7AeXezn3O98957scJSLU4unBzz+2PliSUdF4h0RjSaN9ghmnqGem75mZqb5PLuaGavmqVuD50a+yKhpPTT/K4dqjiO+FpGiMSMNKrJa1GLc8sPXC7fQCgUrhaeL1mRPPKoV/ks79wapgpG4pAIEzUY1ZLa2Y+uXFYMO2tu2Z3yoWgH2673xt8rLdKQA2Zh+wMfuAQOZj5uUIMl5Kcvf6eQD+/enrzuc/7JfcOiS3Dnlz5ayIiFxrQ+ZwZnV4ti+frfIGP2uXm7tbOy3tTByffpSrvtyQ7gVgxJ03yp21qWlvL/7OsBJrvIS45eNWpH75etceBaAh3QPAYOa7MNEu4BQLAIz9Esaa0j1MBGCVHbRlrbeMMc1zbs/1+eTSOVri8Hd6MwPdm1mk4E32HABr9qR4q0EZQ6B1c9Ron/ehlKIhAoEzSasACQBVvZ8Iwt34Gst4rq2iMQCm7v4BQPsXPfNfqcLVONuefSfkiFIY7dmRb9oau0TrtWZ6Etcu0JjuZdWuLqYmJzGjT7AWJVjx5UFW/XgKgN+/74XXL6iLxwkCk1NDB7o6As/Ne/kboZGH+/jwSP//2gLIn+wnfypDewL8+GK0DjqViPDXvu1Z89/blHk5AoC3ZSdrvu2n+dNd1bLzJ/t5dedPmmJQn4jjBjLQPeyllYjw8NdMwrt19ZmMl5KqNAaAY+CVD86sYXURaIqBisUpB1Icq5i2Q6O6smCYbnd/lDVGUtZ4CavsoIypGuZZMWZUBNF6oHvYWzhMtRjc0bLJoI4FYjq0MUnja/DdItq/h/Z/3jPsP67lvwOjGG1S8vVScQAAAABJRU5ErkJggg%3D%3D" alt="OFF">';

eval(GM_getResourceText('IMAGENES'));
var Options = {
  HauteurBoite :700,
  KDODef:0,
  reapprointerval:0,
  NewTab       : false,
  Smiley       : true,
  srcSortBy    : 'level',
  srcMinLevel  : 1,
  srcMaxLevel  : 7,
  wildType     : 1,
  unownedOnly  : true,
  mistedOnly   : true,
  hostileOnly  : false,  
  friendlyOnly : false,  
  alliedOnly   : false,  
  unalliedOnly : false,  
  neutralOnly  : false,  
  srcAll       : true,  
  srcScoutAmt  : 1,
  minmight     : 1,
  srcdisttype  : 'square',
  pbWinIsOpen  : false,
  pbWinPos     : {},
  pbTrackOpen  : true,
  pbKillFairie : false,
  pbGoldHappy  : 95,
  pbGoldEnable : false,
  pbEveryEnable: false,
  pbEveryMins  : 30,
  pbChatOnRight: false,
  pbWideMap    : false,
  pbWinDrag    : true,
  ptWinPos     : {},
  MapExtra     : true,
  OverViewShowExtra : 'maximum',
  salvageconfig:{running:false,CityCity:0,RepairCity:0,Repairrunning:false,},
  alertConfig  : {aChat:false, aPrefix:'** I\'m being attacked! **', scouting:false, wilds:false, defend:true,   minTroops    : 10000, spamLimit:10, lastAttack:0, barbautoswitch:false, raidautoswitch: {}, },
  alertSound   : {enabled:false, soundUrl:'http://thorastur.99h.com.ar/powerkoc/fliegeralarmsire.mp3', repeat:true, playLength:20,   repeatDelay  : 0.5, volume:100, alarmActive:false, expireTime:0},
  spamconfig   : {aspam:false, spamvert:'Join my Alliance!!', spammins:'30', atime:2 , spamstate:'a'},
  giftDomains  : {valid:false, list:{}},
  celltext     : {atext:false, provider:0, num1:"000", num2:"000", num3:"0000"},
  giftDelete   : 'e',
  EffetRouge   : 0,                  // faltaaa
  TroneInverse : true,         // faltaaa
  TroneRangeDebuff:false,     // faltaaa
  TroneRange   : false,       // faltaaa
  AllEffet     : false,       // faltaaa
  currentTab   : false,
  hideOnGoto   : true,
  transportinterval : 60,
  minwagons    : 100,
  lasttransport: 0,
  reassigninterval: 60,
  lastreassign : 0,
  HelpRequest  : false,
  RaidRunning  : false,
  RaidReset    : 0,
  DeleteMsg    : false,
  DeleteMsgs0  : false,
  DeleteMsgs1  : false,
  DeleteMsgs2  : false,
  DeleteMsgs3  : false,
  DeleteMsgs4  : false,
  DeleteMsgs5  : false,
  DeleteMsgs6  : false,
  DeleteTimerMinute:5,
  Foodstatus   : {1:0,2:0,3:0,4:0,5:0,6:0,7:0},
  LastReport   : 0,
  MsgInterval  : 1,
  foodreport   : false,
  includeCity	: true,
  includeTraining:false,
  includeTrainingTotal:false,
  includeCityHome:		false,
  includeCityRaid:		false,
  includeCityMarch:		false,
  includeCityTrain:		false,
  includeMarching:true,
  wrapCityName:				false,
  resourceProd:				false,
  showPopulation:			false,
  showBuildings:			false,
  showTroops   : true,
  showDefenses : false,
  dispBattleRounds: true, 
  encRemaining : true,
  maxIdlePop   : false,
  fixMapDistance: true,
  fixWarnZero  : true,
  fixMsgCount  : true,
  fixPageNav   : true,
  enhanceARpts : true,
  enhanceMsging : true,
  enhanceViewMembers : true,
  currentTab : false,
  TournoiLigne : 25,
  gmtClock : true,
  chatEnhance : true,
  chatglobal : true,
  chatwhisper : true,
  chatbold : false,
  chatAttack : true,
  chatLeaders : true,
  fixKnightSelect : true,
  attackCityPicker : true,
  mapCoordsTop : true,
  reportDeleteButton : true,
  overviewFontSize : 12,
  overviewAllowOverflow : false,
  curOverTab : 'A',
  curMarchTab : 'N',
  curOptTab : 'U', 
  playersNoCities : false,
  enableWhisperAlert : true,
  enableTowerAlert : true,
  AllianceLeaders : [],
  rptType: 'alliance',
  arPageFrom: 1,
  arPageTo: 5,
  arAttacker: 'Them',
  arTarget: 'Us',
  arAttack: true,
  arScout: true,
  arReinforce: false,
  arTransport:	true,
  enableFoodWarn : true,
  foodWarnHours : 24,
  LastCrestReport : 0,
  Creststatus  : {1101:0,1102:0,1103:0,1104:0,1105:0,1106:0,1107:0,1108:0,1109:0,1110:0,1111:0,1112:0,1113:0,1114:0,1115:0},
  CrestMsgInterval  : 1,
  crestreport  : false,
  Crest1Count  : 0,
  Crest2Count  : 0,
  CrestLevel   : 0,
  crestRunning   : false,  
  CrestType    : 0,
  ThroneDeleteItems	: false,
  ThroneDeleteLevel	: 0,
  throneSaveNum : 10,
  throneDeletedNum : 0,
  RangeSaveModeSetting : 0,
  enableReportNumber:	true,
  marRemaining:	true,
  atkAlliance:	false,
  tgtAlliance:	true,
  atkCityName:	'no',
  tgtCityName:	'same',
  allowAlterAR:	true,
  pu      : 0,
  Xrenfort:0,
  Yrenfort:0,
  AttackHorloge:"21:00:00",
  AttackGoHorloge:null,
  AttackOnOff:false,
  AttackUnits : {},
  AttackFav : {0:{0:"200K mil",1:0,2:2e5,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0},1:{0:"200K Heavy",1:0,2:0,3:0,4:0,5:0,6:0,7:2e5,8:0,9:0,10:0,11:0,12:0,13:0}},
  AttackFromCity : 0,
  AttackCibleX : 0,
  AttackCibleY : 0,
  AttackKnight : 0,
};

var upgradeData = {  active : false, Items: [],  retryInterval : 30, };

var ThroneOptions = {
    Active:false,
    IntervalMin:3,
    Interval:30,
    RepairTime:0,
	Tries:0,
    minStones : 100000,
	Good:0,
	Bad:0,
	Items: [],
	Salvage:{},
	SalvageQuality:0,
};

var Colors ={
    DarkRow : '#eee',
    ButtonSelected : '#71DDF5',
    TabClicked : '#EED',
    Tabs : '#1E66BD',
    MainTitle  : '#357',
    ChatLeaders: '#B8B8B8',
    ChatGlobal :  '#CCCCFF',
    OverviewDarkRow : '#f0f0f0',
    TabFont : '#F8E151',
    ChatAll : '#99ccff',
    ChatAtt : '#FF4D4D',
    ChatWhisper : '#FF4D4D',
    ChatVC         : '#00ff00',
    ChatChancy     : '#F5D349',
    overviewFontSize : 12,
};

var GlobalOptions = {
  pbWatchdog   : false,
  pbWideScreen : true,
  pbNoMoreKabam:false,
  pbWideScreenStyle : 'normal',
  autoPublishGamePopups : false,
  autoPublishPrivacySetting : 80,
  escapeurl : null,
};

var TrainOptions = {
  Running    : false,
  Troops     : {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  Threshold  : {1:500,2:500,3:500,4:500,5:500,6:500,7:500,8:500},
  Max        : {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  Gamble     : {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  Workers    : {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  Keep       : {1:{Food:0,Wood:0,Stone:0,Ore:0},
                2:{Food:0,Wood:0,Stone:0,Ore:0},
				3:{Food:0,Wood:0,Stone:0,Ore:0},
				4:{Food:0,Wood:0,Stone:0,Ore:0},
				5:{Food:0,Wood:0,Stone:0,Ore:0},
				6:{Food:0,Wood:0,Stone:0,Ore:0},
				7:{Food:0,Wood:0,Stone:0,Ore:0},
				8:{Food:0,Wood:0,Stone:0,Ore:0}
			   },
  Enabled    : {1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
  SelectMax  : {1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
  Resource   : {1:true,2:true,3:true,4:true,5:true,6:true,7:true,8:true},
  UseIdlePop : {1:true,2:true,3:true,4:true,5:true,6:true,7:true,8:true},
  CraftingRunning : false,
  CraftIntervallMin : 3,
  CraftingActif : {3000:false,3001:false,3002:false,3003:false,3004:false,3005:false,3006:false,3007:false,3008:false,3009:false,3010:false,3011:false},
  CraftingNb : {3000:0,3001:0,3002:0,3003:0,3004:0,3005:0,3006:0,3007:0,3008:0,3009:0,3010:0,3011:0,},
};

var WallTrainOptions = { 
	intervalSecs:	60,
	doTraps:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	doCalrops:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	doSpikes:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	doXbows:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	troopType:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepFood:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepWood:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepStone:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepOre:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
};

var AttackOptions = {
  LastReport    		: 0,
  MsgEnabled          	: true,
  MsgInterval	      	: 30,
  Method			    : "distance",
  SendInterval			: 8,
  MaxDistance           : 40,
  RallyClip				: 0,
  Running       		: false,
  BarbsFailedKnight		: 0,
  BarbsFailedRP 		: 0,
  BarbsFailedTraffic   	: 0,
  BarbsFailedVaria		: 0,
  BarbsFailedBog        : 0,
  BarbsTried    		: 0,
  DeleteMsg             : true,
  DeleteMsgs0			: false,
  Foodstatus			: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  MsgLevel			    : {1:true,2:true,3:true,4:true,5:true,6:true,7:true,8:true,9:true,10:true},
  BarbsDone     		: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  BarbNumber    		: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  Levels    			: {1:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},2:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},3:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},4:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},5:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},6:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},7:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},8:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false}},
  Troops    			: {1:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},2:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},3:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},4:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},5:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},6:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},7:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},8:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},9:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},10:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0}},
  MinDistance			: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},
  Distance              : {1:750,2:750,3:750,4:750,5:750,6:750,7:750,8:750,9:750,10:750},
  Update                : {1:[0,0],2:[0,0],3:[0,0],4:[0,0],5:[0,0],6:[0,0],7:[0,0],8:[0,0]},
  UpdateEnabled         : true,
  UpdateInterval	    : 30,
  stopsearch            : 1,
  knightselector        : 0,
};

var knightRoles = [
  ['Foreman', 'politics', 'Pol'],
  ['Marshall', 'combat', 'Com'],
  ['Alchemystic', 'intelligence', 'Int'],
  ['Steward', 'resourcefulness', 'Res'],
];

var CoordBox = {
  init : function (){
    var t = CoordBox;
    t.boxDiv = searchDOM (document.getElementById('maparea_map'), 'node.className=="mod_coord"', 3, false);
    t.setEnable (Options.mapCoordsTop);
  },
  setEnable : function (tf){
    var t = CoordBox;
    if (t.boxDiv == null)
      return;
    if (tf)
      t.boxDiv.style.zIndex = '100000';
    else
      t.boxDiv.style.zIndex = '10011';
  }, 
  isAvailable : function (){
    var t = CoordBox;
    return !(t.boxDiv==null);
  }, 
};

var CrestOptions = {
  Running   	: 	false,
  CrestCity 	: 	0,
  RoundOne  	: 	false,
  RoundTwo  	: 	true,
  lastRoundTwo 	: 	0,
  X				:	0,
  Y				:	0,
  R1ST			:	0,
  R1MM			:	0,
  R1Scout		:	0,
  R1Pike		:	0,
  R1Sword		:	0,
  R1Arch		:	0,
  R1LC			:	0,
  R1HC			:	0,
  R1SW			:	0,
  R1Ball		:	0,
  R1Ram			:	0,
  R1Cat			:	0,
  R2ST			:	0,
  R2MM			:	0,
  R2Scout		:	0,
  R2Pike		:	0,
  R2Sword		:	0,
  R2Arch		:	0,
  R2LC			:	0,
  R2HC			:	0,
  R2SW			:	0,
  R2Ball		:	0,
  R2Ram			:	0,
  R2Cat			:	0,
};

var CrestData = new Array();

	function CrestFunc (Arr) {
	
		if (Arr == undefined)
			Arr = CrestOptions;

		this.Running 		=  	true;
  		this.CrestCity 		= 	Arr.CrestCity;
		this.RoundOne 		= 	Arr.RoundOne;
		this.RoundTwo 		= 	true;
		this.lastRoundTwo 	= 	0;
		this.X 				= 	Arr.X;
		this.Y 				= 	Arr.Y;
		this.R1ST 			= 	Arr.R1ST;
		this.R1MM 			= 	Arr.R1MM;
		this.R1Scout 		= 	Arr.R1Scout;
		this.R1Pike 		= 	Arr.R1Pike;
		this.R1Sword 		= 	Arr.R1Sword;
		this.R1Arch 		= 	Arr.R1Arch;
		this.R1LC 			= 	Arr.R1LC;
		this.R1HC 			= 	Arr.R1HC;
		this.R1SW 			= 	Arr.R1SW;
		this.R1Ball 		= 	Arr.R1Ball;
		this.R1Ram 			= 	Arr.R1Ram;
		this.R1Cat 			= 	Arr.R1Cat;
		this.R2ST 			= 	Arr.R2ST;
		this.R2MM 			= 	Arr.R2MM;
		this.R2Scout 		= 	Arr.R2Scout;
		this.R2Pike 		= 	Arr.R2Pike;
		this.R2Sword 		= 	Arr.R2Sword;
		this.R2Arch 		= 	Arr.R2Arch;
		this.R2LC 			= 	Arr.R2LC;
		this.R2HC 			= 	Arr.R2HC;
		this.R2SW 			= 	Arr.R2SW;
		this.R2Ball 		= 	Arr.R2Ball;
		this.R2Ram 			= 	Arr.R2Ram;
		this.R2Cat 			= 	Arr.R2Cat;
		
	};

var CombatOptions = {
	research : [{tch8:0,tch9:0,tch13:0,tch15:0}, //Poison Edge, Metal Alloys, Fletching, Healing Potions
	            {tch8:0,tch9:0,tch13:0,tch15:0}],
	knt      : [50,50],
	guardian : [['wood',0],['ore',0]],
	ratio    : [{unt1:{},unt2:{},unt3:{},unt4:{},unt5:{},unt6:{},unt7:{},unt8:{},unt9:{},unt10:{},unt11:{},unt12:{}},
	            {unt1:{},unt2:{},unt3:{},unt4:{},unt5:{},unt6:{},unt7:{},unt8:{},unt9:{},unt10:{},unt11:{},unt12:{}}],
}

var Cities = {};
var researchLevels = [];
var Seed = unsafeWindow.seed;
var Tabs = {};
var pbButtons = {};
var mainPop;
var CM = unsafeWindow.cm;
var pbStartupTimer = null;
var CPopUpTopClass = 'pbPopTop';
var firefoxVersion = getFirefoxVersion();
var TrainCity = 0;
var currentName = 'Overview';
var KOCversion = null;
var uW = unsafeWindow;
var researchLevels = [];
var TroopDefTrainEstimates = [];
var playerLastLogin = [];
var allianceName = [];
var names = ['', 'Sup', 'Mil', 'Sct', 'Pik', 'Swd', 'Arc', 'Cav', 'Hvy', 'Wag', 'Bal', 'Ram', 'Cat'];
var crestname = {};
var ResetColors=false;
var ResetAll=false;
var deleting=false;
var ChatOptions = {
  latestChats : [],
  AllowUsersRemoteControl : [],
  BlacklistUsersRemoteControl: [],
  password : '',
  Chatpassenable : false,
 }; 
  var showMightKoCBugFix  = '';
  var showMightKoCBugFix = '#mainbody div#kochead.kocHeader div.taskbar div.rightColumn div.avatarInfo div.avatarStats div.avatarGlory { margin-left:30px; } .kocHeader .avatarStats .avatarLevel { padding-top:1px; left: -2px;  top: 35px;} .kocHeader .avatarMight, .kocHeader .avatarGlory {padding-left:1px;}';
  var showResKoCBugFix  = '';
  var showResKoCBugFix = '.kocmain .mod_cityinfo #cityinfo_1 table .grw {left: 650px;    margin-top: 25px;    position: fixed;    text-align: right;    width: 60px;} .kocmain .mod_cityinfo #cityinfo_1 table tbody tr td {    background-color: transparent;    border-bottom: 1px solid transparent;}';

/*********************************End Var**********************************************/
var battleReports = {
	init: function (){
		var t = battleReports;
                t.getReportDisplayFunc = new CalterUwFunc ('getReportDisplay', [['return p.join("")', 'var themsg=p.join(""); themsg=getReportDisplay_hook(themsg, arguments[1]); return themsg']]);
	        uw.getReportDisplay_hook = t.hook;
		t.getReportDisplayFunc.setEnable (true);
                t.renderBattleReportFunc = new CalterUwFunc ('Messages.viewMarchReport', [['$("modal_msg_list").innerHTML = cm.MarchReportController.getMarchReport(m, r);','var msg = cm.MarchReportController.getMarchReport(m, r); $("modal_msg_list").innerHTML = renderBattleReport_hook(msg,m,r);']]); //March reports battle rounds function
                uw.renderBattleReport_hook = t.hook2;
		t.renderBattleReportFunc.setEnable (true);
		unsafeWindow.deleteAreport = t.e_deleteReport;
                uW.MoreReport = t.e_MoreReport;
                uW.PostReport = t.e_PostReport;
	},

	isRoundsAvailable: function (){
		var t = battleReports;
		return t.getReportDisplayFunc.isAvailable();
	},
	

	generateBackButtonHook: function (msg, rptid){
		if (!Options.reportDeleteButton)
			return msg;
		var delBut = msg.replace ('onclick=\'', 'onclick=\'deleteAreport('+ rptid +',false); ');
		delBut = delBut.replace (/<span>(.*)<\/span>/, '<span>'+ unsafeWindow.g_js_strings.commonstr.deletetx +'</span>');
		return msg + delBut;
	},

	e_deleteReport: function (rptid){
		var t = battleReports;
		t.ajaxDeleteMyReport (rptid);
	},

	ajaxDeleteMyReport: function (rptid, isUnread, side, isCityReport, notify){
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.s0rids = rptid;
		params.s1rids = '';
		params.cityrids = '';
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if (rslt.ok && isUnread){
					unsafeWindow.seed.newReportCount = parseInt(seed.newReportCount) - 1;
					unsafeWindow.messages_notify_bug()
				}
				if (notify)
					notify (rslt.errorMsg);
			},
			onFailure: function () {
				if (notify)
					notify ('AJAX ERROR');
			},
		});
	},

	hook2: function (msg, rslt){
		if (rslt.rnds && Options.dispBattleRounds){
			msg = msg.replace (/(Attackers.*?<span.*?)<\/div>/im, '$1<BR>Rounds: '+ rslt.rnds +'</div>');
			msg = msg.replace (/%27/img, '&#39;');
		}
		return msg;
	},
	hook: function (msg, rslt){
		if (rslt.rnds && Options.dispBattleRounds){
			msg = msg.replace (/(Attackers <span.*?)<\/div>/im, '$1<BR>Rounds: '+ rslt.rnds +'</div>');
			msg = msg.replace (/%27/img, '&#39;');
		}
		return msg;
	},
}

var nHtml={
  FindByXPath:function(obj,xpath,nodetype) {
	if(!nodetype){
		nodetype = XPathResult.FIRST_ORDERED_NODE_TYPE;
	}
	try {
		var q=document.evaluate(xpath,obj,null,nodetype,null);
	} catch(e) {
		GM_log('bad xpath:'+xpath);
	}
	if(nodetype == XPathResult.FIRST_ORDERED_NODE_TYPE){
		if(q && q.singleNodeValue) { return q.singleNodeValue; }
	}else{
		if(q){
			return q;
		}
	}
	return null;
  },

  ClickWin:function(win,obj,evtName) {
	var evt = win.document.createEvent("MouseEvents");
	evt.initMouseEvent(evtName, true, true, win,
		0, 0, 0, 0, 0, false, false, false, false, 0, null);
	return !obj.dispatchEvent(evt);
  },

  Click:function(obj) {
	return this.ClickWin(window,obj,"click");
  },
  
  ClickTimeout:function(obj,millisec) {
	window.setTimeout(function() {
		return nHtml.ClickWin(window,obj,"click");
	},millisec+Math.floor(Math.random()*500));
  },

  SetSelect:function(obj,v) {
	for(var o=0; o<obj.options.length; o++) {
		if(v==obj.options[o].value) { obj.options[o].selected=true; return true; }
	}
	return false;
  },

}
if (document.URL.search(/kingdomsofcamelot.com\/fb\/e2\/src\/helpFriend_src.php/i) >= 0){ helpFriends ();}
readGlobalOptions ();

if (document.URL.search(/apps.facebook.com\/kingdomsofcamelot/i) >= 0){
  setTimeout(function() {
    var test=document.URL;
    var testt = /s=([0-9]+)/i.exec(test);
    if (testt) {
     unsafeWindow.window.document.title="PowerKoc "+testt[1];
    }
    }, 10000)
  facebookInstance ();
}

if (document.URL.search(/kingdomsofcamelot.com\/fb\/e2\/fbLoginButton.php/i) >= 0){
 var test=document.URL;
 var testt = /s=([0-9]+)&/i.exec(test);
 if (testt) {
  setTimeout(function() {
  unsafeWindow.kraken.network.redirect("https://www.kabam.com/kingdoms-of-camelot/game.php?entrypt=kabamHome&lp=index&cb=moar&s="+testt[1]);  
  },5000);
 } 
 return;
}

if (document.URL.search(/facebook.com\/4oh4.php/i) >= 0){
 setTimeout(function() {
   unsafeWindow.history.go(-1);
 },5000); 
 return;
}

if (document.URL.search(/kabam.com\/kingdoms-of-camelot\/play/i) >= 0){ kabamStandAlone ();}
if (document.URL.search(/facebook.com/i) >= 0){ if(document.URL.search(/connect\/uiserver.php/i) >= 0 || document.URL.search(/serverfbml/i) >= 0 || document.URL.search(/dialog\/stream.publish/i) >= 0 || document.URL.search(/dialog\/apprequests/i) >= 0 || document.URL.search(/dialog\/feed/i) >= 0) HandlePublishPopup ();}
if (document.URL.search(/kingdomsofcamelot.com/i) >= 0){ kocWideScreen ();}
function helpFriends(){function a(){var b=ById("claimhelpform");if(!b){setTimeout(a,1e3)}b.submit()}a()}
function readGlobalOptions (){
  s = GM_getValue ('Options_??');
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts)
      GlobalOptions[k] = opts[k];
  }
 }

function kocWideScreen(){
	var fois=0;
	function setWideFb (){
		var kocFrame = parent.document.getElementById('kocIframes1');
		if (!kocFrame){
			setTimeout (setWideFb, 1000);
			return;
		}
		kocFrame.style.width = '100%';
		var style = document.createElement('style')
		style.innerHTML = 'body { margin:0; width:100%; !important;}';
		kocFrame.parentNode.appendChild(style);
	}
	function test() {
		var alla = ById('kocinitloading');
		if (alla) {
			if (alla.style.display!="none") {
				fois++;
				if (fois>23)  reloadKOC();
				setTimeout (test, 2500);
				return;
			}
		}
	}
	if(document.URL.match(/standalone=0/i)){
		test();
	}
	kocWatchdog ();
	if (GlobalOptions.pbWideScreen)
		setWideFb();
}

/***  Run only in "apps.facebook.com" instance ... ***/
function facebookInstance (){
  function setWide (){
	var iFrame = document.getElementById('iframe_canvas');
	if (!iFrame){
	  setTimeout (setWide, 1000);
	  return;
	}
	iFrame.style.width = '100%';

	while ( (iFrame=iFrame.parentNode) != null)
	  if (iFrame.tagName=='DIV')
		iFrame.style.width = '100%';
	document.getElementById('globalContainer').style.left = '0px';
    try{    
      document.getElementById('rightCol').parentNode.removeChild(document.getElementById('rightCol'));
      document.getElementById('leftColContainer').parentNode.removeChild(document.getElementById('leftColContainer'));
    } catch (e){
      // toolkit may have removed them already!
    }
    var e = document.getElementById('mainContainer');
	if(e){
		if (GlobalOptions.pbWideScreenStyle=="normal") e.parentNode.style.minWidth = '100%';
		if (GlobalOptions.pbWideScreenStyle=="wide") e.parentNode.style.width = '1520px';
		if (GlobalOptions.pbWideScreenStyle=="ultra") e.parentNode.style.width = '2000px';
		for(i=0; i<e.childNodes.length; i++){
			if(e.childNodes[i].id == 'contentCol'){
				e.childNodes[i].style.margin = '0px';
				e.childNodes[i].style.paddingTop = '5px';
				break;
			}
		}
	}
	var e = document.getElementById('pageHead');
	if(e){
		e.style.width = '80%';
		e.style.margin = '0 10%';
	}
	var e = document.getElementById('bottomContent');
	if(e){
		e.style.padding = "0px 0px 12px 0px";
	}
    
  }
  facebookWatchdog();
  if (GlobalOptions.pbWideScreen)
    setWide();
}

/********** facebook watchdog: runs only in 'http://apps.facebook.com/kingdomsofcamelot/*' instance!  ******/
function facebookWatchdog(){function b(){try{if(ById("app_content_130402594779")==null){logit("KOC NOT FOUND!");KOCnotFound(5*60)}}catch(a){logit("KOC NOT FOUND!");KOCnotFound(4*60)}}var a=5e4;if(!GlobalOptions.pbWatchdog)return;setTimeout(b,a)}
function kocWatchdog(){function b(){if(ById("mod_maparea")==null){logit("KOC not loaded");KOCnotFound(20)}}var a=1e4;if(!GlobalOptions.pbWatchdog)return;setTimeout(b,a)}
function $(ID,root) {return (root||document).getElementById(ID);}
function kabamStandAlone  (){
  function setWide (){
	var iFrames = ById('game_frame');
	if (!iFrames){
	  setTimeout (setWide, 1000);
	  return;
	}
	iFrames.style.width = '100%';
	while ( (iFrames=iFrames.parentNode) != null)
	  if (iFrames.tagName=='DIV')
		iFrames.style.width = '100%';
		if (GlobalOptions.enableBrowserBG && GlobalOptions.backStyle=="backCol") ById("content" && "gameIframe").style.backgroundColor= GlobalOptions.bgCol;
		if (GlobalOptions.enableBrowserBG && GlobalOptions.backStyle=="backImg")  ById("content" && "gameIframe").style.backgroundImage = "url('"+GlobalOptions.bgImg+"')";
	ById("main-nav").parentNode.removeChild(ById("main-nav"));
	ById("main-header").parentNode.removeChild(ById("main-header"));
  }
  if (GlobalOptions.pbWideScreen)
    setWide();
  if(GlobalOptions.pbNoMoreKabam){
  var serverID = /s=([0-9]+)/im.exec (document.location.href);
  var sr = /signed_request" value="(.*?)"/im.exec ($("post_form").innerHTML);
  window.location = $("post_form").action+"?signed_request="+sr[1]+(serverID?"&s="+serverID[1]:'');
  }
}

function HandlePublishPopup() {
	if(GlobalOptions.autoPublishGamePopups){
		// Check the app id (we only want to handle the popup for kingdoms of camelot)
		var FBInputForm = document.getElementById('uiserver_form');
		if(FBInputForm){
			var channel_input = nHtml.FindByXPath(FBInputForm,".//input[contains(@name,'channel')]");
			if(channel_input){
				var current_channel_url = channel_input.value;
					var publish_button = nHtml.FindByXPath(FBInputForm,".//input[@type='submit' and contains(@name,'publish')]");
                                        var test =ById("feedform_user_message");
                                        if(publish_button && test){
                                              setTimeout(function() {
					      nHtml.Click(publish_button);
						},2500);
					}
				}					
		}
		setTimeout(HandlePublishPopup, 5000);
	}
}
var myServerId = null;
function getServerId(){if(myServerId==null){var a=/^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);if(a)myServerId=a[1];else myServerId="??"}return myServerId}
function ById(id) {return document.getElementById(id);}

function pbStartup (){
  clearTimeout (pbStartupTimer);
  if (unsafeWindow.pbLoaded)
    return;
  var metc = getClientCoords(document.getElementById('main_engagement_tabs'));
  if (metc.width==null || metc.width==0){
    pbStartupTimer = setTimeout (pbStartup, 1000);
    return;
  }
  unsafeWindow.pbLoaded = true;
  logit ("KofC client version: "+ anticd.getKOCversion());

  readOptions();  
  readColors();
  Seed = unsafeWindow.seed;

GM_addStyle ('.xtab {padding-right: 5px; border:none; background:none; white-space:nowrap;}\
    .xtabBR {padding-right: 5px; border:none; background:none;}\
    table.pbTab tr td {border:none; background:none; white-space:nowrap; padding:0px}\
    table.pbTab2 tr td {border:none; background:none; white-space:nowrap;}\
    .hide {font-weight:bold; color:#060;}\
    .defend {font-weight:bold; color:#700;}\
    .Hostiles td { background:red; }.Amigables td{background:lightgreen; }.Alianza td{background:lightblue; }\
    table.pbTabPadNW tr td {border:none; background:none; white-space:nowrap; padding: 2px 4px 2px 8px;}\
    table.pbTabBR tr td {border:none; background:none;}\
    table.pbTabLined tr td {border:1px none none solid none; padding: 2px 5px; white-space:nowrap;}\
    table.pbOptions tr td {border:1px none none solid none; padding: 1px 3px; white-space:nowrap;}\
    table.pbSrchResults tr td {border:1px none none solid none; padding: 1px 3px; white-space:nowrap;}\
    table.pbTabSome tr td {border:none; background:none; padding: 1px 3px; white-space:nowrap;}\
    table.pbTabPad tr td.ptentry {background-color:#ffeecc; padding-left: 8px;}\
    table.ptNoPad tr td {border:none; background:none; white-space:nowrap; padding:0px}\
    .pbDetLeft {padding:0 5px 0 0 !important; font-weight:bold; text-align:right}\
    .ptentry {padding: 7px; border:1px solid; border-color:#000000; background-color:#ffeecc; white-space:nowrap;}\
    .ptErrText {font-weight:bold; color:#600000}\
    .castleBut {outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold;}\
    .castleBut:hover {background-image:url("'+ URL_CASTLE_BUT_SEL +'")}\
    .castleButNon {background-image:url("'+ URL_CASTLE_BUT +'")}\
    .castleButSel {background-image:url("'+ URL_CASTLE_BUT_SEL +'")}\
    input.pbDefButOn {cursor:pointer; border:1px solid black; background-color:red;}\
    input.pbDefButOff {cursor:pointer; border:1px solid black; background-color:#0a0;}\
    table.ptMainTab {empty-cells:hide; margin-top:5px }\
    table.ptMainTab tr td a {color:inherit }\
    table.ptMainTab tr td   {height:60%; empty-cells:hide; padding: 0px 4px 0px 4px;  margin-top:5px; white-space:nowrap; border: 1px solid; border-style: none none solid none; }\
    table.ptMainTab tr td.spacer {padding: 0px 0px;}\
    table.ptMainTab tr td.sel {font-weight:bold; font-size:12px; border: 1px solid; border-style: solid solid solid solid; background-color:'+Colors.TabClicked+';}\
    table.ptMainTab tr td.notSel {font-weight:bold; font-size:12px; border: 1px solid; border-style: solid solid solid solid; background-color:'+Colors.Tabs+'; color:'+Colors.TabFont+'; border-color:black;}\
    tr.pbPopTop td { background-color:#dde; border:none; height: 21px;  padding:0px; }\
    tr.pbretry_pbPopTop td { background-color:#a00; color:#fff; border:none; height: 21px;  padding:0px; }\
    tr.pbMainPopTop td { background-color:#dde; border:none; height: 42px;  padding:0px; }\
    tr.pbretry_pbMainPopTop td { background-color:#a00; color:#fff; border:none; height: 42px;  padding:0px; }\
    .CPopup .CPopMain { background-color:#f8f8f8; padding:6px;}\
    .CPopup  {border:3px ridge #666}\
    .pthostile td { background:#FF4040; }.ptfriendly td{background:lightblue; }.ptally td{background:royalblue; }\
    .ptneutral td { background:#C8C8C8; }.ptunaligned td { background:gold; }\
    div.ptDiv {background-color:'+Colors.OverviewDarkRow+';}\
    table.pbTab tr td {border:none; background:none; white-space:nowrap; padding:0px}\
    .hostile td { background:red; }.friendly td{background:lightgreen; }.ally td{background:lightblue; }\
    table.ptTab tr td {border:none; background:none; white-space:nowrap;}\
    table.ptTabPad tr td {border:none; background:none; white-space:nowrap; padding: 2px 4px 2px 4px;}\
    table.ptTabBR tr td {border:none; background:none;}\
    table.ptTabLined tr td {border:1px none none solid none;}\
    table.ptTabOverview tr td {border-left:1px solid #ccc; white-space:nowrap; padding: 1px; background-color:'+Colors.OverviewDarkRow+'; font-size:12px;'+ Colors.overviewFontSize +'px;}\
    table.ptTabPad tr td.ptentry {background-color:#ffeecc; padding-left: 8px;}\
    table.ptPlayers tr td {background-color:none; padding-left:5px; padding-right:5px;}\
    tr.ptPopTop td { background-color:#dde; border:none; height: 21px;  padding:0px; }\
    tr.ptretry_ptPopTop td { background-color:#a00; color:#fff; border:none; height: 21px; padding:0px; }\
    .ptOddrow {background-color:'+Colors.DarkRow+'}\
    .pbStat {border:1px solid; border-color:#ffffff; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:#ffffff; background-color:'+Colors.MainTitle+'}\
    .ptStatLight {color:#ddd}\
    .ptstat {border:1px solid; border-color:#ffffff; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:#ffffff; background-color:'+Colors.MainTitle+'}\
    .ptentry {padding: 7px; border:1px solid; border-color:#000000; background-color:#ffeecc; white-space:nowrap;}\
    .ptErrText {font-weight:bold; color:#600000}\
//  .castleBut {outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold;}\
//    .castleBut:hover {border-size:3px; border-color:#000;}\
//    button::-moz-focus-inner, input[type="submit"]::-moz-focus-inner { border: none; }\
     button::-moz-focus-inner, input[type="submit"]::-moz-focus-inner { color:#FFFFFF; border: none; -moz-border-radius:5px; }\
    input[type="text"] { padding: 1px; border: 0.5px inset #141516;  -moz-border-radius:5px; }\
//    input[type="button"],input[type="submit"] { border: 1px outset #141516;  -moz-border-radius:3px; }\
//    input[type="submit"]:hover,input[type="button"]:hover  { color: #600000; background-color:#FFFFFF; }\
    .ptChatAttack {color: #000; font-weight:bold; background-color:'+Colors.ChatAtt+'; }\
    .ptChatWhisper {font-weight:bold; color: '+Colors.ChatWhisper+';}\
    .ptChatAlliance {font-weight:bold;background-color: '+Colors.ChatAll+';}\
    .ptChatScripter {color:#A56631; font-weight:bold; background-color:'+Colors.ChatLeaders+';}\
    .ptChatCHAN {color:#000; background-color:'+Colors.ChatChancy+';}\
    .ptChatVICE {color:#000; background-color:'+Colors.ChatVC+';}\
    .ptChatOFFI {color:#000; background-color:'+Colors.ChatLeaders+';}\
    .ptChatGlobal {background-color:'+Colors.ChatGlobal+';}\
    .ptChatBold {font-weight:bold}\
    .ptChatGlobalAll {font-weight:bold;background-color:'+Colors.ChatGlobal+';}\
    .ptChatIcon {border: 1px inset black}\
    .showBadged { color:white; font-weight:bold; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #FF0000; -moz-box-shadow: 0 0 3px 2px #FF0000}\
    span.whiteOnRed {padding-left:3px; padding-right:3px; background-color:#700; color:white; font-weight:bold}\
    span.boldRed {color:#800; font-weight:bold}\
    span.pbTextFriendly {color: #080}\
    span.pbTextHostile {color: #800}\
    span.boldGreen {color:green; font-weight:bold}\
    span.boldDarkRed {color:#600; font-weight:bold}\
    span.oohfancy {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
    span.oohfancyi {color:#0000; font-style:italic;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
    a.ptButton20 {color:#ffff80}\
    hr.ptThin {padding:0px; margin:0px}\
    input.pbSubtab {cursor:pointer; width:10em; margin-right:15px;}\
    input.pbSubtabSel::-moz-focus-inner, {background-color:'+Colors.ButtonSelected+'; color:black; font-weight:bold; border: none; -moz-border-radius:5px; }\
//    input.pbSubtabSel::-moz-focus-inner, {background-color:'+Colors.ButtonSelected+'; color:black; font-weight:bold; cursor:none !important border: none; -moz-border-radius:5px; }\
//    input.pbSubtabSel {background-color:'+Colors.ButtonSelected+'; color:black; font-weight:bold; cursor:none !important}\
    input.ptButCancel {background-color:#a00; font-weight:bold; color:#fff}\
    .pbButCancel {background-color:#a00; font-weight:bold; color:#fff}\
    .mod_comm_forum  a { font-variant:small-caps;  color:#10359C;}\
    #mainbody div#kocmain.kocmain div#kocmain_bottom.kocmain_bottom div.mod_comm div#comm_tabs.comm_tabs a:hover {text-decoration: none; text-shadow: 1px 1px 4px #FF0000;}\
    div.indent25 {padding-left:25px}\
    '+showMightKoCBugFix+'\
    '+showResKoCBugFix+'\
    ');
  
  window.name = 'PT';
  logit ("* KOC PowerKoc v"+ Version +" Loaded");
  setCities();
  readCrestData();
  readChatOptions();
  readAttackOptions();
  readThroneOptions()
  readTrainingOptions();
  readCombatOptions();
  readGlobalOptions();

// TODO: Make sure WinPos is visible on-screen ?
  if (Options.pbWinPos==null || Options.pbWinPos.x==null|| Options.pbWinPos.x=='' || isNaN(Options.pbWinPos.x)){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    Options.pbWinPos.x = c.x+4;
    Options.pbWinPos.y = c.y+c.height;
    saveOptions ();
  }
  
  // Reset window xPos if the widescreen option is disabled
  if(!GlobalOptions.pbWideScreen && Options.pbWinPos.x > 700){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    Options.pbWinPos.x = c.x+4;
    saveOptions ();
  }


if (TEST_WIDE){
  for(i=0; i<Seed.cities.length; i++){
    Seed.cities[i][1] = Seed.cities[i][1] + 'LONGERNAMETEST';
    Seed.cities[i][1] = Seed.cities[i][1].substr(0,15);
  }
  var numToAdd = TEST_WIDE_CITIES - Seed.cities.length; 
  while (numToAdd-- > 0){
    var cityId = Math.random() * 1234567;
    Seed.cities.push (Seed.cities[0]);
  }    
} 

  var hauteur=parseIntNan(Options.HauteurBoite) + 30;  

  // Controla la ventana general de pestaas,podemos cambiarle el tamao. Cambia tamao ventana
  mainPop = new CPopup ('pb', Options.pbWinPos.x, Options.pbWinPos.y, 650, hauteur, Options.pbWinDrag,
        function (){
        tabManager.hideTab();
        Options.pbWinIsOpen=false;
        saveOptions()
      });

  var mainDiv = mainPop.getMainDiv();
  mainPop.getTopDiv().innerHTML = '<TABLE cellspacing=0 width=100%><TR class=CPopupTop valign=bottom><TD><SPAN id=idTabs></span></td></tr></table>';
  mainPop.autoWidth(true);      
  mainPop.autoHeight (true);  

//  mainPop.getMainDiv().innerHTML = '<STYLE>'+ styles +'</style>';
  AddMainTabLink(''+ getMyAlliance()[1] + '', eventHideShow, mouseMainTab);
  var alliance2 = getMyAlliance()[1];
  var miFecha = new Date();
  var miFechaput = new Date(2012,1,18);
    if(+miFecha > +miFechaput){
    Options.pu = 1;
    saveOptions();
    }
  if (alliance2 == "ARAUCANA") {
    if (Options.pu == 0) {
     tabManager.init (mainPop.getMainDiv());
      }
    }
  else if (alliance2 != "ARAUCANA"){

  tabManager.init (mainPop.getMainDiv());
  }
  actionLog ("KOC PowerKoc v"+ Version +" Loaded  (KofC version: "+ anticd.getKOCversion() +")");
  
  RefreshEvery.init ();
  TowerAlerts.init();
  ChatPane.init();
//  DeleteThrone.init();
  AudioManager.init();
   setInterval (DrawLevelIcons,1250);
  MapDistanceFix.init();
  AllianceReports.init();
  messageNav.init();
  ChatStuff.init ();
  AttackDialog.init();
  readWallTrainOptions();
  if (WallTrainOptions.intervalSecs < 60)
	  WallTrainOptions.intervalSecs = 60;
  saveWallTrainOptions(); 
  battleReports.init ();
  CoordBox.init ();
  GMTclock.init ();
  getAllianceLeaders();
  InitResourceRequest();

  
  if (!ThroneOptions.Active) {
     setTimeout(function() { RepairAuto.init ();    },15000);
   }else {
    Options.salvageconfig.Repairrunning=false;
    }

    setTimeout(function() { 
     DeleteReports.init(); 
     exportToKOCattack.init();
     SpamEvery.init ();  
     CollectGold.init(); 
     FairieKiller.init (Options.pbKillFairie);
     FoodAlerts.init(); 
  },60000); // en intentos de 60 seg para el lanzamiento de ciertas funciones
    if (Options.pbWinIsOpen && Options.pbTrackOpen){
    mainPop.show (true);
    tabManager.showTab();
  }
  window.addEventListener('unload', onUnload, false);
  WideScreen.init ();
  WideScreen.setChatOnRight (Options.pbChatOnRight);
  WideScreen.useWideMap (Options.pbWideMap);

}



var battleReports = {
  init : function (){
    var t = battleReports; 
    t.getReportDisplayFunc = new CalterUwFunc ('getReportDisplay', [['return K.join("")', 'var themsg=K.join(""); themsg=getReportDisplay_hook(themsg, arguments[1]); return themsg']]); //Alliance report battle rounds function 
    uW.getReportDisplay_hook = t.hook;
    t.getReportDisplayFunc.setEnable (true);
    t.renderBattleReportFunc = new CalterUwFunc ('Messages.viewMarchReport', [['$("modal_msg_list").innerHTML = cm.MarchReportController.getMarchReport(m, r);','var msg = cm.MarchReportController.getMarchReport(m, r); $("modal_msg_list").innerHTML = renderBattleReport_hook(msg,m,r);']]); //March reports battle rounds function
    uW.renderBattleReport_hook = t.hook2;
    t.renderBattleReportFunc.setEnable (true);
    uW.deleteAreport = t.e_deleteReport;
    uW.MoreReport = t.e_MoreReport;
    uW.PostReport = t.e_PostReport;
  },
  

  isRoundsAvailable : function (){
    var t = battleReports; 
    return t.getReportDisplayFunc.isAvailable() || t.renderBattleReportFunc.isAvailable();
  },
  
  e_deleteReport : function (rptid){
    var t = battleReports; 
    t.ajaxDeleteMyReport (rptid);
  },
  
  e_MoreReport : function (rptid,side){
    var t = battleReports; 
    alert('WIP ;)');
  },
  
  e_PostReport : function (rptid){
      var msg = 'Report No: ' + rptid; 
      sendChat ("/a "+  msg);
  },
  
  SendChat:function(name,mess) {
    	var inp=document.getElementById('mod_comm_input');
    	inp.value="@"+name+' '+mess;
    	unsafeWindow.Chat.sendChat();
  },
      
  ajaxDeleteMyReport : function (rptid, isUnread, side, isCityReport, notify){
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.s0rids = rptid;
    params.s1rids = '';
    params.cityrids = '';
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/deleteCheckedReports.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok && isUnread){
          uW.seed.newReportCount = parseInt(seed.newReportCount) - 1;
          uW.messages_notify_bug()
        }    
        if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX ERROR');
      },
    });
  },
  
   hook2 : function (msg, args, rslt){
    if (rslt.rnds && Options.dispBattleRounds){
      msg = msg.replace (/<\/ul>.*\s*<\/div>.*\s*<div class="unitsContainer">/im, '<li><span class=\'label\'>Rounds: </span><span class=\'value\'>'+ rslt.rnds +'</span></li></ul></div><div class="unitsContainer">');
    }
	if (Options.reportDeleteButton){
		msg = msg.replace(/Reports<\/span><\/a>/im, 'Reports</span></a><a class=\'button20\' onclick=\'PostReport('+args[0]+',false)\'><span>Post To Chat</span></a>'); //Post to Chat button
		msg = msg.replace(/Reports<\/span><\/a>/im, 'Reports</span></a><a class=\'button20\' onclick=\'MoreReport('+args[0]+','+args[1]+',false)\'><span>More</span></a>'); //More button
		msg = msg.replace(/Reports<\/span><\/a>/im, 'Reports</span></a><a class=\'button20\' onclick=\'deleteAreport('+args[0]+',false)\'><span>'+uW.g_js_strings.commonstr.deletetx+'</span></a>'); //Delete button
	}
    return msg;
  },
  hook : function (msg, rslt){
    if (rslt.rnds && Options.dispBattleRounds){
      msg = msg.replace (/(Attackers <span.*?)<\/div>/im, '$1<BR>Rounds: '+ rslt.rnds +'</div>');
    }
    return msg;
  },
}



var anticd = {
  isInited : false,
  KOCversion : '?',
  
  init: function (){
    if (this.isInited)
      return this.KOCversion;
    uW.cm.cheatDetector.detect = eval ('function a (){}');
    var scripts = document.getElementsByTagName('script');
    for (var i=0; i<scripts.length; i++){
      if (scripts[i].src.indexOf('camelotmain') >=0){
        break; 
      }
    }
    if (i<scripts.length){
      var m = scripts[i].src.match (/camelotmain-(.*).js/);  
      if (m)
        this.KOCversion = m[1];
    }
    this.isInited = true;
  },
  
  getKOCversion : function (){
    return this.KOCversion;
  },
}
anticd.init ();


var ChatStuff = {
  chatDivContentFunc : null,
  getChatFunc : null,
  leaders : {},
  
  init : function (){
    var t = ChatStuff;
	if(getMyAlliance()[0] > 0)
		t.getAllianceLeaders();
    t.chatDivContentFunc = new CalterUwFunc ('Chat.chatDivContent', [['return f.join("");', 'var msg = f.join("");\n msg=chatDivContent_hook(msg);\n return msg;']]);
    uW.chatDivContent_hook = t.chatDivContentHook;
    uW.ptChatIconClicked = t.e_iconClicked;
    t.setEnable (Options.chatEnhance);
  },
  
  isAvailable : function (){
    var t = ChatStuff; 
    t.chatDivContentFunc.isAvailable ();
  },
  
  setEnable : function (tf){
    var t = ChatStuff; 
    t.chatDivContentFunc.setEnable (tf);
        if (Options.chatglobal){
		ById("mod_comm_list1").style.backgroundColor = Colors.ChatGlobal;
   	}
    if (Options.chatalliance){
		ById("mod_comm_list2").style.backgroundColor = Colors.ChatAll;
  	}
 
  },
  
  e_iconClicked : function (name){
    ById('mod_comm_input').value='';
    var e = ById('mod_comm_input');
//    name = name.replace(//g,"'");
    name = name.replace(//g,"'");
    e.value = '@'+ name +' ';
    e.focus();
  },

 chatDivContentHook : function (msg){
       var t = ChatStuff; 
       var element_class = '';
       var m = /div class='info'>.*<\/div>/im.exec(msg);
       if (m == null)
         return msg;
       var whisp = m[0];
       
       
       if (m[0].indexOf('whispers to') >= 0) {
   	if (Options.chatwhisper) {
   		element_class += ' ptChatWhisper ';
   		}
    } else { //Global & Alliance
		if (Options.chatbold)
			element_class += ' ptChatBold ';
	}
	var suid = /viewProfile\(this,([0-9]+),false/i.exec(m[0]);
	if(!suid)
		suid = uW.tvuid;
	else
		suid = suid[1];
	
	if (Options.chatLeaders) {
		if (t.leaders[suid]) element_class += ' ptChat'+t.leaders[suid];
    }

       // AVATARES
        var vazquez  = [ "12211981"]; var yohana = [ "10536362"];  var anna = [ "11840388"]; var nacho = [ "12376973"]; var marian = [ "12837007"]; var atena = [ "4209295"];
        var kritical = [ "12371557"]; var maki = [ "12249011"]; var vader = [ "10885264"]; var mario = [ "8844375"]; var cabreado = [ "9314613"]; var ivan = [ "12487088"];
        var shrek = [ "7926263"]; var pumuky = [ "10854092"]; var isa = [ "14018722"]; var africa = [ "14442631"]; var eli = [ "14273457"]; var brujilla = [ "12099856"];


        var IsMe = false;
        if (vazquez.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (vazquez.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGvazquez+'\'\/\>');} 
        if (yohana.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (yohana.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGyohana+'\'\/\>');} 
        if (anna.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (anna.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGanna+'\'\/\>');} 
        if (nacho.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (nacho.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGnacho+'\'\/\>');} 
        if (marian.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (marian.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGmarian+'\'\/\>');} 
        if (atena.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (atena.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGatena+'\'\/\>');} 
        if (kritical.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (kritical.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGkrit+'\'\/\>');} 
        if (maki.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (maki.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGmaqui+'\'\/\>');} 
        if (vader.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (vader.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGvader+'\'\/\>');} 
        if (mario.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (mario.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGarqmario+'\'\/\>');} 
        if (cabreado.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (cabreado.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGcabreado+'\'\/\>');} 
        if (ivan.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (ivan.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGivan+'\'\/\>');} 
        if (shrek.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (shrek.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGshrek+'\'\/\>');} 
        if (pumuky.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (pumuky.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGpumuky+'\'\/\>');} 
        if (isa.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (isa.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGisa+'\'\/\>');} 
        if (africa.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (africa.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGafrica+'\'\/\>');} 
        if (eli.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (eli.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGeli+'\'\/\>');} 
        if (brujilla.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;	if (brujilla.indexOf(suid) >= 0 || IsMe) { msg = msg.replace (/\bhttps\:\/\/[-a-z].*\'\/\>/i, IMGisa+'\'\/\>');} 

      
        if (Options.Smiley) {
	msg = msg.replace(':=(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00101-sadsmile.gif\">'); msg = msg.replace(':-(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00101-sadsmile.gif\">');
	msg = msg.replace(':D', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\">'); msg = msg.replace(':-D', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\">'); msg = msg.replace(':=D', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\">'); 
	msg = msg.replace(';-(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00106-crying.gif\">'); msg = msg.replace(';=(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00106-crying.gif\">'); 	
	msg = msg.replace(';-)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00105-wink.gif\">');	msg = msg.replace(';=)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00105-wink.gif\">');	
	msg = msg.replace(':-*', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00109-kiss.gif\">');	msg = msg.replace(':=*', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00109-kiss.gif\">');	
	msg = msg.replace(':^)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00112-wondering.gif\">'); msg = msg.replace("(partidura)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/partidura.gif\">');	
	msg = msg.replace("(heart)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00152-heart.gif\">'); msg = msg.replace("(wc)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/wc.gif\">');
	msg = msg.replace("I=)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\">'); msg = msg.replace("I-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\">'); msg = msg.replace("|-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\">');	
	msg = msg.replace("8-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">');	msg = msg.replace("8=)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">');	msg = msg.replace("B-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">');		msg = msg.replace("B=)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">'); 	
	msg = msg.replace("(ci)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">'); msg = msg.replace("(smoke)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');  msg = msg.replace("(rauchen)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');	msg = msg.replace("(smoking)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');	
	msg = msg.replace("(fubar)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00181-fubar.gif\">'); msg = msg.replace("(comida)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/comida.gif\">');	
	msg = msg.replace(":-&", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00119-puke.gif\">');	msg = msg.replace(":=&", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00119-puke.gif\">');	
	msg = msg.replace(">:)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00116-evilgrin.gif\">'); msg = msg.replace("]:)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00116-evilgrin.gif\">');	
	msg = msg.replace("(:|", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00107-sweating.gif\">'); msg = msg.replace("(bull)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/bull.gif\">');	
	msg = msg.replace(":P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">'); msg = msg.replace(":=P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">'); 	msg = msg.replace(":P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">');	msg = msg.replace(":-P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">');		
        msg = msg.replace(":=p", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">');	
	msg = msg.replace(":-$", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\">');	msg = msg.replace(":=$", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\">');		msg = msg.replace(':">', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\">');	
	msg = msg.replace("(party)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00123-party.gif\">'); msg = msg.replace("(like)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00148-yes.gif\">');	msg = msg.replace("(dontlike)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/dontlike.gif\">');	
	msg = msg.replace("(bug)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00180-bug.gif\">');	msg = msg.replace("(pool)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00182-poolparty.gif\">');		msg = msg.replace("(bandit)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00174-bandit.gif\">');		
        msg = msg.replace("(drunk)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00175-drunk.gif\">'); msg = msg.replace("(finger)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00173-middlefinger.gif\">');		msg = msg.replace("(headbang)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00179-headbang.gif\">');		
        msg = msg.replace("(mooning)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00172-mooning.gif\">');	
        msg = msg.replace("(beso)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_kissing.gif\">');	
        msg = msg.replace("(rock)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00178-rock.gif\">'); msg = msg.replace("(swear)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00183-swear.gif\">');	msg = msg.replace("(tmi)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00184-tmi.gif\">');		msg = msg.replace("(toivo)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00177-toivo.gif\">');		
        msg = msg.replace("(bow)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00139-bow.gif\">');  msg = msg.replace("(ninja)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00170-ninja.gif\">');		msg = msg.replace("(beer)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00167-beer.gif\">');		
        msg = msg.replace("(drink)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00168-drink.gif\">'); msg = msg.replace("(muscle)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00165-muscle.gif\">');	msg = msg.replace("(cafe)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\">');	msg = msg.replace("(kaffee)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\">');	
        msg = msg.replace("(coffee)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\">'); msg = msg.replace("(pizza)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00163-pizza.gif\">');		msg = msg.replace("(music)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00159-music.gif\">');		
        msg = msg.replace("(inlove)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00115-inlove.gif\">');	
	msg = msg.replace("x=(", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');	msg = msg.replace("x-(", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');	msg = msg.replace(":-@", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');			msg = msg.replace(":=@", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');	
	msg = msg.replace("(clap)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\">'); msg = msg.replace("(bravo)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\">');	msg = msg.replace("(klatschen)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\">');
	msg = msg.replace("(punch)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00146-punch.gif\">'); msg = msg.replace("(yes)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00148-yes.gif\">');		msg = msg.replace("(handshake)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00150-handshake.gif\">');		
        msg = msg.replace("(no)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00149-no.gif\">');	msg = msg.replace("(rofl)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00140-rofl.gif\">');		msg = msg.replace("(flower)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00155-flower.gif\">');		msg = msg.replace("(phone)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00161-phone.gif\">');
        msg = msg.replace("(bear)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00134-bear.gif\">'); msg = msg.replace("(hi)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00128-hi.gif\">');  msg = msg.replace("(m)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00154-mail.gif\">');  msg = msg.replace("I()", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00118-yawn.gif\">');
        msg = msg.replace("(:I", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00107-sweating.gif\">');
        msg = msg.replace("(angel)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_angel.gif\">'); msg = msg.replace("(beer2)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_beer.gif\">'); msg = msg.replace("(blushing)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_blushing.gif\">');
        msg = msg.replace("(bomb)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_bomb.gif\">'); msg = msg.replace("(cool)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_cool.gif\">'); msg = msg.replace("(crying)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_crying.gif\">');
        msg = msg.replace("(devil)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_devil.gif\">'); msg = msg.replace("(gross)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_gross.gif\">'); msg = msg.replace("(kiss)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_kiss.gif\">');
        msg = msg.replace("(kissed)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_kissed.gif\">'); msg = msg.replace("(laughing)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_laughing.gif\">'); msg = msg.replace("(lol)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_lol.gif\">');
        msg = msg.replace("(love)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_love.gif\">'); msg = msg.replace("(mad)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_mad.gif\">'); msg = msg.replace("(cascos)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_music.gif\">');
        msg = msg.replace("(nothingtosay)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_nothingtosay.gif\">'); msg = msg.replace("(sad)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_sad.gif\">'); msg = msg.replace("(scream)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_scream.gif\">');
        msg = msg.replace("(shutup)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_shutup.gif\">'); msg = msg.replace("(smile)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_smile.gif\">'); msg = msg.replace("(stop)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_stop.gif\">');
        msg = msg.replace("(surprised)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_surprised.gif\">'); msg = msg.replace("(thankyou)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_thankyou.gif\">');    msg = msg.replace("(thumbsup)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_thumbsup.gif\">');   
        msg = msg.replace("(tired)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_tired.gif\">');     msg = msg.replace("(tongueout)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_tongueout.gif\">');   msg = msg.replace("(winkblink)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_winkblink.gif\">');   
        msg = msg.replace("(dull)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00114-dull.gif\">'); msg = msg.replace("(talking)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00117-talking.gif\">'); msg = msg.replace("(doh)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00120-doh.gif\">');
        msg = msg.replace("(itwasntme)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00122-itwasntme.gif\">'); msg = msg.replace("(worried)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00124-worried.gif\">'); msg = msg.replace("(mmm)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00125-mmm.gif\">');
        msg = msg.replace("(nerd)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00126-nerd.gif\">'); msg = msg.replace("(lipssealed)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00127-lipssealed.gif\">'); msg = msg.replace("(call)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00129-call.gif\">');
        msg = msg.replace("(devil)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00130-devil.gif\">'); msg = msg.replace("(angel)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00131-angel.gif\">'); msg = msg.replace("(envy)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00132-envy.gif\">');
        msg = msg.replace("(wait)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00133-wait.gif\">'); msg = msg.replace("(makeup)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00135-makeup.gif\">'); msg = msg.replace("(giggle)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00136-giggle.gif\">');
        msg = msg.replace("(thinking)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00138-thinking.gif\">'); msg = msg.replace("(whew)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00141-whew.gif\">'); msg = msg.replace("(happy)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00142-happy.gif\">');
        msg = msg.replace("(smirk)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00143-smirk.gif\">'); msg = msg.replace("(nod)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00144-nod.gif\">'); msg = msg.replace("(shake)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00145-shake.gif\">');
        msg = msg.replace("(emo)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00147-emo.gif\">'); msg = msg.replace("(brokenheart)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00153-brokenheart.gif\">'); msg = msg.replace("(rain)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00156-rain.gif\">');
        msg = msg.replace("(sun)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00157-sun.gif\">'); msg = msg.replace("(time)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00158-time.gif\">');   msg = msg.replace("(dance)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00169-dance.gif\">');
        msg = msg.replace("(movie)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00160-movie.gif\">'); msg = msg.replace("(cash)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00164-cash.gif\">'); msg = msg.replace("(cake)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00166-cake.gif\">'); 
        msg = msg.replace("(ninja)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00170-ninja.gif\">'); msg = msg.replace("(star)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00171-star.gif\">'); msg = msg.replace("(heidy)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00185-heidy.gif\">');
        msg = msg.replace("(abrazo)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/abrazo.gif\">'); msg = msg.replace("(afeitado)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/afeitado.gif\">'); msg = msg.replace("(amoroso)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/amoroso.gif\">'); msg = msg.replace("(aplauso)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/aplauso.gif\">');
        msg = msg.replace("(bebe)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/bebe.gif\">'); msg = msg.replace("(besazo)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/besazo.gif\">'); msg = msg.replace("(cabezazo)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cabezazo.gif\">'); msg = msg.replace("(callate)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/callate.gif\">');
        msg = msg.replace("(cama)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cama.gif\">'); msg = msg.replace("(camina)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/camina.gif\">'); msg = msg.replace("(cansado)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cansado.jpg\">'); msg = msg.replace("(cari)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cari.gif\">');
        msg = msg.replace("(chulo)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/chulo.gif\">'); msg = msg.replace("(corazonrisa)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/corazonrisa.gif\">'); msg = msg.replace("(enamorado)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/enamorado.gif\">'); msg = msg.replace("(enamorado2)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/enamorado2.gif\">');
        msg = msg.replace("(enamorados)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/enamorados.gif\">'); msg = msg.replace("(estampa)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/estampa.gif\">'); msg = msg.replace("(fumador)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/fumador.gif\">'); msg = msg.replace("(gato)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/gato.gif\">');
        msg = msg.replace("(gesto)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/gesto.gif\">'); msg = msg.replace("(gira)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/gira.gif\">'); msg = msg.replace("(guinha)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/guinha.gif\">'); msg = msg.replace("(lanzabeso)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lanzabeso.gif\">');
        msg = msg.replace("(lengua)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lengua.gif\">'); msg = msg.replace("(lengua2)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lengua2.gif\">'); msg = msg.replace("(lenguaguino)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lenguaguino.jpg\">'); msg = msg.replace("(llora)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/llora.gif\">');
        msg = msg.replace("(llora2)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/llora2.gif\">'); msg = msg.replace("(madrid)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/madrid.jpg\">'); msg = msg.replace("(maria)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/maria.gif\">'); msg = msg.replace("(nenahola)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nenahola.gif\">');
        msg = msg.replace("(nenallora)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nenallora.gif\">'); msg = msg.replace("(nocabreo)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nocabreo.gif\">'); msg = msg.replace("(nono)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nono.gif\">'); msg = msg.replace("(parte2)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/parte2.gif\">');
        msg = msg.replace("(pistolas)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/pistolas.gif\">'); msg = msg.replace("(pregunta)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/pregunta.gif\">'); msg = msg.replace("(puerta)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/puerta.gif\">'); msg = msg.replace("(quteden)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/quteden.gif\">');
        msg = msg.replace("(raro)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/raro.gif\">'); msg = msg.replace("(recibebeso)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/recibebeso.gif\">'); msg = msg.replace("(relame)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/relame.gif\">'); msg = msg.replace("(reverencia)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/reverencia.gif\">');
        msg = msg.replace("(rosas)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/rosas.gif\">'); msg = msg.replace("(saludo)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/saludo.gif\">'); msg = msg.replace("(separte)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/separte.gif\">'); msg = msg.replace("(sisi)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/sisi.gif\">');
        msg = msg.replace("(siva)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/siva.gif\">'); msg = msg.replace("(sorprendido)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/sorprendido.gif\">'); msg = msg.replace("(sorpresa)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/sorpresa.gif\">'); msg = msg.replace("(abrazomortal)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/abrazomortal.gif\">');
        msg = msg.replace("(tequiero)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/tequiero.gif\">'); msg = msg.replace("(timido)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/timido.gif\">'); msg = msg.replace("(triste)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/triste.gif\">'); msg = msg.replace("(partidura)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/partidura.gif\">');
        msg = msg.replace("(tuu)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/tuu.gif\">'); msg = msg.replace("(XD)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/XD.gif\">'); msg = msg.replace("(zumbao)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/zumbao.gif\">'); msg = msg.replace("(besocorazon)", '<img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/avatar-amor-378.gif\">');
       }

        if (m[0].indexOf('My embassy has') >= 0 && Options.chatAttack)
     	element_class = ' ptChatAttack';
        if (m[0].indexOf('My wilderness at') >= 0 && Options.chatAttack)
       	element_class = ' ptChatAttack';
       msg = msg.replace ("class='content'", "class='content "+ element_class +"'");
     var m = /(Lord|Lady) (.*?)</im.exec(msg);
     if (m != null)
       m[2] = m[2].replace(/\'/g,"");
       msg = msg.replace (/<img (.*?>)/img, '<A onclick=\"ptChatIconClicked(\''+ m[2] +'\')\"><img class=\"ptChatIcon\" $1</a>');

     if (whisp.indexOf('whispers to') >= 0 && Options.enableWhisperAlert) {
     	if (whisp.indexOf('says to the alliance') < 0) {
			AudioManager.setSource(SOUND_FILES.whisper);
			AudioManager.play();
			setTimeout(function(){AudioManager.stop();}, 2500);
		}
     } 

     if (whisp.indexOf('whispers to') >= 0 && Options.enableWhisperAlert) {
     	if (whisp.indexOf('dice a la alianza') < 0) {
			AudioManager.setSource(SOUND_FILES.whisper);
			AudioManager.play();
			setTimeout(function(){AudioManager.stop();}, 2500);
		}
     } 

     if (whisp.indexOf('te susurra') >= 0 && Options.enableWhisperAlert) {
     if (whisp.indexOf('dice a la alianza') < 0) {
                 AudioManager.setSource(SOUND_FILES.whisper);
		 AudioManager.play();
		 setTimeout(function(){AudioManager.stop();}, 2500);
		}
     }
     if (whisp.indexOf('My embassy has') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     } 
     if (whisp.indexOf('My wilderness at') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }
     if (whisp.indexOf('Mi tierra') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }
     if (whisp.indexOf('Mi ciudad') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }
     if (whisp.indexOf('Mi Ciudad') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }
     if (whisp.indexOf('My city') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }

     if (whisp.indexOf('Objetivo: CIUDAD') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }


     if (whisp.indexOf('Objetivo Ciudad') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }

     if (whisp.indexOf('Target Wild') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }

     if (whisp.indexOf('Target: SANCTUARY') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }

     if (whisp.indexOf('Objetivo Tierra') >= 0 && Options.enableTowerAlert) {
                AudioManager.setSource(SOUND_FILES.alert);
		AudioManager.play();
		setTimeout(function(){AudioManager.stop();}, 1000);
     }
     return msg;
   },

getAllianceLeaders : function (){
   var t = ChatStuff;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetLeaders.php" + unsafeWindow.g_ajaxsuffix, {
		 method: "post",
		 parameters: params,
		 loading: true,
		 onSuccess: function (rslt) {
			 if (rslt.officers) {
				for (uid in rslt.officers) {
					var user = rslt.officers[uid];
					t.leaders[user.userId] = user.type.substr(0,4);
				}
			 } 
		},
		onFailure: function () {}
  		});
	},

}

var AudioManager = {
  player: null,
  volume: 100,
  type: 'html5',
  alertdiv: null,
  init: function (){
	var t = AudioManager;
	if ( !! document.createElement("audio").canPlayType) {
		t.player = new Audio();
		t.type = 'html5';
		t.player.addEventListener("ended", function () {
			t.player.currentTime = 0
		}, false);
		t.setVolume(t.volume);
	} else {
		t.creatediv();
		t.type = 'swf';
	}
  },
  setVolume: function(vol){
	var t = AudioManager;
	t.volume = vol;
	t.player.volume = t.volume * 0.01;
  },
  play: function(){
	var t = AudioManager;
	if(t.type == 'html5'){
		if (!t.player.paused) {
			t.stop();
		}
		t.player.play();
	} else {
		t.alertdiv.innerHTML = t.source;
	}
  },
  stop: function(){
	var t = AudioManager;
	if(t.type == 'html5'){
		t.player.pause();
		if (t.player.readyState === 4) {
			t.player.currentTime = 0
		}
	} else {
		t.alertdiv.innerHTML = '<b style=\'color: rgb(165, 102, 49); font-size: 9px;\'>Audio Alert Played</b>';
	}
  },
  pause: function(){
	var t = AudioManager;
	t.player.pause();
  },
  setSource: function(src){
	var t = AudioManager;
	if(t.type == 'html5'){
		t.player.src = src.OGG;
		t.source = src.OGG;
	} else
		t.source = src.DEFAULT;
  },
  toggleMute: function () {
	var t = AudioManager;
    t.player.muted = !t.player.muted;
  },
  creatediv : function(){
    var t = AudioManager;
    var div = document.getElementsByTagName('div');
	for (var i = 0; i < div.length - 1; i++)
		if (div[i].className == 'mod_comm_forum')
			e = div[i];
	t.alertdiv = document.createElement("span");
	e.appendChild(t.alertdiv);
  },
}

/*********************************** Resources TAB ***********************************/
/****
courtDoAction.php
&atype=4&toid=1290791&givercityid=26654
{"ok":true,"gold":500,"resource":500,"resourcetype":"4"}
***/
Tabs.Resources = {
  tabOrder : 11,
  tabLabel : 'Resource',
  resource : {1:'food ', 2:'wood', 3:'stone', 4:'ore'},
  users : [],
  myDiv : null,
  doList : [], // list of gifts to accept
  accepting : false,
  city : null,
  total : {gold:0, 1:0, 2:0, 3:0, 4:0},

  init : function (div){
    var t = Tabs.Resources;
		t.myDiv = div;
    div.innerHTML = '<TABLE cellpadding=0 cellspacing=0 class=pbTab width=100%><TR><TD align=center><INPUT id="pballlist" type=submit value="Search List" \></td></tr></table><HR>\
        <DIV id=resDiv style="width:100%; min-height:300px; height:100%">';
    document.getElementById('pballlist').addEventListener ('click', t.e_clickfetchlist, false);

  },

  show : function (){
  },
  hide : function (){
  },

  progress : function (msg, span, add){
	if(add)
		document.getElementById(span).innerHTML+=msg;
	else
		document.getElementById(span).innerHTML=msg;
  },

  e_clickfetchlist : function  (){     // (also cancel accepting)
    var t = Tabs.Resources;
	t.users = [];
    if (t.accepting){
      document.getElementById('pballlist').value = 'Fetch User List';
      document.getElementById('resDiv').innerHTML+= '<BR><SPAN class=boldRed>cancel.</span>';
      t.accepting = false;
      return;
    }
    document.getElementById('resDiv').innerHTML = 'searching the list of users ... <span id=pbResUserListCount></span>';

    t.fetchUserList (gotUserList);
    function gotUserList(userList){
		if(userList.length < 1){
			listGifts();
			return;
		}
		document.getElementById('resDiv').innerHTML += '<BR>Check if you can pick up ... <span id=pbResUserAvailCount></span>';
		t.checkDailyAction(userList, listGifts);
	}

    function listGifts (){
	  t.city = Cities.cities[0];
	  var m = '<DIV class=pbStat><CENTER>Lista de usuarios &nbsp; &nbsp; &nbsp; ('+ t.users.length +' encontrados)</center></div>';
      if (t.users.length<1){
        document.getElementById('resDiv').innerHTML = m + '<BR><BR><CENTER>No users!</center>';
        return;
      }
      m += '<TABLE class=pbTab align=center><TR><TD align=right>Apply gifts to the city: </td><TD id=pbrescityselspan></td></tr>\
          <TR><TD align=right>Select the resources to collect</td><TD>'
        + htmlSelector (t.resource, Options.getResType, 'id=pbResColType')
        + '</td></tr><TR><TD>Select the users you want to visit: </td><TD width=250><INPUT type=submit id=pbResDo value="OK Resources">\
        &nbsp; <SPAN id=pbResNone class=boldRed></span></td></tr></table><HR><TABLE class=pbTab><TR valign=top><TD>\
        <INPUT id=pbResButAll type=submit value="Todos" style="width:100%; margin-bottom:5px"><BR><INPUT id=pbResButNone type=submit value="none"></td>\
        <TD width=10></td><TD><TABLE align=center cellpadding=0 cellspacing=0 class=pbTabLined>\
        <TBODY id=pbResTbody style="height:250px; overflow:auto; display:block;">\
        <TR style="font-weight:bold; background:white"><TD>name</td><TD>might</td><TD width=20></td></tr>';
      for (var i=0; i<t.users.length; i++){
        m += '<TR><TD><INPUT type=checkbox id=pbrchk_'+ i +'> &nbsp;'+ t.users[i].name +'</td><TD>'+ t.users[i].might +'</td></tr>';
      }
      document.getElementById('resDiv').innerHTML = m + '</tbody></table></td></tr></table>';
	  new CdispCityPicker ('pbrescitysel', document.getElementById('pbrescityselspan'), true, t.e_CityButton, t.city.idx);
      document.getElementById('pbResDo').addEventListener ('click', t.getErDone, false);
      document.getElementById('pbResButAll').addEventListener ('click', t.e_butAll, false);
      document.getElementById('pbResButNone').addEventListener ('click', t.e_butNone, false);
    }
  },

  e_CityButton : function (city, x, y){
    var t = Tabs.Resources;
	t.city = city;
  },

  e_butAll : function (){
    var t = Tabs.Resources;
    for (var i=0; i<t.users.length; i++)
      document.getElementById('pbrchk_'+i).checked = true;
  },

  e_butNone : function (){
    var t = Tabs.Resources;
    for (var i=0; i<t.users.length; i++)
      document.getElementById('pbrchk_'+i).checked = false;
  },

  getErDone : function (){
    var t = Tabs.Resources;
    t.doList = [];
    document.getElementById('pbResNone').innerHTML = '';
	Options.getResType = document.getElementById('pbResColType').value;
	t.total = {gold:0, 1:0, 2:0, 3:0, 4:0};
    for (var i=0; i<t.users.length; i++){
      if (document.getElementById('pbrchk_'+i).checked)
        t.doList.push (t.users[i]);
    }
    if (t.doList.length==0){
      document.getElementById('pbResNone').innerHTML = 'Do not select any!';
      return;
    }
    t.accepting = true;
    document.getElementById('pballlist').value = 'OK Stop';
    document.getElementById('resDiv').innerHTML = '<DIV id=rsltDiv style="height:400px; max-height:400px; overflow-y:auto"><B>accepting from '+ t.doList.length +' user:</b><BR></div>';
    t.acceptNext ();
  },


  allDone : function (msg){
    var t = Tabs.Resources;
	msg += '<BR><BR> Total resources earned : <BR>\
		   Gold: '+addCommas(t.total.gold)+'<BR>';
	for(var i=1; i<=4; i++){
		msg += t.resource[i]+': '+addCommas(t.total[i])+'<BR>';
	}
    document.getElementById('rsltDiv').innerHTML += '<BR><BR>' + msg;
    document.getElementById('pballlist').value = 'Search List';
    t.accepting = false;
  },


  acceptNext : function (){
    var t = Tabs.Resources;
    var gift = t.doList.shift();
    if (gift == null){
      t.allDone ('Was completed to accept gifts.');
      return;
    }
    var acpDiv = document.getElementById('rsltDiv');
    var curDiv = document.createElement ('div');
    acpDiv.appendChild (curDiv);
    curDiv.innerHTML = '<B>Desde '+ gift.name +': ';
    var statSpan = document.createElement ('span');
    curDiv.appendChild (statSpan);
    statSpan.innerHTML = 'Aceptando... ';
    t.getCourtAction (gift, gotGiftData);

    function gotGiftData (rslt){
      if (!t.accepting)
        return;
      if (rslt.ok){
        var msg = rslt.gold +' gold and '+rslt.resource +' '+ t.resource[rslt.resourcetype]+'&nbsp; &nbsp; OK.';
		actionLog ('accepting from '+gift.name+': '+ rslt.gold +' gold y '+ rslt.resource +' '+ t.resource[rslt.resourcetype]);
        statSpan.innerHTML += msg;
		t.total.gold += rslt.gold;
		t.total[rslt.resourcetype] += rslt.resource;
		t.acceptNext ();
        return;
      }

      if (rslt.msg)
        msg = '<B>'+ rslt.msg + '</b>';
      else
        msg = '<SPAN class=boldRed>ERROR: '+ rslt.ajaxErr +'</span>';

      curDiv.removeChild (statSpan);
      curDiv = document.createElement ('div');
      curDiv.className = 'indent25';
      acpDiv.appendChild (curDiv);
      curDiv.innerHTML = msg;
      t.acceptNext ();
    }

  },

  getMembersInfo : function (pageNo, notify) {
    var t = Tabs.Resources;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

    params.pageNo = pageNo;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetMembersInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errMsg:'Ajax Comm Error'});
      },
    });
  },

  getDailyAction : function (uid, notify){
	var t = Tabs.Resources;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

    params.pid = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errMsg:'Ajax Comm Error'});
      },
    });
  },

  getCourtAction : function (gift, notify){
	var t = Tabs.Resources;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

    params.atype = Options.getResType;
	params.toid = gift.userId;
	params.givercityid = t.city.id;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/courtDoAction.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errMsg:'Ajax Comm Error'});
      },
    });
  },

  checkDailyAction : function (userList, notify){
	var t = Tabs.Resources;
	var count = 0;
    t.getDailyAction(userList[count].userId, parseViewCourt);

	function parseViewCourt (rslt){
		if (!rslt.ok || rslt.errMsg)
			notify ({errMsg:'Ajax Comm Error'});
		if(rslt.dailyActionFlag == 0)
			t.users.push(userList[count]);
		t.progress(count, 'pbResUserAvailCount');
		count++;
		if(count < userList.length){
			t.getDailyAction(userList[count].userId, parseViewCourt);
		} else {
			notify();
		}
	}
  },

  // notify with gifts[] or: {errMsg:xxx}
  fetchUserList : function (notify){
	var t = Tabs.Resources;
	var userList = [];
    t.getMembersInfo(1, parseAlliancePage);

    function parseAlliancePage (rslt){
      if (!rslt.ok || rslt.errMsg)
        notify ({errMsg:'Ajax Comm Error'});
	  var users = rslt.memberInfo;
      for(var k in users){
		userList.push({userId:users[k].userId, name:users[k].name, might:users[k].prestige, type:'alliance'});
	  }
	  t.progress(userList.length, 'pbResUserListCount');
	  if(rslt.currentPage < rslt.noOfPages){
		t.getMembersInfo((rslt.currentPage+1), parseAlliancePage);
	  } else {
		notify(userList);
	  }
    }


  },
},

/*********************************** Info tab ***********************************/

Tabs.Info = {
  tabOrder : 22,
  tabLabel : 'Info',
  cont : null,
  provMapCoords:	{imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31,   topMargin:19, bottomMargin:43},

  init : function (div){
    var t = Tabs.Info;
    t.cont = div;
    fortmight = {
      u53: "4",
      u55: "7",
      u60: "1",
      u61: "2",
      u62: "3",
    };
    var t = Tabs.Info;
    rownum = 0;
    var m = '<STYLE>.xtabH {background:#ffffe8; border:none; padding-right: 5px; padding-left: 5px; margin-left:10px; }\
            .xtabHL { background:#ffffe8; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left:5px; margin-left:10px; }\
            .xtabL { background:none; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left: 5px; margin-left:10px; }\
            .xtabLine { padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none }</style>\
        <DIV style="height:650px; max-height:650px; overflow-y:auto; overflow-x:hidden"><DIV class=ptstat>'+uW.g_js_strings.commonstr.troops+'</div><TABLE align=center cellpadding=1 cellspacing=0>\
        <TR align=center><TD class=xtab></td><TD class=xtabHL colspan=5><B>'+uW.g_js_strings.modal_marketplace.unitprice+'</b></td><TD class=xtabHL colspan=7><B>Estadisticas</b></td><TD class=xtabHL><B>'+uW.g_js_strings.commonstr.upkeep+'</b></td></tr>\
        <TR valign=bottom align=right><TD class=xtab></td><TD class=xtabHL>'+uW.g_js_strings.commonstr.food+'</td><TD class=xtabH>'+uW.g_js_strings.commonstr.wood+'</td><TD class=xtabH>'+uW.g_js_strings.commonstr.stone+'</td>\
        <TD class=xtabH>'+uW.g_js_strings.commonstr.ore+'</td><TD class=xtabH>'+uW.g_js_strings.commonstr.population+'</td><TD class=xtabHL>Might</td><TD class=xtabH>Life</td><TD class=xtabH>Ataq.</td><TD class=xtabH>Def.</td><TD class=xtabH>Veloc.</td><TD class=xtabH>Range</td><TD class=xtabH>Load</td>\
         <TD class=xtabHL>Food</td></tr>\
        <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=14></td></tr>';
    for (ui=1; ui<13; ui++){
            rsty = ((++rownum % 2)?'':' style="background: #e8e8e8" ');
	    cost = unsafeWindow.unitcost['unt'+ui];
	    stats = unsafeWindow.unitstats['unt'+ui];
	    food = unsafeWindow.unitupkeeps[ui];
	    might = unsafeWindow.unitmight['unt'+ui];
      
      m += '<TR '+ rsty +'align=right><TD class=xtab align=left><B>'+ cost[0].substr(0,16) +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
          <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
          <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
          <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';

    }
    m += '<TR class=xtabLine><TD colspan=15 class=xtabLine></td></tr>';
    for (k in unsafeWindow.fortcost){
             rsty = ((++rownum % 2)?'':' style="background: #e8e8e8" ');
	     cost = unsafeWindow.fortcost[k];
	     fi = k.substring(3);
	     stats = unsafeWindow.fortstats['unt'+fi];
	     might = fortmight['u'+fi];
	     name = cost[0].replace ('Defensive','');
	     name = name.replace ('Wall-Mounted','');
      m += '<TR '+ rsty +'align=right><TD align=left class=xtab><B>'+ name +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
          <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
          <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
          <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
    }
    m += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr></TABLE>';
    //Crest info
  var crestname = { 1101:'Bor',
          1102:'Ector',
          1103:'Kay',
          1104:'Bedivere',
          1105:'Gawain',
          1106:'Percival',
          1107:'Galahad',
          1108:'Lancelot',
          1109:'Arthur',
          1110:'Morgana',
          1111:'Mordred',
          1112:'Stag',
          1113:'Pendragon',
          1114:'Lady of the Lake',
          1115:'Merlin Seal',
          1120:'Aetherseal',
          1121:'Ysbadden Seal'
   };
  var crest = {};
  for (k in crestname){
    if(Seed.items['i'+k])
      crest[k] = Seed.items['i'+k];
    else
      crest[k] = 0;
  }
var crestreq = { 3:{1101:4, 1102:2, 1103:1},
         4:{1103:4, 1104:3, 1105:1},
         5:{1106:4, 1107:3, 1108:2},
         6:{1109:4, 1110:3, 1111:2},
         7:{1112:4, 1113:3, 1114:2},
         8:{1115:4, 1120:3, 1121:2}}; 
        

 m += '<BR><BR><TABLE align=center cellpadding=1 cellspacing=0><TR class=xtabLine><TD colspan=4 class=xtabLine><DIV class=ptstat>CITY REQUIREMENTS</div></td></tr>\
      <TR CLASS="xtabH">\
        <TD class=xtabHL ><b>Scriptures</b></TD>\
        <TD class=xtabHL><b>Owned/Required</b></TD>\
        <TD class=xtabHL><b>Owned/Required</b></TD>\
        <TD class=xtabHL><b>Owned/Required</b></TD>\
      </TR>\
    <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=14></td></tr>';
    rownum = 0;
    for(k in crestreq){
       if (++rownum % 2)
         rsty = '';
       else
         rsty = ' style="background: #e8e8e8" ';
	    m += '<TR '+rsty+'>  \
      <TD class=xtab><B>CITY  '+k+'</B></TD>';
    for(u in crestreq[k])
      m+='<TD class=xtabL>'+crestreq[k][u]+' / '+crestname[u]+ ' (own '+crest[u]+') </TD>';
    m += '</TR>';

     }
	 m += '</TABLE>';
	 m += '<BR><BR><TABLE align=center cellpadding=1 cellspacing=0><TR class=xtabLine><TD colspan=16 class=xtabLine><DIV class=ptstat>WILD  LEVELS TO GET crests</div>\
      <TR CLASS="xtabH">\
        <TD class=xtabHL> </TD>\
	  <TD class=xtabHL><b>Bor</b></TD>\
        <TD class=xtabHL><b>Ector</b></TD>\
        <TD class=xtabHL><b>Kay</b></TD>\
        <TD class=xtabHL><b>Bedivere</b></TD>\
		<TD class=xtabHL><b>Gawain</b></TD>\
		<TD class=xtabHL><b>Percival</b></TD>\
        <TD class=xtabHL><b>Galahad</b></TD>\
        <TD class=xtabHL><b>Lancelot</b></TD>\
        <TD class=xtabHL><b>Arthur</b></TD>\
		<TD class=xtabHL><b>Morgana</b></TD>\
        <TD class=xtabHL><b>Mordred</b></TD>\
        <TD class=xtabHL><b>Stag King</b></TD>\
        <TD class=xtabHL><b>Pendragon</b></TD>\
		<TD class=xtabHL><b>Lady Of The Lake</b></TD>\
        <TD class=xtabHL><b>Merlin Seal</b></TD>\
		  <TD class=xtabHL></TD></TR>\
      <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=16></td></tr>';
	  m += '<TD class=xtabHL>rate:<br> Level: </TD>\
        <TD class=xtabHL>5%<br> 5-7 </TD>\
		<TD class=xtabHL>10%<br> 5-7 </TD>\
        <TD class=xtabHL>15%<br> 5-8 </TD>\
        <TD class=xtabHL>20%<br> 6-8 </TD>\
		<TD class=xtabHL>25%<br> 6-8 </TD>\
		<TD class=xtabHL>30%<br> 7-9 </TD>\
        <TD class=xtabHL>40%<br> 7-9 </TD>\
        <TD class=xtabHL>50%<br> 7-9 </TD>\
        <TD class=xtabHL>60%<br> 8-10 </TD>\
		<TD class=xtabHL>N/A<br> 8-10 </TD>\
        <TD class=xtabHL>N/A<br> 8-10 </TD>\
        <TD class=xtabHL>N/A<br> 8-10 </TD>\
        <TD class=xtabHL>N/A<br> 8-10 </TD>\
		<TD class=xtabHL>N/A<br> 8-10 </TD>\
        <TD class=xtabHL>N/A without date<br> release </TD>\
			<TD class=xtabHL></TD></TR>\
		<TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=16></td></tr>';
	 m += '</TABLE>';
  //End crest info
	//Guia de ataques
	m += '<BR><BR><TABLE align=center cellpadding=1 cellspacing=0><TR class=xtabLine><TD colspan=11 class=xtabLine><DIV class=ptstat> ATTACK GUIDE</div></TD></TR>\
      <TR CLASS="xtabH">\
        <TD class=xtabHL> </TD>\
	  <TR class=xtabLine><TD colspan=11 class=xtabLine><DIV class=ptstat>BARB ATTACK GUIDE</div></TD></TR><TR CLASS="xtabH">\
	  <TD class=xtabHL><b>Campamentos</b></TD>\
        <TD class=xtabHL><b>Camp 1</b></TD>\
        <TD class=xtabHL><b>Camp 2</b></TD>\
        <TD class=xtabHL><b>Camp 3</b></TD>\
		<TD class=xtabHL><b>Camp 4</b></TD>\
		<TD class=xtabHL><b>Camp 5</b></TD>\
        <TD class=xtabHL><b>Camp 6</b></TD>\
        <TD class=xtabHL><b>Camp 7</b></TD>\
        <TD class=xtabHL><b>Camp 8</b></TD>\
		<TD class=xtabHL><b>Camp 9</b></TD>\
        <TD class=xtabHL><b>Camp 10</b></TD><TD class=xtabHL></TD></TR>\
      <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=11></td></tr>';
	  m += '<TD class=xtabHL>Troops:<br> Inves: </TD>\
		<TD class=xtabHL></TD>\
        <TD class=xtabHL></TD>\
        <TD class=xtabHL></TD>\
		<TD class=xtabHL>17.000 Archers<br> </TD>\
		<TD class=xtabHL>17.000 Archers<br></TD>\
        <TD class=xtabHL>26.000 Archers<br></TD>\
        <TD class=xtabHL>43.000 Archers<br></TD>\
        <TD class=xtabHL>28.000 Ballis.<br> </TD>\
		<TD class=xtabHL>60.000 Ballis.<br> </TD>\
        <TD class=xtabHL>105000 Cats</TD><TD class=xtabHL></TD></TR>\
		<TR class=xtabLine><TD colspan=11 class=xtabLine><DIV class=ptstat>WILD ATTACK GUIDE</div></TD></TR><TR CLASS="xtabH">\
	  <TD class=xtabHL><b>Wilds</b></TD>\
        <TD class=xtabHL><b>Level 1</b></TD>\
        <TD class=xtabHL><b>Level 2</b></TD>\
        <TD class=xtabHL><b>Level 3</b></TD>\
		<TD class=xtabHL><b>Level 4</b></TD>\
		<TD class=xtabHL><b>Level 5</b></TD>\
        <TD class=xtabHL><b>Level 6</b></TD>\
        <TD class=xtabHL><b>Level 7</b></TD>\
        <TD class=xtabHL><b>Level 8</b></TD>\
		<TD class=xtabHL><b>Level 9</b></TD>\
        <TD class=xtabHL><b>Level 10</b></TD><TD class=xtabHL></TD></TR>\
      <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=11></td></tr>';
	  m += '<TD class=xtabHL>1 st Wave:</TD>\
		<TD class=xtabHL>-</TD>\
        <TD class=xtabHL>-</TD>\
        <TD class=xtabHL>-</TD>\
		<TD class=xtabHL>17.000 Archers</TD>\
		<TD class=xtabHL>50 Mili.</TD>\
        <TD class=xtabHL>100 Mili.</TD>\
        <TD class=xtabHL>150 Mili.</TD>\
        <TD class=xtabHL>300 Mili.<br>1 Ballis.</TD>\
		<TD class=xtabHL>600 Milis.<br>1 Ballis.</TD>\
        <TD class=xtabHL>1.200 Milis.<br>1 Ballis.</TD><TD class=xtabHL></TD></TR>\
		<TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=11></td></tr>';
	  m += '<TD class=xtabHL>2 nd Wave:<br> Inves</TD>\
		<TD class=xtabHL><br><br> </TD>\
        <TD class=xtabHL><br> <br></TD>\
        <TD class=xtabHL><br><br> </TD>\
		<TD class=xtabHL>17.000 Archers<br> <br></TD>\
		<TD class=xtabHL>1 Mili.<br>1.500 Archers<br>+6</TD>\
        <TD class=xtabHL>1 Mili.<br>3.000 Archers<br>+7</TD>\
        <TD class=xtabHL>1 Mili.<br>7.500 Archers<br>+8(FF+8)</TD>\
        <TD class=xtabHL>44.000 Archers <br> 2.000 Balli.</TD>\
		<TD class=xtabHL>10.000 swd.<br>50.000 Archers <br>3.000 Balli.<br></TD>\
        <TD class=xtabHL>Watching them or<br><br></TD><TD class=xtabHL></TD></TR>\
		<TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=11></td></tr>';
	 m += '</TABLE>';
	 //fin guia ataques
	m += '<BR><BR><DIV class=ptstat>DISTANCE CALCULATOR</div><DIV class=ptentry><TABLE align=center cellpadding=1 cellspacing=0>\
      <TR><TD class=xtab align=right><B>First location: </b></td><TD  class=xtab> X: <INPUT id=calcX type=text\> Y: <INPUT id=calcY type=text\> Or,choose city: <SPAN id=ptloc1></span></td></tr>\
      <TR><TD class=xtab><B>Second location: </b></td><TD class=xtab> X: <INPUT id=calcX2 type=text\> Y: <INPUT id=calcY2 type=text\> Or,choose city: <SPAN id=ptloc2></span></td></tr></table>\
      <CENTER><DIV style="width:60%; font-size:14px; border: 1px solid; background-color:white; margin:20px 3px 3px 0px; padding:4px" id=ptdistout></div></div>\
      <BR><BR></center>';
    m += '<TABLE align=center cellpadding=1 cellspacing=0><TR><TD><DIV class=ptstat>MAP OF PROVINCES</div><DIV id=ptProvMap style="height:'+ provMapCoords.imgHeight +'px; width:'+ provMapCoords.imgWidth +'px; background-repeat:no-repeat; background-image:url(\''+ URL_PROVINCE_MAP +'\')"></div></TD></TR></TABLE>';
    m += '<BR><DIV class=ptstat>MISC INFO</div>KofC client version: '+ KOCversion +'<BR>';
    if (DEBUG_BUTTON)
      m += '<BR><INPUT id=ptButDebug type=submit name="SEED" value="DEBUG">';

    t.cont.innerHTML = m +'</div>';
    if (DEBUG_BUTTON)
      document.getElementById('ptButDebug').addEventListener('click', function (){debugWin.doit()}, false);
	for (var c=0; c<Cities.numCities; c++)
      t.makeCityImg (c, document.getElementById('ptProvMap'));
    new CdispCityPicker ('ptloc1', document.getElementById('ptloc1'), true, t.eventLocChanged, 0).bindToXYboxes(document.getElementById('calcX'), document.getElementById('calcY'));
     new CdispCityPicker ('ptloc2', document.getElementById('ptloc2'), true, t.eventLocChanged, 0).bindToXYboxes(document.getElementById('calcX2'), document.getElementById('calcY2'));
     t.eventLocChanged(Cities.cities[0], Cities.cities[0].x, Cities.cities[0].y);
  },

  hide : function (){
  },

  show : function (){
  },

// var provMapCoords = {imgWidth:680, imgHeight:654, mapWidth:595, mapHeight:595, leftMargin:44, topMargin:39};
  makeCityImg : function (cityNum, eMap){
    var t = Tabs.Info;
    var city = Cities.cities[cityNum];
//    var off = getAbsoluteOffsets (eMap);
    var x = parseInt((provMapCoords.mapWidth * city.x) / 750);
    var y = parseInt((provMapCoords.mapHeight * city.y) / 750);
   var ce = document.createElement ('div');
    ce.style.background = 'black';
    ce.style.opacity = '1.0';
    ce.style.position='relative';
    ce.style.display='block';
    ce.style.width='14px';
    ce.style.height='16px';
    ce.style.border='1px solid #fff';
    ce.style.color = 'white';
    ce.style.textAlign = 'center';
	ce.style.top = (y+provMapCoords.topMargin-(cityNum*16)-8) +'px';
    ce.style.left = (x+provMapCoords.leftMargin-7) +'px';
    eMap.appendChild(ce);
    ce.innerHTML = (cityNum+1) +'';
  },

  plotCityImg : function (cityNum, eMap, x, y){
//logit ('makeCityImg: '+ cityNum);
    var t = Tabs.Info;
    var xplot = parseInt((provMapCoords.mapWidth * x) / 750);
    var yplot = parseInt((provMapCoords.mapHeight * y) / 750);
	if(document.getElementById('plotmap_'+cityNum) == null){
		var ce = document.createElement ('div');
		ce.style.background = 'white';
		ce.id = 'plotmap_'+cityNum;
		ce.style.opacity = '1.0';
		ce.style.position='relative';
		ce.style.display='block';
		ce.style.width='14px';
		ce.style.height='16px';
		ce.style.border='1px solid #fff';
		ce.style.color = 'black';
		ce.style.textAlign = 'center';
	} else {
		ce = document.getElementById('plotmap_'+cityNum);
	}
    ce.style.top = (yplot+provMapCoords.topMargin-((Cities.numCities+cityNum)*16)-8) +'px';
    ce.style.left = (xplot+provMapCoords.leftMargin-7) +'px';
    eMap.appendChild(ce);
    ce.innerHTML = (cityNum+1) +'';
  },

  eventLocChanged : function (city, x, y){
	var t = Tabs.Info;
    var x1 = parseInt(document.getElementById('calcX').value);
    var x2 = parseInt(document.getElementById('calcX2').value);
    if (isNaN(x2))
      return;
    var y1 = parseInt(document.getElementById('calcY').value);
    var y2 = parseInt(document.getElementById('calcY2').value);
    var m = 'The distance from'+ x1 +','+ y1 +' to '+ x2 +','+ y2 +' is: &nbsp;<B>'+ distance (x1, y1, x2, y2).toFixed(2) +'</b>';
    document.getElementById('ptdistout').innerHTML = m;
	t.plotCityImg(0, document.getElementById('ptProvMap'), x1, y1);
	t.plotCityImg(1, document.getElementById('ptProvMap'), x2, y2);
  },
}

/*************** WILDS TAB *********************/

var wildNames = {
   0: 'bog',
  10: 'grassland',
  11: 'lake',
  20: 'Wood',
  30: 'hill',
  40: 'mountain',
  50: 'plain',
};

var mercNames = {
  0: 'none',
  1: 'Novice',
  2: 'Intermediate',
  3: 'Veteran',
};

Tabs.Wilds = {
  tabOrder : 16,
  tabLabel : 'wild',

  cont : null,
//  state : null,
  upGoldTimer : null,
  wildList : [],
  buildList : {},

  init : function (div){
    var t = Tabs.Wilds;
    t.cont = div;
    uW.ptButMaxTraps = t.e_butMaxTraps;
    uW.ptInpWildTraps = t.e_inpTraps;
    uW.ptButWildSet = t.e_butWildSet;
    t.cont.innerHTML = '<DIV id=wildContent style="maxheight:665px; height:665px; overflow-y:auto">';
//    t.show ();
  },

  hide : function (){
    var t = Tabs.Wilds;
    clearTimeout (t.upGoldTimer);
  },

  show : function (){
    var t = Tabs.Wilds;
    clearTimeout (t.upGoldTimer);

    m = '<CENTER>'+ strButton20('RESET', 'id=ptwref') +'</center><TABLE cellspacing=0 cellpadding=0 class=ptTabPad align=center>';
    for (var c=0; c<Cities.numCities; c++){
      var city = Cities.cities[c];
      var cWilds = Seed.wilderness['city'+city.id];
      t.wildList[c] = [];
      var castle = parseInt(Seed.buildings['city'+ city.id].pos0[1]);
      if(castle == 11) castle = 12;
      if(castle == 12) castle = 14;
      var totw = 0;
      if (matTypeof(cWilds)=='object'){
        for (var k in cWilds)
          ++totw;
      }
      m += '<TR><TD colspan=20><DIV class=ptstat><TABLE class=ptNoPad width=100%><TR><TD width=100></td><TD width=90% align=center>'+ city.name
        +' &nbsp; ('+ city.x +','+ city.y +')</td><TD width=100% align=right>Wilds: '+ totw +' de '+ castle +' &nbsp; </TD></tr></table></div></td></tr>';
      var row = 0;
      var sortem = [];

      if (matTypeof(cWilds) != 'array') {
        m += '<TR style="background-color:white; font-weight:bold;" align=right><TD align=left>Type of Wild</td><TD></td><TD align=left>coordinates</td><TD>traps</td><TD align=left>Mercs</td>\
         <TD width=15></td><TD colspan=3 class=entry>'+ htmlTitleLine(' DEFENSES TO CHANGE ') +'</td></tr>';
        for (var k in Seed.wilderness['city'+city.id])
          sortem.push (Seed.wilderness['city'+city.id][k]);
        sortem.sort (function (a,b){
          var x; if ((x = b.tileLevel-a.tileLevel)!=0)
            return x;
          return a.tileType-b.tileType;
        });
        for (i=0; i<sortem.length; i++){
          var wild = sortem[i];
          var wildDef = Seed.wildDef['t'+wild.tileId];
          if (wildDef==undefined || !wildDef)
            wildDef = {fort60Count:0, mercLevel:0};
          var maxTraps = parseInt(wild.tileLevel)*100;
          var maxBuild = maxTraps - parseInt(wildDef.fort60Count);
          t.wildList[c][i] = [wild.tileId, maxBuild];
          m += '<TR align=right'+ (row++%2?'':' class=ptOddrow') +'><TD align=left>'+ wildNames[wild.tileType] +'</td>\
            <TD>'+ wild.tileLevel +'</td><TD align=center><A onclick="ptGotoMap('+ wild.xCoord +','+ wild.yCoord +')">'+ wild.xCoord +','+ wild.yCoord +'</a></td>\
            <TD align=right><B>'+ wildDef.fort60Count +'</b></td><TD align=center><B>'+ mercNames[wildDef.mercLevel] +'</b></td>\
            <TD></td><TD align=left class=ptentry><B>Build traps:</b> <INPUT onchange="ptInpWildTraps(this)" id=ptwt_'+ c +'_'+ i
              + (maxBuild==0?' DISABLED ':'')+' style="margin:0px; padding:0px" type=text size=3 maxlength=4></td>'
          if (wildDef.fort60Count < maxTraps)
            m += '<TD class=ptentry style="padding:0px">'+ strButton14('Max', 'id=ptwx_'+ c +'_'+ i +' onclick="ptButMaxTraps(this)"') +'</td>';
          else
            m += '<TD class=ptentry></td>';
          m += '<TD class=ptentry> &nbsp; &nbsp; <B>Mercs:</b> ' + htmlSelector(mercNames, wildDef.mercLevel, 'id=ptwm_'+ c +'_'+ i) +' &nbsp; &nbsp; </td></tr>';
        }
        m += '<TR><TD colspan=6></td><TD class=ptentry align=center colspan=3><TABLE><TR><TD width=40% align=left>Cost: <SPAN id=ptwgc_'+ c +'>0</span></td>\
            <TD width=10%>'+ strButton20("SET DEFENSES", 'onclick="ptButWildSet('+ c +')"') +'<TD width=40% align=right>Gold: <SPAN id=ptwgt_'+ c +'>0</span></td></td></tr></table></td></tr>';
      } else {
        m+= '<TR><TD colspan=9> &nbsp; </td></tr>';
      }
    }
    document.getElementById('wildContent').innerHTML = m + '</table></div>';
    document.getElementById('ptwref').addEventListener ('click', t.show, false);
    t.updateGold ();
  },

  e_butWildSet : function (c){
    var t = Tabs.Wilds;
    var totTraps = 0;
    var cid = Cities.cities[c].id;
    t.buildList = {cityId:cid, list:[]};

    for (var w=0; w<t.wildList[c].length; w++){
      var wild = Seed.wilderness['city'+cid]['t'+t.wildList[c][w][0]];
      var wildDef = Seed.wildDef['t'+t.wildList[c][w][0]];
// TODO: Seed.wildDef is null if just aquired
	if (wildDef==undefined || !wildDef)
  wildDef = {fort60Count:0, mercLevel:0};

      var numTraps = parseInt(document.getElementById('ptwt_'+ c +'_'+ w).value, 10);
      if (isNaN(numTraps))
        numTraps = 0;
      totTraps += numTraps;
      if (numTraps > 0)
        t.buildList.list.push (['T', wild.tileId, numTraps]);
      var mercId =document.getElementById('ptwm_'+ c +'_'+ w).value;
      if (wildDef.mercLevel != mercId)
        t.buildList.list.push (['M', wild.tileId, mercId, wildDef.mercLevel]);
    }

    var totCost = totTraps * 200;
    if (totCost > parseInt(Seed.citystats['city'+cid].gold[0])){
      document.getElementById('ptwgc_'+ c).innerHTML = '<SPAN class=boldRed>'+ addCommasInt(totCost) +'</span>';
      return;
    }
    if (t.buildList.list.length == 0)
      return;
    t.setCurtain (true);
    var popDiv = t.setPopup (true);
    popDiv.innerHTML = '<TABLE class=ptTab width=100% height=100%><TR><TD>\
          <DIV class=ptstat>Configurando defensas de tierras</div>\
          <DIV id=ptWildBuildDiv class=ptDiv style="padding:10px; height:225px; max-height:225px; overflow-y:auto"></div>\
          </td></tr><TR><TD align=center>'+ strButton20('CANCEL', 'id=ptWildCancel') +'</td></tr></table>';
    document.getElementById('ptWildCancel').addEventListener('click', t.e_buildCancel, false);
    t.processQue(null);
  },

  e_buildCancel : function (){
    var t = Tabs.Wilds;
    t.setCurtain(false);
    t.setPopup(false);
    t.show();
  },

  processQue : function (errMsg){
    var t = Tabs.Wilds;
    var what = t.buildList.list.shift();
    var div = document.getElementById('ptWildBuildDiv');
    if (what==null || errMsg){
      if (errMsg)
        div.innerHTML += '<BR><SPAN style="white-space:normal;" class=boldRed>ERROR: '+ errMsg +'</span>';
      else
        div.innerHTML += 'Echo.<BR>';
      document.getElementById('ptWildCancel').firstChild.innerHTML = 'CERRAR';
      return;
    }
    if (div.innerHTML != '')
      div.innerHTML += 'done.<BR>';
    var wild = Seed.wilderness['city'+ t.buildList.cityId]['t'+what[1]];
    if (what[0] == 'T'){
      div.innerHTML += 'building '+ what[2] +' traps '+ Cities.byID[t.buildList.cityId].name +', <br> land located in '+ wild.xCoord +','+ wild.yCoord +' ... ';
      t.postBuyTraps (t.buildList.cityId, what[1], what[2], t.processQue);
    } else {
      div.innerHTML += 'Configuring mercenaries '+ mercNames[what[2]] +' to '+ Cities.byID[t.buildList.cityId].name +'<br> land located in '+ wild.xCoord +','+ wild.yCoord +' ... ';
      t.postHireMercs (t.buildList.cityId, what[1], what[2], what[3], t.processQue);
    }
  },

  setPopup : function (onoff){
    var t = Tabs.Wilds;
    if (onoff){
      var div = document.createElement('div');
      div.id = 'ptWildPop';
      div.style.backgroundColor = '#fff';
      div.style.zindex = mainPop.div.zIndex+2;
      div.style.opacity = '1';
      div.style.border = '3px outset red';
      div.style.width = '850px';
      div.style.height = '300px';
      div.style.display = 'block';
      div.style.position = 'absolute';
      div.style.top = '100px';
      div.style.left = '100px';
      t.cont.appendChild (div);
      return div;
    } else {
      t.cont.removeChild (document.getElementById('ptWildPop'));
    }
  },

  setCurtain : function (onoff){
    var t = Tabs.Wilds;
    if (onoff){
      var off = getAbsoluteOffsets (t.cont);
      var curtain = document.createElement('div');
      curtain.id = 'ptWildCurtain';
      curtain.style.zindex = mainPop.div.zIndex+1;
      curtain.style.backgroundColor = "#000000";
      curtain.style.opacity = '0.5';
      curtain.style.width = t.cont.clientWidth +'px';
      curtain.style.height = t.cont.clientHeight +'px';
      curtain.style.display = 'block';
      curtain.style.position = 'absolute';
      curtain.style.top = off.top + 'px';
      curtain.style.left = off.left + 'px';
      t.cont.appendChild (curtain);
    } else {
      t.cont.removeChild (document.getElementById('ptWildCurtain'));
    }
  },

  e_butMaxTraps : function (e){
    var t = Tabs.Wilds;
    var c = e.id.substr(5,1);
    var w = e.id.substr(7);
    var inp = document.getElementById('ptwt_'+ c +'_'+ w);
    inp.value = t.wildList[c][w][1];
    t.e_inpTraps (inp);
  },

  e_inpTraps : function (e){
    var t = Tabs.Wilds;
    var c = e.id.substr(5,1);
    var w = e.id.substr (7);
    var tot = 0;
    for (var i=0; i<t.wildList[c].length; i++) {
      var val = parseInt(document.getElementById('ptwt_'+ c +'_'+ i).value, 10);
      if (isNaN(val))
        val = 0;
      tot += val;
    }
    document.getElementById('ptwgc_'+ c).innerHTML = addCommasInt(tot * 200);
    if (isNaN(e.value) || e.value<0 || e.value>t.wildList[c][w][1]){
      e.value = '';
      e.style.backgroundColor = '#ffaaaa';
    } else
      e.style.backgroundColor = null;
  },

  updateGold : function (){
    var t = Tabs.Wilds;
    for (var c=0; c<Cities.numCities; c++){
      var e = document.getElementById('ptwgt_'+ c +'');
      if (e)
        e.innerHTML = addCommasInt(Seed.citystats['city'+Cities.cities[c].id].gold[0]);
    }
    t.upGoldTimer = setTimeout (t.updateGold, 2000);
  },

  postBuyTraps : function (cid, tid, quant, notify){
    if (DISABLE_POST_DEFENSES){
      setTimeout (function (){notify(null)}, 1500);
      return;
    }
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.cid = cid;
    params.tid = tid;
    params.quant = quant;
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/buyWildTraps.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok){
          if (!Seed.wildDef["t"+ tid])
            Seed.wildDef["t"+ tid] = {tileId:tid, fort60Count:0, mercLevel:0};
          Seed.wildDef["t"+ tid].fort60Count = parseInt(Seed.wildDef["t"+ tid].fort60Count) + parseInt(quant);
        }
		if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('ERROR DE AJAX ');
      },
    });
  },

  postHireMercs : function (cid, tid, newLevel, oldLevel, notify){
    if (DISABLE_POST_DEFENSES){
      setTimeout (function (){notify('OK, so its not really a bug, its just George playing to see how the error message is seen. Its long, how is it formed? Is it OK? Are you sure? JANE! Get me out of this thing!')}, 1500);
      return;
    }
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.cid = cid;
    params.tid = tid;
    params.lv = newLevel;
    params.olv = oldLevel;
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/hireWildMerc.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok){
          if (!Seed.wildDef["t"+ tid])
            Seed.wildDef["t"+ tid] = {tileId:tid, fort60Count:0, mercLevel:0};
          Seed.wildDef["t"+ tid].mercLevel = newLevel;
		}
		if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('ERROR DE AJAX ');
      },
    });
  },

} 


/*************** KNIGHTS TAB *********************/
Tabs.Knights = {
  tabOrder : 19,
//  tabLabel : uW.g_js_strings.commonstr.knight,
  tabLabel : 'Knight',
  cont : null,
  displayTimer : null,
  action : 0,

  init : function (div){
    var t = Tabs.Knights;
    t.cont = div;
    uW.ptAssignSkill = t.clickedAssignPoints;
    uW.ptAssignTunes = t.clickedAssignTune;
    t.cont.innerHTML = '<STYLE>table.ptTabPad tr.ptwpad {background-color:#ffffff; padding-left:15px}</style>\
       <DIV id=ptknightdiv style="max-height:660px; height:660px; overflow-y:auto">';
  },

  hide : function (){
    var t = Tabs.Knights;
    clearTimeout (t.displayTimer);
  },

  show : function (){
    var t = Tabs.Knights;
    clearTimeout (t.displayTimer);

    function _dispKnight (roleId, knight, numcid){
      var rid = roleId;
      if (roleId==null)
        rid = 1;
      var sty='';
      if (row++ % 2)
        sty = 'class=ptOddrow ';
	m = '<TR '+ sty +'valign=top align=right><TD><B>'+ (roleId==null ? '':knightRoles[rid][0]) +'</b></td><TD align=left>';
      if (knight == null) {//mostramos estados y calificaciones
        m += '--------</td><TD colspan=4></td><TD class=ptentry colspan=5></td><TD colspan=2></td></tr>';
      } else {
        var level = parseInt(Math.sqrt(parseInt(knight.experience) / 75)) + 1;
        var unpoints = level - parseInt(knight.skillPointsApplied);
        var salary = (parseInt(knight.skillPointsApplied) + 1) * 20;
        totSalary += salary;
        var ass = '';
        if (knight.knightStatus == 10){
          ass = '<TD class=ptentry align=left colspan=4>Marching</td>';
        } else {
          if (unpoints > 0){
            unpoints = '<SPAN class="boldRed">'+ unpoints +'</span>';// asigna puntos del caballero
          for (var i=0; i<4; i++){
            var sty = 'padding-left:1px;';
            if (i == rid)   // bold it
              sty += 'font-weight:bold;color:#116654';
             if (t.action==2) {   
	          t.clickedAssignPoints(null,cid,knight.knightId,i);
            }
            if (t.action==1) {   
	      	  t.clickedAssignPoints(null,cid,knight.knightId,1);
            }
            ass += '<TD class=ptentry align=left style="'+ sty +'" ><A style="'+ sty +'" onclick="ptAssignSkill(this,' + cid +','+ knight.knightId +','+ i +')">['+ knightRoles[i][2] +'] &nbsp;</a></td>';
          }
          }
          else
            ass = '<TD class=ptentry colspan=4></td>';
        }
        var skills = [];
        for (var i=0; i<4; i++){
          if (i == rid)
            skills[i] = '<B>'+ knight[knightRoles[i][1]] +'</b>';
          else
            skills[i] = knight[knightRoles[i][1]];
        }
		
	var item211="0";
        var item221="0";
        var item231="0";
        var item241="0";
        if (Seed.items.i211) item211='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(1,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i211+'</a>';
        if (Seed.items.i221) item221='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(2,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i221+'</a>';
        if (Seed.items.i231) item231='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(3,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i231+'</a>';
        if (Seed.items.i241) item241='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(4,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i241+'</a>';
		
        m += '<a title="Role Assigner" onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ assign_role_modal('+ knight.knightId +');return false;}, 500);">'+knight.knightName + '</td><TD>'+ skills[0] +' ('+item211+')</td><TD>'+ skills[1] +' ('+item221+')</td><TD>'+ skills[2] +' ('+item231+')</td><TD>' + skills[3] +' ('+item241+')</td><TD class=ptentry>'+ unpoints +'</td>'+ ass +'<TD><a title="EXP Boost" onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){  xpBoost_modal('+ knight.knightId +');return false; }, 500);">'+ level +'</a></td><td><a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ loyalBoost_modal('+ knight.knightId +');return false;}, 500);">'+knight.loyalty+'</a></td><TD>'+ addCommas(salary) +'</td></tr>';

      }
      return m;
    }

    var totSalary = 0;
    var m = '<TABLE cellspacing=0 align=center class=ptTabPad><TBODY>';
    	  m += '<TR><TD colspan=15><DIV class=ptstat>Automatic methods of assignment - <input style="height:20px;font-size:9px;" type=button value="Add default" id="ptknight_def"><input style="height:20px;font-size:9px;" type=button value="Add to combat" id="ptknight_com"></div></td></tr>';
    for (var c=0; c<Cities.numCities; c++) {
      var cid = Cities.cities[c].id;
      m += '<TR><TD colspan=13><DIV class=ptstat>'+ Cities.cities[c].name +'</div></td></tr>\
          <TR class=ptwpad style="font-weight:bold" align=right><TD width=70>Role</td><TD width=140 align=center>name</td><TD width=26>Pol</td><TD width=26>Com</td>\
          <TD width=26>Int</td><TD width=26>Ing</td><TD width=90 align=center colspan=5>--- unassigned---</td><TD width=35>Level</td><td>loyalty</td><TD width=40 align=right> salary</td></tr>';
     totSalary = 0;
      var did = {}; 
      var row = 0;
      for (var i=0; i<knightRoles.length; i++){
        var leader = Seed.leaders['city'+cid][knightRoles[i][1]+'KnightId'];
        if (leader == 0)
          m += _dispKnight (i, null, c);
        else {
          m += _dispKnight (i, Seed.knights['city'+cid]['knt'+leader], c);
          did['knt'+leader] = true;
        }
      }
      var list = [];
      for (k in Seed.knights['city'+cid]){
        if (!did[k])
          list.push (Seed.knights['city'+cid][k]);
      }
      list.sort (function (a,b){return parseInt(b.combat)-parseInt(a.combat)});
      for (i=0; i<list.length; i++)
        m += _dispKnight (null, list[i], c);
      m += '<TR align=right><TD colspan=13><B>Total Salary:</b></td><TD>'+ addCommas(totSalary) +'</td></tr>';        
    }
    document.getElementById('ptknightdiv').innerHTML = m +'</tbody></table></div>';
	t.action = 0;
    document.getElementById('ptknight_com').addEventListener ('click', function (){
      t.action=1;
      t.show();
    }, false);
    document.getElementById('ptknight_def').addEventListener ('click', function (){
          t.action=2;
          t.show();
    }, false);
    t.displayTimer = setTimeout (t.show, 10000);
  },


  clickedAssignPoints : function (e, cid, kid, rid){
    var t = Tabs.Knights;
    clearTimeout (t.displayTimer);

    var knight = Seed.knights['city'+cid]['knt'+kid];
    if (knight.knightStatus == 10 && e!=null){
      var row = e.parentNode.parentNode;
      row.childNodes[7].innerHTML = 'Marching';
      return;
    }
    sk = [];
    var unassigned = parseInt(Math.sqrt(parseInt(knight.experience)/75)) + 1  - parseInt(knight.skillPointsApplied);
    for (var i=0; i<4; i++){
      sk[i] = parseInt(knight[knightRoles[i][1]]);
      if (i == rid)
        sk[i] += unassigned;
    }
    if (unassigned==0) return;

    if (e!=null) {
     var row = e.parentNode.parentNode;
     for (i=row.cells.length-1; i>=1; i--)
      row.deleteCell (i);
     var newCell=row.insertCell(-1);
     newCell.colSpan = 12;
     newCell.align= 'left';
     newCell.style.padding='1px 5px 1px 10px';
     var div = document.createElement ('div');
     div.style.backgroundColor = '#ffffff';
     div.style.textAlign = 'center';
     div.style.border = '1px solid';
     div.style.width = '98%';
     div.style.whiteSpace = 'normal';
     newCell.appendChild (div);
     div.innerHTML = 'Assigning '+ unassigned +' skill points to '+ knightRoles[rid][1] +' ... ';
    }
  t.postSkillPoints (cid, kid, sk[0], sk[1], sk[2], sk[3], function (r){t.postDone(r, div)});
  },

  postDone : function (rslt, div){
    var t = Tabs.Knights;
    clearTimeout (t.displayTimer);
    if (rslt.ok){
      div.innerHTML += '<B>done.</b>';
      t.displayTimer = setTimeout (t.show, 5000);
    } else {
      div.innerHTML += '<BR><SPAN class=boldRed>ERROR: '+ rslt.errorMsg +'</span>';
      t.displayTimer = setTimeout (t.show, 10000);
    }
  },

  postSkillPoints : function (cid, kid, pol, com, int, res, notify){
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.cid = cid;
    params.kid = kid;
    params.p = pol;
    params.c = com;
    params.i = int;
    params.r = res;
    if (DISABLE_POST_KNIGHT_SKILLS){
      setTimeout (function (){notify({ok:true})}, 1500);
//      setTimeout (  function (){notify({ok:false, errorMsg:"FAKE ERROR message, a long one, to test how it will fit and overflow! Perhaps you'll need to retry?"})}  , 2000);
      return;
    }
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/skillupKnight.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok) {
          var knight = Seed.knights["city" + cid]["knt" + kid];
          var up = pol + com + int + res - knight.politics - knight.combat - knight.intelligence - knight.resourcefulness;
          knight.politics = pol;
          knight.combat = com;
          knight.intelligence = int;
          knight.resourcefulness = res;
          knight.skillPointsApplied = (parseInt(knight.skillPointsApplied) + up).toString();
        }
        if (notify)
          notify (rslt);
      },
      onFailure: function () {
        if (notify)
          notify (rslt);
      },
    });
  },
};

/**************AllianceReports singleton**********************/

var messageNav = {
  mmFunc : null,
  mmsFunc : null,
  MapFunc :null,
  
 init : function (){
    t = messageNav;
    t.MapFunc = new CalterUwFunc ('modal_maptile', [[/}\s*$/, 'setTimeout(function() { KsMdal_hook(j,k,m); },0); }']]);
    t.mmFunc = new CalterUwFunc ('modal_messages', [[/}\s*$/, 'setTimeout(messageNav_hook,0); }']]);
    t.mmsFunc = new CalterUwFunc ('modal_messages_send', [[/{\s*var params/i, '{\nif (modal_messages_send_hook()) return;\nvar params']]);
    unsafeWindow.KsMdal_hook = t.testons;
    unsafeWindow.modal_messages_send_hook = t.msgSendHook;    
    t.mmFunc.setEnable (true);
    t.mmsFunc.setEnable (true);
    t.MapFunc.setEnable (true);
  },

  setEnable : function (tf){
  },

  isAvailable : function (){
    t = messageNav;
	return t.mmFunc.isAvailable();
  },

  	testons :function(uid) {
		if (uid!=null) {
			var div = ById('contextMenu');
			var scr = document.createElement('div');
			scr.className = "maptilewrap";
			scr.innerHTML ="checking the details of the player...";
			div.appendChild(scr);
			var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
			params.checkArr = uid;
			new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					var p = rslt.data;
					if (p[uid] == true) {
						m = '<span style="color:red"><blink><b>El player is on line!</b></blink></span>';
						scr.innerHTML= m;
					} else {
						m = '<span style="color:green"><blink><b>El player is offline!</b></blink></span>';
						scr.innerHTML= m;
						var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
						params.pid = uid;
						new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
							method: "post",
							parameters: params,
							onSuccess: function (rslt) {
								if (rslt.ok) {
									scr.innerHTML += '<br><b><u>last loginn</u>:</b> <span style="color:green"><b>'+rslt.playerInfo.lastLogin+'</b></span>';
								}

							},onFailure: function (rslt) {},

						});

					}


				},onFailure: function (rslt) {},

			});
		}
	},
  
  hook : function (){
    if (!Options.enhanceMsging)
      return;
    var div = document.getElementById('modal_msg_view_actions');
    div = document.getElementById('modal_msg_write_to').parentNode;
    div.innerHTML = '<TABLE><TR><TD class=xtab><b>A:</b> <INPUT type=text id=modal_msg_write_to></td>\
    <TD class=xtab></td></tr>\
    <tr><td></td><td></td></tr></table>\
    <table><tr><TD colspan=2><SPAN id=pt2fwdbut></span></td></tr></table>';
    document.getElementById('ptfwdbut').innerHTML="Cc : <INPUT type=text id=message_cc>"; 
    
  },

  eventForward : function (){
    document.getElementById('modal_msg_write_subj').value = "fwd: " + document.getElementById('modal_msg_view_subj').innerHTML.toString().stripTags();
    document.getElementById('modal_msg_write_to').value = '';
    var from = document.getElementById('modal_msg_view_from').children[0].innerHTML;
    var body = document.getElementById('modal_msg_view_body').innerHTML.replace(/\n/g, '').replace(/<br>/gi, '\n').stripTags().replace (/back$/i, '');
    document.getElementById('modal_msg_write_txt').value = '[Mensaje original de '+ from +' follows:]\n'+ body;
    uW.modal_messages_compose();
  },

  msgSendHook : function (){
    if (!Options.enhanceMsging)
      return;
    var to = document.getElementById("modal_msg_write_to").value.trim();
    if (to.toLowerCase() != '<officers>' || getMyAlliance()[0]==0)
      return false;
    var params = uW.Object.clone(uW.g_ajaxparams);
        params.subject = "CC: "+ById("modal_msg_write_subj").value;
        params.message = ById("modal_msg_write_txt").value;
        params.requestType = 'COMPOSED_MAIL';
        params.toIds = getMyAlliance()[0]; 
        params.type = 'alliance';       
        new AjaxRequest(uW.g_ajaxpath + "ajax/sendMessage.php" + uW.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            if (rslt.ok) {
                uW.Modal.showAlert(uW.g_js_strings.modal_messages_send.msgsent);
                document.getElementById('modal_msg_write_to').value = "";
                document.getElementById('modal_msg_write_subj').value = "";
                document.getElementById('modal_msg_write_txt').value = ""
            } else {
                uW.Modal.showAlert(uW.g_js_strings.modal_messages_send.enterexistingname)
            }
        },
        onFailure: function () {
          uW.Modal.showAlert(uW.g_js_strings.modal_messages_send.oopscompose)
        },
    });
    return true;
  },
}

var AttackDialog = {
  init : function (){
    var t = AttackDialog;
    t.modal_attackFunc = new CalterUwFunc ('modal_attack', [[/}\s*$/, 'attackDialog_hook(); }']]);
    uW.attackDialog_hook = t.modalAttackHook;
    t.modal_attackFunc.setEnable (true);
  },
  
  setEnable : function (){
  },

  isKnightSelectAvailable : function (){
    var t = AttackDialog;
    return t.modal_attackFunc.isAvailable();
  },
  isAttackCityPickerAvailable : function (){
    var t = AttackDialog;
    return t.modal_attackFunc.isAvailable();
  },
    
  modalAttackHook : function (){
    var t = AttackDialog;
    if (Options.fixKnightSelect || Options.attackCityPicker){
      for (var i=1; i<6; i++)
        document.getElementById('modal_attack_tab_'+ i).addEventListener('click', t.e_changeMarchType, false);
    }
    if (Options.attackCityPicker){
      setTimeout (t.initCityPicker, 0);
    }      
  },
  
  initCityPicker : function (){
    var t = AttackDialog;
    var div = document.getElementById('modal_attack_target_numflag'); // as of KofC version 96;
    var mySpan;
    if (div) {
      div.parentNode.innerHTML += ' &nbsp; <SPAN id=modal_attack_citybuts></span>';
    } else {
      var span = document.getElementById('modal_attack_target_coords');   // KofC version 116+;
      span.parentNode.parentNode.firstChild.innerHTML += ' &nbsp; <SPAN id=modal_attack_citybuts></span>';
    }
    new CdispCityPicker ('ptatp', document.getElementById('modal_attack_citybuts'), false, t.e_CityButton);
    var cityIdx = Cities.byID[uW.currentcityid].idx;
    thisCityBut = document.getElementById('ptatp_'+ cityIdx);
    thisCityBut.style.opacity = '0.5';
    thisCityBut.disabled = true;
    if (document.getElementById('modal_attack_tab_4').className=='selected' || document.getElementById('modal_attack_tab_3').className=='selected')   // don't do for attack or scout
      document.getElementById('modal_attack_citybuts').style.display = 'none';
  },
  
  e_CityButton : function (city){
    document.getElementById('modal_attack_target_coords_x').value = city.x;
    document.getElementById('modal_attack_target_coords_y').value = city.y;
    uW.modal_attack_update_time();
  },
      
  e_changeMarchType : function (evt){
    var t = AttackDialog;
    var marchType = parseInt(evt.target.id.substr(17));  
    if (Options.attackCityPicker){
      if (marchType==3 || marchType==4)
        document.getElementById('modal_attack_citybuts').style.display = 'none';
      else
        document.getElementById('modal_attack_citybuts').style.display = 'inline';
    }
    if (Options.fixKnightSelect){
      var knightVal = 0;
      var selector = document.getElementById('modal_attack_knight'); 
      if (selector.length>1 && (marchType==4 || marchType==2))   // if 'attack' or 'reinforce'
        knightVal = 1;
      selector.selectedIndex = knightVal;
    }
  },  
}


var AllianceReports = {
  checkPeriod : 300,
  allianceNames : [],
  saveArfunc : uW.allianceReports,

  init : function (){
    t = AllianceReports;
    t.enable (Options.enhanceARpts);
    t.marvFunc = new CalterUwFunc ('modal_alliance_report_view', [['getReportDisplay', 'getReportDisplay_hook2']]);
    t.memListFunc = new CalterUwFunc ('membersInfo', [['commonstr.might','commonstr.might + "</td><td class=colcities>" + g_js_strings.commonstr.cities + "</td><td class=collast>" + g_js_strings.membersInfo.lastonline'],['memberInfo[key].prestige', 'memberInfo[key].prestige+ "</td>");memhtml.push("<td class=colcities>" + memberInfo[key].cities + "</td>");memhtml.push("<td class=collast>" + memberInfo[key].lastLogin']]);
    uW.getReportDisplay_hook2 = t.getReportDisplayHook;
    uW.getmembersInfo_hook = t.getMembersInfoHook;
    t.marvFunc.setEnable (true);
	t.enable_viewmembers(Options.enhanceViewMembers);
  },
   
  getReportDisplayHook : function (a, b){
    var x = '';
    try {
      x = uW.getReportDisplay(a,b);  
    } catch (e){
      x = 'Error formatting report: '+ e;
    }
    return x;
  },
  
  enable_viewmembers : function (tf){
    t = AllianceReports;
    t.memListFunc.setEnable (tf);
  },
  
  enable : function (tf){
    t = AllianceReports;
    if (tf)
      uW.allianceReports = t.myAllianceReports;
    else
      uW.allianceReports = t.saveArfunc;
  },
  
  myAllianceReports : function (pageNum){
    var params = uW.Object.clone(uW.g_ajaxparams);
    if (pageNum)
      params.pageNo = pageNum;
    params.group = "a";
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/listReports.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        displayReports (rslt.arReports, rslt.arPlayerNames, rslt.arAllianceNames, rslt.arCityNames, rslt.totalPages);
      },
      onFailure: function (rslt) {
      },
    }, false);

    function displayReports (ar, playerNames, allianceNames, cityNames, totalPages){
      var msg = new Array();
      var myAllianceId = getMyAlliance()[0];
      msg.push ("<STYLE>.msgviewtable tbody .myCol div {margin-left:5px; overflow:hidden; white-space:nowrap; color:#000}\
            .msgviewtable tbody .myHostile div {font-weight:600; color:#600}\
            .msgviewtable tbody .myGray div {color:#666}\
            .msgviewtable tbody .myRein div {color:#050}\
            .msgviewtable tbody .myWarn div {font-weight:600; color:#442200}\
            </style>");
      msg.push("<div class='modal_msg_reports'>");
      var rptkeys = uW.Object.keys(ar);
      if (matTypeof(ar) != 'array') {
        if (Options.allowAlterAR)
          msg.push("<div id='modal_alliance_reports_tablediv' class='modal_msg_list'><table width=675 cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
        else
          msg.push("<div id='modal_alliance_reports_tabledivNKA' class='modal_msg_list'><table width=675 cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
        msg.push("<thead><tr><td width=105>FECHA</td><td width=40>TIPO</td><td width=150>ATACANTE</td><td>OBJETIVO</td><td>VER</td></tr></thead><tbody>");
        for (var i = 0; i < rptkeys.length; i++) {
          var rpt = ar[rptkeys[i]];
          var colClass = '"myCol"';
          rpt.marchType = parseInt(rpt.marchType);
          rpt.side0AllianceId = parseInt(rpt.side0AllianceId);
          var targetDiplomacy = getDiplomacy (rpt.side0AllianceId);
          if (rpt.marchType == 2){
            colClass = '"myCol myRein"';
          } else if (rpt.side1AllianceId != myAllianceId){
            colClass = '"myCol myHostile"';
          } else {
            if (parseInt(rpt.side0TileType) < 50){          // if wild
              if (parseInt(rpt.side0PlayerId) == 0)
                colClass = '"myCol myGray"';
              else
                colClass = '"myCol myWarn"';
            } else if (parseInt(rpt.side0PlayerId) == 0) {   // barb
              colClass = '"myCol myGray"';
            } else {
              if (targetDiplomacy == 'friendly')
                colClass = '"myCol myWarn"';
            }
          }
          msg.push ('<tr valign=top');
          if (i%2 == 0)
            msg.push(" class=stripe");
          msg.push("><TD class="+ colClass +"><div>");
          msg.push(uW.formatDateByUnixTime(rpt.reportUnixTime));
          msg.push ('<BR>Rpt #');
          msg.push (rpt.reportId);          
          msg.push("</div></td><TD class="+ colClass  +"><div>");
          if (rpt.marchType == 1)
            msg.push (uW.g_js_strings.commonstr.transport);
          else if (rpt.marchType == 3)
            msg.push (uW.g_js_strings.commonstr.scout);
          else if (rpt.marchType == 2)
            msg.push ('Reinf');
          else
            msg.push (uW.g_js_strings.commonstr.attack);

          // attacker ...
          msg.push ("</div></td><TD class="+ colClass +"><div>");
          if (parseInt(rpt.side1PlayerId) != 0)
            msg.push(escape(playerNames["p" + rpt.side1PlayerId]))
          else
            msg.push ('?Unknown?');
            msg.push (' ');
            msg.push (coordLink(rpt.side1XCoord, rpt.side1YCoord));
            msg.push ('<BR>');
          
          if (rpt.side1AllianceId != myAllianceId){
            msg.push (allianceNames['a'+rpt.side1AllianceId]);
            msg.push (' (');
            msg.push (getDiplomacy(rpt.side1AllianceId));
            msg.push (')');
          } else {
            msg.push ('<BR>');
          }
          msg.push ('</div></td>');

          // target ...
          msg.push ("<TD class="+ colClass  +"><DIV>");
          var type = parseInt(rpt.side0TileType);

          if (type < 50){                              // wild
            msg.push(uW.g_mapObject.types[type].toString().capitalize());
            msg.push(" Lvl " + rpt.side0TileLevel)
            if (parseInt(rpt.side0PlayerId) != 0) {   // IF OWNED, show owner ...
              msg.push (' [');
              msg.push (escape(playerNames["p" + rpt.side0PlayerId]));
              msg.push ('] ');
            }
          } else {
            if (parseInt(rpt.side0PlayerId) == 0) {   //  barb
              msg.push(uW.g_js_strings.commonstr.barbariancamp);
              msg.push(" Lvl " + rpt.side0TileLevel)
            } else {        // city
              msg.push (escape(playerNames["p" + rpt.side0PlayerId]));
              msg.push (' - ');
              msg.push (cityNames['c'+ rpt.side0CityId]);
            }
          }
          msg.push (' ');
          msg.push (coordLink(rpt.side0XCoord, rpt.side0YCoord));
          if (rpt.side0AllianceId!=0 && rpt.side0AllianceId!=myAllianceId){
            msg.push ('<BR>');
            msg.push (allianceNames['a'+rpt.side0AllianceId]);
            msg.push (' (');
            msg.push (targetDiplomacy);
            msg.push (')');
          }

          

          
          
          // 'view report' link ...
          if (Options.allowAlterAR)
            msg.push("</div></td><TD class="+ colClass  +"><div><a onclick=' modal_alliance_report_view(\"");   // ONCLICK ???
          else
            msg.push("</div></td><TD class="+ colClass  +"><div><a onclick=' $(\"modal_alliance_reports_tabledivNKA\").id=\"modal_alliance_reports_tablediv\"; modal_alliance_report_view(\"");   // ONCLICK ???
          msg.push(rpt.reportId);
          msg.push('",');
          if (parseInt(rpt.side1AllianceId) == parseInt(Seed.allianceDiplomacies.allianceId))
            msg.push(1);
          else
            msg.push(0);
          msg.push(",");
          msg.push(rpt.side0TileType);
          msg.push(",");
          msg.push(rpt.side0TileLevel);
          msg.push(",");
          msg.push(rpt.side0PlayerId);
          msg.push(',"');
          if (parseInt(rpt.side0PlayerId) != 0)
            msg.push(escape(playerNames["p" + rpt.side0PlayerId]));
          else
            msg.push(uW.g_js_strings.commonstr.enemy);
          msg.push('","');
          if (parseInt(rpt.side0PlayerId) != 0)
            msg.push(escape(playerNames["g" + rpt.side0PlayerId]));
          else
            msg.push(0)
          msg.push('","');
          if (parseInt(rpt.side1PlayerId) > 0)
            msg.push(escape(playerNames["p" + rpt.side1PlayerId]));
          msg.push('","');
          if (parseInt(rpt.side1PlayerId) != 0)
            msg.push(escape(playerNames["g" + rpt.side1PlayerId]));
          msg.push('",');
          msg.push(rpt.marchType);
          msg.push(",");
          msg.push(rpt.side0XCoord);
          msg.push(",");
          msg.push(rpt.side0YCoord);
          msg.push(",");
          msg.push(rpt.reportUnixTime);
          msg.push(",");
          if (parseInt(rpt.reportStatus) == 2)
            msg.push(1);
          else
            msg.push(0);
          if (rpt.side1XCoord) {
            msg.push(",");
            msg.push(rpt.side1XCoord);
            msg.push(",");
            msg.push(rpt.side1YCoord)
          } else {
            msg.push(",,");
          }
          msg.push(");return false;'>View</a></div></td></tr>");
        }
        msg.push("</tbody></table></div>");
      }
      msg.push("</div><div id='modal_report_list_pagination'></div>");
      document.getElementById('allianceContent').innerHTML = msg.join("");
      if (pageNum) {
        uW.ctrlPagination("modal_report_list_pagination", totalPages, "allianceReports", pageNum)
      } else {
        uW.ctrlPagination("modal_report_list_pagination", totalPages, "allianceReports")
      }
    }
  },

}   // end AllianceReports singleton

/*************************************** OVERVIEW TAB ************************************************/
var GMTclock = {
  span : null,
  timer : null,
  
  init : function (){
    this.span = document.createElement ('span');
    this.span.style.fontWeight = 'bold';
    document.getElementById('kochead_time').parentNode.appendChild (this.span);
    this.setEnable (Options.gmtClock);
  },

  setEnable : function (tf){
    var t = GMTclock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
    
  everySecond : function (){
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*60000));
  	GMTclock.span.innerHTML = ' &nbsp; ('+ now.toLocaleFormat('%H:%M') +')';
  },
}


function getResourceProduction (cityId){
  var ret = [0,0,0,0,0];
  var now = unixTime ();
  var search='type==10 || type==11';
  var wilds = [0, 0, 0, 0, 0];
  var w = Seed.wilderness["city" + cityId];
  for (var k in w){
    var type = parseInt(w[k].tileType);

    if (type==10 || type==11)
	      wilds[1] += parseInt(w[k].tileLevel);
	    else 
	      wilds[type/10] += parseInt(w[k].tileLevel);
  }  
  knight = 0;       
  var s = Seed.knights["city" + cityId];
  if (s) {
    s = s["knt" + Seed.leaders["city" + cityId].resourcefulnessKnightId];
    if (s){
      var knight = parseInt(s.resourcefulness);
      if (s.resourcefulnessBoostExpireUnixtime > now)
        knight *= 1.25;
    }
  }
  var workerFactor = 1;
  var c = parseInt(Seed.citystats["city" + cityId]["pop"][0]);  // Current  population
  var w = parseInt(Seed.citystats["city" + cityId]["pop"][3]);  // Labor force
  if (w > c)
    workerFactor = c / w;
  
  for (var i=1; i<5; i++){
    var usage = Seed.resources["city" + cityId]["rec" + i];
    var items = 0;
    if (parseInt(Seed.playerEffects["r" + i + "BstExp"]) > now) {
      items = 0.25;
    }
    var tech = Seed.tech["tch" + i];
    ret[i] = parseInt((usage[2] * (1 + tech/10 + knight/100 + items + 0.05 * wilds[i]) * workerFactor + 100));
  }
  return ret;  
}

function getWallInfo (cityId, objOut){
  objOut.wallSpaceUsed = 0;
  objOut.fieldSpaceUsed = 0;
  objOut.wallLevel = 0;  
  objOut.wallSpace = 0;     
  objOut.fieldSpace = 0;  
  var b = Seed.buildings["city" + cityId];
  if (b.pos1==null)
    return;  
  objOut.wallLevel = parseInt(b.pos1[1]);
  var spots = 0;
  for (var i=1; i<(objOut.wallLevel+1); i++)
    spots += (i * 500);
  objOut.wallSpace = spots;     
  objOut.fieldSpace = spots;  
     
  var fort = Seed.fortifications["city" + cityId];
  for (k in fort){
    var id = parseInt(k.substr(4));
    if (id<60)
      objOut.wallSpaceUsed += parseInt(uW.fortstats["unt"+ id][5]) * parseInt(fort[k]);
    else
      objOut.fieldSpaceUsed += parseInt(uW.fortstats["unt"+ id][5]) * parseInt(fort[k]);
  }
}    


Tabs.OverView = {
  tabOrder : 1,
  tabLabel : 'OVERVIEW ',
  cont:null,
  displayTimer:null,
  curTabBut : null,
  curTabName : null,
  	
  init : function (div){
    var t = Tabs.OverView;
    dt = new Date ();
    dt.setTime (Seed.player.datejoinUnixTime * 1000);
    t.cont = div;
    
    var main = '<DIV class=ptstat style="margin-top:5px; margin-bottom:5px;"><TABLE cellspacing=0 cellpadding=0 class=ptTab width=97% align=center>';
    main +='<TR align=left><TD><SPAN class=ptStatLight>JOINED:</span> '+ dt.toLocaleDateString() +'</td>';
    main +='<TD><SPAN class=ptStatLight>Might:</span> ' + addCommas(Seed.player.might) +'</td>';
    main +='<TD><SPAN class=ptStatLight>Alliance:</span> ' + getMyAlliance()[1] +'</td>';
    main +='<TD align=right><SPAN class=ptStatLight>DOMAIN:</span> ' + uW.domainName +'</td></tr></table></div>';      
	main +='<TABLE class=ptTab align=left><TR>';
    main +='<TD width=125px><SELECT id="ShowExtra"><option value="maximum">'+uW.g_js_strings.commonstr.maximum+'</options>';
    main +='<option value="normal">'+uW.g_js_strings.commonstr.normal+'</options></select></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubA type=submit value='+uW.g_js_strings.commonstr.resources+'></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubB type=submit value='+uW.g_js_strings.commonstr.troops+'></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubC type=submit value='+uW.g_js_strings.modaltitles.buildings+'></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubD type=submit value='+uW.g_js_strings.commonstr.info+'></td></tr></table><BR><BR>';
    main +='<DIV id=ptOverOutput align=left style="margin-top:10px; background-color:"#F8F8F8"; height:680px; overflow:scroll;"></div>';
	main += '<TD width = "100px" ; border:none"><a href="http://code.google.com/p/koc-power-tools/wiki/HowToOverview" target="_blank">Help</a></td></tr>';
            
    t.cont.innerHTML = main;
    t.Overv = document.getElementById('ptOverOutput');
    
    document.getElementById('ShowExtra').value = Options.OverViewShowExtra; 
    document.getElementById('ptmrchSubA').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubB').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubC').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubD').addEventListener('click', e_butSubtab, false);
    document.getElementById('ShowExtra').addEventListener('change', function(){
           Options.OverViewShowExtra = document.getElementById('ShowExtra').value;
           saveOptions();
           clearTimeout (t.displayTimer);
           t.init(div); 
    }, false);
    changeSubtab (document.getElementById('ptmrchSub'+Options.curOverTab));
    
    function e_butSubtab (evt){            
      changeSubtab (evt.target);   
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pbSubtab'; 
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pbSubtab pbSubtabSel'; 
      but.disabled=true;
      t.curTabName = but.id.substr(-1);
	  Options.curOverTab = t.curTabName;
      t.show ();
    }    
  },

  hide : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
  },
  
  show : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    if (t.curTabName == 'A') 
    	if (Options.OverViewShowExtra == "maximum") t.showResources(); 
    		else t.paintOld();
    else if (t.curTabName == 'B')
      t.showTroops();
    else if (t.curTabName == 'C')
      t.showBuilds();
    else if (t.curTabName == 'D')
      t.showInfo();
  },
  
      showResources : function (){
        var t = Tabs.OverView;
        t.Overv.innerHTML = null;
        t.Overv.style.maxHeight = '700px';
        t.Overv.style.overflowY = 'scroll';
        clearTimeout (t.displayTimer);	
         var z = "<DIV id=overMain><TABLE class=ptTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right><TD style='background: #FFFFFF; border:none;'></td>";
              for(i=0; i<Cities.numCities; i++) {
                z += "<TD width=81 style='background: #FFFFFF'><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ uW.provincenames['p'+ Cities.cities[i].provId];
                cityID = 'city'+Cities.cities[i].id;
                Gate = parseInt(Seed.citystats[cityID].gate);
                if(Gate == 0)
                  z+= '<BR>refugiadas</td>';
                else
                  z+= '<BR><SPAN class=boldRed>Defending</span></td>';
              }
        	  for (var a=1; a<=5;a++){
        	  		var total = 0;
        	  		z+='<TR><TD colspan="8" style="background: #FFFFFF"><B>'+((a!=5)?uW.resourceinfo['rec'+a]:uW.resourceinfo['7'])+': </b></td></tr><TR>';
        	  		for(b=0; b<Cities.numCities; b++) total += parseInt((a!=5)?Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600:Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]);
        	  		z+='<TD>'+ addCommas(total) +'</td>';
        	  		for(b=0; b<Cities.numCities; b++) z+='<TD align=right ">'+ addCommasInt((a!=5)?Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600:Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]) +'</font></td>';
        	  		z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showResourceTooltip.caplimit+':</font></td>';
        	  		for(b=0; b<Cities.numCities; b++) {
        	  			    z+='<TD align=right style="background: #FFFFFF">';
							if(a==5){
								z+= (parseInt(1000000) > parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]))? '<FONT COLOR= "669900">':'<FONT COLOR="686868">';
								z+= addCommas(1000000);
							} else{
								if (parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][1]/3600) > parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600)) z+='<FONT COLOR= "669900">';
								else z+='<FONT COLOR="686868">';
								z+= addCommas( parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][1]/3600));
							}
        	  				z+='</font></td>';
        	  		}
					if(a!=5){
						z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showResourceTooltip.hrprod+':</font></td>';
						for(b=0; b<Cities.numCities; b++) {
								var rp = getResourceProduction (Seed.cities[b][0]);
								var usage = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][3]);
								z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+ addCommas(rp[a] - usage)  +'</font></td>';
						}
					}
        	  		z+='</tr>';
        	  		if (a==1){
        	  			z+='<TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.upkeep+':</font></td>';
        	  			for(b=0; b<Cities.numCities; b++){
        	  				 var rp = getResourceProduction (Seed.cities[b][0]);
        	  				 var usage = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][3]);
        	  				 var prod = rp[a] - usage;
        	  				 var timeLeft = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]) / 3600 / (0-prod) * 3600;
        				 	 if (prod > 0) z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">----</font></td>';
        	  				 else {
        		  				 if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600)) z+='<TD align=right style="background: #FFFFFF"><FONT COLOR=RED>';
        		  				 else  z+='<TD align=right style="background: #FFFFFF"> <FONT COLOR="686868">';
        		  				 z+= timestrShort(timeLeft) +'</font></td>';
        		  				 
        	  				}
        	  		   }
        	  	    }
        	  	  var totalmarching = 0;
        	  	  for(b=0; b<Cities.numCities; b++) {
        	  	  	   var march = Seed.queue_atkp['city' + Seed.cities[b][0]];
        	  	  	   if (march != []) for (c in march) 
        	  	  	   		if (march[c]['resource'+a] != undefined && march[c]['marchType'] != 9) totalmarching += parseInt(march[c]['resource'+a]);
        	  	  } 
        	  	  if (totalmarching > 0){
		        	  	  z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.marching+':</font></td>';
		        	  	  for(b=0; b<Cities.numCities; b++) {
		        	  	  	   var recmarching = 0;
		        	  	  	   var march = Seed.queue_atkp['city' + Seed.cities[b][0]];
		        	  	  	   if (march != []) for (c in march) 
		        	  	  	   		if (march[c]['resource'+a] != undefined && march[c]['marchType'] != 9) recmarching += (parseInt(march[c]['resource'+a]));
		        	  	       if (recmarching !=0)	z+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(recmarching)+'</font></td>';
		        	  	       else z+= '<TD align=right style="background: #FFFFFF"></td>';
		        	  	  }	
		       	  }
        	  }
        	  z+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td><TR><TD colspan="8" style="background: #FFFFFF"><B>'+uW.g_js_strings.commonstr.gold+':</b></td></tr><TR>';
        	  var goldtotal = 0;
        	  for(b=0; b<Cities.numCities; b++) goldtotal += parseInt(Seed.citystats["city" + Seed.cities[b][0]]['gold'][0]);
        	  z+='<TD>'+addCommas(goldtotal)+'</td>';
        	  for(b=0; b<Cities.numCities; b++) {
        	  		z+='<TD align=right >'+ addCommas(Seed.citystats["city" + Seed.cities[b][0]]['gold'][0])  +'</td>';
        	  }
        	  z+='<TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showGoldTooltip.netincome+':</font></td>';
        	  for(b=0; b<Cities.numCities; b++) {
        	  		var f = 1;
        	  		if (parseInt(Seed.playerEffects.r0BstExp) > unixTime()) f = 2;
        	  		var g = parseInt(parseInt(Seed.citystats["city" + Seed.cities[b][0]]['gold'][1] * Seed.citystats["city" + Seed.cities[b][0]]['pop'][0]) * 0.01) * f;
        	  		var h = parseInt(Seed.citystats["city" + Seed.cities[b][0]]["gold"][2] * 10 * -1);
        	  		z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+ addCommas(g+h)  +'</font></td>';
        	  }
        	  z+='</tr><TR><TD colspan="8" style="background: #FFFFFF">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.showPopTooltip.idlepop+':</b></td>';
        	  for(b=0; b<Cities.numCities; b++) {
    	  			var i = Seed.citystats["city" + Seed.cities[b][0]]['pop'][0];
    	  			var j = Seed.citystats["city" + Seed.cities[b][0]]['pop'][3];
    	  			var k = i - j;
    	  			if (k > 0) z+='<TD align=right style="background: #FFFFFF">'+ addCommas(k)  +'</td>'; 
    	  			 else z+='<TD align=right style="background: #FFFFFF"><FONT COLOR=red>'+ addCommas(k)  +'</font></td>';
        	  }  
        	 z+='</tr><TR><TD colspan="8" style="background: #FFFFFF">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.showMyWilderness.conqueredwild+':</b></td>';
        		for(b=0; b<Cities.numCities; b++) {
        		      var totWilds = 0;
        			  dat = Seed.wilderness['city'+ Seed.cities[b][0]];
        			  if (dat!=null && matTypeof(dat)=='object')
        		  			for (k in dat)
        		    			++totWilds;
        			 var castle = parseInt(Seed.buildings['city'+ Seed.cities[b][0]].pos0[1]);
        			 if(castle == 11) castle = 12;
        			 else if(castle == 12) castle = 14;
        			 if (totWilds < castle)
        		  	z+=  '<TD align=right "><FONT COLOR=RED>'+ totWilds +'/'+ castle +'</font></span>';
        			else
        		  		z+=  '<TD align=right>'+ totWilds +'/'+ castle +'</span>';
        		}
        		z+='</tr>';
              for (c in uW.cm.WILDERNESS_TYPES){
              		var wildtype ='';
              		switch (c) {
              		  case 'GRASSLAND' : wildtype = uW.g_js_strings.commonstr.grassland;break;
              		  case 'LAKE' : wildtype = uW.g_js_strings.commonstr.lake;break;
              		  case 'WOODS' : wildtype = uW.g_js_strings.commonstr.woods;break;
              		  case 'HILLS' : wildtype = uW.g_js_strings.commonstr.hills;break;
              		  case 'MOUNTAIN' : wildtype = uW.g_js_strings.commonstr.mountain;break;
              		  case 'PLAIN' : wildtype = uW.g_js_strings.commonstr.plain;break;
              		}
              		var grandtotal = 0;
              		for(b=0; b<Cities.numCities; b++) {
              			dat = Seed.wilderness['city'+ Seed.cities[b][0]];
              			if (dat!=null && matTypeof(dat)=='object') for (k in dat) if (dat[k]['tileType'] == uW.cm.WILDERNESS_TYPES[c]) grandtotal++; 
              		}
              		if (grandtotal >0) {
		              		z+='<TR><TD style="background: #FFFFFF">'+wildtype+'</td>';
		              		for(b=0; b<Cities.numCities; b++) {		
		              			var total =0;
		              			dat = Seed.wilderness['city'+ Seed.cities[b][0]];
		              			if (dat!=null && matTypeof(dat)=='object')
		              					for (k in dat)
		              						if (dat[k]['tileType'] == uW.cm.WILDERNESS_TYPES[c])
		              							++total;  
		        				if (total >0) z+='<TD align=right style="background: #FFFFFF">'+total+'</td>';
		        				else z+='<TD style="background: #FFFFFF"></td>';
		        					
		              		}
		              		z+='</tr>';
		      	    }       
              }
             
        var totboosts = false;
        	  var l = Seed.playerEffects;
            for (p in l) if (l[p] > unixTime()) totboosts =true;               
            if (totboosts) {
                z+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.commonstr.boost+':</b></td>';
                for (p in l) {
                   if (p =='r0BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+0]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r1BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+1]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r2BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+2]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r3BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+3]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r4BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+4]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='atkExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.attack+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='defExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.defend+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='loadExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.modal_barracks_train.load+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='returnExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.returning+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='troopUpkeepReductExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.upkeep+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='fogExpire' && l[p] > unixTime()) z+='<TR ><TD style="background: #FFFFFF">'+uW.itemlist.i10021.name+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
               }
            }      
        z+='</table></div>';
      t.Overv.innerHTML = z;
     	t.displayTimer = setTimeout (t.showResources, 1000);  
   },   
      
        
    showTroops : function (){
      var t = Tabs.OverView;
      t.Overv.innerHTML =null;
      t.Overv.style.maxHeight = '700px';
      t.Overv.style.overflowY = 'scroll';
      var n = "<TABLE class=ptTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right></td><TD colspan='2' id=update align=center style='background: #FFFFFF; border:none; vertical-align:middle'><INPUT id=TEST type=submit value="+uW.g_js_strings.modal_progress_actions.updatestatus+"></td></td>";
           for(i=0; i<Cities.numCities; i++) {
             n += "<TD width=81 style='background: #FFFFFF'><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ uW.provincenames['p'+ Cities.cities[i].provId] +"</td>";
           }
   	  for(a=1;a<13;a++) {
   	        var total=0;
   	        var marching = 0;
   	        var raiding = 0;
   	        var tottraining = 0;
   	        
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   var train = Seed.queue_unt['city' + Seed.cities[b][0]];
   	        	   if (train != []) for (c in train) if (train[c][0] == a) tottraining += parseInt(train[c][1]);
   	        }
   	        if (tottraining > 0) var rowsp = 3; 
   	        else var rowsp = 2; 
   	        n+='<TR><TD rowspan="'+rowsp+'" style="background: #FFFFFF; vertical-align:top;"><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+a+'_30.jpg></td>';
   	        for(b=0; b<Cities.numCities; b++) total += parseInt(Seed.units['city' + Seed.cities[b][0]]['unt'+a]);
   	        if (total >0) n+='<TD align=right >'+addCommas(total)+'</td>';
   	        else n+='<TD align=right >&nbsp;</td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	if (Seed.units['city' + Seed.cities[b][0]]['unt'+a] > 0) n+= '<TD align=right >'+addCommas(Seed.units['city' + Seed.cities[b][0]]['unt'+a])+'</td>';
   	        	else n+='<TD ></td>';
   	        }
   	        n+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.marching+'</font></td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   marching = 0;
   	        	   raiding = 0;
   	        	   var atkp = Seed.queue_atkp['city' + Seed.cities[b][0]];
   	        	   if (atkp != []){
	   	        	   for (c in atkp){
	   	        	   		if (atkp[c]['marchType'] == 9) raiding += (parseInt(atkp[c]['unit'+a+'Count']) + parseInt(atkp[c]['unit'+a+'Return']));
	   	        	   		else if (atkp[c]['marchType'] != undefined)marching += parseInt(atkp[c]['unit'+a+'Count']);
	   	        	   }
	   	        	   if (marching >0 || raiding > 0) {
	   	        	   		n+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(marching)+' / ';
	   	        	   		n+= addCommas(raiding)+'</font></td>';
   	        	   	   }
   	        	   	   else n+='<TD style="background: #FFFFFF"></td>';	
   	        	   }
   	        }
   	      if (tottraining >0){
   	        n+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.modal_openBarracks.trainingttl+'</font></td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   training = 0;
   	        	   var train = Seed.queue_unt['city' + Seed.cities[b][0]];
   	        	   if (train != []){
	   	        	   for (c in train) if (train[c][0] == a) training += parseInt(train[c][1]);
	   	        	   if (training >0) {
	   	        	   		n+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(training)+'</font></td>';
   	        	   	   }
   	        	   	   else n+='<TD style="background: #FFFFFF"></td>';	
   	        	   }
   	      }
   	  		n+='</tr>';
   	  	}
   	  }
   	  n+='<TR><TD colspan="8" style="background: #FFFFFF; border:none;">&nbsp;</td> </tr>';
      n+='<TR><TD colspan="2" style="border=solid">'+uW.g_js_strings.openKnights.myknights+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var knights=0;
           var knightscity = Seed.knights['city' + Seed.cities[b][0]];
           if (knightscity != []) for (c in knightscity) if (knightscity[c]['knightId'] > 0) knights++;
        	 n+= '<TD align=right >'+knights+'</td>';	
      }
      n+='</tr><TR><TD colspan="2" >'+uW.g_js_strings.commonstr.combat+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var combat=0;
           var knightscity = Seed.knights['city' + Seed.cities[b][0]];
           if (knightscity != []) for (c in knightscity) if (knightscity[c]['combat'] > combat) 
               if (Seed.leaders['city' + Seed.cities[b][0]]['combatKnightId'] != knightscity[c]['knightId'])  combat = knightscity[c]['combat'];
        	 n+= '<TD align=right style="background: #FFFFFF">'+combat+'</td>';	
      }
      
      n+='<TR><TD colspan="8" style="background: #FFFFFF; border:none;">&nbsp;</td> </tr>';
      n+='<TR><TD colspan="2" style="border=solid">'+uW.g_js_strings.modal_barracks_trainingtab.totaltraintime+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var time=0;
           now = unixTime();
           var  unt = Seed.queue_unt['city' + Seed.cities[b][0]];
           //alert(unt.length);
           if (unt != null && unt.length > 0) time = (unt[unt.length-1][3] - now);
           if (time < 0) time=0;
           if (time < 3600) n+= '<TD align=right ><FONT COLOR=red>'+timestr(time)+'</font></td>';	
           else n+= '<TD align=right >'+timestr(time)+'</td>';	
      }
      
      
      
   	  n+='</tr></table>';
   	  t.Overv.innerHTML = n;
   	  
   	  document.getElementById('TEST').addEventListener('click', function(){
   	  		var params = uW.Object.clone(uW.g_ajaxparams);
   	    			new AjaxRequest(uW.g_ajaxpath + "/fb/e2/src/main_src.php?g=&y=0&n=nan001&l=nl_NL&messagebox=&standalone=0&res=1&iframe=1&lang=en&ts=1304248288.7067&s=250&appBar=" + uW.g_ajaxsuffix, {
   	    			    method: "POST",
   	    			    parameters: params,
   	    			    onSuccess: function (rslt) {
   	    			        var mainSrcHTMLCode = rslt.responseText;
   	    			    	var myregexp = /var seed=\{.*?\};/;
   	    			    	var match = myregexp.exec(mainSrcHTMLCode);
   	    			    	if (match != null) {
   	    			    		result = match[0];
   	    			    		result = result.substr(4);
   	    			    		var seed = eval(result);
   	  	  			    		uW.document.seed = seed;
   	  	  			    		Seed = seed;
   	  	  			    		uW.seed = seed;
   	  	  			    		document.getElementById('update').style.background ='#99FF99';
   	  	  			    		setTimeout(function(){ (document.getElementById('update').style.background ='#FFFFF'); }, 1000);
   	    			    	}
   	    			    },
   	    			    onFailure: function () {
   	    			      if (notify != null)
   	    			        notify(rslt.errorMsg);
   	    			    },
   	    			});
   	  	
   	  }, false);
   	    	
      t.displayTimer = setTimeout (t.showTroops, 1000);  
    },
	
	
  showBuilds : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    t.Overv.innerHTML =null;
    t.Overv.style.maxHeight = '700px';
    t.Overv.style.overflowY = 'scroll';	
    var wall=0;
    var blacksmith=0;
    var fletching=0;
    var geometry = 0;
    var metalalloys = 0;
    var logging = 0;
    var poisonededge = 0;

    var FieldSpace = {1:13,
    			  2:16,
    			  3:19,
    			  4:22,
    			  5:25,
    			  6:28,
    			  7:31,
    			  8:34,
    			  9:37,
    			  10:40,
    			  11:40,
    			  12:40};
    			  		   
    fertilizer = Seed.tech['tch1'];
    logging = Seed.tech['tch2'];
    stoneworking = Seed.tech['tch3'];
    mining = Seed.tech['tch4'];
    geometry = Seed.tech['tch5'];
    eagleeyes = Seed.tech['tch6'];
    poisonededge = Seed.tech['tch8'];
    metalalloys = Seed.tech['tch9'];
    featherweightpowder = Seed.tech['tch10'];
    magicalmapping = Seed.tech['tch11'];
    alloyhorseshoes = Seed.tech['tch12'];
    fletching = Seed.tech['tch13'];
    shrinkingpowder = Seed.tech['tch14'];
    healingpotions = Seed.tech['tch15'];
    giantsstrength = Seed.tech['tch16'];			  		       
    
    var m = '<DIV id=BuildsDiv style="font-size:12px"><TABLE cellpadding=5 cellspacing=0 border="1" style="border: 1px solid; border-style: none none none none;"><TR valign=top align=right>';
    m += "<TD align=left width=85 style='background-color:"+Colors.OverviewDarkRow+";'><INPUT id=showReq type=checkbox " + (t.showReq?'CHECKED ':'') +">Show requirements.</td>";
    for(i=0; i<Cities.numCities; i++) {
      m += "<TD width=79 style='background-color:"+Colors.OverviewDarkRow+"'><B>"+ Cities.cities[i].name.substring(0,11) +"</b><BR>"+ coordLink(Cities.cities[i].x, Cities.cities[i].y) +"<BR></td>";
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">building</td>';	
    for(i=0; i<Seed.cities.length; i++) {
    	city = 'city'+Seed.cities[i][0];
    	m+='<TD width=79 style="background:#FFFFFF">';
    	if (Seed.queue_con[city][0] != undefined) {
    		m+=uW.buildingcost['bdg' + Seed.queue_con[city][0][0]][0];
    		m+=' ('+Seed.queue_con[city][0][1]+')';
    		m+='<br>'+ timestr((Seed.queue_con[city][0][4] - unixTime()),true);
    	}
    	m+='</td>';	
    }
    m+='</tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">researching</td>';	
    for(i=0; i<Seed.cities.length; i++) {
    	city = 'city'+Seed.cities[i][0];
    	m+='<TD width=79 style="background:#FFFFFF">';
    	if (Seed.queue_tch[city][0] != undefined) {
    		m+=uW.techcost['tch' + Seed.queue_tch[city][0][0]][0];
    		m+=' ('+Seed.queue_tch[city][0][1]+')';
    		m+='<br>'+ timestr((Seed.queue_tch[city][0][3] - unixTime()),true);
    	}
    	m+='</td>';		
    }
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt53'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = WallSpace/2/2 - parseInt(Seed.fortifications[city]["fort53"]) - parseInt(Seed.fortifications[city]["fort55"]);
    	m+= '<TD width=79 style="background:#FFFFFF">' + Seed.fortifications[city]["fort53"];
    	if (wall >=6 && blacksmith >=6 && fletching >=5 && max > 0) m+= '<br>Left: ' + max +'</td>';
    	else if (t.showReq){
    			if (wall < 6) m+= '<br><FONT COLOR= "CC0000">Muro: ' + wall + '(6)</font>';
    			if (blacksmith < 6) m+= '<br><FONT COLOR= "CC0000">Herreria: ' + blacksmith + '(6)</font>';
    			if (fletching < 5) m+= '<br><FONT COLOR= "CC0000">Flechas: ' + fletching + '(5)</font>';
    			m+='</td>';
    		} 		
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt55'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = WallSpace/2/4 - parseInt(Seed.fortifications[city]["fort53"]) - parseInt(Seed.fortifications[city]["fort55"]);
    	m+=  '<TD width=79 style="background:#FFFFFF">' +Seed.fortifications[city]["fort55"];
    	if (wall >=8 && blacksmith >=8 && fletching >=7 && geometry>=7 && max > 0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 8) m+= '<br><FONT COLOR= "CC0000">Muro: ' + wall + '(8)</font>';
    			if (blacksmith < 8) m+= '<br><FONT COLOR= "CC0000">Herreria: ' + blacksmith + '(8)</font>';
    			if (fletching < 7) m+= '<br><FONT COLOR= "CC0000">Flechas: ' + fletching + '(7)</font>';
    			if (geometry < 7) m+= '<br><FONT COLOR= "CC0000">Geomet.: ' + geometry + '(7)</font>';
    			m+='</td>';
    	} 	
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';"> Wall defenses</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	build = (parseInt(Seed.fortifications[city]["fort53"])*2)+ (parseInt(Seed.fortifications[city]["fort55"])*4);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = WallSpace/2;
    	if (build < max) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	m+= build+'</font>';
    	m+= '/' + max +'</td>';
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt60'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = WallSpace/2/4 - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+=  '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort60"];
    	if (wall >=4 && blacksmith >=4 && poisonededge>=4 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 4) m+= '<br><FONT COLOR= "CC0000">Muro: ' + wall + '(4)</font>';
    			if (blacksmith < 4) m+= '<br><FONT COLOR= "CC0000">Herreria: ' + blacksmith + '(4)</font>';
    			if (poisonededge < 4) m+= '<br><FONT COLOR= "CC0000">P.envenenada: ' + poisonededge + '(4)</font>';
    			m+='</td>';
    	} 	
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt61'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = WallSpace/2/1 - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+= '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort61"];
    	if (wall >=1 && metalalloys >=1 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 1) m+= '<br><FONT COLOR= "CC0000">Muro: ' + wall + '(1)</font>';
    			if (metalalloys < 1) m+= '<br><FONT COLOR= "CC0000">A.Metal.: ' + metalalloys + '(1)</font>';
    			m+='</td>';
    	} 	
    }
    m+='</tr><TR valign=top align=right><TD style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt62'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = (WallSpace/2/3).toFixed(0) - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+=  '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort62"];
    	if (wall >=2 && blacksmith>=2 && logging>=2 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 2) m+= '<br><FONT COLOR= "CC0000">Muro: ' + wall + '(2)</font>';
    			if (blacksmith < 2) m+= '<br><FONT COLOR= "CC0000">Herreria: ' + blacksmith + '(2)</font>';
    			if (logging < 2) m+= '<br><FONT COLOR= "CC0000">Logg.: ' + logging + '(2)</font>';
    			m+='</td>';
    	} 	
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">Field defenses</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	build = (parseInt(Seed.fortifications[city]["fort60"])*4)+ (parseInt(Seed.fortifications[city]["fort61"])*1) + (parseInt(Seed.fortifications[city]["fort62"])*3);
    	var WallSpace = 0;
    	for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
    	max = WallSpace/2;
    	if (build < max) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	m+= build+'</font>';
    	m+= '/' + max +'</td>';
    }
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">city ??spaces</td>';
    
    for(i=0; i<Seed.cities.length; i++) {
    	var count=0;
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] >=5 && Seed.buildings[city][y][0] <19) count++;
    	}
    	if (count == 31) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	m+= count + '</font> (31)</td>';
    }
    m+='</tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">field spaces</td>';
    
    for(i=0; i<Seed.cities.length; i++) {
    	var count=0;
    	var castle=0;
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 0) castle = Seed.buildings[city][y][1];
    		if (Seed.buildings[city][y][0] >=1 && Seed.buildings[city][y][0] <=4) count++;
    	}
    	if (count == FieldSpace[castle]) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	m+= count + '</font> ('+FieldSpace[castle]+')</td>';
    }
    m+='</tr>';
    for (b=0;b<20;b++){
    	m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.buildingcost['bdg' + b][0]+'</td>';
        for (c=0;c<Seed.cities.length;c++){
        	m+='<TD style="width:79px; max-width:79px; word-wrap: break-word; background:#FFFFFF">';
        		city= 'city'+Seed.cities[c][0];
        		var count =0;
        		for (y in Seed.buildings[city]) {
        			if (Seed.buildings[city][y][0] == b) {
        				count++;
        				if (count > 1) m+=",";
        				if (Seed.buildings[city][y][1] >= 9) m+='<FONT COLOR= "669900">';
        				m+=Seed.buildings[city][y][1];
        				if (Seed.buildings[city][y][1] >= 9) m+='</font>';
        				
        			}
        		}
        		if (count == 0) {
        			m+='<FONT COLOR= "CC0000">0</font>';
        		}
        	m+='</td>';		
        }
        m+='</tr>';
    } 
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    for(i=0; i<Cities.numCities; i++) {
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">guardians</td>';
    for(i=0; i<Seed.cities.length; i++) {
     	for(g=0;g<Seed.guardian.length;g++) {
     		if (Seed.guardian[g]['cityId'] == Seed.cities[i][0] && Seed.guardian[g]['level']!=0) {
     			m += '<TD width=79 style="background:#FFFFFF">';
     			if (Seed.guardian[g]['level'] >=9) m+='<FONT COLOR= "669900">'; 
     			m+=Seed.guardian[g]['level']+"("+Seed.guardian[g]['type']+")</td>";
     			if (Seed.guardian[g]['level'] >=9) m+='</font>'; 
     		}
     		else {if (Seed.guardian[g]['cityId'] == Seed.cities[i][0] && Seed.guardian[g]['level']==0) m += '<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">0</font></td>'};
    	}
    }
    m+='</tr></table><BR></table><BR><TABLE class=ptBuilds  border=1px cellpadding=2 cellspacing=0><TR valign=top align=left>';
    for (i in uW.techcost) {
    	m+='<TD border=1px style="width:150px; background:#FFFFFF">'+uW.techcost[i][0]+'</td><TD align=center style="width:50px max-width:150px; background:#FFFFFF;">';
    	if (Seed.tech[i] >=9) m+='<FONT COLOR= "669900">';
    	if (Seed.tech[i] ==0) m+='<FONT COLOR= "CC0000">';
    	m+=Seed.tech[i];
    	if (Seed.tech[i] >=9 || Seed.tech[i] ==0) m+='</font>';
    	if (t.showReq) {
    		for(z=0; z<Seed.cities.length; z++) {
        		city = 'city'+Seed.cities[z][0];
        		for (y in Seed.buildings[city]) {
        			var farm,sawmill,quarry,mine,alchemylab,workshop,blacksmith,stable,storehouse,barracks = 0;
        			if (Seed.buildings[city][y][0] == 1 && Seed.buildings[city][y][0] > farm) farm = Seed.buildings[city][y][1]; 
        			if (Seed.buildings[city][y][0] == 2 && Seed.buildings[city][y][0] > sawmill) sawmill = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 3 && Seed.buildings[city][y][0] > quarry) quarry = Seed.buildings[city][y][1]; 
        			if (Seed.buildings[city][y][0] == 4 && Seed.buildings[city][y][0] > mine) mine = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 9) storehouse = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 11) alchemylab = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 13 && Seed.buildings[city][y][0] > barracks) barracks = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 16) workshop = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 17) stable = Seed.buildings[city][y][1];
        		}
        	}
        	m+='<FONT COLOR= "CC0000">';
    		switch (i) {
    			case '1': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (farm < Seed.tech[i]) m+='<BR>Farm '+ farm +'('+ (Seed.tech[i]+1) +')</td>';
    				break;
    			case '2': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (sawmill < Seed.tech[i]) m+='<BR>Sawmill '+ sawmill +'('+ (Seed.tech[i]) +')';
    				break;
    			case '3': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (quarry < Seed.tech[i]) m+='<BR>Quarry '+ quarry +'('+ (Seed.tech[i]) +')</td>';
    				break;
    			case '4': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (mine < Seed.tech[i]) m+='<BR>Mine '+ mine +'('+ (Seed.tech[i]) +')';
    				break;
    			case '5': 
    				if (alchemylab < 3) m+='<BR>Alchemy Lab '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (workshop < Seed.tech[i]) m+='<BR>Workshop ' + workshop +'('+ (Seed.tech[i]) +')';
    				if (stoneworking < 2) m+='<BR>Stoneworking '+ stoneworking +'(2)';
    				break;
    			case '6': 
    				if (alchemylab < 3) m+='<BR>Alchemy Lab '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;	
    			case '8': 
    				if (alchemylab < 2) m+='<BR>Alchemy Lab '+ alchemylab +'(2)';
    				if (alchemylab >= 2 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (barracks < 2) m+='<BR>Barracks '+ barracks +'(2)';
    				break;		
    			case '9': 
    				if (alchemylab < 3) m+='<BR>Alchemy Lab '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (blacksmith < Seed.tech[i]) m+='<BR>Blacksmith '+ blacksmith+'('+ (Seed.tech[i]) +')';
    				if (mining < Seed.tech[i]) m+='<BR>Mining '+ mining +'('+ (Seed.tech[i]) +')';
    				break;
    			case '10': 
    				if (alchemylab < 4) m+='<BR>Alchemy Lab '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;
    			case '11': 
    				if (alchemylab < 4) m+='<BR>Alchemy Lab '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;
    			case '12': 
    				if (alchemylab < 5) m+='<BR>Alchemy Lab '+ alchemylab +'(5)';
    				if (alchemylab >= 5 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (stable < Seed.tech[i]) m+='<BR>Stable '+ stable +'('+ (Seed.tech[i]+1) +')';
    				if (metalalloys < Seed.tech[i]) m+='<BR>Metal Alloys '+ metalalloys +'('+ (Seed.tech[i]+1) +')';
    				break;
    			case '13': 
    				if (alchemylab < 4) m+='<BR>Alchemy Lab '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (logging < 4) m+='<BR>Logging '+ logging +'(4)';
    				break;
    			case '14': 
    				if (alchemylab < 6) m+='<BR>Alchemy Lab '+ alchemylab +'(6)';
    				if (alchemylab >= 6 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (storehouse < Seed.tech[i]) m+='<BR>Storehouse '+ storehouse +'('+ (Seed.tech[i]) +')';
    				if (logging < 3) m+='<BR>Logging '+ logging+'(3)';
    				break;
    			case '15': 
    				if (alchemylab < 6) m+='<BR>Alchemy Lab '+ alchemylab +'(6)';
    				if (alchemylab >= 6 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (featherweightpowder  < 3) m+='<BR>Featherweight Powder  '+ featherweightpowder +'(3)';
    				break;
    			case '16': 
    				if (alchemylab < 5) m+='<BR>Alchemy Lab '+ alchemylab +'(5)';
    				if (alchemylab >= 5 && alchemylab < Seed.tech[i]) m+='<BR>Alchemy Lab '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (logging  < 5) m+='<BR>Logging '+ logging +'(5)';
    				if (geometry  < 2) m+='<BR>Geometry  '+ geometry +'(2)';
    				break;
    		}
    		m+='</font>';
    	}
    	m+='</td></tr>';
    }	
    m+='</table></div>';
    t.Overv.innerHTML = m;
    document.getElementById('showReq').addEventListener ('change', function (){
    	t.showReq = document.getElementById('showReq').checked;
    	t.showBuilds();
    },false);	
    t.displayTimer = setTimeout (t.showBuilds, 1000);
  },
  
  showInfo : function (){
      var t = Tabs.OverView;
      t.Overv.innerHTML = null;
      t.Overv.style.maxHeight = '700px';
      t.Overv.style.overflowY = 'scroll';
      clearTimeout (t.displayTimer);	
      
	  var u='<DIV class=ptstat>LINKS</div><DIV id=ptLinks><TABLE align=center cellpadding=1 cellspacing=0><TR>';
	  u+='<TD width="300px" ; border:none">Scripts</td><TD width="300px" ; border:none">INFORMATION SITES</td></tr>';
	  u+='<TR><TD width="300px" ; border:none"><a href="http://userscripts.org/scripts/show/103659" target="_blank">Power Tools (Koc Scripters)</a></td>';
	  u+='<TD width="300px" ; border:none"><a href="http://koctools.com/index.php?pageid=servers" target="_blank">KOCTools</a></td></tr>';
	  u+='<TR><TD width="100px" ; border:none"><a href="http://code.google.com/p/koc-power-tools/wiki/Home?tm=6" target="_blank">Power Tools WIKI</a></td>';
	  u+='<TD width="300px" ; border:none"><a href="http://koc.dunno.com/index.sjs?f=ListServers" target="_blank">KOC Mapper</a></td></tr>';
	  u+='<TR><TD width="100px" ; border:none"><a href="http://userscripts.org/scripts/show/101052" target="_blank">Power Bot (Koc Scripters)</a></td>';
	  u+='<TD width="300px" ; border:none"><a href="http://kocmon.com/" target="_blank">KoC Monitor</a></td></tr>';
	  u+='<TR><TD width="100px" ; border:none"><a href="http://code.google.com/p/koc-power-bot/wiki/Home?tm=6" target="_blank">Power Bot WIKI</a></td>';
	  u+='<TD width="300px" ; border:none"><a href="http://koc.wikia.com/wiki/" target="_blank">Koc Wikia</a></td></tr>';
	  u+='<TR><TD width="100px" ; border:none"><a href="https://addons.mozilla.org/en/firefox/addon/greasemonkey/" target="_blank">Greasemonkey</a></td><TD width="100px" ; border:none"></td>';
	  u+='<TR><TD width="100px" ; border:none"><a href="https://addons.mozilla.org/en/firefox/addon/scriptish/" target="_blank">Scriptish</a></td><TD width="100px" ; border:none"></td>';
	  u+='</tr></table></div><BR>';
	  
	  var crestreq = { 3:{1101:4, 1102:2, 1103:1},
	  				 4:{1103:4, 1104:3, 1105:1},
	  				 5:{1106:4, 1107:3, 1108:2},
	  				 6:{1109:4, 1110:3, 1111:2},
	  				 7:{1112:4, 1113:3, 1114:2}
	  				};
	  				
	  u+='<DIV class=ptstat>Crest Information</div><DIV id=ptLinks><TABLE align=center cellpadding=1 cellspacing=0><TR>';
	  for (city in crestreq){
	  		deed = 'q800' + city;
        if (Seed.quests[deed] ==1) u+='<TD width=75px style="background:#CCFFCC">';
        else  u+='<TD width=75px ">';
        u+= uW.g_js_strings.commonstr.city+' '+city+'</td>';
	  		for (crest in crestreq[city]){
	  			owned = Seed.items['i'+crest];
	  			if (Seed.quests[deed] ==1) u+='<TD 200px style="background:#CCFFCC">';
          else  u+='<TD 200px ">';
	  			if (owned == undefined) owned=0;
	  			if (owned < crestreq[city][crest]) u+='<FONT color=red>'+owned+'/'+crestreq[city][crest]+'</font> '+uW.itemlist['i'+crest]['name']+'</td>';
	  				else  u+='<FONT color=green>'+owned+'/'+crestreq[city][crest]+'</font> '+uW.itemlist['i'+crest]['name']+'</td>'; 
	  		}
	  		u+='</tr>';
	  }
	  u+='</table><BR>';
	  fortmight = {
	        u53: "4",
	        u55: "7",
	        u60: "1",
	        u61: "2",
	        u62: "3",
	      };
	      rownum = 0;
	      u += '<STYLE>.xtabH {background:#ffffe8; border:none; padding-right: 5px; padding-left: 5px; margin-left:10px; }\
	              .xtabHL { background:#ffffe8; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left:5px; margin-left:10px; }\
	              .xtabL { background:none; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left: 5px; margin-left:10px; }\
	              .xtabLine { padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none }</style>\
	          <DIV style="overflow-y:auto; overflow-x:hidden"><DIV class=ptstat>INFORMATION FOR THE TROOPS</div><TABLE align=center cellpadding=1 cellspacing=0>\
	          <TR align=center><TD class=xtab></td><TD class=xtabHL colspan=5><B>COST TO BUILD</b></td><TD class=xtabHL colspan=7><B>STATS</b></td><TD class=xtabHL><B>EATS</b></td></tr>\
	          <TR valign=bottom align=right><TD class=xtab></td><TD class=xtabHL>Food</td><TD class=xtabH>Wood</td><TD class=xtabH>Stone</td>\
	          <TD class=xtabH>Ore</td><TD class=xtabH>Pop</td><TD class=xtabHL>Might</td><TD class=xtabH>Life</td><TD class=xtabH>Attack</td><TD class=xtabH>Def</td><TD class=xtabH>Speed</td><TD class=xtabH>Range</td><TD class=xtabH>Load</td>\
	          <TD class=xtabHL>Food</td></tr>\
	          <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=14></td></tr>';
	      for (ui=1; ui<13; ui++){
	        if (++rownum % 2)
	          rsty = '';
	        else
	          rsty = ' style="background: #e8e8e8" ';
	        cost = unsafeWindow.unitcost['unt'+ui];     //  NAME, Food, Wood, Stone, Ore, ?, IdlePop, Time
	        stats = uW.unitstats['unt'+ui];   //  Life, Attack, Defense, Speed, Range, Load
	        food = uW.unitupkeeps[ui];
	        might = uW.unitmight['unt'+ui];
	        u += '<TR '+ rsty +'align=right><TD class=xtab align=left><B>'+ cost[0].substr(0,16) +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
	            <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
	            <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
	            <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
	  
	      }
	      u += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr>';
	      for (k in uW.fortcost){
	        if (++rownum % 2)
	          rsty = '';
	        else
	          rsty = ' style="background: #e8e8e8" ';
	        cost = unsafeWindow.fortcost[k];     //  NAME, Food, Wood, Stone, Ore, ?, IdlePop, Time
	        fi = k.substring(3);
	        stats = unsafeWindow.fortstats['unt'+fi];   //  Life, Attack, Defense, Speed, Range, Load
	        food = 0;
	        might = fortmight['u'+fi];
	        name = cost[0].replace ('Defensive','');
	        name = name.replace ('Wall-Mounted','');
	        u+= '<TR '+ rsty +'align=right><TD align=left class=xtab><B>'+ name +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
	            <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
	            <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
	            <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
	      }
	      u += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr>';
	      u += '</table></div><BR>';
               //Troop Train Estimates
			function _displayrow (name, row){
                    var tot=0;
      			style = ((rownum++ % 2)?'':' style = "background: #e8e8e8"');
      			u += '<TR' + style + '><TD align=right><B>' + name + '</B></td>';
      			for (i=0; i<row.length; i++) {
      				u += ((row[i]==0)?'<td align=right><SPAN class=boldRed>0</SPAN></td>':'<td align=right>'+addCommas(parseInt(row[i]))+'</td>');
      				tot+=parseInt(row[i]);
      				}
      			u += '<td align=right>'+addCommas(tot)+'</td></tr>';
      		}
		  u += '<DIV class=ptstat>ESTIMATED TIME TRAINING TROOPS</div><TABLE align=center cellpadding=1 cellspacing=0><TR align=right><TD></td>';
	      infoRows = [];
      		for (r=0; r<24; r++)
      			infoRows[r] = [];
      		for(i=0; i<Cities.numCities; i++) {
      			cityID = 'city'+ Cities.cities[i].id;
      			u += "<TD align=center valign=bottom width=60px><B>" + Cities.cities[i].name.substr(0,10)  + "</B></TD>";
      			// getTroopDefTrainEstimates(cityID);
      			infoRows[0][i] = Cities.cities[i].numCottages;
      			infoRows[1][i] = Cities.cities[i].numBarracks;
      			infoRows[2][i] = Cities.cities[i].foremanBasePoliticsScore;
      			infoRows[3][i] = Cities.cities[i].marshallCombatScore;
      			infoRows[5][i] = Cities.cities[i].stableLevel;
      			infoRows[6][i] = Cities.cities[i].workshopLevel;
      			for (var j=1; j<13; j++)
      				infoRows[j+6][i] = ((Cities.cities[i]['Troop'+j+'Time'] > 0)?(3600 / Cities.cities[i]['Troop'+j+'Time']):0);
      			infoRows[19][i] = Cities.cities[i]['Def53Time'];
      			if (infoRows[19][i] > 0)
      				infoRows[19][i] = 3600 / infoRows[19][i];
      			infoRows[20][i] = Cities.cities[i]['Def55Time'];
      			if (infoRows[20][i] > 0)
      				infoRows[20][i] = 3600 / infoRows[20][i];
      			infoRows[21][i] = Cities.cities[i]['Def60Time'];
      			if (infoRows[21][i] > 0)
      				infoRows[21][i] = 3600 / infoRows[21][i];
      			infoRows[22][i] = Cities.cities[i]['Def61Time'];
      			if (infoRows[22][i] > 0)
      				infoRows[22][i] = 3600 / infoRows[22][i];
      			infoRows[23][i] = Cities.cities[i]['Def62Time'];
      			if (infoRows[23][i] > 0)
      				infoRows[23][i] = 3600 / infoRows[23][i];
      		}
      		u += "<td align=center valign=bottom width=60px><b>Total</td></tr>";
      		 var rownum = 0;
      		_displayrow ("Cottage", infoRows[0]);
      		_displayrow ("Barracks", infoRows[1]);
      		_displayrow (" Foreman Policy", infoRows[2]);
      		_displayrow (" Marshal Combat ", infoRows[3]);
      		_displayrow ("Stable Level", infoRows[5]);
      		_displayrow ("Workshop Level", infoRows[6]);
      		u += "<TR><TD></TD><TD nowrap align=center colspan="+(Cities.numCities)+"><B>Output per hour of troops</B></TD></TR>";
      		_displayrow ("Supply Troop", infoRows[7]);
      		_displayrow ("Militiaman", infoRows[8]);
      		_displayrow ("Scout", infoRows[9]);
      		_displayrow ("Pikeman", infoRows[10]);
      		_displayrow ("Swordsman", infoRows[11]);
      		_displayrow ("Archer", infoRows[12]);
      		_displayrow ("Cavalry", infoRows[13]);
      		_displayrow ("Heavey Cavalry", infoRows[14]);
      		_displayrow ("Wagons", infoRows[15]);
      		_displayrow ("Ballista", infoRows[16]);
      		_displayrow ("Battering Ram", infoRows[17]);
      		_displayrow ("Catapult", infoRows[18]);
      		u += "<TR><TD></TD><TD nowrap align=center colspan="+(Cities.numCities)+"><B>Output per hour of wall defenses</B></TD></TR>";
      		_displayrow ("Crossbow", infoRows[19]);
      		_displayrow ("Trebuchet", infoRows[20]);
      		_displayrow ("Trap", infoRows[21]);
      		_displayrow ("Caltrop", infoRows[22]);
      		_displayrow ("Spike Barrier", infoRows[23]);
		  u += '</tr></table>';
             
	      
	      u += '<DIV class=ptstat>additional information</div><TABLE><TD width="200px" style="background-color:#FFFFFF; border:none">Dedicated to my love with all my heart</td>';
	      u += '<TD style="background-color:#FFFFFF; border:none"><INPUT id=ptButDebug type=submit name="SEED" value="DEBUG"></td></table></div>';
      
      t.Overv.innerHTML = u;   
      document.getElementById('ptButDebug').addEventListener('click', function (){debugWin.doit()}, false);  
  },      

  paintOld : function (){
    var rownum = 0;
    var t = Tabs.OverView;
    
    clearTimeout (Tabs.OverView.displayTimer);
    t.Overv.innerHTML = null;
    t.Overv.style.maxHeight = '700px';
    t.Overv.style.overflowY = 'scroll';

    function _row (name, row, noTotal){
      var t = Tabs.OverView;
      if (rownum++ % 2)
        style = '';
      else
        style = ' style = "background: #e8e8e8"';
      var tot = 0;
      var m = [];
      m.push ('<TR style="background: #fff" align=right');
      m.push (style);
      m.push ('><TD');
      m.push (style);
      m.push ('><B>');
      m.push (name);
      m.push (' &nbsp; </td>');
      if (noTotal){
        m.push ('<TD');
        m.push (style);
        m.push ('> &nbsp;</td>');
      } else {
        for (i=0; i<row.length; i++)
          tot += row[i];
        m.push ('<TD style="background: #ffc">');
      if (TEST_WIDE)
          m.push ('X,');        
        m.push (addCommas(tot));
        m.push ('</td>');
      }
      for (i=0; i<row.length; i++){
        m.push ('<TD');
        m.push (style);
        m.push ('>');
      if (TEST_WIDE)
         m.push ('X,');        
        m.push (addCommas(row[i]));
        m.push ('</td>');
      }
      m.push ('</tr>');
      return m.join('');
    }
    
    //DebugTimer.start(); 
    try {
      if (Options.includeMarching)
        march = getMarchInfo ();
      if (Options.includeTrainingExt)
        train = getTrainInfo ();

      dt = new Date ();
      dt.setTime (Seed.player.datejoinUnixTime * 1000);
              
      str = "<DIV id=overMainDiv style='font-size:"+ Options.overviewFontSize +"px'><TABLE class=ptTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right><TD width=65></td><TD width=88 style='background: #ffc'><B>TOTAL</b></td>";
      for(i=0; i<Cities.numCities; i++) {
        str += "<TD width=81><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ unsafeWindow.provincenames['p'+ Cities.cities[i].provId] +"</td>";
      }
      if (Options.includeMarching)
        str += '<TD width=81><B>Marching</b></td>';
      if (Options.includeTrainingExt)
        str += '<TD width=81><B>Entrenando</b></td>';
      str += "</tr>";
  
    str += '<TR valign=top align=right><TD></td><TD style=\'background: #ffc\'></td>';
    for(i=0; i<Cities.numCities; i++){
      cityID = 'city'+Cities.cities[i].id;
      Gate = parseInt(Seed.citystats[cityID].gate);
    if(Gate == 0)
      str += '<TD>Refugiadas</td>';
    else
      str += '<TD><SPAN class=boldRed>Defending</span></td>';
    }

      rows = [];
      rows[0] = [];
      for(i=0; i<Cities.numCities; i++) {
        cityID = 'city'+ Cities.cities[i].id;
        rows[0][i] = parseInt(Seed.citystats[cityID].gold[0]);
      }
      for (r=1; r<5; r++){
        rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
          rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0] / 3600);
        }
      }
	  rows[5] = [];
	  for(i=0; i<Cities.numCities; i++) { //Aetherstone
        cityID = 'city'+ Cities.cities[i].id;
        rows[5][i] = parseInt(Seed.resources[cityID]['rec5'][0]);
      }
  
      if (Options.includeMarching){
        for (var i=0; i<5; i++)
          rows[i][Cities.numCities] = march.resources[i]; //Aetherstone does not show up in march info
      }
      str += _row ('Gold', rows[0]);
      str += _row ('Food', rows[1]);
      str += _row ('Wood', rows[2]);
      str += _row ('Stone', rows[3]);
      str += _row ('Ore', rows[4]);
      str += _row ('Aetherstone', rows[5]);
      str += '<TR><TD colspan=11><BR></td></tr>';
      for (r=1; r<13; r++){
        rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
          rows[r][i] = parseInt(Seed.units[cityID]['unt'+r]);
        }
      }
	  
	  var colnum = Cities.numCities;
      if (Options.includeMarching){
        for (var i=0; i<13; i++){
          rows[i][colnum] = march.marchUnits[i];
		}
		colnum++;
      }
	  if(Options.includeTrainingExt){
		for (var i=0; i<13; i++){
		  rows[i][colnum] = train.trainUnts[i];
		}
	  }
      if (Options.includeTraining){
        var q = Seed.queue_unt;
        for(i=0; i<Cities.numCities; i++) {
          q = Seed.queue_unt['city'+ Cities.cities[i].id];
          if (q && q.length>0){
            for (qi=0; qi<q.length; qi++)
              rows[q[qi][0]][i] += parseInt(q[qi][1]);
          }    
        }
      }
      rownum = 0;
      str += _row ('Supply Troops', rows[1]);
      str += _row ('Militia', rows[2]);
      str += _row ('Scout', rows[3]);
      str += _row ('Pike', rows[4]);
      str += _row ('Sword', rows[5]);
      str += _row ('Archer', rows[6]);
      str += _row ('Cav', rows[7]);
      str += _row ('Heavey', rows[8]);
      str += _row ('Wagon', rows[9]);
      str += _row ('Ball', rows[10]);
      str += _row ('Ram', rows[11]);
      str += _row ('Cat', rows[12]);
      str += '<TR><TD colspan=11><BR></td></tr>';
      
      row = [];
      for(i=0; i<Cities.numCities; i++) {
        var rp = getResourceProduction (Cities.cities[i].id);
        var usage = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
        row[i] = rp[1] - usage;
      }
     
      str += _row ('Food +/-', row, true);
      
      for(i=0; i<Cities.numCities; i++) {
        if (row[i] >= 0)
          row[i] = '----';
        else {
          var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-row[i]) * 3600;
          if (timeLeft > 86313600)
            row[i] = '----';
          else {
            if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600))
              row[i] = '<SPAN class=whiteOnRed>'+ timestrShort(timeLeft) +'</span>';
            else
              row[i] = timestrShort(timeLeft);
          }
        }
      }    
      str += _row ('Cons.Food', row, true);
      str += '<TR><TD><BR></td></tr>';
      
      row = [];
      for(i=0; i<Cities.numCities; i++) {
        var totWilds = 0;
        dat = Seed.wilderness['city'+ Cities.cities[i].id];
        if (dat!=null && matTypeof(dat)=='object')
          for (k in dat)
            ++totWilds;
        var castle = parseInt(Seed.buildings['city'+ Cities.cities[i].id].pos0[1]);
       if(castle == 11) castle = 12;
       else if(castle == 12) castle = 14;
        if (totWilds < castle)
          row[i] = '<SPAN class=boldRed><B>'+ totWilds +'/'+ castle +'</b></span>';
        else
          row[i] = totWilds +'/'+ castle;
      }
      str += _row ('Wild', row, true);
  
      row = [];
      for(i=0; i<Cities.numCities; i++) {
        totKnights = 0;
        dat = Seed.knights['city'+ Cities.cities[i].id];
        for (k in dat)
          ++totKnights;
        row[i] = totKnights;
      }
      str += _row ('Knights', row, true);
  
      var now = unixTime();
      var row = [];
      for(i=0; i<Cities.numCities; i++) {
        var totTime = 0;
        var q = Seed.queue_unt['city'+Cities.cities[i].id]; 
        if (q!=null && q.length>0)
          totTime = q[q.length-1][3] - now;
        if (totTime < 0)
          totTime = 0;
        if (totTime < 3600)
          row[i] = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
        else
          row[i] = timestr(totTime);
      }
      str += _row ('Entre.tropas', row, true);
      
      var row = [];
      for(i=0; i<Cities.numCities; i++) {
        var wall = {};
        getWallInfo (Cities.cities[i].id, wall);
        var totTime = 0;
        var q = Seed.queue_fort['city'+Cities.cities[i].id]; 
        if (q!=null && q.length>0)
          totTime = q[q.length-1][3] - now;
        if (totTime < 0)
          totTime = 0;
        if (totTime<1 && (wall.wallSpaceUsed < wall.wallSpace-4 || wall.fieldSpaceUsed < wall.fieldSpace-4))
          row[i] = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
        else
          row[i] = timestr(totTime);
      }    
      str += _row ('Entre.Defense', row, true);
      str += '<TR><TD class=xtab></td><TD class=xtab colspan=4><BR><INPUT type=CHECKBOX id=idCheck'+ (Options.includeMarching?' CHECKED':'') +'>include Troops/Resources in place</td></tr>';
      str += '<TR><TD class=xtab></td><TD class=xtab colspan=4><INPUT type=CHECKBOX id=ptoverIncTrain'+ (Options.includeTraining?' CHECKED':'') +'>Include training troops in cities</td></tr>';
      str += '<TR><TD class=xtab></td><TD class=xtab colspan=4><INPUT type=CHECKBOX id=ptoverIncTrainExt'+ (Options.includeTrainingExt?' CHECKED':'') +'>Include total troop training</td></tr>';
      str += '<TR><TD class=xtab></td><TD class=xtab colspan=4><INPUT type=CHECKBOX id=ptOverOver'+ (Options.overviewAllowOverflow?' CHECKED':'') +'>Allow Overflow width \
         &nbsp; &nbsp; FONT SIZE: '+ htmlSelector ({9:9, 10:10, 11:11, 12:12}, Options.overviewFontSize, 'id=ptoverfont') +'</td></tr><BR>';
      str += "</table></div>";
      str += 'PowerKoc Version:' + Version;
      t.Overv.innerHTML = str;
      document.getElementById('idCheck').addEventListener('click', e_clickEnableMarch, false);
      document.getElementById('ptoverIncTrain').addEventListener('click', e_clickEnableTraining, false);
      document.getElementById('ptoverIncTrainExt').addEventListener('click', e_clickEnableTrainingExt, false);
      document.getElementById('ptOverOver').addEventListener('click', e_allowWidthOverflow, false);
      document.getElementById('ptoverfont').addEventListener('change', e_fontSize, false);
    //DebugTimer.display ('Draw Overview');    
    } catch (e){
      t.Overv.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }   
    t.displayTimer = setTimeout (t.paintOld, 5000);	

    function e_clickEnableMarch (){
      var t = Tabs.OverView;
      Options.includeMarching = document.getElementById('idCheck').checked;
      t.paintOld ();
    }
    function e_clickEnableTraining (){
      var t = Tabs.OverView;
      Options.includeTraining = document.getElementById('ptoverIncTrain').checked;
      t.paintOld ();
    }
    function e_clickEnableTrainingExt (){
      var t = Tabs.OverView;
      Options.includeTrainingExt = document.getElementById('ptoverIncTrainExt').checked;
      t.paintOld ();
    }

    function e_fontSize(evt){
      document.getElementById('ptOverOutput').style.fontSize = evt.target.value +'px'; 
      Options.overviewFontSize = evt.target.value;
      t.paintOld ();
    }

    function e_allowWidthOverflow (evt){
      var t = Tabs.OverView;
      var tf = document.getElementById('ptOverOver').checked;
      Options.overviewAllowOverflow = tf;
      if (tf)
        t.Overv.style.overflowX = 'visible';
      else
        t.Overv.style.overflowX = 'auto';
      t.paintOld ();
    }
  },
};


/*************** March Tab **********/
Tabs.Attaque = {
 cont : null,
 displayTimer : null,
 tabLabel : 'Mutli attack',
 tabOrder : 12,
 state : null,
 curTabBut : null,
 curTabName : null,
 BOAttackTimer: null,
 sourceCity : {},
 destinationCity : {},
 rows : [],
 iused : new Array(),
 init : function (div){
   var t = Tabs.Attaque;
   t.cont = div;
   t.state = null;
   clearTimeout (t.displayTimer);
 },
  getContent : function (){
    var t = Tabs.Attaque;
    return t.cont;
  },
  hide : function (){
    var t = Tabs.Attaque;
    t.state = null;
    clearTimeout (t.displayTimer);
  },
  show : function (){  
    var t = Tabs.Attaque;
    var rownum = 0;
    var ModelCity = {};
    if (t.state == null) {  
         m = "<DIV class=ptstat><b>FAST SPEED TOOL</b></div>";
         m +="<div id='statpourRAA'></div>";       
         m += "<TABLE width=600 class=ptTab border=0 align=center>\
           <tr><td colspan=4 align=center><input type=button id=REEaction value='Scout'>&nbsp;<input type=button id=RAAaction value='attack'>&nbsp<input type=button id=RARaction value='Reasign'>&nbsp;<input type=button id=RENaction value='reinforcing'>&nbsp;<input type=button id=RENBaction value='Reinforce and Max. food'></td></tr><tr align=center valign=top><td width=130><b><u>From</b></u><br><span id=RAAsrcRptspeedcity></span></td>\
           <td><b><u>Destination</b></u><br>X:<input type=text id=RAAtypetrpx size=3>&nbsp;Y:<input type=text id=RAAtypetrpy size=3><br><a href='javascript:void(0);' id='BOchargelistelieux'>View Members</a> : <select id='listeFavori'></select></td>\
           <td><b><u>distance</u></b><br><span id='BOEstimationD'>&nbsp;</span><td><b><u>nearby city</u></b><br><span id=BOVilleProche></span>\
           </tr><tr align=center valign=top>\
           <td colspan=4 align=left><table border=0 bordercolor=black cellspacing=0 cellpadding=0 width=100% style='text-align:center'><tr><td rowspan=13><div id=RAAstatsource></div></td><td colspan=2><a href='javascript:void(0)' id=BO_RAZ_Units title='Clear' >troops selected</a></td><td>Attack time</td><td>Booster time</td></tr>";
            for (r=1; r<13; r++){
   	     m += '<tr><td align=right><img height=20 title="'+unsafeWindow.unitcost['unt'+r][0]+'" src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+r+'_30_s34.jpg></td><td align=left><input style="border:1px solid black;height:16px;font-size:11px;" id="RAAnbunit'+r+'" type=text size=7 value="0" ></td><td><span id="BOEstimationTT'+r+'">&nbsp;</span></td><td><span id="BOEstimationTZ'+r+'">&nbsp;</span></td></tr>';
      	}
      	var itemlist=[55,57,931,932];
	var BOitems="";
	for(var i=0;i<itemlist.length;i++){
		 BOitems += "<img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/30/"+itemlist[i]+".jpg' /><input type=checkbox id='BOitem_"+itemlist[i]+"'><span id='BOitemSpan_"+itemlist[i]+"'>" + unsafeWindow.ksoItems[itemlist[i]].count + "</span>&nbsp;";
        }
        m += "</table></td></tr>\
              <tr><td colspan=4>knight : <SELECT id='RAApiKnight' type=list></select> <br>"+BOitems+"</td></tr></table>\
              <DIV class=ptstat>Save settings of troops :</div><TABLE><tr><td colspan=2><select id=BO_AT_Fav></select><input type=button value='reset' id=BO_AT_Fav_Sup><input type=button value='reset all' id=BO_AT_Fav_RESET></td><td colspan=2>new : <input type=type id=BO_AT_Fav_Nom size=10 maxlength=12>&nbsp;<input type=button value='Save troops' id=BO_AT_Fav_ajou>\
              <tr><td colspan=4><div id=ptRAAStatus style='overflow-y:auto; max-height:50px; height: 50px;'></div></td></tr></table>\
              <DIV class=ptstat>Auto Attack</div><table></tr><tr><td><input type=button id='BOActiveAttack' value='ON : OFF' ></td><td colspan=3><span id='BOCompAttack'></span></tr>\
              <tr><td><b>Check in:</b> <input type=text size=7 id='BOHorloge' value='" + Options.AttackHorloge + "'></td><td><input type=button value='save' id='BOSaveAttack'></td><td><input type=button value='Editar' id='BOEditAttack' disabled></td></tr>\
              <tr><td colspan=4><span id='BOAttackProg'></span></td></tr></table>";
        t.cont.innerHTML = m; 
        t.statpourRAA = ById ('statpourRAA');
        //Gestion des favoris  
        t.Favoris = ById ('BO_AT_Fav');
	function metajourfavori() {
	       t.Favoris.innerHTML="<option value=''>...</option>";
	       var lisf = Options.AttackFav;
	       for (var m in lisf) {
	         var lis = lisf[m];
	          t.Favoris.innerHTML+="<option value='"+m+"'>"+lis[0]+"</option>";
      	       }  
	}
       ById("BO_AT_Fav_RESET").addEventListener ('click', function() {
		 Options.AttackFav={};
		 saveOptions(); 
         metajourfavori();
       }, false); 
       ById("BO_AT_Fav_Sup").addEventListener ('click', function() {
       numfav=ById("BO_AT_Fav").value;
       if (numfav!="") {
        Options.AttackFav[numfav]={};
        delete Options.AttackFav[numfav];
        //Options.AttackFav=unset(Options.AttackFav, numfav);
        saveOptions(); 
        metajourfavori();
       }
       }, false); 
 	  ById("BO_RAZ_Units").addEventListener ('click', function() {
  	for (r=1; r<13; r++) ById("RAAnbunit"+r).value=0; 
 	}, false); 
       ById("BO_AT_Fav_ajou").addEventListener ('click', function() {
        if (ById("BO_AT_Fav_Nom").value=="") {
         alert("Please fill in a name!");
         return;
        }
        var a =ById("BO_AT_Fav_Nom").value;
        Options.AttackFav[a]={};
        var lisf = Options.AttackFav[a];
        lisf[0]=ById("BO_AT_Fav_Nom").value;
        for (r=1; r<13; r++) lisf[r]=ById("RAAnbunit"+r).value;
        ById("BO_AT_Fav_Nom").value="";
        saveOptions(); 
	metajourfavori();
       }, false); 
       ById("BO_AT_Fav").addEventListener ('change', function() {
         numfav=ById("BO_AT_Fav").value;
         if (numfav=="") {
          for (r=1; r<13; r++) ById("RAAnbunit"+r).value=0; 
         }else {
          var lisf = Options.AttackFav[numfav];
          for (var m in lisf) {
           if(m>0)
	    if (ById("RAAnbunit"+m)) ById("RAAnbunit"+m).value=lisf[m];
	  }
         }
       }, false); 
       // Fin gestion des favoris
       ById("BOitem_55").addEventListener ('click', function() {
        ById("BOitem_57").checked=false;
        t.estimerRes();
       }, false);  
       ById("BOitem_57").addEventListener ('click', function() {
              ById("BOitem_55").checked=false;
              t.estimerRes();
       }, false);
        t.statutRAA = ById ('ptRAAStatus');
        t.destinationCityx = ById ('RAAtypetrpx');
        t.destinationCityy = ById ('RAAtypetrpy');
        t.destinationCityx.value = Options.Xrenfort;
        t.destinationCityy.value = Options.Yrenfort;
        if (ById ('maparea_map').style.display!="none") {
         t.destinationCityx.value = ById ('mapXCoor').value;
         t.destinationCityy.value = ById ('mapYCoor').value;
        }
        t.listeFavoris = ById ('listeFavori');
        t.listeFavoris.addEventListener ('change', t.SelectFavoris, false);
        t.chargelistelieux = ById ('BOchargelistelieux');
        t.chargelistelieux.addEventListener ('click', t.chercherFavoris, false);
        t.actionREN = ById ('RENaction');
        t.actionRENB = ById ('RENBaction');
        t.actionREE = ById ('REEaction');
        t.actionRAA = ById ('RAAaction');
        t.actionRAR = ById ('RARaction');

  	t.actionREN.addEventListener ('click', function () { t.clickATTAQUEDo(2,0); }, false);
        t.actionRAA.addEventListener ('click',  function () { t.clickATTAQUEDo(4,0); }, false);
        t.actionRAR.addEventListener ('click',  function () { t.clickATTAQUEDo(5,0); }, false);
        t.actionRENB.addEventListener ('click',  function () { t.clickATTAQUEDo(2,1); }, false);
        t.actionREE.addEventListener ('click',  function () { t.clickATTAQUEDo(3,0); }, false);
        t.destinationCityx.addEventListener ('change', function () { t.estimerRes(); }, false);
        t.destinationCityy.addEventListener ('change', function () { t.estimerRes(); }, false);       
        var dcp0 = new CdispCityPicker ('ptRAA0', ById('RAAsrcRptspeedcity'), false, t.clickRAACitySourceSelect, Cities.byID[unsafeWindow.currentcityid].idx);
        t.state = 1;
        t.estimerRes();
        t.BOAttackProg = ById ('BOAttackProg');
        t.BOHorloge = ById ('BOHorloge');
        t.BOSaveAttack = ById ('BOSaveAttack');
        t.BOEditAttack = ById ('BOEditAttack');
        t.BOCompAttack = ById ('BOCompAttack');
        t.BOActiveAttack  = ById ('BOActiveAttack');
        t.BOActiveAttack.addEventListener ('click', t.AutoattackOnOff, false);
        
        t.BOSaveAttack.addEventListener ('click', function () {
        
          var itemlist=[55,57,931,932];
	  for(var i=0;i<itemlist.length;i++){
	        ById('BOitemSpan_'+itemlist[i]).checked=false;
          }
        
         t.enregistreAttack();
        
        }, false);
        if (Options.AttackCibleX!=0 && Options.AttackCibleY!=0) {
         t.BOEditAttack.disabled=false;
        }
        t.BOEditAttack.addEventListener ('click', function () { 
          t.destinationCityx.value = Options.AttackCibleX;
          t.destinationCityy.value = Options.AttackCibleY;
          ById("RAApiKnight").value=Options.AttackKnight;
          nHtml.Click(ById("ptRAA0_"+Cities.byID[Options.AttackFromCity].idx)); 
          for (r=1; r<13; r++) {
	      ById("RAAnbunit"+r).value=Options.AttackUnits[r-1];
          }
        }, false);
        
        metajourfavori();
        if (Options.AttackOnOff) {
          t.BOActiveAttack.value='ENABLED : ON';
    	  t.activeAttack();
        }
       }

    },
    AutoattackOnOff:function() {
     // click click sur le bouton Activer le compte   rebour !
     var t = Tabs.Attaque;
     t.BOCompAttack.innerHTML='';
     clearTimeout (t.BOAttackTimer);
     if (t.BOActiveAttack.value=='ENABLED : OFF') {
    	t.BOActiveAttack.value='ENABLED : ON';
    	     Options.AttackOnOff = true;
    	     saveOptions();  
    	     t.activeAttack();
    	     
    	    } else {
    	     Options.AttackOnOff = false;
    	     saveOptions();  
    	     t.BOActiveAttack.value='ENABLED : OFF';   
    }   
    },
    activeAttack:function() {
     var t = Tabs.Attaque;
     clearTimeout (t.BOAttackTimer);
     if (Options.AttackGoHorloge) {
       var depart=new Date()
       depart.setTime(Options.AttackGoHorloge);
       var now = unixTime()*1000;
       if (now >= Options.AttackGoHorloge) {
	t.BOCompAttack.innerHTML='<center><font color=red>LAUNCH ATTACK MADE</font></center>';
	t.destinationCityx.value = Options.AttackCibleX;
	t.destinationCityy.value = Options.AttackCibleY;
	ById("RAApiKnight").value=Options.AttackKnight;
	nHtml.Click(ById("ptRAA0_"+Cities.byID[Options.AttackFromCity].idx));
	for (r=1; r<13; r++) {
	   ById("RAAnbunit"+r).value=Options.AttackUnits[r-1];
          }
      t.clickATTAQUEDo(4,0);
      clearTimeout (t.BOAttackTimer);
      Options.AttackGoHorloge=null;
      saveOptions();  
     }
     if (now > depart.getTime()) {
         t.BOCompAttack.innerHTML='<center><font color=red>IMPOSIBLE</font></center>';
         clearTimeout (t.BOAttackTimer);
       	 Options.AttackGoHorloge=null;
         saveOptions();  
         return false;
     }
       
     t.BOAttackTimer=setTimeout(function(){
        var depart=new Date();
	depart.setTime(Options.AttackGoHorloge);
        var now = unixTime()*1000;
        var tempsrestant = depart.getTime() - now;
        t.BOCompAttack.innerHTML='<center><font color=red><b>IN ATTACK '+timestr(tempsrestant/1000)+'</b></font></center>';
        t.activeAttack();
      },1000);
     }
    
    },
    enregistreAttack : function() {
     var t = Tabs.Attaque; 
     if (t.BOHorloge.value.match("^[0-9]{2}:[0-9]{2}:[0-9]{2}$")) {
       var horloge = t.BOHorloge.value;
       Options.AttackHorloge = horloge;
       
       var ndate=new Date();
       ndate.setHours(horloge.substr(0,2));
       ndate.setMinutes(horloge.substr(3,2));
       ndate.setSeconds(0);
       var atunits=new Array();
       for (r=1; r<13; r++) {
          atunits.push(parseInt(ById("RAAnbunit"+r).value));
       }
       Options.AttackUnits = atunits;
       Options.AttackFromCity = t.sourceCity.id;
       Options.AttackKnight = ById("RAApiKnight").value;
       Options.AttackCibleX = t.destinationCityx.value;
       Options.AttackCibleY = t.destinationCityy.value;
       
       var x1 = parseInt(t.sourceCity.x);
       var x2 = parseInt(t.destinationCityx.value);
       var y1 = parseInt(t.sourceCity.y);
       var y2 = parseInt(t.destinationCityy.value);
       var dist = distance (x1, y1, x2, y2);  
       var tempplusgrand=0;
       for (r=1; r<13; r++){
         if (parseInt(ById("RAAnbunit"+r).value)>0) {
               var m = estETA(dist, r, t.sourceCity.id);
               if (tempplusgrand<m.ETA) tempplusgrand=m.ETA;   
         }
       }
       var departtime=ndate.getTime() - (tempplusgrand*1000);
       var depart=new Date()
       depart.setTime(departtime);
       
       var now = unixTime()*1000;
       if (now > depart.getTime()) {
        t.BOAttackProg.innerHTML = "Undeliverable !";
        return false;
       }
       Options.AttackGoHorloge =  depart.getTime();
       saveOptions ();
       t.BOAttackProg.innerHTML = "attack on " + Options.AttackCibleX + ","+ Options.AttackCibleY +" defensive";
       t.BOEditAttack.disabled=false;
     } else {
      t.BOAttackProg.innerHTML = "Wrong time format.";
     }     
    
    },
    clickATTAQUEDo: function(typemarche, bouffe) {
      var t = Tabs.Attaque;  
      var totalunit=0;
      if (typemarche==3 && ById("RAAnbunit3").value==0) ById("RAAnbunit3").value=1;
      for (r=1; r<13; r++){
         if (typemarche==3 && r!=3) {
          ById("RAAnbunit"+r).value=0;
         }
          if (parseInt(ById("RAAnbunit"+r).value) > parseInt(ById("RAAdestunit"+r).value)) {
            ById("RAAnbunit"+r).style.backgroundColor="red";
            return false;
          }
          totalunit=totalunit+parseInt(ById("RAAnbunit"+r).value);
          ById("RAAnbunit"+r).style.backgroundColor="";
      }
      var errMsg = "";
      if (isNaN (t.destinationCityx.value) ||t.destinationCityx.value<0 || t.destinationCityx.value>749)
            errMsg = "X coordinates must be between 0 and 749<BR>"; 
      if (isNaN (t.destinationCityy.value) || t.destinationCityy.value<0 || t.destinationCityy.value>749)
       errMsg += "Y coordinates must be between 0 and 749<br>";
      
      if (ById("RAApiKnight").value==0 && typemarche==4) {
       errMsg += "Knight unselected!<BR>"; 
      }
      
      if (errMsg != "") {
           t.statutRAA.innerHTML = "<FONT COLOR=#550000>"+ errMsg +"</font>";
           return;
      }
      
      var x=t.destinationCityx.value;
      var y=t.destinationCityy.value;
      // On sauvegardes les coordonnes en cas de F5
      t.SaveCoordsOptions(x,y);
      
      
      // Les objets pour l'attaque !
      var e=1;
      var f=unsafeWindow.unixtime();
      if(Seed.playerEffects.aurasExpire){
      if(Seed.playerEffects.aurasExpire>f){e=1.15}}
      if(Seed.playerEffects.auras2Expire){if(Seed.playerEffects.auras2Expire>f){e=1.3}}

     var l_elem=ById("BOitem_931");
     if(l_elem&&l_elem.checked&&parseInt(Seed.items["i931"])>0){
       e+=0.25;
      
     }
     var l_elem=ById("BOitem_932");
     if(l_elem&&l_elem.checked&&parseInt(Seed.items["i932"])>0){
       e+=0.5;
     }
       
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      
      if (totalunit==0) {
         t.statutRAA.innerHTML = '<FONT COLOR=#550000>There are no troops available!</font>';
           return;
      }
      var niveauPointRall=parseInt(getCityBuilding (t.sourceCity.id, 12).maxLevel); // 12=Point de ralliement
         var maxtroupe=parseInt(niveauPointRall*10000*e);
         if (niveauPointRall==11) maxtroupe=parseInt(150000*e);
         if (niveauPointRall==12) maxtroupe=parseInt(200000*e);
      if (totalunit>maxtroupe) {
       t.statutRAA.innerHTML = '<FONT COLOR=#550000>You can only send '+maxtroupe+' troops.</font>';
       return;
      }
      var iused=new Array();
      var itemlist=[55,57,931,932];
      for(var i=0;i<itemlist.length;i++){
      
       var l_elem=ById("BOitem_"+itemlist[i]);
       if(l_elem&&l_elem.checked&&parseInt(Seed.items["i"+itemlist[i]])>0){
        iused.push(itemlist[i]);       
       }      
      }
      var res=0;
      if (bouffe==1) {
       for (var i=1;i<13;i++) {
        res += parseInt(unsafeWindow.unitstats['unt'+i][5] * ById("RAAnbunit"+i).value * (1 + (0.10 * Seed.tech.tch10)));
       }
       }
      params.items=iused.join(","); 
         params.cid= t.sourceCity.id;
         params.type = typemarche; // 5 = REASSIGNER - 4 = ATTAQUE - 2 = RENFORCER
         params.xcoord = x;
         params.ycoord = y;
   	 params.kid= ById("RAApiKnight").value;
	 params.r1 = res; 
	 params.r2 = 0; 
	 params.r3 = 0; 
	 params.r4 = 0; 
	 params.gold = 0; 
	 params.u1 = 0;
  	 params.u2 = 0;
  	 params.u3 = 0;
  	 params.u4 = 0;
  	 params.u5 = 0;
  	 params.u6 = 0;
  	 params.u7 = 0;
  	 params.u8 = 0;
  	 params.u9 = 0;
  	 params.u10 = 0;
  	 params.u11 = 0;
 	 params.u12 = 0;
 
 
         if (typemarche!=3) {
        if (ById("RAAnbunit1").value>0) params.u1 = ById("RAAnbunit1").value;
	if (ById("RAAnbunit2").value>0) params.u2 = ById("RAAnbunit2").value;
	if (ById("RAAnbunit3").value>0) params.u3 = ById("RAAnbunit3").value;
	if (ById("RAAnbunit4").value>0) params.u4 = ById("RAAnbunit4").value;
	if (ById("RAAnbunit5").value>0) params.u5 = ById("RAAnbunit5").value;
	if (ById("RAAnbunit6").value>0) params.u6 = ById("RAAnbunit6").value;
	if (ById("RAAnbunit7").value>0) params.u7 = ById("RAAnbunit7").value;
	if (ById("RAAnbunit8").value>0) params.u8 = ById("RAAnbunit8").value;
	if (ById("RAAnbunit9").value>0) params.u9 = ById("RAAnbunit9").value;
	if (ById("RAAnbunit10").value>0) params.u10 = ById("RAAnbunit10").value;
	if (ById("RAAnbunit11").value>0) params.u11 = ById("RAAnbunit11").value;
	if (ById("RAAnbunit12").value>0) params.u12 = ById("RAAnbunit12").value;
	
	}else {
	 params.u3 = ById("RAAnbunit3").value;
	 ById("RAAnbunit3").value=0;
	}
  	t.actionRAA.disabled=true;
        t.actionREN.disabled=true;
        t.actionREE.disabled=true;
	t.statutRAA.innerHTML = "<i><b>Enviando marcha....</b></i>";
	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
	              method: "post",
	              parameters: params,
	              loading: true,
	              onSuccess: function (transport) {
	                  var t = Tabs.Attaque;  
	                  var rslt = transport;
	                  if (rslt.ok) {
			   var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
	                   var ut = unsafeWindow.unixtime();
	                   var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
	                   for(i = 0; i <= unitsarr.length; i++){
	                   	if(params["u"+i]){
	                  	unitsarr[i] = params["u"+i];
	                  	}
	                   }
	                   var resources=new Array();
	                   resources[0] = params.gold;
	                   for(i=1; i<=4; i++){
	                  	resources[i] = params["r"+i];
	                   }
	                   var currentcityid =  t.sourceCity.id;
	                   unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
	                   unsafeWindow.update_seed(rslt.updateSeed)
	                   if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
	                   
	                   for(var i=0;i<iused.length;i++){
						Seed.items["i"+iused[i]]=parseInt(Seed.items["i"+iused[i]])-1;unsafeWindow.ksoItems[iused[i]].subtract();
					   }
					    var typeattaque = "";
						switch (typemarche){
							case 2:
								typeattaque="reinforcement made";
								break;
							case 3:
								typeattaque="scouting  on";
								break;
							case 4:
								typeattaque="attack carried out";
								break;
							case 5:
								typeattaque="reallocation on";
								break;
							default:
								typeattaque="on march";
						}
     	 		   t.statutRAA.innerHTML = "<center><font size='3px'><b>"+typeattaque+"</b></font></center>";
	                   t.actionRAA.disabled=false;
	                   t.actionREE.disabled=false;
      			   t.actionREN.disabled=false;	
      			   t.clickRAACitySourceSelect(t.sourceCity);
	                  } else {
			    t.statutRAA.innerHTML ="<font color=red size='3px'><b>Error sending progress!<b></font>";
			     if (rslt.msg) {
			       t.statutRAA.innerHTML +="<br><font color=black size='2px'>" + rslt.msg +"</font>";
	         	     
	                     t.actionRAA.disabled=false;
      			     t.actionREN.disabled=false;
      			     t.actionREE.disabled=false;
      			     }else{
      			      t.statutRAA.innerHTML +="<br>Esperando 2 segundos!</font>";
         	     	      setTimeout(function() { t.clickATTAQUEDo(); }, 2000);
      			     }
	                  }
	                  },
	                  onFailure: function () {
	                    var t = Tabs.Attaque;
	                    t.statutRAA.innerHTML ="<font color=red size='3px'><b>Error communicating with the server!<b></font>";
	                    t.actionRAA.disabled=false;
      			    t.actionREN.disabled=false;
      			    t.actionREE.disabled=false;
	                  }
	          });
            
  
    },
  
    estimerRes: function() {
     var t = Tabs.Attaque;
     // CAlcul de ETA = Estimation du temps de marches
     var x1 = parseInt(t.sourceCity.x);
     var x2 = parseInt(t.destinationCityx.value);
     var y1 = parseInt(t.sourceCity.y);
     var y2 = parseInt(t.destinationCityy.value);
     var dist = distance (x1, y1, x2, y2);
     ById("BOEstimationD").innerHTML = '<b>' + dist + '</b>&nbsp;<a href="javascript:void(0)" onclick="cm.utils.CoordinateLinkController.onClick(event)" class="coordinateLink">('+ t.destinationCityx.value +','+ t.destinationCityy.value +')</a>';     
     for (r=1; r<13; r++){
        var m = estETA(dist, r, t.sourceCity.id);
        ById("BOEstimationTT"+r).innerHTML = "<b>" + m.etaStr + "</b>";
        ById("BOEstimationTZ"+r).innerHTML = "<b>" + m.friendEtaStr + "</b>";
     }
    var closestDist=999999;
	var closestLoc=null;
	var closestNum=1;
	for (var c=0; c<Cities.numCities; c++){
	var city = Cities.cities[c];
	var dist=distance(city.x,city.y,x2,y2);
	if(dist<closestDist) {
	 closestDist=dist;
	 closestLoc=city.x +','+ city.y;
	 closestNum=c+1;
	}
	}
	ById("BOVilleProche").innerHTML='<input type="submit" value="'+closestNum+'" class="ptcastleBut ptcastleButNon">'		
    },
    SelectFavoris:function() {
      var t = Tabs.Attaque;
      if (t.listeFavoris.value!='') {
       var valeur=t.listeFavoris.value;
       var x=valeur.substr(0, valeur.lastIndexOf(','));
       var y=valeur.substr(valeur.lastIndexOf(',')+1, valeur.length);
       t.destinationCityx.value = x;
       t.destinationCityy.value = y;
      }
      t.estimerRes();
     },
      chercherFavoris: function() {
      var t = Tabs.Attaque;
      var myA = getMyAlliance ();
      if (myA[0]!=0) {
         var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
         params.perPage = 100;
         params.allianceId = myA[0];
             new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
   	        method: "post",
   	        parameters: params,
   	        onSuccess: function (rslt) {
   	          // on vide la liste
   	          //t.listeFavoris.innerHTML=null;
   	          if (rslt.ok){
   	           var z=0;
   	           var m="";
   	           for (var i=0; i<rslt.results.length; i++){
        		      p = rslt.results[i];
   		      if (p.userId != 0){
   		       for (var c=0; c<p.cities.length; c++){
   		         if (Seed.player.name!=p.displayName) {
   		          m += "<option value='" + p.cities[c].xCoord + ","+ p.cities[c].yCoord+"'>" + p.displayName + " - City " + (c+1) + " - " + p.cities[c].xCoord + "," + p.cities[c].yCoord+"</option>";
   		         }
   		       }  //fin for cities  	       
   		      }   //fin if user 
         	            } //fin for resultat
         	    t.listeFavoris.innerHTML="<option value=''>Selection...</option>"+m;
   	          }// fin
   	        },
   	        onFailure: function (rslt) {
   	          t.listeFavoris.innerHTML="<option>Error collecting information</option>";
   	        },
       	});
             
      } else {
        // Si pas d'alliance !
        t.listeFavoris.innerHTML="<option>Error collecting information !</option>";
      }
         
  },
   SaveCoordsOptions: function(x,y) {
       Options.Xrenfort = x;
       Options.Yrenfort = y;
       saveOptions ();
  },
   
  clickRAACitySourceSelect : function (city){
     var t = Tabs.Attaque;
    
     if (t.sourceCity!=city) {
      t.sourceCity = city; 
     }
     var m="";
     m="<table cellspacing=0 cellpadding=0 width=80%><tr><td colspan=2>troops available</tr>";
     var cityID = 'city'+ t.sourceCity.id;
     for (r=1; r<13; r++){   
       m += '<tr><td align=right><img title="'+unsafeWindow.unitcost['unt'+r][0]+'" height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+r+'_30_s34.jpg></td>\
             <td align=left><input style="border:1px solid black;height:16px;font-size:11px;" id="RAAdestunit'+r+'" type=text size=7 readonly value="'+parseInt(Seed.units[cityID]['unt'+r])+'">&nbsp;\
             <input type=button value="--->" id="RAApdestunit'+r+'"  style="border:1px solid black;height:16px;font-size:11px;"></td></tr>';
     }
     m += "</table>";
     ById("RAAstatsource").innerHTML = m;
        var knt = new Array();
        for (k in Seed.knights['city' + t.sourceCity.id]){
               		if (Seed.knights['city' + t.sourceCity.id][k]["knightStatus"] == 1 && Seed.leaders['city' + t.sourceCity.id]["resourcefulnessKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"] && Seed.leaders['city' + t.sourceCity.id]["politicsKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"] && Seed.leaders['city' + t.sourceCity.id]["combatKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"] && Seed.leaders['city' + t.sourceCity.id]["intelligenceKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"]){
               			knt.push ({
               				Name:   Seed.knights['city' + t.sourceCity.id][k]["knightName"],
               				Combat:	Seed.knights['city' + t.sourceCity.id][k]["combat"],
               				ID:	Seed.knights['city' + t.sourceCity.id][k]["knightId"],
               			});
               		}
               }
               knt = knt.sort(function sort(a,b) {a = parseInt(a['Combat']);b = parseInt(b['Combat']);return a == b ? 0 : (a > b ? -1 : 1);}); 
               ById('RAApiKnight').options.length=0;
               var o = document.createElement("option");
     	       o.text = "--Select a Knight--"
     	       o.value = 0;
               ById("RAApiKnight").options.add(o);
               for (k in knt){
            			if (knt[k]["Name"] !=undefined){
        	    			var o = document.createElement("option");
        	    			o.text = (knt[k]["Name"] + ' (' + knt[k]["Combat"] +')')
        	    			o.value = knt[k]["ID"];
        	    			ById("RAApiKnight").options.add(o);
            			}
         }
     
      if (ById('RAApiKnight').options.length>0) {
       ById('RAApiKnight').selectedIndex=1;
      } 
      
      var itemlist=[55,57,931,932];
      for(var i=0;i<itemlist.length;i++){
        ById('BOitemSpan_'+itemlist[i]).innerHTML = unsafeWindow.ksoItems[itemlist[i]].count;
      }
     for (r=1; r<13; r++){
       ById("RAApdestunit"+r).addEventListener ('click', function() {
         var nomcha=this.id.replace("RAApdest","RAAdest");
         var nomcha2=this.id.replace("RAApdestunit","RAAnbunit");
         ById(nomcha2).value=0; 
         var e=1;
         var f=unsafeWindow.unixtime();
         if(Seed.playerEffects.aurasExpire){if(Seed.playerEffects.aurasExpire>f){e=1.15}}
	 if(Seed.playerEffects.auras2Expire){if(Seed.playerEffects.auras2Expire>f){e=1.3}}

         var l_elem=ById("BOitem_931");
	 if(l_elem&&l_elem.checked&&parseInt(Seed.items["i931"])>0){	        e+=0.25;	 }
	 var l_elem=ById("BOitem_932");
	 if(l_elem&&l_elem.checked&&parseInt(Seed.items["i932"])>0){	        e+=0.5;     }

         var niveauPointRall=parseInt(getCityBuilding (t.sourceCity.id, 12).maxLevel); // 12=Point de ralliement
         var maxtroupe=parseInt(niveauPointRall*10000*e);
         if (niveauPointRall==11) maxtroupe=parseInt(150000*e);
         if (niveauPointRall==12) maxtroupe=parseInt(200000*e);
         var nbunitto=0;
         for (r=1; r<13; r++) {
           nbunitto+=parseInt(ById("RAAnbunit"+r).value);
	 }
         var libre = parseInt(maxtroupe - nbunitto);
         if (ById(nomcha).value>=libre) {
           ById(nomcha2).value = libre;
         }  else {
           ById(nomcha2).value= ById(nomcha).value;
         }
        }, false);
     }
     if (t.sourceCity!=city) {
           for (r=1; r<13; r++){
            ById("RAAnbunit"+r).value="0";
           }
     } else {
          
          for (r=1; r<13; r++){
              if (ById("RAAnbunit"+r).value=="") ById("RAAnbunit"+r).value="0";
              if (ById("RAAdestunit"+r).value=="") ById("RAAdestunit"+r).value="0";
                if (parseInt(ById("RAAnbunit"+r).value)>parseInt(ById("RAAdestunit"+r).value)) {
                 ById("RAAnbunit"+r).value="0";
                }
           }
     }
     t.estimerRes();
   },
 
 
}


function estETA(dist, unit, cityID) {
	var ret={ETA:0,etaStr:'N/D',friendETA:0,friendEtaStr:'N/D'};    
	if (dist <= 0) return ret;
	var troop_type = unit;
	var horse=0;
	if(troop_type>6) horse=1;
	var troop_speed=parseInt(unsafeWindow.unitstats["unt"+troop_type][3])*(1+0.1*parseInt(Seed.tech.tch11));
	if (horse){
		troop_speed=troop_speed*(1+0.05*parseInt(Seed.tech.tch12))
	} 
	var Speed = troop_speed;
	var gi=unsafeWindow.cm.guardianModalModel.getMarchBonus();
	var multiplier=1+(gi*0.01);
	Speed=Speed*multiplier;
	var gSpeed = 0;
	var estSec;
	if (Speed>0) {
	  gSpeed = Speed/6000;
	  estSec = Math.ceil(parseFloat(dist)/gSpeed);
	}
	var e=1;
	if (ById("BOitem_55")) {
	  var l_elem=ById("BOitem_55");
	  if(l_elem&&l_elem.checked>0){ e=0.75;     }
	}
	if (ById("BOitem_57")) {
	  var l_elem=ById("BOitem_57");
	  if(l_elem&&l_elem.checked){   e=0.5;   }
	}
	ret.ETA = (parseInt((estSec*e+''))+30); 
	if(Seed.playerEffects.returnExpire>unsafeWindow.unixtime()){
	  ret.ETA=parseInt(ret.ETA*0.5);
	}
	ret.etaStr = timestr (ret.ETA,1);
	var building = getCityBuilding (cityID, 18);
	if (building) {
	  fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
	  gSpeed = fSpeed/6000;
	  estSec = (dist/gSpeed).toFixed(0);
	  ret.friendETA = parseInt((estSec*e+''))+30; 
	  ret.friendEtaStr = timestr ((ret.friendETA+''),1);
	}
	return ret;
}

/********************************* Reports Tab *************************************/
Tabs.Rpt = {
	tabOrder:    29,
	tabLabel:    'Reports',
	cont:        null,
	state:       null,
	minPages:    parseInt(Options.arPageFrom),
	maxPages:    parseInt(Options.arPageTo),
	data:        [],
        dataDF:	     [],
        dataAT:	     [],
	report:      [],
	reportDF:    [],
	reportAT:    [],
	totalPages:  parseInt(Options.arPageTo),
	what:        '',
	whatNot:     '',
	content:     '',

  show : function () {

    var t = Tabs.Rpt;
  },
	hide : function (){
  	},

	init: function (div){
		var t = Tabs.Rpt;
		t.cont=div;
		unsafeWindow.getmsg = t.getMailBody;
		unsafeWindow.getReport = t.getReportBody;
		unsafeWindow.DelMail = t.DeleteMail;
		unsafeWindow.DelReport = t.DeleteReport;

		var tc = '<DIV class=ptstat>RESEARCH REPORTS ALLIANCE AND PLAYER</DIV><DIV class=ptentry><TABLE><TR align=center valign=center>';
		tc += '<TD class=xtab align=right>type:&nbsp;<SELECT id="idRptType">';
		tc += '<OPTION value="alliance" ' + (Options.rptType=='alliance'?'SELECTED':'') + '>Alliance</OPTION>';
		tc += '<OPTION value="player" ' + (Options.rptType=='player'?'SELECTED':'') + '>player</OPTION>';
		tc += '<OPTION value="inbox" ' + (Options.rptType=='inbox'?'SELECTED':'') + '>inbox</OPTION>';
		tc += '<OPTION value="outbox" ' + (Options.rptType=='outbox'?'SELECTED':'') + '>outbox</OPTION></SELECT>';
		tc += '<BR />Pages:&nbsp;<INPUT id="idRptPageFrom" size=1 value="' + Options.arPageFrom + '">&#8211;<INPUT id="idRptPageTo" size=1 value="' + Options.arPageTo + '"></TD>';
		tc += '<TD class=xtab align=right>attacker:&nbsp;<SELECT id="idRptAttacker">'; // Options.arPageFrom - Options.arPageTo
		tc += '<OPTION value="Them" ' + (Options.arAttacker=='Them'?'SELECTED':'') + '>them</OPTION>';
		tc += '<OPTION value="Us" ' + (Options.arAttacker=='Us'?'SELECTED':'') + '>us</OPTION>';
		tc += '<OPTION value="Both" ' + (Options.arAttacker=='Both'?'SELECTED':'') + '>both</OPTION></SELECT>';
		tc += '<BR />target:&nbsp;<SELECT id="idRptTarget">';
		tc += '<OPTION value="Them" ' + (Options.arTarget=='Them'?'SELECTED':'') + '>them</OPTION>';
		tc += '<OPTION value="Us" ' + (Options.arTarget=='Us'?'SELECTED':'') + '>us</OPTION>';
		tc += '<OPTION value="Both" ' + (Options.arTarget=='Both'?'SELECTED':'') + '>both</OPTION></SELECT></TD>';
		tc += '<TD class=xtab align=right>contains:&nbsp;<INPUT id=idRptWhat type=text size=11 maxlength=50 value=""><BR />';
		tc += 'Target:&nbsp;<INPUT id=idRptWhatNot type=text size=11 maxlength=50 value=""></TD>';
		tc += '<TD class=xtab align=left><INPUT id=idRptAttack type=checkbox '+(Options.arAttack?'CHECKED':'')+' />&nbsp;Attack<BR />';
		tc += '<INPUT id=idRptScout type=checkbox '+(Options.arScout?'CHECKED':'')+' />&nbsp;scout</TD>';
		tc += '<TD class=xtab align=left><INPUT id=idRptReinforce type=checkbox '+(Options.arReinforce?'CHECKED':'')+' />&nbsp;reinforcement<BR />';
		tc += '<INPUT id=idRptTransport type=checkbox '+(Options.arTransport?'CHECKED':'')+' />&nbsp;Transportes</TD>';
		tc += '<TD class=xtab align=left><INPUT id=idRptSearch type=submit value="search" /></TD>';
		tc += '<TD class=xtab align=left><select id=idRptFiltre1><option value="">--</option><option value="0">TS</option><option value=54>FS</option></select><br>SYNTH : <input type=checkbox id=BOSyntheseAttack></TD></TR></TABLE></DIV>';
		tc += '<DIV class=ptstat><TABLE width=100% cellspacing=0><TR><TD class=xtab align=left width=125><DIV id=idRptSearched></DIV></TD></TD>';                    
		tc += '<TD class=xtab><TD class=xtab align=center><SPAN style="white-space:normal" id=idRptStatus>&nbsp;</span></TD></TD>';
		tc += '<TD class=xtab><TD class=xtab align=right width=125><DIV id=idRptFound></DIV></TD></TR></TABLE></DIV>';
		tc += '<DIV id="idRptResultsDiv" style="height:556px; max-height:556px; overflow-x:auto; overflow-y:auto; white-space:nowrap;"></DIV>';
		t.cont.innerHTML = tc;
		ById('idRptType').addEventListener ('change', t.handleRptType, false);
		ById('idRptPageFrom').addEventListener ('change', t.handleRptPages, false);
		ById('idRptPageTo').addEventListener ('change', t.handleRptPages, false);
		ById('idRptAttacker').addEventListener ('change', t.handleRptAttacker, false);
		ById('idRptTarget').addEventListener ('change', t.handleRptTarget, false);
		ById('idRptWhat').addEventListener ('keyup', t.handleRptWhat, false);
		ById('idRptWhatNot').addEventListener ('keyup', t.handleRptWhatNot, false);
		ById('idRptSearch').addEventListener ('click', t.handleRptSearch, false);
		ById('idRptFiltre1').addEventListener ('change', t.handleRptWhat, false);

		t.togOpt ('idRptAttack', 'arAttack');
		t.togOpt ('idRptScout', 'arScout');
		t.togOpt ('idRptReinforce', 'arReinforce');
		t.togOpt ('idRptTransport', 'arTransport');
		return this.cont;
	},

	DeleteMail: function(rptid, type) {
   var t = Tabs.Rpt;
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.requestType="ACTION_ON_MESSAGES";
   params.selectedAction="delete";
   params.boxType=ById('idRptType').value;
   params.selectedMessageIds=rptid;

   new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
         method: "post",
         parameters: params,
         onSuccess: function (rslt) {
           if (rslt.ok) {
           
           t.handleRptSearch();
           
           }
           if (notify)
             notify (rslt.errorMsg);
         },
         onFailure: function () {
           if (notify)
             notify ('AJAX ERROR');
         },
       });
  },
  
  DeleteReport: function(rptid, isUnread) {
   var t = Tabs.Rpt;
     
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.s0rids = rptid;
   params.s1rids = '';
   params.cityrids = '';
   
   new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
         method: "post",
         parameters: params,
         onSuccess: function (rslt) {
           if (rslt.ok) {
           
           if (isUnread){
             unsafeWindow.seed.newReportCount = parseInt(unsafeWindow.seed.newReportCount) - 1;
             unsafeWindow.messages_notify_bug()
           } 
           //t.handleRptSearch();
           //t.DisplayRpt();
           }
    
         },
         onFailure: function () {
             t.handleRptSearch();
         },
       });
  },

	togOpt: function (checkboxId, optionName){
		var t = Tabs.Rpt;
		var checkbox = document.getElementById(checkboxId);
		checkbox.addEventListener ('change', eventHandler, false);
		function eventHandler (){
			Options[optionName] = this.checked;
			saveOptions();
			if (t.data.length > 0)
				if (Options.rptType == 'alliance' || Options.rptType == 'player')
					t.DisplayRpt();
				else
					t.DisplayMail();
		}
	},

	handleRptType: function(){
		var t = Tabs.Rpt;
		Options.rptType = document.getElementById("idRptType").value;
		saveOptions();
		document.getElementById("idRptSearched").innerHTML = '';
		document.getElementById("idRptStatus").innerHTML = '&nbsp;';
		document.getElementById("idRptFound").innerHTML = '';
		document.getElementById("idRptResultsDiv").innerHTML = '';
	},

	handleRptPages: function(){
		var t = Tabs.Rpt;
		t.minPages=parseInt(document.getElementById("idRptPageFrom").value);
		t.maxPages=parseInt(document.getElementById("idRptPageTo").value);
		if (t.maxPages < t.minPages) {
			t.maxPages = t.minPages;
			document.getElementById("idRptPageTo").value = t.maxPages;
		}
		Options.arPageFrom = t.minPages;
		Options.arPageTo = t.maxPages;
		saveOptions();
		t.totalPages=t.maxPages;
	},

	handleRptAttacker: function(){
		var t = Tabs.Rpt;
		Options.arAttacker = document.getElementById("idRptAttacker").value;
		saveOptions();
		if ((Options.rptType == 'alliance' || Options.rptType == 'player') && t.data.length > 0)
			t.DisplayRpt();
	},

	handleRptTarget: function(){
		var t = Tabs.Rpt;
		Options.arTarget = document.getElementById("idRptTarget").value;
		saveOptions();
		if ((Options.rptType == 'alliance' || Options.rptType == 'player') && t.data.length > 0)
			t.DisplayRpt();
	},

	handleRptWhat: function(){
		var t = Tabs.Rpt;
		t.what = document.getElementById("idRptWhat").value;
		if (t.data.length > 0)
			if (Options.rptType == 'alliance' || Options.rptType == 'player')
				t.DisplayRpt();
			else
				t.DisplayMail();
	},

	handleRptWhatNot: function(){
		var t = Tabs.Rpt;
		t.whatNot = document.getElementById("idRptWhatNot").value;
		if (t.data.length > 0)
			if (Options.rptType == 'alliance' || Options.rptType == 'player')
				t.DisplayRpt();
			else
				t.DisplayMail();
	},

	handleRptSearch: function(){
		var t = Tabs.Rpt;
		if (t.searchRunning){
			t.searchRunning = false;
			t.stopSearch ('Search canceled!');
			return;
		}
		t.handleRptPages();
		document.getElementById ('idRptSearch').value = 'stop search';
		document.getElementById('idRptStatus').innerHTML = 'looking page ' + t.minPages + 'of ' + t.maxPages;
		t.searchRunning = true;
		t.data=[];
		t.report = [];
		t.dataDF=[];
		t.dataAT=[];
		t.reportAT=[];
		t.reportDF = [];
		if (Options.rptType == 'alliance' || Options.rptType == 'player')
			t.getRpt(t.minPages);
		else
			t.getMail(t.minPages);
	},

	stopSearch: function (msg){
		var t = Tabs.Rpt;
		if (t.searchRunning || msg == 'Search canceled!')
			document.getElementById ('idRptStatus').innerHTML = '<FONT color=#ffaaaa>' + msg + '</FONT>';
		document.getElementById ('idRptSearch').value = 'start searching';
		t.searchRunning = false;
		if (Options.rptType == 'alliance' || Options.rptType == 'player')
			t.DisplayRpt();
		else
			t.DisplayMail();
	},

	getMail: function (pageNum){
		var t = Tabs.Rpt;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pf=0;
		params.requestType="GET_MESSAGE_HEADERS_FOR_USER_INBOX";
		params.boxType = document.getElementById('idRptType').value;
		params.pageNo = pageNum;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				t.getMailCallback(rslt, pageNum);
			},
			onFailure: function () {
			},
		}, false);
	},

	getMailCallback: function(rslt, page) {
		var t = Tabs.Rpt;
		if (rslt) {
			if (!rslt.ok) {
				document.getElementById("idRptStatus").innerHTML = '<FONT color=#ffaaaa>' + rslt.errorMsg + '</FONT>';
				return;
			}
			t.totalPages=parseInt(rslt.noOfPages);
			if (t.totalPages < t.maxPages)
				t.maxPages = t.totalPages;
			if (rslt.message && page) {
				var ml = rslt.message;
				if (rslt.messageCount > 0) {
					var rptkeys = unsafeWindow.Object.keys(ml);
					for (var i = 0; i < rptkeys.length; i++) {
						var rpt = ml[rptkeys[i]];
						rpt.page = page;
						t.data.push(rpt);
					}
				}
			}
			if (parseInt(page)+1 <= t.maxPages && t.searchRunning) {
				document.getElementById("idRptStatus").innerHTML = 'looking page ' + (parseInt(page)+1) + ' de ' + t.maxPages;
				t.getMail(parseInt(page)+1);
				if (t.data.length > 0)
					t.DisplayMail();
			} else if (page)
				t.stopSearch ('done!');
		}
	},

	getRpt: function (pageNum){
		var t = Tabs.Rpt;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pageNo = pageNum;
		if (Options.rptType == 'alliance')
			params.group = "a";
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt){
				t.getRptCallback (rslt, pageNum);
			},
			onFailure: function (rslt){
				t.getRptCallback (rslt, pageNum);
			},
		}, false);
	},

	getRptCallback: function(rslt, page){
		var t = Tabs.Rpt;
		if (rslt) {
			if (!rslt.ok) {
				document.getElementById("idRptStatus").innerHTML = '<FONT color=#ffaaaa>' + rslt.errorMsg + '</FONT>';
				return;
			}
			t.totalPages=parseInt(rslt.totalPages);
			if (t.totalPages < t.maxPages)
				t.maxPages = t.totalPages;
			if (rslt.arReports && page) {
				var ar = rslt.arReports;
			//	if (ar.length == 0)
			//		t.stopSearch('Empty pages found from page ' + page + ' onwards - Kabam glitch');
				var rptkeys = unsafeWindow.Object.keys(ar);
				for (var i = 0; i < rptkeys.length; i++) {
					var rpt = ar[rptkeys[i]];
					var reportId = parseInt(rpt.reportId);
					t.report[reportId] = [];

					// Attacker
					t.report[reportId].side1Name = rslt.arPlayerNames['p'+rpt.side1PlayerId];
					t.report[reportId].side1AllianceId = parseInt(rpt.side1AllianceId);
					if (rpt.side1AllianceId > 0)
						t.report[reportId].side1AllianceName = rslt.arAllianceNames['a'+rpt.side1AllianceId];
					else
						t.report[reportId].side1AllianceName = 'no alliance';
					if (rpt.side1CityId > 0)
						t.report[reportId].side1CityName = rslt.arCityNames['c'+rpt.side1CityId];
					else
						t.report[reportId].side1CityName = 'none';
					t.report[reportId].side1XCoord = rpt.side1XCoord;
					t.report[reportId].side1YCoord = rpt.side1YCoord;
					// Target
					if (parseInt(rpt.side0PlayerId) == 0) { // Kabam
						t.report[reportId].side0Name = 'Enemy';
						t.report[reportId].side0AllianceName = '';
						t.report[reportId].side0CityName = '';
					} else { // Player
						t.report[reportId].side0Name = rslt.arPlayerNames['p'+rpt.side0PlayerId];
						if (rpt.side0AllianceId > 0)
							t.report[reportId].side0AllianceName = rslt.arAllianceNames['a'+rpt.side0AllianceId];
						else
							t.report[reportId].side0AllianceName = 'no alliance';
						if (rpt.side0CityId > 0)
							t.report[reportId].side0CityName = rslt.arCityNames['c'+rpt.side0CityId];
						else
							t.report[reportId].side0CityName = 'none';
					}
					t.report[reportId].side0AllianceId = parseInt(rpt.side0AllianceId);
					t.report[reportId].side0XCoord = rpt.side0XCoord;
					t.report[reportId].side0YCoord = rpt.side0YCoord;
					if (parseInt(rpt.side0TileType) == 10)
						t.report[reportId].side0TileTypeText='grassland';
					else if (parseInt(rpt.side0TileType) == 11)
						t.report[reportId].side0TileTypeText='lake';
					else if (parseInt(rpt.side0TileType) == 20)
						t.report[reportId].side0TileTypeText='woods';
					else if (parseInt(rpt.side0TileType) == 30)
						t.report[reportId].side0TileTypeText='hill';
					else if (parseInt(rpt.side0TileType) == 40)
						t.report[reportId].side0TileTypeText='mountain';
					else if (parseInt(rpt.side0TileType) == 50)
						t.report[reportId].side0TileTypeText='plain';
					else if (parseInt(rpt.side0TileType) == 51 && parseInt(rpt.side0CityId) == 0)
						t.report[reportId].side0TileTypeText='Barb';
					else if (parseInt(rpt.side0TileType) == 54)
						t.report[reportId].side0TileTypeText='F.S.';
					else if (parseInt(rpt.side0CityId) ==0)
						t.report[reportId].side0TileTypeText='Barbaro';
					else
						t.report[reportId].side0TileTypeText='city';
					t.report[reportId].side0TileTypeLevel = t.report[reportId].side0TileTypeText + ' ' + rpt.side0TileLevel;
					t.report[reportId].side0TileType = rpt.side0TileType;
					t.report[reportId].side0TileLevel = rpt.side0TileLevel;
					t.report[reportId].page = page;
					t.report[reportId].reportUnixTime = rpt.reportUnixTime;
					if (rpt.side0AllianceId == parseInt(getMyAlliance()[0]))
						t.report[reportId].sideId = 0;
					else if (rpt.side1AllianceId == parseInt(getMyAlliance()[0])) {
						t.report[reportId].sideId = 1;
					} else { // if we're here then this is a player report from when they were in another alliance
						if (rpt.side0PlayerId == getMyUserId())
							t.report[reportId].sideId = 0;
						else if (rpt.side1PlayerId == getMyUserId())
							t.report[reportId].sideId = 1;
						else // shouldn't get here but we'll catch it if the report body is requested
							t.report[reportId].sideId = -1;
					}
					if (!ById("BOSyntheseAttack").checked && parseInt(rpt.side0TileType) == 54 && Options.rptType=='player') {
					    t.FindItemRpt(reportId, t.report[reportId].sideId, t.report[reportId].side0TileLevel);  
				        }
					if (ById("BOSyntheseAttack").checked && (rpt.marchType == 4 || rpt.marchType == 3))
					{
					    t.BOSyntheseAttack(reportId, t.report[reportId].sideId, 0);
					}

					if (rpt.marchType == 0)
						t.report[reportId].marchName = 'Desertion';
					else if (rpt.marchType == 1)
						t.report[reportId].marchName = 'Transport';
					else if (rpt.marchType == 2)
						t.report[reportId].marchName = 'Reinforce';
					else if (rpt.marchType == 3 || rpt.marchType == 11) {
						if (t.report[reportId].sideId == 0)
							t.report[reportId].marchName = 'Anti-Scout';
						else
							t.report[reportId].marchName = 'Scout';
					} else if (rpt.marchType == 4) {
						if (t.report[reportId].sideId == 0)
							t.report[reportId].marchName = 'Defend';
						else
							t.report[reportId].marchName = 'Attack';
					} else if (rpt.marchType == 10 || rpt.marchType == 9) {
					 t.report[reportId].marchName = 'Attack';
					} else
						t.report[reportId].marchName = '?';
					t.data.push ({
						reportId: reportId,
					});
				}
			}
			if (parseInt(page)+1 <= t.maxPages && t.searchRunning) {
				document.getElementById("idRptStatus").innerHTML = 'looking page ' + (parseInt(page)+1) + ' of ' + t.maxPages;
				t.getRpt(parseInt(page)+1);
				if (t.data.length > 0)
					t.DisplayRpt();
			} else if (page) {

				if (ById("BOSyntheseAttack").checked) {
				 t.stopSearch ('<a id=BOresumeAT style="color:#ffaaaa" onclick="javascript:void(0);"><u>Show summary of attacks</u></a>');
				 setTimeout(function() {
								 // ouverture du resume des rapports FS avec Items
								   ById("BOresumeAT").addEventListener ('click', t.AfficheResumeAtk, false);
				  }, 1000);
				} else {
				
				if (Options.rptType=='player') {
				 t.stopSearch ('<a id=BOresumeDF style="color:#ffaaaa" onclick="javascript:void(0);"><u>Show summary of Dark Forests</u></a>');
				 setTimeout(function() {
				 // ouverture du resume des rapports FS avec Items
				   ById("BOresumeDF").addEventListener ('click', t.AfficheResume, false);
				  }, 1000);
				 } else {
				  t.stopSearch ('completed !');
				 }
				}
                  }   
		}
	},

	AfficheResumeAtk:function() {
	 var t = Tabs.Rpt;
	 var puipui=new Array();
	 var fortmight = {u53: "4",u55: "7",u60: "1",u61: "2",u62: "3",    };
	 for (var ui = 1 ; ui<13; ui++)
		 puipui.push(unsafeWindow.unitmight['unt'+ui]);
	 puipui[52] = fortmight['u53'];
	 puipui[54] = fortmight['u55'];
	 puipui[59] = fortmight['u60'];
	 puipui[60] = fortmight['u61'];
	 puipui[61] = fortmight['u62'];
	 var messageBody="";
	 reportsSearched = t.dataAT.length;
	 reportsFound = 0;
         var tr0=0,tr1=0,tr2=0,tr3=0,tr4=0,tr5=0;
	 if (reportsSearched>0) {
	  messageBody +='<br><table width=98%><thead><th>player<br>Alliance</th><th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png></th>\
	  <th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png></th><th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png></th>\
	  <th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png></th><th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png></th>\
	  <th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png></th></thead><tbody>';
	  t.dataAT.sort(function(a, b){
		var sortA=a.nom,sortB=b.nom;
		if (sortA < sortB) return -1
		if (sortA > sortB) return 1
		return 0 
	  });
	 var datartp = [];
	 var nbrp=0;
	 for (var i=0; i<reportsSearched;i++) {
	  var idrapport=t.dataAT[i].reportId;
	  if ((t.what == '' || (t.dataAT[i].nom.search(t.what, "i") != -1)  || (t.dataAT[i].alliance.search(t.what, "i") != -1))
	      && (t.whatNot == '' || (t.dataAT[i].nom.search(t.whatNot, "i") != -1 && t.dataAT[i].alliance.search(t.whatNot, "i") != -1)))
	  {
	   
	   if (datartp[nbrp]==undefined) { 
	     datartp[nbrp]=[];
	     datartp[nbrp].nom = t.dataAT[i].nom;
	     datartp[nbrp].alliance = t.dataAT[i].alliance;
	     datartp[nbrp].res0=0;
	     datartp[nbrp].res1=0;
	     datartp[nbrp].res2=0;
	     datartp[nbrp].res3=0;
	     datartp[nbrp].res4=0;
	     datartp[nbrp].res5=0;
	     for (var z=1;z<64;z++) {
	      datartp[nbrp]['s1unit'+z] =0;
	      datartp[nbrp]['s0unit'+z] =0;
	     }
	   }  
	   if(datartp[nbrp].nom==t.dataAT[i].nom && datartp[nbrp].alliance==t.dataAT[i].alliance) {
	     datartp[nbrp].res0 += parseIntNan(t.reportAT[idrapport].res0);
	     datartp[nbrp].res1 += parseIntNan(t.reportAT[idrapport].res1);
	     datartp[nbrp].res2 += parseIntNan(t.reportAT[idrapport].res2);
	     datartp[nbrp].res3 += parseIntNan(t.reportAT[idrapport].res3);
	     datartp[nbrp].res4 += parseIntNan(t.reportAT[idrapport].res4);
	     datartp[nbrp].res5 += parseIntNan(t.reportAT[idrapport].res5);
	       for (var z=1;z<64;z++) {
	        datartp[nbrp]['s1unit'+z] += parseIntNan(t.reportAT[idrapport]['s1unit'+z]);
	        datartp[nbrp]['s0unit'+z] += parseIntNan(t.reportAT[idrapport]['s0unit'+z]);
	      }
	   } else {
	     nbrp++;
	     datartp[nbrp]=[];
	     datartp[nbrp].nom = t.dataAT[i].nom;
	     datartp[nbrp].alliance = t.dataAT[i].alliance;
	     datartp[nbrp].res0=0;
	     datartp[nbrp].res1=0;
	     datartp[nbrp].res2=0;
	     datartp[nbrp].res3=0;
	     datartp[nbrp].res4=0;
	     datartp[nbrp].res5=0;
	     datartp[nbrp].res0 += parseIntNan(t.reportAT[idrapport].res0);
	     datartp[nbrp].res1 += parseIntNan(t.reportAT[idrapport].res1);
	     datartp[nbrp].res2 += parseIntNan(t.reportAT[idrapport].res2);
	     datartp[nbrp].res3 += parseIntNan(t.reportAT[idrapport].res3);
	     datartp[nbrp].res4 += parseIntNan(t.reportAT[idrapport].res4);
	     datartp[nbrp].res5 += parseIntNan(t.reportAT[idrapport].res5);
	     for (var z=1;z<64;z++) {
	     	      datartp[nbrp]['s1unit'+z] =0;
	     	      datartp[nbrp]['s0unit'+z] =0;
	     	      datartp[nbrp]['s1unit'+z] += parseIntNan(t.reportAT[idrapport]['s1unit'+z]);
	     	      datartp[nbrp]['s0unit'+z] += parseIntNan(t.reportAT[idrapport]['s0unit'+z]);	     
	     }
	   }
	   }// fin du regrouppement
	  }
	  reportsSearched = datartp.length;
	  var tres=[0,0,0,0,0,0];
	  var perts1=[];var perts0=[];
	  for (var z=1;z<64;z++) { perts1[z]=0;perts0[z]=0; }
	  
	  for (var i=0; i<reportsSearched;i++) {
	   messageBody += '<tr><td>'+datartp[i].nom+'<br>'+datartp[i].alliance+'</td>';
	    for (var res=0;res<6;res++) {
	     messageBody += '</td><td align=right>';
	     var cb=0;
	     if (datartp[i]["res"+res] != undefined) {
	       cb=parseIntNan(datartp[i]["res"+res]);
	       tres[res]+=cb;
	     }
	     messageBody += addCommas(cb);
	    }
	    for (var z=1;z<64;z++) {
	     perts1[z]+=parseIntNan(datartp[i]['s1unit'+z]);
	     perts0[z]+=parseIntNan(datartp[i]['s0unit'+z]);
	    } 
	  }
	  messageBody += '</td></tr><tr><td><b>TOTAL : </td>';
	  for (var res=0;res<6;res++) messageBody +='<td align=right><b>'+addCommas(tres[res])+'</b></td>';
	  messageBody += "</tr></table>";
	  messageBody += "<br><table><thead><th width=120><b>your losses</b></th>";
	  for (var z=1;z<64;z++) {
	    if (perts1[z]>0) {
	      messageBody +='<th width=6%><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+z+'_30.jpg ';
	      if(z<14)
	        messageBody +='title="'+unsafeWindow.unitcost['unt'+z][0]+'"';
	      messageBody +='></th>';
	    }
	  }
	  messageBody +='<th></th></thead><tr><td>units</td>';
	  for (var z=1;z<64;z++) if (perts1[z]>0) messageBody +='<td align=right>'+ addCommas(perts1[z])+'</td>';
	  messageBody +='<td></td></tr><tr><td>'+uW.g_js_strings.commonstr.might+'</td>';
	  for (var z=1;z<64;z++) if (perts1[z]>0) messageBody +='<td align=right>'+ addCommas(parseIntNan(perts1[z])*parseIntNan(puipui[z-1]))+'</td>';
	  var to1=0;
	  messageBody +='<td></td></tr><tr><td>'+uW.g_js_strings.commonstr.might+' total</td>';
	  for (var z=1;z<64;z++) to1+=(parseIntNan(perts1[z])*parseIntNan(puipui[z-1]));
	  messageBody += "<td align=right><b>"+addCommas(to1)+"</b></td></tr><thead><th><b>their losses</b></th>";
	  for (var z=1;z<64;z++) {
	   if (perts0[z]>0) {
	      messageBody +='<th width=6%><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+z+'_30.jpg ';
	      if(z<14)
	        messageBody +='title="'+unsafeWindow.unitcost['unt'+z][0]+'"';
	      messageBody +='></th>';
	   }
	  }
	  messageBody +='<th></th></thead><tr><td>name</td>';
	  for (var z=1;z<64;z++) if (perts0[z]>0)messageBody +='<td align=right>'+ addCommas(parseIntNan(perts0[z]))+'</td>';
	  messageBody +='<td></td></tr><tr><td>'+uW.g_js_strings.commonstr.might+'</td>';
	  
	  for (var z=1;z<64;z++) if (perts0[z]>0)messageBody +='<td align=right>'+ addCommas(parseIntNan(perts0[z])*parseIntNan(puipui[z-1]))+'</td>';
	  var to2=0;
	  messageBody +='</tr><tr><td>'+uW.g_js_strings.commonstr.might+' total</td>';
	  for (var z=1;z<64;z++) to2+= (parseIntNan(perts0[z])*parseIntNan(puipui[z-1]));
	  messageBody +="<td align=right><b>"+addCommas(to2)+"</b></td></tr></table><br>";

	  if (to1<to2)
	    messageBody += "<br><b>Apart from might: <font color=#449944>"+addCommas((to2-to1))+"</font><br>";
	  if (to1==to2)
	    messageBody += "<br><b>No one lost power<br>";  
	   if (to1>to2)
	    messageBody += "<br><b>Apart from might: <font color=#994444>"+addCommas((to1-to2))+"</font><br>";  
	    
	 } else {
	  messageBody +="<br><center>The summary is not attack<br>";
	 }
	 t.popRapportAT = new CPopup('pbRapportATBody', 0, 0, 770, 500, true, function() {clearTimeout (1000);});
	 t.popRapportAT.centerMe (mainPop.getMainDiv());
	 var m = '<DIV style="max-height:465px; height:465px; overflow-y:scroll">';
	 m+= messageBody + '</div>';
	 t.popRapportAT.getMainDiv().innerHTML = m;
	 t.popRapportAT.getTopDiv().innerHTML = '<div class=showBadged><center><B>Summary reports of attacks</B></center></div>';
	 t.popRapportAT.show(true);
	},

	AfficheResume:function() {
	 var t = Tabs.Rpt;
	 var messageBody="";
	 reportsSearched = t.dataDF.length;
	 reportsFound = 0;
	 if (t.dataDF.length>0) {
	messageBody +='<br><center><table width=60%><thead><th>report</th><th>level</th><th colspan=2>Objet trouv&eacute;</th></thead><tbody>';
	for (var i=0; i<reportsSearched;i++) {
	var idrapport=t.dataDF[i].reportId;
	var rpt =  t.reportDF[idrapport];
	messageBody += '<tr><td align=right><a onclick="getReport('+ idrapport+')">'+idrapport+'</A></td><td>'+rpt.lvl+'</td><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/' + rpt.item + '.jpg></td><td>'+unsafeWindow.ksoItems[rpt.item].name+'</td></tr>';
	}
	messageBody += "</tbody></table>";
	} else {
	messageBody +="<br><center>There were no reports of Dark forest<br>";
	}
	
	messageBody +='<br><input type=button value="Clear reporting forest" id=BODelAllDF></center>';
	
	
	t.popRapportDF = new CPopup('pbRapportDFBody', 0, 0, 500, 400, true, function() {clearTimeout (1000);});
	t.popRapportDF.centerMe (mainPop.getMainDiv());

	var m = '<DIV style="max-height:365px; height:4365px; overflow-y:scroll">';
	m+= messageBody + '</div>';
	t.popRapportDF.getMainDiv().innerHTML = m;	
        t.popRapportDF.getTopDiv().innerHTML = '<div class=showBadged><center><B>Summary reports '+unsafeWindow.g_js_strings.commonstr.darkForest+'</B></center></DIV>';
	t.popRapportDF.show(true);
	ById('BODelAllDF').addEventListener ('click', t.DeleteRptDF, false);
					
	},
	pagesasup:0,
	DeleteRptDF:function() {
	 var t = Tabs.Rpt;
	 t.pagesasup = 0;
	 t.fetchreport(0, t.checkreports);
	 t.popRapportDF.show(false);
	 t.popRapportDF.destroy();
	 t.popRapportDF = null;
	},
	 fetchreport : function(pageNo, callback){
		var t =  Tabs.Rpt;
		 if (t.pagesasup>=t.maxPages) return;
			var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
			if(pageNo > 1)
				params.pageNo = pageNo;
			new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
				        t.pagesasup++;
					callback(rslt);
				},
					onFailure: function () {
					t.pagesasup++;
					callback();
				},
			});
	    },
		
	    checkreports : function(rslt){
			var t = Tabs.Rpt;
			if(!rslt.ok){
				return;
			}
			if(rslt.arReports.length < 1){
				return;
			}
			var reports = rslt.arReports;
			var totalPages = rslt.totalPages;
			var deletes1 = new Array();
			for(k in reports){
					if(reports[k].side0TileType==54)
						deletes1.push(k.substr(2));
				
			}
			if(deletes1.length > 0 ){
				t.deleteCheckedReports(deletes1);
			} else {
				
				return;
			}
	    },

    	deleteCheckedReports : function(deletes1){
    		var t =  Tabs.Rpt;
    		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    		params.s1rids = deletes1.join(",");
    		params.cityrids = '';
    		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
    			method: "post",
    			parameters: params,
    			onSuccess: function (rslt) {
    				if(rslt.ok){
    					Seed.newReportCount = parseInt(Seed.newReportCount) - parseInt(deletes1.length);
    				}
    				t.fetchreport(0, t.checkreports);
    				t.DisplayRpt();
    			},
    			onFailure: function () {
    			},
    		});
    },

    BOSyntheseAttack:function(reportId, sideId, lvl) {

     var t = Tabs.Rpt;
     var rpt = t.report[reportId];
     var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
     	  params.rid=reportId;
	  params.side=sideId;
     if (params.side > -1) {
     	   new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/fetchReport.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
       
     	   onSuccess:function(msg){
     		var rslt = eval("(" + msg.responseText + ")");
     		t.dataAT.push ({reportId: reportId, nom:rpt.side0Name, alliance:rpt.side0AllianceName});
     		t.reportAT[reportId] = [];
     		t.reportAT[reportId].nom = rpt.side0Name;
     		t.reportAT[reportId].alliance = rpt.side0AllianceName;
     		t.reportAT[reportId].res0=0;
     		t.reportAT[reportId].res1=0;
     		t.reportAT[reportId].res2=0;
     		t.reportAT[reportId].res3=0;
     		t.reportAT[reportId].res4=0;
     		t.reportAT[reportId].res5=0;
     		if (rslt.loot) {
     		 if (rslt['loot'][0] !== undefined) t.reportAT[reportId].res0=rslt['loot'][0];
     		 if (rslt['loot'][1] !== undefined) t.reportAT[reportId].res1=rslt['loot'][1];
     		 if (rslt['loot'][2] !== undefined) t.reportAT[reportId].res2=rslt['loot'][2];
     		 if (rslt['loot'][3] !== undefined) t.reportAT[reportId].res3=rslt['loot'][3];
     		 if (rslt['loot'][4] !== undefined) t.reportAT[reportId].res4=rslt['loot'][4];
     		 if (rslt['loot'][6] !== undefined) t.reportAT[reportId].res5=rslt['loot'][6];
     	        }
     	        if (sideId==0) { // les pertes !!!!
     	         for (var zz=0;zz<6;zz++)
     	            t.reportAT[reportId]["res"+zz] = t.reportAT[reportId]["res"+zz] *-1;
     	        }
     	        if (rslt['fght'] != undefined){
     	        	if (rslt['fght']["s1"] != undefined) {
     	        		for (var i=1;i<13;i++) {
					if (rslt['fght']["s1"]['u'+i] != undefined) {
						if (sideId==1) t.reportAT[reportId]['s1unit'+i]=rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1]; // perte 
						else t.reportAT[reportId]['s0unit'+i]=rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1]; // perte 

					}else{
					 	if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
						else t.reportAT[reportId]['s0unit'+i]=0;
					}
				}
				for (var i=53;i<=55;i++) {
					if (rslt['fght']["s1"]['f'+i] != undefined) {
						if (sideId==1) t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
						else t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
				
			 		}else{
			 			if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
			 			else t.reportAT[reportId]['s0unit'+i]=0;
					}
			 	}
		 		for (var i=60;i<=63;i++) {
					if (rslt['fght']["s1"]['f'+i] != undefined) {
						if (sideId==1) t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
						else t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
				
					}else{
			 			if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
			 			else t.reportAT[reportId]['s0unit'+i]=0;
					}
			 	}	
		 	}
     	         	if (rslt['fght']["s0"] != undefined) {
     	         		for (var i=1;i<13;i++) {
					if (rslt['fght']["s0"]['u'+i] != undefined) {
					  if (sideId==1) {
					   t.reportAT[reportId]['s0unit'+i]=rslt['fght']["s0"]['u'+i][0] - rslt['fght']["s0"]['u'+i][1]; // perte
					  }else{
					    t.reportAT[reportId]['s1unit'+i]=rslt['fght']["s0"]['u'+i][0] - rslt['fght']["s0"]['u'+i][1]; // perte
					  }
					} else {
					 if (sideId==1) {
					  t.reportAT[reportId]['s0unit'+i]=0;
					 } else {
					   t.reportAT[reportId]['s1unit'+i]=0;
					 }
					}
				}
     	         		for (var i=53;i<=55;i++) {
		 			if (rslt['fght']["s0"]['f'+i] != undefined) {
		 				if (sideId==1) {
		 					t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				} else {
		 					t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				}
		 			}else{
						if (sideId==1) t.reportAT[reportId]['s0unit'+i]=0;
						else t.reportAT[reportId]['s1unit'+i]=0;
					}
			 	}
		 		for (var i=60;i<=63;i++) {
		 			if (rslt['fght']["s0"]['f'+i] != undefined) {
		 				if (sideId==1) {
		 					t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				} else {
		 					t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				}
		 			}else{
			 			if (sideId==1) {
			 					t.reportAT[reportId]['s0unit'+i]=0;
			 				} else {
			 					t.reportAT[reportId]['s1unit'+i]=0;
						}
			 		}	
		 		}
			}
     	        }
     	        
        } });
      }  
    },

    FindItemRpt:function(reportId, sideId, lvl) {
	  var t = Tabs.Rpt;
	  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	  params.rid=reportId;
	  params.side=sideId;
	  if (params.side > -1) {
	   new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/fetchReport.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
  
	   onSuccess:function(msg){
		var rslt = eval("(" + msg.responseText + ")");
		if (rslt.loot) {
			if (rslt['loot'][5] !== undefined) {
				var q=unsafeWindow.Object.keys(rslt['loot'][5]);
				if (q.length>0) {
			 			  for(var u=0,y=q.length;u<y;++u){
			 				C=q[u];
			 				if (unsafeWindow.ksoItems[C]!==undefined) {
			 				 t.dataDF.push ({reportId: reportId,});
			 				 t.reportDF[reportId] = [];
			 				 t.reportDF[reportId].lvl = lvl;
			 				 t.reportDF[reportId].item = C;
			 				}
			 			  }
			 	}
			
	          
	                    }
	          
	               }
	        }
            });
          }  
	
	},

	DisplayMail: function (){
		var t = Tabs.Rpt;
		var results = document.getElementById("idRptResultsDiv");
		if(!t.data.length) {
			results.innerHTML = '<center>nothing found</center>';
			return;
		}
		reportsSearched = t.data.length;
		reportsFound = 0;
		t.content = '';
		for (var i=0; i<reportsSearched;i++) {
			var rpt = t.data[i];
			if ((t.what == '' || (rpt.subject.search(t.what, "i") != -1) || (rpt.displayName.search(t.what, "i") != -1))
				&& (t.whatNot == '' || ((rpt.subject.search(t.whatNot, "i") == -1) && (rpt.displayName.search(t.whatNot, "i") == -1)))) {
                                if (rpt.subject == '')
					rpt.subject = '&lt;Sin titulo&gt;';
				reportsFound++;
				if (reportsFound == 1)
					t.content += '<center><table><thead><th>P</th><th>date</th><th>sender</th><th>title</th></thead><tbody>';
                                var stylee="";
				if (rpt.messageRead==0) stylee=' style="background-color:#CCCCCC;"';
				t.content += '<tr><td align=right '+stylee+'>'+rpt.page+'</td><td '+stylee+'>'+rpt.dateSent+'</td><td '+stylee+'>'+rpt.displayName+'</td>';
				t.content += '<td '+stylee+'><A><SPAN onclick="getmsg('+ rpt.messageId +')">' + rpt.subject + '</SPAN></a></td><td><a onclick="DelMail('+ rpt.messageId +');"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="Delete the message"></a></td></tr>';
			}
		}
		if (reportsFound > 1)
			t.content += '</tbody></table></center>';
		if (reportsFound == 0 && reportsSearched > 0)
			t.content = '<center>nothing found</center>';
		results.innerHTML = t.content;
		document.getElementById("idRptSearched").innerHTML = '&nbsp;Searching: ' + reportsSearched;
		document.getElementById("idRptFound").innerHTML = 'found: ' + reportsFound;
	},

	getMailBody: function(ID,dataI){
		var t = Tabs.Rpt;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.messageId=ID;
		params.requestType="GET_MESSAGE_FOR_ID";

		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if (rslt.ok)
					t.displayMailBody(rslt.messageBody);
			},
			onFailure: function () {},
		}, false);
	},

	displayMailBody: function (messageBody, ID) {
		var t = Tabs.Rpt;
		if (t.popMsg == null) {
		  t.popMsg = new CPopup('pbMailBody', 0, 0, 670, 600, true, function() {clearTimeout (1000);});
		  t.popMsg.centerMe (mainPop.getMainDiv());
		}
		messageBody=messageBody.replace(/custom-line-break/g,"<br>");
		var m = '<DIV style="max-height:565px; height:565px; overflow-y:scroll">';
		m+= messageBody + '<hr><a onclick="DelMail('+ ID +');"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="Delete the message"> delete</a><br></div>';
		t.popMsg.getMainDiv().innerHTML = m;
		t.popMsg.getTopDiv().innerHTML = '<div class=showBadged><center>message</center></div><br><hr>';
		t.popMsg.show(true);
	},

	DisplayRpt: function (){
		var t = Tabs.Rpt;
		var results = document.getElementById("idRptResultsDiv");
		if(!t.data.length) {
			results.innerHTML = '<center>nothing found</center>';
			return;
		}
		var myAllianceId = parseInt(getMyAlliance()[0]);
		reportsSearched = t.data.length;
		reportsFound = 0;
		t.content = '';
		for (var i=0; i<reportsSearched;i++) {
			var reportId = t.data[i].reportId;
			var rpt = t.report[reportId];
			if ((rpt.side0Name=='undefined') && (rpt.marchName != 'Desertion'))
				continue;
			if ((((myAllianceId == parseInt(rpt.side1AllianceId) && Options.arAttacker != 'Them')
				|| (myAllianceId != parseInt(rpt.side1AllianceId) && Options.arAttacker != 'Us')
				|| Options.arAttacker == 'Both')
				&& ((myAllianceId == parseInt(rpt.side0AllianceId) && Options.arTarget != 'Them')
				|| (myAllianceId != parseInt(rpt.side0AllianceId) && Options.arTarget != 'Us')
				|| Options.arTarget == 'Both')
				&& ((Options.arAttack && (rpt.marchName == 'Attack' || rpt.marchName == 'Defend'))
				|| (Options.arScout && (rpt.marchName == 'Scout' || rpt.marchName == 'Anti-Scout'))
				|| (Options.arReinforce && rpt.marchName == 'Reinforce')
				|| (Options.arTransport && rpt.marchName == 'Transport')))
				|| (rpt.marchName == 'Desertion')) {
				if (((t.what == ''
					|| (rpt.side1Name.search(t.what, "i") != -1)
					|| (rpt.side1AllianceName.search(t.what, "i") != -1)
					|| (rpt.side0Name.search(t.what, "i") != -1)
					|| (rpt.side0AllianceName.search(t.what, "i") != -1)
					|| (rpt.side0TileTypeText.search(t.what, "i") != -1))
					&& (t.whatNot == ''
					|| ((rpt.side1Name.search(t.whatNot, "i") == -1)
					&& (rpt.side1AllianceName.search(t.whatNot, "i") == -1)
					&& (rpt.side0Name.search(t.whatNot, "i") == -1)
					&& (rpt.side0AllianceName.search(t.whatNot, "i") == -1)
					&& (rpt.side0TileTypeText.search(t.whatNot, "i") == -1))))
					|| (rpt.marchName == 'Desertion')) {

					if ((ById("idRptFiltre1").value=="") ||   (rpt.side0TileType==54 && ById("idRptFiltre1").value==54)  ||
					    (rpt.side0TileType>0 && rpt.side0TileType<51 && ById("idRptFiltre1").value==0)) {


					reportsFound++;
					if (reportsFound == 1) {
						if (Options.enableReportNumber)
							t.content += '<center><table><thead><th>P</th><th>V.</th><th>date</th><th>report</th><th>attacker</th><th>from</th>';
						else
							t.content += '<center><table><thead><th>P</th><th>V.</th><th>date</th><th>attacker</th><th>from</th>';
						if (Options.arAttacker != 'Us')
							t.content += '<th>Alliance</th>';
						t.content += '<th>Action</th><th>objective</th><th>type</th><th>A</th>';
						if (Options.arTarget != 'Us')
							t.content += '<th>Alliance</th>';
						t.content += '<th>Dist</th><th>close</th></thead><tbody>';
					}
					var closestDist=999999;
					var closestLoc=null;
					var closestNum=1;
					for (var c=0; c<Cities.numCities; c++){
						var city = Cities.cities[c];
						city.x +','+ city.y
						var dist=distance(city.x,city.y,rpt.side0XCoord,rpt.side0YCoord);
						if(dist<closestDist) {
							closestDist=dist;
							closestLoc=city.x +','+ city.y;
							closestNum=c+1;
						}
					}
                                         if (rpt.marchName == 'Anti-Scout' || rpt.marchName == 'Defend')
					 style=' style="background-color:#EF9999;"';
					else if (rpt.marchName == 'Reinforce')
					 style=' style="background-color:#99EF99;"';
					else
					 style="";

					t.content += '<tr id="pkrpt'+ reportId +'"><td align=right '+style+'>'+rpt.page+'</td><td  align=right '+style+'><a onclick="getReport('+ reportId+')"><img  border=0 src="http://cdn1.iconfinder.com/data/icons/woothemesiconset/16/search_button.png"></a>';
					 if (rpt.side0Name==Seed.player.name || rpt.side1Name==Seed.player.name) {
					         t.content +='&nbsp;<a onclick="DelReport('+ reportId +', false);document.getElementById(\'pkrpt'+ reportId +'\').style.display=\'none\';"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="Delete my report"></a>';
        					}
					t.content += '</td><td '+style+'>'+formatUnixTime(rpt.reportUnixTime,'24hour')+'</td>';
					if (Options.enableReportNumber)
						t.content += '<td '+style+'>' + reportId + '</td>';
					if (rpt.marchName == 'Desertion') {
						t.content += '<td '+style+'></td><td '+style+'></td>';
						if (Options.arAttacker != 'Us')
							t.content += '<td '+style+'></td>';
						t.content += '<td '+style+'>'+rpt.marchName+'</td><td '+style+'></td><td '+style+'></td><td '+style+'></td>';
						if (Options.arAttacker != 'Us')
							t.content += '<td '+style+'></td>';
						t.content += '<td '+style+'></td><td '+style+'></td>';
						} else {
						t.content += '<td '+style+'>'+rpt.side1Name+'</td><td align=center '+style+'><A onclick="ptGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a></td>';
						if (Options.arAttacker != 'Us')
							t.content += '<td '+style+'>'+rpt.side1AllianceName+'</td>';
						            if (rpt.marchName == 'Anti-Scout' || rpt.marchName == 'Scout')
						             t.content += '<TD '+style+'><A><SPAN onclick="getReport('+ reportId+')"><FONT color="FF8822">'+rpt.marchName+'</font></span></a></td>';
							    else if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
                                                             t.content += '<TD '+style+'><A><SPAN onclick="getReport('+ reportId+')"><FONT color="FF1122">'+rpt.marchName+'</font></span></a></td>';
							    else if (rpt.marchName == 'Reinforce')
                                                             t.content += '<TD '+style+'><A><SPAN onclick="getReport('+ reportId+')"><FONT color="339933">'+rpt.marchName+'</font></span></a></td>';
	      					 	    else
                                                             t.content += '<TD '+style+'><A><SPAN onclick="getReport('+ reportId+')">'+rpt.marchName+'</span></a></td>';
						t.content += '<TD '+style+'>'+rpt.side0Name+'</td><TD '+style+'>'+rpt.side0TileTypeLevel+'</td>';
						t.content += '<td align=center '+style+'><A onclick="ptGotoMap('+ rpt.side0XCoord +','+ rpt.side0YCoord +')">'+ rpt.side0XCoord +','+ rpt.side0YCoord +'</a></td>';
						if (Options.arTarget != 'Us')
							t.content += '<td '+style+'>'+rpt.side0AllianceName+'</td>';
						t.content += '<td  align=right '+style+'>'+Math.floor(closestDist)+'</td><td align=center '+style+'><A onclick=\"ptGotoCity(' + closestNum + ')\">' + closestLoc + '</a></td></tr>';
					}
                                    }
				}
			}
		}
		if (reportsFound > 1)
			t.content += '</tbody></table></center>';
		if (reportsFound == 0 && reportsSearched > 0)
			t.content = '<center>nothing found</center>';
		results.innerHTML = t.content;
		document.getElementById("idRptSearched").innerHTML = '&nbsp;Searching: ' + reportsSearched;
		document.getElementById("idRptFound").innerHTML = 'found: ' + reportsFound;
	},

	getReportBody: function(reportId){
		var t = Tabs.Rpt;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.rid=reportId;
		params.side=t.report[reportId].sideId;
		if (params.side > -1) {
			new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fetchReport.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					t.displayReportBody(rslt,reportId);
				},
				onFailure: function (rslt) {},
			}, false);
		} else {
			unsafeWindow.alert ('I could not determine what kind of reports do - please send details to the developer');
		}
	},

	displayReportBody: function (rslt, reportId) {
		var t = Tabs.Rpt;
		var popReport = null;
		var rpt = t.report[reportId];
		var m = '';
		var fortmight = {u53: "4",u55: "7",u60: "1",u61: "2",u62: "3",    };
		var unitImg = [];
		var puipui=new Array();
		for (var ui = 1 ; ui<13; ui++)
		 puipui.push(uW.unitmight['unt'+ui]);
		puipui[53] = fortmight['u53'];
		puipui[55] = fortmight['u55'];
		puipui[60] = fortmight['u60'];
		puipui[61] = fortmight['u61'];
		puipui[62] = fortmight['u62'];
		ordre_grandeur=0;
		delta_perte=0;
		var perte_atk = 0;
		var perte_def = 0;
		for (var i=1;i<13;i++)
			unitImg[i] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+i+'_30_s34.jpg title="'+uW.unitcost['unt'+i][0]+'"></TD><TD>' + uW.unitcost['unt'+i][0].substr(0,10);
		for (var i=101;i<111;i++)
			unitImg[i] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+i+'_30.jpg title="'+uW.g_js_strings.monsterUnitsNames['m'+i]+'"></TD><TD>' + uW.g_js_strings.monsterUnitsNames['m'+i].substr(0,10);
	        unitImg[53] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_53_30.png></TD><TD>'+ uW.fortcost.frt53[0];
		unitImg[55] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_55_30.png></TD><TD>'+ uW.fortcost.frt55[0];
		unitImg[60] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_60_30.png></TD><TD>'+ uW.fortcost.frt60[0];
		unitImg[61] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_61_30.png></TD><TD>'+ uW.fortcost.frt61[0];
		unitImg[62] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_62_30.png></TD><TD>' + uW.fortcost.frt62[0];
		goldImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png></TD><TD>' + uW.g_js_strings.commonstr.gold;;
		foodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png></TD><TD>' + uW.g_js_strings.commonstr.food;
		woodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png></TD><TD>' + uW.g_js_strings.commonstr.wood;;
		stoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png></TD><TD>' + uW.g_js_strings.commonstr.stone;;
		oreImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png></TD><TD>' + uW.g_js_strings.commonstr.ore;;
		aetherstoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png></TD><TD>'+ uW.g_js_strings.commonstr.aetherstone;

		function buildHeader () {
			var h='<TABLE class=ptTab width=100%>';
			h+='<TR valign=top><TD align=left width=10%><B>';
			if (rpt.marchName == 'Anti-Scout' || rpt.marchName == 'Scout')
			 h+=uW.g_js_strings.commonstr.location+" " + uW.g_js_strings.modal_messages_viewreports_view.antiscoutingat+' ';
			else if (rpt.marchName == 'scout')
				h+=uW.g_js_strings.modal_messages_viewreports_view.scoutrpt+' ';
			else if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
				h+='Batalla en ';
			else if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport')
				h+=rpt.marchName+' de<BR />'+rpt.marchName+' a</B>';
			else if (rpt.marchName == 'Transport')
			  h+=rpt.marchName+' desde<BR />'+uW.g_js_strings.modal_messages_viewreports_view.transpto+'</B>';
			if (rpt.side0TileTypeText == 'Barb')
				h+=' Barb camp level ' + rpt.side0TileLevel;
			else if (rpt.side0TileTypeText != 'City')
				h+=' '+rpt.side0TileTypeText+' level'+ rpt.side0TileLevel+' ';
			h+='</B>';

			if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend' || rpt.marchName == 'Anti-Scout' || rpt.marchName == 'scout')
			 if (rslt['displayGlory']!==undefined)
			   h+='<br><B>'+uW.g_js_strings.commonstr.glory+' : <font color=red>'+rslt['glory']+'</font></B>';
				
			h+='</td>';
			if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport') {
				h+='<TD align=left width=1%>';
				if (Seed.player.name != rpt.side1Name)
					h+=rpt.side1Name;
				if (Seed.player.name != rpt.side0Name)
					h+='<BR />'+rpt.side0Name;
				h+='</TD>';
			}
			h+='<TD align=left width=5%>';

			if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport')
				h+='(<A onclick="ptGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a>)<BR />';
			h+='(<A onclick="ptGotoMap('+ rpt.side0XCoord +','+ rpt.side0YCoord +')">'+ rpt.side0XCoord +','+ rpt.side0YCoord +'</a>)</TD>';

			if (rpt.side0TileTypeText != 'City' && rpt.side0TileTypeText != 'Barb' && (rpt.marchName == 'Attack' || rpt.marchName == 'Defense')) {
				if (rslt['conquered']==1)
					h+='<TD><FONT color="#CC0000"><B>'+uW.g_js_strings.commonstr.conquered+'</B></font></td>';
				else if (rslt['conquered']==0)
					h+='<TD><FONT color="#66CC33"><B>in the conquered</B></font></td>';
			} else if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport') {
				h+='<TD align=left width=5%>'+rpt.side1CityName+'<BR />';
				if (rpt.side0CityName != '')
					h+=rpt.side0CityName+'</TD>';
				else
					h+=rpt.side0TileTypeText+' level '+ rpt.side0TileLevel+'</TD>';
			}
			h+='<TD align=right>' + formatUnixTime(rpt.reportUnixTime,'24hour') + '<BR />&nbsp;';
			if (rpt.side0Name==Seed.player.name || rpt.side1Name==Seed.player.name)
			  h+='<a onclick="DelReport('+ reportId +', false);ById(\'pkrpt'+ reportId +'\').style.display=\'none\';ById(\'pbShowOther_X\').click();"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="Delete my report"></a>';
			
			h+='&nbsp;'+uW.g_js_strings.modal_messages_viewreports_view.reportno+': ' + reportId + '</TD></TR></TABLE>';
			return h;
		}

		function handleunts () { // Troops sent to Reinforce or troops found on a Scout
			var hunts = '', th = '', tc = '', tf = '';
			if (rslt['unts'] != undefined) {
				if (rpt.marchName == 'Reinforce')
					th='<TABLE class=ptTab><TR><TH colspan=3 align=left>reinforcements sent</TH></TR>';
				else if (rslt['unts']['u1'] != undefined || rslt['unts']['u2'] != undefined || rslt['unts']['u3'] != undefined || rslt['unts']['u4'] != undefined || rslt['unts']['u5'] != undefined || rslt['unts']['u6'] != undefined || rslt['unts']['u7'] != undefined || rslt['unts']['u8'] != undefined || rslt['unts']['u9'] != undefined || rslt['unts']['u10'] != undefined || rslt['unts']['u11'] != undefined || rslt['unts']['u12'] != undefined)
					th='<TABLE class=ptTab><TR><TH colspan=3 align=left>'+uW.g_js_strings.commonstr.troops+'</TH></TR>';
				for (var i=1;i<13;i++)
					if (rslt['unts']['u'+i] != undefined)
						tc+='<TR><TD>' + unitImg[i] + '</TD><TD align=right>'+addCommas(rslt['unts']['u'+i])+'</TD></TR>';
				tf='</TABLE>';
			}
			if (tc != '')
				hunts = th + tc + tf;
			return hunts;
		}

		function handlersc () { // Resources brought with reinforcements or found on a Scout
			var hrsc = '', th = '', tc = '', tf = '';
			if (rslt['rsc']) {
				if (rslt['rsc']['r1'] > 0 || rslt['rsc']['r2'] > 0 || rslt['rsc']['r3'] > 0 || rslt['rsc']['r4'] > 0) {
					if (rpt.marchName == 'Reinforce')
						th='<TABLE class=ptTab><TR><TH colspan=3 align=left>resources sent</TH></TR>';
					else {
						th='<TABLE class=ptTab><TR><TH colspan=3 align=left>resources found</TH></TR>';
						if (rslt['gld'] > 0)
							tc+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommasInt(rslt['gld'])+'</TD></TR>';
					}
					if (rslt['rsc']['r1'] > 0)
						tc+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r1'])+'</TD></TR>';
					if (rslt['rsc']['r2'] > 0)
						tc+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r2'])+'</TD></TR>';
					if (rslt['rsc']['r3'] > 0)
						tc+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r3'])+'</TD></TR>';
					if (rslt['rsc']['r4'] > 0)
						tc+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r4'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hrsc = th + tc + tf;
			return hrsc;
		}

		function handlefrt () { // Fortifications found on a Scout
			var hfrt = '', th = '', tc = '', tf = '';
			if (rslt['frt'] != undefined) {
				if (rslt['frt']['f53'] != undefined || rslt['frt']['f55'] != undefined || rslt['frt']['f60'] != undefined || rslt['frt']['f61'] != undefined || rslt['frt']['f62'] != undefined) {
					th='<TABLE class=ptTab><TR><TH colspan=3 align=left>Defensas Encontradas</TH></TR>';
					if (rslt['frt']['f53'])
						tc+='<TR><TD>' + unitImg[53] + '</TD><TD align=right>'+addCommas(rslt['frt']['f53'])+'</TD></TR>';
					if (rslt['frt']['f55'])
						tc+='<TR><TD>' + unitImg[55] + '</TD><TD align=right>'+addCommas(rslt['frt']['f55'])+'</TD></TR>';
					if (rslt['frt']['f60'])
						tc+='<TR><TD>' + unitImg[60] + '</TD><TD align=right>'+addCommas(rslt['frt']['f60'])+'</TD></TR>';
					if (rslt['frt']['f61'])
						tc+='<TR><TD>' + unitImg[61] + '</TD><TD align=right>'+addCommas(rslt['frt']['f61'])+'</TD></TR>';
					if (rslt['frt']['f62'])
						tc+='<TR><TD>' + unitImg[62] + '</TD><TD align=right>'+addCommas(rslt['frt']['f62'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hfrt = th + tc + tf;
			return hfrt;
		}

		function handleblds (bType) {
		     if (rslt['blds'] != undefined) {
		
			var blds = rslt['blds']['b'+bType]; 
			var couleur='';
			if (bType==8) couleur=' style="background-color:red"';
			b = '<TR><TD '+couleur+'>'; arField = [], firstbld = true;
			b+=unsafeWindow.buildingcost["bdg"+bType][0]+'</TD><TD '+couleur+'>';
			for (var i=1; i<12; i++)
				arField[i]=0;
			for (var i=0; i < blds.length; i++)
				arField[blds[i]]++
			for (var i=11; i>0; i--) {
				if (arField[i] > 0) {
					if (firstbld)
						firstbld = false;
					else
						b+=', ';
					if (arField[i] > 1)
						b+=arField[i] + ' x ';
					b+=' ' + i;
				}
			}
			b+='</TD></TR>';
		       } else {
		        b='';
		       }
		       return b;
		}

    	if (t.popReport == null) {
		if (rpt.marchName == 'Reinforce') {
			t.popReport = new CPopup('pbShowRein', 0, 0, 425, 340, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:285px">';
		} else if (rpt.marchName == 'Transport') {
			t.popReport = new CPopup('pbShowTrans', 0, 0, 525, 240, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:185px">';
		} else if (rpt.marchName == 'Scout' && rslt['winner']==1 && rpt.sideId==1){
			t.popReport = new CPopup('pbShowOther', 0, 0, 600, 550, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:550px; height:550px; overflow-y:scroll">';
		} else {
			t.popReport = new CPopup('pbShowOther', 0, 0, 730, 380, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:730px; height:730px; overflow-y:scroll">';
		}
		t.popReport.centerMe (mainPop.getMainDiv());
	        t.popReport.autoHeight (true); 
              }
		m+=buildHeader();

		if (rpt.marchName == 'Transport') { // Transport
			m+='<TABLE class=ptTab>'; // Only transports have these in rslt, so handle them here
			if (parseInt(rslt['gold']) > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['gold'])+'</TD></TR>';
			if (parseInt(rslt['resource1']) > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['resource1'])+'</TD></TR>';
			if (parseInt(rslt['resource2']) > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['resource2'])+'</TD></TR>';
			if (parseInt(rslt['resource3']) > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['resource3'])+'</TD></TR>';
			if (parseInt(rslt['resource4']) > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['resource4'])+'</TD></TR>';
			if (parseInt(rslt['resource5'])> 0)
				m+='<TR><TD>'+aetherstoneImg+'</TD><TD align=right>'+addCommas(rslt['resource5'])+'</TD></TR>';
			m+='</TABLE>';
		}

		m+='<TABLE class=ptTab>';
		if ((rslt['winner']==1 && rpt.sideId==0) || (rslt['winner']==0 && rpt.sideId==1)) {
			if (rpt.marchName == 'Scout')
				m+='<TR><TD><FONT color="#CC0000"><B>'+uW.g_js_strings.modal_messages_viewreports_view.scoutfail+'</B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#CC0000"><B>'+uW.g_js_strings.commonstr.defeat+'</B></font></TD></TR>';
		}
		if (rslt['winner']==0 && rpt.sideId==0)
			m+='<TR><TD><FONT color="#66CC33"><B>'+uW.g_js_strings.commonstr.victory+' !</B></font></TD></TR>';
		if (rslt['winner']==1 && rpt.sideId==1)
			m+='<TR><TD><FONT color="#66BB33"><B>'+uW.g_js_strings.commonstr.victory+' !</B></font></TD></TR>';

		if (rslt['wall'] != undefined) {
		     if (rslt['wall'] > 0 && rslt['wall'] < 100)
				m+='<TR><TD>The attackers broke down the walls.</TD></TR>';
			else
				m+='<TR><TD>The attackers did not break the walls. The walls are '+rslt['wall']+'% damaged</TD></TR>';
		}
		m+= '</TABLE><BR />';
		if (rslt['wonGloryItem']) {
		  m+="<TABLE class=ptTab><TR><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/" + rslt['wonGloryItem'] + ".jpg></td><td colspan=2>"+unsafeWindow.ksoItems[rslt['wonGloryItem']].name+"</td></tr></TABLE><BR />";
		}
		
		if (rslt['throneRoomDrop']) {
		  var A=rslt['throneRoomDrop'];
		  faction=A.faction;
		  if (unsafeWindow.kocThroneItems[rslt['throneRoomDrop'].id]) {
       	           var name=unsafeWindow.kocThroneItems[rslt['throneRoomDrop'].id].name;
       	         
		  m+="<TABLE class=ptTab><TR><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/30/"+faction.replace('briton','britton')+"/"+faction.replace('briton','britton')+"_"+A.type+"_normal_1.png></td><td colspan=2>"+name+"</td></tr></TABLE><BR />";
		 }
		}


		if (rslt['loot'] != undefined) {
			m+='<TABLE class=ptTab>';
			if (rslt['loot'][0] > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['loot'][0])+'</TD></TR>';
			if (rslt['loot'][1] > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][1])+'</TD></TR>';
			if (rslt['loot'][2] > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][2])+'</TD></TR>';
			if (rslt['loot'][3] > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['loot'][3])+'</TD></TR>';
			if (rslt['loot'][4] > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['loot'][4])+'</TD></TR>';
			if (rslt['loot'][6] > 0)
				m+='<TR><TD>'+aetherstoneImg+'</TD><TD align=right>'+addCommas(rslt['loot'][6])+'</TD></TR>';
			if (rslt['loot'][5] !== undefined) {
				var q=unsafeWindow.Object.keys(rslt['loot'][5]);
				if (q.length>0) {
				 for(var u=0,y=q.length;u<y;++u){
				 C=q[u];
				 if (unsafeWindow.ksoItems[C]!==undefined) 
				  m+="<TR><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/" + C + ".jpg></td><td colspan=2>"+unsafeWindow.ksoItems[C].name+"</td></tr>";
			        }
			        }
				
			}
			m+='</TABLE><BR />';
		}

		if (rpt.marchName == 'Reinforce') {
			m+=handleunts();
			m+=handlersc();
		}

		if (rpt.marchName == 'Scout' && rslt['winner']==1) {
			m+='<TABLE class=ptTab width=100%><TR><TD width=50% align=left valign=top>';
			m+=handleunts();
			if (rpt.side0TileTypeText!='F.S.')  m+=handlefrt();
			m+=handlersc();
			m+='</TD><TD width=50% align=left valign=top>';
			if (rpt.side0TileTypeText!='F.S.') {
			m+='<TABLE class=ptTab width=100%>';
			if (rslt['lstlgn'] != undefined) {
				if (!rslt['lstlgn'])
					m+='<TR><TD>Last Login: unsaved</TD></TR>';
				else
					m+='<TR><TD>Last Login: ' + formatUnixTime(rslt['lstlgn']) + '</TD></TR>';
			}
			m+='<TR><TD>'+uW.g_js_strings.modal_messages_viewreports_view.knightskills+' : ';
			if (rslt['knt'] != undefined)
				m+=rslt['knt']['cbt'];
			else
				m+='None';
			m+='</TD></TR>';
			if (rslt['pop'] != undefined)
				m+='<TR><TD>Poblacin: ' + addCommas(rslt['pop']) + '</TD></TR>';
			if (rslt['hap'])
				m+='<TR><TD>Felicidad: ' + addCommas(rslt['hap']) + '</TD></TR></TABLE>';
			 if (rslt['blds'] != undefined) {
				m+='<b><a id=BORptBatClick>'+uW.g_js_strings.commonstr.buildings+'</a></b><br><TABLE class=ptTab id=BORptBat style="display:none">';
				for (var i=0; i<53; i++)
					if (rslt['blds']['b'+i] != undefined)
						m+=handleblds(i);
				m+='</TABLE>';
			 }
			 if (rslt['tch'] != undefined) {
				m+='<b><a id=BORptRechercheClick>'+uW.g_js_strings.commonstr.technology+'</a></b><br><TABLE class=ptTab id=BORptRecherche style="display:none">';
				for (var tl=1; tl < 17; tl++)
					if (tl != 7)
						m+='</TD></TR><TR><TD>'+researchLevels[tl].Name+'</TD><TD align=right>' + rslt['tch']['t'+tl] + '</TD></TR>';
				m+='</TABLE>';
			 }
                      }
		       m+='</TD></TR></TABLE>';
		}

		if (rslt['fght'] != undefined){
			m+='<TABLE class=ptTab width=100%><TR><TD width=50% align=left valign=top>';
			m+='<TABLE class=ptTab width=100%>';
			m+='<TR><TD colspan=4><B>'+uW.g_js_strings.commonstr.attacker+'</B> ('+rpt.side1Name+')';
			if (rslt['winner']==1)
				m+='<FONT color="#CC0000"><B> '+uW.g_js_strings.commonstr.winner+'</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
				m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.knightskills+' : ' + rslt['s1KCombatLv'] + '</TD></TR>';
			if (rslt['s1atkBoost']!== undefined)
			 if (100*rslt['s1atkBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.attackboosted+' : ' + 100*rslt['s1atkBoost'] + '%</TD></TR>';
			if (rslt['s1defBoost']!== undefined)
			 if (100*rslt['s1defBoost']>0) 
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.defenseboosted+' : ' + 100*rslt['s1defBoost'] + '%</TD></TR>';
			if (rslt['s1lifeBoost']!== undefined)
			 if (100*rslt['s1lifeBoost']>0)
			  m+='<TR><TD colspan=4>Vie : ' + 100*rslt['s1lifeBoost'] + '%</TD></TR>';
			if (rslt['s1guardianDefBoost']!== undefined)
			 if (100*rslt['s1guardianDefBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.guardian_defenseboosted+' : ' + 100*rslt['s1guardianDefBoost'] + '%</TD></TR>';
			if (rslt['s1guardianAtkBoost']!== undefined)
			 if ( 100*rslt['s1guardianAtkBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.guardian_attackboosted+' : ' + 100*rslt['s1guardianAtkBoost'] + '%</TD></TR>';
			if (rslt['s1guardianMarchBoost']!== undefined)
			 if (100*rslt['s1guardianMarchBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.guardian_marchboosted+' : ' + 100*rslt['s1guardianMarchBoost'] + '%</TD></TR>';
			m+='<TR><TD colspan=4><a href="javascript:void(0)" onclick="cm.utils.CoordinateLinkController.onClick(event)" class="coordinateLink">('+ rpt.side1XCoord +','+ rpt.side1YCoord +')</a> ' + rpt.side1CityName + '</TD></TR>';
			if (rslt['fght']["s1"] != undefined) {
				m+='<TR><TH></TH><TH align=left>'+uW.g_js_strings.commonstr.troops+'</TH><TH align=right>fought</TH><TH align=right>survived</TH><TH align=right>lost</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s1"]['u'+i] != undefined) {
						if (rslt['fght']["s1"]['u'+i][0] > rslt['fght']["s1"]['u'+i][1]) {
							perte_atk= perte_atk +(rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1])*puipui[i-1];
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</FONT></td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</td></tr>';
						}
					}
				}
			}
			m+='</TABLE><br>';
			// Bonus divers ^^^
			if (rslt['s1ThroneRoomBoosts']) {
			m+='<b><a id=BORptS1ThroneClick>Bonds throne room attacker</a></b><br><TABLE class=ptTab id=BORptS1Throne style="display:none">';
			  for (var i in rslt['s1ThroneRoomBoosts']) {
	
			   m+='<TR><TD><B>'+uW.cm.thronestats.effects[i][1]+'</B></td><td align=right>'+ rslt['s1ThroneRoomBoosts'][i] +' %</td></tr>'; 
			 
			  }
			m+='</TABLE>';
			}else{
				  m+='<b>No bond of the throne room</b>';
			}

			m+='</TD><TD width=50% align=left valign=top>';
			m+='<TABLE class=ptTab width=100%>';
			m+='<TR><TD colspan=4><B>'+uW.g_js_strings.commonstr.defenders+'</B> ('+rpt.side0Name+')';
			if (rslt['winner']==0)
				m+='<FONT color="#CC0000"><B> '+uW.g_js_strings.commonstr.winner+'</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
				m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.knightskills+' : ' + rslt['s0KCombatLv'] + '</TD></TR>';
			if (rslt['s0atkBoost'] !== undefined)
			 if (100*rslt['s0atkBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.attackboosted+' : ' + 100*rslt['s0atkBoost'] + '%</TD></TR>';
			if (rslt['s0defBoost'] !== undefined)
			 if (rslt['s0defBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.defenseboosted+' : ' + 100*rslt['s0defBoost'] + '%</TD></TR>';
			if (rslt['s0lifeBoost']!== undefined)
			 if (100*rslt['s0lifeBoost']>0)
			  m+='<TR><TD colspan=4>Vie : ' + 100*rslt['s0lifeBoost'] + '%</TD></TR>';
			if (rslt['s0guardianDefBoost']!== undefined)
			 if (100*rslt['s0guardianDefBoost']>0)
			 m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.guardian_defenseboosted+' : ' + 100*rslt['s0guardianDefBoost'] + '%</TD></TR>';
			if (rslt['s0guardianAtkBoost']!== undefined)
			 if (100*rslt['s0guardianAtkBoost']>0)
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.guardian_attackboosted+' : ' + 100*rslt['s0guardianAtkBoost'] + '%</TD></TR>';
			if (rslt['s0guardianMarchBoost']!== undefined)
			 if (100*rslt['s0guardianMarchBoost'])
			  m+='<TR><TD colspan=4>'+uW.g_js_strings.modal_messages_viewreports_view.guardian_marchboosted+' : ' + 100*rslt['s0guardianMarchBoost'] + '%</TD></TR>';
			if (rslt['rnds']!==undefined)
			   m+='<TR><TD colspan=4>rounds : ' + rslt['rnds'] + '</TD></TR>';
			if (rslt['fght']["s0"] != undefined) {
				m+='<TR><TH></TH><TH align=left>'+uW.g_js_strings.commonstr.troops+'</TH><TH align=right>fought</TH><TH align=right>survived</TH></TR>';


				for (var i=1;i<13;i++) {
					if (rslt['fght']["s0"]['u'+i] != undefined) {
						if (rslt['fght']["s0"]['u'+i][0] > rslt['fght']["s0"]['u'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</td></tr>';
						}
					}
				}
				// Dark Forest
							for (var i=101;i<111;i++) {
									if (rslt['fght']["s0"]['m'+i] != undefined) {
										if (rslt['fght']["s0"]['m'+i][0] > rslt['fght']["s0"]['m'+i][1]) {
											m+='<TR><TD>' + unitImg[i] + '</td>';
											m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['m'+i][0])+'</td>';
											m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['m'+i][1])+'</FONT></td></tr>';
										} else {
											m+='<TR><TD>' + unitImg[i] + '</td>';
											m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['m'+i][0])+'</td>';
											m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['m'+i][1])+'</td></tr>';
										}
									}
				}
				//
				for (var i=53;i<=55;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
				for (var i=60;i<=63;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
			} else
				m+='<TR><TD>'+uW.g_js_strings.modal_messages_viewreports_view.notroopsdef+'</TD></TR>';	
			m+='</TABLE><br>';
			// Bonus divers ^^^
			if (rslt['s0ThroneRoomBoosts']) {
			m+='<b><a id=BORptS0ThroneClick>Bonds defender throne room</a></b><br><TABLE class=ptTab id=BORptS0Throne style="display:none">';
			  for (var i in rslt['s0ThroneRoomBoosts']) {
	
			   m+='<TR><TD><B>'+uW.cm.thronestats.effects[i][1]+'</B></td><td align=right>'+ rslt['s0ThroneRoomBoosts'][i] +' %</td></tr>'; 
			 
			  }

			m+='</TABLE>';
			
			}else{
			  m+='<b>No bond of the throne room</b>'
			}
			m+='</TD></TR>';
			delta_perte = perte_atk - perte_def;
			delta_pos = 1;
			ordre_grandeur = 1; //par defaut: perte en k
			delta_perte = delta_perte/1000;
			if (delta_perte<0){
				delta_pos = -1; //plus de perte pour def
				delta_perte = Math.abs(delta_perte);
			}
			if (delta_perte>1000) { //perte en Mega
				ordre_grandeur = 2;
				delta_perte = entier_1dec(delta_perte/1000);
			}
			if (delta_perte<1) { // pertes inferiereures   1 k
				ordre_grandeur = 0;
				delta_perte = entier_1dec(delta_perte*1000);
			}
			if (ordre_grandeur == 1) { //perte en kilo => garde 1chiffre apres virgule
				delta_perte = entier_1dec(delta_perte);
			}
			// transforme les pertes en kilo (avec 1 chiffre derriere virgule)
			perte_atk = entier_1dec(perte_atk/1000);
			perte_def = entier_1dec(perte_def/1000);
			
			m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			// affichage 
			if ((delta_pos == 1) && (delta_perte != 0)) {
				m+='<TR><TD><FONT color="#000"><b>'+uW.g_js_strings.commonstr.might+' Perdio</b> ('+rpt.side1Name+') : </FONT><FONT color="#CC0000"> '+(perte_atk)+'k</FONT></TD><TD><FONT color="#00"><b>'+uW.g_js_strings.commonstr.might+' Perdio</b> ('+rpt.side0Name+') : '+perte_def+'k </FONT></TD></TR>';
				if (ordre_grandeur==2) {
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">Perdidas de :</FONT><FONT color="#CC0000"> '+delta_perte+'M</FONT></TD><TD></TD></TR></table>';
				} else if (ordre_grandeur==1){
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">Perdidas de :</FONT><FONT color="#CC0000"> '+delta_perte+'k </FONT></TD><TD></TD></TR></table>';
				} else if(ordre_grandeur==0){
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">Perdidas de :</FONT><FONT color="#CC0000"> '+delta_perte+'</FONT></TD><TD></TD></TR></table>';
				}
			}
			if ((delta_pos == -1) && (delta_perte != 0)) {
				m+='<TR><TD><FONT color="#000"><b>'+uW.g_js_strings.commonstr.might+' Perdio</b> ('+rpt.side1Name+') : '+perte_atk+'k</FONT></TD><TD><FONT color="#000"><b>'+uW.g_js_strings.commonstr.might+' Perdio</b> ('+rpt.side0Name+') : </FONT><FONT color="#CC0000"> '+perte_def+'k </FONT></TD></TR>';
				if (ordre_grandeur==2) {
					m+='<TR><TD></TD><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">Perdidas de :</FONT><FONT color="#CC0000"> '+delta_perte+'M</FONT></TD></TR></table>';
				} else if (ordre_grandeur==1){
					m+='<TR><TD></TD><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">Perdidas de :</FONT><FONT color="#CC0000"> '+delta_perte+'k</FONT></TD></TR></table>';
				} else if (ordre_grandeur==0){
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">Perdidas de :</FONT><FONT color="#CC0000"> '+delta_perte+'</FONT></TD><TD></TD></TR></table>';
				}
			}
			if (delta_perte == 0 && (perte_def>0 || perte_atk>0)) {
				m+='<TR><TD><FONT color="#000"><b>'+uW.g_js_strings.commonstr.might+' lost</b> ('+rpt.side1Name+') : '+perte_atk+'k</FONT></TD><TD><FONT color="#000"><b>'+uW.g_js_strings.commonstr.might+' lost</b> ('+rpt.side0Name+') : '+perte_def+'k </FONT></TD></TR></TABLE>';		
			}
		}

		m+='</DIV>';
		t.popReport.getMainDiv().innerHTML = m;
		t.popReport.getTopDiv().innerHTML = '<div class=showBadged><center><B>REPORTS</B></center></DIV>';
		t.popReport.show(true);            
    		t.popReport.autoHeight (true); 
    		if (ById('BORptS0ThroneClick')) {
				 ById('BORptS0ThroneClick').addEventListener('click', function () {
				    		  if (ById('BORptS0Throne').style.display=="none") {ById('BORptS0Throne').style.display="block";} else {ById('BORptS0Throne').style.display="none";}
				 },false);
    		}
    		if (ById('BORptS1ThroneClick')) {
		 ById('BORptS1ThroneClick').addEventListener('click', function () {
		    		  if (ById('BORptS1Throne').style.display=="none") {ById('BORptS1Throne').style.display="block";} else {ById('BORptS1Throne').style.display="none";}
		 },false);
    		}
    		if (ById('BORptBatClick')) {
		 ById('BORptBatClick').addEventListener('click', function () {
		    		  if (ById('BORptBat').style.display=="none") {ById('BORptBat').style.display="block";} else {ById('BORptBat').style.display="none";}
		 },false);
    		}
    		if (ById('BORptRechercheClick')) {
    		 ById('BORptRechercheClick').addEventListener('click', function () {
    		  if (ById('BORptRecherche').style.display=="none") {ById('BORptRecherche').style.display="block";} else {ById('BORptRecherche').style.display="none";}
    		 },false);
	      }	
	},

};

/*********************************** Alliance TAB ***********************************/
Tabs.Alliance = {
	tabOrder: 23,
	tabLabel: 'Alliance',
	myDiv:	null,
	sortBy:	'positionType',
	searchRunning:	false,
	state:	null,
	members: [],
	totalPages: 1,
	infoMembers: 1,
	content: '',

	init: function (div){
		var t = Tabs.Alliance;
		t.myDiv = div;
		t.myDiv.innerHTML = '<DIV class=ptstat>FUNCTIONS OF THE ALLIANCE</DIV><DIV class=ptentry><TABLE width=100%><TR align=center valign=center><TD class=xtab align=right width=10%>Sort by:&nbsp;' +
			'<SELECT id="idAMSortBy"><OPTION value="name">name</OPTION><OPTION value="positionType" SELECTED>position</OPTION><OPTION value="might">might</OPTION><OPTION value="cities">cities</OPTION>' +
			'<OPTION value="lastLogin">lastLogin</OPTION><OPTION value="dateJoined">dateJoined</OPTION><OPTION value="daysInPosition">daysInPosition</OPTION></SELECT></TD>' +
			'<TD class=xtab align=left><INPUT id=idAMList type=submit value="Members list" /></TD><TD class=xtab align=right><INPUT id=idADList type=submit value="list diplomacy"></TD></TR></TABLE></DIV>' +
			'<DIV class=ptstat><TABLE width=100% cellspacing=0><TR><TD class=xtab align=left width=125><DIV id=idAMSearched></DIV></TD></TD>' +
			'<TD class=xtab><TD class=xtab align=center><SPAN style="white-space:normal" id=idAMStatus>&nbsp;</span></TD></TD>' +
			'<TD class=xtab><TD class=xtab align=right width=125><DIV id=idAMFound></DIV></TD></TR></TABLE></DIV>' +
			'<DIV id="idAllResultsDiv" style="height:575px; max-height:575px; overflow-x:auto; overflow-y:auto; white-space:nowrap;"></DIV>';
		document.getElementById('idAMSortBy').addEventListener ('change', t.handleAMSortBy, false);
		document.getElementById('idAMList').addEventListener ('click', t.handleAMSearch, false);
		document.getElementById('idADList').addEventListener ('click', t.displayDiplomacies, false);
		return this.myDiv;
	},

	handleAMSortBy: function(){
		var t = Tabs.Alliance;
		t.sortBy = document.getElementById("idAMSortBy").value;
		if (parseInt(t.members.length) > 0)
			t.displayMembers();
	},

	handleAMSearch: function(){
		var t = Tabs.Alliance;
		if (t.searchRunning){
			t.searchRunning = false;
			t.stopSearch ('Busqueda Cancelada!');
			return;
		}
		document.getElementById('idAllResultsDiv').innerHTML ='';
		document.getElementById ('idAMList').value = 'stop search';
		document.getElementById('idAMStatus').innerHTML = 'Looking page 1';
		t.searchRunning = true;
		t.members=[];
		t.getMembers(1);
	},

	stopSearch: function (msg){
		var t = Tabs.Alliance;
		if (t.searchRunning || msg == 'Search Cancelled!')
			document.getElementById ('idAMStatus').innerHTML = '<FONT color=#ffaaaa>' + msg + '</FONT>';
		document.getElementById ('idAMList').value = 'Members list';
		t.searchRunning = false;
		if (parseInt(t.members.length) > 0)
			t.displayMembers();
	},

	getMembers: function (){
		var t = Tabs.Alliance;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pf = 0;

		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetInfo.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				t.infoMembers = rslt.allianceInfo.members;
				t.totalPages = 1 + parseInt(t.infoMembers / 10); // usually correct, but will be corrected by the callback
				document.getElementById("idAMSearched").innerHTML = '&nbsp;Alliance members: ' + t.infoMembers;
				document.getElementById('idAMStatus').innerHTML = 'Looking page 1 of ' + t.totalPages;
				t.getMembersCallback(1);
			},
			onFailure: function (rslt) {},
		});
	},

	getMembersCallback: function(page) {
		var t = Tabs.Alliance;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pageNo = page;
		params.pf = 0;
		document.getElementById('idAMStatus').innerHTML = 'Searching page ' + page + ' of ' + t.totalPages;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetMembersInfo.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				t.totalPages=parseInt(rslt.noOfPages);
				for (var k in rslt["memberInfo"]){
					t.members.push ({
						userId:					parseInt(rslt["memberInfo"][k]["userId"]),
						positionType:		parseInt(rslt["memberInfo"][k]["positionType"]),
						position:				officerId2FullString (parseInt(rslt["memberInfo"][k]["positionType"])),
						cities:					parseInt(rslt["memberInfo"][k]["cities"]),
						might:					parseInt(rslt["memberInfo"][k]["might"]),
						dateJoined:			rslt["memberInfo"][k]["dateJoined"],
						dateJoinedSort:	DateStringToSortString(rslt["memberInfo"][k]["dateJoined"], 'DD Mon YYYY'),
						daysInPosition:	rslt["memberInfo"][k]["daysInPosition"],
						name:						rslt["memberInfo"][k]["name"],
						genderAndName:	rslt["memberInfo"][k]["genderAndName"],
						fbuid:					parseInt(rslt["memberInfo"][k]["fbuid"]),
						lastLogin:			rslt["memberInfo"][k]["lastLogin"],
						lastLoginSort:	DateStringToSortString(rslt["memberInfo"][k]["lastLogin"], 'Mon DD, HH:MM AM'),
						provinceIds:		rslt["memberInfo"][k]["provinceIds"],
					});
				}
				t.displayMembers();
				if (parseInt(rslt.currentPage) < t.totalPages) {
					if (t.searchRunning)
						t.getMembersCallback(parseInt(rslt.currentPage)+1);
				} else
					t.stopSearch ('completed!');
			},
			onFailure: function (rslt) {},
		});
	},

	displayMembers: function (){
		var t = Tabs.Alliance;
		var results = document.getElementById("idAllResultsDiv");
		if(!t.members.length) {
			results.innerHTML = '<center>None found</center>';
			return;
		}
		var pageMembers = t.members.length;
		var myMembers = []; // copy the official array as it might still be being populated
		for (var i=0; i<pageMembers;i++) {
			myMembers[i] = [];
			var mem = t.members[i];
			myMembers[i].fbuid = mem.fbuid;
			myMembers[i].name = mem.name;
			myMembers[i].genderAndName = mem.genderAndName;
			myMembers[i].positionType = mem.positionType;
			myMembers[i].position = mem.position;
			myMembers[i].might = mem.might;
			myMembers[i].cities = mem.cities;
			myMembers[i].lastLogin = mem.lastLogin;
			myMembers[i].lastLoginSort = mem.lastLoginSort;
			myMembers[i].dateJoined = mem.dateJoined;
			myMembers[i].dateJoinedSort = mem.dateJoinedSort;
			myMembers[i].daysInPosition = mem.daysInPosition;
		}
		if (t.sortBy == 'name') {
			myMembers.sort(function(a, b){
				var sortA=a.name.toLowerCase(), sortB=b.name.toLowerCase()
				if (sortA < sortB)
					return -1
				if (sortA > sortB)
					return 1
				return 0
			});
		} else if (t.sortBy == 'positionType') {
			myMembers.sort(function (a,b){return 100000000*(a.positionType-b.positionType) + b.might-a.might});
		} else if (t.sortBy == 'cities') {
			myMembers.sort(function (a,b){return 100000000*(b.cities-a.cities) + b.might-a.might});
		} else if (t.sortBy == 'might') {
				myMembers.sort(function (a,b){return b.might-a.might});
		} else if (t.sortBy == 'lastLogin') {
			myMembers.sort(function (a,b){return b.lastLoginSort-a.lastLoginSort});
		} else if (t.sortBy == 'dateJoined') {
			myMembers.sort(function (a,b){return b.dateJoinedSort-a.dateJoinedSort});
		} else if (t.sortBy == 'daysInPosition') {
			myMembers.sort(function (a,b){return 100000000*(b.daysInPosition-a.daysInPosition) + b.might-a.might});
		}

		t.content = '<center><table><thead><th>name</th><th>load</th><th>might</th><th>cities</th><th>Last Login</th><th>Join Date</th><th>Days in charge</thead><tbody>';
		for (var i=0; i<pageMembers;i++) {
			var mem = myMembers[i];
			t.content += '<tr align=right><td><A target="_tab" href="http://www.facebook.com/profile.php?id='+ mem.fbuid +'">'+mem.genderAndName+'</a></td><td>'+mem.position+'</td>' +
				'<td>'+addCommas (mem.might)+'</td><td align=center>'+mem.cities+'</td><td>'+ mem.lastLogin+'</td><td>'+ mem.dateJoined+'</td><td align=right>'+ mem.daysInPosition +
				'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>';
		}
		t.content += '</tbody></table></center>';
		results.innerHTML = t.content;
		document.getElementById("idAMFound").innerHTML = 'members found: ' + pageMembers;
	},

	displayDiplomacies: function () {
		var allianceName = '';
		var membersCount = '';
		document.getElementById('idAllResultsDiv').innerHTML ='';
		document.getElementById('idAMSearched').innerHTML ='';
		document.getElementById('idAMStatus').innerHTML ='&nbsp;';
		document.getElementById('idAMFound').innerHTML ='';
		var m = '<CENTER><TABLE class=xtab><TR><TD valign=top><TABLE class=xtab><TR><TD colspan=2 style=\'background: #33CC66;\' align=center><B>friendly</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['friendly'] == null)?'<TR><TD colspan=2>There were no friendly...</TD></TR>':'<TR><TD><B>Name of alliance</B></TD><TD><B>Miembros</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['friendly']){
			allianceName = Seed.allianceDiplomacies['friendly'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['friendly'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '</TABLE></TD><TD valign=top><TABLE class=xtab><TR><TD colspan=2 style=\'background: #FF6633;\' align=center><B>Friendly towards them</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['friendlyToThem'] == null)?'<TR><TD colspan=2>There were no friendly towards them...</TD></TR>':'<TR><TD><B>Name of alliance</B></TD><TD><B>members</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['friendlyToThem']){
			allianceName = Seed.allianceDiplomacies['friendlyToThem'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['friendlyToThem'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '<TR><TD colspan=2 style=\'background: #FF6633;\' align=center><B>Friendly to us</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['friendlyToYou'] == null)?'<TR><TD colspan=2>There were no friendly towards us</TD></TR>':'<TR><TD><B>Name of alliance</B></TD><TD><B>members</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['friendlyToYou']){
			allianceName = Seed.allianceDiplomacies['friendlyToYou'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['friendlyToYou'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '</TABLE></TD><TD valign=top><TABLE class=xtab><TR><TD colspan=2 style=\'background: #CC0033;\' align=center><B>Hostile</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['hostile'] == null)?'<TR><TD colspan=2>There were no hostile...</TD></TR>':'<TR><TD><B>name alliances</B></TD><TD><B>members</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['hostile']){
			allianceName = Seed.allianceDiplomacies['hostile'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['hostile'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '</TABLE></TD></TR></TABLE></CENTER>';
		document.getElementById('idAllResultsDiv').innerHTML = m;
	},

	hide: function (){
	},

	show: function (){
	},
}

/*************************************** MARCHES TAB ************************************************/
Tabs.Marches = {
  tabOrder : 28,
  tabLabel : 'Inc/Mar/Enc',
  cont:null,
  displayTimer:null,
	curTabBut : null,
  curTabName : null,
  widescreen:true,

  init : function (div){
     var t = Tabs.Marches;
    uW.pr56Recall = t.butRecall;
    uW.r8x6Home = t.butSendHome;
    uW.cancelMarch = t.butcancelmarch;

    t.cont = div;
   var main = '<TABLE class=ptTab align=center><TR><TD><INPUT class=pbSubtab ID=ptmrchSubN type=submit value="incoming"></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubM type=submit value='+uW.g_js_strings.commonstr.marching+'></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubR type=submit value='+uW.g_js_strings.commonstr.reinforced+'></td></tr></table><HR class=ptThin>';
    main +='<DIV id=ptMarchOutput style="margin-top:10px; background-color:white; height:680px; overflow:scroll;"></div>';

    t.cont.innerHTML = main;
    t.marchDiv = document.getElementById('ptMarchOutput');
    document.getElementById('ptmrchSubN').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubR').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubM').addEventListener('click', e_butSubtab, false);
    changeSubtab (document.getElementById('ptmrchSub'+Options.curMarchTab));

    function e_butSubtab (evt){
      changeSubtab (evt.target);
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pbSubtab';
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pbSubtab pbSubtabSel';
      but.disabled=true;
      t.curTabName = but.id.substr(9);
	  Options.curMarchTab = t.curTabName;
       saveOptions();
      t.show ();
    }
  },

  hide : function (){
    var t = Tabs.Marches;
    clearTimeout (t.displayTimer);
  },

  show : function (){
    var t = Tabs.Marches;
    clearTimeout (t.displayTimer);
    if (t.curTabName == 'R')
      t.showReinforcements();
    else if (t.curTabName == 'M')
      t.showMarches();
    else
      t.showIncoming();
  },

  /***   Incoming SUBTAB  ***/
      showIncoming : function (){
    var t = Tabs.Marches;
    t.marchDiv.innerHTML =null;

         var z = '<TABLE id=pdincoming cellSpacing=10 width=100% height=0% class=pbTab>';

       for (k in Seed.queue_atkinc) {
          if(Seed.queue_atkinc.length !=0){
       		var now = unixTime();
				var icon, status, FROM, cityname, FROMmight, marchdir, marchtime;
               		var marchType = parseInt(Seed.queue_atkinc[k]["marchType"]);
               		var marchStatus = parseInt(Seed.queue_atkinc[k]["marchStatus"]);

               		for (var i=0; i<Seed.cities.length;i++) {
        	       			if (Seed.cities[i][0] == Seed.queue_atkinc[k]["toCityId"]) cityname = Seed.cities[i][1];
               		}

               		if (Seed.queue_atkinc[k]["destinationUnixTime"] < now || marchStatus == 8)
					marchdir = "back";
				else
					marchdir = "marching";

               		var destinationUnixTime = Seed.queue_atkinc[k]["arrivalTime"] - now;
				if(destinationUnixTime > 0)
                		marchtime = timestr(destinationUnixTime, true)
				else
					marchtime = 'completed';

          if (marchType != 3 && marchType !=4){
               			var player = Seed.players['u'+Seed.queue_atkinc[k]["fromPlayerId"]]
					FROM = player.n;
					FROMmight = player.m;
          }
          else {
               		for (players in Seed.players){
               				if (marchType == 3 || marchType == 4){
                        if (('u'+Seed.queue_atkinc[k]["pid"]) == players){
                              FROM = Seed.players[players]["n"];
                              FROMmight = Seed.players[players]["m"];
                        }
                      }
               			}
          }

       if (marchType == 2 && marchStatus == 2) marchType = 102;

        switch (marchType) {
					case 1: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status=uW.g_js_strings.commonstr.transport;break;
					case 2: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status=uW.g_js_strings.commonstr.reinforce	;break;
					case 3: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/scouting.jpg";status=uW.g_js_strings.commonstr.scout;break;
					case 4: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status=uW.g_js_strings.commonstr.attack;break;
					case 9: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status=uW.g_js_strings.commonstr.attack;break;
					case 5: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status=uW.g_js_strings.commonstr.reassign;break;
					case 100: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg";status=uW.g_js_strings.commonstr.returning;break;
					case 102: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status=uW.g_js_strings.commonstr.encamped;break;
 				}

					if(status == uW.g_js_strings.commonstr.encamped)
					z += '<TD width="10px"><A onclick="r8x6Home('+ Seed.queue_atkinc[k].marchId +')"><img src='+ icon +'></a></td>';
					else
               		z += '<TD width="10px"><img src='+ icon +'></td>';
               		z += '<TD width="40px">'+ status +'</td>';
               		z += '<TD>' + cityname + '</td>';
               		z += '<TD>'+ marchtime +'</td>';
				z +='<TD>'+uW.g_js_strings.commonstr.from+': ' + FROM + '</td>';
				z +='<TD>'+uW.g_js_strings.commonstr.might+': ' + addCommas(FROMmight) + '</td>';
				if (Seed.queue_atkinc[k]["knt"] != undefined) z +='<TD>'+uW.g_js_strings.commonstr.knight+': '+ Seed.queue_atkinc[k]["knt"]["cbt"]+'</td>';

				if (Seed.queue_atkinc[k]["gold"] > 0) z += '<TD>'+uW.resourceinfo.rec0 +': '+ addCommas(Seed.queue_atkinc[k]["gold"]) +'</td>';
				if (Seed.queue_atkinc[k]["resource1"] > 0) z += '<TD>'+uW.resourceinfo.rec1 +': '+ addCommas(Seed.queue_atkinc[k]["resource1"]) +'</td>';
				if (Seed.queue_atkinc[k]["resource2"] > 0) z += '<TD>'+uW.resourceinfo.rec2 +': '+ addCommas(Seed.queue_atkinc[k]["resource2"]) +'</td>';
				if (Seed.queue_atkinc[k]["resource3"] > 0) z += '<TD>'+uW.resourceinfo.rec3 +': '+ addCommas(Seed.queue_atkinc[k]["resource3"]) +'</td>';
				if (Seed.queue_atkinc[k]["resource4"] > 0) z += '<TD>'+uW.resourceinfo.rec4 +': '+ addCommas(Seed.queue_atkinc[k]["resource4"]) +'</td>';

        		    for(i=1; i<13; i++){
					if(Seed.queue_atkinc[k]["unit"+i+"Count"] > 0 && marchdir == "going") z += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkinc[k]["unit"+i+"Count"]) +'</td>';
					if(Seed.queue_atkinc[k]["unit"+i+"Return"] > 0 && marchdir == "returning") z += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkinc[k]["unit"+i+"Return"]) +'</td>';
 				}

				if (marchType == 3)
					if (Seed.queue_atkinc[k]["unts"]["u3"] > 0) z += '<TD>'+unsafeWindow.unitcost.unt3[0]+': '+ addCommas(Seed.queue_atkinc[k]["unts"]["u3"]) +'</td>';
 				if (marchType == 4){
					for(ui=1; ui<13; ui++){
						if (Seed.queue_atkinc[k]["unts"]["u"+ui] > 0) z += '<TD>'+ unsafeWindow.unitcost['unt'+ui][0] +': '+ addCommas(Seed.queue_atkinc[k]["unts"]["u"+ui]) +'</td>';
 					}
				}

               		z += '</tr>';
              }
     }
     z += '</table>';
     t.marchDiv.innerHTML = z;

     t.displayTimer = setTimeout (t.showIncoming, 500);
  },

  /***   MARCHES SUBTAB  ***/
  showMarches : function (){
    var t = Tabs.Marches;
    t.marchDiv.innerHTML =null;
      var updatemarch = Seed.queue_atkp;

      var  m = '<TABLE id=pdmarches cellSpacing=10 width=200px height=0% class=pbTab>';
     if (t.widescreen) m += '<TR><TD><INPUT id=Wide type=checkbox checked=true>widescreen</td>';
     else  m += '<TR><TD><INPUT id=Wide type=checkbox unchecked=true>widescreen</td></tr></table>';
     m+='<TABLE id=pdmarches cellSpacing=10 width=100% height=0% class=pbTab>';
     for (var c=0; c< Seed.cities.length;c++) {
     		cityname = Seed.cities[c][1];
     		cityID = 'city' + Seed.cities[c][0];
    		number=0;

    		if (Seed.queue_atkp[cityID].length !=0) m+= '<TR><TD colspan=5 style=\'background: #99CCFF;\' align=center><B>' + cityname +': </b></td></tr>';
  		    for (k in Seed.queue_atkp[cityID]){
  				 if (Seed.queue_atkp[cityID].length !=0) {
  				    var marchID = new String(k);
  				    marchID = marchID.substr(1);
  				    var marchType = parseInt(Seed.queue_atkp[cityID][k]["marchType"]);
  				    var marchStatus = parseInt(Seed.queue_atkp[cityID][k]["marchStatus"]);
  				    var now = unixTime();
  				    cityTo=null;
  				    number++;
					var icon, status, type, cityTo, knight, marchtime;

  				    for (var i=0; i<Seed.cities.length;i++) {
  				    		if (Seed.cities[i][2] == Seed.queue_atkp[cityID][k]["toXCoord"] && Seed.cities[i][3] == Seed.queue_atkp[cityID][k]["toYCoord"]) cityTo = Seed.cities[i][1];
  				    }
  				    var destinationUnixTime = Seed.queue_atkp[cityID][k]["destinationUnixTime"] - now;
  				    var returnUnixTime = Seed.queue_atkp[cityID][k]["returnUnixTime"] - now;
  				    var encampedUnixTime = now - Seed.queue_atkp[cityID][k]["destinationUnixTime"];
					var restingUnixTime = now - Seed.queue_atkp[cityID][k]["returnUnixTime"];

  				    if (Seed.queue_atkp[cityID][k]["destinationUnixTime"] > now)
						marchtime = timestr(destinationUnixTime, true);
  				    else
						marchtime = timestr(returnUnixTime, true);

  				    if (Seed.queue_atkp[cityID][k]["destinationUnixTime"] < now && marchType == 2)
						marchtime = timestr(encampedUnixTime, true);
					if (Seed.queue_atkp[cityID][k]["returnUnixTime"] < now && marchType == 9)
						marchtime = timestr(restingUnixTime, true);

  				    if (Seed.queue_atkp[cityID][k]["destinationUnixTime"] < now || marchStatus == 8)
						type = "returning";
  				    else
						type = "going";

					if(Seed.queue_atkp[cityID][k]["destinationUnixTime"] < now){
						if (marchStatus == 8)
							marchtime = timestr(returnUnixTime, true);
						if (type =="returning" && marchType == 2 && marchStatus != 2)
							marchtime = timestr(returnUnixTime, true);
						if (type =="returning" && marchType == 4 && marchStatus == 2)
							marchtime = timestr(returnUnixTime, true);
						if (marchStatus == 2 && marchType !=2)
							marchtime = timestr(returnUnixTime, true);
					}
  				    if (parseInt(Seed.queue_atkp[cityID][k]["marchType"]) == 4 && marchStatus == 2)
						marchtime = timestr(destinationUnixTime, true);;


					if (type =="returning" && marchType != 2)
						marchType = 8;
  				    if (type =="returning" && marchType == 2 && marchStatus == 2)
						marchType = 102;
  				    if (type =="returning" && marchType == 2 && marchStatus != 2)
						marchType = 8;
  				    if (marchStatus == 3)
							marchType = 103;
					if (marchStatus == 4)
							marchType = 104;


  				    if (parseInt(Seed.queue_atkp[cityID][k]["marchType"]) == 4 && marchStatus == 2) {
  						marchType = 102;
  						marchtime = timestr(encampedUnixTime, true)
  				    }

  				    switch (marchType) {
  					    case 1: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status=uW.g_js_strings.commonstr.transport;break;
  					    case 2: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status=uW.g_js_strings.commonstr.reinforce;break;
  					    case 3: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/scouting.jpg";status=uW.g_js_strings.commonstr.scout;break;
  					    case 4: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status=uW.g_js_strings.commonstr.attack;break;
  					    case 5: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status=uW.g_js_strings.commonstr.reassign;break;
  					    case 8: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg";status=uW.g_js_strings.commonstr.returning;break;
  					    case 9: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status=uW.g_js_strings.commonstr.raid;break;
  					    case 102: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status=uW.g_js_strings.commonstr.encamped;break;
						case 103: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_stopped_desat.png";status=unsafeWindowg_js_strings.attack_generatequeue.raidstopped;break;
						case 104: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png";status=uW.g_js_strings.attack_generatequeue.raidresting;break;
   				    }

  				    if (Seed.queue_atkp[cityID][k]["knightId"] !=0){
  				    	for (i in Seed.knights[cityID]) {
  				    			if (i == ("knt" + Seed.queue_atkp[cityID][k]["knightId"]) ) knight = Seed.knights[cityID][i]["combat"];
  				    	}
  				    } else knight = null;

  				    m += '<TR><TD>'+ number +'</td>';
  				   if (status=="Encamped" && !t.isMyself(Seed.queue_atkp[cityID][k].fromPlayerId))
						m += '<TD><A onclick="r8x6Home('+ marchID +')"><img src='+ icon +'></a></td>';
  				    else if(status=='Encamped' && t.isMyself(Seed.queue_atkp[cityID][k].fromPlayerId))
						m += '<TD><A onclick="pr56Recall('+ marchID +')"><img src='+ icon +'></a></td>';
					else if(status=='Returning' || status=="Stopped" || status=="Resting")
						m += '<TD><img src='+ icon +'></td>';
					else
						m += '<TD><A onclick="cancelMarch('+ marchID +')"><img src='+ icon +'></a></td>';
  				    m += '<TD width="40px">'+ status +'</td>';
  				    m += '<TD>'+ marchtime +'</td>';

  				    if (cityTo == null)
						m += '<TD style="padding-right:10px;">'+ coordLink(Seed.queue_atkp[cityID][k]["toXCoord"],Seed.queue_atkp[cityID][k]["toYCoord"]) + '</td>';
  				    else
						m += '<TD style="padding-right:10px;">'+ cityTo +'</td>';

  				    if (knight != null)  m += '<TD>'+uW.g_js_strings.commonstr.knight+': '+ knight +'</td>';

  				    if (Seed.queue_atkp[cityID][k]["toTileType"] == 11) m+='<TD>lv. Lago: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
  				    else if (Seed.queue_atkp[cityID][k]["toTileType"] == 20) m+='<TD>lv. Pradera: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
  				    else if (Seed.queue_atkp[cityID][k]["toTileType"] == 30) m+='<TD>lv. Colina: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
  				    else if (Seed.queue_atkp[cityID][k]["toTileType"] == 40) m+='<TD>lv. Montaa: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
  				    else if (Seed.queue_atkp[cityID][k]["toTileType"] == 50) m+='<TD>lv. Planicie: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
  					else if (Seed.queue_atkp[cityID][k]["toCityId"] ==0) m +='<TD>'+uW.g_js_strings.commonstr.barbariancamp+' '+uW.g_js_strings.commonstr.lvl+': '+Seed.queue_atkp[cityID][k]["toTileLevel"]+'</td>';

  				    if (Seed.queue_atkp[cityID][k]["gold"] > 0) m += '<TD>'+uW.resourceinfo.rec0 +': '+ Seed.queue_atkp[cityID][k]["gold"] +'</td>';
  				    if (Seed.queue_atkp[cityID][k]["resource1"] > 0) m += '<TD>'+uW.resourceinfo.rec1 +': '+ addCommas(Seed.queue_atkp[cityID][k]["resource1"]) +'</td>';
  				    if (Seed.queue_atkp[cityID][k]["resource2"] > 0) m += '<TD>'+uW.resourceinfo.rec2 +': '+ addCommas(Seed.queue_atkp[cityID][k]["resource2"]) +'</td>';
  				    if (Seed.queue_atkp[cityID][k]["resource3"] > 0) m += '<TD>'+uW.resourceinfo.rec3 +': '+ addCommas(Seed.queue_atkp[cityID][k]["resource3"]) +'</td>';
  				    if (Seed.queue_atkp[cityID][k]["resource4"] > 0) m += '<TD>'+uW.resourceinfo.rec4 +': '+ addCommas(Seed.queue_atkp[cityID][k]["resource4"]) +'</td>';

  				    for(i=1; i<13; i++){
						if(Seed.queue_atkp[cityID][k]["unit"+i+"Count"] > 0 && type == "going") m += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkp[cityID][k]["unit"+i+"Count"]) +'</td>';
						if(Seed.queue_atkp[cityID][k]["unit"+i+"Return"] > 0 && type == "returning") m += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkp[cityID][k]["unit"+i+"Return"]) +'</td>';
 					}
					m += '</tr>';
   			  }
  		    }
  	}
  	m += '</table>';
  	t.marchDiv.innerHTML = m;

  	if (t.widescreen==false) document.getElementById('ptMarchOutput').style.maxWidth = '740px';
  	else document.getElementById('ptMarchOutput').style.maxWidth = '1100px';

  	document.getElementById('Wide').addEventListener('click', function(){
  		t.widescreen=document.getElementById('Wide').checked;
  	  	}, false);

    t.displayTimer = setTimeout (t.showMarches, 500);
    },

	isMyself: function(userID){
		if(!Seed.players["u"+userID])
			return false;
		if(Seed.players["u"+userID].n == Seed.player.name)
			return true;
		else
			return false;
		return false;
	},

    butcancelmarch: function(marchID){
    	 var t = Tabs.Marches;
    	 	 var params = uW.Object.clone(uW.g_ajaxparams);
    	 	 params.mid = marchID;
     	 	 for (var c=0; c<Cities.numCities; c++){
    	 	   var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
    	 	   if (matTypeof(que)=='array')
    	 	     continue;
    	 	   for (k in que){
    	 	     if (k == 'm'+marchID){
    	 	       params.cid = Cities.cities[c].id;
    	 	       break;
    	 	     }
    	 	   }
    	 	 }

    	 	 new AjaxRequest(uW.g_ajaxpath + "ajax/cancelMarch.php" + uW.g_ajaxsuffix, {
    	 	     method: "post",
    	 	     parameters: params,
    	 	     onSuccess: function (rslt) {
    	 	     var march = uW.seed.queue_atkp["city" + params.cid]["m" + params.mid];
    	 	     march.marchStatus = 8;
    	 	      var marchtime = parseInt(march.returnUnixTime) - parseInt(march.destinationUnixTime);
    	 	      var ut = unixTime();
    	 	      if (uW.seed.playerEffects.returnExpire > unixtime())
    	 	        marchtime *= 0.5
    	 	       march.returnUnixTime = ut + marchtime;
    	 	       march.destinationUnixTime = ut;
    	 	       march.marchUnixTime = ut - marchtime;
    	 	       if (notify != null)
    	 	         notify(rslt.errorMsg);
    	 	     },
    	 	     onFailure: function () {
    	 	       if (notify != null)
    	 	         notify(rslt.errorMsg);
    	 	     },
    	 	 });

  },



  /***  REINFORCEMENTS SUBTAB  ***/
  showReinforcements : function (){
    var rownum = 0;
    var names = ['SupplyTroop', 'Militiaman.', 'Scout.', 'Pikeman.', 'Swordsman.', 'archers.', 'Cavalry', 'HeavyCavalry.', 'SupplyWagons', 'Ballista.', 'BatteringRam', 'Catapult.'];
    var t = Tabs.Marches;
      clearTimeout (t.displayTimer);

// TODO FIX:    Troops show as encamped even if they are here yet (check destinationUnixTime)

/***
var s = 'OUTGOING:<BR>';
for (var c=0; c<Cities.numCities; c++){
  var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
  if (matTypeof(que)=='array')
    continue;

s += 'City: '+  Cities.cities[c].name + ': <BR>';

  for (k in que){
    march = que[k];
    var mid = k.substr(1);
    s += mid +' DEST: '+ march.toXCoord +','+ march.toYCoord + '  <INPUT type=submit value="Recall" onclick="pr56Recall('+ mid +')"><BR>'
  }
}
t.cont.innerHTML = s;
t.displayTimer = setTimeout (t.show, 10000);
return;
***/

    function clickShowRemaining (){
      checkBox = document.getElementById('idCheck2');
      if (checkBox.checked)
        Options.encRemaining = false;
      else
        Options.encRemaining = true;
      t.show ();
    }

	enc = {};
    numSlots = 0;

    if (matTypeof(Seed.queue_atkinc) != 'array'){
      for (k in Seed.queue_atkinc){
        march = Seed.queue_atkinc[k];
        if (march.marchType == 2){
          ++numSlots;
          city = march.toCityId;
          from = march.fromPlayerId;
          if (!enc[city])
            enc[city] = {};
          if (!enc[city][from])
            enc[city][from] = [];
          s = {};
          s.knight = parseInt (march.knightCombat);
          s.marchId = k.substr(1);
          s.troops = [];
          for (i=1; i<13; i++){
            if (Options.encRemaining)
              s.troops[i] = parseInt (march['unit'+ i +'Return']);
            else
              s.troops[i] = parseInt (march['unit'+ i +'Count']);
          }
          enc[city][from].push (s);
        }
      }
    }
    s = '<div class=ptstat>Showing troops camped in each of the embassies.</div><BR>';
    if (numSlots == 0){
      s += '<BR><CENTER><B>No troops camped.</b></center>';
    } else {
      s += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;}</style>';
      s += '<TABLE cellspacing=0 width=100%><TR align=center><TD align=left width=16%><B>player (Cab.)</b></td>';

      for (k=0; k<names.length; k++)
        s += '<TD width=7%><B>' + names[k] + '</b></td>';
      s += '</tr>';

      tot = [];
      for (i=0; i<13; i++)
        tot[i] = 0;
      for (c in Cities.cities){
        dest = Cities.cities[c].id;
        if (enc[dest]){
          s+= '<TR><TD class=xtab><BR></td></tr>';
          s+= '<TR><TD class="city" colspan=13 align=center><B>'+ Cities.cities[c].name +'</b></td></tr>';
          for (p in enc[dest]){
            try {
              player = Seed.players['u'+p].n;
            } catch (err){
              player = '???';
            }
            for (m=0; m<enc[dest][p].length; m++){
				var march = enc[dest][p][m];
              knight = '';
              if (march.knight > 0)
                knight = ' ('+ march.knight +')';
// TODO: Only allow 'send home' if troops are here now  (marchStatus = ?)
              s += '<TR align=right><TD align=left>'+ player + knight +' <A><SPAN style="color:red"; onclick="r8x6Home('+ march.marchId +')">return</span></a></td>'
               for (i=1; i<13; i++){
                s += '<TD>'+ march.troops[i]  +'</td>';
                tot[i] += march.troops[i];
              }
              s += '</tr>';

            }
          }
        }
      }
      s += '<TR><TD colspan=13><BR><BR></td></tr><TR align=right><TD class="tot" align=left><B>TOTAL:</b></td>';
      for (i=1; i<13; i++)
        s+= '<TD class="tot">'+ tot[i] +'</td>';
      s += '</tr></table>';
    }

    s += '<BR><BR><INPUT type=CHECKBOX id=idCheck2 '+ (Options.encRemaining?'':' CHECKED ') +'> Show source of troops';
    s += '<BR><BR><DIV style="font-size:10px">NOTE: You must reload to show troops camped KofC or troops left after a battle.</div>';
    t.marchDiv.innerHTML = s;
    checkBox = document.getElementById('idCheck2');
    checkBox.addEventListener('click', clickShowRemaining, false);
    t.displayTimer = setTimeout (t.show, 10000);
  },


  butRecall : function (marchId){
    var t = Tabs.Marches;
    logit ("CANCELLING: "+ marchId);
    t.ajaxRecall (marchId);
  },

  butSendHome : function (marchId){
    var t = Tabs.Marches;
	alert("Send reinforcement troops home "+marchId);
    logit ("SEND HOME: "+ marchId);
    t.ajaxSendHome (marchId, function(r){t.show(); logit("AJAX RESULT: "+ r)});
  },


  /***
  // not working, returns 'invalid parameters' :(
  ajaxCancelMarch : function (marchId, notify){
    var params = uW.Object.clone(uW.g_ajaxparams);
logit ('ajaxCancelMarch: '+ marchId);
    for (var c=0; c<Cities.numCities; c++){
      var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
      if (matTypeof(que)=='array')
        continue;
      for (k in que){
        if (k == 'm'+marchId){
          params.cid = Cities.cities[c].id;
          params.cityId = Cities.cities[c].id;
          break;
        }
      }
    }
    params.marchId = marchId;
    params.mid = 'm'+ marchId;
    params.requestType = "CANCEL_MARCH";
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/cancelMarch.php" + uW.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          if (notify != null)
            notify(rslt.errorMsg);
        },
        onFailure: function () {
          if (notify != null)
            notify(rslt.errorMsg);
        },
    });
  },
***/





  ajaxSendHome : function (marchId, notify){
logit ('ajaxSendHome: '+ marchId);
    var march = Seed.queue_atkinc['m'+ marchId];
    if (march == null){
      notify ('March not found!');
      return;
    }
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.mid = marchId;
    params.cid = march.toCityId;
    params.fromUid = march.fromPlayerId;
    params.fromCid = march.fromCityId;

   new MyAjaxRequest(uW.g_ajaxpath + "ajax/kickoutReinforcements.php" + uW.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          if (rslt.ok){
            var upkeep = 0;
            for (var i=1; i<13; i++)
              upkeep += parseInt(march["unit" + i + "Return"]) * parseInt(uW.unitupkeeps[i])
            uW.seed.resources["city"+ march.toCityId].rec1[3] -= upkeep;
            if (parseInt(march.fromPlayerId) == parseInt(uW.tvuid)) {
              var mymarch = uW.seed.queue_atkp["city" + march.fromCityId]["m" + marchId];
              var marchtime = Math.abs(parseInt(mymarch.destinationUnixTime) - parseInt(mymarch.eventUnixTime));
              mymarch.returnUnixTime = unixTime() + marchtime;
              mymarch.marchStatus = 8;
            }
            delete uW.seed.queue_atkinc["m" + marchId];
            if (notify != null)
              notify(null);
          } else {
            if (notify != null)
              notify(rslt.errorMsg);
          }
        },
        onFailure: function () {
          if (notify != null)
            notify(rslt.errorMsg);
        },
    });
  },

/*****

      for (var b = 1; b < 13; b++) {
        g += parseInt(e["unit" + b + "Return"]) * parseInt(unitupkeeps[b])
      }

function kickout_allies(mid, cid, fromUid, fromCid, upkeep) {
  var params = Object.clone(g_ajaxparams);
  params.mid = mid;
  params.cid = cid;
  params.fromUid = fromUid;
  params.fromCid = fromCid;
  new Ajax.Request(g_ajaxpath + "ajax/kickoutReinforcements.php" + g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function(transport) {
      var rslt = eval("(" + transport.responseText + ")");
      if (rslt.ok) {
        Modal.showAlert(g_js_strings.kickout_allies.troopshome);
        seed.resources["city" + currentcityid].rec1[3] = parseInt(seed.resources["city" + currentcityid].rec1[3]) - upkeep;
        Modal.hideModalAll();
        if (parseInt(fromUid) == parseInt(tvuid)) {
          var curmarch = seed.queue_atkp["city" + fromCid]["m" + mid];
          var marchtime = Math.abs(parseInt(curmarch.destinationUnixTime) - parseInt(curmarch.eventUnixTime));
          curmarch.returnUnixTime = unixtime() + marchtime;
          curmarch.marchStatus = 8
        }
        delete seed.queue_atkinc["m" + mid]
      } else {
        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
      }
    },
    onFailure: function() {}
  })
};
***/





  ajaxRecall : function (marchId, notify){
    var params = uW.Object.clone(uW.g_ajaxparams);
    for (var c=0; c<Cities.numCities; c++){
      var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
      if (matTypeof(que)=='array')
        continue;
      for (k in que){
        if (k == 'm'+marchId){
          params.cid = Cities.cities[c].id;
          break;
        }
      }
    }
    params.mid = marchId;
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/undefend.php" + uW.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          var march = uW.seed.queue_atkp["city" + params.cid]["m" + params.mid];
          march.marchStatus = 8;
          var marchtime = parseInt(march.returnUnixTime) - parseInt(march.destinationUnixTime);
          var ut = unixTime();
          if (uW.seed.playerEffects.returnExpire > unixTime())
            marchtime *= 0.5
          march.returnUnixTime = ut + marchtime;
          march.destinationUnixTime = ut;
          march.marchUnixTime = ut - marchtime;
          if (notify != null)
            notify(rslt.errorMsg);
        },
        onFailure: function () {
          if (notify != null)
            notify(rslt.errorMsg);
        },
    });
  },

 };


/*********************************** Players TAB ***********************************/

Tabs.AllianceList = {
  tabOrder : 8,
  tabLabel : uW.g_js_strings.commonstr.player,
  cont : null,
  dat : [],

fetchPlayerCourt : function (uid, notify){
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.pid = uid;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function (rslt) {
logit ("ajax/viewCourt.php\n"+ inspect (rslt, 3, 1));      
      notify (rslt);
    },
    onFailure: function (rslt) {
      notify (rslt);
    },
  });
},


fetchTEST : function (pageNum, notify){    // as in alliance list, sorted by rank, 10 per page
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.pageNo = 1;
  params.numPerPage = 100;
  params.perPage = 100;
  params.results = 100;
  params.numResults = 100;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetMembersInfo.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function (rslt) {
logit ("ajax/allianceGetMembersInfo.php:\n"+ inspect (rslt, 5, 1));      
      notify (rslt);
    },
    onFailure: function (rslt) {
      notify ({errorMsg:'AJAX error'});
    },
  });
},

  
   init : function (div){
    var t = Tabs.AllianceList;
    t.cont = div;
    unsafeWindow.PTgetMembers = t.eventGetMembers;
    unsafeWindow.PTPaintMembers = t.GetDataForMap;
    unsafeWindow.PTpd = t.clickedPlayerDetail;
    unsafeWindow.PTpl = t.clickedPlayerLeaderboard;
    unsafeWindow.PTpl2 = t.clickedPlayerLeaderboard2;
    unsafeWindow.PTalClickPrev = t.eventListPrev;
    unsafeWindow.PTalClickNext = t.eventListNext;
    unsafeWindow.PCplo = t.clickedPlayerGetLastLogin;
    Lastlogin=0;
    t.show();
  },
 

  hide : function (){
  },

  show : function (){
    var t = Tabs.AllianceList;
    if (t.state == null){
      if (getMyAlliance()[0] == 0) {
        t.cont.innerHTML = '<BR><BR><CENTER>You are not in any alliance.</center>';
        t.state = 1;
        return;
      }
      var m = '<DIV class=ptentry><TABLE width=100% cellpadding=0>\
          <TR><TD class=xtab align=right></td><TD class=xtab>Enter all or part of a player s name: &nbsp;</td>\
            <TD width=80% class=xtab><INPUT id=allPlayName size=20 type=text /> &nbsp; <INPUT id=playSubmit type=submit value="Search Player" /></td>\
            <TD class="xtab ptErrText"><SPAN id=ptplayErr></span></td></tr>\
          <TR><TD class=xtab>O: </td><TD class=xtab> Enter all or part of the name of an alliance: &nbsp;</td>\
            <TD class=xtab><INPUT id=allAllName type=text /> &nbsp; <INPUT id=allSubmit type=submit value="Search alliance" /></td>\
            <TD class="xtab ptErrText"><SPAN id=ptallErr></span></td></tr>\
           <TR><TD class=xtab><INPUT align=left id=allListSubmit type=submit value="Alliance list" /></td>\
            <TD class=xtab><INPUT align=right id=idMyAllSubmit type=submit value="'+ getMyAlliance()[1] +'"/>\
           <TD class=xtab></td><TD class=xtab><span align=right <b>'+uW.g_js_strings.attack_generateincoming.estimatedarrival+': </b></span>\
            <div><select id="idFindETASelect">\
        <option value="0,0" > ---Select--- </option>\
        <option value="0,180" >'+unsafeWindow.unitcost["unt1"][0]+'</option>\
        <option value="0,200" > '+unsafeWindow.unitcost["unt2"][0]+' </option>\
        <option value="0,3000" > '+unsafeWindow.unitcost["unt3"][0]+' </option>\
        <option value="0,300" > '+unsafeWindow.unitcost["unt4"][0]+' </option>\
        <option value="0,275" > '+unsafeWindow.unitcost["unt5"][0]+' </option>\
        <option value="0,250" > '+unsafeWindow.unitcost["unt6"][0]+' </option>\
        <option value="1,1000" > '+unsafeWindow.unitcost["unt7"][0]+' </option>\
        <option value="1,750" > '+unsafeWindow.unitcost["unt8"][0]+' </option>\
        <option value="1,150" > '+unsafeWindow.unitcost["unt9"][0]+' </option>\
        <option value="1,100" > '+unsafeWindow.unitcost["unt10"][0]+' </option>\
        <option value="1,120" > '+unsafeWindow.unitcost["unt11"][0]+' </option>\
        <option value="1,80" > '+unsafeWindow.unitcost["unt12"][0]+' </option>\
        </select></div>\
        </td></tr>\
         </table><span style="vertical-align:middle;" id=altInput></span></div><SPAN id=allListOut></span>';
      t.cont.innerHTML = m;
      document.getElementById('allPlayName').addEventListener ('keypress', function(e) {if ( e.which == 13)  document.getElementById('playSubmit').click();}, false);
      document.getElementById('allAllName').addEventListener ('keypress', function(e) {if ( e.which == 13)  document.getElementById('allSubmit').click();}, false);
      
      document.getElementById('allSubmit').addEventListener ('click', t.eventSubmit, false);
      document.getElementById('playSubmit').addEventListener ('click', t.eventPlayerSubmit, false);
      document.getElementById('allAllName').addEventListener ('focus', function (){document.getElementById('ptallErr').innerHTML='';}, false);
      document.getElementById('allPlayName').addEventListener ('focus', function (){document.getElementById('ptplayErr').innerHTML='';}, false);
      document.getElementById('allListSubmit').addEventListener ('click', t.eventListSubmit, false);
      document.getElementById('idMyAllSubmit').addEventListener ('click', t.showMyAlliance, false);
      document.getElementById('idFindETASelect').addEventListener ('click', t.handleEtaSelect, false);
      document.getElementById('idFindETASelect').disabled = true;
      t.ModelCity=Cities.cities[0];
      t.curPage = 0;
      t.MaxPage = -1;
      t.state = 1;
    }
  },

  pName : '',
  eventPlayerSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptplayErr').innerHTML='';
    var name = document.getElementById('allPlayName').value;
    name = name.replace(/\'/g,"_");
    t.pName = name;
    if (name.length < 3){
      document.getElementById('ptplayErr').innerHTML = 'Enter at least 3 characters';
      return;
    }
    document.getElementById('altInput').innerHTML = '';
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking ...</center>';
    t.fetchPlayerList (name, t.eventGotPlayerList);
  },
  
  eventGotPlayerList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    t.playerList = rslt.matchedUsers;
    var uList = [];
    for (k in rslt.matchedUsers)
      uList.push (rslt.matchedUsers[k].userId);     
    t.fetchPlayerStatus (uList, function(r){t.eventGotPlayerOnlineList(r)});    
  },    
    
  eventGotPlayerOnlineList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<DIV class=ptstat>Showing players found <B>"'+ t.pName +'"</b></div>\
      <DIV style="height:575px; max-height:575px; overflow-y:auto">\
      <TABLE width=100% align=center class=ptTab cellspacing=0><TR style="font-weight:bold"><TD>name &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp</td>\
      <TD align=right>user iD &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp</td><TD>Might &nbsp &nbsp</td><TD> &nbsp; on-line</td><TD> &nbsp;Facebook &nbsp; </td><TD width=75%>see</td></tr>';
    var row=0;
    var cl='';
    for (k in t.playerList){
      var u = t.playerList[k];
      if (++row % 2)
        cl = 'class=ptOddrow ';
      else
        cl = '';
      m += '<TR '+ cl +'valign=top><TD>'+ u.genderAndName +'</td><TD><A target="_tab" href="http://koc.dunno.com/index.sjs?f=ServersByUser&user_id='+ u.userId +'">' + u.userId + '</a></SPAM></td><TD align=right>'+ addCommasInt(u.might) +'</td>\
          <TD>'+ (rslt.data[u.userId]?"&nbsp;<SPAN class=boldDarkRed>on-line</span>":"") +'</td>\
          <TD align=center><A target="_tab" href="http://www.facebook.com/profile.php?id='+ u.fbuid +'">Perfil</a></td>\
          <TD><SPAN onclick="PTpd(this, '+ u.userId +')"><A>details</a> &nbsp; <BR></span><SPAN onclick="PTpl2(this,'+ u.userId+','+rslt.data[u.userId]+')"><A>classification</a><BR></span><SPAN onclick="PCplo(this, \''+ u.userId +'\')"><A>Last Login</a></span></td></tr>';
    }
    m += '</table></div>';
    document.getElementById('allListOut').innerHTML = m;
  },
  asName : '',
    eventPlayerUIDSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptplayErr').innerHTML='';
    var uid = document.getElementById('allPlayName').value;

	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.uid = uid;
    MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserGeneralInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
	  t.asName = rslt.userInfo[0].name;
      },
      onFailure: function (rslt) {
           document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>Looking ... not found</center>';
		   return;
      },
    });
    t.pName = t.asName;
    document.getElementById('altInput').innerHTML = '';
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking...</center>';
    t.fetchPlayerList (t.asName, t.eventGotPlayerList);
  },
	
  clickedPlayerDetail : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "looking for details ...";
    t.fetchPlayerInfo (uid, function (r) {t.gotPlayerDetail(r, span)});
  },

  clickedPlayerLeaderboard : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "collecting information on classification ...";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard(r, span)});
  },

  clickedPlayerLeaderboard2 : function (span, uid,status){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "looking for information on classification ... ";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard2(r, span,uid,status)});
  },
  
  clickedPlayerGetLastLogin : function (span, uid){
     var t = Tabs.AllianceList;
     span.onclick = '';
     span.innerHTML = "looking login date ...";
     t.fetchPlayerLastLogin (uid, function (r) {t.gotPlayerLastLogin(r, span)});
   },

  gotPlayerLeaderboard2 : function (rslt,span,uid,status){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = '<B>Leaderboard:</b> Not found! (misted?)';
      return;
    }
    var myA = getMyAlliance ();
    t.dat = [];
    var p = rslt.results[0];
        if ( myA[0] == p.allianceId)
           t.friendEta = true;
        else
           t.friendEta = false;
        for (var c=0; c<p.cities.length; c++){
          t.dat.push ([p.displayName, parseInt(p.might), p.officerType, parseInt(p.numCities), parseInt(p.cities[c].tileLevel),
               parseInt(p.cities[c].xCoord), parseInt(p.cities[c].yCoord), p.cities[c].cityName, 0, status,0,p.userId]);
        }
        t.setDistances (Cities.cities[0].x, Cities.cities[0].y);
        t.ModelCity=Cities.cities[0];
        t.setEta();
        t.fetchPlayerLastLogin (uid, function (r) {t.displayPlayer(p.allianceName,r)});
  },
  
  
  gotPlayerLeaderboard : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = '<B>Leaderboard:</b> Not found! (misted?)';
      return;
    }
    var p = rslt.results[0];
    var an = p.allianceName;
    if (!an || an=='' || p.officerType==4)
      an = 'none';
    else
      an += ' ('+ officerId2String(p.officerType) +')';
    pStr = JSON2.stringify(p);
    logit (pStr);
    m = '<TABLE cellspacing=0 class=ptTab><TR><TD><B>classification: </b></td><TD colspan=2> might: '+ p.might  +' &nbsp; Allianc: '+ an +'</td></tr>'; 
    for (var i=0; i<p.cities.length; i++){
      var c = p.cities[i];
      var created = '';
      if (c.dateCreated && c.dateCreated.substr(0,2)=='20')
        created = ' &nbsp; created: ' + c.dateCreated.substr(0,10);
      m += '<TR><TD align=right><B>city#'+ (i+1) +':</b></td><TD> &nbsp; '+ c.cityName 
      +'</a>) (<a onclick="pbGotoMap ('+ c.xCoord +',' +c.yCoord+ ')">'+ c.xCoord +','+ c.yCoord +'</a>)</td><TD width=75%> &nbsp; level: '
        + c.tileLevel +' &nbsp; status: '+ cityStatusString (c.cityStatus) + created +'</td></tr>';
    }  
    span.innerHTML = m + '</table>';
  },
    
  gotPlayerDetail : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    var u = rslt.userInfo[0];
    var a = 'Ninguna';
    if (u.allianceName)
      a = u.allianceName +' ('+ getDiplomacy(u.allianceId) + ')';
    var m = '<TABLE cellspacing=0 class=ptTab><TR><TD><B>details:</b> &nbsp; </td><TD>Alliance: '+ a +' &nbsp; cities: '
          + u.cities +' &nbsp; population: '+ u.population +'</td></tr><TR><TD></td><TD>provinces: ';
    var pids = u.provinceIds.split (',');
    var p = [];
    for (var i=0; i<pids.length; i++)
      p.push(unsafeWindow.provincenames['p'+pids[i]]);
    span.innerHTML = m + p.join (', ') +'</td></tr></table>';
  },

  eventMyAllianceSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking ...</center>';
    t.fetchAllianceMemberList (getMyAlliance()[0], null, t.eventGotMemberList);
  },  
    
  aName : '',
  eventSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptallErr').innerHTML='';
    t.aName = document.getElementById('allAllName').value;
    if (t.aName.length < 3){
      document.getElementById('ptallErr').innerHTML = 'Enter at least 3 characters';
      return;
    }
    var myA = getMyAlliance ();
    document.getElementById('altInput').innerHTML = '';
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking ...</center>';
    if (myA[0]!=0 && myA[1].toLowerCase().indexOf(t.aName.toLowerCase())>=0 )
      t.fetchAllianceList (t.aName, myA[0], t.eventGotAllianceList);
    else
      t.fetchAllianceList (t.aName, null, t.eventGotAllianceList);
  },

  eventListSubmit : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking ...</center>';
    if (myA[0]!=0  ) {
       t.curPage=1;
       t.fetchOtherAllianceInfo ( 1, t.eventGotOtherAlliancePage);
    }
    else {
       document.getElementById('allListOut').innerHTML = 'Youre not in an alliance.';
    }
  },

  eventGotAllianceList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<DIV class=ptstat>Showing alliances found <B>"'+ t.aName +'"</b></div>\
    <TABLE><TR style="font-weight:bold"><TD class=xtab>Aliance</td><TD class=xtab>Rango</td><TD class=xtab>members</td>\
        <TD align=right class=xtab>might</td><TD class=xtab>diplomacy</td><TD class=xtab></td></tr>';
    for (k in rslt.alliancesMatched){
      var all = rslt.alliancesMatched[k];
      var dip = '';
      if (all.relation && all.relation==1)
        dip = 'Amigables';
      else if (all.relation && all.relation==2)
        dip = 'Hostiles';
      m += '<TR><TD class=xtab>'+ all.allianceName +'</td><TD align=right class=xtab>'+ all.ranking +'</td><TD align=right class=xtab>'+ all.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(all.might) +'</td><TD class=xtab>'+ dip +'</td>\
       <TD class=xtab><a onclick="PTgetMembers('+ all.allianceId +')">View Members</a></td>\
        <TD class=xtab><a onclick="PTPaintMembers('+ all.allianceId +')">'+unsafeWindow.g_js_strings.commonstr.viewmap+'</a></td></tr>';
    }
    document.getElementById('allListOut').innerHTML = m;
  },


  showMyAlliance : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> ...</center>';
    if (myA[0]!=0  ) {
       t.eventGetMembers(myA[0]);
    }
    else {
       document.getElementById('allListOut').innerHTML = 'Youre not in an alliance.';
    }
  },

  curPage : 0,
  MaxPage : 0,

  eventListNext : function (amt){
    var t = Tabs.AllianceList;
    if( parseInt(amt) >= 9999 )
       t.curPage = t.MaxPage;
    else {
	    t.curPage = parseInt(t.curPage) + parseInt(amt);
	    if ( t.curPage > t.MaxPage) {
	      t.curPage = t.MaxPage;
	    }
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking...</center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  eventListPrev : function (amt){
    var t = Tabs.AllianceList;
    if(amt <= -1)
       t.curPage = 1;
    else {
	    t.curPage-=amt;
	    if ( t.curPage < 1 ) {
	      t.curPage = 1;
	    }
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking...</center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  gotoPage : function (){
    var t = Tabs.AllianceList;
    if (t.MaxPage < 0 ) {
      document.getElementById('allListOut').innerHTML = 'List Alliances first.';
      return;
    }
    if (t.MaxPage < 0 || val > t.MaxPage || val < 1) {
      document.getElementById('allListOut').innerHTML = 'Page number out of range';
      return;
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> ...</center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  eventGotOtherAlliancePage : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    t.MaxPage=rslt.noOfPages;
    var m = '<div style="overflow:auto; height:556px;width:620px;"><TABLE><thead><TR style="font-weight:bold"> \
        <th class=xtab>Aliance</th><th class=xtab>Rank</th><th class=xtab>members</th>\
        <th class=xtab>might</th><th class=xtab>Diplomacia</th><th class=xtab></th><th class=xtab></th></tr></thead><tbody>';
    document.getElementById('allListOut').innerHTML = m;
    for (var i=0; i<rslt.otherAlliances.length; i++) {
      var alliance = rslt.otherAlliances[i];
      var dip = '';
      dip = getDiplomacy(alliance.allianceId);
      m += '<TR class="'+ dip + '"><TD class=xtab>' + alliance.name +'</td><TD align=right class=xtab>'+ alliance.ranking +'</td><TD align=right class=xtab>'+ alliance.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(alliance.might) +'</td><TD class=xtab>'+ dip +'</td>\
       <TD class=xtab><a onclick="PTgetMembers('+ alliance.allianceId +')">'+uW.g_js_strings.commonstr.members+'</a></td>\
       <TD class=xtab><a onclick="PTPaintMembers('+ alliance.allianceId +')">'+uW.g_js_strings.commonstr.viewmap+'</a></td></tr>';
    }
    m += '</tbody></TABLE><div style="font-weight:bold"; height:20px;width:560px; ><span> <a onclick="PTalClickPrev(-1)"> [Principio] </a><a onclick="PTalClickPrev(10)"> [-10] </a><a onclick="PTalClickPrev(5)"> [-5] </a><a onclick="PTalClickPrev(1)"> [Anterior] </a> \
          <a onclick="PTalClickNext(1)"> [Siguiente] </a><a onclick="PTalClickNext(5)"> [+5] </a><a onclick="PTalClickNext(10)"> [+10] </a><a onclick="PTalClickNext(9999)"> [Final] </a> </span></div>';
    m += '</div>';
    document.getElementById('allListOut').innerHTML = m;
 },

  showCurrentPage : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();

    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> ...</center>';
    if (myA[0]!=0  ) {
       t.fetchOtherAllianceInfo ( t.curPage, t.eventGotOtherAlliancePage);
    }
    else {
       t.fetchOtherAllianceInfo ( t.curPage, t.eventGotOtherAlliancePage);
    }
  },

  eventGotMemberList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    t.memberListRslt = rslt;
    var uList = [];
    for (k in rslt.results)
      uList.push (rslt.results[k].userId);     
    t.fetchPlayerStatus (uList, function(r){t.eventGotMemberOnlineList(r)});    
  },    
    
  eventGotMemberOnlineList : function (rslt){
    var t = Tabs.AllianceList;
    var numInvalid = 0;
    var numPlayers = 0;
    var myA = getMyAlliance ();
    t.dat = [];
    for (var i=0; i<t.memberListRslt.results.length; i++){
      p = t.memberListRslt.results[i];
      if (p.userId == 0){
        ++numInvalid;
      } else {
        ++numPlayers;
        if ( myA[0] == p.allianceId)
           t.friendEta = true;
        else
           t.friendEta = false;
        for (var c=0; c<p.cities.length; c++){
          t.dat.push ([p.displayName, parseInt(p.might), p.officerType, parseInt(p.numCities), parseInt(p.cities[c].tileLevel),
               parseInt(p.cities[c].xCoord), parseInt(p.cities[c].yCoord), p.cities[c].cityName, 0, rslt.data[p.userId]?1:0,'NA',p.userId]);
        }
      }
    }
    t.setDistances (Cities.cities[0].x, Cities.cities[0].y);
    t.ModelCity=Cities.cities[0];
    t.setEta();
    t.displayMembers (t.memberListRslt.allianceName, numPlayers);
  },

  // sort and display
  reDisp : function (){
    var t = Tabs.AllianceList;
    function sortFunc (a, b){
      var t = Tabs.AllianceList;
      if (typeof(a[t.sortColNum]) == 'number'){
        if (t.sortDir > 0)
          return a[t.sortColNum] - b[t.sortColNum];
        else
          return b[t.sortColNum] - a[t.sortColNum];
      } else if (typeof(a[t.sortColNum]) == 'boolean'){
// TODO !!        
return 0;        
      } else {
        if (t.sortDir > 0)
          return a[t.sortColNum].localeCompare(b[t.sortColNum]);
        else
          return b[t.sortColNum].localeCompare(a[t.sortColNum]);
      }
    }
    t.dat.sort (sortFunc);
    var m = '';
    for (var i=0; i<t.dat.length; i++){
      m += '<TR style="max-height:30px"><TD class=xxtab>'+ t.dat[i][0] +'</td><TD align=right class=xxtab>'+ addCommasInt(t.dat[i][1]) 
         +'</td><TD align=center class=xxtab>'+ t.dat[i][3] +'</td><TD class=xxtab>'+ officerId2String(t.dat[i][2])                       
         +'</td><TD class=xxtab>'+ (t.dat[i][9]?'<SPAN class=boldDarkRed>on-line</span>':'') +'</td><TD class=xxtab>'+ t.dat[i][7] +'</td><TD align=right class=xxtab>'+ t.dat[i][4] 
         +'</td><TD align=center class=xxtab><DIV onclick="pbGotoMap('+ t.dat[i][5] +','+ t.dat[i][6] +')"><A>'+ t.dat[i][5] +','+ t.dat[i][6] +'</a></div></td>\
            <TD align=right class=xxtab style="padding-right:20px;">'+ t.dat[i][8].toFixed(2) +'</td>\
         </td><TD  nowrap class=xxtab>'+ (t.dat[i][10]?'<SPAN>'+ (t.dat[i][10]>0?timestr(t.dat[i][10],1):'NA') +'</span>':'<SPAN>NA</span>') +'<td class=xxtab><SPAN onclick="PCplo(this, \''+ t.dat[i][11] +'\')"><A>Last Login</a></span><td><TD></tr>';
    }
    var tbody = document.getElementById('allBody');
    tbody.style.maxHeight = '';
    tbody.innerHTML = m;


    if (parseInt(tbody.clientHeight) > 470){
      tbody.style.height = '470px';
      tbody.style.maxHeight = '470px';
    }
  },


  setDistances : function (x, y){
    var t = Tabs.AllianceList;
    for (var i=0; i<t.dat.length; i++)
      t.dat[i][8] = distance (x, y, t.dat[i][5], t.dat[i][6]);
  },

  friendEta:false,

  setEta : function (){
    var t = Tabs.AllianceList;
    for (var i=0; i<t.dat.length; i++) {
      if (t.dat[i][8]) {
        var eta = t.estETA(parseFloat(t.dat[i][8]));
        if (t.friendEta)
           t.dat[i][10] = eta.friendETA;
        else
           t.dat[i][10] = eta.ETA;
      }
    }
  },



  handleEtaSelect : function (){
    var t = Tabs.AllianceList;
    t.setEta();
    t.reDisp();
  },

  sortColNum : 8,
  sortDir : 1,

  displayMembers : function (allName, numPlayers){
    var t = Tabs.AllianceList;
    function alClickSort (e){
      var t = Tabs.AllianceList;
      var newColNum = e.id.substr(8);
      document.getElementById('clickCol'+t.sortColNum).className = 'clickable';
      e.className='clickable clickableSel';
      if (newColNum == t.sortColNum)
        t.sortDir *= -1;
      else
        t.sortColNum = newColNum;
      t.reDisp();
    }
    unsafeWindow.PTalClickSort = alClickSort;
    var m = '<STYLE>.clickable{background-color:#ddd; border:2px outset; border-color:#555; padding-left:5px; padding-right:5px}\
            .clickableSel{background-color:#ffffcc;}\
            .xxtab{background-color:none; padding-left:5px; padding-right:5px;} </style>\
      <DIV class=ptstat ><TABLE id=tabAllMembers cellpadding=0  width=100%><TR font-weight:bold"><TD class=xtab> &nbsp; '+ allName +'</td>\
        <TD class=xtab width=80% align=center>distances from <SPAN id=distFrom>'+ Cities.cities[0].name +' ('+ Cities.cities[0].x +','+ Cities.cities[0].y +')</span></td><TD class=xtab align=right>'+ numPlayers +' players found &nbsp; </td></tr></table></div>\
      <div style="max-height:470px; height:470px; overflow-y:auto;"><TABLE id=tabAllMembers align=center cellpadding=0 cellspacing=0><THEAD style="overflow-y:hidden;">\
      <TR style="font-weight:bold"><TD id=clickCol0 onclick="PTalClickSort(this)" class=clickable><A><DIV>player</div></a></td>\
        <TD id=clickCol1 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>might</a></div></td>\
        <TD id=clickCol3 onclick="PTalClickSort(this)" class=clickable><A><DIV>cities</a></div></td>\
        <TD id=clickCol2 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Rank</a></div></td>\
        <TD id=clickCol9 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>status</a></div></td>\
        <TD id=clickCol7 onclick="PTalClickSort(this)" class=clickable><A><DIV>city</a></div></td>\
        <TD id=clickCol4 onclick="PTalClickSort(this)" class=clickable><A><DIV>level</a></div></td>\
        <TD id=clickCol5 onclick="PTalClickSort(this)" class=clickable><A><DIV>coordinates</a></div></td>\
        <TD id=clickCol8 onclick="PTalClickSort(this)" class=clickable><A><DIV>distance</a></div></td>\
        <TD id=clickCol10 onclick="PTalClickSort(this)" class=clickable><A><DIV>estimated time</a></div></td>\
        <TD class=clickable><A><DIV>Last login</a></div></td></tr></thead>\
        <TBODY id=allBody style="background-color:#ffffff;"></tbody></table></div>';
      
    document.getElementById('allListOut').innerHTML = m; //style="top:670px; left:0px; position:absolute;
    document.getElementById('altInput').innerHTML = '<HR><TABLE width=100% cellpaddding=0><TR align=center>\
        <TD class=xtab>Show distance from: &nbsp; X: <INPUT size=2 type=text id=plyrX /> Y: <INPUT size=2 type=text id=plyrY /> &nbsp; or select city: <span id=dmcoords></span></td></tr></table>';
    document.getElementById('clickCol'+t.sortColNum).className = 'clickable clickableSel';

    t.reDisp();
    new CdispCityPicker ('plyrdcp', document.getElementById ('dmcoords'), true, t.eventCoords, 0).bindToXYboxes(document.getElementById('plyrX'), document.getElementById('plyrY'));
    
    document.getElementById('dmcoords').addEventListener ('click', function(){ 
    },false);	
    document.getElementById('idFindETASelect').disabled = false;
  },
  
  displayPlayer : function (allName,rslt){
    var t = Tabs.AllianceList;
    function alClickSort (e){
      var t = Tabs.AllianceList;
      var newColNum = e.id.substr(8);
      document.getElementById('clickCol'+t.sortColNum).className = 'clickable';
      e.className='clickable clickableSel';
      if (newColNum == t.sortColNum)
        t.sortDir *= -1;
      else
        t.sortColNum = newColNum;
      t.reDisp();
    }
    unsafeWindow.PTalClickSort = alClickSort;
    var m = '<STYLE>.clickable{background-color:#ddd; border:2px outset; border-color:#555; padding-left:5px; padding-right:5px}\
            .clickableSel{background-color:#ffffcc;}\
            .xxtab{background-color:none; padding-left:5px; padding-right:5px;} </style>\
            <DIV class=ptstat ><TABLE id=tabAllMembers cellpadding=0  width=100%><TR font-weight:bold"><TD class=xtab>Aliance: '+ allName +'</td>\
              <TD class=xtab width=80% align=center>Last Login: <SPAN id=lastlogin>'+  rslt.playerInfo.lastLogin+'</span></td><TD class=xtab align=right></td></tr></table></div>\
      <div style="max-height:470px; height:470px; overflow-y:auto;"><TABLE id=tabAllMembers align=center cellpadding=0 cellspacing=0><THEAD style="overflow-y:hidden;">\
      <TR style="font-weight:bold"><TD id=clickCol0 onclick="PTalClickSort(this)" class=clickable><A><DIV>player</div></a></td>\
        <TD id=clickCol1 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>might</a></div></td>\
        <TD id=clickCol3 onclick="PTalClickSort(this)" class=clickable><A><DIV>cities</a></div></td>\
        <TD id=clickCol2 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Rank</a></div></td>\
        <TD id=clickCol9 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>status</a></div></td>\
        <TD id=clickCol7 onclick="PTalClickSort(this)" class=clickable><A><DIV>city</a></div></td>\
        <TD id=clickCol4 onclick="PTalClickSort(this)" class=clickable><A><DIV>level</a></div></td>\
        <TD id=clickCol5 onclick="PTalClickSort(this)" class=clickable><A><DIV>coordinates</a></div></td>\
        <TD id=clickCol8 onclick="PTalClickSort(this)" class=clickable><A><DIV>distance</a></div></td>\
        <TD id=clickCol10 onclick="PTalClickSort(this)" class=clickable><A><DIV>estimated time</a></div></td>\
		<TD class=clickable><A><DIV>last loginn</a></div></td></tr></thead>\
      <TBODY id=allBody style="background-color:#ffffff;"></tbody></table></div>\
      <DIV  width:100%; style="top:670px; left:0px; position:absolute; background-color:#ffffff; border-top:1px solid; margin-top:8px; color:#700; font-weight:bold;">';
    document.getElementById('allListOut').innerHTML = m;  //style="top:670px; left:0px; position:absolute;
    document.getElementById('altInput').innerHTML = '<HR><TABLE width=100% cellpaddding=0><TR align=center>\
        <TD class=xtab>Show distance from: &nbsp; X: <INPUT size=2 type=text id=plyrX /> Y: <INPUT size=2 type=text id=plyrY /> &nbsp; or select city: <span id=dmcoords></span></td></tr></table>';
    document.getElementById('clickCol'+t.sortColNum).className = 'clickable clickableSel';
    t.reDisp();
    new CdispCityPicker ('plyrdcp', document.getElementById ('dmcoords'), true, t.eventCoords, 0).bindToXYboxes(document.getElementById('plyrX'), document.getElementById('plyrY'));
    document.getElementById('idFindETASelect').disabled = false;
  },
  
  eventCoords : function (city, x, y){
    var t = Tabs.AllianceList;
    var m = '';
    if (city != null)
      m = city.name +' ('+ city.x +','+ city.y +')';
    else
      m = x +','+ y;
    var distFrom = document.getElementById('distFrom');
    if (distFrom)
        distFrom.innerHTML = m;
    t.ModelCity=city;
    t.JumpCity(city.name);
    t.setDistances(x,y);
    t.setEta();
    t.reDisp();
  },

  eventGetMembers : function (aid){
    var t = Tabs.AllianceList;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>looking ...</center>';
    t.fetchAllianceMemberList (aid, null, t.eventGotMemberList);
  },

  fetchAllianceMemberList : function (allianceId, allianceName, notify) {
    var t = Tabs.AllianceList;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.perPage = 100;
    if (allianceName)
      params.allianceName = allianceName;
    if (allianceId && allianceId != 0)
      params.allianceId = allianceId;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  GetDataForMap : function (allianceId) {
    var t = Tabs.AllianceList;
    var params = uW.Object.clone(uW.g_ajaxparams);
    var Data=[];
    params.perPage = 100;
    params.allianceId = allianceId;
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/getUserLeaderboard.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
      	var city = '';
      	for (var i=0; i<rslt.results.length; i++) {
      		//alert(rslt.results[i].toSource());
      	    if (rslt.results[i]['userId'] !=0){
	      	    player = rslt.results[i]['cities'];
	      	    for (var ii=0; ii<player.length; ii++) 
	      			Data.push ({X:player[ii]['xCoord'],Y:player[ii]['yCoord']});
	    	}  	
        }
        if (Data != []) t.PaintDataOnMap(Data);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  PaintDataOnMap : function(Data){
  		var provMapCoordsA = {imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31, topMargin:19};  
  		var map = '<DIV id=ptAlliProvMap style="height:'+ provMapCoordsA.imgHeight +'px; width:'+ provMapCoordsA.imgWidth +'px; background-repeat:no-repeat; background-image:url(\''+ URL_PROVINCE_MAP +'\')"></div>';
  		document.getElementById('allListOut').innerHTML = map;
		var eMap =  document.getElementById('ptAlliProvMap');
		for (var cc=0; cc<Seed.cities.length; cc++) {
		    var city = Seed.cities;
		    var Xplot = parseInt((provMapCoordsA.mapWidth * parseInt(city[cc][2])) / 750);
		    var Yplot = parseInt((provMapCoordsA.mapHeight * parseInt(city[cc][3])) / 750);
		    var cf = document.createElement ('div');
		    cf.style.background = 'black';
		    cf.style.opacity = '1.0';
		    cf.style.position='relative';
		    cf.style.display='block';
		    cf.style.width='14px';
		    cf.style.height='16px';
		    cf.style.border='1px solid #fff';
		    cf.style.color = 'white';
		    cf.style.textAlign = 'center';
		    cf.style.top = (Yplot+provMapCoordsA.topMargin-(cc*16)-8) +'px';      
		    cf.style.left = (Xplot+provMapCoordsA.leftMargin-7) +'px';
		    cf.innerHTML = (cc+1) +'';
		    eMap.appendChild(cf);
		}

		for (var i=0;i<Data.length;i++) {
			var x = parseInt(Data[i]['X']);
			var y = parseInt(Data[i]['Y']);
  	        var xplot = parseInt((provMapCoordsA.mapWidth * x) / 750);
  	        var yplot = parseInt((provMapCoordsA.mapHeight * y) / 750);
  	    	var ce= document.createElement ('div');
  	    		ce.style.background = 'red';
  	    		ce.style.opacity = '1.0';
  	    		ce.style.position='relative';
  	    		ce.style.display='block';
  	    		ce.style.width='4px';
  	    		ce.style.height='4px';
  	    		ce.style.color = 'white';
  	    		ce.style.textAlign = 'center';
  	    	ce.style.top = (yplot+provMapCoordsA.topMargin -(4*i)-((Seed.cities.length)*18)) +'px';      
  	    	ce.style.left = (xplot+provMapCoordsA.leftMargin -2) +'px';
  	    	ce.innerHTML = '<DIV onclick="pbGotoMap('+ x +','+ y +')">&nbsp;</div>';
  	        eMap.appendChild(ce);
  	   }
  	   
  	   
  },
  

  fetchLeaderboard : function (uid, notify) {
    var t = Tabs.AllianceList;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.userId = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchAllianceList : function (allianceName, myAid, notify) {   // at least 3 chars :)
    var t = Tabs.AllianceList;
    function combineResults (rsltA, rsltM, notify){
      if (!rsltA.ok){
        if (rsltA.msg.indexOf("There were no alliances with ")!=0 || !rsltM.ok){
          notify (rsltA);
          return;
        }
        rsltA.ok = true;
        rsltA.count = 0;
        rsltA.alliancesMatched = {};
      }
      if (rsltM.ok){
        rsltA.alliancesMatched['a'+rsltM.allianceInfo.allianceId] = {allianceId: rsltM.allianceInfo.allianceId, allianceName: rsltM.allianceInfo.allianceName,
              membersCount: rsltM.allianceInfo.members, relation: null, might: rsltM.allianceInfo.might, ranking: rsltM.allianceInfo.ranking};
        ++rsltA.count;
      }
      notify (rsltA);
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.allianceName = allianceName;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetSearchResults.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (myAid!=null && myAid>0)
          t.fetchMyAllianceInfo  (function (r){ combineResults (rslt, r, notify)});
        else
          notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchOtherAllianceInfo : function (pageNum, notify){    // as in alliance list, sorted by rank, 10 per page
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.pageNo = pageNum;
    params.cityId = unsafeWindow.currentcityid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetOtherInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchMyAllianceInfo : function (notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchPlayerList : function (name, notify){  // at least 3 chars!! 
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.searchName = name;
    params.subType = "ALLIANCE_INVITE";
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/searchPlayers.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },


  
  fetchPlayerInfo : function (uid, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.uid = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserGeneralInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  fetchPlayerStatus : function (uidArray, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.checkArr = uidArray.join(',');
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  fetchPlayerLastLogin : function (uid, notify){
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      params.pid = uid;
      new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          notify (rslt);
        },
        onFailure: function (rslt) {
          notify ({errorMsg:'AJAX error'});
        },
      });
    },
    
    gotPlayerLastLogin : function (rslt, span){
        var t = Tabs.AllianceList;
        if (!rslt.ok){
          span.innerHTML = rslt.errorMsg;
          return;
        }
    
        var p = rslt.playerInfo;
        var lastLogin = rslt.playerInfo.lastLogin;
    
        if (lastLogin) {
          m = '<span style="color:black">Last login: '+lastLogin+'</span>';
        } else {
           m = '<span style="color:red">Not found login data: '+lastLogin+'</span>';
        }
        span.innerHTML = m + '';
      },

  ModelCity : {},

  estETA : function(dist) { // Need Relief Station Levels to estimate transport, reinf, or reassign times. 
    var t = Tabs.AllianceList;
    var ret={ETA:0,etaStr:'NA',friendETA:0,friendEtaStr:'NA'};    
    var cityID;
    if (dist <= 0) return ret;
    var EtaType = document.getElementById('idFindETASelect');
    var baseSpeedSel = EtaType.options[EtaType.selectedIndex].value;
    var m = baseSpeedSel.split(',');
    var horse = 0;
    var baseSpeed = 0;
    if(m) {
      horse = parseInt(m[0]);
      baseSpeed = parseInt(m[1]);
    }
    if (baseSpeed == 0) return ret;
    var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
    var Speed = 0;
    if (horse){
      var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
      Speed = baseSpeed * (1 + mmLvl/10.0) * (1 + hsLvl/20.0);
    }
    else {
      Speed = baseSpeed * (1 + mmLvl/10.0);
    }
    var gSpeed = 0;
    var estSec;
    if (Speed>0) {
      gSpeed = Speed/6000.0;//0.48333 mm=10, hs=9
      estSec = (parseFloat(dist)/gSpeed).toFixed(0);
    }
    ret.ETA = (parseInt((estSec+''))+30); 
    ret.etaStr = timestr (ret.ETA,1);
   if (t.ModelCity) {
      cityID = t.ModelCity.id;
      var building = getCityBuilding (cityID, 18);
      if (building) {
        fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
        gSpeed = fSpeed/6000;
        estSec = (dist/gSpeed).toFixed(0);
        ret.friendETA = parseInt((estSec+''))+30; 
        ret.friendEtaStr = timestr ((ret.friendETA+''),1);
      }
   }
    return ret;
  },
  
     JumpCity:function(city) {
   		var t = Tabs.AllianceList;
   		for (i=0;i<Seed.cities.length;i++) {
   			if (Seed.cities[i][1]==city) var cityNum=i;
   		}
   		cityNum++;
   		var obj = document.getElementById('citysel_'+cityNum);
	   	return t.ClickWin(window,obj,'click');
   },
   
   ClickWin:function(win,obj,evtName) {
   	var evt = win.document.createEvent("MouseEvents");
   	evt.initMouseEvent(evtName, true, true, win,
   		0, 0, 0, 0, 0, false, false, false, false, 0, null);
   	return !obj.dispatchEvent(evt);
   },
};

 /******* Crafting List ******
(array) 1 = [object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object]
    (object) 0 = [object Object]
      (string) recipe_id = 1
      (string) name = Crystal Song
      (string) output_item_id = 3000
      (null) consolation_item_id: null = null
      (string) category = 1
      (object) input = [object Object]
        (array) items = 

        (object) resources = [object Object]
          (string) 1 = 10500


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 1 = [object Object]
      (string) recipe_id = 2
      (string) name = Tricked Wind
      (string) output_item_id = 3001
      (null) consolation_item_id: null = null
      (string) category = 1
      (object) input = [object Object]
        (array) items = 

        (object) resources = [object Object]
          (string) 1 = 5200


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 2 = [object Object]
      (string) recipe_id = 4
      (string) name = Spun Bone
      (string) output_item_id = 3003
      (null) consolation_item_id: null = null
      (string) category = 1
      (object) input = [object Object]
        (array) items = 

        (object) resources = [object Object]
          (string) 1 = 10500


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 3 = [object Object]
      (string) recipe_id = 8
      (string) name = Sewn Blood
      (string) output_item_id = 3007
      (null) consolation_item_id: null = null
      (string) category = 1
      (object) input = [object Object]
        (array) items = 

        (object) resources = [object Object]
          (string) 1 = 2500


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 4 = [object Object]
      (string) recipe_id = 9
      (string) name = Sewn Weight
      (string) output_item_id = 3008
      (null) consolation_item_id: null = null
      (string) category = 1
      (object) input = [object Object]
        (array) items = 

        (object) resources = [object Object]
          (string) 1 = 2500


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 5 = [object Object]
      (string) recipe_id = 10
      (string) name = Shape Muck
      (string) output_item_id = 3009
      (null) consolation_item_id: null = null
      (string) category = 1
      (object) input = [object Object]
        (array) items = 

        (object) resources = [object Object]
          (string) 1 = 2500


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 6 = [object Object]
      (string) recipe_id = 12
      (string) name = Knit Grace
      (string) output_item_id = 3011
      (string) consolation_item_id = 3000
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 1
          (string) 3001 = 2

        (object) resources = [object Object]
          (string) 1 = 21000


      (object) requirements = [object Object]
        (string) building = 1

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 7 = [object Object]
      (string) recipe_id = 11
      (string) name = Cast Hide
      (string) output_item_id = 3010
      (string) consolation_item_id = 1107
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 1107 = 1
          (string) 3002 = 2

        (object) resources = [object Object]
          (string) 1 = 75000


      (object) requirements = [object Object]
        (string) building = 5

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 8 = [object Object]
      (string) recipe_id = 25
      (string) name = Knit Courage
      (string) output_item_id = 221
      (string) consolation_item_id = 3003
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3003 = 2
          (string) 3007 = 5

        (object) resources = [object Object]
          (string) 1 = 50000


      (object) requirements = [object Object]
        (string) building = 5

      (string) insurance_cost = 33
      (string) failure_chance = med

    (object) 9 = [object Object]
      (string) recipe_id = 26
      (string) name = Knit Wisdom
      (string) output_item_id = 231
      (string) consolation_item_id = 3003
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3003 = 2
          (string) 3009 = 5

        (object) resources = [object Object]
          (string) 1 = 50000


      (object) requirements = [object Object]
        (string) building = 5

      (string) insurance_cost = 33
      (string) failure_chance = med

    (object) 10 = [object Object]
      (string) recipe_id = 27
      (string) name = Knit Beauty
      (string) output_item_id = 211
      (string) consolation_item_id = 3000
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 2
          (string) 3007 = 5

        (object) resources = [object Object]
          (string) 1 = 50000


      (object) requirements = [object Object]
        (string) building = 5

      (string) insurance_cost = 33
      (string) failure_chance = med

    (object) 11 = [object Object]
      (string) recipe_id = 28
      (string) name = Knit Toil
      (string) output_item_id = 241
      (string) consolation_item_id = 3000
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 2
          (string) 3009 = 5

        (object) resources = [object Object]
          (string) 1 = 50000


      (object) requirements = [object Object]
        (string) building = 5

      (string) insurance_cost = 33
      (string) failure_chance = med

    (object) 12 = [object Object]
      (string) recipe_id = 5
      (string) name = Divine Act
      (string) output_item_id = 3004
      (string) consolation_item_id = 3010
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 3
          (string) 3003 = 3
          (string) 3010 = 1

        (object) resources = [object Object]
          (string) 1 = 120000


      (object) requirements = [object Object]
        (string) building = 6

      (string) insurance_cost = 20
      (string) failure_chance = med

    (object) 13 = [object Object]
      (string) recipe_id = 29
      (string) name = Forge Fury
      (string) output_item_id = 2002
      (string) consolation_item_id = 3003
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3003 = 7
          (string) 3007 = 21

        (object) resources = [object Object]
          (string) 1 = 400000


      (object) requirements = [object Object]
        (string) building = 6

      (string) insurance_cost = 40
      (string) failure_chance = high

    (object) 14 = [object Object]
      (string) recipe_id = 6
      (string) name = Divine Rite
      (string) output_item_id = 3005
      (string) consolation_item_id = 3004
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 3
          (string) 3003 = 3
          (string) 3004 = 1

        (object) resources = [object Object]
          (string) 1 = 180000


      (object) requirements = [object Object]
        (string) building = 7

      (string) insurance_cost = 40
      (string) failure_chance = high

    (object) 15 = [object Object]
      (string) recipe_id = 7
      (string) name = Divine Toll
      (string) output_item_id = 3006
      (string) consolation_item_id = 3005
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 3
          (string) 3003 = 3
          (string) 3005 = 1

        (object) resources = [object Object]
          (string) 1 = 240000


      (object) requirements = [object Object]
        (string) building = 8

      (string) insurance_cost = 40
      (string) failure_chance = high

    (object) 16 = [object Object]
      (string) recipe_id = 13
      (string) name = Divine Song
      (string) output_item_id = 401
      (string) consolation_item_id = 3006
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 3
          (string) 3003 = 3
          (string) 3006 = 1

        (object) resources = [object Object]
          (string) 1 = 320000


      (object) requirements = [object Object]
        (string) building = 9

      (string) insurance_cost = 40
      (string) failure_chance = high

    (object) 17 = [object Object]
      (string) recipe_id = 14
      (string) name = Divine Hymn
      (string) output_item_id = 402
      (string) consolation_item_id = 401
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 3
          (string) 3003 = 3
          (string) 401 = 1

        (object) resources = [object Object]
          (string) 1 = 500000


      (object) requirements = [object Object]
        (string) building = 10

      (string) insurance_cost = 124
      (string) failure_chance = high

    (object) 18 = [object Object]
      (string) recipe_id = 31
      (string) name = Mist Song
      (string) output_item_id = 1120
      (string) consolation_item_id = 1110
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 1110 = 1
          (string) 261 = 1
          (string) 3007 = 7
          (string) 3011 = 2

        (object) resources = [object Object]
          (string) 1 = 80000


      (object) requirements = [object Object]
        (string) building = 10

      (string) insurance_cost = 18
      (string) failure_chance = low

    (object) 19 = [object Object]
      (string) recipe_id = 32
      (string) name = Mist Dirge
      (string) output_item_id = 1121
      (string) consolation_item_id = 1120
      (string) category = 1
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 1120 = 1
          (string) 272 = 1
          (string) 3009 = 3
          (string) 3008 = 3
          (string) 3011 = 2

        (object) resources = [object Object]
          (string) 1 = 85000


      (object) requirements = [object Object]
        (string) building = 10

      (string) insurance_cost = 20
      (string) failure_chance = med


  (array) 3 = [object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object]
    (object) 0 = [object Object]
      (string) recipe_id = 15
      (string) name = Crimson Act
      (string) output_item_id = 261
      (string) consolation_item_id = 3007
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3007 = 5

        (object) resources = [object Object]
          (string) 1 = 10000


      (object) requirements = [object Object]
        (string) building = 2

      (string) insurance_cost = 9
      (string) failure_chance = low

    (object) 1 = [object Object]
      (string) recipe_id = 18
      (string) name = Aegis Act
      (string) output_item_id = 271
      (string) consolation_item_id = 3008
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3008 = 5

        (object) resources = [object Object]
          (string) 1 = 10000


      (object) requirements = [object Object]
        (string) building = 2

      (string) insurance_cost = 9
      (string) failure_chance = low

    (object) 2 = [object Object]
      (string) recipe_id = 20
      (string) name = Trapped Wind
      (string) output_item_id = 55
      (string) consolation_item_id = 1103
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 1103 = 1
          (string) 3001 = 5

        (object) resources = [object Object]
          (string) 1 = 25000


      (object) requirements = [object Object]
        (string) building = 2

      (string) insurance_cost = 5
      (string) failure_chance = low

    (object) 3 = [object Object]
      (string) recipe_id = 22
      (string) name = Trick Hunger
      (string) output_item_id = 273
      (string) consolation_item_id = 3000
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 3000 = 5

        (object) resources = [object Object]
          (string) 1 = 160000


      (object) requirements = [object Object]
        (string) building = 2

      (string) insurance_cost = 33
      (string) failure_chance = med

    (object) 4 = [object Object]
      (string) recipe_id = 16
      (string) name = Crimson Rite
      (string) output_item_id = 262
      (string) consolation_item_id = 261
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 261 = 1
          (string) 3007 = 3

        (object) resources = [object Object]
          (string) 1 = 30000


      (object) requirements = [object Object]
        (string) building = 3

      (string) insurance_cost = 43
      (string) failure_chance = med

    (object) 5 = [object Object]
      (string) recipe_id = 19
      (string) name = Aegis Rite
      (string) output_item_id = 272
      (string) consolation_item_id = 271
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 271 = 1
          (string) 3008 = 3

        (object) resources = [object Object]
          (string) 1 = 30000


      (object) requirements = [object Object]
        (string) building = 3

      (string) insurance_cost = 43
      (string) failure_chance = med

    (object) 6 = [object Object]
      (string) recipe_id = 21
      (string) name = Poached Wind
      (string) output_item_id = 57
      (string) consolation_item_id = 55
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 55 = 1
          (string) 3001 = 3

        (object) resources = [object Object]
          (string) 1 = 75000


      (object) requirements = [object Object]
        (string) building = 3

      (string) insurance_cost = 20
      (string) failure_chance = med

    (object) 7 = [object Object]
      (string) recipe_id = 23
      (string) name = Trap Hunger
      (string) output_item_id = 274
      (string) consolation_item_id = 273
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 273 = 1
          (string) 3000 = 3

        (object) resources = [object Object]
          (string) 1 = 240000


      (object) requirements = [object Object]
        (string) building = 3

      (string) insurance_cost = 60
      (string) failure_chance = med

    (object) 8 = [object Object]
      (string) recipe_id = 17
      (string) name = Crimson Toll
      (string) output_item_id = 280
      (string) consolation_item_id = 262
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 262 = 1
          (string) 3007 = 3

        (object) resources = [object Object]
          (string) 1 = 90000


      (object) requirements = [object Object]
        (string) building = 4

      (string) insurance_cost = 40
      (string) failure_chance = high

    (object) 9 = [object Object]
      (string) recipe_id = 24
      (string) name = Poach Hunger
      (string) output_item_id = 275
      (string) consolation_item_id = 274
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 274 = 1
          (string) 3000 = 3

        (object) resources = [object Object]
          (string) 1 = 320000


      (object) requirements = [object Object]
        (string) building = 4

      (string) insurance_cost = 168
      (string) failure_chance = high

    (object) 10 = [object Object]
      (string) recipe_id = 30
      (string) name = Aegis Toll
      (string) output_item_id = 281
      (string) consolation_item_id = 272
      (string) category = 3
      (object) input = [object Object]
        (object) items = [object Object]
          (string) 272 = 1
          (string) 3008 = 3

        (object) resources = [object Object]
          (string) 1 = 90000


      (object) requirements = [object Object]
        (string) building = 4

      (string) insurance_cost = 40
      (string) failure_chance = high
*******/
/*************************** Auto Craft Tab *************************************/
Tabs.AutoCraft = {
	tabOrder: 17, //CHECKTHIS ?
	tabLabel: "Craft",
	timer: null,
	craftIntervall  : TrainOptions.CraftIntervallMin,
	crafting: [],
	myDiv: null,
	timerStat: null,
	numcity :-1,
        par: false,
        craftinfo : {},

	init: function(div){
        var t = Tabs.AutoCraft;
        t.myDiv = div;   
        t.crafting = {
	            running: TrainOptions.CraftingRunning,
        };
        var m = '<DIV id=pbCraftingDiv class=pbStat>AUTO CRAFTING</div><TABLE id=pbcraftingfunc width=100% height=0% class=pbTab><TR>';
        if (t.crafting.running == false) {
	            m += '<TD  width="33%"><INPUT id=pbCraftRunning type=submit value="Crafting = OFF"></td>';
                    updatebotbutton('Craft-OFF', 'bocrafttab');
	 }	        else {
	            m += '<TD width="33%"><INPUT id=pbCraftRunning type=submit value="Crafting = ON"></td>';
                    updatebotbutton('Craft-ON', 'bocrafttab');
	            t.timer=setInterval(t.Start,parseInt(t.craftIntervall*60000));
        }
        m += '<TD width="10%">interval: <input type=text value="'+TrainOptions.CraftIntervallMin+'" size=2  maxlength=2 id=pbCraftIntervall> minute(s) <b>(</b><span class=boldRed>need a refresher</span><b>)</b></td></table></div>';
        m += '<DIV id=pbCraftingStats class=pbStat>AMOUNT AND TIME CRAFTING AETHERSTONES</div><span id="CraftStat"></span>';
        m += '</tr><DIV id=pbCraftingList class=pbStat>AUTO CRAFTING - LIST</div><TABLE id=pbcraftingqueues width=100% height=0% class=pbTabLined><TR>';
        m += "<td colspan=2><center><b>objects</b></center></td><td><center><b>I have</b></center></td><td><b>I</b></td>"; 
        m += "<td colspan=2><center><b>objects</b></center></td><td><center><b>I have</b></center></td><td><b>I</b></td>"; 
        
		m += "</tr><tr>";
        	 
		for(var i=0; i < unsafeWindow.recipelist[1].length; i++){
                        if ((i+1)%2 != 0) m += "</tr><tr>";
                        if (i==unsafeWindow.recipelist[1].length) {
                               if ((i+1)%2 == 0) {
                                    m += "</tr><tr>";
                                    t.par=true;
                                }
                           }
			var h = parseInt(unsafeWindow.recipelist[1][i].output_item_id);
			t.craftinfo[h] = {};
			t.craftinfo[h].recipe_id = unsafeWindow.recipelist[1][i].recipe_id;
			t.craftinfo[h].category = unsafeWindow.recipelist[1][i].category;
			t.craftinfo[h].input = unsafeWindow.recipelist[1][i].input;
			t.craftinfo[h].requirements = unsafeWindow.recipelist[1][i].requirements;
			m += "<td ><center><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></center></td><td><center>"+unsafeWindow.itemlist["i"+h].name+"</center></td><td><center><span class=boldGreen>"+parseIntNan(Seed.items["i"+h])+"</span></center></td>";
			m += "<td><input type=text size=4 id='Craft_nb_"+h+"' value='"+ parseIntNan(TrainOptions.CraftingNb[h]) +"'></td>";
                        if ((i+1)%2 == 0) m += "</tr><tr>";
                        if (i==unsafeWindow.recipelist[1].length) {
                               if ((i+1)%2 != 0) {
                                    m += "</tr><tr>";
                                    t.impar=true;
                                }
                           }
		}
		for(var j=0; j < unsafeWindow.recipelist[3].length; j++){
                         if (t.par) {
                            if ((j+1)%2 != 0) m += "</tr><tr>";
                        }else{ 
			    if ((j+1)%2 == 0) m += "</tr><tr>";
                         }
			var h = parseInt(unsafeWindow.recipelist[3][j].output_item_id);
			t.craftinfo[h] = {};
			t.craftinfo[h].recipe_id = unsafeWindow.recipelist[3][j].recipe_id;
			t.craftinfo[h].category = unsafeWindow.recipelist[3][j].category;
			t.craftinfo[h].input = unsafeWindow.recipelist[3][j].input;
			t.craftinfo[h].requirements = unsafeWindow.recipelist[3][j].requirements;
			m += "<td ><center><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></center></td><td><center>"+unsafeWindow.itemlist["i"+h].name+"</center></td><td><center><span class=boldGreen>"+parseIntNan(Seed.items["i"+h])+"</span></center></td>";
			m += "<td><input type=text size=4 id='Craft_nb_"+h+"' value='"+ parseIntNan(TrainOptions.CraftingNb[h]) +"'></td>";


        }
        m+="</table><b>Note: </ b> If you want multiple objects, the creation will be randomly. <BR> <b>Important: minimum 5,000 Aetherstones and refresh to update the inventory!</b> ";

       t.myDiv.innerHTML = m;
       
       window.addEventListener('unload', t.onUnload, false);
       
	document.getElementById("pbCraftRunning").addEventListener ('click', function (){t.toggleStateRunning(this)}, false);     
        document.getElementById("pbCraftIntervall").addEventListener ('click', function (){
		if (parseIntNan(document.getElementById("pbCraftIntervall").value)<3) {
                document.getElementById("pbCraftIntervall").value=3;
                }else{
		TrainOptions.CraftIntervallMin = document.getElementById("pbCraftIntervall").value;
                }
		}, false); 

  }, 

  updateStat: function() {
   var t = Tabs.AutoCraft;
   var rownum = 0;
   function _row (name, row, noTotal, typee){
         if (rownum++ % 2)
           style = '';
         else
           style = ' style = "background: #e8e8e8"';
         var tot = 0;
         var m = [];
         m.push ('<TR style="background: #fff" align=right');
         m.push (style);
         m.push ('><TD');
         m.push (style);
         m.push ('><B>');
         m.push (name);
         m.push ('</td>');
         if (noTotal){
           m.push ('<TD');
           m.push (style);
           m.push ('>&nbsp;</td>');
         } else {
           for (i=0; i<row.length; i++)
             tot += row[i];
           m.push ('<TD style="background: #ffc">');
            if (tot<0) {
             m.push ("<SPAN class=boldRed>"+addCommas(tot)+"</span>");
            } else {
             m.push (addCommas(tot));
            }
           m.push ('</td>');
         }
         for (i=0; i<row.length; i++){
           m.push ('<TD');
           m.push (style);
           m.push ('>');
           if (row[i]<5000) {
	                m.push ("<SPAN class=boldRed>"+addCommas(row[i])+"</span>");
	   } else {
	                m.push (addCommas(row[i]));
           }
           m.push ('</td>');
         }
   
         m.push ('</tr>');
         return m.join('');
       }

   clearTimeout(t.timerStat);
   var str="<TABLE class=pbTabOverview cellpadding=0 cellspacing=0><TR  align=center><TD width=55 align=center></td><TD width=88 style='background: #ffc; font-size:150%' align=center><SPAN class=oohfancy>TOTAL</SPAN></td>";
   for(i=0; i<Cities.numCities; i++) {
            cityID = 'city'+ Cities.cities[i].id;
         
            str += "<TD width=81><SPAN class=oohfancy>"+ Cities.cities[i].name.substring(0,10) +"</SPAN></td>";
          
   }
   rows = [];
   var now = unixTime();
   rows[0] = [];
   for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
          rows[0][i] = parseInt(Seed.citystats[cityID].gold[0]);
        }
        for (r=1; r<6; r++){
          rows[r] = [];
          for(i=0; i<Cities.numCities; i++) {
            cityID = 'city'+ Cities.cities[i].id;
            if (r==5)
             rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0]);
            else
             rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0] / 3600);
            
          }
         
      }
      str += _row ('<img height=18 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png>', rows[5], false, 0);
      str +='<tr style="background: #e8e8e8" align=right><td><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/3.jpg title="Crafting"></b></td><td>&nbsp;</td>';
                for(i=0; i<Cities.numCities; i++) {
                 var totTime = 0;
                 if (Seed.queue_craft["city" + Cities.cities[i].id].length > 0) {
                  var q=Seed.queue_craft["city" + Cities.cities[i].id][0];
                  var totTime = 0;
                  totTime = q.craftingEtaUnixTime - now;
                  if (totTime < 0)
                    totTime = 0;
                  if (getCityBuilding(Cities.cities[i].id,20).count>0 && totTime == 0)
                    affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
                  else
                    affuichage = timestr(totTime);
                  
                  str +="<td><span onclick='Crafting("+Cities.cities[i].id+");'>"+ affuichage + "</span></td>";  
           
                 } else {
                 affuichage = timestr(totTime);
                 if (getCityBuilding(Cities.cities[i].id,20).count>0)
                    affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
                    
                 str +="<td><span onclick='Crafting("+Cities.cities[i].id+");'>"+affuichage+"</span></td>";
                 }
                }    
             str +="</tr>";    
             
         document.getElementById("CraftStat").innerHTML=str;
         t.timerStat = setTimeout(function() { t.updateStat(); }, 2000);
         
         
  },
  updateCraftnb : function() {
   var t = Tabs.AutoCraft;
   for(var h in t.craftinfo) {
		if (document.getElementById("Craft_nb_" +h)) document.getElementById("Craft_nb_"+h).value=parseInt(TrainOptions.CraftingNb[h]) ;
     }
  },
  saveCraftState : function() {
   var t = Tabs.AutoCraft;
   TrainOptions.CraftingRunning =  t.crafting.running;
   for(var h in t.craftinfo) {
		if (document.getElementById("Craft_nb_" +h)) TrainOptions.CraftingNb[h] = document.getElementById("Craft_nb_"+h).value;
    }
    saveTrainingOptions();
  },

   toggleStateRunning: function(obj){
  	var t = Tabs.AutoCraft;
  	obj = document.getElementById('pbCraftRunning');
          if (t.crafting.running == true) {
              t.crafting.running = false;
              t.saveCraftState();
              if (obj) obj.value = "Crafting = OFF";
              updatebotbutton('Craft-OFF', 'bocrafttab');
              clearInterval(t.timer);
          }
          else {
              t.crafting.running = true;
              t.saveCraftState();
              if (obj) obj.value  = "Crafting = ON";
              updatebotbutton('Craft-ON', 'bocrafttab');
              t.timer=setInterval(t.Start,parseInt(t.craftIntervall*60000));
          }
          t.updateCraftnb();
    },
    Start: function() {
     var t = Tabs.AutoCraft;
     if(!TrainOptions.CraftingRunning) {
      clearInterval(t.timer);
      return;
     }
     if (t.numcity<Cities.numCities-1) {
           t.numcity++;
         } else {
          t.numcity=0; 
     }
     var c=t.numcity;
     var cityId=Cities.cities[c].id;
     
     var ret=getCityBuilding(cityId,20).count;
     if (ret==0) { 
       t.Start();
       return;
     }
     if (parseInt(Seed.resources["city" + cityId]['rec5'][0])<5000) 
            return;
     var tableau = [];
     for(var d in TrainOptions.CraftingNb) {
     if (parseInt(TrainOptions.CraftingNb[d])>0) {
     tableau.push (d); 
           }
     }
     if (tableau.length==0) {
	    t.crafting.running = false;
            obj = ById('pbCraftRunning');
	    if (obj) obj.value = "Crafting = OFF";
		t.saveCraftState();
		 clearInterval(t.timer);
		  return;
             }

     var itemId = tableau[Math.floor(Math.random()*tableau.length)];
     var recipeId = t.craftinfo[itemId].recipe_id;
     var category = t.craftinfo[itemId].category; 
     var i=Seed.queue_craft["city"+cityId];
     if(i.length>0) {
          var q=i[0];
     	  var totTime = 0;
     	  var now = unixTime();
          totTime = q.craftingEtaUnixTime - now;
          if (totTime > 0) {
           return;
          }
     } 
     t.CraftingItem(cityId,  itemId, recipeId, category);
    },
    CraftingItem: function (currentcity, itemId, recipeId, category) {
      var t = Tabs.AutoCraft;
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
          params.action="craft";
          params.ctrl="Crafting";
          params.cityId=currentcity;
          params.insurance=false;
     	  params.itemId=itemId;
     	  params.recipeId=recipeId;
     	  params.categoryId=category;
      new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, { method: "post", parameters: params,loading: true,
          onSuccess: function (transport) {
              var o=eval("("+transport.responseText+")");
              if(o.ok===true){
               if (o.status=="error") {
			   
               } else if(o.status=="failure"){
    	        setTimeout(function() {
    	         t.CraftingItem(currentcity,  itemId, recipeId);
    	        }, 5000);
     	       } else if (o.status=="success"){
     	        TrainOptions.CraftingNb[itemId] =  TrainOptions.CraftingNb[itemId] -1;
     	        saveTrainingOptions();
     	        t.updateCraftnb();
       		if(!Seed.queue_craft["city"+currentcity]) {
    		 Seed.queue_craft["city"+currentcity]=[];
    		}
         	var n={};
         	n.recipeId=recipeId;
         	n.craftingUnixTime=o.time.startTime;
         	n.craftingEtaUnixTime=o.time.endTime;
         	n.craftingId=o.craftingId;
         	n.categoryId=null;
         	n.recipeIndex=null;
         	unsafeWindow.seed.queue_craft["city"+currentcity].push(n);
         	t.Start()
               }
              }
            },
            onFailure: function () {    }
       });
 },

    show : function (){
		var t = Tabs.AutoCraft;
		clearTimeout(t.timerStat);
		t.updateStat();
    },
    hide: function(){
		var t = Tabs.AutoCraft;
		clearTimeout(t.timerStat);
      },
	  onUnload: function(){
		  var t = Tabs.AutoCraft;
		   t.saveCraftState();
    },
};


/*********************************** AUTOSCOUT	TAB *************************************/

Tabs.ScoutAlliance = {  
tabLabel: 'AUTOSCOUT',  
tabOrder : 26,  
myDiv : null,  
MapAjax : new CMapAjax(),

  ScoutAllianceOptions : {     num_scouts     : 1,     min_might      : 50,     max_might      : 99000000,     scout_interval : 5,     scouting       : false,       scout_ready    : false,     scoutage : {},  },

  init : function (div){
    var t = Tabs.ScoutAlliance;
    var o = t.ScoutAllianceOptions;
    unsafeWindow.fetchAllianceMembers = t.eventGetMembers;
    t.myDiv = div;
    t.city = 0;
    t.citiesToScout = {};

    var s = GM_getValue('ScoutAllianceOptions_' + getServerId());
    if (s != null){       t.ScoutAllianceOptions = JSON2.parse(s);       }

    for(var i=0; i < Cities.numCities; i++) {
        t.citiesToScout[i] = [];
        var s = GM_getValue('CitiesToScout_city_' + i + '_' + getServerId());
        if (s != null){ t.citiesToScout[i] = JSON2.parse(s);  }
    }

    t.show();
    t.doNextScout();
  },


  setScoutAllianceOptions : function () {     var t = Tabs.ScoutAlliance;     GM_setValue ('ScoutAllianceOptions_' + getServerId(), JSON2.stringify(t.ScoutAllianceOptions));  },

  show : function (){
    var t = Tabs.ScoutAlliance;
    var o = t.ScoutAllianceOptions;

    if (t.state == null){
      if (getMyAlliance()[0] == 0) {  t.myDiv.innerHTML = '<BR><BR><CENTER><blink><b>You have to be in an alliance to use this feature!!!</b></blink></center>'; t.state = 1; return; }
      var m = '<DIV class=pbStat>AutoScout Alliances</div><DIV class=ptEntry><TABLE width=100% cellpadding=0><TR>';
         if (o.scouting) {
           m += '<TD colspan=2 class=xtab style="text-align:center"><CENTER><INPUT id=IdScoutingStatus type=submit value="AutoScout = ON"></td>';
         } else {
            if (o.scout_ready) {
               m += '<TD colspan=2 class=xtab style="text-align:center"><INPUT id=IdScoutingStatus type=submit value="AutoScout = OFF"></td>';
            } else {
               m += '<TD colspan=2 class=xtab style="text-align:center"><INPUT id=IdScoutingStatus type=submit value="AutoScout= allaince"></td>';
            }
         }
         m += '</TR><TR><TD class=xtab colspan="2">Scanning interval: <INPUT id=IdScoutInterval type=text size=8 maxlength=8 value='+ o.scout_interval +' \> seconds</td> <TD class=xtab>Min. might:  <INPUT id=IdMinMight type=text size=8 maxlength=8 value='+ o.min_might +' \></td></tr><TR>  <TD colspan="2" class=xtab>Scouting: <INPUT id=IdNumScouts type=text size=8 maxlength=8 value='+ o.num_scouts +' \></td>  <TD class=xtab>Max. might: <INPUT id=IdMaxMight type=text size=8 maxlength=8 value='+ o.max_might +' \></td></tr><TR>  <TD class=xtab colspan="2">Aliance: <INPUT id=IdSearchAllianceName type=text />    &nbsp;    <INPUT id=IdSearchAllianceNameSubmit type=submit value="Search alliance" /></td>  </tr><TR><TD colspan="2" class="xtab ptErrText"><SPAN id=IdScoutAllianceErrorSpan></span></td></tr></table>';
         m += '<span style="vertical-align:middle;" id=IdScoutAlliance></span></div><div style=" max-height:200px; overflow-y:auto; text-align: center; font-weight: bold;" id=IdScoutAllianceStatus></div></div><div style=" max-height:200px; overflow-y:auto;"; id=IdScoutAllianceProgress></div></div>';

      t.myDiv.innerHTML = m;

      document.getElementById('IdScoutInterval').addEventListener('change', function(){		o.scout_interval=parseInt(document.getElementById('IdScoutInterval').value);		t.setScoutAllianceOptions();	        },false);
      document.getElementById('IdNumScouts').addEventListener('change', function(){		o.num_scouts=parseInt(document.getElementById('IdNumScouts').value);		t.setScoutAllianceOptions();	        },false);
      document.getElementById('IdMinMight').addEventListener('change', function(){		o.min_might=parseInt(document.getElementById('IdMinMight').value);		t.setScoutAllianceOptions();	        },false);
      document.getElementById('IdMaxMight').addEventListener('change', function(){		o.max_might=parseInt(document.getElementById('IdMaxMight').value);		t.setScoutAllianceOptions();	        },false);
      document.getElementById('IdSearchAllianceNameSubmit').addEventListener ('click', t.SearchAllianceSubmit, false);
      document.getElementById('IdScoutingStatus').addEventListener('click', function(){t.toggleScoutingStatus(this)} , false);
      t.state = 1;
    }
  },

  hide: function(){  },

  SearchAllianceName : '',
  SearchAllianceSubmit : function (){
    var t = Tabs.ScoutAlliance;
    document.getElementById('IdScoutAllianceErrorSpan').innerHTML='';
    t.SearchAllianceName = document.getElementById('IdSearchAllianceName').value;
    if (t.SearchAllianceName.length < 3){
      document.getElementById('IdScoutAllianceErrorSpan').innerHTML = 'Min. 3 letters';
      return;
    }
    document.getElementById('IdScoutAllianceStatus').innerHTML = '<DIV class=pbStat>looking <B>"'+ t.SearchAllianceName +'"</b>...';
    t.fetchAllianceList (t.SearchAllianceName, t.eventGotAllianceList);
  },

  eventGotAllianceList : function (rslt){
    var t = Tabs.ScoutAlliance;
    if (!rslt.ok){      document.getElementById('IdScoutAllianceStatus').innerHTML = rslt.errorMsg;      document.getElementById('IdScoutAllianceErrorSpan').innerHTML = rslt.errorMsg;      return;    }
    var m = '<DIV class=pbStat>RESULTS <B>"'+ t.SearchAllianceName +'"</b></div>\
    <TABLE><TR style="font-weight:bold"><TD class=xtab>alliance</td><TD class=xtab>rank</td><TD class=xtab>players</td>\
        <TD align=right class=xtab>might</td><TD class=xtab>diplomacy</td><TD class=xtab></td></tr>';
    for (k in rslt.alliancesMatched){
      var all = rslt.alliancesMatched[k];
      var dip = '';
      if (all.relation && all.relation==1)
        dip = 'friendly';
      else if (all.relation && all.relation==2)
        dip = 'Hostiles';
      m += '<TR><TD class=xtab>'+ all.allianceName +'</td><TD align=right class=xtab>'+ all.ranking +'</td><TD align=right class=xtab>'+ all.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(all.might) +'</td><TD class=xtab>'+ dip +'</td>\
       <TD class=xtab><a onclick="fetchAllianceMembers('+ all.allianceId +')">Show players</a></td></tr>';
    }
    document.getElementById('IdScoutAllianceStatus').innerHTML = m;
  },

  fetchAllianceList : function (allianceName, notify) {
    var t = Tabs.ScoutAlliance;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.allianceName = allianceName;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetSearchResults.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
          notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  eventGetMembers : function (aid){    var t = Tabs.ScoutAlliance;    t.ScoutAllianceOptions.scout_ready = false;    t.setScoutAllianceOptions();    document.getElementById('IdScoutingStatus').value ="Exploracin = NO PREPARADA";    document.getElementById('IdScoutAllianceStatus').innerHTML = '<DIV class=pbStat>Buscando datos en la clasificacin';    document.getElementById('IdScoutAllianceProgress').innerHTML = '';    t.fetchAllianceMemberList (aid, t.eventGotMemberList);  },

  fetchAllianceMemberList : function (allianceId, notify) {
    var t = Tabs.ScoutAlliance;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.perPage = 100;
    params.allianceId = allianceId;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  eventGotMemberList : function (rslt){
    var t = Tabs.ScoutAlliance;
    var o = t.ScoutAllianceOptions;
    document.getElementById('IdScoutAllianceProgress').innerHTML="";
    if (!rslt.ok){
      document.getElementById('IdScoutAllianceStatus').innerHTML = "<center><span class=boldRed> "+rslt.errorMsg+"</span></center>";
      document.getElementById('IdScoutAllianceErrorSpan').innerHTML = "<center><span class=boldRed> "+rslt.errorMsg+"</span></center>";
      return;
    }
    var numInvalid = 0;
    var numPlayers = 0;
    var numCities = 0;
    var myA = getMyAlliance ();
    var dist = 0;
    for(var i=0; i < Cities.numCities; i++) {
        t.citiesToScout[i] = [];
    }
    for (var r=0; r<rslt.results.length; r++){
      p = rslt.results[r];
      if (p.userId == 0){
        ++numInvalid;
      } else {
        ++numPlayers;
        numCities += p.cities.length;
        might = parseInt(p.might);
        if (might > parseInt(o.min_might) && might < parseInt(o.max_might)) {
          for (var c=0; c<p.cities.length; c++){
             for(var i=0; i < Cities.numCities; i++) {
                dist = distance (Cities.cities[i].x, Cities.cities[i].y, p.cities[c].xCoord, p.cities[c].yCoord);
                t.citiesToScout[i].push ({x:p.cities[c].xCoord,y:p.cities[c].yCoord, dist:dist, nom:p.displayName});
            }
          }
        }
      }
    }

    dist = 100000;
    for(var i=0; i < Cities.numCities; i++) {
        t.citiesToScout[i].sort(function sortDist(a,b) {a = a['dist'];b = b['dist'];return a == b ? 0 : (a < b ? -1 : 1);});
        if (t.citiesToScout[0].length > 0 && t.citiesToScout[i][0].dist < dist) {
            t.city = i;
            dist = t.citiesToScout[i][0].dist;
        }
        GM_setValue('CitiesToScout_city_' + i + '_' + getServerId(), JSON2.stringify(t.citiesToScout[i]));
    }
    if (t.city == 0) t.city = Cities.numCities;
    else t.city -= 1;

    var m = ''; 
    m += '<DIV class=pbStat>found: '+ rslt.allianceName +' (players: ' + numPlayers + '';
    if (numInvalid > 0) m += ' - misted: ' + numInvalid + ' ';
    m += '/ Ciudades: ' +t.citiesToScout[0].length+ ' ';
    if (t.citiesToScout[0].length != numCities) m += ' - Total ' + numCities + '';
    m += ')</div><div>';
    document.getElementById('IdScoutAllianceStatus').innerHTML = m;
    if (t.citiesToScout[0].length > 0) {
      /*var m = '<table width=100%><tr><td>Ciudad explorando</td><td>Jugador</td><td>Cordenadas</td><td>Distancia</td></tr>'; 
      for(var i=0; i < Cities.numCities; i++) {
            var list=t.citiesToScout[i];
            for (var z=0;z<list.length;z++) {
             m+="<tr><td>"+Cities.cities[i].name+"</td><td>"+list[z].nom+"</td><td>"+list[z].x+","+list[z].y+"</td><td>"+list[z].dist+"</td></tr>";
            }
      }
      m+="</table></div>";*/
      t.ScoutAllianceOptions.scout_ready = true;
      t.setScoutAllianceOptions();
      document.getElementById('IdScoutingStatus').value ="autoscout = OFF";
    }
  },


  toggleScoutingStatus: function(obj){     var t = Tabs.ScoutAlliance;     var o = t.ScoutAllianceOptions;     if (!o.scout_ready) return;     if (o.scouting) {         o.scouting = false;         t.setScoutAllianceOptions();         obj.value ="autoscout= OFF";         t.nextscout = null;     } else {         o.scouting = true;         t.setScoutAllianceOptions();         obj.value ="autoscout = ON";         t.doNextScout();     } },

  doNextScout: function(){
     var t = Tabs.ScoutAlliance;
     var o = t.ScoutAllianceOptions;
     if (!o.scout_ready) return;
     if (!o.scouting) return;
     var slots = 0;
     var can_scout = false;
     that_city = t.city;
	var now = new Date().getTime()/1000.0;
  		  now = now.toFixed(0);
  		  
     do {
       t.city += 1;
       if (t.city>=Seed.cities.length){ t.city=0; }

       this_city = t.city;
       if (this_city == that_city) { t.nextscout = setTimeout(t.doNextScout,(parseInt(o.scout_interval)*1000)); return; }
       city = Cities.cities[this_city];
       if (t.citiesToScout[this_city].length == 0) { o.scout_ready = false; o.scouting = false; t.setScoutAllianceOptions(); document.getElementById('IdScoutingStatus').value ="scout = NOT READY";          t.nextscout = null;          return; }
       if(parseInt(Seed.units['city'+city.id]['unt'+3]) < parseInt(o.num_scouts)){ continue; }

       var rallypointlevel = t.getRallypoint(city.id);
       if(rallypointlevel == 12) rallypointlevel = 11;
       slots = 0;
       if (Seed.queue_atkp['city'+city.id] != undefined){
	       for(var k in Seed.queue_atkp['city'+city.id])
		      slots++;
		      if(Seed.queue_atkp['city'+city.id].toSource() == "[]")
		          slots = 0;
	}
	  else slots=0;
	  
       id=t.citiesToScout[this_city][0].x+","+t.citiesToScout[this_city][0].y;
       if (t.ScoutAllianceOptions.scoutage[id]) {       
        last = t.ScoutAllianceOptions.scoutage[id];
        if ( now < (parseInt(last) + (24 * 60 * 60))){
         t.scout_delete(t.citiesToScout[this_city][0].x,t.citiesToScout[this_city][0].y);    
         
         continue;
        }
       } 
       if(slots >= rallypointlevel){          continue;        }
       can_scout = true;

    } while (!can_scout);
	
	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.cid = city.id;
	params.kid = 0;
	params.type = 3;
	params.xcoord = t.citiesToScout[this_city][0].x;
	params.ycoord = t.citiesToScout[this_city][0].y;
	params.u3 = parseInt(o.num_scouts);
	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
		 method: "post",
		 parameters: params,
		 onSuccess: function (rslt) {
		 if (rslt.ok) {
			 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
			 var ut = unixTime();
			 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 for(i = 0; i <= unitsarr.length; i++){
				if(params["u"+i]){
				unitsarr[i] = params["u"+i];
				}
			 }
			 var currentcityid = params.cid;
			 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
			 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
			 document.getElementById('IdScoutAllianceProgress').innerHTML += 'scout sent from '+city.name+' a '+t.citiesToScout[this_city][0].nom+' '+params.xcoord+', '+params.ycoord+' - distance : '+t.citiesToScout[this_city][0].dist+'<BR>';
                         t.scout_done(params.xcoord, params.ycoord);
                         t.nextscout = setTimeout(t.doNextScout,(o.scout_interval*1000));
		 } else {
                         rslt.errorMsg = unsafeWindow.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));
			 document.getElementById('IdScoutAllianceProgress').innerHTML += 'Error sending '+city.name+' a '+t.citiesToScout[this_city][0].nom+' '+params.xcoord+', '+params.ycoord+' ['+rslt.errorMsg+']<BR>';
                          // protection du joueur
                          if (rslt.error_code==208) t.scout_done(params.xcoord, params.ycoord);                        
                         t.nextscout = setTimeout(t.doNextScout,(o.scout_interval*1000));
		  }
		},
		onFailure: function () {}
  		});
  },

 getRallypoint: function(cityId){
      var t = Tabs.ScoutAlliance;
      cityId = 'city'+cityId;
      for (o in Seed.buildings[cityId]){
		var buildingType = parseInt(Seed.buildings[cityId][o][0]);
		var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
		if (buildingType == 12){
			return parseInt(buildingLevel);
			break;
		}
	   }
	  return 0;
    },
  scout_delete : function(x,y) {
    var t = Tabs.ScoutAlliance;
    var id = x + "," + y;
    
    for(var i=0; i < Cities.numCities; i++) {
     for (var c=0; c < (t.citiesToScout[i].length); c++) {
       if (parseInt(t.citiesToScout[i][c].x) == parseInt(x) && parseInt(t.citiesToScout[i][c].y) == parseInt(y)) {
             t.citiesToScout[i].splice(parseInt(c), 1);
       }
     }
    }
   document.getElementById('IdScoutAllianceProgress').innerHTML += 'scout '+t.citiesToScout[this_city][0].nom+' en '+x+', '+y+' - <b>Restrict scan 24 hours</b><BR>';
     
  },
  scout_done: function(x,y){
     var t = Tabs.ScoutAlliance;
     var cnt = 0;
     for(var i=0; i < Cities.numCities; i++) {
       for (var c=0; c < (t.citiesToScout[i].length); c++) {
         if (parseInt(t.citiesToScout[i][c].x) == parseInt(x) && parseInt(t.citiesToScout[i][c].y) == parseInt(y)) {
           var now = new Date().getTime()/1000.0;
	   now = now.toFixed(0);
	   var id = x + "," + y;
           t.ScoutAllianceOptions.scoutage[id] = now;
           t.setScoutAllianceOptions();
           t.citiesToScout[i].splice(parseInt(c), 1);
           GM_setValue('CitiesToScout_city_' + i + '_' + getServerId(), JSON2.stringify(t.citiesToScout[i]));
           cnt++;
           break;
         }
       }
    }
    if (cnt != Cities.numCities) {
    }
  },
}

 /*********************************  Barbing Tab - now the Dark Forest Tab ***********************************/
Tabs.Barb = {
  tabLabel: 'DF',
  tabOrder : 6,
  myDiv : null,
  MapAjax : new CMapAjax(),
  popFirst : true,
  opt : {},
  nextattack : null,
  searchRunning : false,
  tilesSearched : 0,
  tilesFound : 0,
  curX : 0,
  curY : 0,
  lastX : 0,
  firstX : 0,
  firstY : 0,
  lastY : 0,
  rallypointlevel:0,
  knt:{},
  barbArray:{},
  lookup:1,
  city:0,
  deleting:false,
  
    
  init : function (div){
    var t = Tabs.Barb;
    t.myDiv = div;


 
    var m = '<DIV id=pbTowrtDivF class=pbStat>AUTOMATED FOREST FUNCTION</div><TABLE id=pbbarbingfunctions width=100% height=0% class=pbTab><TR align="center">';
          m += '<TD align=center><INPUT id=pbBarbState type=submit value="DF = '+ (AttackOptions.Running?'ON':'OFF')+'"></td>';
	        updatebotbutton('DF-'+ (AttackOptions.Running?'ON':'OFF')+'', 'pbbosquestab'); 

	  m += '<TD><INPUT id=troopselect type=submit value="Select troops"></td>';
	  m += '<TD><INPUT id=Options type=submit value="Option"></td>';
	  m += '</tr></table></div>';
	  
	  m += '<DIV id=pbTraderDivD class=pbStat>FOREST STATS</div>';
	
	  m += '<TABLE id=pbbarbstats width=95% height=0% class=pbTab><TR align="left"><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD>' + Seed.cities[i][1] +'</td>';
	  }
	  m+='</tr><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pdtotalcity' + i +'></span></div></td>';
	  }
	  m+='</tr><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pddatacity' + i +'></span></div></td>';
	  }
	  m+='</tr><TR>'
	   for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pddataarray' + i +'></span></div></td>';
	 }
	 m+='</tr></table><TABLE id=pbbarbstats width=95% height=0% class=pbTab><TR align="left"><TR>';
	 for (i=0;i<=6;i++) {
	 	m+='<TD><DIV><span id='+ 'pberror' + i +'></span></div></td>';
     }
     m+='</tr></table>';
     m += '<DIV id=pbTraderDivD class=pbStat>FOREST OPTIONS</div>';
     m += '<TABLE width=95% height=0% class=ptTab><TR align="left">';
     for(i=0;i<Seed.cities.length;i++){
        m += '<TR><TD>' + Seed.cities[i][1] +'</td>';
        for (w=1;w<=10;w++){
           m += '<TD class=pblevelopt><INPUT id=pbcity'+i+'level'+w+' type=checkbox unchecked=true>level:'+w+'</td>';
        }
     }
    
     t.myDiv.innerHTML = m;

     saveAttackOptions();
	 t.checkBarbData();

     for(i=0;i<Seed.cities.length;i++){
		var element = 'pdtotalcity'+i;
		if (t.barbArray[i+1] == undefined) document.getElementById(element).innerHTML = 'No Data';
		else document.getElementById(element).innerHTML =  'Forests:' + t.barbArray[i+1].length;
     }
    
    for(i=0;i<Seed.cities.length;i++){
		for (w=1;w<=10;w++){
			document.getElementById('pbcity'+i+'level'+w).checked = AttackOptions.Levels[i+1][w]; 
		}
    }
    
	document.getElementById('pbBarbState').addEventListener('click', function(){t.toggleBarbState(this)} , false);
	document.getElementById('Options').addEventListener('click', t.barbOptions , false);
	document.getElementById('troopselect').addEventListener('click', t.troopOptions , false);
    var element_class = document.getElementsByClassName('pblevelopt');
    for (k=0;k<element_class.length;k++){
    	element_class[k].addEventListener('click', t.saveLevelOptions , false);
    }
   },
  
  saveLevelOptions : function(){
		for(i=0;i<Seed.cities.length;i++){
			AttackOptions.Levels[i+1][0]=false;
			for (w=1;w<=10;w++){
				var ele = document.getElementById('pbcity'+i+'level'+w);
				AttackOptions.Levels[i+1][w]=ele.checked;
				if (ele.checked)					
					AttackOptions.Levels[i+1][0]=true;
			}		
		}
		saveAttackOptions();
   },
   
  troopOptions: function(){
  	 var t = Tabs.Barb;
	 var troopDef = [
	  ['Supply', 1],
      ['Miltia', 2],
      ['Scout', 3],
      ['Pikes', 4],
	  ['Swords', 5],
      ['Archers', 6],
      ['Cavalry', 7],
      ['Heavies', 8],
      ['Wagons', 9],
      ['Ballista', 10],
      ['Rams', 11],
	  ['Cats', 12],
     ];
  	 if(t.troopselect == null)	
		t.troopselect = new CPopup ('pbtroopselect', 0, 0, 815, 450, true, function(){t.saveTroops();});
  	 t.troopselect.centerMe (mainPop.getMainDiv());  
         t.troopselect.getTopDiv().innerHTML = '<div class=showBadged><CENTER><b>PowerKoc: Selection of troops to attack dark forests on the server '+getServerId()+'</b></CENTER></div>';
  	 var z= '<DIV id=pbTraderDivD class=pbStat>TROOP SELECTION</div><TABLE width=100%><TR>';
	 z+='<TD></td>';
	 for(var i=0; i<troopDef.length; i++)
		z+='<TD>'+troopDef[i][0]+'</td>';
	 z+='<TD>MIN dist</td><TD>MAX dist</td>';
	 for(i=0;i<10;i++){
	 	z += '<TR><TD>Nivel '+(i+1)+': </td>';
	 	for(var j=0; j<troopDef.length; j++){
	 		z += '<TD><INPUT id="level'+i+'troop'+j+'" type=text size=4 maxlength=6 value="'+AttackOptions.Troops[i+1][j+1]+'" /></td>';
	 	}
		z+='<TD align=left><INPUT id=Mindist'+i+' type=text size=3 maxlength=3 value="'+AttackOptions.MinDistance[i+1]+'"</td>';
	 	z+='<TD align=right><INPUT id=dist'+i+' type=text size=3 maxlength=3 value="'+AttackOptions.Distance[i+1]+'"</td>';
	 	z+='</tr>';		 		
	 }
	 z+='</table>';
	  t.troopselect.getMainDiv().innerHTML = z;
	  t.troopselect.show(true);
  },
  
  barbOptions: function(){
  	 var t = Tabs.Barb;
  	 if(t.barboptions == null)	
		t.barboptions = new CPopup ('pbbarboptions', 0,0, 408,350, true);
  	 t.barboptions.centerMe (mainPop.getMainDiv());  
	 t.barboptions.getTopDiv().innerHTML = '<div class=showBadged><CENTER><b>Dark Forest Options for server '+getServerId()+'</b></CENTER></div>';
  	var y = '<DIV style="max-height:400px; overflow-y:auto;"><DIV class=pbStat>RESET FORESTS/div><TABLE width=100%>';
	   y +='<TR><TD style="margin-top:5px; text-align:center;"><INPUT id=pbresetbarbs type=submit value="Reset Forestss"></td>';
	   y +='<TD style="margin-top:5px; text-align:center;"><INPUT id=pbpaintbarbs type=submit value="Show forests"></td>';
	   y += '<TD><SELECT id=pbcity type=list></td></tr></table>';
	   y +='<TD style="margin-top:5px; text-align:center;"><DIV class=pbStat> OPTIONS  </div></td><TABLE>';
     y +='<TR><TD>Attack interval: <INPUT id=pbsendint type=text size=4 maxlength=4 value='+ AttackOptions.SendInterval +' \> seconds</td></tr>';
     y +='<TR><TD>Max search distance: <INPUT id=pbmaxdist type=text size=4 maxlength=4 value='+ AttackOptions.MaxDistance +' \></td></tr>';
     y +='<TR><TD>Keep <INPUT id=rallyclip type=text size=1 maxlength=2 value="'+AttackOptions.RallyClip+'" \> rallypoint slot(s) free</td></tr>';
     y +='<TR><TD><INPUT id=pbreport type=checkbox '+(AttackOptions.UpdateEnabled?'CHECKED':'')+'\> Reset search each <INPUT id=pbmsgint type=text size=2 maxlength=2 value='+AttackOptions.UpdateInterval+' \>minutes</td></tr>';
	 y +='<TR><TD> Skip city after <INPUT id=barbstopsearch type=text size=4 value='+AttackOptions.stopsearch+' \> attempts.</td></tr>';
     y +='<TR><TD>Method : '+htmlSelector({distance:'Closest first', level:'Highest level first', lowlevel:'Lowest level first'}, AttackOptions.Method, 'id=pbmethod')+'</td></tr>';
     y +='<TR><TD>priority knights : '+htmlSelector({0:'Lowest combat skill', 1:'Highest combat skill'}, AttackOptions.knightselector, 'id=barbknight')+'</td></tr>';
     y+='</table></td></tr></table>';
	   t.barboptions.getMainDiv().innerHTML = y;
	   t.barboptions.show(true);
	
	document.getElementById('pbcity').options.length=0;
	for (i=0;i<Seed.cities.length;i++){
		var o = document.createElement("option");
		o.text = Seed.cities[i][1]
		o.value = i+1;
		document.getElementById("pbcity").options.add(o);
	}
	   
	document.getElementById('pbpaintbarbs').addEventListener('click', function(){
			t.showBarbs(document.getElementById("pbcity").value,Seed.cities[document.getElementById("pbcity").value -1][1]);
			
    },false);
	document.getElementById('pbresetbarbs').addEventListener('click', t.deletebarbs,false);
	document.getElementById('pbmethod').addEventListener('change', function(){
		AttackOptions.Method=document.getElementById('pbmethod').value;
		saveAttackOptions();
		t.checkBarbData();
	},false);
	document.getElementById('barbknight').addEventListener('change', function(){
		AttackOptions.knightselector=document.getElementById('barbknight').value;
		saveAttackOptions();
	},false);
	document.getElementById('pbreport').addEventListener('change', function(){
		AttackOptions.UpdateEnabled=document.getElementById('pbreport').checked;
		saveAttackOptions();
	},false);
	document.getElementById('pbmsgint').addEventListener('change', function(){
		AttackOptions.UpdateInterval=parseInt(document.getElementById('pbmsgint').value);
		saveAttackOptions();
	},false);
    document.getElementById('pbsendint').addEventListener('change', function(){
		if(parseInt(document.getElementById('pbsendint').value) <5) //Set minimum attack interval to 5 seconds
			document.getElementById('pbsendint').value = 5;
		AttackOptions.SendInterval=parseInt(document.getElementById('pbsendint').value);
		saveAttackOptions();
	},false);
    document.getElementById('pbmaxdist').addEventListener('change', function(){
		if(parseInt(document.getElementById('pbmaxdist').value) > 75)
			document.getElementById('pbmaxdist').value = 75;
		AttackOptions.MaxDistance=parseInt(document.getElementById('pbmaxdist').value);
		saveAttackOptions();
	},false);
    document.getElementById('rallyclip').addEventListener('change', function(){
		AttackOptions.RallyClip=parseInt(document.getElementById('rallyclip').value);
		saveAttackOptions();
	},false);
    document.getElementById('barbstopsearch').addEventListener('change', function(){
		document.getElementById('barbstopsearch').value = parseInt(document.getElementById('barbstopsearch').value)>0?document.getElementById('barbstopsearch').value:1
		AttackOptions.stopsearch=parseInt(document.getElementById('barbstopsearch').value);
		saveAttackOptions();
	},false);    
  },
  
    showBarbs: function (citynumber,cityname) {
		var t = Tabs.Barb;
		var popTradeRoutes = null;
		t.popTradeRoutes = new CPopup('pbShowBarbs', 0, 0, 500, 500, true, function() {clearTimeout (1000);});
		var m = '<DIV style="max-height:460px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbShowBarbs" id="pbBars">';       
		t.popTradeRoutes.getMainDiv().innerHTML = '</table></div>' + m;
		t.popTradeRoutes.getTopDiv().innerHTML = '<TD><B>Dark forests of the city: '+cityname+'</td>';
		t.paintBarbs(citynumber,cityname);
		t._addTabHeader(citynumber,cityname);
		t.popTradeRoutes.show(true)	;
	 },
  	paintBarbs: function(i,cityname){
	        var t = Tabs.Barb;
				for (k=(t.barbArray[i].length-1);k>=0;k--){t._addTab(i,cityname,k+1,t.barbArray[i][k]['x'], t.barbArray[i][k]['y'],t.barbArray[i][k]['dist'], t.barbArray[i][k]['level']);}
	    },
	  
  _addTab: function(citynumber,cityname,queueId,X,Y,dist,level){
	 var t = Tabs.Barb;
	 var row = document.getElementById('pbBars').insertRow(0);
	 row.vAlign = 'top';
	 row.insertCell(0).innerHTML = queueId;
	 row.insertCell(1).innerHTML = X;
	 row.insertCell(2).innerHTML = Y;
	 row.insertCell(3).innerHTML = dist;
	 row.insertCell(4).innerHTML = level;
	 row.insertCell(5).innerHTML = '<a class="button20" id="barbdel_' + queueId + '"><span>delete</span></a>';
	 document.getElementById('barbdel_' + queueId).addEventListener('click', function(){
		t.deleteBarbElement(citynumber,queueId,cityname, true);
	 }, false);
  },
	 
  _addTabHeader: function(citynumber,cityname) {
	 var t = Tabs.Barb;
	 var row = document.getElementById('pbBars').insertRow(0);
	 row.vAlign = 'top';
	 row.insertCell(0).innerHTML = "Bosque";
	 row.insertCell(1).innerHTML = "X";
	 row.insertCell(2).innerHTML = "Y";
	 row.insertCell(3).innerHTML = "Dist.";
	 row.insertCell(4).innerHTML = "level";
	 row.insertCell(5).innerHTML = '<a class="button20" id="barbdelAll"><span>Clear all</span></a>';
	 document.getElementById('barbdelAll').addEventListener('click', function(){
		t.deleteBarbsCity(citynumber,cityname);
	 }, false);
  },   
	   
  deleteBarbElement: function(citynumber,queueId,cityname,showFlag){
      var t = Tabs.Barb;
      var queueId = parseInt(queueId);
      var myarray = t.barbArray[citynumber];
      if (myarray) {
        myarray.splice((queueId-1), 1);
        GM_setValue('DF_' + Seed.player['name'] + '_city_' + citynumber + '_' + getServerId(), JSON2.stringify(myarray));
        t.checkBarbData();
        if (showFlag) t.showBarbs(citynumber,cityname);
       }
  },
	  
  deleteBarbsCity: function(citynumber,cityname){
      var t = Tabs.Barb;
      var queueId = parseInt(queueId);
	  AttackOptions.Update[citynumber][1] = 0;
      GM_deleteValue('DF_' + Seed.player['name'] + '_city_' + citynumber + '_' + getServerId())
      t.checkBarbData();
      t.showBarbs(citynumber,cityname);
      reloadKOC();
  },  
  
  saveTroops: function(){
    for(i=0;i<10;i++){
  	 	for (w=0;w<12;w++){
  	 		AttackOptions.Troops[i+1][w+1] = parseIntNan(document.getElementById('level'+i+'troop'+w).value);
  	 	}
		if(parseIntNan(document.getElementById('dist'+i).value) > AttackOptions.MaxDistance)
			document.getElementById('dist'+i).value = AttackOptions.MaxDistance;
		AttackOptions.MinDistance[i+1] = parseIntNan(document.getElementById('Mindist'+i).value);
  	 	AttackOptions.Distance[i+1] = parseIntNan(document.getElementById('dist'+i).value);	 		
	 }
	 saveAttackOptions();
  },
  
   deletebarbs: function(){
	for (i=1;i<=Seed.cities.length;i++){
		AttackOptions.Update[i][1] = 0;
		GM_deleteValue('DF_' + Seed.player['name'] + '_city_' + i + '_' + getServerId())
	}
	reloadKOC();
   },

  checkBarbData: function(){
  	var t = Tabs.Barb;
	if(!AttackOptions.Running) return;
	  for (i=1;i<=Seed.cities.length;i++){
		if (!AttackOptions.Levels[i][0]) continue; //Skip city if not selected
		t.barbArray[i] = [];
	  	var myarray = JSON2.parse(GM_getValue('DF_' + Seed.player['name'] + '_city_' + i + '_' + getServerId(),"[]"));
		if ((myarray == undefined || myarray.length == 0) && t.searchRunning==false) {
	  		t.lookup=i;
			if(parseInt(AttackOptions.Update[t.lookup][1]) >= parseInt(AttackOptions.stopsearch)) continue; //Skip if search results are empty more than X times
			t.searchRunning = true;
	  		t.opt.startX = parseInt(Seed.cities[(i-1)][2]);
	  		t.opt.startY = parseInt(Seed.cities[(i-1)][3]);  
	  		t.clickedSearch();
			break;
	  	}
		if (myarray){
			if(AttackOptions.Method == 'distance') t.barbArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['dist'];b = b['dist'];return a == b ? 0 : (a < b ? -1 : 1);});
			if(AttackOptions.Method == 'level') t.barbArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['level']+a['dist'];b = b['level']+b['dist'];return a == b ? 0 : (a > b ? -1 : 1);});
			if(AttackOptions.Method == 'lowlevel') t.barbArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['level']+a['dist'];b = b['level']+b['dist'];return a == b ? 0 : (a < b ? -1 : 1);});
	  		GM_setValue('DF_' + Seed.player['name'] + '_city_' + i + '_' + getServerId(), JSON2.stringify(t.barbArray[i]));
	  	}
		AttackOptions.Update[i][1] = 0;
		saveAttackOptions();
	  }
	  t.nextattack = setTimeout(t.getnextCity, parseInt((Math.random()*3000)+2000));
  },
  
  toggleBarbState: function(obj){
	var t = Tabs.Barb;
        obj = document.getElementById('pbBarbState');
	if (AttackOptions.Running == true) {
		AttackOptions.Running = false;
		obj.value = "DF = OFF";
                updatebotbutton('DF-OFF', 'pbbosquestab');
		saveAttackOptions();
		t.nextattack = null;
	} else {
		AttackOptions.Running = true;
		obj.value = "DF = ON";
                updatebotbutton('DF-ON', 'pbbosquestab');
		saveAttackOptions();
		t.checkBarbData();
		t.nextattack = setTimeout(t.getnextCity, parseInt((Math.random()*3000)+2000));
	}
  },
  
  barbing : function(){
  	   var t = Tabs.Barb;
	   var city = t.city;
       citynumber = Seed.cities[city-1][0];
       cityID = 'city' + citynumber; 
       t.getAtkKnight(cityID);
       t.getRallypointLevel(cityID);
       if (t.rallypointlevel > 11 ) t.rallypointlevel = 11;
	   var slots=0;
	   if (Seed.queue_atkp[cityID] != undefined){
	       for(var k in Seed.queue_atkp[cityID])
		    slots++;
		   if(Seed.queue_atkp[cityID].toSource() == "[]")
			slots = 0;
		} else
			slots=0; 
       var element1 = 'pddatacity'+(city-1);
       document.getElementById(element1).innerHTML = 'sent: ' + AttackOptions.BarbsDone[city]; 
       var element2 = 'pddataarray'+(city-1); 
       document.getElementById(element2).innerHTML = 'PR: (' + slots + '/' + t.rallypointlevel +')';
	   if ((t.rallypointlevel-AttackOptions.RallyClip) <= slots) return;
	   if (t.knt.toSource() == "[]") return; 
	   var kid = t.knt[0].ID;
	   if(t.barbArray[city].length > 0)
		var barbinfo = t.barbArray[city].shift();
	   else if(parseInt(AttackOptions.Update[city][1])==0){
		t.checkBarbData();
		return;
	   } else 
		return;
       var check=0;
       var barblevel = parseInt(barbinfo.level);
       if (AttackOptions.Levels[city][barbinfo.level]) check=1;
       if (barbinfo.dist < AttackOptions.MinDistance[barblevel] || barbinfo.dist > AttackOptions.Distance[barblevel]){
			check=0;
			GM_setValue('DF_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.barbArray[city]));
			return;
		}

         // check troop levels in city
         var trps = AttackOptions.Troops[barblevel];
         var num_troops = 0;
         for (var ii=1; ii<13; ii++) {
	        if (parseInt(trps[ii]) > Seed.units[cityID]['unt'+ii]) check = 0;
	        num_troops += trps[ii];
         }
         if (num_troops == 0) check = 0;
         if (check == 0){
		t.barbArray[city].push(barbinfo);
		GM_setValue('DF_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.barbArray[city]));
		return;
	   }
        	var element = 'pdtotalcity'+(city-1);
		if (t.barbArray[city] == undefined) document.getElementById(element).innerHTML = 'No Data';
		else document.getElementById(element).innerHTML =  'Forests:' + t.barbArray[city].length;
       var xcoord = barbinfo['x'];
       var ycoord = barbinfo['y'];
       t.doBarb(citynumber,city,xcoord,ycoord,barblevel,kid,trps);
       saveAttackOptions();
  },

  getnextCity: function(){
	var t = Tabs.Barb;
	if(t.searchRunning || !AttackOptions.Running) return;
	t.nextattack = setTimeout(t.getnextCity, parseInt((Math.random()*3)+AttackOptions.SendInterval)*1000);
	var city = t.city+1;
	if (city>Seed.cities.length){
		city=1;
	}
	t.city = city;
	if(AttackOptions.UpdateEnabled){
		var now = unixTime();
		if(now > parseInt(AttackOptions.Update[city][0] + (AttackOptions.UpdateInterval*60))){
			AttackOptions.Update[city][1]=0;
			t.barbArray[city] = []; //Clears data if last update was more than X minutes
			GM_setValue('DF_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.barbArray[city]));
		}
	}
	if(AttackOptions.Levels[city][0])
		t.barbing();
  },
  
  getRallypointLevel: function(cityId){
    var t = Tabs.Barb;
    for (var o in Seed.buildings[cityId]){
  	var buildingType = parseInt(Seed.buildings[cityId][o][0]);
  	var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
  	if (buildingType == 12) t.rallypointlevel=parseInt(buildingLevel);
     }
  }, 
  
  getAtkKnight : function(cityID){
     var t = Tabs.Barb;
     t.knt = new Array();
     t.getRallypointLevel(cityID);
     for (k in Seed.knights[cityID]){
     		if (Seed.knights[cityID][k]["knightStatus"] == 1 && Seed.leaders[cityID]["resourcefulnessKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["politicsKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["combatKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["intelligenceKnightId"] != Seed.knights[cityID][k]["knightId"]){
     			t.knt.push ({
     				Name:   Seed.knights[cityID][k]["knightName"],
     				Combat:	Seed.knights[cityID][k]["combat"],
     				ID:		Seed.knights[cityID][k]["knightId"],
     			});
     		}
     }
     t.knt = t.knt.sort(function sort(a,b) {
	a = parseInt(a['Combat']);
	b = parseInt(b['Combat']);
     if(parseInt(AttackOptions.knightselector) > 0)
	return a == b ? 0 : (a > b ? -1 : 1);
     else
	return a == b ? 0 : (a < b ? -1 : 1);
      });
  },
    
  doBarb: function(cityID,counter,xcoord,ycoord,level,kid,trps){
  		var t = Tabs.Barb;
    		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		params.cid=cityID;
  		params.type=4;
  	        params.kid=kid;
  		params.xcoord = xcoord;
  		params.ycoord = ycoord;
		for (ii=1; ii<13; ii++) {
			if(parseInt(trps[ii]) > 0)
				params['u'+ii]=trps[ii];
        }
    		AttackOptions.BarbsTried++;
  		document.getElementById('pberror1').innerHTML = 'Intentos:'+ AttackOptions.BarbsTried; 
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  		         loading: true,
  		         onSuccess: function (transport) {
				   var rslt = eval("(" + transport.responseText + ")");
				   if (rslt.ok) {
					 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
					 var ut = unsafeWindow.unixtime();
					 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
					 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
					 for(i = 0; i <= unitsarr.length; i++){
						if(params["u"+i]){
						unitsarr[i] = params["u"+i];
						}
					 }
					 var currentcityid = params.cid;
					 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
					 unsafeWindow.update_seed(rslt.updateSeed)
					 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
					 var slots=0;
					 for(var k in Seed.queue_atkp['city'+cityID])
					  slots++;
					 if(Seed.queue_atkp['city'+cityID].toSource() == "[]")
					  slots = 0;
					 AttackOptions.BarbsDone[counter]++;
					 var element1 = 'pddatacity'+(counter-1);
					 document.getElementById(element1).innerHTML = 'sent: ' + AttackOptions.BarbsDone[counter]; 
					 var element2 = 'pddataarray'+(counter-1); 
					 document.getElementById(element2).innerHTML = 'PR: (' + slots + '/' + t.rallypointlevel +')';
					 var now = new Date().getTime()/1000.0;
					 now = now.toFixed(0);
					 GM_setValue('DF_' + Seed.player['name'] + '_city_' + counter + '_' + getServerId(), JSON2.stringify(t.barbArray[counter]));
					 saveAttackOptions();
				   } else {
					 if (rslt.error_code != 8 && rslt.error_code != 213 && rslt.error_code == 210) AttackOptions.BarbsFailedVaria++;
					 if (rslt.error_code == 213)AttackOptions.BarbsFailedKnight++;
					 if (rslt.error_code == 210) AttackOptions.BarbsFailedRP++;
					 if (rslt.error_code == 8) AttackOptions.BarbsFailedTraffic++;
					 if (rslt.error_code == 104) {
					   AttackOptions.BarbsFailedBog++;
					   GM_setValue('DF_' + Seed.player['name'] + '_city_' + counter + '_' + getServerId(), JSON2.stringify(t.barbArray[counter]));
					   saveAttackOptions();
					 }
					 document.getElementById('pberror2').innerHTML = 'Errors excess traffic:' + AttackOptions.BarbsFailedTraffic; 
					 document.getElementById('pberror3').innerHTML = 'Meeting point errors:'+ AttackOptions.BarbsFailedRP;
					 document.getElementById('pberror4').innerHTML = 'knights errors:' + AttackOptions.BarbsFailedKnight;
					 document.getElementById('pberror5').innerHTML = 'other errors:' + AttackOptions.BarbsFailedVaria;
					 document.getElementById('pberror6').innerHTML = 'Bog errores:' + AttackOptions.BarbsFailedBog;
					 }
  		         },
  		         onFailure: function () {}
  		 });
  	 saveAttackOptions();
  },
  
  sendreport: function(){
	  var t = Tabs.Barb;
	  var total = 0;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.emailTo = Seed.player['name'];
    params.subject = "Barb Overview";
    var message = 'Barbing Stats: (Sent/Total)' + '%0A';
    for (x=1;x<=Seed.cities.length;x++){	 
    	message+= Seed.cities[x-1][1] + ': (' + AttackOptions.BarbsDone[x] + '/' + t.barbArray[x].length +')' + '%0A';
    }
    message += '%0A'+ 'Errors excess traffic: ' + AttackOptions.BarbsFailedTraffic +'%0A';
    message += 'Meeting point errors: ' + AttackOptions.BarbsFailedRP +'%0A';
    message += 'knights errors: ' + AttackOptions.BarbsFailedKnight +'%0A';
    message += 'other errors: ' + AttackOptions.BarbsFailedVaria +'%0A';
    message += 'Actual sent attacks: ' + (AttackOptions.BarbsTried - AttackOptions.BarbsFailedTraffic - AttackOptions.BarbsFailedRP - AttackOptions.BarbsFailedKnight -  AttackOptions.BarbsFailedVaria) +'%0A';
    message += '%0A'+'%0A' + 'Food Gain (for '+AttackOptions.MsgInterval+' hour of barbing)' +'%0A';
    for (q=1;q<=Seed.cities.length;q++){
    	var cityID = 'city' + Seed.cities[q-1][0];
    	var gain = parseInt(Seed.resources[cityID]['rec1'][0] / 3600) - AttackOptions.Foodstatus[q];
    	message+= Seed.cities[q-1][1] + ': Start: ' + addCommas(AttackOptions.Foodstatus[q]) + ' End :' + addCommas(parseInt(Seed.resources[cityID]['rec1'][0] / 3600)) + ' Gain: ';
    	message += addCommas(gain)  + '%0A';
		total += gain;
    }
	message += '%0A Total food gain : '+addCommas(total)+'%0A';
    params.message = message;
    params.requestType = "COMPOSED_MAIL";
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
            } else {
            }
        },
        onFailure: function () {
        },
    });  
  },
  
  clickedSearch : function (){
    var t = Tabs.Barb;
    t.opt.maxDistance = parseInt(AttackOptions.MaxDistance); 
    t.opt.searchShape = 'circle'; 
    t.mapDat = [];
    t.firstX =  t.opt.startX - t.opt.maxDistance;
    t.lastX = t.opt.startX + t.opt.maxDistance;
    t.firstY =  t.opt.startY - t.opt.maxDistance;
    t.lastY = t.opt.startY + t.opt.maxDistance;
    t.tilesSearched = 0;
    t.tilesFound = 0;
    t.curX = t.firstX;
    t.curY = t.firstY;
    var xxx = t.MapAjax.normalize(t.curX);
    var yyy = t.MapAjax.normalize(t.curY);
    var element = 'pddatacity'+(t.lookup-1);
    document.getElementById(element).innerHTML = 'seeking '+ xxx +','+ yyy;
    setTimeout (function(){t.MapAjax.request (xxx, yyy, 15, t.mapCallback)}, MAP_DELAY);
  },
  
  mapCallback : function (left, top, width, rslt){
    var t = Tabs.Barb;
    if (!t.searchRunning)
      return;
    if (!rslt.ok){
      t.stopSearch ('ERROR: '+ rslt.errorMsg);
      return;
    }
    map = rslt.data;
    for (k in map){
	  if (map[k].tileType==54 && AttackOptions.Levels[t.lookup][map[k].tileLevel]){
	     var dist = distance (t.opt.startX, t.opt.startY, map[k].xCoord, map[k].yCoord);
		 if(dist <= parseInt(AttackOptions.MaxDistance))
			t.mapDat.push ({time:0,x:map[k].xCoord,y:map[k].yCoord,dist:dist,level:map[k].tileLevel});
	  }
    }
    t.tilesSearched += (15*15);
    t.curX += 15;
    if (t.curX > t.lastX){
      t.curX = t.firstX;
      t.curY += 15;
      if (t.curY > t.lastY){
		t.stopSearch('found: ' + t.mapDat.length);
        return;
      }
    }
    var x = t.MapAjax.normalize(t.curX);
    var y = t.MapAjax.normalize(t.curY);
    var element = 'pddatacity'+(t.lookup-1);
    document.getElementById(element).innerHTML = 'seeking '+ x +','+ y;
    setTimeout (function(){t.MapAjax.request (x, y, 15, t.mapCallback)}, MAP_DELAY);
  },
  
  stopSearch : function (msg){
    var t = Tabs.Barb;
	var element = 'pddatacity'+(t.lookup-1);
        document.getElementById(element).innerHTML = msg;
	GM_setValue('DF_' + Seed.player['name'] + '_city_' + t.lookup + '_' + getServerId(), JSON2.stringify(t.mapDat));
	AttackOptions.Update[t.lookup][0] = unixTime();
	AttackOptions.Update[t.lookup][1]++;
        t.searchRunning = false;
	saveAttackOptions();
	t.checkBarbData();
	return;
  },
  
  hide : function (){
  
  },

  show : function (){
  
  },
};

/***********************************************************************************/
/************ KOC POWER - TABS TOURNAMENT *****************************************/
/*********************************************************************************/
Tabs.Tournament = {
tabLabel : 'TOURNAMENT',
tabOrder : 27,
cont:null,
displayTimer : null,
 
init : function (div){
	var t = Tabs.Tournament;
	t.cont = div;
},

hide : function (){
	var t = Tabs.Tournament;
	clearTimeout (t.displayTimer);
},
getContent : function (){
	var t = Tabs.Tournament;
	return t.cont;
},
show : function () {
	var t = Tabs.Tournament;
	t.cont.style.overflowY = 'auto';
	t.cont.style.maxHeight = '650px';
  clearTimeout (t.displayTimer);
  t.cont.innerHTML = "<div class='tourny_modal_upsell'></div>";
  var mhtl = "<DIV class=pbStat>POPULATION AND PRODUCTION INFORMATION</div><table width=100% class=pbTab2><tr><td colspan=8>&nbsp;</td></tr><tr><td></td>";
  for(var i=0; i<Cities.numCities; i++) {
   mhtl += "<TD align=center valign=bottom width=60px><B>" + Cities.cities[i].name + "</B></TD>";
  }
  mhtl += "</tr><tr><td><img height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg title=Militiaman> Militiaman  / h</td>";
  var temps=[];
  for(var i=0; i<Cities.numCities; i++) {
   temps[i]=((Cities.cities[i]['Troop2Time'] > 0)?(3600 / Cities.cities[i]['Troop2Time']):0);
   mhtl += "<td>" + addCommas(parseInt(temps[i])) +"</td>";
  }
    mhtl += "</tr><tr><td><img height=18 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/population_40.png title=Population> Population / h</td>";
	var pop=[];
  for(var i=0; i<Cities.numCities; i++) {
   cityID = 'city'+ Cities.cities[i].id;
   pop[i] =  parseInt(Seed.citystats[cityID]["pop"][1]) / 2;
   mhtl += "<td>" + addCommas(parseInt(pop[i])) +"</td>";
  }
  mhtl += "</tr><tr><td><b>difference</b></td>";
  var diff=0;
  for(var i=0; i<Cities.numCities; i++) {
   diff = parseInt(pop[i] - temps[i]);
   var couleur=" style='font-color:green' ";
   if (diff<0) couleur=" style='background-color:red' ";
   mhtl += "<td "+couleur+"><b>" + addCommas(parseInt(diff)) +"</b></td>";
  }
  
   mhtl += "</tr><tr><td><img height=18 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/happiness.png title=happiness> happiness</td>";
   for(var i=0; i<Cities.numCities; i++) {
   cityID = 'city'+ Cities.cities[i].id;
   var bon = parseInt(Seed.citystats[cityID]["pop"][2]); 
   var bonc = "red";
   if (bon>99) bonc="green";
   mhtl += "<td style='background-color:"+bonc+"'><center><b>"+bon+"</td>";
  }
  var now = unixTime();
  mhtl += "</tr><tr><td><b>training time</b></td>";
    for(var i=0; i<Cities.numCities; i++) {
     cityID = 'city'+ Cities.cities[i].id;
     var totTime = 0;
     var q = Seed.queue_unt[cityID]; 
     if (q!=null && q.length>0)
         totTime = q[q.length-1][3] - now;
     if (totTime < 0) totTime = 0;
     if (totTime < 3600)
      var bonc="style='background-color:red'";
     else
      var bonc="";
     mhtl += "<td "+bonc+"><center><b>"+timestr(totTime)+"</td>";
    }
    
  mhtl += "</tr></table><br>";
  t.cont.innerHTML += mhtl;
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.format=2;
  params.tournyPos=0;
  new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/getLeaderboard.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
  
  onSuccess:function(transport){
   var rslt=eval("("+transport.responseText+")");
   if(rslt.ok){
   
    if(!rslt.data){
	   
	t.cont.innerHTML +="<div class=pbStat>CHECKING TOURNAMENT</div><div class='tourny_modal_upsell'><br><center><b>"+unsafeWindow.g_js_strings.modal_tourny_changetab.notourny+"</b></center></div>";
	  
	  
    }else{ //  rslt.data
     var tournyhtml=new Array();
     
     if(rslt.name){
	    tournyhtml.push("<div class=pbStat><center>"+rslt.name.replace('The Tournament of Might','The Tournament of Might')+"</center></div>")
     }  else{
	    tournyhtml.push("<div class='tournymodaltitle'><center>"+unsafeWindow.g_js_strings.commonstr.tournament+"</div>")
     }
	   tournyhtml.push("<div>");
	   
	   
	   
	   if(rslt.startdate&&rslt.enddate){
	   	   	    var startTime=rslt.startdate;
	   	   	    var endTime=rslt.enddate;
	   	   	    var now=parseInt(new Date().getTime()/1000);
	   	   	    tournyhtml.push("<table width=100% align=center class=pbTab><tr bgcolor=#FE8888><td width=40%><b>start</td><td width=40%><b>just</td><td width=20%><b>time Left</td></tr>");
	   	   	    dt = new Date ();
	   	            dt.setTime (startTime * 1000);
	   	            dtf = new Date ();
	   	            dtf.setTime (endTime * 1000);
	   	           
	   	            var restant = endTime - now; 
	   	            
	   	   	   
	   	   	   tournyhtml.push("<tr><td>");
	   	   	     tournyhtml.push("" + dt.toLocaleDateString() + " - "+ dt.toLocaleTimeString());
	   	   	    tournyhtml.push("</td><td>");
	   	   	    tournyhtml.push("" + dtf.toLocaleDateString()+ " - "+ dtf.toLocaleTimeString());
	   	   	    tournyhtml.push("</td><td>"+timestr(restant,1)+"</td></tr></table>");
	   	     tournyhtml.push("<br>");
	   
	   }
	   
	
	   tournyhtml.push("<center><table class='tourny_list_table' cellpadding='0' cellspacing='0' border='0' width=90% style='margin:5px'>");
	   tournyhtml.push("<thead>");
	   tournyhtml.push("<tr>");
     if(rslt.type==24){
	    tournyhtml.push("<td class='rankcol' style='background-color:red'>");
	    tournyhtml.push("<div><input type=button id='BOTournoiPM' value='-'>&nbsp;"+unsafeWindow.g_js_strings.commonstr.ranking+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>chancellor</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.commonstr.alliance+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.modal_tourny_changetab.mightgained+"</div>");
	    tournyhtml.push("</td  style='background-color:red'>");
	    tournyhtml.push("<td  style='background-color:red'> ");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.modal_tourny_changetab.rewardperplayer+"</div>");
	    tournyhtml.push("</td>")
      }else{
            tournyhtml.push("<td	class='rankcol' style='background-color:red'>");
	    tournyhtml.push("<div><input type=button id='BOTournoiPM' value='-'>&nbsp;"+unsafeWindow.g_js_strings.commonstr.ranking+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>player</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.commonstr.alliance+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+rslt.contestcategory+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.commonstr.reward+"</div>");
	    tournyhtml.push("</td>")
     }
	   tournyhtml.push("</tr>");
	   tournyhtml.push("</thead>");
	   tournyhtml.push("</tbody>");
	   var nb=rslt.data.length;
	   var votrepuissance = 0;
	   for(var i=0;i<rslt.data.length;i++){
	    var row=rslt.data[i];
	    if(rslt.type==24){ // Tournament
	     if (getMyAlliance()[1] == row.alliance) {
	      votrepuissance=row.contestValue;
	      break;
	     }
	    } else {
	     if (Seed.player.prefix + ' '+ Seed.player.name == row.name ) {
	      votrepuissance=row.contestValue;
	      break;
	     }	
	    }
	   }
	   for(var i=0;i< Options.TournoiLigne;i++){
	    var row=rslt.data[i];
	    var rewardString=row.itemCount+" ";
	    if(row.itemType==0){
	     rewardString+=unsafeWindow.g_js_strings.commonstr.gems;
	    }else{
	     rewardString+=unsafeWindow.itemlist["i"+row.itemType].name;
	    }
	    var couleur="";
	    if(rslt.type==24){ //Alliance Tournament
	     if (getMyAlliance()[1] == row.alliance) {
	      couleur=" style='background-color:#FF0000' ";
	     }
	    }else{
	     if (Seed.player.prefix + ' '+ Seed.player.name == row.name ) {
	      couleur=" style='background-color:#FF0000' ";
	     }
	    }
	    if(i%2==1){
	     tournyhtml.push("<tr>")
	    }else{
	     tournyhtml.push("<tr class='stripe'>")
	    }
	    tournyhtml.push("<td class='rankcol' "+couleur+">");
	    tournyhtml.push("<div><b>"+row.ranking+"</b></div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+row.name+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+(row.alliance||"----")+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+addCommas(row.contestValue));
	    if (votrepuissance>0) {
	      var ecartavecvous = parseInt(row.contestValue - votrepuissance);
	      if (ecartavecvous>0) {
	       tournyhtml.push("&nbsp;(+ " + addCommas(ecartavecvous) +")");
	      } 
	      if (ecartavecvous<0) {
	       tournyhtml.push("&nbsp;(" + addCommas(ecartavecvous) +")");
	      }
	    }
	    tournyhtml.push("</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+rewardString+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("</tr>")
	   } // fin du for
	
	      if(rslt.type!=24){

	    for(var i= Options.TournoiLigne;i<rslt.data.length;i++){
	   	    var row=rslt.data[i];
	   	 
	   	    if (Seed.player.prefix + ' '+ Seed.player.name == row.name ) {
	   	      var rewardString=row.itemCount+" ";
	   	     	    if(row.itemType==0){
	   	     	     rewardString+=unsafeWindow.g_js_strings.commonstr.gems;
	   	     	    }else{
	   	     	     rewardString+=unsafeWindow.itemlist["i"+row.itemType].name;
	   	     	    }
	   	     	    tournyhtml.push("<tr class='stripe' >")
	   	     	    tournyhtml.push("<td class='rankcol' style='background-color:#FF0000'>");
	   	     	    tournyhtml.push("<div><b>"+row.ranking+"</b></div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:#FF0000'>");
	   	     	    tournyhtml.push("<div>"+row.name+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:#FF0000'>");
	   	     	    tournyhtml.push("<div>"+(row.alliance||"----")+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:#FF0000'>");
	   	     	    tournyhtml.push("<div>"+addCommas(row.contestValue)+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:#FF0000'>");
	   	     	    tournyhtml.push("<div>"+rewardString+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	            tournyhtml.push("</tr>")
	   	   }    
	   }
	   }
	   tournyhtml.push("</tbody>");
	   tournyhtml.push("</table>");
      tournyhtml.push("</div>");
      t.cont.innerHTML += tournyhtml.join("");      
           document.getElementById('BOTournoiPM').addEventListener ('click', function() { 
            var lg=rslt.data.length;
            if (rslt.type!=24) lg=25;
            t.plusmoins(lg);
           }, false);      
           
        if ((Options.TournoiLigne==5 && rslt.type!=24) || (Options.TournoiLigne==5 && rslt.type==24)) {
	        document.getElementById('BOTournoiPM').value="Maximizar";
	    } else {
	        document.getElementById('BOTournoiPM').value="Minimizar";           
        }
          } // fin rslt.data 
         } else {
            t.cont.innerHTML = "<div class='tourny_modal_upsell'><center>No Info</div>";
         }
       }, onFailure:function()  {
         t.cont.innerHTML = "<div class='tourny_modal_upsell'><center>No Info</div>";
       }
   });
   t.displayTimer = setTimeout (t.show, 240000);       
  },
  plusmoins: function(lg) {
   var t = Tabs.Tournament;
   if (document.getElementById('BOTournoiPM').value=="Maximize") {
     document.getElementById('BOTournoiPM').value="Minimize";
     Options.TournoiLigne = lg;
   } else {
     document.getElementById('BOTournoiPM').value="Maximize";
     Options.TournoiLigne = 5;
   }
   saveOptions();
   clearTimeout (t.displayTimer);
   t.show();
  },  
}
/************************  AutoTrain Tab ************************/

Tabs.AutoTrain = {
  tabOrder: 18,
  tabLabel: 'AutoTrain',
  myDiv: null,
  city:0,
  gamble : {"1":{"min":"5","max":"15","cost":"2"},"2":{"min":"10","max":"25","cost":"4"}},
      init: function(div){
		var t = Tabs.AutoTrain;
        t.myDiv = div;
        t.city = 0;
	t.nextcity();


      var m = '<DIV id=pbAT class=pbStat>AUTO TRAINING</div><TABLE id=pbAT width=100% height=0%       class=pbTab><TR align="center">';
      if (TrainOptions.Running == false) {
          m += '<TD align=left><INPUT id=pbAutoTrainState type=submit value="AutoTrain = OFF"></td>';
		updatebotbutton('AutoTrain -OFF', 'pbtraintab');
      }else {
          m += '<TD align=center><INPUT id=pbAutoTrainState   type=submit value="AutoTrain = ON"></td>';
		updatebotbutton('AutoTrain-ON', 'pbtraintab');
      }
      m += '<TD align=center><INPUT id=pbShowTrainHelp type=submit value="Help"></td>';
      m += '</tr></table></div>';

      m += '<DIV class=pbStat>TRAINING OPTIONS</div><TABLE width=100% height=0% class=pbTab><TR align="center">';
     for (i=0;i<Seed.cities.length;i++){
      	  city = i+1;
      	   m += '<TABLE width=100% height=0% class=pbTab><TR align="left">';
           m+='<TR><TD width=30px><INPUT type=checkbox class='+city+' id="SelectCity'+city+'"></td>';
           m+='<TD><TABLE><TR>';
           m+='<TD><B>'+ Seed.cities[i][1] +'</b></td>'; 
	      m += '<TD width=150px><SELECT class='+city+' id="TroopsCity'+city+'"><option value="Select">--Select--</options>';
	      for (y in unsafeWindow.unitcost) m+='<option value="'+y.substr(3)+'">'+unsafeWindow.unitcost[y][0]+'</option>';
	      m+='</select></td>';
	      m +='<TD width=100px>Min.: <INPUT class='+city+' id=treshold'+city+' type=text size=4 maxlength=6 value="'+ TrainOptions.Threshold[city]+'"\></td>';
	      m +='<TD width=130px><INPUT type=checkbox class='+city+' id="SelectMax'+city+'"> Max.: <INPUT class='+city+' id=max'+city+' type=text size=5 maxlength=6 value="'+ TrainOptions.Max[city]+'"\></td>';
	      m +='<TD>workers use: ';
        m+='<SELECT class='+city+' id="workers'+city+'"><option value="0">0%</options>';
        m+='<option value="25">25%</options>';
        m+='<option value="50">50%</options>';
        m+='<option value="75">75%</options>';
        m+='<option value="100">100%</options>';
        m+='</td></tr></table></td><tr>';
        m += '<TD></td><TD><TABLE><TR>';
        m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png"></td>'; 
	      m += '<TD><INPUT class='+city+' id="KeepFood'+city+'" type=text size=7 maxlength=7 value="'+ TrainOptions.Keep[city]['Food']+'"\></td>';
	      m += '<TD width=20px><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png"></td>';
	      m += '<TD><INPUT class='+city+' id="KeepWood'+city+'" type=text size=7 maxlength=7 value="'+ TrainOptions.Keep[city]['Wood']+'"\></td>';
	      m += '<TD width=20px><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png"></td>';
	      m += '<TD><INPUT class='+city+' id="KeepStone'+city+'" type=text size=7 maxlength=7 value="'+ TrainOptions.Keep[city]['Stone']+'"\></td>';
	      m += '<TD width=20px><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png"></td>';
	      m += '<TD><INPUT class='+city+' id="KeepOre'+city+'" type=text size=7 maxlength=7 value="'+ TrainOptions.Keep[city]['Ore']+'"\></td>';
	      m += '<TD><SELECT class='+city+' id="Resource'+city+'"><option value="true">keep</options>';
	      m+='<option value="false">Usar</option>';
  	m+='</select></td>';
        m += '<TD><SELECT class='+city+' id="TrainSpeed_'+city+'">\
            <option value=0><CENTER>--- '+unsafeWindow.g_js_strings.commonstr.speedup+' ---</center></option>\
            <option value=1>'+ t.gamble[1].cost+'x res ('+ t.gamble[1].min+' - '+t.gamble[1].max+'%)</option>\
            <option value=2>'+ t.gamble[2].cost+'x res ('+ t.gamble[2].min+' - '+t.gamble[2].max+'%)</option></select>';
        m+='</td></tr></table>';
        m+='</td></tr></table>'; 
	  }
      t.myDiv.innerHTML = m;
      for (i=0;i<Seed.cities.length;i++){
           city = i+1;
           document.getElementById('TroopsCity'+city).value = TrainOptions.Troops[city];
           document.getElementById('SelectCity'+city).checked = TrainOptions.Enabled[city];
           document.getElementById('Resource'+city).value = TrainOptions.Resource[city];
           document.getElementById('SelectMax'+city).checked = TrainOptions.SelectMax[city];
           document.getElementById('workers'+city).value = TrainOptions.Workers[city];
           document.getElementById('TrainSpeed_'+city).value = TrainOptions.Gamble[city];
           if (!TrainOptions.SelectMax[city]) document.getElementById('max'+city).disabled=true;
      }
       document.getElementById('pbShowTrainHelp').addEventListener('click', function(){
       	t.helpPop(this);
       }, false);
       document.getElementById('pbAutoTrainState').addEventListener('click', function(){
      	t.toggleAutoTrainState(this);
      }, false);
      for(var k=1; k<=Seed.cities.length; k++){
     	document.getElementById('treshold'+k).addEventListener('change', function(e){
     	    if (isNaN(e.target.value)) e.target.value=0 ;
			TrainOptions.Threshold[e.target['className']] = e.target.value;
     		saveTrainOptions();
     	}, false);
     	document.getElementById('SelectMax'+k).addEventListener('change', function(e){
 		    TrainOptions.SelectMax[e.target['className']] = e.target.checked;
 		    if (!TrainOptions.SelectMax[e.target['className']]){
				document.getElementById('max'+e.target['className']).value = 0;
				document.getElementById('max'+e.target['className']).disabled=true;
			} else {
				document.getElementById('max'+e.target['className']).disabled=false;
			}
			saveTrainOptions();
 	    }, false);
 		document.getElementById('max'+k).addEventListener('change', function(e){
      	    TrainOptions.Max[e.target['className']] = e.target.value;
      	    saveTrainOptions();
      	}, false);
     	document.getElementById('workers'+k).addEventListener('change', function(e){
      	    TrainOptions.Workers[e.target['className']] = e.target.value;
      	    saveTrainOptions();
      	}, false);
     	document.getElementById('Resource'+k).addEventListener('change', function(e){
			TrainOptions.Resource[e.target['className']] = e.target.value;
     		saveTrainOptions();
		}, false);
     	document.getElementById('TrainSpeed_'+k).addEventListener('change', function(e){
			TrainOptions.Gamble[e.target['className']] = e.target.value;
     		saveTrainOptions();
		}, false);
        document.getElementById('SelectCity'+k).addEventListener('change', function(e){
            TrainOptions.Enabled[e.target['className']] = e.target.checked;
			saveTrainOptions();
      	}, false);
      	document.getElementById('TroopsCity'+k).addEventListener('change', function(e){
			TrainOptions.Troops[e.target['className']] = e.target.value;
            saveTrainOptions();
      	}, false);
      	document.getElementById('KeepFood'+k).addEventListener('change', function(e){
			if (isNaN(e.target.value)) e.target.value=0 ;
            TrainOptions.Keep[e.target['className']]['Food'] = e.target.value;
            saveTrainOptions();
      	}, false);
      	document.getElementById('KeepWood'+k).addEventListener('change', function(e){
      	    if (isNaN(e.target.value)) e.target.value=0 ;
            TrainOptions.Keep[e.target['className']]['Wood'] = e.target.value;
            saveTrainOptions();
      	}, false);
      	document.getElementById('KeepStone'+k).addEventListener('change', function(e){
			if (isNaN(e.target.value)) e.target.value=0 ;
            TrainOptions.Keep[e.target['className']]['Stone'] = e.target.value;
            saveTrainOptions();
      	}, false);
      	document.getElementById('KeepOre'+k).addEventListener('change', function(e){
      	    if (isNaN(e.target.value)) e.target.value=0 ;
            TrainOptions.Keep[e.target['className']]['Ore'] = e.target.value;
            saveTrainOptions();
      	}, false);
    } 
  },
      
  helpPop : function (){
    var helpText = '<BR><DL><dt>Auto training:<dd><LI>Check the box in front of the row to auto train in that city (The number is the number of the city).</dd>\
    	<dd><LI>Select a type of troop pora the city in the drop down boxes.</dd>\
        <dd><LI>Specify the minimum troop training triggers the car (not be trained under this).</dd>\
        <dt>Fill in the resources:</dt>\
          <dd><LI>Maintain: Auto train will keep this minimum amount available in the city.</dd>\
          <dd><LI>Use: Auto Train only use the resources to train troops.</dd>\
        <dt>In turn is: </dt>\
          <dd><LI>Press the  Auto Train.</dd></ul>';
    var pop = new CPopup ('giftHelp', 0, 0, 550, 250, true);
    pop.centerMe (mainPop.getMainDiv());
    pop.getMainDiv().innerHTML = helpText;
    pop.getTopDiv().innerHTML = '<div class=showBadged><center>Help PowerKoc: self-training</center></div>';
    pop.show (true);
  },

  toggleAutoTrainState: function(obj){
		var t = Tabs.AutoTrain;
		obj = document.getElementById('pbAutoTrainState');
        if (TrainOptions.Running == true) {
            TrainOptions.Running = false;
            obj.value = "Auto Train = OFF";
		updatebotbutton('Train-OFF', 'pbtraintab');
        }
        else {
            TrainOptions.Running = true;
            obj.value = "Auto Train = ON";
		updatebotbutton('Train-ON', 'pbtraintab');
        }
        saveTrainOptions();
    },

	show: function(){
		var t = Tabs.AutoTrain;
    },
	hide: function(){
        var t = Tabs.AutoTrain;
    },
    
  checkidlepopulation : function(cityId){
	var t = Tabs.AutoTrain;
	if(TrainOptions.Workers[t.city] == 0)
		t.idle = parseInt(Seed.citystats['city'+cityId].pop[0]) - parseInt(Seed.citystats['city'+cityId].pop[3]);
	else
		t.idle = ((TrainOptions.Workers[t.city]/100)*parseInt(Seed.citystats['city'+cityId].pop[0])).toFixed(0);
	return t.idle>0?true:false;
  },
  checktrainslots : function(cityId){
	var t = Tabs.AutoTrain;
	t.barracks = getCityBuilding(cityId, 13).count;
	t.slots = Seed.queue_unt['city'+cityId].length;
	t.empty = parseInt(t.barracks - t.slots);
	return t.empty>0?true:false;
  },
  checkresources : function(cityId){
	var t = Tabs.AutoTrain;
	t.food = parseInt((Seed.resources['city'+cityId].rec1[0]/3600) - TrainOptions['Keep'][t.city]['Food']);
        t.wood = parseInt((Seed.resources['city'+cityId].rec2[0]/3600) - TrainOptions['Keep'][t.city]['Wood']);
        t.stone = parseInt((Seed.resources['city'+cityId].rec3[0]/3600) - TrainOptions['Keep'][t.city]['Stone']);
        t.ore = parseInt((Seed.resources['city'+cityId].rec4[0]/3600) - TrainOptions['Keep'][t.city]['Ore']); 
	if(t.food>0 && t.wood>0 && t.stone>0 && t.ore>0){
		return true;
	}
	return false;
  },
  trainamt : function(cityId, unitId){
	var t = Tabs.AutoTrain;
	if(!unitId || unitId<1) return false;
	var cost = unsafeWindow.Object.clone(unsafeWindow.unitcost['unt'+ unitId]);
	var gamble = (parseInt(TrainOptions.Gamble[t.city])>0)?t.gamble[TrainOptions.Gamble[t.city]].cost:1;
	t.amt = (t.idle/cost[6]).toFixed(0);
	for(var rs=1; rs<5; rs++)
		cost[rs] *= gamble;
	if ((t.food/cost[1]) < t.amt) t.amt = (t.food/cost[1]).toFixed(0);
	if ((t.wood/cost[2]) < t.amt) t.amt = (t.wood/cost[2]).toFixed(0);
	if ((t.stone/cost[3]) < t.amt) t.amt = (t.stone/cost[3]).toFixed(0);
	if ((t.ore/cost[4]) < t.amt) t.amt = (t.ore/cost[4]).toFixed(0);
	        if(TrainOptions.SelectMax[t.city]){
		if(parseInt(t.amt) > parseInt(TrainOptions.Max[t.city])) t.amt = TrainOptions.Max[t.city];
	}
	if(parseInt(t.amt) < parseInt(TrainOptions.Threshold[t.city])) t.amt = 0;
	return t.amt>0?true:false;
  },
  nextcity : function(){
	var t = Tabs.AutoTrain;
	if (!TrainOptions.Running) return;
	t.city++;
	if(t.city > Seed.cities.length) t.city = 1;
	var cityId = Seed.cities[t.city-1][0];
	var idle = t.checkidlepopulation(cityId);
	var trainslots = t.checktrainslots(cityId);
	var resources = t.checkresources(cityId);
	var train = t.trainamt(cityId, TrainOptions['Troops'][t.city]);
	if(!TrainOptions.Enabled[t.city] || TrainOptions['Troops'][t.city]==0 || !idle || !trainslots || !resources || !train){
		setTimeout(t.nextcity, 5000);
		return;
	}
	t.doTrain(cityId, TrainOptions['Troops'][t.city], t.amt, t.nextcity);
  },
  doTrain : function (cityId, unitId, num, notify){
	var t = Tabs.AutoTrain;
	var time = unsafeWindow.modal_barracks_traintime(unitId, num);
	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	params.cid = cityId;
	params.type = unitId;
	params.quant = num;
	if(parseInt(TrainOptions.Gamble[t.city]) > 0)
		params.gambleId = TrainOptions.Gamble[t.city];

	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/train.php" + unsafeWindow.g_ajaxsuffix, {
		method: "post",
		parameters: params,
		onSuccess: function(rslt) {
		  if (rslt.ok) {
			for (var i = 1; i < 5; i++) {
				var resourceLost = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(num);
				if(rslt.gamble) resourceLost = resourceLost*rslt.gamble[i];
				unsafeWindow.seed.resources["city" + cityId]["rec" + i][0] = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]) - resourceLost;
			}
			unsafeWindow.seed.citystats["city" + cityId].gold[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].gold[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][5]) * parseInt(num);
			unsafeWindow.seed.citystats["city" + cityId].pop[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].pop[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][6]) * parseInt(num);
			unsafeWindow.seed.queue_unt["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, null]);
			setTimeout (notify, 10000);
			for (postcity in Seed.cities) if (Seed.cities[postcity][0] == params.cid) logcity = Seed.cities[postcity][1];
			actionLog(logcity  + ' Train ' + num + ':  ' + troops[unitId] );
		  } else {
			setTimeout (notify, 10000);
		  }
		},
	});
  },
}

/*************************************** Train Tab ***********************************************/

Tabs.Train = {
  tabOrder : 55,
  tabLabel : 'Addestra',
  cont : null,
  timer : null,
  stats : {},
  selectedCity : {},
  trainTimer : null,
  running : false,
  nextAuto:                             null,
  defenseOptions:       "<option value='53'>Crossbow</option><option value='55'>Trebuchet</option><option value='60'>Trap</option><option value='61'>Caltrop</option><option value='62'>Spiked Barrier</option>",
  prevCityNo:                   0,

  init : function (div){
    var t = Tabs.Train;
    t.cont = div;
    unsafeWindow.cancelTrain = t.butcancelTrain;
    unsafeWindow.cancelFort = t.butcancelFort;
    
    s = "<DIV id=trainTopSelect>\
      <DIV class=ptstat id=trainheader>Train troops and build wall/field defenses</div><DIV style='height:5px'></div><DIV class=ptentry>\
      <DIV style='text-align:center; margin-bottom:5px;'>Select City: &nbsp; <span id=ptspeedcity></span></div>\
      <TABLE class=ptTab width=100%><TR valign=top><TD width=50%>\
      <TABLE align=center><TR><TD align=right>Troop Type: </td><TD colspan=2>\
      <SELECT id=ptttType>\
        <option value='1'>Supply Troop</option>\
        <option value='2'>Militiaman</option>\
        <option value='3'>Scout</option>\
        <option value='4'>Pikeman</option>\
        <option value='5'>Swordsman</option>\
        <option value='6'>Archer</option>\
        <option value='7'>Cavalry</option>\
        <option value='8'>Heavy Cavalry</option>\
        <option value='9'>Supply Wagon</option>\
        <option value='10'>Ballista</option>\
        <option value='11'>Battering Ram</option>\
        <option value='12'>Catapult</option>\
      </select> &nbsp; (max <span id=ptttSpMax></span>)</td></tr>\
      <TR><TD align=right># per slot: </td><TD><INPUT id='ptttInpPS' size=5 type='text' value='0'\></td>\
        <TD><INPUT id='ptttButMaxPS' type=submit value='max'\> &nbsp; (max <span id=ptttSpMaxPS>0</span>)</td></tr>\
      <TR><TD align=right># of slots: </td><TD><INPUT id='ptttInpSlots' size=2 type='text' value='1'\></td>\
        <TD width=75%><INPUT id='ptttButMaxSlots' type=submit value='max'\> &nbsp; (max <span id=ptttSpMaxSlots>1</span>)</td></tr>\
            <TR><TD align=right>Limited by:</td><td><span id=ptttLimiter class=boldRed></span></TD><TD><span id=ptttEstimate></span></TD></TR>\
                <TR><TD align=right valign=top>Set Workers idle: </td><TD colspan=2><INPUT type=CHECKBOX id=chkPop"+ (Options.maxIdlePop?' CHECKED ':'') +"> \
        <SPAN style='white-space:normal;'>Allows you to train more troops. May temporarily set idle population negative.</span>\
                <br><INPUT type=CHECKBOX id=chkTut> \
                <SELECT id=tutelage>\
                <option value='36'>Lancelot's Tutelage</option>\
        <option value='37'>Arthur's Tutelage</option>\
        <option value='38'>Merlin's Tutelage</option>\
                </select>\
                </td></tr>\
      <TR><TD colspan=3 align=center><DIV style='height:10px'></div><INPUT id='ptttButDo' type=submit value='Train Troops'\></td></tr>\
      </table></td><TD width=20></td><TD style='border-left:solid 2px;' width=50% align=center>\
      <TABLE align=center><TR><TD align=right>Defense Type: </td><TD colspan=2>\
      <SELECT id=pttdType>\
        <option value='53'>Crossbow</option>\
        <option value='55'>Trebuchet</option>\
        <option value='60'>Trap</option>\
        <option value='61'>Caltrop</option>\
        <option value='62'>Spiked Barrier</option>\
      </select> &nbsp; (<span id=pttdSpMax></span>)</td></tr>\
      <TR><TD align=right># per slot: </td><TD><INPUT id='pttdInpPS' size=5 type='text' value='0'\></td>\
        <TD><INPUT id='pttdButMaxPS' type=submit value='max'\> &nbsp; (max <span id=pttdSpMaxPS>0</span>)</td></tr>\
      <TR><TD align=right># of slots: </td><TD><INPUT id='pttdInpSlots' size=2 type='text' value='1'\></td>\
        <TD width=75%><INPUT id='pttdButMaxSlots' type=submit value='max'\> &nbsp; (max <span id=pttdSpMaxSlots>1</span>)</td></tr>\
                <TR><td align=right>Limited by:</td><TD><span id=pttdLimiter class=boldRed></span></td><TD><span id=pttdEstimate></span></TD></tr>\
                <TR align=center><TD colspan=3><SPAN id=pttdSpace></span></td></tr>\
         <TR><TD align=center colspan=3><INPUT type=CHECKBOX id=chkDoDefenses"+ (AutoTrainOptions.doDefenses[1]?' CHECKED ':'') +">Auto-train 1 trap, 1 caltrop and max. spikes</TD></TR>\
      <TR><TD colspan=3 align=center><DIV style='height:10px'>\
      <SELECT id=siege>\
      <option value='0'><CENTER>--- "+unsafeWindow.g_js_strings.commonstr.speedup+" ---</center></option>\
      <option value='26'>"+ unsafeWindow.itemlist.i26.name+"</option>\
      </select></div>\
      <TR><TD colspan=3 align=center><DIV style='height:10px'></div><INPUT id='pttdButDo' type=submit value='Build Defenses'\></td></tr></table>\
      </td></tr></table></div></div>\
      <TABLE align=center width=425 class=ptTab><TR><TD><div id=ptTrainStatus style='overflow-y:auto; max-height:78px; height: 78px;'></div></td></tr></table>\
      <div style='height: 330px; background: #e8ffe8'>\
      <TABLE width=100% class=ptTab><TR><TD colspan=3><DIV id=divSTtop></div></td></tr>\
      <TR><TD width=50% style='padding-left:15px; padding-right:15px'><DIV style='text-align:center'><B>Troop Queue &nbsp; (<SPAN id=statTTtot></span>)</b><BR><HR></div><DIV id=divSTleft style='overflow-y: auto; height:210px; max-height:210px'></div></td>\
        <TD width=50% style='padding-left:15px; padding-right:15px'><DIV style='text-align:center'><B>Defense Queue &nbsp; (<SPAN id=statDTtot></span>)</b><BR><HR></div><DIV id=divSTright style='overflow-y: auto; height:210px; max-height:210px'></div></td></tr>\
      </div>";
    t.cont.innerHTML = s;

    var dcp = new CdispCityPicker ('ptspeed', document.getElementById('ptspeedcity'), true, t.clickCitySelect, 0);
    t.TTspMax = document.getElementById ('ptttSpMax');
    t.TTspMaxPS = document.getElementById ('ptttSpMaxPS');
    t.TTspMaxSlots = document.getElementById ('ptttSpMaxSlots');
    t.TTbutMaxSlots = document.getElementById ('ptttButMaxSlots');
    t.TTbutMaxPerSlot = document.getElementById ('ptttButMaxPS');
    t.TTinpPerSlot = document.getElementById ('ptttInpPS');
    t.TTinpSlots = document.getElementById ('ptttInpSlots');
    t.TTselType = document.getElementById ('ptttType');
    t.TTbutDo = document.getElementById ('ptttButDo');
        t.TTlimiter = document.getElementById ('ptttLimiter');
    t.TDspMax = document.getElementById ('pttdSpMax');
    t.TDspMaxPS = document.getElementById ('pttdSpMaxPS');
    t.TDspMaxSlots = document.getElementById ('pttdSpMaxSlots');
    t.TDbutMaxSlots = document.getElementById ('pttdButMaxSlots');
    t.TDbutMaxPerSlot = document.getElementById ('pttdButMaxPS');
    t.TDinpPerSlot = document.getElementById ('pttdInpPS');
    t.TDinpSlots = document.getElementById ('pttdInpSlots');
    t.TDselType = document.getElementById ('pttdType');
    t.TDbutDo = document.getElementById ('pttdButDo');
    t.TDspSpace = document.getElementById ('pttdSpace');
        t.TDlimiter = document.getElementById ('pttdLimiter');
    t.divTrainStatus = document.getElementById ('ptTrainStatus');
          
    t.TTinpSlots.addEventListener ('change', t.updateTopTroops, false);
    t.TTbutMaxPerSlot.addEventListener ('click', t.clickTroopMaxPS, false);
    t.TTbutMaxSlots.addEventListener ('click', t.clickTroopMaxSlots, false);
    t.TTselType.addEventListener ('change', t.changeTroopSelect, false);
    t.TTbutDo.addEventListener ('click', t.clickTroopDo, false);
    t.TDinpSlots.addEventListener ('change', t.updateTopDef, false);
    t.TDselType.addEventListener ('change', t.changeDefSelect, false);
    t.TDbutMaxPerSlot.addEventListener ('click', t.clickDefMaxPS, false);
    t.TDbutMaxSlots.addEventListener ('click', t.clickDefMaxSlots, false);
    t.TDbutDo.addEventListener ('click', t.clickDefDo, false);
    document.getElementById ('chkPop').addEventListener ('change', t.clickCheckIdlePop, false);
                document.getElementById ('chkDoDefenses').addEventListener ('change', t.clickCheckDoDefenses, false);
    t.changeTroopSelect();
    t.changeDefSelect();
  t.doAutoTrain(1);

  },


  hide : function (){
    var t = Tabs.Train;
    clearTimeout (t.timer);
  },
  
  show : function (){
    var t = Tabs.Train;
    clearTimeout (t.timer);
    t.displayCityStats();
    t.changeTroopSelect();
    t.changeDefSelect();
    t.timer = setTimeout (t.show, 2000);
  },

/*******  TROOPS  ******/  
  
  updateTopTroops : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TTinpSlots.value, 10);
    if (isNaN(slots) || slots<0)
      slots = 0;
    t.TTspMax.innerHTML = t.stats.MaxTrain;
    t.TTlimiter.innerHTML = t.stats.Limiter;
    t.TTspMaxSlots.innerHTML = t.stats.barracks - t.stats.queued;
    if (slots<1 || (t.stats.barracks-t.stats.queued < 1))
      t.TTspMaxPS.innerHTML = 0;
    else
      t.TTspMaxPS.innerHTML = parseInt(t.stats.MaxTrain / slots);
  },
      
  
  clickTroopMaxPS : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TTinpSlots.value, 10);
    if (slots<1 || (t.stats.barracks-t.stats.queued < 1))
      t.TTinpPerSlot.value = 0;
    else
      t.TTinpPerSlot.value = parseInt(t.stats.MaxTrain / slots);
  },

  clickTroopMaxSlots : function (){
    var t = Tabs.Train;
    t.TTinpSlots.value = t.stats.barracks - t.stats.queued;
  },
  
  clickCitySelect : function (city){
    var t = Tabs.Train;
    t.selectedCity = city;
    t.lastQueString = null;   
    t.lastDQueString = null;   
    t.displayCityStats ();
    t.changeTroopSelect();
    t.changeDefSelect();
    t.JumpCity(city.name);
  },
  
  JumpCity:function(city) {
                var t = Tabs.AllianceList;
                for (i=0;i<Seed.cities.length;i++) {
                        if (Seed.cities[i][1]==city) var cityNum=i;
                }
                cityNum++;
                var obj = document.getElementById('citysel_'+cityNum);
                return t.ClickWin(window,obj,'click');
     },
  
  ClickWin:function(win,obj,evtName) {
        var evt = win.document.createEvent("MouseEvents");
        evt.initMouseEvent(evtName, true, true, win,
                0, 0, 0, 0, 0, false, false, false, false, 0, null);
        return !obj.dispatchEvent(evt);
     },
  
  clickCheckIdlePop : function (){
    var t = Tabs.Train;
    if (document.getElementById ('chkPop').checked)
      Options.maxIdlePop = true;
    else
      Options.maxIdlePop = false;
    saveOptions ();
    t.displayCityStats ();
    t.changeTroopSelect ();
  },

        clickCheckDoDefenses: function (){
                var t = Tabs.Train;
                var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
                AutoTrainOptions.doDefenses[cityNo] = (document.getElementById ('chkDoDefenses').checked)
                saveAutoTrainOptions ();
                t.displayCityStats ();
                t.changeDefSelect ();
        },

  limitingFactor : null,
    
  changeTroopSelect : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    // unitcost: NAME, Food, Wood, Stone, Ore, Gold, Pop, ?
    var id = t.TTselType.value;
    t.lastTroopSelect = id;
    var uc = unsafeWindow.unitcost['unt'+id];
    var max = 9999999999;
    var limiter = 'Unknown';
    if ( (t.stats.food / uc[1]) < max) {
      max = t.stats.food / uc[1];
      limiter = 'Food';
    }
    if ( (t.stats.wood / uc[2]) < max) {
      max = t.stats.wood / uc[2];
      limiter = 'Wood';
    }
    if ( (t.stats.stone / uc[3]) < max) {
      max = t.stats.stone / uc[3];
      limiter = 'Stone';
    }
    if ( (t.stats.ore / uc[4]) < max) {
      max = t.stats.ore / uc[4];
      limiter = 'Ore';
    }
    if ( (t.stats.idlePop / uc[6]) < max) {
      max = t.stats.idlePop / uc[6];
      limiter = 'Idle Population';
    }
    t.limitingFactor = null;
    var uc = unsafeWindow.unitcost['unt'+id];
    var max = 9999999999;
    if ( (t.stats.food / uc[1]) < max){
      max = t.stats.food / uc[1];
      t.limitingFactor = 'food';
    }
    if ( (t.stats.wood / uc[2]) < max){
      max = t.stats.wood / uc[2];
      t.limitingFactor = 'wood';
    }
    if ( (t.stats.stone / uc[3]) < max){
      max = t.stats.stone / uc[3];
      t.limitingFactor = 'stone';
    }
    if ( (t.stats.ore / uc[4]) < max){
      max = t.stats.ore / uc[4];
      t.limitingFactor = 'ore';
    }
    if ( (t.stats.idlePop / uc[6]) < max){
      max = t.stats.idlePop / uc[6];
      t.limitingFactor = 'pop';
          }
    t.stats.MaxTrain = parseInt (max);
    t.stats.Limiter = limiter;
    if (t.stats.MaxTrain < 0)
      t.stats.MaxTrain = 0;
    if (matTypeof(uc[8]) == 'object'){
      for (k in uc[8]){  // check building requirement
        var b = getCityBuilding (cityId, k.substr(1));
        if (b.maxLevel < uc[8][k][1]){
          t.stats.MaxTrain = 0;
          t.stats.Limiter = 'Building';
          t.limitingFactor = null;
          break;
        }
      }
    }
    if (matTypeof(uc[9]) == 'object'){
      for (k in uc[9]){    // check tech requirement
        if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
          t.stats.MaxTrain = 0;
          t.limitingFactor = null;
          t.stats.Limiter = 'Research';
          break;
        }
      }
    }
if (t.limitingFactor){
  document.getElementById('ptttr_'+ t.limitingFactor).className = 'boldRed';
}    
    t.updateTopTroops();
  },

    
  clickTroopDo : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    var unitId = t.TTselType.value;
    var perSlot = parseInt(t.TTinpPerSlot.value, 10);
    var numSlots = parseInt(t.TTinpSlots.value, 10);
    
    t.displayCityStats ();
    if (t.running){
      t.stopTraining('<SPAN class=boldRed>Training cancelled by user</span>');
      return; 
    }    
    if (perSlot<1){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Number of troops per slot must be greater than 0.</font>';
      return;
    }
    if (perSlot*numSlots > t.stats.MaxTrain){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Can\'t train that many troops (max is '+ t.stats.MaxTrain +' total)</font>';
      return;
    }
    if (numSlots<1 || numSlots>t.stats.barracks - t.stats.queued){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Invalid number of slots.</font>';
      return;
    }

        if (document.getElementById ('chkTut').checked)
                var tut = document.getElementById ('tutelage').value;
        else
                var tut = 0;
                
    t.TDbutDo.disabled = true;
    t.TTbutDo.className = 'ptButCancel';
    t.TTbutDo.value = 'CANCEL';
    var que = [];
    for (var i=0; i<numSlots; i++)
      que.push (['T', unitId, parseInt (perSlot)]);
    t.divTrainStatus.innerHTML = '';
    t.running = true;
    t.doQueue (cityId, tut, que);
  },

  
/*******  DEF  ******/  
  
  updateTopDef : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TDinpSlots.value, 10);
    if (isNaN(slots) || slots<0)
      slots = 0;
    t.TDspMax.innerHTML = 'max:'+ t.stats.MaxDefTrain +'&nbsp; owned:'+ t.stats.defOwned;   
    t.TDlimiter.innerHTML = t.stats.DefLimiter;
    t.TDspMaxSlots.innerHTML = t.stats.wallLevel-t.stats.Dqueued;
    if (slots<1)
      t.TDspMaxPS.innerHTML = 0;
    else
      t.TDspMaxPS.innerHTML = parseInt(t.stats.MaxDefTrain / slots);

    t.TDspSpace.innerHTML = 'Wall level: <B>'+ t.stats.wallLevel +'</b><BR>Wall space: '+ (t.stats.wallSpaceUsed+t.stats.wallSpaceQueued)  +'/<B>'+ t.stats.wallSpace +'</b><BR>\
        Field space: '+ (t.stats.fieldSpaceUsed+t.stats.fieldSpaceQueued) +'/<B>'+ t.stats.fieldSpace +'</b>';
  },

  changeDefSelect : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    // unitcost: NAME, Food, Wood, Stone, Ore, Gold, Pop, ?
    var id = t.TDselType.value;
    t.lastDefSelect = id;
    t.stats.defOwned = parseInt(Seed.fortifications['city' + cityId]['fort'+id]);    
    var uc = unsafeWindow.fortcost['frt'+id];
    var max = 9999999999;
    if ( (t.stats.food / uc[1]) < max)
      max = t.stats.food / uc[1];
      limiter = 'Food';
    if ( (t.stats.wood / uc[2]) < max)
      max = t.stats.wood / uc[2];
      limiter = 'Wood';
    if ( (t.stats.stone / uc[3]) < max)
      max = t.stats.stone / uc[3];
      limiter = 'Stone';
    if ( (t.stats.ore / uc[4]) < max)
      max = t.stats.ore / uc[4];
      limiter = 'Ore';
    if ( (t.stats.idlePop / uc[6]) < max)
      max = t.stats.idlePop / uc[6];
      limiter = 'Idle Population';
    t.stats.MaxDefTrain = parseInt (max);
    if (t.stats.MaxDefTrain < 0)
      t.stats.MaxDefTrain = 0;
    if (matTypeof(uc[8]) == 'object'){
      for (k in uc[8]){  // check building requirement
        var b = getCityBuilding (cityId, k.substr(1));
        if (b.maxLevel < uc[8][k][1]){
          t.stats.MaxDefTrain = 0;
          t.stats.DefLimiter = 'Building';
          break;
        }
      }
    }
    if (matTypeof(uc[9]) == 'object'){
      for (k in uc[9]){    // check tech requirement
        if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
          t.stats.MaxDefTrain = 0;
          t.stats.DefLimiter = 'Research';
          break;
        }
      }
    }

    var spaceEach = parseInt(unsafeWindow.fortstats["unt"+ id][5]);
    if (id<60)
      var spaceAvail = t.stats.wallSpace - t.stats.wallSpaceUsed - t.stats.wallSpaceQueued;
    else
      var spaceAvail = t.stats.fieldSpace - t.stats.fieldSpaceUsed - t.stats.fieldSpaceQueued;
    if ( t.stats.MaxDefTrain * spaceEach > spaceAvail)
      t.stats.MaxDefTrain = parseInt(spaceAvail / spaceEach);
      if (id<60)
        t.stats.DefLimiter = 'Wall Space';
      else
        t.stats.DefLimiter = 'Field Space';
    

    t.updateTopDef();
  },
  
  clickDefMaxPS : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TDinpSlots.value, 10);
    if (slots<1)
      t.TDinpPerSlot.value = 0;
    else
      t.TDinpPerSlot.value = parseInt(t.stats.MaxDefTrain / slots);
  },

  clickDefMaxSlots : function (){
    var t = Tabs.Train;
    t.TDinpSlots.value = t.stats.wallLevel-t.stats.Dqueued;
  },
    
  clickDefDo : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    var unitId = t.TDselType.value;
    var perSlot = parseInt(t.TDinpPerSlot.value, 10);
    var numSlots = parseInt(t.TDinpSlots.value, 10);
    
    t.displayCityStats ();
    if (t.running){
      t.stopTraining('<SPAN class=boldRed>Training cancelled by user</span>');
      return; 
    }    
    if (perSlot<1){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Number of units per slot must be greater than 0.</font>';
      return;
    }
    if (perSlot*numSlots > t.stats.MaxDefTrain){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Can\'t train that many unit (max is '+ t.stats.MaxDefTrain +' total)</font>';
      return;
    }
    if (numSlots<1 || numSlots > t.stats.wallLevel-t.stats.Dqueued){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Invalid number of slots.</font>';
      return;
    }
    var siege = document.getElementById ('siege').value;
    t.TTbutDo.disabled = true;
    t.TDbutDo.className = 'ptButCancel';
    t.TDbutDo.value = 'CANCEL';
    var que = [];
    for (var i=0; i<numSlots; i++)
      que.push (['T', unitId, parseInt (perSlot)]);
    t.divTrainStatus.innerHTML = '';
    t.running = true;
    t.doDefQueue (cityId, que);
  },

  doDefQueue : function (cityId, que, errMsg){
    var t = Tabs.Train;
    clearTimeout (t.trainTimer);
    try {
      t.displayCityStats();
      if (errMsg){
        t.stopTraining ('<SPAN class=boldRed>ERROR: '+ errMsg +'</span>');
        return;
      }
      var cmd = que.shift();
      if (!cmd){
        t.stopTraining ('<B>Done queueing defenses.</b>');
        return;
      }
      if (cmd[0] == 'T'){
        t.dispTrainStatus ('Training '+ cmd[2] +' '+  fortNamesShort[cmd[1]] +' at '+ Cities.byID[cityId].name +' ('+ que.length +' slots remaining)<BR>');
        doDefTrain ( cityId, cmd[1], cmd[2], 
          function(errMsg){
            t.trainTimer = setTimeout(function (){Tabs.Train.doDefQueue(cityId, que, errMsg);}, (Math.random()*3500)+1500);
          } );
      }
    } catch (err) {
      logit (inspect (err, 8, 1));
      t.stopTraining ('<SPAN class=boldRed>PROGRAM ERROR: '+ err.message +'</span>');
    }
  },
  

  // fix KofC bugs ....
  // if first start time > now, make it now
  // if any end time != next start time, fix it
  fixQueTimes : function (q){
    var now = unixTime();
    if (q[0][2] > now)
      q[0][2] = now;
    for (var i=0; i<q.length; i++){
      if (q[i+1]!=null && q[i+1][2]!=q[i][3])
        q[i][3] = q[i+1][2];
    }        
  },

  expireTheQueue : function (q){
    if (q==null)
      return;
    var now = unixTime();
    while (q.length>0 && (q[0][3] - now) < 1)
      q.shift();
  },
    
  displayCityStats : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
        var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
        if (t.prevCityNo != cityNo) {
        t.prevCityNo = cityNo;
        document.getElementById ('chkDoDefenses').checked = AutoTrainOptions.doDefenses[cityNo];
                }

    t.stats.food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
    t.stats.wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
    t.stats.stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
    t.stats.ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
    t.stats.gold = Seed.citystats['city'+cityId].gold[0];
    if (Options.maxIdlePop)
      t.stats.idlePop = parseInt(Seed.citystats['city'+cityId].pop[0]);
    else
      t.stats.idlePop = parseInt(Seed.citystats['city'+cityId].pop[0]) - parseInt(Seed.citystats['city'+cityId].pop[3]);
    t.stats.barracks = getCityBuilding (cityId, 13).count;
    var m = '<CENTER><B>'+ Cities.byID[cityId].name +' &nbsp; ('+ Cities.byID[cityId].x +','+ Cities.byID[cityId].y +')</b></center><HR>';

m += '<TABLE class=ptTab width=100%><TR align=center>\
        <TD width=8%><B>Supply:</b></td><TD width=8%><B>Militia:</b></td><TD width=8%><B>Scout:</b></td>\
        <TD width=8%><B>Pike:</b></td><TD width=8%><B>Sword:</b></td><TD width=8%><B>Archer:</b></td>\
        <TD width=8%><B>Cav:</b></td><TD width=8%><B>Heavy Cav:</b></td><TD width=8%><B>Wagon:</b></td>\
        <TD width=8%><B>Ballista:</b></td><TD width=8%><B>Ram:</b></td><TD width=8%><B>Catapult:</b></td><tr>';

 m += '<TR align=center><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt1'])+'</td><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt2'])+
 '<TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt3'])+'</td><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt4'])+
 '<TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt5'])+'</td><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt6'])+
 '<TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt7'])+'</td><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt8'])+
 '<TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt9'])+'</td><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt10'])+
 '<TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt11'])+'</td><TD width=8%>'+addCommas(Seed.units['city'+cityId]['unt12'])+'</td><tr></table>';

    m += '<TABLE class=ptTab width=100%><TR align=center>\
        <TD width=18%><SPAN id=ptttr_food><B>Food:</b><BR>'+ addCommasInt(t.stats.food) +'</span></td>\
        <TD width=16%><SPAN id=ptttr_wood><B>Wood:</b><BR>'+ addCommasInt(t.stats.wood) +'</span></td>\
        <TD width=16%><SPAN id=ptttr_ore><B>Ore:</b><BR>'+ addCommasInt(t.stats.ore) +'</span></td>\
        <TD width=16%><SPAN id=ptttr_gold><B>Stone:</b><BR>'+ addCommasInt(t.stats.stone) +'</span></td>\
        <TD width=16%><SPAN id=ptttr_gold><B>Gold:</b><BR>'+ addCommasInt(t.stats.gold) +'</span></td>\
        <TD width=16%><SPAN id=ptttr_pop><B>Idle Pop:</b><BR>'+ addCommasInt(t.stats.idlePop) +'</span></td></tr></table><BR>';
    document.getElementById ('divSTtop').innerHTML = m;
    
// troop queue .... 
    var totTime = 0;
    var q = Seed.queue_unt['city'+cityId];
    t.expireTheQueue(q);
    var qs = q.toString();
    var now = unixTime();
    if (q!=null && q.length>0)
      totTime = q[q.length-1][3] - now;
    if ( qs == t.lastQueString){
      if (q!=null && q.length>0){
        var cur = q[0][3] - now;
        document.getElementById ('ptttfq').innerHTML = timestr(cur, true);
      }
    } else {
      t.lastQueString = qs;
      t.stats.queued = 0;
      m = '<TABLE align=center class=ptTab>';
      if (q!=null && q.length>0 ){
        t.fixQueTimes (q);
        t.stats.queued = q.length;
        first = true;
        for (var i=0; i<q.length; i++){
          start = q[i][2];
          end = q[i][3];
          if (first)
            actual = end - now;
          else
            actual = end - lastEnd;
          if (actual < 0)
            actual = 0;
          q[i][6] = cityId;
          m += '<TR align=right><TD width="5px"><A><DIV onclick="cancelTrain('+ q[i][0]+','+q[i][1]+','+q[i][2]+','+q[i][3]+','+q[i][5]+','+q[i][6]+','+i +')">X</div></a></td>';
          m += '<TD>'+ q[i][1] +' </td><TD align=left> '+ unsafeWindow.unitcost['unt'+q[i][0]][0];
          if (first)
            m += '</td><TD> &nbsp; '+  timestr(end-start, true) +'</td><TD> (<SPAN id=ptttfq>'+ timestr(actual, true) +'</span>)';
          else
            m += '</td><TD> &nbsp; '+  timestr(actual, true) +'</td></tr>'; 
          lastEnd = end;
          first = false;
        }
      }
      m += '</table>';
      document.getElementById ('divSTleft').innerHTML = m;
    }
    m = t.stats.barracks +' barracks';
    if (t.stats.queued > 0)
      m += ', '+ t.stats.queued +' slots';
    if (totTime > 0)
      m += ', '+ unsafeWindow.timestr(totTime);
    document.getElementById ('statTTtot').innerHTML = m;
    
// defense queue ....
    getWallInfo (cityId, t.stats);    
    var totTime = 0;
    var q = Seed.queue_fort['city'+cityId];
    t.expireTheQueue(q);
    var qs = q.toString();
    if (q!=null && q.length>0)
      totTime = q[q.length-1][3] - now;
    if ( qs == t.lastDQueString){
      if (q!=null && q.length>0){
        var cur = q[0][3] - now;
        document.getElementById ('pttdfq').innerHTML = timestr(cur, true);
      }
    } else {
      t.lastDQueString = qs;
      t.stats.Dqueued = 0;
      t.stats.wallSpaceQueued = 0;
      t.stats.fieldSpaceQueued = 0;
      m = '<TABLE align=center class=ptTab>';
      if (q!=null && q.length > 0 ){
        t.fixQueTimes (q);
        t.stats.Dqueued = q.length;
        first = true;
        for (i=0; i<q.length; i++){
          if (q[i][0] < 60)          
            t.stats.wallSpaceQueued += parseInt(unsafeWindow.fortstats["unt"+ q[i][0]][5]) * parseInt(q[i][1]);
          else          
            t.stats.fieldSpaceQueued += parseInt(unsafeWindow.fortstats["unt"+ q[i][0]][5]) * parseInt(q[i][1]);
          start = q[i][2];
          end = q[i][3];
          if (first)
            actual = end - now;
          else
            actual = end - lastEnd;
          if (actual < 0)
            actual = 0;
                  q[i][7]=cityId;
          m += '<TR align=right><TD width="5px"><A><DIV onclick="cancelFort('+ q[i][0]+','+q[i][1]+','+q[i][2]+','+q[i][3]+','+q[i][5]+','+q[i][6]+','+q[i][7] +','+ i +')">X</div></a></td>'
          m += '<TD>'+ q[i][1] +' </td><TD align=left> '+ fortNamesShort[q[i][0]];
          if (first)
            m += '</td><TD> &nbsp; '+  timestr(end-start, true) +'</td><TD> (<SPAN id=pttdfq>'+ timestr(actual, true) +'</span>)';
          else
            m += '</td><TD> &nbsp; '+  timestr(actual, true) +'</td></tr>'; 
          lastEnd = end;
          first = false;
        }
      }
      m += '</table>';
      document.getElementById ('divSTright').innerHTML = m;
    }
    m = t.stats.Dqueued +' slots';
    if (totTime > 0)
      m += ', '+ unsafeWindow.timestr(totTime);
    document.getElementById ('statDTtot').innerHTML = m;
  },
  
  
  dispTrainStatus : function (msg){
    var t = Tabs.Train;
    t.divTrainStatus.innerHTML = msg + t.divTrainStatus.innerHTML;
  },

  butcancelTrain : function (typetrn, numtrptrn, trnTmp, trnETA, trnNeeded, cityId, trainingId){
    var t = Tabs.Train;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    params.pf =0;
    params.requestType = "CANCEL_TRAINING";
    params.cityId = cityId;
    params.typetrn = typetrn;
    params.numtrptrn =  numtrptrn;
    params.trnETA = trnETA;
    params.trnTmp = trnTmp;
    params.trnNeeded = trnNeeded;
    
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelTraining.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
        var rslt=eval("("+message.responseText+")");
        if (rslt.ok) {
                                        var k=0;
                                        for(var j=0;j<Seed.queue_unt["city"+cityId].length;j++){
                                                if(j>trainingId){
                                                        Seed.queue_unt["city"+cityId][j][2]=parseInt(rslt.dateTraining[k]["start"]);
                                                        Seed.queue_unt["city"+cityId][j][3]=parseInt(rslt.dateTraining[k]["end"]);
                                                        k++;
                                                }
                                        }
                        
                        Seed.queue_unt["city"+cityId].splice(trainingId,1);
                        for(var i=1;i<5;i++){
                                var totalReturn=parseInt(unsafeWindow.unitcost["unt"+typetrn][i])*parseInt(numtrptrn)*3600/2;
                                Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
                        }
        } 
        },
        onFailure: function () {
        },
    });
  },
  
 butcancelFort : function (typefrt, numtrpfrt, frtTmp, frtETA, frtNeeded, frtid, cityId, queueId){
   var t = Tabs.Train;
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   
   params.pf =0;
   params.requestType = "CANCEL_FORTIFICATIONS";
   params.cityId = cityId;
   params.typefrt = typefrt;
   params.numtrpfrt =  numtrpfrt;
   params.frtETA = frtETA;
   params.frtTmp = frtTmp;
   params.frtNeeded = frtNeeded;
   params.frtid = frtid;
   
   new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelFortifications.php" + unsafeWindow.g_ajaxsuffix, {
       method: "post",
       parameters: params,
       onSuccess: function (message) {
       var rslt=eval("("+message.responseText+")");
       if (rslt.ok) {
                        var k=0;
                        for(var j=0;j<Seed.queue_fort["city"+cityId].length;j++){
                                if(j>queueId){
                                        Seed.queue_fort["city"+cityId][j][2]=parseInt(rslt.dateFortifications[k]["start"]);
                                        Seed.queue_fort["city"+cityId][j][3]=parseInt(rslt.dateFortifications[k]["end"]);
                                        k++;
                                }
                        }
                        unsafeWindow.update_seed(rslt.updateSeed);
                        Seed.queue_fort["city"+cityId].splice(queueId,1);
                        for(var i=1;i<5;i++){
                                Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
                        }
                }
       },
       onFailure: function () {
       },
   });
 },
 
  
  stopTraining : function (msg){
    var t = Tabs.Train;
    clearTimeout (t.trainTimer);
    t.trainTimer = null;
    t.dispTrainStatus (msg +'<BR>');
    t.TDbutDo.disabled = false;
    t.TTbutDo.disabled = false;
    t.TTbutDo.value = 'Train Troops';
    t.TDbutDo.value = 'Build Defenses';
    t.TTbutDo.className = '';
    t.TDbutDo.className = '';
    t.running = false;
  },
  
  
  doQueue : function (cityId, tut, que, errMsg){
    var t = Tabs.Train;
    clearTimeout (t.trainTimer);
    try {
      t.displayCityStats();
      if (errMsg){
        t.stopTraining ('<SPAN class=boldRed>'+ errMsg +'</span>');
        return;
      }
      var cmd = que.shift();
      if (!cmd){
        t.stopTraining ('<B>Done queueing troops.</b>');
        return;
      }
      if (cmd[0] == 'T'){
        t.dispTrainStatus ('Training '+ cmd[2] +' '+  unsafeWindow.unitcost['unt'+cmd[1]][0] +' at '+ Cities.byID[cityId].name +' ('+ que.length +' slots remaining)<BR>');
        doTrain (cityId, tut, cmd[1], cmd[2], 
          function(errMsg){
            if (t.running)
              t.trainTimer = setTimeout(function (){Tabs.Train.doQueue(cityId, tut, que, errMsg);}, (Math.random()*2500)+1000 );
          }
        );
      }
    } catch (err) {
      logit (inspect (err, 8, 1));
      t.stopTraining  ('<SPAN class=boldRed>PROGRAM ERROR: '+ err.message +'</span>');
    }
  },
  
        doAutoDefenseTrain: function (cityNo) {
                var t = Tabs.Train;
                wall = {};
                var cityId = Cities.cities[cityNo - 1].id
                var cityID = 'city'+ cityId;
                getWallInfo (cityId, wall);
                availableSpace = wall.fieldSpace - wall.fieldSpaceUsed;
                if (availableSpace > 0 && wall.slotsBusy < 3) {
                        var food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
                        var wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
                        var stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
                        var ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
                        availableSlots = 3 - wall.slotsBusy;

                        secsPerTrap = Cities.byID[cityId]['Def60Time'];
                        if (secsPerTrap > 0 && wall.Trap + wall.TrapTraining == 0 && availableSpace > 3) {
                                if (food > 400 && wood > 800 & stone > 200 && ore > 400) {
                                        actionLog('Auto-Training 1 trap in city ' + Cities.byID[cityId].name);
                                        food -= 400;
                                        wood -= 800;
                                        stone -= 200;
                                        ore -= 400;
                                        availableSlots--;
                                        try {
                                                doDefTrain (cityId, 60, 1);
                                        } catch (err) {
                                                logit (inspect (err, 8, 1));
                                        }
                                }
                        }

                        secsPerCaltrop = Cities.byID[cityId]['Def61Time'];
                        if (secsPerCaltrop > 0 && wall.Caltrops + wall.CaltropsTraining == 0 && availableSpace > 0 && availableSlots > 0) {
                                if (food > 100 && ore > 400) {
                                        actionLog('Auto-Training 1 caltrop in city ' + Cities.byID[cityId].name);
                                        food -= 100;
                                        ore -= 400;
                                        availableSlots--;
                                        try {
                                                doDefTrain (cityId, 61, 1);
                                        } catch (err) {
                                                logit (inspect (err, 8, 1));
                                        }
                                }
                        }
                        var foodRes = AutoTrainOptions.keepFood[cityNo];
                        var woodRes = AutoTrainOptions.keepWood[cityNo];
                        var stoneRes = AutoTrainOptions.keepStone[cityNo];
                        var availFood = food - foodRes;
                        var availWood = wood - woodRes;
                        var availStone = stone - stoneRes;

                        secsPerSpike = Cities.byID[cityId]['Def62Time'];
                        if (secsPerSpike > 0 && availableSpace > 2 && availableSlots > 0) {
                                if (availFood > 150 && availWood > 750 & availStone > 50) {
                                        var numberToTrain = 9999999999;
                                        if ((availFood / 150) < numberToTrain)
                                                numberToTrain = parseInt(availFood / 150);
                                        if ((availWood / 750) < numberToTrain)
                                                numberToTrain = parseInt(availWood / 750);
                                        if ((availStone / 50) < numberToTrain)
                                                numberToTrain = parseInt(availStone / 50);
                                        if (numberToTrain > 5)
                                                numberToTrain = 5;
                                        if (wall.SpikedBarrier + wall.SpikedBarrierTraining < 10 || availableSpace < 15) {
                                                numberToTrain = 1;
                                                actionLog('Auto-Training 1 spike in city ' + Cities.byID[cityId].name);
                                        } else
                                                actionLog('Auto-Training ' + numberToTrain + ' spikes in city ' + Cities.byID[cityId].name);
                                        try {
                                                doDefTrain (cityId, 62, numberToTrain);
                                        } catch (err) {
                                                logit (inspect (err, 8, 1));
                                        }
                                }
                        }
                }
        },

        doAutoTrain: function (cityNo) {
                var t = Tabs.Train;
                clearTimeout (t.nextAuto);
                var cityId = Cities.cities[cityNo - 1].id
                var cityID = 'city'+ cityId;
                var troopType = AutoTrainOptions.troopType[cityNo];
                if (troopType > 0) {
                        var unitQ = Seed.queue_unt['city'+cityId];
                        var queued=0;
                        if (unitQ!=null && unitQ.length>0 )
                                queued = unitQ.length;
                        var slots = Cities.byID[cityId].numBarracks - queued;
                        secsPerTroop = Cities.byID[cityId]['Troop'+troopType+'Time'];
                        if (slots > 0 && secsPerTroop > 0)
                                t.doAutoTroopTrain(cityNo);
                }
                if (AutoTrainOptions.doDefenses[cityNo])
                        t.doAutoDefenseTrain(cityNo);
                if (cityNo == Cities.numCities)
                        t.nextAuto = setTimeout(function(){ t.doAutoTrain(1);}, (AutoTrainOptions.intervalSecs*1000));
                else
                        t.nextAuto = setTimeout(function(){ t.doAutoTrain(cityNo+1);}, 7000);
        },
}

/************************ Food Alerts *************************/
var FoodAlerts = {
  init : function (){
   var f = FoodAlerts;
   f.e_eachMinute();
  },
  minuteTimer : null,

  e_eachMinute : function (){  
    var f = FoodAlerts;
    var now = unixTime();
      row = [];
      for(i=0; i < Cities.numCities; i++) {
        var rp = getResourceProduction (Cities.cities[i].id);
        var foodleft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0])/3600;
        var usage = rp[1] - parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
        row[i] = rp[1] - usage;
          var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-usage) * 3600;
          var msg = '';
        if (usage < 0) {
    if (Options.enableFoodTower && timeLeft<(6*3600)) {
                msg += 'My city ' + Cities.cities[i].name.substring(0,10) + ' (' +
                      Cities.cities[i].x +','+ Cities.cities[i].y + ')';
                msg += ' food is low. remaining: '+addCommasWhole(foodleft)+' ('+timestrShort(timeLeft)+') spend: '+addCommas(usage);
                sendChat ("/a " + msg);
          }
    }
      }
  f.minuteTimer = setTimeout (f.e_eachMinute, 1800000);
  },
}

/************************ Tower Alerts ************************/
var TowerAlerts = {
  viewImpendingFunc : null,
  generateIncomingFunc : null,
  fixTargetEnabled : false,
  towerMarches : {},    // track all marches that have been posted to alliance chat
  
  init : function (){
    var t = TowerAlerts; 
    var s = GM_getValue ('towerMarches_'+GetServerId());
    if (s != null)
      t.towerMarches = JSON2.parse (s);
      t.viewImpendingFunc = new CalterUwFunc ('attack_viewimpending_view', [[/Modal.showModal\((.*)\)/im, 'Modal.showModal\($1\); ptViewImpending_hook(a);']]);
      uW.ptViewImpending_hook = t.viewImpending_hook;
      t.viewImpendingFunc.setEnable (true);
      t.generateIncomingFunc = new CalterUwFunc ('attack_generateincoming', [[/.*} else {\s*e = true;\s*}/im, '} else { e = ptGenerateIncoming_hook(); }']]);
      uW.ptGenerateIncoming_hook = t.generateIncoming_hook;
   },
     
  // fix 'target', add button  
  viewImpending_hook : function (atkinc){    
    var t = TowerAlerts;  
    var div = document.getElementById('modal_attackimpending_view');
    var isFalse = false;
    if (t.fixTargetEnabled){ 
      var city = Cities.byID[atkinc.toCityId];
      var target = '';
      if (!city || (atkinc.marchType!=3 && atkinc.marchType!=4)){  
        target = '<B>FALSE REPORT!</b>';
        isFalse = true;
      } else if (city.tileId == atkinc.toTileId){
        target = city.name + ' ('+ city.x + ','+ city.y +')';
      } else {
        wilds = Seed.wilderness['city'+atkinc.toCityId];
        m = '';
        for (k in wilds){
          if (wilds[k].tileId == atkinc.toTileId){
            m = 'at '+ wilds[k].xCoord + ','+ wilds[k].yCoord;
            break;
          }
        }
        target = city.name + ', <B>WILD '+ m +'</b>';
      }
      div.childNodes[0].innerHTML = '<B>Target: </b>'+ target;
    }
    if (!isFalse){
      var d = document.createElement ('div');
      d.innerHTML = '<BR><TABLE><TR><TD><a id=towerPostToChat class=button20><span>Post to Alliance Chat</span></a></td></tr></table>';
      div.appendChild (d);
      document.getElementById('towerPostToChat').addEventListener('click', function (){t.e_buttonPostToChat(atkinc)}, false);
    }
  },

  // fix false reports  
  generateIncoming_hook : function (){    
    return false;
  },
  
  enableFixFalseReports : function (tf){
    var t = TowerAlerts;  
    t.generateIncomingFunc.setEnable (tf);
  },


  
  isFixTargetAvailable : function (){
    var t = TowerAlerts;  
    return t.viewImpendingFunc.isAvailable();
  },

  isFixFalseReportsAvailable : function (){
    var t = TowerAlerts;  
    return t.generateIncomingFunc.isAvailable();
  },
  
  postToChatOptions : {aChat:false},

  setPostToChatOptions : function (obj){
    var t = TowerAlerts;
    t.postToChatOptions = obj;
    clearTimeout(t.secondTimer);
  },

  e_buttonPostToChat : function (march){
    var t = TowerAlerts;
    t.postToChat (march, true);
    uW.Modal.hideModal();
  },
  
  postToChat : function (m, force){
    var t = TowerAlerts;
    if (DEBUG_TRACE) logit ("checkTower(): INCOMING at "+ unixTime()  +": \n"+ inspect (m, 8, 1));
    if (m.marchType == null)      // bogus march (returning scouts)
        return;
    if (ENABLE_TEST_TAB) Tabs.Test.addDiv ("Incoming!<BR><PRE style='margin:0px;'>" + inspect (m, 8, 1) +'</pre>');
    if (m.marchType == 3){
      if (!t.postToChatOptions.scouting && !force)
        return;
      atkType = 'scouted';
    } else if (m.marchType == 4){
      atkType = 'attacked';
    } else {
      return;
    }
    var target, atkType, who;
    var city = Cities.byID[m.toCityId];
    if ( city.tileId == m.toTileId )
      target = 'city at '+ city.x +','+ city.y;
    else {
      if (!t.postToChatOptions.wilds && !force)
        return;
      target = 'wilderness';
      for (k in Seed.wilderness['city'+m.toCityId]){
        if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
          target += ' at '+ Seed.wilderness['city'+m.toCityId][k].xCoord +','+ Seed.wilderness['city'+m.toCityId][k].yCoord;
          break;
        }
      }
    }
    if (Seed.players['u'+m.pid])
      who = Seed.players['u'+m.pid].n;
    else if (m.players && m.players['u'+m.pid])
      who = m.players['u'+m.pid].n;
    else
      who = 'Unknown';
  
    if (m.fromXCoord)
      who += ' at '+ m.fromXCoord +','+ m.fromYCoord;
    var msg = '';
    if (!force)
      msg = t.postToChatOptions.aPrefix +' ';
    msg += 'My '+ target +' is being '+ atkType  +' by '+ who +'. Incoming Troops (arriving in '+
        uW.timestr(parseInt(m.arrivalTime - unixTime())) +') : ';
    var totTroops = 0;
    for (k in m.unts){
      var uid = parseInt(k.substr (1));
      msg += m.unts[k] +' '+ uW.unitcost['unt'+uid][0] +', ';
      totTroops += m.unts[k];
    }
    if ((totTroops < t.postToChatOptions.minTroops) && !force)
      return;
    msg = msg.slice (0, -2);
    msg += '.';
    if ( city.tileId == m.toTileId ){
      var emb = getCityBuilding(m.toCityId, 8);
      if (emb.count > 0){
        var availSlots = emb.maxLevel;
        for (k in Seed.queue_atkinc){
          if (Seed.queue_atkinc[k].marchType==2 && Seed.queue_atkinc[k].toCityId==m.toCityId && Cities.byID[Seed.queue_atkinc[k].fromCityId]==null){ 
            --availSlots;
          }
        }
        msg += ' My embassy has '+ availSlots +' of '+ emb.maxLevel +' slots available.';
      }
    }
    if (ENABLE_TEST_TAB) Tabs.Test.addDiv (msg);
    if (SEND_ALERT_AS_WHISPER)
      sendChat ("/"+ Seed.player.name +' '+ msg);    // Whisper to myself
    else
      sendChat ("/a "+  msg);                        // Alliance chat
  },
  }

/****************************  Tower Tab  ******************************/
Tabs.tower = {
  tabOrder: 2,
  tabLabel: 'Tower',
  myDiv: null,
  generateIncomingFunc : null,
  fixTargetEnabled : false,
  secondTimer : null,
  soundPlaying : false,
  defMode : {},  
  soundRepeatTimer : null,
  soundStopTimer : null,
  towerMarches: [],
  Providers : {
	0: { 'country': "--country--", 'provider': "--provider--" },
        1: { 'country': "AUSTRALIA", 'provider': "T-Mobile" },
        2: { 'country': "AUSTRALIA", 'provider': "Optus Zoo" },
        3: { 'country': "AUSTRIA", 'provider': "T-Mobile" },
        4: { 'country': "BULGARIA", 'provider': "Mtel" },
        5: { 'country': "BULGARIA", 'provider': "Globul" },
        6: { 'country': "CANADA", 'provider': "Aliant" },
        7: { 'country': "CANADA", 'provider': "Bell Mobility" },
        8: { 'country': "CANADA", 'provider': "Fido" },
        9: { 'country': "CANADA", 'provider': "MTS Mobility" },
        10: { 'country': "CANADA", 'provider': "Rogers Wireless" },
        11: { 'country': "CANADA", 'provider': "Sasktel Mobility" },
        12: { 'country': "CANADA", 'provider': "Telus" },
        13: { 'country': "CANADA", 'provider': "Virgin Mobile" },
        14: { 'country': "CANADA", 'provider': "Presidents Choice" },
        15: { 'country': "GERMANY", 'provider': "T-Mobile" },
        16: { 'country': "GERMANY", 'provider': "Vodafone" },
        17: { 'country': "GERMANY", 'provider': "O2" },
        18: { 'country': "GERMANY", 'provider': "E-Plus" },
        19: { 'country': "ICELAND", 'provider': "OgVodafone" },
        20: { 'country': "ICELAND", 'provider': "Siminn" },
        21: { 'country': "INDIA", 'provider': "Andhra Pradesh AirTel" },
        22: { 'country': "INDIA", 'provider': "Andhra Pradesh Idea Cellular" },
        23: { 'country': "INDIA", 'provider': "Chennal Skycell Airtel" },
        24: { 'country': "INDIA", 'provider': "Chennel RPG Cellular" },
        25: { 'country': "INDIA", 'provider': "Delhi Airtel" },
        26: { 'country': "INDIA", 'provider': "Delhi Hutch" },
        27: { 'country': "INDIA", 'provider': "Gujarat Idea Cellular" },
        28: { 'country': "INDIA", 'provider': "Gujaret Airtel" },
        29: { 'country': "INDIA", 'provider': "Gujaret Celforce" },
        30: { 'country': "INDIA", 'provider': "Goa Airtel" },
        31: { 'country': "INDIA", 'provider': "Goa BPL Mobile" },
        32: { 'country': "INDIA", 'provider': "Goa Idea Cellular" },
        33: { 'country': "INDIA", 'provider': "Haryana Airtel" },
        34: { 'country': "INDIA", 'provider': "Haryana Escotel" },
        35: { 'country': "INDIA", 'provider': "Himachal Pradesh Airtel" },
        36: { 'country': "INDIA", 'provider': "Karnataka Airtel" },
        37: { 'country': "INDIA", 'provider': "Kerala Airtel" },
        38: { 'country': "INDIA", 'provider': "Kerala Escotel" },
        39: { 'country': "INDIA", 'provider': "Kerala BPL Mobile" },
        40: { 'country': "INDIA", 'provider': "Kolkata Airtel" },
        41: { 'country': "INDIA", 'provider': "Madhya Pradesh Airtel" },
        42: { 'country': "INDIA", 'provider': "Maharashtra Airtel" },
        43: { 'country': "INDIA", 'provider': "Maharashtra BPL Mobile" },
        44: { 'country': "INDIA", 'provider': "Maharashtra Idea Cellular" },
        45: { 'country': "INDIA", 'provider': "Mumbai Airtel" },
        46: { 'country': "INDIA", 'provider': "Mumbai BPL Mobile" },
        47: { 'country': "INDIA", 'provider': "Punjab Airtel" },
        48: { 'country': "INDIA", 'provider': "Pondicherry BPL Mobile" },
        49: { 'country': "INDIA", 'provider': "Tamil Nadu Airtel" },
        50: { 'country': "INDIA", 'provider': "Tamil Nadu BPL Mobile" },
        51: { 'country': "INDIA", 'provider': "Tamil Nadu Aircel" },
        52: { 'country': "INDIA", 'provider': "Uttar Pradesh West Escotel" },
        53: { 'country': "IRELAND", 'provider': "Meteor" },
        54: { 'country': "IRELAND", 'provider': "Meteor MMS" },
        55: { 'country': "ITALY", 'provider': "TIM" },
        56: { 'country': "ITALY", 'provider': "Vodafone" },
        57: { 'country': "JAPAN", 'provider': "AU by KDDI" },
        58: { 'country': "JAPAN", 'provider': "NTT DoCoMo" },
        59: { 'country': "JAPAN", 'provider': "Vodafone Chuugoku/Western" },
        60: { 'country': "JAPAN", 'provider': "Vodafone Hokkaido" },
        61: { 'country': "JAPAN", 'provider': "Vodafone Hokuriko/Central North" },
        62: { 'country': "JAPAN", 'provider': "Vodafone Kansai/West, including Osaka" },
        63: { 'country': "JAPAN", 'provider': "Vodafone Kanto/Koushin/East including Tokyo" },
        64: { 'country': "JAPAN", 'provider': "Vodafone Kyuushu/Okinawa" },
        65: { 'country': "JAPAN", 'provider': "Vodafone Shikoku" },
        66: { 'country': "JAPAN", 'provider': "Vodafone Touhoku/Niigata/North" },
        67: { 'country': "JAPAN", 'provider': "Vodafone Toukai/Central" },
        68: { 'country': "JAPAN", 'provider': "Willcom" },
        69: { 'country': "JAPAN", 'provider': "Willcom di" },
        70: { 'country': "JAPAN", 'provider': "Willcom dj" },
        71: { 'country': "JAPAN", 'provider': "Willcom dk" },
        72: { 'country': "NETHERLANDS", 'provider': "T-Mobile" },
        73: { 'country': "NETHERLANDS", 'provider': "Orange" },
        74: { 'country': "SINGAPORE", 'provider': "M1" },
        75: { 'country': "SOUTH AFRICA", 'provider': "Vodacom" },
        76: { 'country': "SPAIN", 'provider': "Telefonica Movistar" },
        77: { 'country': "SPAIN", 'provider': "Vodafone" },
        78: { 'country': "SWEDEN", 'provider': "Tele2" },
        79: { 'country': "UNITED STATES", 'provider': "Teleflip" },
        80: { 'country': "UNITED STATES", 'provider': "Alltel" },
        81: { 'country': "UNITED STATES", 'provider': "Ameritech" },
        82: { 'country': "UNITED STATES", 'provider': "ATT Wireless" },
        83: { 'country': "UNITED STATES", 'provider': "Bellsouth" },
        84: { 'country': "UNITED STATES", 'provider': "Boost" },
        85: { 'country': "UNITED STATES", 'provider': "CellularOne" },
        86: { 'country': "UNITED STATES", 'provider': "CellularOne MMS" },
        87: { 'country': "UNITED STATES", 'provider': "Cingular" },
        88: { 'country': "UNITED STATES", 'provider': "Edge Wireless" },
        89: { 'country': "UNITED STATES", 'provider': "Sprint PCS" },
        90: { 'country': "UNITED STATES", 'provider': "T-Mobile" },
        91: { 'country': "UNITED STATES", 'provider': "Metro PCS" },
        92: { 'country': "UNITED STATES", 'provider': "Nextel" },
        93: { 'country': "UNITED STATES", 'provider': "O2" },
        94: { 'country': "UNITED STATES", 'provider': "Orange" },
        95: { 'country': "UNITED STATES", 'provider': "Qwest" },
        96: { 'country': "UNITED STATES", 'provider': "Rogers Wireless" },
        97: { 'country': "UNITED STATES", 'provider': "Telus Mobility" },
        98: { 'country': "UNITED STATES", 'provider': "US Cellular" },
        99: { 'country': "UNITED STATES", 'provider': "Verizon" },
        100: { 'country': "UNITED STATES", 'provider': "Virgin Mobile" },
        101: { 'country': "UNITED KINGDOM", 'provider': "O2 1" },
        102: { 'country': "UNITED KINGDOM", 'provider': "O2 2" },
        103: { 'country': "UNITED KINGDOM", 'provider': "Orange" },
        104: { 'country': "UNITED KINGDOM", 'provider': "T-Mobile" },
        105: { 'country': "UNITED KINGDOM", 'provider': "Virgin Mobile" },
        106: { 'country': "UNITED KINGDOM", 'provider': "Vodafone" },
        107: { 'country': "BELGIUM", 'provider': "mobistar" },
        108: { 'country': "GERMANY", 'provider': "1und1" },
        109: { 'country': "UNITED STATES", 'provider': "MyCricket" },
        110: { 'country': "Philippines", 'provider': "Smart" },
        111: { 'country': "UNITED STATES", 'provider': "CellularSouth" },
        112: { 'country': "UNITED STATES", 'provider': "Viaero" },
        113: { 'country': "CANADA", 'provider': "Wind Mobile" }
    },

    init: function(div){
		var t = Tabs.tower;
        t.myDiv = div;
      
             AddTowerTab('stop sound', t.stopSoundAlerts, 'pbtowertab');

    if (GM_getValue ('towerMarches_'+getServerId()) != null)
      GM_deleteValue ('towerMarches_'+getServerId());   // remove deprecated data if it exists
    var m = '<DIV class=pbStat>WATCH TOWER</div><TABLE class=pbTab><TR align=center>';
	  for (var i=0; i<Cities.cities.length; i++)
      m += '<TD width=95><SPAN id=pbtacity_'+ i +'>' + Cities.cities[i].name + '</span></td>';
    m += '</tr><TR align=center>';
	  for (var cityId in Cities.byID)
               m += '<TD><INPUT type=submit id=pbtabut_'+ cityId +' value=""></td>';
	       m += '</tr><TR align=center>';
	  for (var cityId in Cities.byID)
	   m += '<TD><CENTER><INPUT id=pbattackqueue_' + cityId + ' type=submit value="A 0 | D 0"></center></td>';
    m += '</tr></table><BR><DIV><CENTER><INPUT id=pbSoundStop type=submit value="stop sound"></center></div><DIV id=pbSwfPlayer></div>';
    m += '<BR><DIV class=pbStat>SETTING</div><TABLE class=pbTab>\
    <tr><td align=left><INPUT id=pbcellenable type=checkbox '+ (Options.celltext.atext?'CHECKED ':'') +'/></td>\
    <td align=left>Text message on the phone incoming attack n: <INPUT id=pbnum1 type=text size=4 maxlength=4 value="'+ Options.celltext.num1 +'"  '+(Options.celltext.provider==0?'DISABLED':'')+'\>\
	&nbsp;<INPUT id=pbnum2 type=text size=3 maxlength=3 value="'+ Options.celltext.num2 +'"  '+(Options.celltext.provider==0?'DISABLED':'')+'\>\
&nbsp;<INPUT id=pbnum3 type=text size=4 maxlength=4 value="'+ Options.celltext.num3 +'"  '+(Options.celltext.provider==0?'DISABLED':'')+'\> <span style="color:#800; font-weight:bold">(Standard rates apply for text messages )</span></td></tr><tr><td></td>\
    <TD align=left>country: <select id="pbfrmcountry">';
    for (var i in t.Providers) {
       var ret=m.indexOf(t.Providers[i].country);
       if (ret==-1) {
         if (t.Providers[i].country==t.Providers[Options.celltext.provider].country) {
           m += '<option value="'+t.Providers[i].country+'" selected="selected">'+t.Providers[i].country+'</option>'; // Load Previous Provider Selection
         }
         else {
           m += '<option value="'+t.Providers[i].country+'">'+t.Providers[i].country+'</option>';
         }
       }
    }
    m += '</select>\
    <select id="pbfrmprovider" '+(Options.celltext.provider==0?'DISABLED':'')+'><option value=0 >--provider--</option>';
    for (var i in t.Providers) {
 if(t.Providers[i].country == t.Providers[Options.celltext.provider].country)
		if(Options.celltext.provider == i)
			m += '<option value="'+i+'" selected="selected">'+t.Providers[i].provider+'</option>'; // Load Previous Provider Selection
		else
           m += '<option value="'+i+'">'+t.Providers[i].provider+'</option>';
    }
    m += '</select></td></tr>\
		<TR><TD><INPUT id=pbalertEnable type=checkbox '+ (Options.alertConfig.aChat?'CHECKED ':'') +'/></td><TD>Check automatically attack in alliance chat.</td></tr>\
        <TR><TD></td><TD><TABLE cellpadding=0 cellspacing=0>\
		<TR><TD align=right>Standard message: &nbsp; </td><TD><INPUT id=pbalertPrefix type=text size=60 maxlength=120 value="'+ Options.alertConfig.aPrefix +'" /></td></tr>\
		<TR><TD align=right>scout alert: &nbsp; </td><TD><INPUT id=pbalertScout type=checkbox '+ (Options.alertConfig.scouting?'CHECKED ':'') +'/></td></tr>\
        <TR><TD align=right>Wild attack -alert: &nbsp; </td><TD><INPUT id=pbalertWild type=checkbox '+ (Options.alertConfig.wilds?'CHECKED ':'') +'/></td></tr>\
       <TR><TD align=right>Show defensive state: &nbsp; </td><TD><INPUT id=pbalertDefend type=checkbox '+ (Options.alertConfig.defend?'CHECKED ':'') +'/></td></tr>\
       <TR><TD align=right>Minimum of troops: &nbsp; </td><TD><INPUT id=pbalertTroops type=text size=7 value="'+ Options.alertConfig.minTroops +'" \> &nbsp; &nbsp; <span id=pbalerterr></span></td></tr>\
        </table></td></tr>\
		<TR><TD align=right><INPUT id=pbalertraid type=checkbox '+ (Options.alertConfig.raid?'CHECKED':'') +'/></td><TD>Stop RAID in case of attack.</td></tr>\
         <TR><TD><BR></td></tr>\
        <TR><TD><INPUT id=pbSoundEnable type=checkbox '+ (Options.alertSound.enabled?'CHECKED ':'') +'/></td><TD>Enable sound in case of attack or scouted</td></tr>\
        <TR><TD></td><TD><DIV id=pbLoadingSwf>Loading SWF player</div><DIV style="display:none" id=pbSoundOpts><TABLE cellpadding=0 cellspacing=0>\
            <TR><TD align=right>Sound file: &nbsp; </td><TD><INPUT id=pbsoundFile type=text size=55 maxlength=160 value="'+ Options.alertSound.soundUrl +'" \>\
             &nbsp; </td><TD><INPUT id=pbSoundLoad type=submit value=Load><INPUT id=pbSoundDefault type=submit value="Default"></td></tr>\
            <TR><TD align=right>volume: &nbsp; </td><TD><TABLE cellpadding=0 cellspacing=0 class=pbTab><TR valign=middle><TD><SPAN id=pbVolSlider></span></td><TD width=15></td><TD align=right id=pbVolOut>0</td></td></table></td><TD align=center><SPAN id=pbLoadStat>xx</span></td></tr>\
            <TR><TD align=right><INPUT id=pbSoundRepeat type=checkbox '+ (Options.alertSound.repeat?'CHECKED ':'') +'/></td><TD> repeat every <INPUT id=pbSoundEvery type=text size=2 maxlength=5 value="'+ Options.alertSound.repeatDelay +'"> minutes</td></tr>\
            <TR><TD></td><TD>sound for <INPUT id=pbSoundLength type=text size=3 maxlength=5 value="'+ Options.alertSound.playLength +'"> sgs</td></tr>\
            <TR><TD></td><TD><INPUT type=submit value="test" id=pbPlayNow></td></tr><td><tr><SPAN class=boldRed>If you want another sound different, just put the path of it and upload, but Default.\
			The format should be .mp3<br>Ej: C:PathToFile.mp3</spam></td></tr></table></div></td></tr>\
        </table><BR>';
    	t.myDiv.innerHTML = m;
    t.mss = new CmatSimpleSound(SWF_PLAYER_URL, null, {height:0, width:0}, t.e_swfLoaded, 'debug=n');
    t.mss.swfDebug = function (m){ logit ('SWF: '+ m)};
    t.mss.swfPlayComplete = t.e_soundFinished;
    t.mss.swfLoadComplete = t.e_soundFileLoaded;
    unsafeWindow.matSimpleSound01 = t.mss;   // let swf find it
    t.volSlider = new SliderBar (document.getElementById('pbVolSlider'), 200, 21, 0);
    t.volSlider.setChangeListener(t.e_volChanged);
    document.getElementById('pbPlayNow').addEventListener ('click', function (){t.playSound(false)}, false);
    document.getElementById('pbSoundStop').addEventListener ('click', t.stopSoundAlerts, false);
    document.getElementById('pbSoundRepeat').addEventListener ('change', function (e){Options.alertSound.repeat = e.target.checked}, false);
    document.getElementById('pbSoundEvery').addEventListener ('change', function (e){Options.alertSound.repeatDelay = e.target.value}, false);
    document.getElementById('pbSoundLength').addEventListener ('change', function (e){Options.alertSound.playLength = e.target.value}, false);
    document.getElementById('pbSoundEnable').addEventListener ('change', function (e){Options.alertSound.enabled = e.target.checked}, false);
    document.getElementById('pbcellenable').addEventListener ('change', function (e){Options.celltext.atext = e.target.checked;}, false);
    document.getElementById('pbSoundStop').disabled = true;
    document.getElementById('pbalertEnable').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbalertPrefix').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbalertScout').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbalertWild').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbalertDefend').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbalertTroops').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbfrmcountry').addEventListener ('change', t.setCountry, false);
    document.getElementById('pbfrmprovider').addEventListener ('change', t.setProvider, false);
    document.getElementById('pbnum1').addEventListener ('change', t.phonenum, false);
    document.getElementById('pbnum2').addEventListener ('change', t.phonenum, false);
    document.getElementById('pbnum3').addEventListener ('change', t.phonenum, false);
    document.getElementById('pbalertraid').addEventListener ('change', t.e_alertOptChanged, false);
    document.getElementById('pbsoundFile').addEventListener ('change', function (){
        Options.alertSound.soundUrl = document.getElementById('pbsoundFile').value;
        t.loadUrl (Options.alertSound.soundUrl);
      }, false);
    document.getElementById('pbSoundDefault').addEventListener ('click', function (){
        document.getElementById('pbsoundFile').value = DEFAULT_ALERT_SOUND_URL;
        Options.alertSound.soundUrl = DEFAULT_ALERT_SOUND_URL;
        t.loadUrl (DEFAULT_ALERT_SOUND_URL);
      }, false);
    for (var cityId in Cities.byID){
  	  var but = document.getElementById ('pbtabut_'+ cityId);
  	  addListener (but, cityId);
  	  t.defMode[cityId] =  parseInt(Seed.citystats["city" + cityId].gate);
  	  t.displayDefMode (cityId);
	  var btnNameT = 'pbattackqueue_' + cityId;
      addTowerEventListener(cityId, btnNameT);
	  }
    function addListener (but, i){
      but.addEventListener ('click', function (){t.butToggleDefMode(i)}, false);
    }
	function addTowerEventListener(cityId, name){
        document.getElementById(name).addEventListener('click', function(){
            t.showTowerIncoming(cityId);
        }, false);
    }	
    setInterval (t.eachSecond, 2000);
  },   
   
  loadUrl : function (url){
    var t = Tabs.tower;
    t.mss.load (1, url, true);
    document.getElementById('pbLoadStat').innerHTML = 'Loading';
  },

  phonenum : function() {
   Options.celltext.num1 = document.getElementById('pbnum1').value;
   Options.celltext.num2 = document.getElementById('pbnum2').value;
   Options.celltext.num3 = document.getElementById('pbnum3').value;
   saveOptions();
  },

  setCountry : function(){
    var t = Tabs.tower;
    var myselect=document.getElementById("pbfrmprovider");
	myselect.innerHTML = '<option value=0 >--provider--</option>';
	myselect.disabled = true;
    for (var i in t.Providers) {
     if (t.Providers[i].country == document.getElementById("pbfrmcountry").value){
		var addoption = document.createElement('option');
		addoption.value = i;
		addoption.text = t.Providers[i].provider;
      myselect.add(addoption, null) //add new option to end of "Providers"
     }
    }
	myselect.disabled = false;
   },

  setProvider : function(){
    var ddProvider = document.getElementById("pbfrmprovider").wrappedJSObject;
     Options.celltext.provider=ddProvider.options[ddProvider.selectedIndex].value;
	if(ddProvider.selectedIndex > 0){
		document.getElementById("pbnum1").disabled = false;
		document.getElementById("pbnum2").disabled = false;
		document.getElementById("pbnum3").disabled = false;
	} else {
		document.getElementById("pbnum1").disabled = true;
		document.getElementById("pbnum2").disabled = true;
		document.getElementById("pbnum3").disabled = true;
	}
   },

  e_swfLoaded : function (){
    var t = Tabs.tower;
    document.getElementById('pbLoadingSwf').style.display = 'none';
    document.getElementById('pbSoundOpts').style.display = 'inline';
    t.volSlider.setValue (Options.alertSound.volume/100);
    t.loadUrl (Options.alertSound.soundUrl);
    setTimeout (function (){t.mss.setVolume (1, Options.alertSound.volume);}, 500);
    if (Options.alertSound.alarmActive && Options.alertSound.expireTime>unixTime())   
      t.soundTheAlert();
  },
  
  e_alertOptChanged : function (){
    var t = Tabs.tower;
    Options.alertConfig.aChat = document.getElementById('pbalertEnable').checked;
    Options.alertConfig.aPrefix=document.getElementById('pbalertPrefix').value;      
    Options.alertConfig.scouting=document.getElementById('pbalertScout').checked;      
    Options.alertConfig.wilds=document.getElementById('pbalertWild').checked;
    Options.alertConfig.defend=document.getElementById('pbalertDefend').checked;
    Options.alertConfig.raid=document.getElementById('pbalertraid').checked;
    var mt = parseInt(document.getElementById('pbalertTroops').value);
    if (mt<1 || mt>120000){
      document.getElementById('pbalertTroops').value = Options.alertConfig.minTroops;
      document.getElementById('pbalerterr').innerHTML = '<font color=#600000><B>INVALID</b></font>';
      setTimeout (function (){document.getElementById('pbalerterr').innerHTML =''}, 2000);
      return;
    }
    Options.alertConfig.minTroops = mt;
	saveOptions();
  },
  
  e_volChanged : function (val){
    var t = Tabs.tower;
    document.getElementById('pbVolOut').innerHTML = parseInt(val*100);
    Options.alertSound.volume = parseInt(val*100);
    t.mss.setVolume (1, Options.alertSound.volume);
  },
  
  butToggleDefMode : function (cityId){
    var t = Tabs.tower;
    var mode = 1;
    if (Seed.citystats["city" + cityId].gate != 0)
      mode = 0;
    t.ajaxSetDefMode (cityId, mode, function (newMode){
        t.defMode[cityId] = newMode;
        t.displayDefMode (cityId);
      });
  },
      
  displayDefMode : function (cityId){
    var t = Tabs.tower;
    var but = document.getElementById('pbtabut_'+ cityId);
    if (t.defMode[cityId]){
      but.className = 'pbDefButOn';
      but.value = 'Def = ON';  
    } else {
      but.className = 'pbDefButOff';
      but.value = 'Def = OFF';  
    }  
  },
    
  eachSecond : function (){
    var t = Tabs.tower;
	for (var cityId in Cities.byID){
      if (Seed.citystats["city" + cityId].gate != t.defMode[cityId]){     // user changed def mode
        t.defMode[cityId] = Seed.citystats["city"+ cityId].gate;
        t.displayDefMode (cityId);
      }
	  Options.alertConfig.raidautoswitch[cityId] = false;
    }
  	var now = unixTime();
	var incomming = false;
    if (matTypeof(Seed.queue_atkinc) != 'array'){
      for (var k in Seed.queue_atkinc){   // check each incoming march
        var m = Seed.queue_atkinc[k];
        if ((m.marchType==3 || m.marchType==4) && parseIntNan(m.arrivalTime)>now){
          if (m.departureTime > Options.alertConfig.lastAttack){
            Options.alertConfig.lastAttack = m.departureTime;  
            t.newIncoming (m);
          }
		  incomming = true;
		  if (Options.alertConfig.raid){
			Options.alertConfig.raidautoswitch[m.toCityId] = true;
		  }
        }
      }
    }
    if (Options.alertSound.alarmActive && (now > Options.alertSound.expireTime))
      t.stopSoundAlerts();

        t.towerMarches = [];
        for (var i = 0; i < Cities.cities.length; i++) {
            var cId = Cities.cities[i].id;
            t['attackCount_' + cId] = 0;
            t['scoutCount_' + cId] = 0;
        }
        if (matTypeof(Seed.queue_atkinc) != 'array') {
            for (var k in Seed.queue_atkinc) {
                var m = Seed.queue_atkinc[k];
                if ((m.marchType == 3 || m.marchType == 4) && parseIntNan(m.arrivalTime) > now) {
                    t.handleTowerData(m);

                }
            }
        }
        for (var i = 0; i < Cities.cities.length; i++) {
            var cId = Cities.cities[i].id;
            document.getElementById('pbattackqueue_' + cId).value = 'A ' + t['attackCount_' + cId] + ' | S ' + t['scoutCount_' + cId];
        }
  },   
  
  e_soundFinished : function (chan){ // called by SWF when sound finishes playing
    var t = Tabs.tower;
    if (chan != 1)
      return;
    if (!Options.alertSound.alarmActive){
      document.getElementById('pbSoundStop').disabled = true;
    }
  },

  e_soundFileLoaded : function (chan, isError){ // called by SWF when sound file finishes loading
    if (chan != 1)
      return;
    if (isError)  
      document.getElementById('pbLoadStat').innerHTML = '<FONT COLOR=#660000>ERROR:You must reload the file by default, or change the sound http</font>!';
    else
      document.getElementById('pbLoadStat').innerHTML = 'Loaded';
  },  
  
  playSound : function (doRepeats){
    var t = Tabs.tower;
    document.getElementById('pbSoundStop').disabled = false;
    clearTimeout (t.soundStopTimer);
    clearTimeout (t.soundRepeatTimer);
    t.mss.play (1, 0);
    t.soundStopTimer = setTimeout (function(){t.mss.stop(1); t.e_soundFinished(1)}, Options.alertSound.playLength*1000);
    if (doRepeats && Options.alertSound.repeat)
      t.soundRepeatTimer = setTimeout (function (){t.playSound(true)}, Options.alertSound.repeatDelay*60000);
    else
      Options.alertSound.alarmActive = false;
  },
        
  soundTheAlert : function (){
    var t = Tabs.tower;
    Options.alertSound.alarmActive = true;
    t.playSound(true);
  },
     
  stopSoundAlerts : function (){
    var t = Tabs.tower;
    t.mss.stop (1);
    clearTimeout (t.soundStopTimer);
    clearTimeout (t.soundRepeatTimer);
    document.getElementById('pbSoundStop').disabled = true;
    Options.alertSound.alarmActive = false;
    Options.alertSound.expireTime = 0;
  },

  newIncoming : function (m){
    var t = Tabs.tower;
    t.postToChat (m);
  },
  
  sendalert : function (m){
    var t = Tabs.tower;
    var now = unixTime();
    if (Options.celltext.atext)
      t.postToCell (m);
    if (Options.alertSound.enabled){
      t.soundTheAlert(m);
      if (m.arrivalTime > Options.alertSound.expireTime)
        Options.alertSound.expireTime = m.arrivalTime;
    }
	if (Options.alertConfig.raid){
		Tabs.Raid.StopCityRaids(m.toCityId);
		Options.alertConfig.raidautoswitch[m.toCityId] = true;
	}  
  },

  ajaxSetDefMode : function (cityId, state, notify){
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.cid = cityId;
		params.state = state;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/gate.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if (rslt.ok) {
					Seed.citystats["city" + cityId].gate = state;
					notify (state);
				}
			},
			onFailure: function () {
			}
		})
  },
  
  onUnload : function (){
  },

  postToCell : function (m){
    var t = Tabs.tower;
    var data = {};
    if (m.marchType == null)      // bogus march (returning scouts)
      return;
    if (m.marchType == 3){
      if (!Options.alertConfig.scouting)
        return;
      data.atkType = 'scout';
    } else if (m.marchType == 4){
      data.atkType = 'atk';
    } else {
      return;
    }
    var city = Cities.byID[m.toCityId];
    if ( city.tileId == m.toTileId )
      data.target = 'city ('+ city.x +','+ city.y+')';
    else {
      if (!Options.alertConfig.wilds)
        return;
      data.target = 'wild';
      for (k in Seed.wilderness['city'+m.toCityId]){
        if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
          data.target += Seed.wilderness['city'+m.toCityId][k].xCoord +','+ Seed.wilderness['city'+m.toCityId][k].yCoord;
          break;
        }
      }
    }
    if (Seed.players['u'+m.pid])
      data.who = Seed.players['u'+m.pid].n;
    else if (m.players && m.players['u'+m.pid])
      data.who = m.players['u'+m.pid].n;
    else
      data.who = 'Unknown';
    if (m.fromXCoord)
      data.who += m.fromXCoord +','+ m.fromYCoord;
     data.arrival = unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime()));
    var totTroops = 0;
    data.totTroops = ' '
    for (k in m.unts){
      var uid = parseInt(k.substr (1));
      data.totTroops += m.unts[k] +' '+ unsafeWindow.unitcost['unt'+uid][0] +', ';
      totTroops += m.unts[k];
    }
    if (totTroops < Options.alertConfig.minTroops)
      return;
    if ( city.tileId == m.toTileId ){
      var emb = getCityBuilding(m.toCityId, 8);
      if (emb.count > 0){
        var availSlots = emb.maxLevel;
        for (k in Seed.queue_atkinc){
          if (Seed.queue_atkinc[k].marchType==2 && Seed.queue_atkinc[k].toCityId==m.toCityId && Cities.byID[Seed.queue_atkinc[k].fromCityId]==null){
            --availSlots;
          }
        }
        data.embassy = 'EMB '+ availSlots +'of'+ emb.maxLevel;
        if (t.defMode[m.toCityId] == 0 && Options.alertConfig.defend==true)
        {
            data.stat = 'sanctuary';
        }
        if (t.defMode[m.toCityId] == 1 && Options.alertConfig.defend==true)
        {
            data.stat = 'DEFENDING';
        }
      }
    }
    data.provider = Options.celltext.provider;
    data.num1 = Options.celltext.num1;
    data.num2 = Options.celltext.num2;
    data.num3 = Options.celltext.num3;
    data.serverId = getServerId();
    data.player = Seed.player['name'];
    data.city = city.name;

  GM_xmlhttpRequest({
    method: 'POST',
    url: 'http://hs151.digitalweb.net/index.php',
	headers: {
		'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    },
	data: implodeUrlArgs(data),

	})
  },
  
  postToChat : function (m){
	var t = Tabs.tower;
    if (DEBUG_TRACE) logit ("checkTower(): INCOMING at "+ unixTime()  +": \n"+ inspect (m, 8, 1));
    if (m.marchType == null)      // bogus march (returning scouts)
      return;
    if (ENABLE_TEST_TAB) Tabs.Test.addDiv ("Incoming!<BR><PRE style='margin:0px;'>" + inspect (m, 8, 1) +'</pre>');
    if (m.marchType == 3){
      if (!Options.alertConfig.scouting)
        return;
      atkType = 'Scouted';	  
    } else if (m.marchType == 4){
      atkType = 'ATTACKED';
    } else {
      return;
         }
    var target, atkType, who;
    var city = Cities.byID[m.toCityId];
    var cityNames = Cities.byID[m.toCityId].name;
	if ( city.tileId == m.toTileId ){
            target = 'city '+ cityNames + 'in ('+ city.x +','+ city.y + ')';
        }
        else {
      if (!Options.alertConfig.wilds)
        return;
      target = 'wild';
      for (k in Seed.wilderness['city'+m.toCityId]){
        if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
          target += ' in ('+ Seed.wilderness['city'+m.toCityId][k].xCoord +','+ Seed.wilderness['city'+m.toCityId][k].yCoord + ')';
          break;
        }
      }
    }
    if (Seed.players['u'+m.pid])
      who = Seed.players['u'+m.pid].n;
    else if (m.players && m.players['u'+m.pid])
      who = m.players['u'+m.pid].n;
    else
      who = 'Unknown';
    if (m.fromXCoord)
	who += ' desde ('+ m.fromXCoord +','+ m.fromYCoord + ')';
        who += ' ('+getDiplomacy(m.aid)+')';
        var msg = Options.alertConfig.aPrefix +' ';
	if(m.marchStatus == 9)
	msg += 'El '+ atkType +' in my '+ target +' by '+ who +' has been returned.';
	else
    	msg += 'my '+ target +' being '+ atkType +' by '+ who +' Troops (coming in'+ unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime())) +') : ';
     var totTroops = 0;
    for (k in m.unts){
      var uid = parseInt(k.substr (1));
      msg += m.unts[k] +' '+ unsafeWindow.unitcost['unt'+uid][0] +', ';
      totTroops += m.unts[k];
    }
    if (totTroops < Options.alertConfig.minTroops)
      return;
    msg = msg.slice (0, -2);
    msg += '.';
    if ( city.tileId == m.toTileId ){
      var emb = getCityBuilding(m.toCityId, 8);
      if (emb.count == 0)
        msg += ' My embassy was not built in this realm. Do not attempt to strengthen.';
      else {
        var availSlots = emb.maxLevel;
        for (k in Seed.queue_atkinc){
          if (Seed.queue_atkinc[k].marchType==2
            && Seed.queue_atkinc[k].toCityId==m.toCityId)
          {
            --availSlots;
          }
        }
      	msg += ' My embassy is '+ availSlots +'slots free '+ emb.maxLevel +'slots available.';
	if (t.defMode[m.toCityId] == 0 && Options.alertConfig.defend==true)
        {
            msg+= ' My troops are not DEFENDING !';
        }
        if (t.defMode[m.toCityId] == 1 && Options.alertConfig.defend==true)
        {
            msg+= ' My troops are DEFENDING!';
        }
            msg+= ' My levels of research are: Fl Lv' + parseInt(Seed.tech.tch13)
             + ', HP Lv'+ parseInt(Seed.tech.tch15)
             + ', PE Lv'+ parseInt(Seed.tech.tch8)
             + ', MA Lv'+ parseInt(Seed.tech.tch9)
             + ', MM Lv'+ parseInt(Seed.tech.tch11)
             + ', AH Lv'+ parseInt(Seed.tech.tch12);
	  }
    }
	t.sendalert(m);
    if (!Options.alertConfig.aChat) return;
	if (ENABLE_TEST_TAB) Tabs.Test.addDiv (msg);
    if (SEND_ALERT_AS_WHISPER)
      sendChat ("/"+ Seed.player.name +' '+ msg);    // Whisper to myself
    else
		sendChat ("/a "+  msg);                        // Alliance chat
	},
	      handleTowerData: function(m){
        var t = Tabs.tower;
        var now = unixTime();
        var target, atkType, who, attackermight, allianceId, allianceName, diplomacy;
        var city = Cities.byID[m.toCityId];

        if (DEBUG_TRACE)
            logit("checkTower(): They arrive in" + unixTime() + ": \n" + inspect(m, 8, 1));

        //ATKTYPE
        if (m.marchType == 3) {
            atkType = 'Scouted';
            t['scoutCount_' + m.toCityId]++;
        }
        else
            if (m.marchType == 4) {
                atkType = 'attacked';
                t['attackCount_' + m.toCityId]++;
            }
            else {
                return;
            }
        //TARGET
        if (city.tileId == m.toTileId)
            target = 'city ' + city.x + ',' + city.y;
        else {
            target = 'wild';
            for (k in Seed.wilderness['city' + m.toCityId]) {
                if (Seed.wilderness['city' + m.toCityId][k].tileId == m.toTileId) {
                    target += ' in ' + Seed.wilderness['city' + m.toCityId][k].xCoord + ',' + Seed.wilderness['city' + m.toCityId][k].yCoord;
                    break;
                }
            }
        }

        //CITYNAME
        var cityName = Cities.byID[m.toCityId].name;
        
        //TROOPS
        var units = [];
        for (i = 0; i < 13; i++)
            units[i] = 0;
        for (k in m.unts) {
            var uid = parseInt(k.substr(1));
            if (unsafeWindow.unitcost['unt' + uid][0] == 'SupplyTroop.')
                units[1] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'Militiaman')
                units[2] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'Scout')
                units[3] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'Pikeman')
                units[4] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'Swordsman')
                units[5] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'archers')
                units[6] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'L.CAV')
                units[7] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'H.CAV')
                units[8] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'SupplyWagon.')
                units[9] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'Ballesta')
                units[10] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'BatteringRam')
                units[11] = m.unts[k];
            if (unsafeWindow.unitcost['unt' + uid][0] == 'Catapult')
                units[12] = m.unts[k];
        }
        //ATTACKERS INFORMATION
        if (Seed.players['u' + m.pid]) {
            who = Seed.players['u' + m.pid].n;
            attackermight = Seed.players['u' + m.pid].m;
            allianceId = Seed.players['u' + m.pid].a;
            allianceName = Seed.allianceNames[allianceId];
            diplomacy = getDiplomacy(allianceId);
        }
        else
            if (m.players && m.players['u' + m.pid]) {
                who = m.players['u' + m.pid].n;
                attackermight = parseInt(m.players['u' + m.pid].m);
                allianceId = 'a' + m.players['u' + m.pid].a;
                allianceName = Seed.allianceNames[allianceId];
                diplomacy = getDiplomacy(allianceId);
            }
            else {
                who = 'n.A.';
                attackermight = 'n.A.';
                allianceId = 'n.A.';
                allianceName = 'n.A.';
                diplomacy = 'n.A.';
            }
		//SOURCE
        if (m.fromXCoord)
            var source = m.fromXCoord + ',' + m.fromYCoord;
        else
            var source = 'n.A.';
        
        var arrivingDatetime = new Date();
        arrivingDatetime.setTime(m.arrivalTime * 1000);
        var count = t.towerMarches.length + 1;
        t.towerMarches[count] = {
            added: now,
            cityId: m.toCityId,
            target: target,
            arrival: parseIntNan(m.arrivalTime),
            atkType: atkType,
            who: who,
            attackermight: attackermight,
            allianceName: allianceName,
            diplomacy: diplomacy,
            rtime: unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime())),
            arrivingDatetime: arrivingDatetime,
			source:source,
            units: units,
        };
    },

    showTowerIncoming: function(cityId){
        var t = Tabs.tower;
        var popTowerIncoming = null;
        var cityName = Tabs.build.getCityNameById(cityId);
        
        if (t.popTowerIncoming == null) {
            t.popTowerIncoming = new CPopup('pbtower_' + cityId, 0, 0, 750, 500, true, function() {clearTimeout (t.timer);});
        }
        t.popTowerIncoming.show(false);
        var m = '<DIV style="max-height:460px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbTabPad" id="pbCityTowerContent">';
        t.popTowerIncoming.getMainDiv().innerHTML = '</table></div>' + m;
        t.popTowerIncoming.getTopDiv().innerHTML = '<div class=showBadged><center><TD width="200px"><B>Report of the tower ' + cityName +'</b></td></center></div>';
        t.addCityData2Pop(cityId);                     
        t.popTowerIncoming.show(true);
		clearTimeout (t.timer);
		t.timer = setTimeout (function() {t.showTowerIncoming(cityId)}, 5000);        
    },

    addCityData2Pop: function(cityId){
        var t = Tabs.tower;
        var rownum = 0;
        var names = ['SupplyTroop.', 'Militiaman.', 'Scout.', 'Pikeman.', 'Swordsman.', 'Archer.', 'cav.', 'H.cav', 'SupplyWagon.', 'Ballista.', 'Rams.', 'Catapult.'];
        enc = {};
        numSlots = 0;
        var row = document.getElementById('pbCityTowerContent').innerHTML = "";
        if (matTypeof(Seed.queue_atkinc) != 'array') {
            for (k in Seed.queue_atkinc) {
                march = Seed.queue_atkinc[k];
                if (march.marchType == 2) {
                    ++numSlots;
                    city = march.toCityId;
                    from = march.fromPlayerId;
					if (!enc[city])
                        enc[city] = {};
                    if (!enc[city][from])
                        enc[city][from] = [];
                    k = [];
                    k[0] = parseInt(march.knightCombat);
                    for (i = 1; i < 13; i++) {
                        if (Options.encRemaining)
                            k[i] = parseInt(march['unit' + i + 'Return']);
                        else
                            k[i] = parseInt(march['unit' + i + 'Count']);
                    }
					k[14] = parseInt(march.marchStatus);
					var now = unixTime();
					k[15] = parseInt(march.destinationUnixTime) - now;
                    enc[city][from].push(k);
                }
            }
        }
        var s1 = '';
		var s2 = '';
		var s3 = '';
		var tot = [];
        var atk = [];
        for (i = 0; i < 13; i++) {
            tot[i] = 0;
            atk[i] = 0;
        }

            s1 += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;} .attack{background:#FF9999;} .own{background:#66FF66;}</style>';
            s1 += '<TABLE cellspacing=0 width=100%><TR align=right><TD align=center width=16%></td>';
            
            for (k = 0; k < names.length; k++)
                s1 += '<TD width=7%><B>' + names[k] + '</b></td>';
            s1 += '</tr>';
            dest = cityId;
            if (enc[dest]) {
                for (p in enc[dest]) {
                    try {
                        player = Seed.players['u' + p].n;
                    }
                    catch (err) {
                        player = '???';
                    }
                    for (m = 0; m < enc[dest][p].length; m++) {
                        /*knight = '';
                        if (enc[dest][p][m][0] > 0)
                            knight = ' (' + enc[dest][p][m][0] + ')';
						*/
						status = '';
                        if (enc[dest][p][m][14] == 1) {
						    status = ' (' + timestr(enc[dest][p][m][15]) + ')';	
							if (enc[dest][p][m][15] < 0)
								status = ' (enc)';	
							else
								 status = ' (' + timestr(enc[dest][p][m][15]) + ')';	
						}
						if (enc[dest][p][m][14] == 2) {
						    status = ' (enc)';	
						}

                        s1 += '<TR align=right><TD align=left class="city">' + player + status +'</td>'
                        for (i = 1; i < 13; i++) {
                            num = enc[dest][p][m][i];
                            s1 += '<TD class="city">' + num + '</td>';
                            tot[i] += num;
                        }
                        //s1 += '<TD><INPUT id=sendhome_' + numSlots + ' type=submit value="Home" style="border:1px solid black; background-color:red;"></td></tr>';
                    }
                }
            } else {
                s1 += '<TR align=right><TD align=left class="city"><B>reinforcement:</b></td>'
                for (i = 1; i < 13; i++) {
                    s1 += '<TD class="city">0</td>';
                }
                
            }
			s1 += '<TR align=right><TD colspan=14><BR></tr>';
            s1 += '<TR align=right><TD class="own" align=left><B>own troops:</b></td>';
            //OWNTROOPS
            var ownTroops = "";
            for (r = 1; r < 13; r++) {
                cityString = 'city' + cityId;
                num = parseInt(Seed.units[cityString]['unt' + r]);
                s1 += '<TD class="own">' + num + '</td>';
                tot[r] += num;
            }
            s1 += '<TD class="city"></td><TR><TD colspan=14><BR></td></tr><TR align=right><TD class="tot" align=left><B>defend:</b></td>';
            for (i = 1; i < 13; i++)
                s1 += '<TD class="tot">' + tot[i] + '</td>';      
			s3 += '</tr></table>';
                s3 += '<TD class="city"></td><TR><TD colspan=14><BR></td></tr><TR align=right><TD class="tot" align=left><B>incoming attacks:</b></td>';
        var names = ['suppy troop.', 'Militiaman.', 'Scout.', 'Pikeman.', 'Swordsman.', 'Archers.', 'cav.', 'H.cav', 'supply wagon.', 'Balli.', 'ram.', 'Catap.'];
        if (t.towerMarches.length > 0) {
            for (k in t.towerMarches) {
                if (typeof t.towerMarches[k].atkType != 'no definido') {
                    if (t.towerMarches[k].cityId == cityId) {
                        s3 += '<TABLE cellspacing=0 width=100%><TR>';
                    if (t.towerMarches[k].atkType == 'atacado') {
                        s3 += '<TD rowspan=2 width=5%><B><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_30.jpg?6545"></b></td>';
                        }
                        else
                            if (t.towerMarches[k].atkType == 'explorado') {
                                s3 += '<TD rowspan=2 width=5%><B><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_30.jpg?6545"></b></td>';
                            }
                        s3 += '<TD width=15%  ><B>Location</b></td>';
                        s3 += '<TD width=15%  ><B>name</b></td>';
						s3 += '<TD width=10%><B>Source: </b></td><TD width=10%>' + t.towerMarches[k].source + '</td>';
                        s3 += '<TD width=10%><B>might: </b></td><TD width=10%>' + t.towerMarches[k].attackermight + '</td>';
                        s3 += '<TD width=10%><B>alliance: </b></td><TD width=10%>' + t.towerMarches[k].allianceName + '</td>';
                        s3 += '<TD width=10%><B>status: </b></td><TD width=10%>' + t.towerMarches[k].diplomacy + '</td></tr>';
                        s3 += '<TR><TD width=10%  >' + t.towerMarches[k].target + '</td>';
                        s3 += '<TD  >' + t.towerMarches[k].who + '</td>';
                        s3 += '<TD><B>remaining: </b></td><TD width=10%>' + t.towerMarches[k].rtime + '</td>';
                        s3 += '<TD><B>arrival: </b></td><TD  colspan=5 width=10%>' + t.towerMarches[k].arrivingDatetime + '</td></tr>';
                        s3 += '</tr></table>';
                        s3 += '<TABLE cellspacing=0 width=100%><TR align=right><TD align=left width=16%></td>';
                        for (n = 0; n < names.length; n++)
                            s3 += '<TD width=7%><B>' + names[n] + '</b></td>';
                        s3 += '</tr><TR align=right><TD class="attack" align=left><B>Units:</td>';
                        for (u = 1; u < 13; u++) {
                            num = t.towerMarches[k].units[u];
                            s3 += '<TD class="attack">' + num + '</td>';
                            atk[u] += parseInt(num);
                        }
						s3 += '</tr></table>';
                    }
                }
                
            }
        }
	s2 += '<TR><TD colspan=14><BR></td></tr><TR align=right><TD class="attack" align=left><B>attackers:</b></td>';
        for (a = 1; a < 13; a++)
        s2 += '<TD class="attack" width=7%>' + atk[a] + '</td>';
	var html = s1 + s2 + s3;
        document.getElementById('pbCityTowerContent').innerHTML = html;
    },
    sendReinforcmentHome: function(){ //FUNCTION NOT IN USE YET BUT SOON :-)
        //mid, cid, fromUid, fromCid, upkeep
        var params = Object.clone(g_ajaxparams);
        params.mid = mid;
        params.cid = cid;
        params.fromUid = fromUid;
        params.fromCid = fromCid;
        new Ajax.Request(g_ajaxpath + "ajax/kickoutReinforcements.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function(transport){
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.showAlert(g_js_strings.kickout_allies.troopshome);
                    seed.resources["city" + currentcityid].rec1[3] = parseInt(seed.resources["city" + currentcityid].rec1[3]) - upkeep;
                    if (parseInt(fromUid) == parseInt(tvuid)) {
                        var curmarch = seed.queue_atkp["city" + fromCid]["m" + mid];
                        var marchtime = Math.abs(parseInt(curmarch.destinationUnixTime) - parseInt(curmarch.eventUnixTime));
                        curmarch.returnUnixTime = unixTime() + marchtime;
                        curmarch.marchStatus = 8
                    }
                    delete seed.queue_atkinc["m" + mid]
                }
                else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function(){
            }
        })
    },
            show : function (){
            },
  
            hide : function (){
            },
}

/****************************  Build Tab *********************************************************
TODO:
	 visu directly in the game of build queue elements
	 <span class="leveltag" style="left:60px;">10</span>
	 more todos within the code
 */
Tabs.build = {
    tabOrder: 4,
    tabLabel: 'Build',
    myDiv: null,
    timer: null,
    buildTab: null,
    koc_buildslot: null,
    currentBuildMode: null,
    buildStates: [],
	loaded_bQ: [],
	lbQ: [],

    init: function(div){
        var t = Tabs.build;
        t.myDiv = div;
        t.koc_buildslot = unsafeWindow.buildslot; //save original koc function
        t.currentBuildMode = "build";
		t.buildStates = {
            running: false,
			help: false,
        };
        t.readBuildStates();
        for (var i = 0; i < Cities.cities.length; i++) {
            t["bQ_" + Cities.cities[i].id] = JSON2.parse(GM_getValue('bQ_' + getServerId() + '_' + Cities.cities[i].id, '[]'));
			if (typeof t["bQ_" + Cities.cities[i].id] == 'undefined' || (t["bQ_" + Cities.cities[i].id]) == "") {
				t["bQ_" + Cities.cities[i].id] = [];
			}
        }

        var m = '<DIV id=pbBuildDivF class=pbStat>Build Functions</div><TABLE id=pbbuildfunctions width=100% height=0% class=pbTab><TR>';
        if (t.buildStates.running == false) {
            m += '<TD><INPUT id=pbBuildRunning type=submit value="Auto Build = OFF"></td>';
		updatebotbutton('Build-OFF', 'pbbuildtab');
        }
        else {
            m += '<TD><INPUT id=pbBuildRunning type=submit value="Auto Build = ON"></td>';
		updatebotbutton('Build-ON', 'pbbuildtab');
        }
		m += '<TD><INPUT id=pbBuildMode type=submit value="Modo Build = OFF"></td>';
		updatebotbutton('Const Mode.-OFF', 'pbbuildmtab');
		m += '<TD>Construction Mode: <SELECT id="pbBuildType">\
				<OPTION value=build>level up</option>\
				<OPTION value=max>max Level</option>\
				<OPTION value=destruct>destruct</option>\
				</select></td>';
		m += '<TD><INPUT id=pbHelpRequest type=checkbox '+ (t.buildStates.help?' CHECKED':'') +'\></td><TD>ask for Help?</td>';
		m += '<TD><INPUT id=pbHelp type=submit value="help"></td>';
		m += '</tr></table></div>';
      m += '<DIV id=pbBuildDivQ class=pbStat>Buld ques</div><TABLE id=pbbuildqueues width=100% height=0% class=ptentry><TR>';
		for (var i = 0; i < Cities.cities.length; i++) {
            m += '<TD colspan=2><CENTER><B>' + Cities.cities[i].name + '</b></center></td>';
        }
		m += '</tr><TR>';
        for (var i = 0; i < Cities.cities.length; i++) {
            m += '<TD colspan=2><CENTER><INPUT id=pbbuild_' + Cities.cities[i].id + ' type=submit value="view"></center></td>';
        }
        m += '</tr><TR>';
        for (var i = 0; i < Cities.cities.length; i++) {
            m += '<TD colspan=2><CENTER><INPUT id=pbCancelAll_' + Cities.cities[i].id + ' type=submit value="Clear all"></center></td>';
        }
        m += '</tr><TR>';
        for (var i = 0; i < Cities.cities.length; i++) {
            m += '<TD>Const.:</td><TD id=pbbuildcount_' + Cities.cities[i].id + '>' + t["bQ_" + Cities.cities[i].id].length + '</td>';
        }
        m += '</tr><TR>';
        for (var i = 0; i < Cities.cities.length; i++) {
            t['totalTime_' + Cities.cities[i].id] = 0;
            cbQ = t["bQ_" + Cities.cities[i].id];
            if (typeof cbQ != 'undefined') {
                for (var j = 0; j < cbQ.length; j++) {
                    t['totalTime_' + Cities.cities[i].id] = parseInt(t['totalTime_' + Cities.cities[i].id]) + parseInt(cbQ[j].buildingTime);
                }
                timestring = timestr(t['totalTime_' + Cities.cities[i].id]);
            }
            m += '<TD>Total:</td><TD id=pbbuildtotal_' + Cities.cities[i].id + '>' + timestring + '</td>';
        }
        m += '</tr></table><SPAN class=boldRed id=pbbuildError></span>';
        t.myDiv.innerHTML = m;

        for (var i = 0; i < Cities.cities.length; i++) {
            var cityId = Cities.cities[i].id;
            var btnName = 'pbbuild_' + cityId;
            addQueueEventListener(cityId, btnName);
            var btn2Name = 'pbCancelAll_' + cityId;
            CancelAllEventListener(cityId, btn2Name);
			t.showBuildQueue(cityId, false);
        }

        t.e_autoBuild(); //start checking if we can build someting

                document.getElementById('pbBuildRunning').addEventListener('click', t.toggleStateRunning, false);
		document.getElementById('pbBuildType').addEventListener('change', function(){t.setBuildMode(this.value);}, false);
	   	document.getElementById('pbBuildMode').addEventListener('click', t.toggleStateMode, false);
                document.getElementById('pbHelp').addEventListener('click', t.pbHelp, false);
		document.getElementById('pbHelpRequest').addEventListener ('change', function (){
        t.buildStates.help = (document.getElementById('pbHelpRequest').checked);
        t.saveBuildStates();
        }, false);

		window.addEventListener('unload', t.onUnload, false);

        function addQueueEventListener(cityId, name){
            document.getElementById(name).addEventListener('click', function(){
                t.showBuildQueue(cityId, true);
            }, false);
        }

        function CancelAllEventListener(cityId, name){
            document.getElementById(name).addEventListener('click', function(){
            	t["bQ_" + cityId] = [];
            	t['totalTime_' + cityId] = 0;
            	document.getElementById('pbbuildcount_' + cityId).innerHTML = 0;
            	document.getElementById('pbbuildtotal_' + cityId).innerHTML = timestr(0);
            }, false);
        }


    },
  pbHelp : function (){
    var helpText = '<BR>Designed to create self-tails.<BR>';
    helpText += 'Auto Build ON/OFF---> Active Mode auto construction.<BR>';
    helpText += 'Build Mode ON / OFF ----> To Create the construction queue!. We itching in the game each building.<BR>';
    helpText += 'Building Mode ---> We indicate if we destroy, Up one level or the maximum level of the building in question.<BR>';
    helpText += 'View Button ----> Displays the tail of building the city in question!<BR>';
    helpText += 'Sometimes, you can rest stop tail, is a matter of deleting and remaking it again!<BR>';

    var pop = new CPopup ('pbHelp', 0, 0, 585, 230, true);
    pop.centerMe (mainPop.getMainDiv());
    pop.getMainDiv().innerHTML = helpText;
    pop.getTopDiv().innerHTML = '<div class=showBadged><center>Help menu Power Koc: self builder</center></div>';
    pop.show (true);
  },
  
  setBuildMode: function (type) {
    var t = Tabs.build;
    t.currentBuildMode = type;
  },

  e_autoBuild: function(){
    var t = Tabs.build;
    document.getElementById('pbbuildError').innerHTML = '';
    if (t.buildStates.running == true) {
          var now = unixTime();
          for (var i = 0; i < Cities.cities.length; i++) {
              var cityId = Cities.cities[i].id;
              var isBusy = false;
              var qcon = Seed.queue_con["city" + cityId];
              if (matTypeof(qcon)=='array' && qcon.length>0) {
                if (parseInt(qcon[0][4]) > now)
                  isBusy = true;
                else
                  qcon.shift();   // remove expired build from queue
              }
              if (isBusy) {
                  //TODO add info of remaining build time and queue infos
              } else {
                 if (t["bQ_" + cityId].length > 0) { // something to do?
                 	var bQi = t["bQ_" + cityId][0];   //take first queue item to build
                 	  t.doOne (bQi);
                }
              }
            }
          }
		setTimeout(t.e_autoBuild, 10000); //should be at least 10
    },
    doOne : function (bQi){
		var t = Tabs.build;
		var currentcityid = parseInt(bQi.cityId);
		var cityName = t.getCityNameById(currentcityid);
		var time = parseInt(bQi.buildingTime);
		var mult = parseInt(bQi.buildingMult);
		var attempt = parseInt(bQi.buildingAttempt);
 		var mode = bQi.buildingMode;
		var citpos = parseInt(bQi.buildingPos);
		if (Seed.buildings['city' + currentcityid]["pos" + citpos] != undefined && Seed.buildings['city' + currentcityid]["pos" + citpos][0] != undefined) {
		var l_bdgid = parseInt(bQi.buildingType); //JUST FOR CHECK
		var bdgid = parseInt(Seed.buildings['city' + currentcityid]["pos" + citpos][0]);
		var l_curlvl = parseInt(bQi.buildingLevel); //JUST FOR CHECK
 		var curlvl = parseInt(Seed.buildings['city' + currentcityid]["pos" + citpos][1]);
		var l_bid = parseInt(bQi.buildingId); //JUST FOR CHECK
		var bid = parseInt(Seed.buildings["city" + currentcityid]["pos" + citpos][3]);
		if (curlvl > 8 && mode == 'build') {
			t.cancelQueueElement(0, currentcityid, time, false);
			actionLog(" Deleted Items: Building level is equal to 9 or more!!!");
			return;
		};
		if (isNaN(curlvl)) {
			t.cancelQueueElement(0, currentcityid, time, false);
			actionLog("Found no correct value for current building!!!!");
			return;
 		}
		if (l_bdgid != bdgid) {
			t.cancelQueueElement(0, currentcityid, time, false);
			actionLog("Building Type does not match!!!!");
			return;
		}
		if (l_bid != bid) {
			t.cancelQueueElement(0, currentcityid, time, false);
			actionLog("Building ID does not match!!!!");
			return;
		}
		if (l_curlvl < curlvl) {
				t.cancelQueueElement(0, currentcityid, time, false);
				actionLog("Queue item deleted: Buildinglevel is equal or higher!!!");
				return;
		}
		if (l_curlvl > curlvl && mode == 'build') {
				t.requeueQueueElement(bQi);
				return;
		}

		if (mode == 'destruct') {
			var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
			params.cid = currentcityid;
			params.bid = "";
			params.pos = citpos;
			params.lv = curlvl - 1;
			if (curlvl >= 1) {
				params.bid = bid;
			}
			params.type = bdgid;
			new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/destruct.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function(rslt){
					if (rslt.ok) {
						actionLog("Destruyendo " + unsafeWindow.buildingcost['bdg' + bdgid][0] + " en " + cityName);
						Seed.queue_con["city" + currentcityid].push([bdgid, 0, parseInt(rslt.buildingId), unsafeWindow.unixtime(), unsafeWindow.unixtime() + time, 0, time, citpos]);
						if (params.cid == unsafeWindow.currentcityid)
	         					unsafeWindow.update_bdg();
                                                if (document.getElementById('pbHelpRequest').checked == true) 
							t.bot_gethelp(params.bid, currentcityid);
						  t.cancelQueueElement(0, currentcityid, time, false);
					} else {
						var errmsg = unsafeWindow.printLocalError(rslt.error_code || null, rslt.msg || null, rslt.feedback || null);
						t.requeueQueueElement(bQi);
						document.getElementById('pbbuildError').innerHTML = errmsg;
						logit(errmsg);
					}
				},
				onFailure: function(){
					document.getElementById('pbbuildError').innerHTML = "Destroying connection error! Please try again later";
				}
			})
		}
		if (mode == 'build') {
			var invalid = false;
			var chk = unsafeWindow.checkreq("bdg", bdgid, curlvl); //check if all requirements are met
			for (var c = 0; c < chk[3].length; c++) {
				if (chk[3][c] == 0) {
					invalid = true;
				}
			}
			if (invalid == false) {
				var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
				params.cid = currentcityid;
				params.bid = "";
				params.pos = citpos;
				params.lv = curlvl + 1;
				if (params.lv > 9){ //make sure that no level 10+ is built
					t.cancelQueueElement(0, currentcityid, time, false);
					actionLog("Queue elements removed: He tried to build level 10 + building! Please report if this happens!!!");
					return;
				}
				if (params.lv > 1) {
					params.bid = bid;
				}
				params.type = bdgid;
				new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/construct.php" + unsafeWindow.g_ajaxsuffix, {
					method: "post",
					parameters: params,
					onSuccess: function(rslt){
						if (rslt.ok) {
							actionLog("Construyendo " + unsafeWindow.buildingcost['bdg' + bdgid][0] + " Nivel " + params.lv + " en " + cityName);
							Seed.resources["city" + currentcityid].rec1[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][1]) * mult * 3600;
							Seed.resources["city" + currentcityid].rec2[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][2]) * mult * 3600;
							Seed.resources["city" + currentcityid].rec3[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][3]) * mult * 3600;
							Seed.resources["city" + currentcityid].rec4[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][4]) * mult * 3600;
							Seed.citystats["city" + currentcityid].gold[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][5]) * mult;
							Seed.queue_con["city" + currentcityid].push([bdgid, curlvl + 1, parseInt(rslt.buildingId), unsafeWindow.unixtime(),  unsafeWindow.unixtime() + time, 0, time, citpos]);
							if (params.cid == unsafeWindow.currentcityid)
							unsafeWindow.update_bdg();
							if (document.getElementById('pbHelpRequest').checked == true) 
								t.bot_gethelp(params.bid, currentcityid);
								t.cancelQueueElement(0, currentcityid, time, false);							
						} else {
							var errmsg = unsafeWindow.printLocalError(rslt.error_code || null, rslt.msg || null, rslt.feedback || null);
							if (rslt.error_code == 103) { // building has already the target level => just  delete
								t.cancelQueueElement(0, currentcityid, time, false);
								actionLog("Queue elements removed: this level of construction already exists or the construction process has begun!");
							} else {
								t.requeueQueueElement(bQi);
								document.getElementById('pbbuildError').innerHTML = Cities.byID[currentcityid].name +': '+ errmsg + " The Pre was required. Check the number of retries.";
							}
							logit(errmsg);
						}
				},
					onFailure: function(){
						document.getElementById('pbbuildError').innerHTML = "Connection error during construction! Please try again later";
					}
				});
			} else {
				t.requeueQueueElement(bQi); // requeue item if check is invalid
			}
		}
		} else {
			t.cancelQueueElement(0, currentcityid, time, false);
			actionLog("Queue elements removed: no Construction!!!");
		}
	},

	requeueQueueElement: function (bQi) {
	    var t = Tabs.build;
		var cityId = bQi.cityId;
		var buildingPos = parseInt(bQi.buildingPos);
		var buildingId = parseInt(bQi.buildingId);
		var buildingLevel = parseInt(bQi.buildingLevel);
		var buildingType = parseInt(bQi.buildingType);
		var buildingTime = parseInt(bQi.buildingTime);
		var buildingMult = parseInt(bQi.buildingMult);
		var buildingAttempts = parseInt(bQi.buildingAttempts);
		var buildingMode = bQi.buildingMode;

		t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts + 1, buildingMult, buildingMode); // requeue item
		t.cancelQueueElement(0, cityId, buildingTime, false); // delete Queue Item
	},

    show: function(){
		var t = Tabs.build;
    },

    bot_buildslot: function(c, a){
        var t = Tabs.build;
	var cityId = t.getCurrentCityId();
        var buildingPos   = c.id.split("_")[1];
        var buildingType  = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][0]);
        var buildingLevel = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][1]);
	var buildingId    = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][3]);
	if (DEBUG_TRACE) logit("Pos: " + buildingPos + " Type: " + buildingType + " Level: " + buildingLevel + " Id: " + buildingId);
   	var buildingAttempts = 0;
	var loaded_bQ = t["bQ_" + cityId];
	if (typeof Seed.queue_con['city' + cityId][0] != 'undefined') {
		var current_construction_pos = Seed.queue_con['city' + cityId][0][2];
	} else {
		var current_construction_pos = "";
	}
	if (loaded_bQ.length == 0 && current_construction_pos != "" ) { //check anyway if there is currently build in progess for this specific building
	if (current_construction_pos != 'NaN' && current_construction_pos == buildingId) {
		buildingLevel += 1;
	}
	} else {
	if (current_construction_pos != "" && current_construction_pos == buildingId) {
		buildingLevel += 1;
	}
	for (var i = 0; i < loaded_bQ.length; i++) { // check if there are already queue items for this building or the building is currently building
	        var loadedCity = loaded_bQ[i].cityId;
	        var loadedSlot = loaded_bQ[i].buildingPos;
	        if (loadedSlot == buildingPos && loadedCity == cityId) {
		buildingLevel += 1;
	}
	if (loaded_bQ[i].buildingMode == 'destruct' && loadedSlot == buildingPos && loadedCity == cityId) { // check if destrcution is already in queue
		t.modalmessage('Destruccin ya en cola!');
		return;
	  }
	 }
	}
        if (t.currentBuildMode == "build") {
	   if (buildingLevel >= 9) {
                t.modalmessage('Due to the construction requirements (DI), the buildings of level 10 \ must be built manually.');
                return;
            }
                var buildingMode = "build";
	        var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
		var buildingMult = result[0];
		var buildingTime = result[1];
		var queueId = loaded_bQ.length;
		t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
		t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
        }
        if (t.currentBuildMode == "max") {
                var buildingMode = "build";
	        for (var bL = buildingLevel; bL <9; bL++) {
	        var queueId = loaded_bQ.length;
	        var result = t.calculateQueueValues(cityId, bL, buildingType, buildingMode);
		var buildingMult = result[0];
		var buildingTime = result[1];
		queueId = queueId ;
		t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, bL, buildingAttempts, buildingMult, buildingMode);
		t._addTab(queueId, cityId, buildingType, buildingTime, bL, buildingAttempts, buildingMode);
	        }
        }
        if (t.currentBuildMode == "destruct") {
            var buildingMode = "destruct";
			var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
			var buildingMult = result[0];
			var buildingTime = result[1];
			var queueId = loaded_bQ.length;
			t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
			t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
        }

    },


	bot_buildguardian: function(c, a){
        var t = Tabs.build;
		var cityId = t.getCurrentCityId();
        var buildingType  = 50;
		for(i=0; i < Cities.numCities; i++){
			if(Seed.guardian[i].cityId == cityId){
				var buildingLevel = Seed.guardian[i].level;
				break;
			}
		}
		var buildingId    = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][3]);
		if (DEBUG_TRACE) logit("Pos: " + buildingPos + " Tipo: " + buildingType + " Nivel: " + buildingLevel + " Id: " + buildingId);
  		var buildingAttempts = 0;
		var loaded_bQ = t["bQ_" + cityId];
		if (typeof Seed.queue_con['city' + cityId][0] != 'undefined') {
			var current_construction_pos = Seed.queue_con['city' + cityId][0][2];
		} else {
			var current_construction_pos = "";
		}
		if (loaded_bQ.length == 0 && current_construction_pos != "" ) { //check anyway if there is currently build in progess for this specific building
			if (current_construction_pos != 'NaN' && current_construction_pos == buildingId) {
				buildingLevel += 1;
			}
		} else {
			if (current_construction_pos != "" && current_construction_pos == buildingId) {
				buildingLevel += 1;
			}
			for (var i = 0; i < loaded_bQ.length; i++) { // check if there are already queue items for this building or the building is currently building
				var loadedCity = loaded_bQ[i].cityId;
				var loadedSlot = loaded_bQ[i].buildingPos;
				if (loadedSlot == buildingPos && loadedCity == cityId) {
					buildingLevel += 1;
				}
				if (loaded_bQ[i].buildingMode == 'destruct' && loadedSlot == buildingPos && loadedCity == cityId) { // check if destrcution is already in queue
					t.modalmessage('Destruction already in the queue!');
					return;
				}
			}
		}
        if (t.currentBuildMode == "build") {
		    if (buildingLevel >= 9) {
                t.modalmessage('Due to the construction requirement (DI), buildings above the level 9 \ n must be built manually.');
                return;
            }
            var buildingMode = "build";
			var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
			var buildingMult = result[0];
			var buildingTime = result[1];
			var queueId = loaded_bQ.length;
			t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
			t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
        }
        if (t.currentBuildMode == "max") {
            var buildingMode = "build";
			for (var bL = buildingLevel; bL <9; bL++) {
				var queueId = loaded_bQ.length;
				var result = t.calculateQueueValues(cityId, bL, buildingType, buildingMode);
				var buildingMult = result[0];
				var buildingTime = result[1];
				queueId = queueId ;
				t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, bL, buildingAttempts, buildingMult, buildingMode);
				t._addTab(queueId, cityId, buildingType, buildingTime, bL, buildingAttempts, buildingMode);
			}
        }
        if (t.currentBuildMode == "destruct") {
            var buildingMode = "destruct";
			var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
			var buildingMult = result[0];
			var buildingTime = result[1];
			var queueId = loaded_bQ.length;
			t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
			t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
        }

    },
	calculateQueueValues: function (cityId, buildingLevel, buildingType, buildingMode) {
	    var t = Tabs.build;
		var now = unixTime();
		if (buildingMode == 'build') {
			var buildingMult = Math.pow(2, buildingLevel);
        }
		if (buildingMode == 'destruct') {
			var buildingMult = Math.pow(2, buildingLevel - 2);
		}

		var knights = Seed.knights["city" + cityId];
		if (knights) {
			var polKniId = parseInt(Seed.leaders['city' + cityId].politicsKnightId);
			if (polKniId) {
				var polValue = parseInt(Seed.knights['city' + cityId]['knt' + polKniId].politics);
				var polBoost = parseInt(Seed.knights['city' + cityId]['knt' + polKniId].politicsBoostExpireUnixtime);
				if ((polBoost - now) > 0) {
					polValue = parseInt(polValue * 1.25);
				}
			} else {
				polValue = 0;
			}
		} else {
			polValue = 0;
		}
        var buildingTime = unsafeWindow.buildingcost["bdg" + buildingType][7] * buildingMult;
        if (parseInt(buildingType) < 6 && parseInt(buildingType) > 0 && buildingMult == 1) {
            buildingTime = 15;
        }
		if (buildingMode == 'build') {
			buildingTime = parseInt(buildingTime / (1 + 0.005 * polValue + 0.1 * parseInt(Seed.tech.tch16)));
        }
		if (buildingMode == 'destruct') {
			buildingTime = buildingTime / (1 + 0.005 * polValue + 0.1 * parseInt(Seed.tech.tch16));
			if (buildingTime % 1 > 0) {
				buildingTime = parseInt(buildingTime);
			}
		}
		var result = new Array(buildingMult, buildingTime);
		return result;
	},

	bot_gethelp: function (f, currentcityid) {
		var t = Tabs.build;
		var city = t.getCityNameById(currentcityid);
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	        params.bid = f;
	        params.ctrl = 'AskForHelp';
	        params.action = 'getHelpData';
	        new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
	        method: "post",
                parameters: params,
                onSuccess: function (rslt) {
                unsafeWindow.handleHelpCallback (rslt.data);
        },

        onFailure: function (rslt) {
              t.bot_gethelp (f, currentcityid);
              return;
            },
           });
          var a = Seed.queue_con["city" + currentcityid]; 
	  var e = 0;
	  var d = 0;
	  for (var c = 0; c < a.length; c++) {
		if (parseInt(a[c][2]) == parseInt(f)) {
		  e = parseInt(a[c][0]);
		  d = parseInt(a[c][1]);
		  break
		}
	  }
	  var b = new Array();
	  b.push(["REPLACE_LeVeLbUiLdInG", d]);
	  b.push(["REPLACE_BuIlDiNgNaMe", unsafeWindow.buildingcost["bdg" + e][0]]);
	  b.push(["REPLACE_LeVeLiD", d]);
	  b.push(["REPLACE_AsSeTiD", f]);
	  var g = function(h, i) {
		unsafeWindow.continuation_95(h, i);
		if (!h) {
		  var j = d > 1 ? unsafeWindow.cm.SpeedUpType.upgrade : unsafeWindow.cm.SpeedUpType.build;
		  unsafeWindow.cm.ClientSideCookieManager.setCookie(j, false)
		}
	  };
	  unsafeWindow.common_postToProfile("95", unsafeWindow.Object.cloneFeed(unsafeWindow.template_data_95), unsafeWindow.Object.cloneFeed(unsafeWindow.actionlink_data_95), g, b)
	 },

	addQueueItem: function (cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode) {
	var t = Tabs.build;
		var lbQ = t["bQ_" + cityId];
		lbQ.push({
            cityId: 			cityId,
            buildingPos:		buildingPos,
            buildingType: 		buildingType,
			buildingId: 		buildingId,
            buildingTime: 		buildingTime,
            buildingLevel: 		buildingLevel,
            buildingAttempts: 	buildingAttempts,
			buildingMult: 		buildingMult,
            buildingMode: 		buildingMode
        });
		t.modifyTotalTime(cityId, 'increase', buildingTime); //adjust total Time
	},

    modalmessage: function(message){
	    var t = Tabs.build;
        var timeout = 10000;
        var content = "autocerrar despues de 10sec...<br><br>"
        content += message;
        unsafeWindow.Modal.showAlert(content);
        window.setTimeout('unsafeWindow.Modal.hideModal();', timeout);
    },

    modifyTotalTime: function (cityId, type, buildingTime) {
	    var t = Tabs.build;
		var element = document.getElementById('pbbuildcount_' + cityId);
		var currentCount = parseInt(element.innerHTML);
		if (type == "increase") {
			t['totalTime_' + cityId] = t['totalTime_' + cityId] + buildingTime;
			var currentCount = currentCount + 1;
		}
		if (type == "decrease") {
			t['totalTime_' + cityId] = t['totalTime_' + cityId] - buildingTime;
			var currentCount = currentCount - 1;
		}
		element.innerHTML = currentCount;
		document.getElementById('pbbuildtotal_' + cityId).innerHTML = timestr(t['totalTime_' + cityId]);
	},

    hide: function(){
        var t = Tabs.build;
		//unsafeWindow.buildslot = t.koc_buildslot; // restore original koc function
    },

    onUnload: function(){
        var t = Tabs.build;
        for (var i = 0; i < Cities.cities.length; i++) {
            //t["bQ_" + Cities.cities[i].id] = []; //clean up if needed
            if (!ResetAll) GM_setValue('bQ_' + getServerId() + '_' + Cities.cities[i].id, JSON2.stringify((t["bQ_" + Cities.cities[i].id])));
         }
        t.saveBuildStates();
    },
    _addTab: function(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode){
		var t = Tabs.build;
        var row = document.getElementById('pbCityQueueContent').insertRow(0);
        row.vAlign = 'top';
        row.insertCell(0).innerHTML = queueId;
        if (buildingMode == "destruct") {
            row.insertCell(1).innerHTML = '<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/bonus_att.png">';
        }
        else {
            row.insertCell(1).innerHTML = '<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/bonus_prod.png">';
        }
        row.insertCell(2).innerHTML = unsafeWindow.buildingcost['bdg' + buildingType][0];
        row.insertCell(3).innerHTML = timestr(buildingTime);
		if (buildingMode == "destruct") {
			row.insertCell(4).innerHTML = 0;
        } else {
			row.insertCell(4).innerHTML = buildingLevel + 1; // => target Level
		}
		row.insertCell(5).innerHTML = buildingAttempts;
        row.insertCell(6).innerHTML = '<a class="button20" id="queuecancel_' + queueId + '"><span>Cancel</span></a>';
        document.getElementById('queuecancel_' + queueId).addEventListener('click', function(){
            t.cancelQueueElement(queueId, cityId, buildingTime, true);
        }, false);
    },

    cancelQueueElement: function(queueId, cityId, buildingTime, showQueue){
        var t = Tabs.build;
        var queueId = parseInt(queueId);
        t["bQ_" + cityId].splice(queueId, 1);
        t.modifyTotalTime(cityId, 'decrease', buildingTime); //adjust total Time

        if (showQueue == true) {
            t.showBuildQueue(cityId, false);
        }
    },

    showBuildQueue: function(cityId, focus){
	    var t = Tabs.build;
	    clearTimeout (t.timer);
        var popBuildQueue = null;
        var cityName = t.getCityNameById(cityId);
        if (t.popBuildQueue == null) {
            t.popBuildQueue = new CPopup('pbbuild_' + cityId, 0, 0, 350, 500, true, function() {clearTimeout (t.timer);});
        }
        var m = '<DIV style="max-height:560px; height:560px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbTabPad" id="pbCityQueueContent">';
        t.popBuildQueue.getMainDiv().innerHTML = '</table></div>' + m;
        t.popBuildQueue.getTopDiv().innerHTML = '<TD width="200px"><B>Build Queue of ' + cityName + '</b></td><TD><INPUT id=pbOptimizeByTime type=submit value="Optimize by time"></td>';
        t.paintBuildQueue(cityId);
        if (focus)
          t.popBuildQueue.show(true);
		document.getElementById('pbOptimizeByTime').addEventListener('click', function(){t.clearBuildQueue();t.paintBuildQueue(cityId, true);}, false);
		t.timer = setTimeout (function() {t.showBuildQueue(cityId, false)}, 45000);
	},

    paintBuildQueue: function(cityId, optimize){
        var t = Tabs.build;
        var lbQ = t["bQ_" + cityId];
		if (optimize == true) {
			lbQ.sort(function(a,b){return a.buildingTime - b.buildingTime});
		}
		t["bQ_" + cityId] = lbQ;
		for (var i = 0; i < lbQ.length; i++) {
			var queueId = i;
			t._addTab(queueId, lbQ[i].cityId, lbQ[i].buildingType, lbQ[i].buildingTime, lbQ[i].buildingLevel, lbQ[i].buildingAttempts, lbQ[i].buildingMode);
        }
    },

    clearBuildQueue: function() {
	    var t = Tabs.build;
		var table = document.getElementById('pbCityQueueContent');
		var rows = table.rows;
		while(rows.length)
			table.deleteRow(rows.length-1);
	},

    getCurrentCityId: function(){ // TODO maybe move as global function to the core application
        if (!unsafeWindow.currentcityid)
            return null;
        return unsafeWindow.currentcityid;
    },

    saveBuildStates: function(){
		var t = Tabs.build;
        var serverID = getServerId();
        GM_setValue('buildStates_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(t.buildStates));
    },

    readBuildStates: function(){
        var t = Tabs.build;
        var serverID = getServerId();
        s = GM_getValue('buildStates_' + Seed.player['name'] + '_' +serverID);
        if (s != null) {
            states = JSON2.parse(s);
            for (k in states)
                t.buildStates[k] = states[k];
        }
    },

    toggleStateRunning: function(obj){
	var t = Tabs.build;
	obj = document.getElementById('pbBuildRunning');
        if (t.buildStates.running == true) {
            t.buildStates.running = false;
            t.saveBuildStates();
            obj.value = "Auto Build = OFF";
		updatebotbutton('Build-OFF', 'pbbuildtab');
        }else {
            t.buildStates.running = true;
            t.saveBuildStates();
            obj.value = "Auto Build = ON";
		updatebotbutton('Build-ON', 'pbbuildtab');
        }
    },

    toggleStateMode: function(obj){
		var t = Tabs.build;
		obj = document.getElementById('pbBuildMode');
        if (obj.value == 'Modo Build = OFF') {
			unsafeWindow.buildslot = t.bot_buildslot; // overwrite original koc function
            var guardian = document.getElementById('citymap').getElementsByClassName('bldg_guardian_0');
			if(guardian.length >0)
				guardian[0].addEventListener('click', t.bot_buildguardian, false);
			obj.value = "Modo Build = ON";
			updatebotbutton('Const Mode.-ON', 'pbbuildmtab');
        }else {
			unsafeWindow.buildslot = t.koc_buildslot; // restore original koc function
			var guardian = document.getElementById('citymap').getElementsByClassName('bldg_guardian_0');
			if(guardian.length >0)
				guardian[0].removeEventListener('click', t.bot_buildguardian, false);
			obj.value = "Modo Build = OFF";
			updatebotbutton('Const Mode.-OFF', 'pbbuildmtab');
        }
    },

    getCityNameById: function (cityId) {obj = document.getElementById('pbBuildRunning');
    return Cities.byID[cityId].name;
	},
}



/*********************************SEARCH TAB*************************************/

/***
TODO: Better search algorithm (circular OR square, always start at center, working outwards) 
        Should be separate class (producer/consumer) so auto attack can use it too
**/

Tabs.Search = {
  tabOrder : 9,
  tabLabel : 'Search',
  myDiv : null,
  MapAjax : new CMapAjax(),
  MAX_SHOW_WHILE_RUNNING : 250,
  popFirst : true,
  SearchList : [],

  init : function (div){
    var t = Tabs.Search;
    var Provinces = {1:{'name':"Tintagel",'x':75,'y':75},
				2:{'name':"Cornwall",'x':225,'y':75},
				3:{'name':"Astolat",'x':375,'y':75},
				4:{'name':"Lyonesse",'x':525,'y':75},
				5:{'name':"Corbenic",'x':625,'y':75},
				6:{'name':"Paimpont",'x':75,'y':225},
				7:{'name':"Cameliard",'x':225,'y':225},
				8:{'name':"Sarras",'x':375,'y':225},
				9:{'name':"Canoel",'x':525,'y':225},
				10:{'name':"Avalon",'x':675,'y':225},
				11:{'name':"Carmathen",'x':75,'y':375},
				12:{'name':"Shallot",'x':225,'y':375},
				14:{'name':"Cadbury",'x':525,'y':375},
				15:{'name':"Glastonbury",'x':675,'y':375},
				16:{'name':"Camlamn",'x':75,'y':525},
				17:{'name':"Orkney",'x':225,'y':525},
				18:{'name':"Dore",'x':375,'y':525},
				19:{'name':"Logres",'x':525,'y':525},
				20:{'name':"Caerleon",'x':675,'y':525},
				21:{'name':"Parmenie",'x':75,'y':675},
				22:{'name':"Bodmin Moor",'x':225,'y':675},
				23:{'name':"Cellwig",'x':375,'y':675},
				24:{'name':"Listeneise",'x':525,'y':675},
				25:{'name':"Albion",'x':675,'y':675}};
    t.selectedCity = Cities.cities[0];
    t.myDiv = div;
    m = '<DIV class=ptentry><TABLE width=100% class=pbTab><TR><TD class=pbDetLeft>Search for: </td><TD width=99%>';
    m += htmlSelector ({0:"Barb Camp", 1:"Wilderness", 2:"Cities"}, null, 'id=pasrcType'); 
    m += '&nbsp; &nbsp; &nbsp; <span class=pbDetLeft>Search style: &nbsp;';
    m += htmlSelector({square:"square", circle:"circle"}, Options.srcdisttype, 'id=pbsrcdist');
    m += '</span></td></tr><TR><TD class=pbDetLeft>En: </td><TD class=xtab>X=<INPUT id=pasrchX type=text\> &nbsp;Y=<INPUT id=pasrchY type=text\>\
      &nbsp; Radius: <INPUT id=pasrcDist size=3 value=10 /> &nbsp; <SPAN id=paspInXY></span></tr>\
      <TR><TD class=pbDetLeft>O:</td><TD>Search entire province: <select id="provinceXY"><option>--provinces--</option>';
    for (var i in Provinces)
    m += '<option value="'+i+'">'+Provinces[i].name+'</option>';
    m += '</select></td></tr>';
    m += '<TR><TD colspan=2 align=center><INPUT id=pasrcStart type=submit value="start search"/></td></tr>';
    m += '</table></div>\
        <DIV id="pasrcResults" style="height:400px; max-height:400px;"></div>';
    t.myDiv.innerHTML = m;
    var psearch = document.getElementById ("pasrcType");
      new CdispCityPicker ('pasrchdcp', document.getElementById ('paspInXY'), true, t.citySelNotify).bindToXYboxes(document.getElementById ('pasrchX'), document.getElementById ('pasrchY'));
      document.getElementById ('provinceXY').addEventListener ('click', function() {
	  if (this.value >= 1) {	  
		  document.getElementById ('pasrchX').value = Provinces[this.value].x;
		  document.getElementById ('pasrchY').value = Provinces[this.value].y;
		  document.getElementById ('pasrcDist').value = '75';
	  }
	  }, false);
	document.getElementById('pbsrcdist').addEventListener ('change', function (){
      Options.srcdisttype = document.getElementById('pbsrcdist').value;
      saveOptions();
      }, false);
    document.getElementById ('pasrcStart').addEventListener ('click', t.clickedSearch, false);
    document.getElementById ('pasrchX').addEventListener ('keydown', t.e_coordChange, false);
    document.getElementById ('pasrchY').addEventListener ('keydown', t.e_coordChange, false);
    document.getElementById ('pasrcDist').addEventListener ('keydown', t.e_coordChange, false);
    document.getElementById ('pasrchY').addEventListener ('change', t.e_coordChange, false);
    document.getElementById ('pasrchY').addEventListener ('change', t.e_coordChange, false);
    unsafeWindow.pbSearchLookup = t.clickedLookup;  
    unsafeWindow.pbSearchScout = t.clickedScout;  
  },

  e_coordChange : function(){
    document.getElementById ('provinceXY').selectedIndex = 0;
  },

  hide : function (){
  },

  show : function (cont){
  },

  citySelNotify : function (city){
    var t = Tabs.Search;
    t.selectedCity = city;
  },
  
  opt : {},
  selectedCity : null,
  searchRunning : false,
  tilesSearched : 0,
  tilesFound : 0,
  curX : 0,
  curY : 0,
  lastX : 0,
  firstX : 0,
  firstY : 0,
  lastY : 0,

  clickedSearch : function (){
    var t = Tabs.Search;
    if (t.searchRunning){
      t.stopSearch ('SEARCH CANCELLED!');
      return;
    }
    t.opt.searchType = document.getElementById ('pasrcType').value;
    t.opt.startX = parseInt(document.getElementById ('pasrchX').value);
    t.opt.startY = parseInt(document.getElementById ('pasrchY').value);
    t.opt.maxDistance = parseInt(document.getElementById ('pasrcDist').value);
    t.opt.searchShape = Options.srcdisttype;
    errMsg = '';
    if (isNaN (t.opt.startX) ||t.opt.startX<0 || t.opt.startX>749)
      errMsg = "X should be between 0 y 749<BR>";
    if (isNaN (t.opt.startY) ||t.opt.startY<0 || t.opt.startY>749)
      errMsg += "Y should be between 0 y 749<BR>";
    if (isNaN (t.opt.maxDistance) ||t.opt.maxDistance<1 || t.opt.maxDistance>750)
      errMsg += "El Radius (distance) must be between 1 y 750<BR>";
    if (errMsg != ''){
      document.getElementById('pasrcResults').innerHTML = '<FONT COLOR=#660000>ERROR:</font><BR><BR>'+ errMsg;
      return;
    }
    t.searchRunning = true;
    document.getElementById ('pasrcStart').value = 'Stop Search';
    m = '<DIV class=pbStat><TABLE width=100% cellspacing=0><TR><TD class=xtab width=125><DIV id=pastatSearched></div></td>\
        <TD class=xtab align=center><SPAN style="white-space:normal" id=pastatStatus></span></td>\
        <TD class=xtab align=right width=125><DIV id=pastatFound></div></td></tr></table></div>\
          <TABLE width=100%><TR valign=top>\
            <TD width=99% style="max-width:50px"><DIV id=padivOutTab style="height:380px; max-height:380px; overflow-y:auto;"></div></td>\
            <TD align=center valign=middle><A id=pbAhideShow style="text-decoration:none; cursor:pointer;"><DIV style="width:1em; border:1px solid red; padding:10px 2px; background-color:#fee"><SPAN id=spanHideShow> O C U L T A R</span><BR><BR> L<BR>I<BR>S<BR>T<BR><BR><BR> O<BR>P<BR>T<BR>I<BR>O<BR>N<BR>S<BR> </div></a></td>\
            <TD width=100% height=100% style="background:#e0e0f0; height:100%; padding:5px"><DIV id=padivOutOpts></div></td>\
          </table>';    
    document.getElementById('pasrcResults').innerHTML = m;
    if (t.opt.searchType == 0)
      var typeName = 'Barbarians';
    else if (t.opt.searchType == 1)
      var typeName = 'Wildernesses';
	else 
	  var typeName = 'Cities';
    if (t.opt.searchShape == 'square')
      var distName = 'Distance';
    else
      var distName = 'Radius';
	m = '<CENTER><B>Search for '+ typeName +'<BR>\
        Centro: '+ t.opt.startX +','+ t.opt.startY +'  &nbsp; '+ distName +': '+ t.opt.maxDistance +'<BR></center>\
        <DIV class=ptentry><TABLE cellspacing=0 width=100%><TR align=center><TD class=xtab colspan=10><B>LIST OPTIONS:</b><BR></td></tr>';
	if (t.opt.searchType == 1 || t.opt.searchType == 0) {
      m += '<TR><TD class=xtab align=right>Min. level to show:</td><TD class=xtab> <INPUT id=pafilMinLvl size=2 value='+ Options.srcMinLevel +' /></td></tr>\
        <TR><TD class=xtab align=right>Max. level to show:</td><TD class=xtab> <INPUT id=pafilMaxLvl size=2 value='+ Options.srcMaxLevel +' /></td></tr>';
    }
	if (t.opt.searchType == 1){
      m += '<TR><TD class=xtab align=right>Wilderness Type:</td><TD class=xtab><SELECT id=pafilWildType>';
      m += htmlOptions ( {1:'Glassland/Lake', 3:'Woodlands', 4:'Hills', 5:'Mountain', 6:'Plain', 8:'Dark Forest', 0:'ALL'}, Options.wildType );
      m+= '</select></td></tr>';
      m += '</select></td></tr><TR><TD class=xtab align=right>Unowned Only:</td><TD class=xtab><INPUT id=pafilUnowned type=CHECKBOX '+ (Options.unownedOnly?' CHECKED':'') +'\><td></tr>';
    }
    if (t.opt.searchType == 1 || t.opt.searchType == 0) {
	m+= '<TR><TD class=xtab align=right>Sort By:</td><TD class=xtab><SELECT id=pafilSortBy>\
          <OPTION value="level" '+ (Options.srcSortBy=='level'?'SELECTED':'')  +'>level</option>\
          <OPTION value="dist" '+ (Options.srcSortBy=='dist'?'SELECTED':'')  +'>Distance</option>\
        </select></td></tr>\
		<TR><TD class=xtab align=right>Min. might:</td><TD class=xtab><INPUT type=text id=paminmight size=6 value='+ Options.minmight +'>\
		  <TR><TD class=xtab align=right>only coordinates:</td><TD class=xtab><INPUT type=checkbox id=pacoordsOnly \></td></tr>\
		</table></div><BR><SPAN id=pasrchSizeWarn></span><DIV id=pbSrcExp></div>';
    } else {
		m+= '</select></td></tr><TR><TD class=xtab align=right>mist:</td><TD class=xtab><INPUT name=pbfil id=pafilMisted type=CHECKBOX '+ (Options.mistedOnly?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>Hostile:</td><TD class=xtab><INPUT name=pbfil id=pafilHostile type=CHECKBOX '+ (Options.hostileOnly?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>friendly:</td><TD class=xtab><INPUT name=pbfil id=pafilFriendly type=CHECKBOX '+ (Options.friendlyOnly?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>Alliance:</td><TD class=xtab><INPUT name=pbfil id=pafilAllied type=CHECKBOX '+ (Options.alliedOnly?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>Neutral:</td><TD class=xtab><INPUT name=pbfil id=pafilNeutral type=CHECKBOX '+ (Options.neutralOnly?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>Unallianced:</td><TD class=xtab><INPUT name=pbfil id=pafilunAllied type=CHECKBOX '+ (Options.unalliedOnly?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>all:</td><TD class=xtab><INPUT name=pbfil id=pafilAll type=CHECKBOX '+ (Options.srcAll?' CHECKED':'') +'\><td></tr>';
		m+= '<TR><TD class=xtab align=right>Sort by:</td><TD class=xtab><SELECT id=pafilSortBy>\
          <OPTION value="might" '+ (Options.srcSortBy=='might'?'SELECTED':'')  +'>might</option>\
             <OPTION value="dist" '+ (Options.srcSortBy=='dist'?'SELECTED':'')  +'>Distance</option>\
        </select></td></tr>\
        <TR><TD class=xtab align=right>only coordinates</td><TD class=xtab><INPUT type=checkbox id=pacoordsOnly \></td></tr>\
        </table></div><BR><SPAN id=pasrchSizeWarn></span><DIV id=pbSrcExp></div>';
	}
    document.getElementById('padivOutOpts').innerHTML = m;
    if (t.opt.searchType == 1 || t.opt.searchType == 0) {
		document.getElementById('pafilMinLvl').addEventListener ('change', function (){
      Options.srcMinLevel = document.getElementById('pafilMinLvl').value;
      saveOptions();
      t.dispMapTable ();
      }, false);
	  	document.getElementById('paminmight').addEventListener ('change', function (){
        Options.minmight = parseIntNan(document.getElementById('paminmight').value);
        saveOptions();
        t.dispMapTable ();
        }, false);
      document.getElementById('pafilMaxLvl').addEventListener ('change', function (){
      Options.srcMaxLevel = document.getElementById('pafilMaxLvl').value;
      saveOptions();
      t.dispMapTable ();
      }, false);
    }
      document.getElementById('pafilSortBy').addEventListener ('change', function (){
      Options.srcSortBy = document.getElementById('pafilSortBy').value;
      saveOptions();
      t.dispMapTable ();
      }, false);
    document.getElementById('pacoordsOnly').addEventListener ('change', function (){ t.dispMapTable (); }, false);
    if (t.opt.searchType == 1){
      document.getElementById('pafilWildType').addEventListener ('change', function (){
        Options.wildType = document.getElementById('pafilWildType').value;
        saveOptions();
        t.dispMapTable ();
        }, false);
      document.getElementById('pafilUnowned').addEventListener ('change', function (){
        Options.unownedOnly = (document.getElementById('pafilUnowned').checked);
        saveOptions();
        t.dispMapTable ();
        }, false);
    }
	if (t.opt.searchType == 2){
		document.getElementById('pafilMisted').addEventListener ('change', function (){
        Options.mistedOnly = (document.getElementById('pafilMisted').checked);
		if(!Options.mistedOnly){
			document.getElementById('pafilAll').checked = false;
			Options.srcAll = Options.mistedOnly;
		}
        saveOptions();
        t.dispMapTable ();
        }, false);
		document.getElementById('pafilHostile').addEventListener ('change', function (){
        Options.hostileOnly = (document.getElementById('pafilHostile').checked);
		if(!Options.hostileOnly){
			document.getElementById('pafilAll').checked = false;
		Options.srcAll = Options.hostileOnly;
		}
        saveOptions();
        t.dispMapTable ();
        }, false);
		document.getElementById('pafilFriendly').addEventListener ('change', function (){
        Options.friendlyOnly = (document.getElementById('pafilFriendly').checked);
		if(!Options.friendlyOnly){
			document.getElementById('pafilAll').checked = false;
			Options.srcAll = Options.friendlyOnly;
		}
        saveOptions();
        t.dispMapTable ();
        }, false);
		document.getElementById('pafilAllied').addEventListener ('change', function (){
        Options.alliedOnly = (document.getElementById('pafilAllied').checked);
		if(!Options.alliedOnly){
			document.getElementById('pafilAll').checked = false;
			Options.srcAll = Options.alliedOnly;
		}
        saveOptions();
        t.dispMapTable ();
        }, false);
		document.getElementById('pafilNeutral').addEventListener ('change', function (){
        Options.neutralOnly = (document.getElementById('pafilNeutral').checked);
		if(!Options.neutralOnly){
			document.getElementById('pafilAll').checked = false;
			Options.srcAll = Options.neutralOnly;
		}
        saveOptions();
        t.dispMapTable ();
        }, false);
		document.getElementById('pafilunAllied').addEventListener ('change', function (){
        Options.unalliedOnly = (document.getElementById('pafilunAllied').checked);
		if(!Options.unalliedOnly){
			document.getElementById('pafilAll').checked = false;
			Options.srcAll = Options.unalliedOnly;
		}
        saveOptions();
        t.dispMapTable ();
        }, false);
		document.getElementById('pafilAll').addEventListener ('change', function (){
        Options.srcAll = (document.getElementById('pafilAll').checked);
		for(i in document.getElementsByName('pbfil'))
			document.getElementsByName('pbfil')[i].checked = Options.srcAll;
		Options.mistedOnly=Options.hostileOnly=Options.friendlyOnly=Options.alliedOnly=Options.neutralOnly=Options.unalliedOnly=Options.srcAll;
        saveOptions();
        t.dispMapTable ();
       }, false);
    }
    document.getElementById('pbAhideShow').addEventListener ('click', t.hideShowClicked, false);
    t.mapDat = [];
    t.firstX =  t.opt.startX - t.opt.maxDistance;
    t.lastX = t.opt.startX + t.opt.maxDistance;
    t.firstY =  t.opt.startY - t.opt.maxDistance;
    t.lastY = t.opt.startY + t.opt.maxDistance;
    t.tilesSearched = 0;
    t.tilesFound = 0;
    t.curX = t.firstX;
    t.curY = t.firstY;
    var xxx = t.MapAjax.normalize(t.curX);
    var yyy = t.MapAjax.normalize(t.curY);
    document.getElementById ('pastatStatus').innerHTML = 'seeking'+ xxx +','+ yyy;
    setTimeout (function(){t.MapAjax.request (xxx, yyy, 15, t.eventgetplayeronline)}, MAP_DELAY);
  },

  hideShowClicked : function (){
    var div = document.getElementById('padivOutOpts');
    if (div.style.display == 'none'){
      div.style.display = 'block';
      document.getElementById('spanHideShow').innerHTML = 'H I D E';
    } else {
      div.style.display = 'none';
      document.getElementById('spanHideShow').innerHTML = 'S H O W';
    }
  },
  
  dispMapTable : function (){
    var tileNames = ['Barb Camp', 'Grassland', 'Lake', 'Woodlands', 'Hills', 'Mountain', 'Plain', null, 'Dark Forest' ];
    var t = Tabs.Search;
    var coordsOnly = document.getElementById('pacoordsOnly').checked;
if (DEBUG_SEARCH) DebugTimer.start();
    function mySort(a, b){
      if (Options.srcSortBy == 'level'){
        if ((x = a[4] - b[4]) != 0)
          return x;
      }
	  if (Options.srcSortBy == 'might'){
        if ((x = b[10] - a[10]) != 0)
          return x;
      }     
	  return a[2] - b[2];
    }
    dat = [];
    for (i=0; i<t.mapDat.length; i++){
      lvl = parseInt (t.mapDat[i][4]);
      type = t.mapDat[i][3];
	  if (t.opt.searchType==2 && type==7 ) {
	   if(t.mapDat[i][10] >= Options.minmight || t.mapDat[i][5])
		if((Options.hostileOnly && t.mapDat[i][12] == 'h') || 
		   (Options.mistedOnly && t.mapDat[i][5]===true) || 
		   (Options.friendlyOnly && t.mapDat[i][12] == 'f') || 
		   (Options.alliedOnly && t.mapDat[i][12] == 'a') ||
		   (Options.neutralOnly && t.mapDat[i][12] == 'n') ||
		   (Options.unalliedOnly && t.mapDat[i][12] == 'u') ||
		   (Options.srcAll))
			dat.push(t.mapDat[i]);
	  } else {     
	  if (lvl>=Options.srcMinLevel && lvl<=Options.srcMaxLevel){
        if (t.opt.searchType==0 || Options.wildType==0
        ||  (Options.wildType==1 && (type==1 || type==2))
        ||  (Options.wildType == type)){
          if (!Options.unownedOnly || t.mapDat[i][5]===false)
            dat.push (t.mapDat[i]);
        }
      }
    }
    }
   if (DEBUG_SEARCH) DebugTimer.display('SEACHdraw: FILTER');
    document.getElementById('pastatFound').innerHTML = 'found: '+ dat.length;
    if (dat.length == 0){
      m = '<BR><CENTER>Searching map...</center>';
    } else {
      dat.sort(mySort);
   if (DEBUG_SEARCH) DebugTimer.display('SEACHdraw: SORT');
      if (coordsOnly)
        m = '<TABLE align=center id=pasrcOutTab cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>location</td></tr>';
      else {
      if (t.opt.searchType == 2) {
 			m = '<TABLE id=pasrcOutTab class=pbSrchResults cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>location</td><TD align=right>distance</td><TD>player</td><TD align=right>might</td><TD>alliance</td><TD>rank</td><TD></td></tr>';
		} else { 
			m = '<TABLE id=pasrcOutTab cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>location</td><TD style="padding-left: 10px">distance</td><TD style="padding-left: 10px;">level</td><TD width=80%> &nbsp; type</td><TD style=""></td></tr>';
		}
	}
      var numRows = dat.length;
        if (numRows > t.MAX_SHOW_WHILE_RUNNING && t.searchRunning){
        numRows = t.MAX_SHOW_WHILE_RUNNING;
        document.getElementById('pasrchSizeWarn').innerHTML = '<FONT COLOR=#600000>NOTE: Table shows only '+ t.MAX_SHOW_WHILE_RUNNING +' of '+ dat.length +' results until the search is completed .</font>';
       }
      for (i=0; i<numRows; i++){
        m += '<TR><TD><DIV onclick="pbGotoMap('+ dat[i][0] +','+ dat[i][1] +')"><A>'+ dat[i][0] +','+ dat[i][1] +'</a></div></td>';
        if (coordsOnly) {
          m += '</tr>';
        } else {
          if (t.opt.searchType == 2) { // city search
            m += '<TD align="right" >'+ dat[i][2].toFixed(2) +'</td>';
            if (dat[i][5])
              m += '<TD colspan=4>* mist * &nbsp; &nbsp; <SPAN onclick="pbSearchScout('+ dat[i][0] +','+ dat[i][1] +');return false;"><A>Explorar</a></span></td></tr>';
         else {
              var allStyle = '';
              if (dat[i][12]=='f')
                allStyle = 'class=pbTextFriendly';
              else if (dat[i][12]=='h')
                allStyle = 'class=pbTextHostile';
              m += '<TD>'+ dat[i][9]+'</td><TD align=right>'+ dat[i][10] +'</td><TD><SPAN '+ allStyle +'>'+ dat[i][11]+'</span></td><TD>'+(dat[i][13]?'<SPAN class=boldDarkRed>on-line</span>':'')+'</td><TD><A onclick="pbSearchLookup('+ dat[i][7] +')">search</a></td></tr>';
			 }
			} else { 
          m += '<TD align=right  valign="top">'+ dat[i][2].toFixed(2) +' &nbsp; </td><TD align=right>'+ dat[i][4] +'</td><TD> &nbsp; '+ tileNames[dat[i][3]]
            +'</td><TD  valign="top">'+ (dat[i][5]?(dat[i][6]!=0?' <A onclick="pbSearchLookup('+dat[i][6]+')">OWNER</a>':'<A onclick="pbSearchScout('+ dat[i][0] +','+ dat[i][1] +');return false;">mist</a>'):'') +'</td></tr>';
			}
		}
	
       }
      m += '</table>';
    }
    document.getElementById('padivOutTab').innerHTML = m;
    dat = null;
if (DEBUG_SEARCH) DebugTimer.display('SEACHdraw: DRAW');
  },

  mapDat : [],

  stopSearch : function (msg){
    var t = Tabs.Search;
    document.getElementById ('pastatStatus').innerHTML = '<FONT color=#ffaaaa>'+ msg +'</font>';
    document.getElementById ('pasrcStart').value = 'start search';
    document.getElementById ('pasrchSizeWarn').innerHTML = '';
    if (t.opt.searchType==0 && document.getElementById('KOCAttackToggle')!=null){    
      document.getElementById ('pbSrcExp').innerHTML = '<CENTER>'+ strButton20('Exportar Resultados', 'id=pbSrcDoExp') +'</center><TR><TD>NOTE: With the export button, you can as the name says send the coordinates located in the search box to auto attack. This system only works with the KOCAttack - Extra Features created by "niknah. To export just follow his steps and coordinates with the data of troops in the next window configure it, then you just have to activate the autoataques".</td></tr>';
      document.getElementById ('pbSrcDoExp').addEventListener ('click', t.exportKOCattack, false);
    }
	if (t.opt.searchType==2){
	  document.getElementById ('pbSrcExp').innerHTML = '<CENTER>'+ strButton20('Generate scan list', 'id=pbSrcDoScout') +'</center>'; 
      document.getElementById ('pbSrcDoScout').addEventListener ('click', t.generateScoutList, false);
	}
	t.searchRunning = false;
    t.dispMapTable();
  },

  exportKOCattack : function (){
    var t = Tabs.Search;
    var bulkAdds = {};
    for (i=1; i<11; i++)
      bulkAdds['lvl'+ i] = [];
    for (i=0; i<t.mapDat.length; i++){
      var lvl = parseInt (t.mapDat[i][4]);
      if (lvl>=Options.srcMinLevel && lvl<=Options.srcMaxLevel && t.mapDat[i][3]==0)
        bulkAdds['lvl'+ lvl].push({x:t.mapDat[i][0], y:t.mapDat[i][1]});
    }
    exportToKOCattack.doExport (bulkAdds, t.selectedCity);
  },  
    
  generateScoutList : function (){
    var t = Tabs.Search;
    var bulkScout = [];
    for (i=0; i<t.mapDat.length; i++){
      if (t.mapDat[i][3] == 7){
		if(t.mapDat[i][10] >= Options.minmight || t.mapDat[i][5]){
		if((Options.hostileOnly && t.mapDat[i][12] == 'h') || 
		   (Options.mistedOnly && t.mapDat[i][5]===true) || 
		   (Options.friendlyOnly && t.mapDat[i][12] == 'f') || 
		   (Options.alliedOnly && t.mapDat[i][12] == 'a') ||
		   (Options.neutralOnly && t.mapDat[i][12] == 'n') ||
		   (Options.unalliedOnly && t.mapDat[i][12] == 'u') ||
		   (Options.srcAll))
        bulkScout.push({x:t.mapDat[i][0], y:t.mapDat[i][1], dist:t.mapDat[i][2]});
	    }
	}
   }
    if(t.selectedCity == null)
    t.selectedCity = Cities.cities[0];
    t.ShowScoutList (bulkScout, t.selectedCity);
  },

  ShowScoutList : function (coordlist, city){
	var t = Tabs.Search;
	var popScout = null;
	t.scoutcity = city;
	if(popScout==null){
	popScout = new CPopup ('pbsrcscout', 0,0, 350,500, true, function (){popScout.destroy(); popScout=null;});
        popScout.centerMe (mainPop.getMainDiv());  
    }
	var m = '<DIV class=pbStat>Options for self exploration</div>';
		m += '<DIV>Cantidad de Exploradores a enviar: <input id=pbsrcScoutAmt value="'+Options.srcScoutAmt+'" /></div><BR>';
		m += '<DIV>select City: <span id=pbsrcScoutcitypick> </span></div><BR>';
		m += '<DIV class=pbStat>explorers from<span id=pbsrcScoutcity>'+city.name+'</span> <BR> objectives total '+coordlist.length+'</div>';
		m += '<DIV style="max-height:220px; overflow-y:auto;"><TABLE align=center cellpadding=0 cellspacing=0 class=pbTabPadNW><TR style="font-weight:bold; background-color:white"><TD width=15><input type=checkbox id=pbsrcScout_All /></td><TD>coordinates Objectives</td></tr>';
	  for(i=0; i<coordlist.length; i++){
		m += '<TR style="background-color:white"><TD><input type=checkbox name=pbsrcScoutCheck id="pbsrcScoutCheck_'+coordlist[i].x+'_'+coordlist[i].y+'" value="'+coordlist[i].x+'_'+coordlist[i].y+'" /></td><TD>'+coordLink(coordlist[i].x,coordlist[i].y)+'</td></tr>';
	  }
	        m += '</table></div>';
		m += '<BR><CENTER>'+ strButton20('start Navigation', 'id=pbSrcStartScout') +'</center>';
		m += '<CENTER><DIV style="width:70%; max-height:75px; overflow-y:auto;" id=pbSrcScoutResult></DIV></center>'; 
	popScout.getMainDiv().innerHTML = m;
	new CdispCityPicker ('pbScoutPick', document.getElementById('pbsrcScoutcitypick'), false, function(c,x,y){document.getElementById('pbsrcScoutcity').innerHTML = c.name; t.scoutcity = c; }, city.idx);
	popScout.getTopDiv().innerHTML = '<div class=showBadged><center>Lista de exploracin de PowerKoc</center></div>';
	popScout.show(true);
	document.getElementById('pbsrcScoutAmt').addEventListener('change', function(){
	Options.srcScoutAmt = parseInt(document.getElementById('pbsrcScoutAmt').value);
	saveOptions();
	}, false);
	document.getElementById('pbsrcScout_All').addEventListener('change', function(){
	for(k in document.getElementsByName('pbsrcScoutCheck'))
	document.getElementsByName('pbsrcScoutCheck')[k].checked = document.getElementById('pbsrcScout_All').checked;
	}, false);
	document.getElementById('pbSrcStartScout').addEventListener('click', t.clickedStartScout, false);
  },
  scouting : false,
  scoutcity : null,

  doScout : function(list, city){
	var t = Tabs.Search;
	document.getElementById('pbSrcScoutResult').innerHTML = '';
	if(list.length < 1){
		document.getElementById('pbSrcScoutResult').innerHTML = '<SPAN class=boldRed>ERROR: No coordinates selected</span>';
		t.clickedStartScout();
		return;
	}
	if(parseInt(Seed.units['city'+city.id]['unt'+3]) < Options.srcScoutAmt){
		document.getElementById('pbSrcScoutResult').innerHTML = '<SPAN class=boldRed>ERROR: There are no browsers available</span>';
		t.clickedStartScout();
		return;
	}
	t.doScoutCount(list, city, list.length, 0);
  },

  doScoutCount : function(list, city, total, count){
	var t = Tabs.Search;
	if(!t.scouting){
		document.getElementById('pbSrcScoutResult').innerHTML += '<SPAN class=boldRed>exploration by the user stops</span><BR>';
		document.getElementById('pbSrcStartScout').className = 'button20 ptButton20';
		document.getElementById('pbSrcStartScout').innerHTML = '<SPAN>start Navigation</span>';
		return;
	}
	if(total <= (count)){
		document.getElementById('pbSrcScoutResult').innerHTML += 'done!<BR>';
		t.clickedStartScout();
		return;
	}
	var rallypointlevel = t.getRallypoint(city.id);
        if(rallypointlevel == 12) rallypointlevel = 11;
	var slots = 0;
	for (z in Seed.queue_atkp['city'+city.id]){
         slots++;
       }
       if  (Seed.queue_atkp['city'+city.id].toSource() == "[]") slots=0;

	if(slots >= rallypointlevel){
		setTimeout(function(){t.doScoutCount(list, city, total, count)}, 5000);
		document.getElementById('pbSrcScoutResult').innerHTML += 'Waiting for rally point to clear...';
		return;
	}
	var coords = list[count].split("_");
	if(coords[0] == 'undefined' || coords[1] == 'undefined'){
		document.getElementById('pbSrcScoutResult').innerHTML += '<SPAN class=boldRed>ERROR: Coordinates are not valid</span>';
		t.clickedStartScout();
		return;
	}
	document.getElementById('pbSrcScoutResult').innerHTML += 'Sending exploration to '+coords[0]+','+coords[1]+'...';
	document.getElementById('pbsrcScoutCheck_'+coords[0]+'_'+coords[1]).checked = false;
	t.sendScout(coords[0], coords[1], city, count, function(c){t.doScoutCount(list, city, total, c)});
  },

  sendScout : function(x, y, city, count, notify){
	var t = Tabs.Search;
	count = parseInt(count);
	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = city.id;
	params.kid = 0;
	params.type = 3;
	params.xcoord = x;
	params.ycoord = y;
	params.u3 = Options.srcScoutAmt;
	new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
		 method: "post",
		 parameters: params,
		 loading: true,
		 onSuccess: function (rslt) {
		 rslt = eval("(" + rslt.responseText + ")");
		 if (rslt.ok) {
			 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
			 var ut = unixTime();
			 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 for(i = 0; i <= unitsarr.length; i++){
				if(params["u"+i]){
				unitsarr[i] = params["u"+i];
				}
			 }
			 var currentcityid = params.cid;
			 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
			 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
			 document.getElementById('pbSrcScoutResult').innerHTML += 'Sent!<BR>';
			 if (notify)
			  setTimeout(function(){ notify(count+1); }, 1000);
		 } else {
			 document.getElementById('pbSrcScoutResult').innerHTML += 'Failure! retrying....<BR>';
			 if (notify)
			  setTimeout(function(){ notify(count); }, 1000);
		  }
		},
		onFailure: function () {}
  		});
  },

  getRallypoint: function(cityId){
      var t = Tabs.Search;
	  cityId = 'city'+cityId;
      for (o in Seed.buildings[cityId]){
		var buildingType = parseInt(Seed.buildings[cityId][o][0]);
		var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
		if (buildingType == 12){
			return parseInt(buildingLevel);
			break;
		}
	   }
	  return 0;
    },
	clickedStartScout : function(){
	var t = Tabs.Search;
		if(t.scouting == false){
			t.scouting = true;
			var ScoutList = [];
			for(k=0; k<document.getElementsByName('pbsrcScoutCheck').length; k++){
				if(document.getElementsByName('pbsrcScoutCheck')[k].checked){
					ScoutList.push(document.getElementsByName('pbsrcScoutCheck')[k].value);
				}
			}
			t.doScout(ScoutList, t.scoutcity);
			document.getElementById('pbSrcStartScout').className = 'button20 pbButCancel';
			document.getElementById('pbSrcStartScout').innerHTML = '<SPAN>Parar</span>';
		} else {
			t.scouting = false;
			document.getElementById('pbSrcStartScout').className = 'button20 ptButton20';
			document.getElementById('pbSrcStartScout').innerHTML = '<SPAN>start Navigation</span>';
		}
	},
 
  mapCallback : function (uList){
    var t = Tabs.Search;
    var rslt = t.SearchList;
    map = rslt.data;
	var Dip = Seed.allianceDiplomacies;	
	var userInfo = rslt.userInfo;
    var alliance = rslt.allianceNames;
    for (k in map){
      if (t.opt.searchType==0 && map[k].tileType==51 && !map[k].tileCityId ) {  // if barb
        type = 0;
      } else if (t.opt.searchType==1 && map[k].tileType>=10 &&  map[k].tileType<=50) { // if wild
        if (map[k].tileType == 10)
          type = 1;
        else if (map[k].tileType == 11)
          type = 2;
        else
          type = (map[k].tileType/10) + 1;
      } else if (t.opt.searchType==1 && map[k].tileType==54) {
		    type = 8;
      } else if (t.opt.searchType==2 && map[k].tileCityId >= 0 && map[k].tileType > 50 && map[k].cityName) {
		  type = 7;     
	  } else
            continue;
      var dist = distance (t.opt.startX, t.opt.startY, map[k].xCoord, map[k].yCoord);
      if ((t.opt.searchShape=='circle' && dist <= t.opt.maxDistance)
      ||  (t.opt.searchShape=='square' && map[k].xCoord>=t.firstX && map[k].xCoord<=t.lastX && map[k].yCoord>=t.firstY && map[k].yCoord<=t.lastY)){
	  	  if (t.opt.searchType==2) {    // if city search
			var isMisted = map[k].tileUserId == 0 || false;		
			var uu = 'u'+map[k].tileUserId;
			var aD = '';
				var nameU = '';
				var mightU = ''; 
				var aU = '';
				if (!isMisted && userInfo[uu]) {
    				nameU = userInfo[uu].n;   // can error, must check if (userInfo[uu])
    				mightU = userInfo[uu].m;
				if (alliance['a'+userInfo[uu].a])
					aU = alliance['a'+userInfo[uu].a];
   				else
   				  aU = '----';
    				aD = '';
    				if (Dip.friendly && Dip.friendly['a'+userInfo[uu].a]) aD = 'f';
    				if (Dip.hostile && Dip.hostile['a'+userInfo[uu].a]) aD = 'h';
					if (Dip.allianceId && Dip.allianceId==userInfo[uu].a) aD = 'a';
					if (getDiplomacy(userInfo[uu].a) == 'neutral') aD = 'n';
					if (!userInfo[uu].a || userInfo[uu].a==0) aD = 'u';
					if (Dip.allianceId && Dip.allianceId==userInfo[uu].a) aD = 'a';
					if (getDiplomacy(userInfo[uu].a) == 'neutral') aD = 'n';
					if (!userInfo[uu].a || userInfo[uu].a==0) aD = 'u';
 			}
// TODO: save memory, remove city name ?   	
				t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isMisted, map[k].tileCityId, map[k].tileUserId, map[k].cityName, nameU, mightU, aU, aD, uList.data[map[k].tileUserId]?1:0]);
				} else {      
		isOwned = map[k].tileUserId>0 || map[k].misted;
        t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isOwned, (map[k].tileUserId>0? map[k].tileUserId : 0), uList.data[map[k].tileUserId]?1:0]);
         }       
		++t.tilesFound;
      }
    }
    t.tilesSearched += (15*15);
    document.getElementById('pastatSearched').innerHTML = 'searched: '+ t.tilesSearched;
    t.dispMapTable();
    t.curX += 15;
    if (t.curX > t.lastX){
      t.curX = t.firstX;
      t.curY += 15;
      if (t.curY > t.lastY){
        t.stopSearch ('done!');
        return;
      }
    }
    var x = t.MapAjax.normalize(t.curX);
    var y = t.MapAjax.normalize(t.curY);
    document.getElementById ('pastatStatus').innerHTML = 'seeking '+ x +','+ y;
    setTimeout (function(){t.MapAjax.request (x, y, 15, t.eventgetplayeronline)}, MAP_DELAY);
  },
  
  eventgetplayeronline : function (left, top, width, rslt){
	var t = Tabs.Search;
    if (!t.searchRunning)
      return;
    if (!rslt.ok){
      t.stopSearch ('ERROR: '+ rslt.errorMsg);
      return;
    }
    map = rslt.data;
    t.SearchList = rslt;
    var uList = [];
    for(k in map){
	if(map[k].tileUserId != null)
	   uList.push(map[k].tileUserId);
	}
	t.fetchPlayerStatus (uList, function(r){ t.mapCallback(r)});
  },

  clickedScout : function (x, y){
    unsafeWindow.modal_attack (3, x, y);
    CwaitForElement ('modal_attack', 5000, function (){document.getElementById('modalBox1').style.zIndex='112000'});
  },
    
  clickedLookup : function (pid){
    var t = Tabs.Search;
    var pop = new CPopup ('pbsrclookup', 0,0, 500,500, true);
    if (t.popFirst){
      pop.centerMe (mainPop.getMainDiv());  
      t.popFirst = false;
    }
    pop.getTopDiv().innerHTML = '<div class=showBadged><center>PLAYER SEARCH</center></div>';
    pop.getMainDiv().innerHTML = '<DIV class=pbStat>Information Ranking</div><SPAN id=pblupLB>Looking classification..</span>\
      <BR><DIV class=pbStat>seeking Alliance</div><SPAN id=pblupAI>Viewing Information Alliance...</span>';
    pop.show (true);
    t.fetchLeaderboard (pid, function (r){t.gotPlayerLeaderboard(r, document.getElementById('pblupLB'))});
    t.fetchPlayerInfo (pid, function (r){t.gotPlayerInfo(r, document.getElementById('pblupAI'))});
  },

  gotPlayerLeaderboard : function (rslt, span){
    var t = Tabs.Search;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = '<B>Clasificacin:</b> not Found! (mist?)<BR><BR>';
      return;
    }
    var p = rslt.results[0];
    var x;
    var name = '';
    if (p.playerSex == 'M')
      name = 'Lord ';
    else if (p.playerSex == 'F')
      name = 'Lady ';   
    name += p.displayName;      
    if ((x = officerId2String(p.officerType)) != '')  
      name += ' ('+ x + ')';  
    var aName = p.allianceName;
    if (!aName || aName=='')
      aName = 'none';
    var m = '<CENTER><SPAN class=boldRed>NOTE: The information qualifier can be up 24 hours ago</span></center><TABLE class=pbTabSome>';
    m += '<TR><TD class=pbDetLeft>player:</td><TD>'+ name +'</td></tr>\
      <TR><TD class=pbDetLeft>might:</td><TD>'+ p.might +' (rank #'+ p.rank +')</td></tr>\
      <TR><TD class=pbDetLeft>Aliance:</td><TD>'+ aName +' ('+ getDiplomacy(p.allianceId) +')</td></tr>\
      <TR valign=top><TD class=pbDetLeft>cities:</td><TD><TABLE class=pbTabSome><TR style="font-weight:bold"><TD>City name</td><TD>coordinates</td><TD>level</td><TD>status</td><TD>created</td></tr>';
    for (var i=0; i<p.cities.length; i++){
      var c = p.cities[i];
      var created = '';
      if (c.dateCreated && c.dateCreated.substr(0,2)=='20')
        created = c.dateCreated.substr(0,10);
      m += '<TR><TD>'+ c.cityName +'</td><TD>'+ coordLink(c.xCoord, c.yCoord) +'</td><TD align=center>'+ c.tileLevel +'</td>\
          <TD>'+ cityStatusString (c.cityStatus) +'</td><TD>'+ creada +'</td></tr>';
    }    
    m += '</table></td></tr></table>';
    span.innerHTML = m;
  },

  gotPlayerInfo : function (rslt, span){
    var t = Tabs.Search;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<TABLE class=pbTabSome>';
    var p = rslt.userInfo[0];
    var pids = p.provinceIds.split (',');
    var prov = [];
    for (var i=0; i<pids.length; i++)
      prov.push(unsafeWindow.provincenames['p'+pids[i]]);
    m += '<TR><TD class=pbDetLeft>player:</td><TD>'+ p.genderAndName +'</td></tr>\
      <TR><TD class=pbDetLeft>might:</td><TD>'+ p.might +'</td></tr>\
      <TR><TD class=pbDetLeft>Facebook profile:</td><TD><A target="_tab" href="http://www.facebook.com/profile.php?id='+ p.fbuid +'">Open in new window</a></td></tr>\
      <TR><TD class=pbDetLeft>Aliance:</td><TD>'+ p.allianceName +' ('+ getDiplomacy(p.allianceId) +')</td></tr>\
      <TR valign=top><TD class=pbDetLeft>Province:</td><TD style="white-space:normal">'+ prov.join(', ') +'</td></tr>';
    span.innerHTML = m + '</table>';
  },
      
  fetchPlayerInfo : function (uid, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.uid = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserGeneralInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
    });
  },

  fetchLeaderboard : function (uid, notify) {
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.userId = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify (rslt);
      },
    });
  },

    fetchPlayerStatus : function (uidArray, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.checkArr = uidArray.join(',');
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
};   // end Search tab


/******** Export to KOC Attack **********/  

var exportToKOCattack = {
  troops : {},  
  init : function (){
    var t = exportToKOCattack;
    for (var b=1; b<11; b++){
      t.troops['b'+ b] = [];
      for (var trp=0; trp<12; trp++){
        t.troops['b'+ b][trp] = 0;
      }
    }
    var s = GM_getValue ('atkTroops_'+ getServerId(), null);
    if (s != null){
      var trp = JSON2.parse(s);
      for (var b=1; b<11; b++){
        if (trp['b'+ b] && trp['b'+ b].length == 12)
          t.troops['b'+ b] = trp['b'+ b];
      }
    }
    window.addEventListener('unload', t.onUnload, false);
  },
  
  onUnload : function (){
    var t = exportToKOCattack;
    if (!ResetAll) GM_setValue ('atkTroops_'+ getServerId(),  JSON2.stringify(t.troops));
  },
  
  doExport : function (coordList, city){
    var t = exportToKOCattack;
    var popExp = null;
    var cList = coordList;
    var curLevel = 0;
    var city = city;
    var troopDef = [
      ['STroop', 1],
      ['Wagon', 9],
      ['Archers', 6],
      ['Cavalry', 7],
      ['Heavies', 8],
      ['Ballista', 10],
    ];
    if (popExp == null){
      popExp = new CPopup ('pbsrcexp', 0,0, 625,600, true, function (){popExp.destroy(); popExp=null;});
      popExp.centerMe (mainPop.getMainDiv());  
    }
    var m = '<DIV class=pbStat>Export data to KOC Attack</div><BR><TABLE align=center cellpadding=0 cellspacing=0 class=pbTabPadNW>\
      <TR style="font-weight:bold; background-color:white"><TD>Target Type</td><TD style="padding:1px" align=center>#<BR>targets</td><TD width=15></td>';
    for (var i=0; i<troopDef.length; i++)
      m += '<TD>'+ troopDef[i][0] +'</td>';
    m += '</tr>';
    for (var b=1; b<11; b++){
      m += '<TR><TD>Barb level '+ b +'</td><TD align=right>'+ coordList['lvl'+b].length  +'&nbsp; &nbsp;</td><TD></td>';
      for (var td=0; td<troopDef.length; td++)
        m += '<TD><INPUT id=ptET_'+ b +'_'+ troopDef[td][1] +' type=text size=3 value="'+ t.troops['b'+ b][troopDef[td][1]-1] +'"></td>';
      m += '<TD width=90%><SPAN class=boldRed id=ptETerr_'+ b +'></span></tr>';
    }
    m += '</table>';
    var isKOCattack = !(document.getElementById('KOCAttackToggle') == null);
    if (isKOCattack){
      m += '<BR><CENTER>'+ strButton20('Bulk Add to KOC Attack', 'id=pbSrcDoBA') +'</center>';
    } else {
      m += 'Attack KOC is not running, unable to export coordinates';
    }
    m += '<CENTER><DIV style="width:70%" id=pbSrcExpResult></DIV></center>';
    popExp.getMainDiv().innerHTML =  m;
    for (var b=1; b<11; b++)
      for (var td=0; td<troopDef.length; td++)
        document.getElementById('ptET_'+ b +'_'+ troopDef[td][1]).addEventListener ('change', validate, false);
    popExp.getTopDiv().innerHTML = '<div class=showBadged><center>POWER KOC EXPORT</center></div>';
    if (isKOCattack)    
      document.getElementById ('pbSrcDoBA').addEventListener ('click', doBulkAdd, false);
    popExp.show(true);
         
    if (city != null){
      for (var i=0; i<Cities.numCities; i++)
        if (city.id == Cities.cities[i].id)
          break;
      if (i < Cities.numCities){
        setTimeout (function(){unsafeWindow.citysel_click(document.getElementById('citysel_'+ (i+1)));}, 0);
      }
    }
// TODO: WAIT FOR City select ?
    function validate (e){
      var x = e.target.id.substr(5).split('_');
      var b = x[0];
      var trp = x[1];
      document.getElementById('ptETerr_'+ b).innerHTML = '';
      var x = parseIntZero (e.target.value);
      if (isNaN(x) || x<0 || x>150000){
        e.target.style.backgroundColor = 'red';
        document.getElementById('ptETerr_'+ b).innerHTML = 'Invalid Entry';
        return;
      } else {
        e.target.style.backgroundColor = '';
        e.target.value = x;
        t.troops['b'+ b][trp-1] = x;
      }
      var tot = 0;
      for (var td=0; td<troopDef.length; td++)
        tot += parseIntZero(document.getElementById('ptET_'+ b +'_'+ [troopDef[td][1]]).value);
      if (tot<1 && cList['lvl'+ b].length>0 )
        document.getElementById('ptETerr_'+ b).innerHTML = 'No troops defined';
      if (tot>150000)
        document.getElementById('ptETerr_'+ b).innerHTML = 'Too many troops';
    }
      
    function doBulkAdd (){
      for (var b=1; b<11; b++){
        if (document.getElementById('ptETerr_'+ b).innerHTML != '')
          return;
        var tot = 0;
        for (var td=0; td<troopDef.length; td++)
          tot += t.troops['b'+b][troopDef[td][1]-1];
        if (tot<1 && cList['lvl'+ b].length>0){
          document.getElementById('ptETerr_'+ b).innerHTML = 'No troops defined';
          return;
        } else if (tot>150000) {
          document.getElementById('ptETerr_'+ b).innerHTML = 'Too many troops';
          return;
        }
      }    
      document.getElementById('pbSrcExpResult').innerHTML = '';
      doNextLevel ();
    }
    
    function endBulkAdd (msg){
      unsafeWindow.Modal.hideModalAll();
      curLevel = 0;
      showMe ();
      popExp.show(true);
      document.getElementById('pbSrcExpResult').innerHTML += msg;
    }
    
    function doNextLevel (){
      while ( curLevel<10 && cList['lvl'+ ++curLevel].length==0)
        ;
      if (curLevel>=10){
        endBulkAdd ('done!<BR>');
        return;
      }
     e_attackDialog(false);
    }
        
    function e_attackDialog (tf){
      if (!tf){
       hideMe();
       popExp.show (false);
       unsafeWindow.Modal.hideModalAll();
       unsafeWindow.modal_attack(4,0,0);
       new CwaitForElement ('BulkAddAttackDiv', 1000, e_attackDialog );
      }
      var div = searchDOM (document.getElementById('BulkAddAttackDiv'), 'node.tagName=="DIV" && node.style.display=="none"', 10);
      if (div==null){
        endBulkAdd ('<SPAN class=boldRed>ERROR: Unexpected attack dialog format (1).</span>');
        return;  
      }
      var ta = searchDOM (div, 'node.tagName=="TEXTAREA"', 10);
      var but = searchDOM (div, 'node.tagName=="A"', 10);
      if (ta==null || but==null){
        endBulkAdd ('<SPAN class=boldRed>ERROR: Unexpected attack dialog format (2).</span>');
        return;  
      }
      for (var trp=1; trp<13; trp++){
        var inp = document.getElementById('modal_attack_unit_ipt' +trp);
        inp.value = t.troops['b'+curLevel][trp-1];
        if (t.troops['b'+curLevel][trp-1] > 0)
          inp.style.backgroundColor = 'yellow';
        else
          inp.style.backgroundColor = 'white';
      }
      div.style.display = 'block';
      document.getElementById('KOCAttackBulkAddForce').checked = true;
      if (DISABLE_BULKADD_LIST)
        ta.value = '';
      else {
        var m = '';
        var list = cList['lvl'+ (curLevel)];
        for (i=0; i<list.length; i++)
          m += list[i].x +','+ list[i].y +'\n';
        ta.value = m;
      }
      clickWin (unsafeWindow, but, 'click');   
      unsafeWindow.Modal.hideModal();
      document.getElementById('pbSrcExpResult').innerHTML += 'Added '+ list.length +' targets for '+ city.name +'<BR>';
      setTimeout (doNextLevel, 500);
    }    
  },
}

  function searchDOM (node, condition, maxLevel, doMult){
    var found = [];
    eval ('var compFunc = function (node) { return ('+ condition +') }');
    doOne(node, 1);
    if(!doMult){
      if (found.length==0)
        return null;
      return found[0];
    }
    return found;
    function doOne (node, curLevel){
      try {
        if (compFunc(node))
          found.push(node);
      } catch (e){
      }      
      if (!doMult && found.length>0)
        return;
      if (++curLevel<maxLevel && node.childNodes!=undefined)
        for (var c=0; c<node.childNodes.length; c++)
          doOne (node.childNodes[c], curLevel);
    }
  }



/*********************************** Test TAB ***********************************/
Tabs.Test = {
  tabOrder: 13,
//  tabDisabled : !ENABLE_TEST_TAB,         // if true, tab will not be added or initialized
  tabLabel : 'Test',
  myDiv : null,

  init : function (div){
    var t = Tabs.Test;
    t.myDiv = div;
	var citySelect = '   <SELECT id=fakeCity>';
	    for (var c=0; c<Cities.numCities; c++) {
		 	 aCity = Cities.cities[c].name + ' ('+Cities.cities[c].x + ','+ Cities.cities[c].y+')';
	         citySelect += '<option value=\''+c+'\'>'+aCity+'</option>';
	    }
	    citySelect += '</select>';
    var m = '<TABLE><TR><TD align=right>Scout: </td><TD><INPUT type=checkbox id=fakeIsScout></td></tr>\
                  <TR><TD align=right>Wild: </td><TD><INPUT type=checkbox id=fakeIsWild></td></tr>\
                  <TR><TD align=right>False Report: </td><TD><INPUT type=checkbox disabled id=fakeFalse></td></tr>\
                  <TR><TD align=right>seconds: </td><TD><INPUT type=text size=4 value=300 id=fakeSeconds></td></tr>\
                  <TR><TD align=right># of supply troops: </td><TD><INPUT type=text size=6 value=0 id=faketroop0></td></tr>\
	          <TR><TD align=right># of militiamen: </td><TD><INPUT type=text size=6 value=0 id=faketroop1></td></tr>\
		  <TR><TD align=right># of scouts: </td><TD><INPUT type=text size=6 value=0 id=faketroop2></td></tr>\
		  <TR><TD align=right># of pikeman: </td><TD><INPUT type=text size=6 value=0 id=faketroop3></td></tr>\
		  <TR><TD align=right># of swordsmen: </td><TD><INPUT type=text size=6 value=0 id=faketroop4></td></tr>\
		  <TR><TD align=right># of archers: </td><TD><INPUT type=text size=6 value=0 id=faketroop5></td></tr>\
		  <TR><TD align=right># of Light Cav.: </td><TD><INPUT type=text size=6 value=0 id=faketroop6></td></tr>\
		  <TR><TD align=right># of heavey cav.: </td><TD><INPUT type=text size=6 value=0 id=faketroop7></td></tr>\
		  <TR><TD align=right># of supply wagons: </td><TD><INPUT type=text size=6 value=0 id=faketroop8></td></tr>\
		  <TR><TD align=right># of Ballests: </td><TD><INPUT type=text size=6 value=0 id=faketroop9></td></tr>\
		  <TR><TD align=right># of b.rams: </td><TD><INPUT type=text size=6 value=0 id=faketroop10></td></tr>\
		  <TR><TD align=right># of Catapults: </td><TD><INPUT type=text size=6 value=0 id=faketroop11></td></tr>\
		  <TR><TD align=right>false name: </td><TD><INPUT type=text size=13 value=Probando id=fakeName></td></tr>\
      		  <TR><TD align=right>city ??attack: </td><TD>'+citySelect+'</td></tr>\
                  <BR>Send alerts the Alliance chat and whisper: <INPUT type=checkbox id=ptalertWhisper>\
        <TR><TD colspan=2 align=center><INPUT id=testSendMarch type=submit value="False attack" \></td></tr>\
        <TR><TD colspan=2 align=center><INPUT id=ptReloadKOC type=submit value="Reload KOC" \></td></tr></table>\
        <BR><DIV id=testDiv style="background-color:#fffff0; width=100%; height=0%; overflow-y:auto;"></div>';
    t.myDiv.innerHTML = m;
    document.getElementById('testSendMarch').addEventListener ('click', t.clickFakeAttack, false);
    document.getElementById('ptReloadKOC').addEventListener ('click', reloadKOC, false);
    document.getElementById('ptalertWhisper').addEventListener ('click', function (){SEND_ALERT_AS_WHISPER=this.checked}, false);
    function xyNotify(city, x, y){
      var m = '[ Notified: '+ (city?city.name:'null') +', x='+ x +', y='+ y +' ]';
      document.getElementById('testNotify').innerHTML = m;
    }
  },

  hide : function (){
  },

  show : function (){
  },
  
  writeDiv : function (msg){
    var t = Tabs.Test;
    if (t.state != null)
    document.getElementById('testDiv').innerHTML = msg;
  },

  addDiv : function (msg){
    var t = Tabs.Test;
    if (t.state != null)
    document.getElementById('testDiv').innerHTML += msg;
  },

  createFakeAttack : function (cityNum, isScout, isWild, isFalse, secs, troops, name){
    var marchId = 'm'+ (88888 + Math.floor(Math.random()*11111));
    var march = {};
    if (matTypeof(Seed.queue_atkinc)=='array')
      Seed.queue_atkinc = {};
    if (isFalse)
      march.marchType = 0;
    else if (isScout)
      march.marchType = 3;
    else
      march.marchType = 4;
    march.toCityId = Cities.cities[cityNum].id;
    if (isWild) {
      keys = unsafeWindow.Object.keys(Seed.wilderness['city'+Cities.cities[cityNum].id]);
      march.toTileId = Seed.wilderness['city'+Cities.cities[cityNum].id][keys[0]].tileId;
    } else {
      march.toTileId = Cities.cities[cityNum].tileId;
    }
    secs = parseInt(secs);
    march.arrivalTime = unixTime() + secs;
    march.departureTime = unixTime() - 10;
     march.unts = {}
	for(i=0; i<12; i++){
	  if(troops[i] > 0)
		march.unts["u"+(i+1)] = addCommas(troops[i]);
	}
    march.pid = 1234567;
    march.score = 9;
    march.mid = marchId.substr(1);
    march.players = {}
    march.players.u1234567 = {}
    march.players.u1234567.n = name;
    march.players.u1234567.t = 60;
    march.players.u1234567.m = 5441192;
    march.players.u1234567.s = 'M';
    march.players.u1234567.w = 1;
    march.players.u1234567.a = 1;
    march.players.u1234567.i = 5;
    Seed.queue_atkinc[marchId] = march;
    Seed.players.u1234567 = march.players.u1234567;
  },

  clickFakeAttack : function (){
    var t = Tabs.Test;
    var isScout = document.getElementById('fakeIsScout').checked;
    var isWild = document.getElementById('fakeIsWild').checked;
    var isFalse = document.getElementById('fakeFalse').checked;
	var troops = [];
	for(i=0; i<12; i++)
		troops[i] = parseInt(document.getElementById('faketroop'+i).value);
    var secs = parseInt(document.getElementById('fakeSeconds').value);
	var name = document.getElementById('fakeName').value;
	var city = document.getElementById('fakeCity').value;
    t.createFakeAttack (city, isScout, isWild, isFalse, secs, troops ,name);
  },
}



/*********************************  Cresting Tab ***********************************/
 Tabs.Crest = {
  tabOrder : 10,
  myDiv : null,
  tabLabel: 'Cresting',
  rallypointlevel:null,
  error_code: 0,
  knt:{},
    
/** window display **/   
  init : function (div){
    var t = Tabs.Crest;
    Options.crestMarchError = 0;
    setInterval(t.sendCrestReport, 1*60*1000);	
    setTimeout(function(){ t.Rounds(1,0,0);}, 5*1000);
    t.myDiv = div;
    var selbut=0;
    var m = '<DIV id=pbTowrtDivF class=pbStat>AUTOMATIC FUNCTION CRESTING</div>><TABLE id=pbcrestfunctions width=100% height=0% class=pbTab><TR align="center">';

        m += '<TD align=center><INPUT id=Cresttoggle type=submit value="Cresting = '+ (Options.crestRunning?'ON':'OFF')+'"></td>';


    m += '<TD><INPUT id=CrestHelp type=submit value="Help"></td>';
    m += '<td><INPUT id=showCrestTargets type=submit value="Show"></td>';
    m += '<TD><INPUT id=pbsendreport type=checkbox '+ (Options.crestreport?' CHECKED':'') +'\> Send crests report each ';
    m += '<INPUT id=pbsendcrestreportint value='+ Options.CrestMsgInterval +' type=text size=3 \> hour </td></table>';
  
    m += '<DIV id=pbOpt class=pbStat>Cresting options</div><TABLE id=pbcrestopt	 width=100% height=0% class=pbTab><TR align="center"></table>';
    m += '<DIV style="margin-bottom:10px;">Cret from: <span id=crestcity></span></div>';
    
    m += '<TABLE class=ptTab><TR><TD>coordinates: X:<INPUT id=pbcrestx type=text size=3 maxlength=3 value=""></td>';
    m += '<TD>Y:<INPUT id=pbcresty type=text size=3 maxlength=3 value=""></td></tr></table>';
   

    m += '<TABLE class=ptTab><TR><TD>Oleada <b>1</b>: </td><TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_30.png></td><TD><INPUT id=R1ST type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_30.png></td><TD><INPUT id=R1MM type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_30.png></td><TD><INPUT id=R1Scout type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_30.png></td><TD><INPUT id=R1Pike type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_30.png></td><TD><INPUT id=R1Sword type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_30.png></td><TD><INPUT id=R1Arch type=text size=7 maxlength=6 value=0></td></tr>';
    m += '<tr><td></td><TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_30.png></td><TD><INPUT id=R1LC type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_30.png></td><TD><INPUT id=R1HC type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_30.png></td><TD><INPUT id=R1SW type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_30.png></td><TD><INPUT id=R1Ball type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_30.png></td><TD><INPUT id=R1Ram type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_30.png></td><TD><INPUT id=R1Cat type=text size=7 maxlength=6 value=0></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
    
    m += '<TR><TD>Oleada <b>2</b>: </td><TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_30.png></td><TD><INPUT id=R2ST type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_30.png></td><TD><INPUT id=R2MM type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_30.png></td><TD><INPUT id=R2Scout type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_30.png></td><TD><INPUT id=R2Pike type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_30.png></td><TD><INPUT id=R2Sword type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_30.png></td><TD><INPUT id=R2Arch type=text size=7 maxlength=6 value=0></td></tr>';
    m += '<tr><td></td><TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_30.png></td><TD><INPUT id=R2LC type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_30.png></td><TD><INPUT id=R2HC type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_30.png></td><TD><INPUT id=R2SW type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_30.png></td><TD><INPUT id=R2Ball type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_30.png></td><TD><INPUT id=R2Ram type=text size=7 maxlength=6 value=0></td>';
    m += '<TD>&nbsp;&nbsp;<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_30.png></td><TD><INPUT id=R2Cat type=text size=7 maxlength=6 value=0></td></tr></table>';
    m += '<DIV style="text-align:center; margin-top:15px"><INPUT id=pbSaveRouteCrest type=submit value="Add Attack"></div>';

    
    t.myDiv.innerHTML = m;
	
	document.getElementById('pbsendreport').addEventListener('change', function(){
		Options.crestreport = document.getElementById('pbsendreport').checked;
		saveOptions();
	}, false);
	document.getElementById('pbsendcrestreportint').addEventListener('change', function(){
		Options.CrestMsgInterval = parseInt(document.getElementById('pbsendcrestreportint').value);
		saveOptions();
	}, false);
    
    for (var i=0;i<Seed.cities.length;i++){
		if (CrestOptions.CrestCity == Seed.cities[i][0]){
			selbut=i;
			break;
		}
	}
		
    t.tcp = new CdispCityPicker ('crestcityselect', document.getElementById('crestcity'), true, t.clickCitySelect, selbut);
    
    if (CrestOptions.CrestCity == 0) {
    	CrestOptions.CrestCity = t.tcp.city.id
    }

      document.getElementById('pbcrestx').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbcrestx').value)) document.getElementById('pbcrestx').value='' ;
      }, false);

      document.getElementById('pbcresty').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbcresty').value)) document.getElementById('pbcresty').value='' ;
      }, false);

      document.getElementById('R1ST').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1ST').value)) document.getElementById('R1ST').value=0 ;
      }, false);

      document.getElementById('R1MM').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1MM').value)) document.getElementById('R1MM').value=0 ;
      }, false);

      document.getElementById('R1Pike').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Pike').value)) document.getElementById('R1Pike').value=0 ;
      }, false);

      document.getElementById('R1Scout').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Scout').value)) document.getElementById('R1Scout').value=0 ;
      }, false);

      document.getElementById('R1Sword').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Sword').value)) document.getElementById('R1Sword').value=0 ;
      }, false);

      document.getElementById('R1Arch').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Arch').value)) document.getElementById('R1Arch').value=0 ;
      }, false);

      document.getElementById('R1LC').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1LC').value)) document.getElementById('R1LC').value=0 ;
      }, false);

      document.getElementById('R1HC').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1HC').value)) document.getElementById('R1HC').value=0 ;
      }, false);

      document.getElementById('R1SW').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1SW').value)) document.getElementById('R1SW').value=0 ;
      }, false);

      document.getElementById('R1Ball').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Ball').value)) document.getElementById('R1Ball').value=0 ;
      }, false);

      document.getElementById('R1Ram').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Ram').value)) document.getElementById('R1Ram').value=0 ;
      }, false);

      document.getElementById('R1Cat').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R1Cat').value)) document.getElementById('R1Cat').value=0 ;
      }, false);
	  
      document.getElementById('R2ST').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2ST').value)) document.getElementById('R2ST').value=0 ;
      }, false);

      document.getElementById('R2MM').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2MM').value)) document.getElementById('R2MM').value=0 ;
      }, false);

      document.getElementById('R2Pike').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Pike').value)) document.getElementById('R2Pike').value=0 ;
      }, false);

      document.getElementById('R2Scout').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Scout').value)) document.getElementById('R2Scout').value=0 ;
      }, false);

      document.getElementById('R2Sword').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Sword').value)) document.getElementById('R2Sword').value=0 ;
      }, false);

      document.getElementById('R2Arch').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Arch').value)) document.getElementById('R2Arch').value=0 ;
      }, false);

      document.getElementById('R2LC').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2LC').value)) document.getElementById('R2LC').value=0 ;
      }, false);

      document.getElementById('R2HC').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2HC').value)) document.getElementById('R2HC').value=0 ;
      }, false);

      document.getElementById('R2SW').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2SW').value)) document.getElementById('R2SW').value=0 ;
      }, false);

      document.getElementById('R2Ball').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Ball').value)) document.getElementById('R2Ball').value=0 ;
      }, false);

      document.getElementById('R2Ram').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Ram').value)) document.getElementById('R2Ram').value=0 ;
      }, false);

      document.getElementById('R2Cat').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('R2Cat').value)) document.getElementById('R2Cat').value=0 ;
      }, false);
         
    document.getElementById('crestcity').addEventListener('click', function(){CrestOptions.CrestCity = t.tcp.city.id;} , false);
    document.getElementById('Cresttoggle').addEventListener('click', function(){t.toggleCrestState(this)} , false);
    document.getElementById('pbcrestx').addEventListener('change', function(){CrestOptions.X = document.getElementById('pbcrestx').value;;} , false);
    document.getElementById('pbcresty').addEventListener('change', function(){CrestOptions.Y = document.getElementById('pbcresty').value;} , false);
    document.getElementById('R1ST').addEventListener('change', function(){CrestOptions.R1ST = document.getElementById('R1ST').value;} , false);
    document.getElementById('R1MM').addEventListener('change', function(){CrestOptions.R1MM = document.getElementById('R1MM').value;} , false);
    document.getElementById('R1Scout').addEventListener('change', function(){CrestOptions.R1Scout = document.getElementById('R1Scout').value;} , false);
    document.getElementById('R1Pike').addEventListener('change', function(){CrestOptions.R1Pike = document.getElementById('R1Pike').value;} , false);
    document.getElementById('R1Sword').addEventListener('change', function(){CrestOptions.R1Sword = document.getElementById('R1Sword').value;} , false);
    document.getElementById('R1Arch').addEventListener('change', function(){CrestOptions.R1Arch = document.getElementById('R1Arch').value;} , false);
    document.getElementById('R1LC').addEventListener('change', function(){CrestOptions.R1LC = document.getElementById('R1LC').value;} , false);
    document.getElementById('R1HC').addEventListener('change', function(){CrestOptions.R1HC = document.getElementById('R1HC').value;} , false);
    document.getElementById('R1SW').addEventListener('change', function(){CrestOptions.R1SW = document.getElementById('R1SW').value;} , false);
    document.getElementById('R1Ball').addEventListener('change', function(){CrestOptions.R1Ball = document.getElementById('R1Ball').value;} , false);
    document.getElementById('R1Ram').addEventListener('change', function(){CrestOptions.R1Ram = document.getElementById('R1Ram').value;} , false);
    document.getElementById('R1Cat').addEventListener('change', function(){CrestOptions.R1Cat = document.getElementById('R1Cat').value;} , false);
    document.getElementById('R2ST').addEventListener('change', function(){CrestOptions.R2ST = document.getElementById('R2ST').value;} , false);
    document.getElementById('R2MM').addEventListener('change', function(){CrestOptions.R2MM = document.getElementById('R2MM').value;} , false);
    document.getElementById('R2Scout').addEventListener('change', function(){CrestOptions.R2Scout = document.getElementById('R2Scout').value;} , false);
    document.getElementById('R2Pike').addEventListener('change', function(){CrestOptions.R2Pike = document.getElementById('R2Pike').value;} , false);
    document.getElementById('R2Sword').addEventListener('change', function(){CrestOptions.R2Sword = document.getElementById('R2Sword').value;} , false);
    document.getElementById('R2Arch').addEventListener('change', function(){CrestOptions.R2Arch = document.getElementById('R2Arch').value;} , false);
    document.getElementById('R2LC').addEventListener('change', function(){CrestOptions.R2LC = document.getElementById('R2LC').value;} , false);
    document.getElementById('R2HC').addEventListener('change', function(){CrestOptions.R2HC = document.getElementById('R2HC').value;} , false);
    document.getElementById('R2SW').addEventListener('change', function(){CrestOptions.R2SW = document.getElementById('R2SW').value;} , false);
    document.getElementById('R2Ball').addEventListener('change', function(){CrestOptions.R2Ball = document.getElementById('R2Ball').value;} , false);
    document.getElementById('R2Ram').addEventListener('change', function(){CrestOptions.R2Ram = document.getElementById('R2Ram').value;} , false);
    document.getElementById('R2Cat').addEventListener('change', function(){CrestOptions.R2Cat = document.getElementById('R2Cat').value;} , false);
    document.getElementById('CrestHelp').addEventListener('click', function(){t.helpPop();} , false);
    document.getElementById('pbSaveRouteCrest').addEventListener('click', function(){t.addCrestRoute();}, false);
    document.getElementById('showCrestTargets').addEventListener('click', function(){t.showCrestRoute();}, false);
  },
  
  helpPop : function (){
    var helpText = '<BR>It is designed to attack land repeatedl.<BR>';
    helpText += 'Normally with a single ground attack would be sufficient to remove blasones.Pero can be attacked from all cities.<BR>';
    helpText += 'Make sure you have an empty space to conquer / or neglect to attack land is best for the method<BR>';
    helpText += 'land we have implemented for now. If the last attack on the ground was less than 5 minutes, powerKoc Ships 10% <BR>';
    helpText += 'of "full wave" to keep the suicide troops to the fullest. So do not panic if the second group has only one<BR>';
    helpText += '29mm, compared with a 299mm. <BR>';
    helpText += 'The wild will be attacked in two waves, abandoned and re-attack.<BR>';
    helpText += 'You must have a free wild space in the castle!<BR>';
    helpText += 'Just fill out the coordinates, the troops, adding the attack and click on "ON".<BR><BR>';
    helpText += 'Aims to show all the attacks really well kept and you can delete the.<BR>';
    helpText += 'Can also be used to attack players or to empty a city<BR>';
    helpText += 'You can find more information on Koc Wikia:<BR>';
    helpText += '<A target="_tab" href="http://andalusies.no-ip.biz/kofc/guia_ataques.php">Guide number of troops on(guidance)</a>';
    helpText += '<TABLE width=100%><TR><TD>Level</td><TD>wave 1</td><TD>wave 2</td><TD>Loss of troops</td><TD>Min. amount of fletch</td></tr>';
    helpText += '<TR><TD>1</td><TD>n/a</td><TD>160 MM</td><TD>12 MM</td><TD>0</td></tr>';
    helpText += '<TR><TD>1</td><TD>n/a</td><TD>80 archers</td><TD>none</td><TD>1+</td></tr>';
    helpText += '<TR><TD>2</td><TD>5 MM</td><TD>130 archers</td><TD>1st wave</td><TD>2+</td></tr>';
    helpText += '<TR><TD>3</td><TD>10 MM</td><TD>520 archers</td><TD>1st wave</td><TD>3+</td></tr>';
    helpText += '<TR><TD>4</td><TD>20 MM</td><TD>1600 archers</td><TD>1st wave</td><TD>4+</td></tr>';
    helpText += '<TR><TD>5</td><TD>50 MM</td><TD>2200 archers</td><TD>1st wave</td><TD>6+</td></tr>';
    helpText += '<TR><TD>6</td><TD>100 MM</td><TD>3000 archers</td><TD>1st wave</td><TD>7+</td></tr>';
    helpText += '<TR><TD>7</td><TD>150 MM</td><TD>6000 archers</td><TD>1st wave</td><TD>8+</td></tr>';
    helpText += '<TR><TD>8</td><TD>299 MM + 1Ball.</td><TD>9000 archers + 900 Ball.</td><TD>1st wave + 1 archers</td><TD>9+</td></tr>';
    helpText += '<TR><TD>9</td><TD>599 MM + 1Ball.</td><TD>13000 archers + 900 Ball.</td><TD>1st wave + 2 archers</td><TD>10</td></tr>';
    helpText += '<TR><TD>10</td><TD>1199 MM + 1Cats.</td><TD>35000 archers + 2500 Cats.</td><TD>1st wave + 6 archers + 50 Cats.</td><TD>10</td></tr></table>';

    var pop = new CPopup ('giftHelp', 0, 0, 785, 530, true);
    pop.centerMe (mainPop.getMainDiv());
    pop.getMainDiv().innerHTML = helpText;
    pop.getTopDiv().innerHTML = '<div class=showBadged><center>AYUDA DEL MENU DE BLASONEO</center></div>';
    pop.show (true);
  },

/** Add crest route **/
    addCrestRoute : function () {
		if(CrestOptions.X == "" || CrestOptions.Y == "") {
			alert("Please enter Coords");
			return;
		}
		
		var t = Tabs.Crest;
		var CrestLength = CrestData.length;
		
		CrestData[CrestLength] = new CrestFunc(CrestOptions);
		saveCrestData();
                document.getElementById('pbOpt').style.background ='#99FF99';
		setTimeout(function(){ (document.getElementById('pbOpt').style.background =''); }, 1000);

    },
	
	

/** Show Crest Targets **/
    showCrestRoute : function () {
		var t = Tabs.Crest;
		var popCrestTargets = null;
		t.popCrestTargets = new CPopup('pbShowCrestTargets', 50, 50, 900, 500, true, function() {clearTimeout (1000);});
		var m = '<DIV style="max-height:460px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbShowCrestTargets" id="pbCrestTargets">';       
		t.popCrestTargets.getMainDiv().innerHTML = '</table></div>' + m;
		t.popCrestTargets.getTopDiv().innerHTML = '<div class=showBadged><center>OBJETIVOS</center></div>';
		t.paintCrestTargets();
		t._addTabHeader();
		t.popCrestTargets.show(true);

    },
	
    _addTabHeader : function () {
		var row = document.getElementById('pbCrestTargets').insertRow(0);
		row.vAlign = 'top';
	     	row.insertCell(0).innerHTML = "City / Objective";
	     	row.insertCell(1).innerHTML = "Wave #";
	     	row.insertCell(2).innerHTML = "supply troops.";
	     	row.insertCell(3).innerHTML = "Milis";
	     	row.insertCell(4).innerHTML = "scout";
	     	row.insertCell(5).innerHTML = "Pike.";
	     	row.insertCell(6).innerHTML = "sword.";
	     	row.insertCell(7).innerHTML = "Archer";
	     	row.insertCell(8).innerHTML = "cav";
	     	row.insertCell(9).innerHTML = "H.Cav";
	     	row.insertCell(10).innerHTML = "supply wagons";
	     	row.insertCell(11).innerHTML = "Ballest.";
	     	row.insertCell(12).innerHTML = "rams";
	     	row.insertCell(13).innerHTML = "Cats";
	     	row.insertCell(14).innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;";
    },	


	
	

/** paintCrestTargets **/
    paintCrestTargets : function () {
		t = Tabs.Crest;

		for(var i = 0; i < CrestData.length; i++) {
			t._addTabCrest(i, "Attack: " + CrestData[i].X + "," + CrestData[i].Y, "Wave 2", CrestData[i].R2ST, CrestData[i].R2MM, CrestData[i].R2Scout, CrestData[i].R2Pike, CrestData[i].R2Sword, CrestData[i].R2Arch, CrestData[i].R2LC, CrestData[i].R2HC, CrestData[i].R2SW, CrestData[i].R2Ball, CrestData[i].R2Ram, CrestData[i].R2Cat, " ");
			t._addTabCrest(i, CrestData[i].CrestCity, "Wave 1", CrestData[i].R1ST, CrestData[i].R1MM, CrestData[i].R1Scout, CrestData[i].R1Pike, CrestData[i].R1Sword, CrestData[i].R1Arch, CrestData[i].R1LC, CrestData[i].R1HC, CrestData[i].R1SW, CrestData[i].R1Ball, CrestData[i].R1Ram, CrestData[i].R1Cat, "Delete");
			t._addTabCrest(i, "","","","","","","","","","","","","","","");
		}

	},
	
	

/** Add Tab Crest **/
    _addTabCrest : function (QueID, col0, col1, col2, col3, col4, col5, col6, col7, col8, col9, col10, col11, col12, col13, col14) {
		var t = Tabs.Crest;
		var row = document.getElementById('pbCrestTargets').insertRow(0);

		for (var i = 0; i <= 14; i++) {
			if (i == 14 && col14 == "Delete") {
				row.insertCell(i).innerHTML = "<a id=pbCrestDel_" + QueID + " value=" + i + ">Delete</a>";
				document.getElementById('pbCrestDel_' + QueID).addEventListener('click', function(){t.cancelCrestTarget(QueID);}, false);
			} else if (col14 == "Delete" && i == 0) {
				row.insertCell(i).innerHTML = Cities.byID[col0].name;
			} else {
				row.insertCell(i).innerHTML = eval("col" + i) + "&nbsp; &nbsp;";
			}
		}
		
    },
	
	

/** Cancel Crest Target **/
    cancelCrestTarget : function (QueID) {
	     var t = Tabs.Crest;
	     var queueId = parseInt(QueID);
	     CrestData.splice(queueId, 1);
	     saveCrestData();
	     t.showCrestRoute();
    },
	
	

	getRallypointLevel: function(cityId){
		var t = Tabs.Crest;
		for (var o in Seed.buildings[cityId]){
			var buildingType = parseInt(Seed.buildings[cityId][o][0]);
			var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
			if (buildingType == 12) 
				t.rallypointlevel=parseInt(buildingLevel);
		}
	},
  
 

	getAtkKnight : function(cityID){
		var t = Tabs.Crest;
		t.knt = new Array();
		for (k in Seed.knights[cityID]){
			if (Seed.knights[cityID][k]["knightStatus"] == 1 && Seed.leaders[cityID]["resourcefulnessKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["politicsKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["combatKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["intelligenceKnightId"] != Seed.knights[cityID][k]["knightId"]){
     			t.knt.push ({
     				Name:   Seed.knights[cityID][k]["knightName"],
     				Combat:	parseInt(Seed.knights[cityID][k]["combat"]),
     				ID:		Seed.knights[cityID][k]["knightId"],
     			});
     		}
		}
		t.knt = t.knt.sort(function sort(a,b) {a = parseInt(a['Combat']);b = parseInt(b['Combat']);return a == b ? 0 : (a > b ? -1 : 1);});
	},
   

   
 	sendMarch: function(p,callback,r,retry, CrestDataNum){
		var t = Tabs.Crest;			
		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {	
			 method: "post",
			 parameters: p,
			 loading: true,
			 onSuccess: function (transport) {		
				var rslt = eval("(" + transport.responseText + ")");
				if (rslt.ok) {
					var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
					var ut = unsafeWindow.unixtime();
					var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
					var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
					for(i = 0; i <= unitsarr.length; i++){
						if(p["u"+i]){
							unitsarr[i] = p["u"+i];
						}
					}

					var currentcityid = p.cid;
					unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, p.xcoord, p.ycoord, unitsarr, p.type, p.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
					unsafeWindow.update_seed(rslt.updateSeed)
				
					if (rslt.updateSeed) {
						unsafeWindow.update_seed(rslt.updateSeed);
					}
			 
					GM_log(r);
			 
					if(r==1){
						Options.Crest1Count++;
						r = 2;
					} else {
						Options.Crest2Count++;
					}				
			
					var now = new Date().getTime()/1000.0;
					now = now.toFixed(0);
					CrestData[CrestDataNum].lastRoundTwo = now;
					saveCrestData();
					setTimeout (function(){callback(r,0,CrestDataNum);}, 5000);	
					return;
					
				} else {

					if (rslt.user_action) {
						new CdialogCancelContinue('<SPAN class=boldRed>CAPTCHA ALERT! These sending too many attacks!</span>', null, null, mainPop.getMainDiv);
						logit('send march captcha');
						setTimeout (function(){callback(r,retry,CrestDataNum);}, 1*60*1000);
						return;
					}
					setTimeout (function(){callback(r,retry,CrestDataNum);}, 5000);
					return;
				}
			},
			 onFailure: function () {
				setTimeout (function(){callback(r,retry,CrestDataNum);}, 5000);
				return;
			 }
  		});	
	},
	

	
	abandonWilderness: function(tid,x,y,cid,callback,retry, CrestDataNum){
		var t = Tabs.Crest;		
		if (!Options.crestRunning) return;
		
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		var cityID = cid;
		var tileid = tid;
		params.tid=tid;
		params.cid=cid;
		params.x=x;
  		params.y=y; 		  		
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/abandonWilderness.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
  		    parameters: params,
  		    loading: true,
  		    onSuccess:function(transport){
				var rslt=eval("("+transport.responseText+")");
				if (rslt.ok) {
					t.error_code = 0;	
					if (rslt.returningMarches) {
						var cities = Object.keys(rslt.returningMarches);
						for (var i = 0; i < cities.length; i++) {
							for (var j = 0; j < rslt.returningMarches[cities[i]].length; j++) {
				                var cid = cities[i].split("c")[1];
				                var mid = rslt.returningMarches[cities[i]][j];
				                var march = Seed.queue_atkp["city" + cid]["m" + mid];
								if (march) {
									var marchtime = Math.abs(parseInt(march.destinationUnixTime) - parseInt(march.marchUnixTime));
				                    var ut = unsafeWindow.unixtime();
				                    Seed.queue_atkp["city" + cid]["m" + mid].destinationUnixTime = ut;
				                    Seed.queue_atkp["city" + cid]["m" + mid].marchUnixTime = ut - marchtime;
				                    Seed.queue_atkp["city" + cid]["m" + mid].returnUnixTime = ut + marchtime;
				                    Seed.queue_atkp["city" + cid]["m" + mid].marchStatus = 8
				                }
				            }
				        }
				    }
					if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
				    if (Object.keys(Seed.wilderness["city" + cityID]).length == 1) {
						Seed.wilderness["city" + cityID] = []
  		         	} else	{
						delete Seed.wilderness["city"+cityID]["t"+tileid];
  		         	}
				} else {
					if (rslt.error_code != 401) {
						t.error_code = rslt.error_code; 
               			if(retry > 5){
							reloadKOC();
							return;
						}
               		}
  		        }				
  		    },
  		    onFailure: function () {}
  		});
    },
    
	
	
	Rounds : function (r, retry, CrestDataNum) {
		var t = Tabs.Crest;
		
		//r = (typeof r === 'undefined') ? 0 : r;
		//retry = (typeof retry === 'undefined') ? 0 : retry;
		//CrestDataNum = (typeof CrestDataNum === 'undefined') ? 0 : CrestDataNum;

		if (!Options.crestRunning) return;
		if (CrestData.length == 0)
			return;
		if (CrestDataNum >= CrestData.length)
			CrestDataNum = 0;

		cityID = 'city' + CrestData[CrestDataNum].CrestCity;
		retry++;
		
		for (var k in Seed.wilderness[cityID] ){
			if (Seed.wilderness[cityID][k]['xCoord']==CrestData[CrestDataNum].X && Seed.wilderness[cityID][k]['yCoord']==CrestData[CrestDataNum].Y && t.error_code!=401) {
				t.abandonWilderness(Seed.wilderness[cityID][k]['tileId'],Seed.wilderness[cityID][k]['xCoord'],Seed.wilderness[cityID][k]['yCoord'],CrestData[CrestDataNum].CrestCity,t.Rounds,retry,CrestDataNum);
			}
		}

		switch (retry) {
			case 10:
				setTimeout(function(){ t.Rounds(r,retry,CrestDataNum);},30000);
				return;
				break;
			case 20:
				setTimeout(function(){ t.Rounds(r,retry,CrestDataNum);},30000);
				return;
				break;
			case 30:
				reloadKOC();
				return;
				break;
		}

		if (parseInt(Seed.units[cityID]['unt1']) < CrestData[CrestDataNum].R1ST || parseInt(Seed.units[cityID]['unt2']) < CrestData[CrestDataNum].R1MM || parseInt(Seed.units[cityID]['unt3']) < CrestData[CrestDataNum].R1Scout || parseInt(Seed.units[cityID]['unt4']) < CrestData[CrestDataNum].R1Pike || parseInt(Seed.units[cityID]['unt5']) < CrestData[CrestDataNum].R1Sword || parseInt(Seed.units[cityID]['unt6']) < CrestData[CrestDataNum].R1Arch || parseInt(Seed.units[cityID]['unt7']) < CrestData[CrestDataNum].R1LC || parseInt(Seed.units[cityID]['unt8']) < CrestData[CrestDataNum].R1HC || parseInt(Seed.units[cityID]['unt9']) < CrestData[CrestDataNum].R1SW || parseInt(Seed.units[cityID]['unt10']) < CrestData[CrestDataNum].R1Ball || parseInt(Seed.units[cityID]['unt11']) < CrestData[CrestDataNum].R1Ram || parseInt(Seed.units[cityID]['unt12']) < CrestData[CrestDataNum].R1Cat || parseInt(Seed.units[cityID]['unt1']) < CrestData[CrestDataNum].R2ST || parseInt(Seed.units[cityID]['unt2']) < CrestData[CrestDataNum].R2MM || parseInt(Seed.units[cityID]['unt3']) < CrestData[CrestDataNum].R2Scout || parseInt(Seed.units[cityID]['unt4']) < CrestData[CrestDataNum].R2Pike || parseInt(Seed.units[cityID]['unt5']) < CrestData[CrestDataNum].R2Sword || parseInt(Seed.units[cityID]['unt6']) < CrestData[CrestDataNum].R2Arch || parseInt(Seed.units[cityID]['unt7']) < CrestData[CrestDataNum].R2LC || parseInt(Seed.units[cityID]['unt8']) < CrestData[CrestDataNum].R2HC || parseInt(Seed.units[cityID]['unt9']) < CrestData[CrestDataNum].R2SW || parseInt(Seed.units[cityID]['unt10']) < CrestData[CrestDataNum].R2Ball || parseInt(Seed.units[cityID]['unt11']) < CrestData[CrestDataNum].R2Ram || parseInt(Seed.units[cityID]['unt12']) < CrestData[CrestDataNum].R2Cat) {
			if (CrestData.length == 1) {
				setTimeout(function(){ t.Rounds(r,retry,CrestDataNum);},20000);
				return;
			 } else
				setTimeout(function(){ t.Rounds(1,retry,parseInt(CrestDataNum)+1);},5000);
			return;
		}

		t.getAtkKnight(cityID);
		slots=0;
		
		for (z in Seed.queue_atkp[cityID]) {
			slots++;
		}
		if  (Seed.queue_atkp[cityID].toSource() == "[]")
			slots=0;
		
		t.getRallypointLevel(cityID);
		switch (t.rallypointlevel) {
			case 12:
				t.rallypointlevel = t.rallypointlevel - 1;
			default:
				if (t.rallypointlevel <= slots) {
					if (CrestData.length == 1) {
						setTimeout(function(){ t.Rounds(r,retry,CrestDataNum);},20000);
					} else {
						setTimeout(function(){ t.Rounds(1,retry,parseInt(CrestDataNum)+1);},5000);
					}
					return;
					break;
				}
		}

       
		if  (t.knt.toSource() == "[]") {
			setTimeout(function(){ t.Rounds(1,retry,parseInt(CrestDataNum)+1);},5000);
			return;
		} 
		var kid = t.knt[0].ID;
		if (CrestData[CrestDataNum].R1ST == 0 && CrestData[CrestDataNum].R1MM == 0 && CrestData[CrestDataNum].R1Scout == 0 && CrestData[CrestDataNum].R1Pike == 0 && CrestData[CrestDataNum].R1Sword == 0 && CrestData[CrestDataNum].R1Arch == 0 && CrestData[CrestDataNum].R1LC == 0 && CrestData[CrestDataNum].R1HC == 0 && CrestData[CrestDataNum].R1SW == 0 && CrestData[CrestDataNum].R1Ball == 0 && CrestData[CrestDataNum].R1Ram == 0 && CrestData[CrestDataNum].R1Cat == 0) {
		   r=2;
	   }else {
			var now = new Date().getTime()/1000.0;
			now = now.toFixed(0);
			if (now > (parseInt(CrestData[CrestDataNum].lastRoundTwo) + 300)) {
				r=1;
			}
		}

		switch(r) {
			case 1:
				if ((t.rallypointlevel-slots) < 2) {
					setTimeout(function(){ t.Rounds(1,retry,CrestDataNum+1);},5000);
					return;
				}
				var params 		= 	unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
				params.cid		= 	CrestData[CrestDataNum].CrestCity;
				params.type		=	4;
				params.kid		= 	kid;
				params.xcoord 	= 	CrestData[CrestDataNum].X;
				params.ycoord 	= 	CrestData[CrestDataNum].Y;
				if (now < (parseInt(CrestData[CrestDataNum].lastRoundTwo) + 300)) { 
				
					params.u2 	= 	(CrestData[CrestDataNum].R1MM / 10);
					params.u2 	= 	params.u2.toFixed(0);
					
					if (params.u2 < (CrestData[CrestDataNum].R1MM / 10)) 
						params.u2++;
				} else {
					params.u2	= 	CrestData[CrestDataNum].R1MM;
				}
				params.u1 		= 	CrestData[CrestDataNum].R1ST;
				params.u2 		= 	CrestData[CrestDataNum].R1MM;
				params.u3 		= 	CrestData[CrestDataNum].R1Scout;
				params.u4 		= 	CrestData[CrestDataNum].R1Pike;
				params.u5 		= 	CrestData[CrestDataNum].R1Sword;
				params.u6 		= 	CrestData[CrestDataNum].R1Arch;
				params.u7 		= 	CrestData[CrestDataNum].R1LC;
				params.u8 		= 	CrestData[CrestDataNum].R1HC;
				params.u9 		= 	CrestData[CrestDataNum].R1SW;
				params.u10 		= 	CrestData[CrestDataNum].R1Ball;
				params.u11 		= 	CrestData[CrestDataNum].R1Ram;
				params.u12 		= 	CrestData[CrestDataNum].R1Cat;
				
				t.sendMarch(params,t.Rounds,r,retry, CrestDataNum);
				break;
			default:
				var params 		= 	unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
				params.cid		= 	CrestData[CrestDataNum].CrestCity;
				params.type		= 	4;
				params.kid		= 	kid;
				params.xcoord 	= 	CrestData[CrestDataNum].X;
				params.ycoord 	= 	CrestData[CrestDataNum].Y;
				params.u1 		= 	CrestData[CrestDataNum].R2ST;
				params.u2 		= 	CrestData[CrestDataNum].R2MM;
				params.u3 		= 	CrestData[CrestDataNum].R2Scout;
				params.u4 		= 	CrestData[CrestDataNum].R2Pike;
				params.u5 		= 	CrestData[CrestDataNum].R2Sword;
				params.u6 		= 	CrestData[CrestDataNum].R2Arch;
				params.u7 		= 	CrestData[CrestDataNum].R2LC;
				params.u8 		= 	CrestData[CrestDataNum].R2HC;
				params.u9 		= 	CrestData[CrestDataNum].R2SW;
				params.u10 		= 	CrestData[CrestDataNum].R2Ball;
				params.u11 		= 	CrestData[CrestDataNum].R2Ram;
				params.u12 		= 	CrestData[CrestDataNum].R2Cat;
				t.sendMarch(params,t.Rounds,r,retry, CrestDataNum);
				break;
		}

	},
	
	toggleCrestState: function(obj) {
		var t = Tabs.Crest;
                obj = document.getElementById('Cresttoggle');
                if (Options.crestRunning == true) {
		  Options.crestRunning = false;
		  obj.value = "Crest = OFF";
                  updatebotbutton('Crest-OFF', 'pbcresttab');
		  saveOptions();

		} else {
                     Options.crestRunning = true;
                     obj.value = "Crest = ON";
	             updatebotbutton('Crest-ON', 'pbcresttab');
		     for (crest in Options.Creststatus) {
					owned = Seed.items['i'+crest];
					if (owned == undefined) owned=0;
					Options.Creststatus[crest] = owned;
//                        		Options.CrestLevel = 0;
//                        		Options.CrestType = 0;
					Options.Crest1Count = 0;
					Options.Crest2Count = 0;
				}
				var now = new Date().getTime()/1000.0;
				now = now.toFixed(0);
				Options.LastCrestReport = now;
                                saveOptions();
				setTimeout(function(){ t.Rounds(1,0,0);}, 5*1000);
			}
	},
	

	
	
	

	sendCrestReport: function(){
		if(!Options.crestreport || !CrestOptions.Running) 
			return;
			
		var t = Tabs.Crest;
		var now = new Date().getTime()/1000.0;
		now = now.toFixed(0);
		
		if (now < (parseInt(Options.LastCrestReport)+(Options.CrestMsgInterval*60*60))) 
			return;

		var total = 0;
		var wildtype = 	'';

		switch (Options.CrestType) {
			case '10':
				wildtype = unsafeWindow.g_js_strings.commonstr.grassland;
				break;
			case '11': 
				wildtype = unsafeWindow.g_js_strings.commonstr.lake;
				break;
			case '20': 
				wildtype = unsafeWindow.g_js_strings.commonstr.woods;
				break;
			case '30': 
				wildtype = unsafeWindow.g_js_strings.commonstr.hills;
				break;
			case '40': 
				wildtype = unsafeWindow.g_js_strings.commonstr.mountain;
				break;
			case '50': 
				wildtype = unsafeWindow.g_js_strings.commonstr.plain;
				break;
		}
		
		var message = 'Crest Stats: %0A';
		message += '%0A Crests Gained (for '+ Options.CrestMsgInterval +' hour of cresting) on a Level: '+Options.CrestLevel+' '+wildtype+'%0A';

		for (crest in Options.Creststatus) {
			owned = Seed.items['i'+crest];
			if (owned == undefined) 
				owned =	0;
			if ((owned - Options.Creststatus[crest]) > 0) 
				message	+= 	'<DIV><B>' + unsafeWindow.itemlist['i'+crest]['name'] +': '+ (owned - Options.Creststatus[crest]) +'%0A </b></div>';
			else 
				message	+= 	unsafeWindow.itemlist['i'+crest]['name'] +': '+ (owned - Options.Creststatus[crest]) +'%0A';
				
			total += (owned - Options.Creststatus[crest]);
			Options.Creststatus[crest] = owned;
		}
		
		message += '%0A Total Crests gained: '+ total +'%0A';
		message += '%0A Numbers of 1st Wave send: '+ Options.Crest1Count +'%0A';
		message += 'Numbers of 2nd Wave send: '+ Options.Crest2Count +'%0A';

		Options.Crest1Count = 0;
		Options.Crest2Count = 0;

		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.emailTo = Seed.player['name'];
		params.subject = "Crest Overview";
		params.message = message;
		params.requestType = "COMPOSED_MAIL";
		
		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (message) {
				var rslt = eval("(" + message.responseText + ")");
				if (rslt.ok) {
					Options.LastCrestReport = now;
				} 
			},
			onFailure: function () {
			},
		});

		saveOptions();
	},	


	hide : function (){
		var t = Tabs.Crest;
	},

	show : function (){
	},
 };
/** End Cresting tab **

/*************** TRANSPORT **********/
Tabs.TranspAuto = {
 tabOrder: 5,
 tabLabel: 'Transporter',
 cont : null,
 displayTimer : null,
 state : null,
 curTabBut : null,
 curTabName : null,
 sourceCity : {},
 destinationCity : {},
 rows : [],
  timer: null,
  traderState: [],
  reapproState: [],
  lTR: [],
  tradeRoutes: [],
  checkdotradetimeout: null,
  count:0,
  check:false,
 show : function (){
   var t = Tabs.TranspAuto;
   if (document.getElementById ('maparea_map').style.display!="none") {
     if (t.destinationCityx) {
                      t.destinationCityx.value = document.getElementById ('mapXCoor').value;
                      t.destinationCityy.value = document.getElementById ('mapYCoor').value;
                     }
   }
   if (t.curTabBut) {
    var but=t.curTabBut;
    t.show2();
   }
 },
 hide : function (){
    var t = Tabs.TranspAuto;
    clearTimeout (t.displayTimer);
    clearTimeout (t.timer);
  },
  
  init : function (div){  
   var t = Tabs.TranspAuto;
   unsafeWindow.BOestimeres = t.estimerRes;
   t.traderState = {running: false,};
   t.reapproState = {running: false,city:-1,unit:9,mini:1000};
   t.readTraderState();
   t.readReapproState();
   
   t.readTradeRoutes();  
   t.e_tradeRoutes();
	    
 
   if (t.reapproState.running == false) {
       	       updatebotbutton('Tran-OFF', 'boreapprotab');
             } else {
       	      updatebotbutton('Tran-ON', 'boreapprotab');
       	      setTimeout(t.actionreappro,10000);
   }
   if (t.traderState.running == false) {
       	       updatebotbutton('Tran-OFF', 'pbtrantab');
             } else {
       	       updatebotbutton('Tran-ON', 'pbtrantab');
    }
    window.addEventListener('unload', t.onUnload, false);
    t.cont = div;
    t.cont.innerHTML = '<TABLE class=ptTab align=center><TR><TD><INPUT class=pbSubtab ID=BoTrpSubM type=submit value="Manual"></td>\
             <TD><INPUT class=pbSubtab ID=BoTrpSubA type=submit  value="Automatic"></td><TD><INPUT class=pbSubtab ID=BoTrpSubR type=submit  value="supply"></td></tr></table>\
         <DIV id="BoTrpOutput" style="margin-top:5px; background-color:white; max-height:'+(Options.HauteurBoite-65)+'px;overflow-y:auto"></div>';
        t.TransportDiv = ById('BoTrpOutput'); 
  ById('BoTrpSubA').addEventListener('click', e_butSubtab, false);
  ById('BoTrpSubM').addEventListener('click', e_butSubtab, false);
  ById('BoTrpSubR').addEventListener('click', e_butSubtab, false);
  
  
  
  
     changeSubtab (ById('BoTrpSubM'));  

      function e_butSubtab (evt){
          changeSubtab (evt.target);   
      }
    
      function changeSubtab (but){
          if (but == t.curTabBut)
            return;
          if (t.curTabBut){
            t.curTabBut.className='pbSubtab'; 
            t.curTabBut.disabled=false;
          }
          t.curTabBut = but;
          but.className='pbSubtab pbSubtabSel'; 
          but.disabled=true;
          t.curTabName = but.id.substr(8);
          t.show2();
      }  
      var final = 0;
      if (t.reapproState.city>=0) {
      for(var i=0; i<Cities.numCities; i++) {
          var x2 = parseInt(Cities.cities[i].x);
          var x1 = parseInt(Cities.cities[t.reapproState.city].x);
          var y2 = parseInt(Cities.cities[i].y);
          var y1 = parseInt(Cities.cities[t.reapproState.city].y);
          var dist = distance (x1, y1, x2, y2);
          var m = estETA(dist,t.reapproState.unit,Cities.cities[t.reapproState.city].id,1);  
           if (m.friendETA>final)
            final=m.friendETA;
        }
        Options.reapprointerval = parseInt(final/60*2+10);
       }    
  },
   show2 : function (){
     var t = Tabs.TranspAuto
     t.state = null;
     clearTimeout (t.displayTimer);
     clearTimeout (t.timer);
     if (t.curTabName == 'M')
       t.showManuel();
     else  if (t.curTabName == 'R')
       t.showReappro();
     else {
       t.showAuto();
       t.showTimer();	
     }
  },
  showTimer: function() {
   var t = Tabs.TranspAuto;
   t.updateTroops();
   t.updateResources();  
   t.timer = setTimeout (t.showTimer, 1000); 
  },
  showReappro: function () {
   var t = Tabs.TranspAuto;
   var m = '<DIV id=pbTowrtDivF class=pbStat>AUTOMATIC - SETUP </div><TABLE id=pbtraderfunctions width=100% height=0% class=pbTab><TR align="center">';
   if (t.reapproState.running == false) {
               m += '<TD><INPUT id=boReapproState type=submit value="tran = OFF"></td>';
     	       updatebotbutton('Tran-OFF', 'boreapprotab');
           } else {
               m += '<TD><INPUT id=boReapproState type=submit value="Tran = ON"></td>';
     	      updatebotbutton('Tran-ON', 'boreapprotab');
   }
   m += '<td><input type=button value="autotransport" id=BORecupReappro></td><td><input type=button value="save" id="boReappro"><td><span title="El time is recalculated each time you open the script ! is defined by how long it takes between the city and the secondary provider + 10 minutes.">interval : <INPUT id=pbreapprointerval type=text size=2 READONLY value="'+Options.reapprointerval+'"\> minutes</td></tr></table>';
   m += '<DIV id=pbReapproDivDRoute class=pbStat>ADJUSTMENTS OF SUPPLY</div>';
   m += '<TABLE id=pbaddReapproroute width=95% height=0% class=pbTab><TR align="left">';
   m += '<TR align="left"><TD colspan=2><b>city ??provider:</b></td> <TD colspan=3><DIV style="margin-bottom:10px;"><span id=borescity></span></div></td><td>&nbsp;&nbsp;</td><td colspan=4><b>'+uW.g_js_strings.commonstr.troops+' : </b><select id="BOApproUnit"><option value=9>Carros</option><option value=7>Caballeria</option><option value=8>Cab.Pesada</option></select><b>&nbsp;&nbsp; Min. : </b><input type=text size=5 value="0" id=BOApproMin></td></tr>';
  
  var Types = ['gold','food','wood','stone','iron','aetherstone'];
   
    m += '<TR align="left"><td colspan=2>Inventory amounts</td>';
   for (var y=0; y< Seed.cities.length;y++)
    m += '<td>'+Seed.cities[y][1]+'</td>';
   for (var i=0;i<=5;i++) {
    m += '</tr><tr><td align=center valign=middle rowspan=2><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/'+Types[i]+'_30.png"></td><td>'+uW.g_js_strings.commonstr.inventory+'</td>';
    for (var y=0; y< Seed.cities.length;y++)
     m += '<td><span id="ReappRec_'+y+'_'+i+'"></span></td>';
    m += '</tr><tr><td>Min to keeping</td>';
        for (var y=0; y< Seed.cities.length;y++)
     m += '<td><input id="ReappRes_'+y+'_'+i+'" type=text size=10 maxlength=12 value=0></td>';  
    m +='</tr>';
   }
   m += '</table><br><u><b>How to use:</b></u><br>1. Clicking on supplying your city.<br>2. Values ??Clik motor carrier (if we) : This makes the values ??of the motor carrier receives<br>3. Put the number in each city to keep secondary (For example, 15M and 15M mineral stone)<br>4. to look<br>5. If the interval is at 0 please click F5(refresh)<br>6. Of course put it in ON !!!';
   t.TransportDiv.innerHTML = m; 
   if (t.reapproState.city==undefined ||t.reapproState.city==-1) {
    
    t.reapproState.city=0;
   }
   t.reacp = new CdispCityPicker ('botrader', ById('borescity'), true, t.updateResources2, t.reapproState.city);
   ById('BOApproMin').addEventListener('change', function(){
    t.reapproState.mini = ById('BOApproMin').value;
    t.saveReappro();
    }, false); 
   ById('boReapproState').addEventListener('click', function(){t.toggleReapproState(this);}, false);
   ById('boReappro').addEventListener('click', function(){t.saveReappro();}, false);
   
   ById('pbreapprointerval').addEventListener('keyup', function(){
      		if (isNaN(ById('pbreapprointerval').value)){ ById('pbreapprointerval').value=60 ;}
      		Options.reapprointerval = ById('pbreapprointerval').value;
      		saveOptions();
   }, false);
   
   ById('BORecupReappro').addEventListener('click', function(){t.RecupReappro();}, false);
   ById('BOApproUnit').value = t.reapproState.unit;
   ById('BOApproMin').value = parseIntNan(t.reapproState.mini);
   ById('BOApproUnit').addEventListener('change', function(){
    t.reapproState.unit = ById('BOApproUnit').value;
    t.saveReappro();
    
   }, false);
   
   t.updateResources2();
  },
  RecupReappro:function() {
   var t = Tabs.TranspAuto;
   var r = t.tradeRoutes;
   for (var y=0; y< Seed.cities.length;y++) {
    for (var i=0;i<(r.length);i++) {
     if (parseInt(Seed.cities[y][0]) == r[i].city) {
   ById('ReappRes_'+y+'_0').value=r[i].target_Gold;
   ById('ReappRes_'+y+'_1').value=r[i].target_Food;
   ById('ReappRes_'+y+'_2').value=r[i].target_Wood;
   ById('ReappRes_'+y+'_3').value=r[i].target_Stone;
   ById('ReappRes_'+y+'_4').value=r[i].target_Ore;
   ById('ReappRes_'+y+'_5').value=r[i].target_Astone;
   
     }
    } 
   }
   t.saveReappro();
   
   
  },
  saveReapproState: function(){
    var t = Tabs.TranspAuto;
    var serverID = getServerId();
    GM_setValue('reapproState_' + Seed.player['name'] + '_' + serverID, JSON2.stringify(t.reapproState));
  },
  saveReappro:function() {
   var t = Tabs.TranspAuto;
   for (var y=0; y< Seed.cities.length;y++) {
    t.reapproState['ReappRes_'+y+'_0'] = parseIntNan(ById('ReappRes_'+y+'_0').value);
    for (var i=1;i<=5;i++) {
     t.reapproState['ReappRes_'+y+'_'+i] = parseIntNan(ById('ReappRes_'+y+'_'+i).value);
    }
   }
   t.saveReapproState();
  },
  readReapproState: function(){
             var t = Tabs.TranspAuto;
             var serverID = getServerId();
             s = GM_getValue('reapproState_' + Seed.player['name'] + '_' + serverID);
             if (s != null) {
                 state = JSON2.parse(s);
                 for (k in state)
                     t.reapproState[k] = state[k];
             }
  },
  toggleReapproState: function(obj){
     	   var t = Tabs.TranspAuto;
     	   obj = ById('boReapproState');
             if (t.reapproState.running == true) {
                 t.reapproState.running = false;
                 if (obj)  obj.value = "Tran = OFF";
     	       updatebotbutton('Tran-OFF', 'boreapprotab');
     	      clearTimeout(t.checkdoreapprotimeout);
             }
             else {
                t.reapproState.running = true;
                if (obj) obj.value = "Tran = ON";
     		updatebotbutton('Tran-ON', 'boreapprotab');
     		t.actionreappro();
             }
  },
  retry:0,
  nbcity:-1,
  actionreappro:function() {
   var t = Tabs.TranspAuto;
   t.nbcity++;
   if (t.reapproState.running == false) {
     clearTimeout(t.checkdoreapprotimeout);
     return;
   }
   if (t.nbcity==t.reapproState.city)
   	t.nbcity++;  
   var tempsprochainevisite = 10000;
   if ((Seed.cities.length-1)<t.nbcity) {
    tempsprochainevisite = Options.reapprointerval*60*1000;
    t.nbcity=-1;
   } else {
     var besoin=[0,0,0,0,0,0]; 
     var stock=[0,0,0,0,0,0];
     qtemin = parseIntNan(t.reapproState['ReappRes_'+t.nbcity+'_0']);
     qtest = parseIntNan(Seed.citystats["city" + Seed.cities[t.nbcity][0]]['gold'][0]);
     if (qtest<qtemin)
        besoin[0] = parseInt(qtemin - qtest);
     stock[0] = parseIntNan(Seed.citystats["city" + Seed.cities[t.reapproState.city][0]]['gold'][0]);
     for (var i=1;i<=5;i++) {
        qtemin = parseIntNan(t.reapproState['ReappRes_'+t.nbcity+'_'+i]);
        if(i==5) {
         qtest = parseInt(Seed.resources["city" + Seed.cities[t.nbcity][0]]['rec'+i][0]);
         qtstock = parseInt(Seed.resources["city" + Seed.cities[t.reapproState.city][0]]['rec'+i][0]);
        }else {
         qtest = parseInt(Seed.resources["city" + Seed.cities[t.nbcity][0]]['rec'+i][0]/3600);
         qtstock= parseInt(Seed.resources["city" + Seed.cities[t.reapproState.city][0]]['rec'+i][0]/3600);
        }
        if (qtest<qtemin)
        besoin[i] = parseInt(qtemin - qtest);
        stock[i] = qtstock;
     }   
     var rallypointlevel = t.getRallypoint('city' + Cities.cities[t.reapproState.city].id);
     if(rallypointlevel == 12) rallypointlevel = 11;
     var slots = 0;
     var cityId = 'city'+ Cities.cities[t.reapproState.city].id;
     for (var k in Seed.queue_atkp[cityId]){   
         	         march = Seed.queue_atkp[cityId][k];
         	         if (typeof (march) == 'object'){
         	           slots++;
         	         }
     }
     if(slots >= rallypointlevel){
      		actionLog("Tran","Transport of"+Cities.cities[t.reapproState.city].name+" vers "+Cities.cities[t.nbcity].name+" <font color=red>Full rallying point !</font>");
      		return;
     }
     if (besoin[0]>0 || besoin[1]>0|| besoin[2]>0 || besoin[3]>0 || besoin[4]>0 || besoin[5]>0) {
     //actionLog("Appro","Transport de "+Cities.cities[t.reapproState.city].name+" vers "+Cities.cities[t.nbcity].name+" : pierre:" + besoin[3] +"<"+stock[3]+" && mine: "+besoin[4]+"<"+stock[4]+"");
     if (besoin[0]<=stock[0] && besoin[1]<=stock[1] && besoin[2]<=stock[2] && besoin[3]<=stock[3] && besoin[4]<=stock[4] && besoin[5]<=stock[5]) {
          var unit = 'unt' + t.reapproState.unit
       	  Troops = parseInt(Seed.units['city' + Seed.cities[t.reapproState.city][0]][unit]);
       	     var untid=t.reapproState.unit;
	     var techLoadBoost=parseInt(Seed.tech.tch10)*0.1;
	     var loadEffectBoost=0;
	     if(Seed.playerEffects.loadExpire>uW.unixtime()){loadEffectBoost=0.25}
	     var loadBoostBase=(uW.cm.ThroneController.effectBonus(6)*0.01)+loadEffectBoost+techLoadBoost;
	     var loadBoost=loadBoostBase;
	     if(uW.cm.unitFrontendType[untid]=="siege"){
	      //loadBoost+=(uW.cm.ThroneController.effectBonus(59)*0.01); // marche pas celui la
	     }else{
	      if(uW.cm.unitFrontendType[untid]=="horsed"){
	       loadBoost+=(uW.cm.ThroneController.effectBonus(48)*0.01)
	      }
   	 }
       	  var LoadUnit=parseInt(parseInt(uW.unitstats["unt"+untid][5])*(1+loadBoost));
       	  TroopsNeeded = (besoin[0] + besoin[1] + besoin[2] + besoin[3] + besoin[4] + (besoin[5]*5))  / LoadUnit;
       	  TroopsNeeded = TroopsNeeded.toFixed(0);
       	  if (TroopsNeeded < ((besoin[0] + besoin[1] + besoin[2] + besoin[3] + besoin[4] + (besoin[5]*5))  / LoadUnit )) TroopsNeeded++;
       	  var rallypointlevel = t.getRallypoint('city' +Seed.cities[t.reapproState.city][0]);	
  	  if (rallypointlevel == 11) rallypointlevel = 15;
	  if (rallypointlevel == 12) rallypointlevel = 20;
       	  if (parseInt(TroopsNeeded) > parseInt(rallypointlevel*10000)){ 
       	   TroopsNeeded = (rallypointlevel*10000); 
       	   var lemax=LoadUnit*TroopsNeeded;
       	   var totalb=lemax;
       	   for (var i=1;i<=5;i++) {
       	    if (besoin[i]>=totalb)
       	    	besoin[i]=totalb;
       	    totalb=totalb-besoin[i];
       	   }
       	  }
       	  if (parseIntNan(TroopsNeeded)<=parseIntNan(Troops) && parseIntNan(TroopsNeeded)>=parseIntNan(t.reapproState.mini)) { 
       	   var city = Seed.cities[t.reapproState.city][0]
       	   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	   params.gold =besoin[0];
	   params.r1 =besoin[1];
	   params.r2 =besoin[2];
	   params.r3 =besoin[3];
	   params.r4 =besoin[4];
	   params.r5 =besoin[5];
   	   params.kid = 0;
   	   params.type = "1";
       	   params.cid=city;
       	   switch (unit){
	            case 'unt1': params.u1 = TroopsNeeded;break;
	            case 'unt2': params.u2 = TroopsNeeded;break;
	            case 'unt3': params.u3 = TroopsNeeded;break;
	            case 'unt4': params.u4 = TroopsNeeded;break;
	            case 'unt5': params.u5 = TroopsNeeded;break;
	            case 'unt6': params.u6 = TroopsNeeded;break;
	            case 'unt7': params.u7 = TroopsNeeded;break;
	            case 'unt8': params.u8 = TroopsNeeded;break;
	            case 'unt9': params.u9 = TroopsNeeded;break;
	            case 'unt10': params.u10 = TroopsNeeded;break;
	            case 'unt11': params.u11 = TroopsNeeded;break;
	            case 'unt12': params.u12 = TroopsNeeded;break;
           }
       	   params.xcoord = Seed.cities[t.nbcity][2];
   	   params.ycoord = Seed.cities[t.nbcity][3];
  
       	  new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
	                       method: "post",
	                       parameters: params,
	                       loading: true,
	                       onSuccess: function (transport) {
	                       var rslt = eval("(" + transport.responseText + ")");
	                       if (rslt.ok) {
	                       var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
	                       var ut = uW.unixtime();
	                       var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
	                       for(i = 0; i <= unitsarr.length; i++){
	                       	if(params["u"+i]){
	                       	unitsarr[i] = params["u"+i];
	                       	}
	                       }
	                       var resources=new Array();
	                       resources[0] = params.gold;
	                       for(i=1; i<=5; i++){
	                       	resources[i] = params["r"+i];
	                       }
	                       var currentcityid = city;
	                       uW.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
	                       uW.update_seed(rslt.updateSeed)
	                       if(rslt.updateSeed){uW.update_seed(rslt.updateSeed)};
	                        actionLog("Appro","transport "+Cities.cities[t.reapproState.city].name+" vers "+Cities.cities[t.nbcity].name+" de "+TroopsNeeded+" "+uW.unitcost[unit][0]);
	                       } else {
	  			actionLog("Appro","transport "+Cities.cities[t.reapproState.city].name+" vers "+Cities.cities[t.nbcity].name+" <font color=red>" + transport.responseText +"</font>");
	  			t.retry++;
	  			if (t.retry>4) {
	  			 t.retry=0;
	  			}else {
	  			 setTimeout(function() {t.nbcity--;t.actionreappro();},4000);
	  			}
	                       }
	                       },
	                       onFailure: function (rslt) {
	                       if (rslt.user_action) {
			       		actionLog("Appro","<b><font color=red>Detection Captcha</font></b>");
			       	   new CdialogCancelContinue('<SPAN class=boldRed>CAPTCHA ALERT ! Trop de marches ! - Appro</span>', null, null, mainPop.getMainDiv);
		
				} else {
	                          actionLog("Appro","<font color=red>" + rslt.responseText +"</font>");
	                        }
	                       }
             });          	  
       	  } else {
       	   //actionLog("Appro","Transport de "+Cities.cities[t.reapproState.city].name+" vers "+Cities.cities[t.nbcity].name+" : blocage troupes minimun");
       	  }
      } else {
       actionLog("Appro","transport "+Cities.cities[t.reapproState.city].name+" vers "+Cities.cities[t.nbcity].name+" : Stock insuffisant");
      }
     }
   }
   t.checkdoreapprotimeout = setTimeout(function() { t.actionreappro();}, tempsprochainevisite);
  },
  showAuto: function() {
   var t = Tabs.TranspAuto;
    var m = '<DIV id=pbTowrtDivF class=pbStat>AUTO TRANSPORTE - CONFIGURATION</div><TABLE id=pbtraderfunctions width=100% height=0% class=pbTab><TR align="center"><TD><b>Interval: </b>: <INPUT id=pbtransportinterval type=text size=4 value="'+Options.transportinterval+'"\> minutes</td><TD>Tropas minimas: <INPUT id=pbminwagons type=text size=2 value="'+Options.minwagons+'"\> units.</td><TD><INPUT id=pbShowRoutes type=submit value="Show routes"></td>';
         if (t.traderState.running == false) {
             m += '<TD><INPUT id=pbTraderState type=submit value="Transporter = OFF"></td>';
   	       updatebotbutton('Trp-OFF', 'pbtrantab');
         } else {
             m += '<TD><INPUT id=pbTraderState type=submit value="Transporter = ON"></td>';
   	      updatebotbutton('Trp-ON', 'pbtrantab');
         }
         m += '</tr></table></div>';
         m += '<DIV id=pbTraderDivDRoute class=pbStat>ADD TRANSPORTATION ROUTES</div>';
         m += '<TABLE id=pbaddtraderoute width=95% height=0% class=pbTab><TR align="left">';
         m += '<TR align="left"><TD>origin :</td> <TD colspan=4><DIV style="margin-bottom:10px;"><span id=ptrescity></span></div></td></tr>';
   
         m += '<TR align="left">';
         m += '<TD>destination :</td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptcityTo></span></div></td>';
         m += '<TD>O destination coordinates:</td>';
         m += '<TD>X:<INPUT id=ptcityX type=text size=3\></td>';
         m += '<TD>Y:<INPUT id=ptcityY type=text size=3\></td></tr>';
         m += '<TABLE id=pbaddtraderoute height=0% class=pbTab><TR align="left">';
         m += '<TD width=75px>'+uW.g_js_strings.commonstr.troops+' :</td><TD width=150px><SELECT id="TransportTroop">';
         for (y in uW.unitcost) m+='<option value="'+y+'">'+unsafeWindow.unitcost[y][0]+'</option>';
         m+='</select></td><TD width=75px>available :&nbsp;</td><TD id=TroopAmount align=left width=75px></td>';
         m+='<TD width=75px>loaded :&nbsp;</td><TD id=CarryAmount align=left width=75px></td>';
         m += '<TR><TD >Num.troops: </td><TD><INPUT id=TroopsToSend type=text size=6 maxlength=6 value="0">&nbsp;&nbsp;<INPUT id=MaxTroops type=submit value="Max"></td>';
         m += '<TD width=50px><INPUT id=FillInMax type=submit value="<----"></td>';
         m +='<TD id=Calc colspan=3></td></tr>';
         m += '<TABLE id=pbaddtraderoute height=0% class=pbTab><TR align="center">';
         m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png"></td>';
         m += '<TD id=TransRec1 align=right width=110px></td>';
         m += '<TD id=HaveRec1 align=right width=110px></td>';
         m += '<TD width=55px align=right><INPUT id=pbshipFood type=checkbox unchecked=true\></td>';
         m += '<TD width=180px  align=left>maintain : <INPUT id=pbtargetamountFood type=text size=11 maxlength=12 value="0" disabled=true\></td>';
         m += '<TD width=100px>Transporter: <INPUT id=pbtradeamountFood type=text size=11 maxlength=12 value="0"\></td>';
         m += '<TD width=50px><INPUT id=MaxFood type=submit value="Max"></td></tr>';
         m += '<TR align="center">';
         m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png"></td>';
         m += '<TD id=TransRec2 align=right width=110px></td>';
         m += '<TD id=HaveRec2 align=right width=110px></td>';
         m += '<TD width=55px align=right><INPUT id=pbshipWood type=checkbox unchecked=true\></td>';
         m += '<TD width=180px align=left>maintain : <INPUT id=pbtargetamountWood type=text size=11 maxlength=12 value="0" disabled=true\></td>';
         m += '<TD width=100px>Transporter: <INPUT id=pbtradeamountWood type=text size=11 maxlength=12 value="0"\></td>';
         m += '<TD width=50px><INPUT id=MaxWood type=submit value="Max"></td></tr>';
         m += '<TR align="center">';
         m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png"></td>';
         m += '<TD id=TransRec3 align=right width=110px></td>';
         m += '<TD id=HaveRec3 align=right width=110px></td>';
         m += '<TD width=55px align=right><INPUT id=pbshipStone type=checkbox unchecked=true\></td>';
         m += '<TD width=180px align=left>maintain: <INPUT id=pbtargetamountStone type=text size=11 maxlength=12 value="0" disabled=true\></td>';
         m += '<TD width=100px>Transporter: <INPUT id=pbtradeamountStone type=text size=11 maxlength=12 value="0"\></td>';
         m += '<TD width=50px><INPUT id=MaxStone type=submit value="Max"></td></tr>';
         m += '<TR align="center">';
         m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png"></td>';
         m += '<TD id=TransRec4 align=right width=110px></td>';
         m += '<TD id=HaveRec4 align=right width=110px></td>';
         m += '<TD width=55px align=right><INPUT id=pbshipOre type=checkbox unchecked=true\></td>';
         m += '<TD width=180px align=left>maintain : <INPUT id=pbtargetamountOre type=text size=11 maxlength=12 value="0" disabled=true\></td>';
         m += '<TD width=100px>Transporter: <INPUT id=pbtradeamountOre type=text size=11 maxlength=12 value="0"\></td>';
         m += '<TD width=50px><INPUT id=MaxOre type=submit value="Max"></td></tr>';
          m += '<TR align="center">';
      m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png"></td>';
      m += '<TD id=TransRec5 align=right width=110px></td>';
      m += '<TD id=HaveRec5 align=right width=110px></td>';
      m += '<TD width=55px align=right><INPUT id=pbshipAstone type=checkbox unchecked=true\></td>';
      m += '<TD width=180px align=left>maintain : <INPUT id=pbtargetamountAstone type=text size=11 maxlength=12 value="0" disabled=true\></td>';
      m += '<TD width=100px>Transporter: <INPUT id=pbtradeamountAstone type=text size=11 maxlength=12 value="0"\></td>';
      m += '<TD width=50px><INPUT id=MaxAstone type=submit value="Max"></td></tr>';
      m += '<TR align="center">';
         m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png"></td>';
         m += '<TD id=TransGold align=right width=110px></td>';
         m += '<TD id=HaveGold align=right width=110px></td>';
         m += '<TD width=55px align=right><INPUT id=pbshipGold type=checkbox unchecked=true\></td>';
         m += '<TD width=180px align=left>maintain : <INPUT id=pbtargetamountGold type=text size=11 maxlength=12 value="0" disabled=true\></td>';
         m += '<TD width=100px>Transporter: <INPUT id=pbtradeamountGold type=text size=11 maxlength=12 value="0"\></td>';
         m += '<TD width=50px><INPUT id=MaxGold type=submit value="Max"></td></tr>';
   
         m += '</table>';
   
         m += '<DIV style="text-align:center; margin-top:15px"><INPUT id=pbSaveRoute type=submit value="Add Path"><INPUT id=pbManualSend type=submit value="Transport Now"></div>';
         m += '<DIV id=errorSpace></div>'
      
  	 t.TransportDiv.innerHTML = m; 
   
    ById('TransportTroop').value = 'unt9';
         
         t.tcp = new CdispCityPicker ('pttrader', ById('ptrescity'), true, t.updateResources, 0);
         t.tcpto = new CdispCityPicker ('pttraderTo', ById('ptcityTo'), true, t.clickCitySelect).bindToXYboxes(document.getElementById ('ptcityX'), document.getElementById ('ptcityY'));
         
         
       ById('TransportTroop').addEventListener('change', function(){t.updateTroops();}, false);
         ById('pbTraderState').addEventListener('click', function(){t.toggleTraderState(this);}, false);
         ById('pbSaveRoute').addEventListener('click', function(){t.addTradeRoute();}, false);
         ById('pbManualSend').addEventListener('click', function(){t.ManualTransport();}, false);
         ById('pbShowRoutes').addEventListener('click', function(){t.showTradeRoutes();}, false);
         ById('FillInMax').addEventListener('click', function(){ById('TroopsToSend').value = t.TroopsNeeded;}, false);
         
         ById('MaxTroops').addEventListener('click', function(){
   			var rallypointlevel = t.getRallypoint('city' + t.tcp.city.id);
   			if (rallypointlevel == 11) rallypointlevel = 15;
   			if (rallypointlevel == 12) rallypointlevel = 20;
   			var max = t.Troops;
   			if (t.Troops > (rallypointlevel*10000) ) max = (rallypointlevel*10000);
   			ById('TroopsToSend').value = max;
   	  }, false);
         ById('MaxFood').addEventListener('click', function(){
         		t.Food = 0;
   			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
         		ById('pbtradeamountFood').value = (parseInt(input) <= parseIntCommas(ById('TransRec1').innerHTML))?input:parseIntCommas(ById('TransRec1').innerHTML);
         }, false);
         ById('MaxWood').addEventListener('click', function(){
         		t.Wood = 0;
   			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
         		ById('pbtradeamountWood').value = (parseInt(input) <= parseIntCommas(ById('TransRec2').innerHTML))?input:parseIntCommas(ById('TransRec2').innerHTML);
         }, false);
         ById('MaxStone').addEventListener('click', function(){
         		t.Stone = 0;
   			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
         		ById('pbtradeamountStone').value = (parseInt(input) <= parseIntCommas(ById('TransRec3').innerHTML))?input:parseIntCommas(ById('TransRec3').innerHTML);
         }, false);
         ById('MaxOre').addEventListener('click', function(){
         		t.Ore = 0;
   			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
         		ById('pbtradeamountOre').value = (parseInt(input) <= parseIntCommas(ById('TransRec4').innerHTML))?input:parseIntCommas(ById('TransRec4').innerHTML);
         }, false);
         ById('MaxGold').addEventListener('click', function(){
   			t.Gold = 0;
   			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
         		ById('pbtradeamountGold').value = (parseInt(input) <= parseIntCommas(ById('TransGold').innerHTML))?input:parseIntCommas(ById('TransGold').innerHTML);
         }, false);
   	   ById('MaxAstone').addEventListener('click', function(){
         		t.Astone = 0;
   			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
         		ById('pbtradeamountAstone').value = (parseInt(input) <= parseIntCommas(ById('TransRec5').innerHTML))?input:parseIntCommas(ById('TransRec5').innerHTML);
         }, false);
         
         ById('pbtransportinterval').addEventListener('keyup', function(){
   		if (isNaN(ById('pbtransportinterval').value)){ ById('pbtransportinterval').value=60 ;}
   		Options.transportinterval = ById('pbtransportinterval').value;
   		saveOptions();
         }, false);
         
         ById('pbtargetamountFood').addEventListener('keyup', function(){
             if (isNaN(ById('pbtargetamountFood').value)) ById('pbtargetamountFood').value=0 ;
         }, false);
         ById('pbtargetamountWood').addEventListener('keyup', function(){
             if (isNaN(ById('pbtargetamountWood').value)) ById('pbtargetamountWood').value=0 ;
         }, false);
         ById('pbtargetamountStone').addEventListener('keyup', function(){
             if (isNaN(ById('pbtargetamountStone').value)) ById('pbtargetamountStone').value=0 ;
         }, false);
         ById('pbtargetamountOre').addEventListener('keyup', function(){
             if (isNaN(ById('pbtargetamountOre').value)) ById('pbtargetamountOre').value=0 ;
         }, false);
   	  ById('pbtargetamountAstone').addEventListener('keyup', function(){
             if (isNaN(ById('pbtargetamountAstone').value)) ById('pbtargetamountAstone').value=0 ;
         }, false);
         ById('pbtargetamountGold').addEventListener('keyup', function(){
             if (isNaN(ById('pbtargetamountGold').value)) ById('pbtargetamountGold').value=0 ;
         }, false);
         ById('pbtradeamountFood').addEventListener('keyup', function(){
             if (isNaN(ById('pbtradeamountFood').value)) ById('pbtradeamountFood').value=0 ;
         }, false);
         ById('pbtradeamountWood').addEventListener('keyup', function(){
             if (isNaN(ById('pbtradeamountWood').value)) ById('pbtradeamountWood').value=0 ;
         }, false);
         ById('pbtradeamountStone').addEventListener('keyup', function(){
             if (isNaN(ById('pbtradeamountStone').value)) ById('pbtradeamountStone').value=0 ;
         }, false);
         ById('pbtradeamountOre').addEventListener('keyup', function(){
             if (isNaN(ById('pbtradeamountOre').value)) ById('pbtradeamountOre').value=0 ;
         }, false);
   	  ById('pbtradeamountAstone').addEventListener('keyup', function(){
             if (isNaN(ById('pbtradeamountAstone').value)) ById('pbtradeamountAstone').value=0 ;
         }, false);
         ById('pbtradeamountGold').addEventListener('keyup', function(){
             if (isNaN(ById('pbtradeamountGold').value)) ById('pbtradeamountGold').value=0 ;
         }, false);
        ById('pbminwagons').addEventListener('keyup', function(){
            if (isNaN(ById('pbminwagons').value)) ById('pbminwagons').value=100 ;
            Options.minwagons = parseInt(ById('pbminwagons').value);
            saveOptions();
        }, false)
         
         ById('pbshipFood').addEventListener('click', function(){
             if (ById('pbshipFood').checked==false) {
                 ById('pbtargetamountFood').disabled = true;
             }
             else {
               ById('pbtargetamountFood').disabled = false;
             }
         },false);
         ById('pbshipWood').addEventListener('click', function(){
             if (ById('pbshipWood').checked==false) {
                 ById('pbtargetamountWood').disabled = true;
             }
             else {
               ById('pbtargetamountWood').disabled = false;
             }
         },false);
         ById('pbshipStone').addEventListener('click', function(){
             if (ById('pbshipStone').checked==false) {
                 ById('pbtargetamountStone').disabled = true;
             }
             else {
               ById('pbtargetamountStone').disabled = false;
             }
         },false);
         ById('pbshipOre').addEventListener('click', function(){
             if (ById('pbshipOre').checked==false) {
                 ById('pbtargetamountOre').disabled = true;
             }
             else {
               ById('pbtargetamountOre').disabled = false;
             }
         },false);
   	   ById('pbshipAstone').addEventListener('click', function(){
             if (ById('pbshipAstone').checked==false) {
                 ById('pbtargetamountAstone').disabled = true;
             }
             else {
               ById('pbtargetamountAstone').disabled = false;
             } 
         },false);
          ById('pbshipGold').addEventListener('click', function(){
             if (ById('pbshipGold').checked==false) {
                 ById('pbtargetamountGold').disabled = true;
             }
             else {
               ById('pbtargetamountGold').disabled = false;
             }
         },false);
  
       },
       updateResources2 : function (){
       var t = Tabs.TranspAuto
       t.reapproState.city = t.reacp.city.idx;
       for (var y=0; y< Seed.cities.length;y++) {
         if (t.reacp.city.id==Seed.cities[y][0]) {
          ById('ReappRes_'+y+'_0').value="0";
          ById('ReappRes_'+y+'_0').disabled=true;
         }else {
          ById('ReappRes_'+y+'_0').disabled=false;
          ById('ReappRes_'+y+'_0').value=parseIntNan(t.reapproState['ReappRes_'+y+'_0']);
          ById('ReappRec_'+y+'_0').innerHTML = addCommas ( parseIntNan(Seed.citystats["city" + Seed.cities[y][0]]['gold'][0]) );
          }
         for (var i=1;i<=5;i++) {
          if (t.reacp.city.id==Seed.cities[y][0]) {
            ById('ReappRes_'+y+'_'+i).value="0";
            ById('ReappRes_'+y+'_'+i).disabled=true;
          } else{
            ById('ReappRes_'+y+'_'+i).value= parseIntNan(t.reapproState['ReappRes_'+y+'_'+i]);
            ById('ReappRes_'+y+'_'+i).disabled=false;
          }
          if(i==5)
              ById('ReappRec_'+y+'_'+i).innerHTML = addCommas ( parseIntNan(Seed.resources["city" + Seed.cities[y][0]]['rec'+i][0]) );
          else 
              ById('ReappRec_'+y+'_'+i).innerHTML = addCommas ( parseIntNan(Seed.resources["city" + Seed.cities[y][0]]['rec'+i][0]/3600));    
         }
        
       }
       
       },
       updateResources : function (){
       	var t = Tabs.TranspAuto
       	var ToCity = null;
       	for (var i=1;i<=5;i++)
   			if(i==5)
   			   ById('TransRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + t.tcp.city.id]['rec'+i][0]) );
   			else 
                          ById('TransRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + t.tcp.city.id]['rec'+i][0]/3600) );
       	ById('TransGold').innerHTML = addCommas ( parseInt(Seed.citystats["city" + t.tcp.city.id]['gold'][0]) );
       	for (ii in Seed.cities)
           if (Seed.cities[ii][2] == document.getElementById ('ptcityX').value && Seed.cities[ii][3] == document.getElementById ('ptcityY').value)
             ToCity = Seed.cities[ii][0];
         for (var i=1;i<=5;i++)
             if (ToCity != null)
   			if(i==5)
   			   ById('HaveRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + ToCity]['rec'+i][0]) );
   			else
                  ById('HaveRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + ToCity]['rec'+i][0]/3600) );
       	  else ById('HaveRec'+i).innerHTML = "----";
         if (ToCity != null) ById('HaveGold').innerHTML = addCommas ( parseInt(Seed.citystats["city" + ToCity]['gold'][0]) );
         else  ById('HaveGold').innerHTML =  "----";   
       },
       
       updateTroops : function (city){
       	var t = Tabs.TranspAuto;
       	var fontcolor = 'black';
       	t.Food = parseInt(ById('pbtradeamountFood').value);
         	t.Wood = parseInt(ById('pbtradeamountWood').value);
         	t.Stone = parseInt(ById('pbtradeamountStone').value);
         	t.Ore = parseInt(ById('pbtradeamountOre').value);
         	t.Gold = parseInt(ById('pbtradeamountGold').value);
   		t.Astone = parseInt(ById('pbtradeamountAstone').value*5);
       	var unit = ById('TransportTroop').value;
       	t.Troops = parseInt(Seed.units['city' + t.tcp.city.id][unit]);
      	var untid=ById('TransportTroop').value;
	var techLoadBoost=parseInt(Seed.tech.tch10)*0.1;
	var loadEffectBoost=0;
	 if(Seed.playerEffects.loadExpire>uW.unixtime()){loadEffectBoost=0.25}
		     var loadBoostBase=(uW.cm.ThroneController.effectBonus(6)*0.01)+loadEffectBoost+techLoadBoost;
		     var loadBoost=loadBoostBase;
		     if(uW.cm.unitFrontendType[untid]=="siege"){
		      //loadBoost+=(uW.cm.ThroneController.effectBonus(59)*0.01) // marche pas celui la
		     }else{
		      if(uW.cm.unitFrontendType[untid]=="horsed"){
		       loadBoost+=(uW.cm.ThroneController.effectBonus(48)*0.01)
		      }
	 }
        var LoadUnit=parseInt(parseInt(uW.unitstats[untid][5])*(1+loadBoost));
       	var GlobalMaxLoad = t.Troops * LoadUnit;
       	t.MaxLoad = parseInt(ById('TroopsToSend').value) * LoadUnit;
        	t.TroopsNeeded = (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone) / LoadUnit;
        	t.TroopsNeeded = t.TroopsNeeded.toFixed(0);	
   		if (t.TroopsNeeded < ((t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone) / LoadUnit)) t.TroopsNeeded++;	
           
           if ( t.TroopsNeeded > t.Troops) fontcolor = 'red';
       	if (t.Troops > 0 ) ById('TroopAmount').innerHTML = '<FONT color='+fontcolor+'>' + addCommas(t.Troops) + '</font>';
       	else ById('TroopAmount').innerHTML = 0;
       	if (GlobalMaxLoad > 0) ById('CarryAmount').innerHTML = addCommas(GlobalMaxLoad);
       	else  ById('CarryAmount').innerHTML = 0;
       	ById('Calc').innerHTML = 'Load-capacity: ' +  addCommas(t.Food + t.Wood + t.Stone + t.Ore + t.Gold  + t.Astone) + ' / ' + addCommas(t.MaxLoad) + '&nbsp;&nbsp;(troops needed : <FONT color='+fontcolor+'>' + addCommas(t.TroopsNeeded) + '</font> )' ;
       },    
       getRallypoint: function(cityId){
         var t = Tabs.TranspAuto;
         for (var o in Seed.buildings[cityId]){
   		var buildingType = parseInt(Seed.buildings[cityId][o][0]);
   		var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
   		if (buildingType == 12){
   			return parseInt(buildingLevel);
   			break;
   		}
   	   }
   	  return 0;
       },
      e_tradeRoutes: function(){
         var t = Tabs.TranspAuto;
         var now = new Date();
         clearTimeout(t.timer);
         if (t.traderState.running == true)    {
         	var now = new Date().getTime()/1000.0;
         	now = now.toFixed(0);
         	var last = Options.lasttransport;
          		if ( now > (parseInt(last) + (Options.transportinterval*60))){
   				  t.checkdoTrades();
         		}
         }
   	 t.timer = setTimeout(function(){ t.e_tradeRoutes();}, Options.transportinterval*1000);
   	  
       },
       	
   	delTradeRoutes: function() {
   		var t = Tabs.TranspAuto;	
   		t.tradeRoutes= [];
   	},
   	
   	checkcoords : function (obj){
   		var t = Tabs.TranspAuto;
   		if(obj.id == 'pbok'){
   			t.check = true;
   			t.addTradeRoute();
   		}
   		return;			
   	},
   	
   	addTradeRoute: function () {
   		var valid = true;
   		var t = Tabs.TranspAuto;
   		var city = t.tcp.city.id;
   		if (ById('ptcityX').value==0 && ById('ptcityY').value ==0 && !t.check)
   		{
   			return;
   		}
   		var ship_Food = ById('pbshipFood').checked;
   		var ship_Wood = ById('pbshipWood').checked;
   		var ship_Stone = ById('pbshipStone').checked;
   		var ship_Ore = ById('pbshipOre').checked;
   		var ship_Astone = ById('pbshipAstone').checked;
   		var ship_Gold = ById('pbshipGold').checked;
   		var target_Food = ById('pbtargetamountFood').value;
   		var target_Wood = ById('pbtargetamountWood').value;
   		var target_Stone = ById('pbtargetamountStone').value;
   		var target_Ore = ById('pbtargetamountOre').value;
   		var target_Astone = ById('pbtargetamountAstone').value;
   		var target_Gold = ById('pbtargetamountGold').value;
   		var trade_Food = ById('pbtradeamountFood').value;
   		var trade_Wood = ById('pbtradeamountWood').value;
   		var trade_Stone = ById('pbtradeamountStone').value;
   		var trade_Ore = ById('pbtradeamountOre').value;
   		var trade_Astone = ById('pbtradeamountAstone').value;
   		var trade_Gold = ById('pbtradeamountGold').value;
   		var target_x = ById('ptcityX').value;
   		var target_y = ById('ptcityY').value;
   		var TroopType = ById('TransportTroop').value;
   		var route_state = true;
   				
   		if (valid == true) {
   			var lTR = t.tradeRoutes;
   			lTR.push({
   				city:				city,
   				ship_Food:			ship_Food,
   				target_Food:		target_Food,
   				trade_Food: 		trade_Food,
   				ship_Wood:			ship_Wood,
   				target_Wood:		target_Wood,
   				trade_Wood: 		trade_Wood,
   				ship_Stone:			ship_Stone,
   				target_Stone:		target_Stone,
   				trade_Stone: 		trade_Stone,
   				ship_Ore:			ship_Ore,
   				target_Ore:			target_Ore,
   				trade_Ore:	 		trade_Ore,
   				ship_Astone:	    ship_Astone,
   				target_Astone:		target_Astone,
   				trade_Astone:	 	trade_Astone,
   				ship_Gold:			ship_Gold,
   				target_Gold:		target_Gold,
   				trade_Gold: 		trade_Gold,
   				target_x: 			target_x,
   				target_y: 			target_y,
   				TroopType:      TroopType,
   				route_state: 		"true"
   			});
   		}
   		ById('pbTraderDivDRoute').style.background ='#99FF99';
   		setTimeout(function(){ (ById('pbTraderDivDRoute').style.background =''); }, 500);
   	},
   	showTradeRoutes: function () {
   		var t = Tabs.TranspAuto;
   		if (t.popTradeRoutes == null) {
   		 t.popTradeRoutes = new CPopup('pbShowTrade', 0, 0, 750, 500, true, function() {clearTimeout (1000);});
   		 t.popTradeRoutes.centerMe (mainPop.getMainDiv());
   		}
   		var m = '<DIV style="max-height:460px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbTab" id="pbRoutesQueue">';       
   		t.popTradeRoutes.getMainDiv().innerHTML = '</table></div>' + m;
   		t.popTradeRoutes.getTopDiv().innerHTML = '<div class=showBadged><center>ROUTES OF TRANSPORTATION</center></div>';
   		t.paintTradeRoutes();
   		t.popTradeRoutes.show(true)	;
   	},
	paintTradeRoutes: function(){
	        var t = Tabs.TranspAuto;  
	        var r = t.tradeRoutes;
	        var cityname;
	        var citynameTo = null;
	    var m= '<TABLE id=paintRoutes class=pbTab>'; 
			for (var i=0;i<(r.length);i++) {
			  citynameTo = null;
				for (var y=0; y< Seed.cities.length;y++) {
					if ( parseInt(Seed.cities[y][0]) == r[i].city) var cityname = Seed.cities[y][1];
					if ( parseInt(Seed.cities[y][2]) == r[i].target_x && parseInt(Seed.cities[y][3]) == r[i].target_y) var citynameTo = Seed.cities[y][1];
				}    
				var queueId = i;
				if (citynameTo == null) var TO = r[i].target_x +','+ r[i].target_y;
				else TO = citynameTo;
				if (r[i].route_state) var status = '<FONT color=green>activated</font>';
				else var status = '<FONT color=red>Disabled</font>';
				if (r[i].TroopType == undefined) var unit = 'unt9';
        else var unit = r[i].TroopType;
				m += '<TR><TD TD width=12px>&nbsp;&nbsp;</td></tr>';
        m +='<TR><TD width=20px>'+(i+1)+'</td><TD width=175px>Desde:&nbsp;&nbsp;'+ cityname +'</TD><TD width=175px>A:&nbsp;&nbsp;'+ TO +'</td><TD width=175px>'+status+'</td>';
        m +='<TD width=60px><A onclick="traceEdit('+queueId+')">Show</a></td><TD width=60px><A onclick="traceDelete('+queueId+')">delete</a></td></tr>';
        m += '<TR><TD></td><TD>troops:&nbsp;&nbsp;'+unsafeWindow.unitcost[unit][0]+'</td></tr>';
        if (r[i].ship_Food) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png"></td><TD>Mantener: '+ addCommas(r[i].target_Food) +'</td><TD>Transportar: '+ addCommas(r[i].trade_Food)+'</td>';
				if (r[i].ship_Wood) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png"></td><TD>mantener: '+ addCommas(r[i].target_Wood) +'</td><TD>Transportar: '+ addCommas(r[i].trade_Wood)+'</td>';
				if (r[i].ship_Stone) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png"></td><TD>Mantener: '+ addCommas(r[i].target_Stone) +'</td><TD>Transportar: '+ addCommas(r[i].trade_Stone)+'</td>';
				if (r[i].ship_Ore) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png"></td><TD>Mantener: '+ addCommas(r[i].target_Ore) +'</td><TD>Transportar: '+ addCommas(r[i].trade_Ore)+'</td>';
                                if (r[i].ship_Astone) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png"></td><TD>Mantener: '+ addCommas(r[i].target_Astone) +'</td><TD>Transportar: '+ addCommas(r[i].trade_Astone)+'</td>';
				if (r[i].ship_Gold) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png"></td><TD>Mantener: '+ addCommas(r[i].target_Gold) +'</td><TD>Transportar: '+ addCommas(r[i].trade_Gold)+'</td>';
       }
	     m +='</table>';
   	     ById('pbRoutesQueue').innerHTML= m; 
          unsafeWindow.traceEdit = t.editQueueElement;
          unsafeWindow.traceDelete = t.cancelQueueElement;
   	    },
   	  
   	 cancelQueueElement: function(queueId){
   	     var t = Tabs.TranspAuto;
   	     var queueId = parseInt(queueId);
   	     t.tradeRoutes.splice(queueId, 1);
   	     t.showTradeRoutes();
   	 },
   	 
   	 editQueueElement: function(queueId){
   	     var t = Tabs.TranspAuto;
   	     var r = t.tradeRoutes;
          var queueId = parseInt(queueId);
   	     var cityname;
   	     var citynameTo = null;
   	     var Types = ['food','wood','stone','iron','aetherstone','gold'];
   	     for (var y=0; y< Seed.cities.length;y++) {
   					if ( parseInt(Seed.cities[y][0]) == r[queueId].city) var cityname = Seed.cities[y][1];
   					if ( parseInt(Seed.cities[y][2]) == r[queueId].target_x && parseInt(Seed.cities[y][3]) == r[queueId].target_y) var citynameTo = Seed.cities[y][1];
   			 }
          if (citynameTo == null) var TO = r[queueId].target_x +','+ r[queueId].target_y;
   			 else TO = citynameTo; 
          var n = '<TABLE id=editRoutes class=pbTab>';
   	     n +='<TD>Desde :&nbsp;'+ cityname +'</td><TD>A :&nbsp;'+ TO +'</td>';
   	     n +='<TD><INPUT id=TradeStatus type=checkbox>&nbsp;Activar la ruta</td>';
   	     n += '<TD width=150px>'+uW.g_js_strings.commonstr.troops+' :<SELECT id="pbbTransportTroop">';
          for (y in unsafeWindow.unitcost) n+='<option value="'+y+'">'+unsafeWindow.unitcost[y][0]+'</option>';
          n+='</select></td></table><BR><TABLE  id=editRoutes class=pbTab>';
          for (var i=0;i<Types.length;i++){
   	    var icon = Types[i];
            n += '<TR><TD width=50px align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/'+icon+'_30.png"></td>';
            n += '<TD width=50px align=center><INPUT id=pbbship'+Types[i]+' type=checkbox></td>';
            n += '<TD width=125px>maintain : <INPUT id=pbbtargetamount'+Types[i]+' type=text size=11 maxlength=12 value="0"></td>';
            n += '<TD width=125px>Transporter : <INPUT id=pbbtradeamount'+Types[i]+' type=text size=11 maxlength=12 value="0"\></td></tr>';
          }
          n+='</table><BR><TABLE id=editRoutes class=pbTab><TR><TD><a class="button20" id="Cancel"><span>'+uW.g_js_strings.commonstr.cancel+'</span></a></td>';
          n+='<TD><a class="button20" id="Save"><span>save</span></a></td></tr>';
          n +='</table>';
          
          ById('pbRoutesQueue').innerHTML= n;
          ById('TradeStatus').checked = r[queueId].route_state;
          if (r[queueId].TroopType == undefined) var unit = 'unt9';
          else var unit = r[queueId].TroopType;
          ById('pbbTransportTroop').value = unit;
	         ById('pbbshipfood').checked = r[queueId].ship_Food;
	         ById('pbbshipwood').checked = r[queueId].ship_Wood;
	         ById('pbbshipstone').checked = r[queueId].ship_Stone;
	         ById('pbbshipiron').checked = r[queueId].ship_Ore;
	  	   ById('pbbshipaetherstone').checked = r[queueId].ship_Astone;
	         ById('pbbshipgold').checked = r[queueId].ship_Gold;
	         ById('pbbtargetamountfood').value = r[queueId].target_Food;
	         ById('pbbtargetamountwood').value = r[queueId].target_Wood;
	         ById('pbbtargetamountstone').value = r[queueId].target_Stone;
	         ById('pbbtargetamountiron').value = r[queueId].target_Ore;
	  	   ById('pbbtargetamountaetherstone').value = r[queueId].target_Astone;
	         ById('pbbtargetamountgold').value = r[queueId].target_Gold;
	         ById('pbbtradeamountfood').value = r[queueId].trade_Food;
	         ById('pbbtradeamountwood').value = r[queueId].trade_Wood;
	         ById('pbbtradeamountstone').value = r[queueId].trade_Stone;
	         ById('pbbtradeamountiron').value = r[queueId].trade_Ore;
	  	   ById('pbbtradeamountaetherstone').value = r[queueId].trade_Astone;
	         ById('pbbtradeamountgold').value = r[queueId].trade_Gold;
	         ById('Cancel').addEventListener('click', function(){t.showTradeRoutes();}, false);
	         ById('Save').addEventListener('click', function(){
	              r[queueId].route_state = ById('TradeStatus').checked;
	              r[queueId].TroopType = ById('pbbTransportTroop').value;
	              r[queueId].ship_Food = ById('pbbshipfood').checked;
	              r[queueId].ship_Wood = ById('pbbshipwood').checked;
	              r[queueId].ship_Stone = ById('pbbshipstone').checked;
	              r[queueId].ship_Ore = ById('pbbshipiron').checked;
	  			r[queueId].ship_Astone = ById('pbbshipaetherstone').checked;
	              r[queueId].ship_Gold = ById('pbbshipgold').checked;
	              r[queueId].target_Food = ById('pbbtargetamountfood').value;
	              r[queueId].target_Wood = ById('pbbtargetamountwood').value;
	              r[queueId].target_Stone = ById('pbbtargetamountstone').value;
	              r[queueId].target_Ore = ById('pbbtargetamountiron').value;
	  			r[queueId].target_Astone = ById('pbbtargetamountaetherstone').value;
	              r[queueId].target_Gold = ById('pbbtargetamountgold').value;
	              r[queueId].trade_Food = ById('pbbtradeamountfood').value;
	              r[queueId].trade_Wood = ById('pbbtradeamountwood').value;
	              r[queueId].trade_Stone = ById('pbbtradeamountstone').value;
	              r[queueId].trade_Ore = ById('pbbtradeamountiron').value;
	  			r[queueId].trade_Astone = ById('pbbtradeamountaetherstone').value;
	              r[queueId].trade_Gold = ById('pbbtradeamountgold').value;
	              t.showTradeRoutes();
	          }, false);
	 },
   	   
   	saveTradeRoutes: function(){
   		var t = Tabs.TranspAuto;
           var serverID = getServerId();
           GM_setValue('tradeRoutes_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(t.tradeRoutes));
       },
     readTradeRoutes: function(){
           var t = Tabs.TranspAuto;
           var serverID = getServerId();
           s = GM_getValue('tradeRoutes_' + Seed.player['name'] + '_' +serverID);
           if (s != null) {
               route = JSON2.parse(s);
               for (k in route)
                   t.tradeRoutes[k] = route[k];
           }
       },
   	saveTraderState: function(){
   		var t = Tabs.TranspAuto;
           var serverID = getServerId();
           GM_setValue('traderState_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(t.traderState));
       },
       readTraderState: function(){
           var t = Tabs.TranspAuto;
           var serverID = getServerId();
           s = GM_getValue('traderState_' + Seed.player['name'] + '_' +serverID);
           if (s != null) {
               state = JSON2.parse(s);
               for (k in state)
                   t.traderState[k] = state[k];
           }
       },
       toggleTraderState: function(obj){
   	   var t = Tabs.TranspAuto;
   	   obj = ById('pbTraderState');
           if (t.traderState.running == true) {
               t.traderState.running = false;
               if (obj)  obj.value = "Transporter = OFF";
   	       updatebotbutton('Trp-OFF', 'pbtrantab');
   	       clearTimeout(t.checkdotradetimeout);
   	       t.count = 0;
   	       Options.lasttransport = 0;
	       saveOptions();
           }
           else {
               t.traderState.running = true;
               if (obj) obj.value = "Transporter = ON";
   		updatebotbutton('Trp-ON', 'pbtrantab');
   			t.e_tradeRoutes();
           }
       },
   	
   	checkdoTrades: function(){
   	var t = Tabs.TranspAuto;
   	if(t.tradeRoutes.length==0) return;
   	t.doTrades(t.count);
   	t.count++;
   	if(t.count < t.tradeRoutes.length){
   			  t.checkdotradetimeout = setTimeout(function() { t.checkdoTrades();}, 5000);
   			} else {
   			  var now = new Date().getTime()/1000.0;
   			  now = now.toFixed(0);
   			  Options.lasttransport = now;
   			  saveOptions();	
   			  t.count = 0;
   			}
   	},
       
     doTrades: function(count){
       var t = Tabs.TranspAuto;
   
      	if(t.tradeRoutes.length==0) return;
      	if(!t.tradeRoutes[count]["route_state"]) return;
      	
      	var city = t.tradeRoutes[count]["city"];
      	if(!Cities.byID[city]) return;
	   		
	var xcoord = t.tradeRoutes[count]["target_x"];
       	var ycoord = t.tradeRoutes[count]["target_y"];
   	var cityID = 'city' + city;
   	for (var zz=0; zz< Seed.cities.length;zz++) {
	   if (parseInt(Seed.cities[zz][0]) == city) 
	      var cityname = Seed.cities[zz][1];
	}                     
   		
      	var rallypointlevel = t.getRallypoint(cityID);
	if(rallypointlevel == 12) rallypointlevel = 11;
        var slots = 0;
	for (var k in Seed.queue_atkp[cityID]){   
	         	         march = Seed.queue_atkp[cityID][k];
	         	         if (typeof (march) == 'object'){
	         	           slots++;
	         	         }
	}
	if(slots >= rallypointlevel){
	      		actionLog("Transport","transport"+cityname+" vers " + xcoord + "," + ycoord + " <font color=red>Full rallying point !</font>");
	      		return;
        }
      	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   		params.gold =0;
   		params.r1 =0;
   		params.r2 =0;
   		params.r3 =0;
   		params.r4 =0 ;
   		params.r5 =0 ;
   		params.kid = 0;
   		
   		var carry_amount= 0;
   		var wagons_needed=0;
   		var citymax = 0;
   		
   		

       	var trade_Food = t.tradeRoutes[count]["trade_Food"];
       	var trade_Wood = t.tradeRoutes[count]["trade_Wood"];
       	var trade_Stone = t.tradeRoutes[count]["trade_Stone"];
       	var trade_Ore = t.tradeRoutes[count]["trade_Ore"];
   	var trade_Astone = t.tradeRoutes[count]["trade_Astone"];
       	var trade_Gold = t.tradeRoutes[count]["trade_Gold"];
       	var target_Food = t.tradeRoutes[count]["target_Food"];
       	var target_Wood = t.tradeRoutes[count]["target_Wood"];
       	var target_Stone = t.tradeRoutes[count]["target_Stone"];
       	var target_Ore = t.tradeRoutes[count]["target_Ore"];
   		var target_Astone = t.tradeRoutes[count]["target_Astone"];
       	var target_Gold = t.tradeRoutes[count]["target_Gold"];
       	var ship_Food = t.tradeRoutes[count]["ship_Food"];
       	var ship_Wood = t.tradeRoutes[count]["ship_Wood"];
       	var ship_Stone = t.tradeRoutes[count]["ship_Stone"];
       	var ship_Ore = t.tradeRoutes[count]["ship_Ore"];
   		var ship_Astone = t.tradeRoutes[count]["ship_Astone"];
       	var ship_Gold = t.tradeRoutes[count]["ship_Gold"];
       	var citymax_Food = parseIntNan(Seed.resources[cityID]['rec1'][0] / 3600);
       	var citymax_Wood = parseIntNan(Seed.resources[cityID]['rec2'][0] / 3600);
       	var citymax_Stone = parseIntNan(Seed.resources[cityID]['rec3'][0] / 3600);
       	var citymax_Ore = parseIntNan(Seed.resources[cityID]['rec4'][0] / 3600);
   		var citymax_Astone = parseIntNan(Seed.resources[cityID]['rec5'][0]);
       	var citymax_Gold = parseIntNan(Seed.citystats[cityID]['gold']);
       	var carry_Food = parseIntNan(citymax_Food - target_Food);
       	var carry_Wood = parseIntNan(citymax_Wood - target_Wood);
       	var carry_Stone = parseIntNan(citymax_Stone - target_Stone);
       	var carry_Ore = parseIntNan(citymax_Ore - target_Ore);
   		var carry_Astone = parseIntNan(citymax_Astone - target_Astone);
       	var carry_Gold = 0;
       	if (carry_Food < 0 || ship_Food==false) carry_Food = 0;
       	if (carry_Wood < 0 || ship_Wood==false) carry_Wood = 0;
       	if (carry_Stone < 0 || ship_Stone==false) carry_Stone = 0;
       	if (carry_Ore < 0 || ship_Ore==false) carry_Ore = 0;
   		if (carry_Astone < 0 || ship_Astone==false) carry_Astone = 0;
       	if (trade_Food > 0 && (carry_Food > trade_Food)) carry_Food = parseIntNan(trade_Food);
       	if (trade_Wood > 0 && (carry_Wood > trade_Wood)) carry_Wood = parseIntNan(trade_Wood);
       	if (trade_Stone > 0 && (carry_Stone > trade_Stone)) carry_Stone = parseIntNan(trade_Stone);
       	if (trade_Ore > 0 && (carry_Ore > trade_Ore)) carry_Ore = parseIntNan(trade_Ore);
   	if (trade_Astone > 0 && (carry_Astone > trade_Astone)) carry_Astone = parseIntNan(trade_Astone);
   		carry_Astone *= 5;         
         if (t.tradeRoutes[count]['TroopType'] == undefined) var wagons = parseInt(Seed.units[cityID]['unt'+ 9]); 
         else var wagons =  parseInt(Seed.units[cityID][t.tradeRoutes[count]['TroopType']]);
         var rallypointlevel = t.getRallypoint(cityID);	
   		  if (rallypointlevel == 11) rallypointlevel = 15;
   		  if (rallypointlevel == 12) rallypointlevel = 20;
       	if (parseInt(wagons) > parseInt(rallypointlevel*10000)){ wagons = (rallypointlevel*10000); }   	
         if (t.tradeRoutes[count]['TroopType'] == undefined) var unit = 'unt9';
         else var unit = t.tradeRoutes[count]['TroopType'];
         var Troops = parseInt(Seed.units[cityID][unit]);
   	  if(parseInt(Troops)>parseInt(wagons)) Troops = wagons;
         var featherweight = parseInt(Seed.tech.tch10);
       	var Load = parseInt(unsafeWindow.unitstats[unit]['5'])
         var maxloadperwagon = (featherweight * ((Load/100)*10)) + Load;
   		  var maxload = (maxloadperwagon * Troops);
   		  if(wagons <= 0) {return; }
   		  var shift_Food = parseIntNan(maxload / 9);
   		  var shift_Wood = parseIntNan(maxload / 9);
   		  var shift_Stone = parseIntNan(maxload / 9);
   		  var shift_Ore = parseIntNan(maxload / 9);
   		  var shift_Astone = parseIntNan(maxload / 9 * 5); 	
   		  if ((maxload - carry_Food - carry_Wood - carry_Stone - carry_Ore - carry_Astone) < 0){
   			 var shift_num=0;
   			 var shift_spare=0;
   			if (carry_Food < shift_Food) {
   				shift_spare += (shift_Food - carry_Food);
   				shift_Food = carry_Food;
   			}
   			if (carry_Wood < shift_Wood) {
   				shift_spare += (shift_Wood - carry_Wood);
   				shift_Wood = carry_Wood;	
   			}
   			if (carry_Stone < shift_Stone) {
   				shift_spare += (shift_Stone - carry_Stone);
   				shift_Stone = carry_Stone;
   			}
   			if (carry_Ore < shift_Ore) {
   				shift_spare += (shift_Ore - carry_Ore);
   				shift_Ore = carry_Ore;
   			}
               if (carry_Astone < shift_Astone) {
   				shift_spare += (shift_Astone - carry_Astone);
   				shift_Astone = carry_Astone;
   			}						
   			 
   		  while (shift_spare >1) {
   				 if (carry_Food < (shift_Food + shift_spare)){
   				    shift_spare = shift_spare - carry_Food;;
   				    shift_Food = carry_Food;
   				 }
   				 else{
   				  shift_Food = (shift_Food + shift_spare);
   				  shift_spare = shift_spare- shift_spare;
   				}
   				 if (carry_Wood < (shift_Wood + shift_spare)){
   				    shift_spare = shift_spare - carry_Wood;;
   				    shift_Wood = carry_Wood;
   				 }
   				 else{
   				  shift_Wood = shift_Wood + shift_spare;
   				  shift_spare = shift_spare- shift_spare;
   				}
           		if (carry_Stone < (shift_Stone + shift_spare)){
   				    shift_spare = shift_spare - carry_Stone;
   				    shift_Stone = carry_Stone;
   				 }
   				 else{
   				  shift_Stone = shift_Stone + shift_spare;
   				  shift_spare = shift_spare- shift_spare;
   				}
   				 if (carry_Ore < (shift_Ore + shift_spare)){
   				    shift_spare = shift_spare - carry_Ore;
   				    shift_Ore = carry_Ore;
   				 }
   				 else{
   				  shift_Ore = shift_Ore + shift_spare;
   				  shift_spare = shift_spare- shift_spare;
   				}
   				if (carry_Astone < (shift_Astone + shift_spare)){
   				    shift_spare = shift_spare - carry_Astone;
   				    shift_Astone = carry_Astone;
   				 }
   				 else{
   				  shift_Astone = shift_Astone + shift_spare;
   				  shift_spare = shift_spare- shift_spare;
   				}
   			 }
   
   		carry_Food = shift_Food;
   		carry_Wood = shift_Wood;
   		carry_Stone = shift_Stone;
   		carry_Ore = shift_Ore;
   		carry_Astone = shift_Astone;
   		}
   		
   		if (maxload > (carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone) && ship_Gold==true) {
   		    if ((maxload-(carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone)) > (citymax_Gold - target_Gold)){
   		    	  carry_Gold = (citymax_Gold - target_Gold);
   		    	  if (carry_Gold < 0 ) carry_Gold = 0;
   		   	}
   		    else carry_Gold = (maxload-(carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone));
   		    if (trade_Gold > 0 && (carry_Gold > trade_Gold)) carry_Gold = parseInt(trade_Gold);
   		}
   		
   		wagons_needed = ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) / maxloadperwagon);
   		wagons_needed = wagons_needed.toFixed(0);	
   		if (wagons_needed < ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) / maxloadperwagon)) wagons_needed++;	
   		if ( wagons_needed < Options.minwagons ) { return; }
           
   		params.cid= city;
   		params.type = "1";
   		params.xcoord = xcoord;
   		params.ycoord = ycoord;
   		params.r1 = carry_Food;
   		params.r2 = carry_Wood;
   		params.r3 = carry_Stone;
   		params.r4 = carry_Ore;
   		params.r5 = parseInt(carry_Astone/5);
   		params.gold = carry_Gold;
   		
   		switch (unit){
         case 'unt1': params.u1 = wagons_needed;break;
         case 'unt2': params.u2 = wagons_needed;break;
         case 'unt3': params.u3 = wagons_needed;break;
         case 'unt4': params.u4 = wagons_needed;break;
         case 'unt5': params.u5 = wagons_needed;break;
         case 'unt6': params.u6 = wagons_needed;break;
         case 'unt7': params.u7 = wagons_needed;break;
         case 'unt8': params.u8 = wagons_needed;break;
         case 'unt9': params.u9 = wagons_needed;break;
         case 'unt10': params.u10 = wagons_needed;break;
         case 'unt11': params.u11 = wagons_needed;break;
         case 'unt12': params.u12 = wagons_needed;break;
       }
      if ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) > 0) {
    
            new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
                     method: "post",
                     parameters: params,
                     loading: true,
                     onSuccess: function (transport) {
                     var rslt = eval("(" + transport.responseText + ")");
                     if (rslt.ok) {
                     var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
                     var ut = unsafeWindow.unixtime();
                     var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
                     for(i = 0; i <= unitsarr.length; i++){
                     	if(params["u"+i]){
                     	unitsarr[i] = params["u"+i];
                     	}
                     }
                     var resources=new Array();
                     resources[0] = params.gold;
                     for(i=1; i<=5; i++){
                     	resources[i] = params["r"+i];
                     }
                     var currentcityid = city;
                     unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
                     unsafeWindow.update_seed(rslt.updateSeed)
                     if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
                      actionLog("Transport","for: " + cityname + " Vers : " + xcoord + ',' + ycoord + "  -> "+ unsafeWindow.unitcost[unit][0] +": " + wagons_needed);
                     } else {
			actionLog("Transport","for: " + cityname + " Vers : " + xcoord + ',' + ycoord + "<br><font color=red>" + transport.responseText + "</font>");
                     }
                     },
                     onFailure: function (transport) {
                     var rslt = eval("(" + transport.responseText + ")");
                     if (rslt.user_action) {
		     						actionLog("Transport","<b><font color=red>Detection Captcha</font></b>");
		     						new CdialogCancelContinue('<SPAN class=boldRed>CAPTCHA ALERT ! Trop marches ! - TRANSPORTAUTO</span>', null, null, mainPop.getMainDiv);
		     }else{		
                      actionLog("Transport","for: " + cityname + " Vers : " + xcoord + ',' + ycoord + "<br><font color=red>" + transport.responseText + "</font>");
                     }
                     }
             });
           }
   	},
   	
   ManualTransport: function(){
       var t = Tabs.TranspAuto;
 
    if (document.getElementById ('ptcityX').value == "" || document.getElementById ('ptcityY').value == "") return;
    if ( t.TroopsNeeded > t.Troops) return;
       
      	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
       var unitType = ById('TransportTroop').value;
      // var LoadUnit = (parseInt(Seed.tech.tch10) * ((parseInt(unsafeWindow.unitstats[unitType]['5'])/100)*10)) + parseInt(unsafeWindow.unitstats[unitType]['5']);
        	     var untid=ById('TransportTroop').value;
       	     var techLoadBoost=parseInt(Seed.tech.tch10)*0.1;
       	     var loadEffectBoost=0;
       	     if(Seed.playerEffects.loadExpire>uW.unixtime()){loadEffectBoost=0.25}
       	     var loadBoostBase=(uW.cm.ThroneController.effectBonus(6)*0.01)+loadEffectBoost+techLoadBoost;
       	     var loadBoost=loadBoostBase;
       	     if(uW.cm.unitFrontendType[untid]=="siege"){
       	      //loadBoost+=(uW.cm.ThroneController.effectBonus(59)*0.01)
       	     }else{
       	      if(uW.cm.unitFrontendType[untid]=="horsed"){
       	       loadBoost+=(uW.cm.ThroneController.effectBonus(48)*0.01)
       	      }
          	 }
       	  var LoadUnit=parseInt(parseInt(uW.unitstats[untid][5])*(1+loadBoost));
       var MaxLoad =  parseInt(Seed.units['city' + t.tcp.city.id][unitType]) * LoadUnit;
       document.getElementById ('errorSpace').innerHTML = '';
         	
   	params.kid = 0;
        params.cid=  t.tcp.city.id;
   	params.type = "1";
   	params.xcoord = parseInt(document.getElementById ('ptcityX').value);
   	params.ycoord = parseInt(document.getElementById ('ptcityY').value);
   	params.r1 = parseInt(document.getElementById ('pbtradeamountFood').value);
   	params.r2 = parseInt(document.getElementById ('pbtradeamountWood').value);
   	params.r3 = parseInt(document.getElementById ('pbtradeamountStone').value);
   	params.r4 = parseInt(document.getElementById ('pbtradeamountOre').value);
   	params.r5 = parseInt(document.getElementById ('pbtradeamountAstone').value);
   	params.gold = parseInt(document.getElementById ('pbtradeamountGold').value);
   		
       switch (unitType){
         case 'unt1': params.u1 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt2': params.u2 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt3': params.u3 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt4': params.u4 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt5': params.u5 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt6': params.u6 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt7': params.u7 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt8': params.u8 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt9': params.u9 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt10': params.u10 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt11': params.u11 = parseInt(document.getElementById ('TroopsToSend').value);break;
         case 'unt12': params.u12 = parseInt(document.getElementById ('TroopsToSend').value);break;
       }
   
       if ((params.r1 + params.r2 + params.r3 + params.r4 + params.r5 + params.gold) > 0) {   
            new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
                     method: "post",
                     parameters: params,
                     loading: true,
                     onSuccess: function (transport) {
                     var rslt = eval("(" + transport.responseText + ")");
                     if (rslt.ok) {                  
   		                  var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
   		                  var ut = unixTime();
   		                  var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
   		                  for(i = 0; i <= unitsarr.length; i++){
   		                  	if(params["u"+i]){
   		                  	unitsarr[i] = params["u"+i];
   		                  	}
   		                  }
   		                  var resources=new Array();
   		                  resources[0] = params.gold;
   		                  for(i=1; i<=5; i++){
   		                  	resources[i] = params["r"+i];
   		                  }
   		                  var currentcityid = t.tcp.city.id;
   		                  unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
   		                  if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
   		                  document.getElementById ('errorSpace').innerHTML = 'Enviados ' + addCommas(params.r1+params.r2+params.r3+params.r4+params.r5+params.gold) + ' resources ' + addCommas(parseInt(document.getElementById ('TroopsToSend').value)) + ' ' + unsafeWindow.unitcost[unitType][0];
   		                  document.getElementById ('pbtradeamountFood').value = 0;
   		                  document.getElementById ('pbtradeamountWood').value = 0;
   		                  document.getElementById ('pbtradeamountStone').value = 0;
   		                  document.getElementById ('pbtradeamountOre').value = 0;
   						  document.getElementById ('pbtradeamountAstone').value = 0;
   		                  document.getElementById ('pbtradeamountGold').value = 0;
   		                  document.getElementById ('TroopsToSend').value = 0;
                     } else {
   		                  var errorcode =  'err_' + rslt.error_code;
   		                  if (rlst.msg == undefined)document.getElementById ('errorSpace').innerHTML = '<HR><FONT COLOR=red>Error: ' + unsafeWindow.g_js_strings.errorcode[errorcode] +'</font>';
   		                  else document.getElementById ('errorSpace').innerHTML = '<HR><FONT COLOR=red>Erreur : ' + rslt.msg +'</font>'; 
                     }
                     },
                     onFailure: function () {}
             });
           }
   	},
	
  onUnload: function(){
     var t = Tabs.TranspAuto;
     if (!ResetAll) t.saveTradeRoutes();
     if (!ResetAll) t.saveTraderState();
     if (!ResetAll) t.saveReapproState();
  },
  showManuel : function() {
   var t = Tabs.TranspAuto
   var rownum = 0;

   var ModelCity = {};
   
   function _row (name, row, noTotal){
      if (rownum++ % 2)
        style = '';
      else
        style = ' style = "background: #e8e8e8"';
      var tot = 0;
      var m = [];
      m.push ('<TR style="background: #fff" align=right');
      m.push (style);
      m.push ('><TD');
      m.push (style);
      m.push ('><B>');
      m.push (name);
      m.push ('</td>');
      if (noTotal){
        m.push ('<TD');
        m.push (style);
        m.push ('>&nbsp;</td>');
      } else {
        for (i=0; i<row.length; i++)
          tot += row[i];
        m.push ('<TD style="background: #ffc">');
        m.push (addCommas(tot));
        m.push ('</td>');
      }
      for (i=0; i<row.length; i++){
        m.push ('<TD');
        m.push (style);
        m.push ('>');
        m.push (addCommas(row[i]));
        m.push ('</td>');
      }
      m.push ('</tr>');
      return m.join('');
    }
    dt = new Date ();
    dt.setTime (Seed.player.datejoinUnixTime * 1000);
    if (t.state == null) {  
      m = "<DIV class=pbStat>TRANSPORT MANUAL</div>";
      m += "<div id=ptTranportStatus style='text-align:center;overflow-y:auto; max-height:78px;'></div>";
      m += "<TABLE width=100% class=pbTab border=0>\
       <tr align=center><td colspan=2><HR></td></tr>\
       <tr align=center valign=top><td colspan=1 width=50%><b><u>Origen</b></u><br><span id=srcptspeedcity></span></td>\
       <td colspan=1 width=50%  rowspan=2><b><u>destination</b></u><br><span id=desptspeedcity></span><br>\
       O Put target coordinates <br>X: <input type=text size=4 id=typetrpx value=0>&nbsp;Y: <input type=text size=4 id=typetrpy value=0><br><a href='javascript:void(0);' id='chargelistelieux'>members</a> : <select id='BOlisteFavori'></select><br><br><INPUT id='ptttButTransport' type=submit value='Transporter' style='font-weight:bold'>\
       </td></tr>\
       <tr align=center><td colspan=1>troop type: <select id=typetrp><option selected value='1'>Supply troops</option><option selected value='9'>supply wagons</option><option value='7'>cavalry</option><option value='8'>heavy cavalry</option></select>\
       <br>troops: <input type=text size=6 value='1000' id='Choixnbwagon'><input type=button id='trswagmax' value='Max'\><br><i>(The amount is the maximum transport of troops selected)</i>\
       <br><b>resources :</b><input type=radio id='ChoixRess0' name='ChoixRess' value='gold' style='visibility:hidden'><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png onclick=document.getElementById('ChoixRess0').checked=true;BOestimeres(); height=20>\
       <input type=radio id='ChoixRess1' name='ChoixRess' value='rec1' style='visibility:hidden'><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png onclick=document.getElementById('ChoixRess1').checked=true;BOestimeres(); height=20>\
       <input type=radio id='ChoixRess2' name='ChoixRess' value='rec2' style='visibility:hidden'><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png onclick=document.getElementById('ChoixRess2').checked=true;BOestimeres(); height=20>\
       <input type=radio id='ChoixRess3' name='ChoixRess' value='rec3' style='visibility:hidden'><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png onclick=document.getElementById('ChoixRess3').checked=true;BOestimeres(); height=20>\
       <input type=radio id='ChoixRess4' name='ChoixRess' value='rec4' style='visibility:hidden'><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png onclick=document.getElementById('ChoixRess4').checked=true;BOestimeres(); height=20>\
       <input type=radio id='ChoixRess5' name='ChoixRess' value='rec5' style='visibility:hidden'><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png onclick=document.getElementById('ChoixRess5').checked=true;BOestimeres(); height=20>\
       </td></tr>\
       <tr><td colspan=2>Estimate of what can be transported : <span id=BOEstimationR></td></tr>\
       </table><div class='pbStat'>TRANSPORT STATISTICS</div><div id='statpourTr'></div>";
    t.TransportDiv.innerHTML = m; 
    t.destinationCityx = document.getElementById ('typetrpx');
    t.destinationCityy = document.getElementById ('typetrpy');
    
    t.destinationCityx.addEventListener ('change', t.estimerRes, false);
    t.destinationCityy.addEventListener ('change', t.estimerRes, false);
    document.getElementById ('ChoixRess0').addEventListener ('click', t.estimerRes, false);
    document.getElementById ('ChoixRess1').addEventListener ('click', t.estimerRes, false);
    document.getElementById ('ChoixRess2').addEventListener ('click', t.estimerRes, false);
    document.getElementById ('ChoixRess3').addEventListener ('click', t.estimerRes, false);
    document.getElementById ('ChoixRess4').addEventListener ('click', t.estimerRes, false);
    document.getElementById ('ChoixRess5').addEventListener ('click', t.estimerRes, false);     
    t.listeFavoris = document.getElementById ('BOlisteFavori');
    t.estimationRes = document.getElementById ('BOEstimationR');
    t.chargelistelieux = document.getElementById ('chargelistelieux');
    t.chargelistelieux.addEventListener ('click', t.chercherFavoris, false);
    t.listeFavoris.addEventListener ('change', t.SelectFavoris, false);   
    var dcp1 = new CdispCityPicker ('ptspeed1', ById('desptspeedcity'), false, t.clickCityDestinationSelect, 1);
    t.TTbutTransport = document.getElementById ('ptttButTransport');
    t.TTbutTransport.addEventListener ('click', t.clickTransportDo, false);
    t.divTranportStatus = document.getElementById ('ptTranportStatus');
    t.statpourTr = document.getElementById ('statpourTr');
    t.typetrp = document.getElementById ('typetrp');
    t.typetrp.addEventListener ('click', t.estimerRes, false); 
    t.trswagmax = document.getElementById ('trswagmax');
    t.trswagmax.addEventListener ('click', t.clickUniteMax, false);
    t.Choixnbwagon  = document.getElementById ('Choixnbwagon');
    t.Choixnbwagon.addEventListener ('keyup', t.verifierWagons, false);
    var dcp0 = new CdispCityPicker ('ptspeed0', ById('srcptspeedcity'), false, t.clickCitySourceSelect, Cities.byID[unsafeWindow.currentcityid].idx);
    t.state = 1;
   }
   if (t.state == 1) {
    if (document.getElementById ('maparea_map').style.display!="none") {
       t.destinationCityx.value = document.getElementById ('mapXCoor').value;
       t.destinationCityy.value = document.getElementById ('mapYCoor').value;
       t.destinationCityx.style.backgroundColor="#FF9999";
       t.destinationCityy.style.backgroundColor="#FF9999";
       setTimeout(function() {
             t.destinationCityx.style.backgroundColor="#fff";
       t.destinationCityy.style.backgroundColor="#fff";
       }, 3000);
                    
    }
    t.state = 2;
   }
   rows=[];
   rows[0]=[];
   m = "<TABLE class=ptTabLined cellspacing=0><TR valign=top align=right><TD width=65></td><TD width=88 style='background: #ffc'><B>TOTAL</b></td>";
      for(i=0; i<Cities.numCities; i++)
         m += '<TD width=81><B>'+ Cities.cities[i].name.substring(0,10) +'</b></td>';
      for(i=0; i<Cities.numCities; i++) {
        cityID = 'city'+ Cities.cities[i].id;
        rows[0][i] = parseInt(Seed.citystats[cityID].gold[0]);
      }
      for (r=1; r<6; r++){
        rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
           if (r==5)
	    rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0]);
	            else
           rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0] / 3600);
        }
      }
      m += _row ('<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png>', rows[0]);
      m += _row ('<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png>', rows[1]);
      m += _row ('<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png>', rows[2]);
      m += _row ('<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png>', rows[3]);
      m += _row ('<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png>', rows[4]);
      m += _row ('<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png>', rows[5]);
      m += '<TR><TD><font size=1><BR></td></tr>';
      row = [];
      var totalbouffe = 0;
      for(i=0; i<Cities.numCities; i++) {
	var rp = getResourceProduction (Cities.cities[i].id);
	var usage = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
	row[i] = rp[1] - usage;
      }
      m += _row ('Prod.Alim.', row, false,  0);
      for(i=0; i<Cities.numCities; i++) {
                    if (row[i] >= 0)
                      row[i] = '----';
                    else {
                      var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-row[i]) * 3600;
                      if (timeLeft > 86313600)
                        row[i] = '----';
                      else {
                        if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600))
                          row[i] = '<SPAN class=whiteOnRed>'+ timestrShort(timeLeft) +'</span>';
                        else
                          row[i] = timestrShort(timeLeft);
                      }
                    }
      }    
      m += _row ('Restante', row, true, 0);
      m += '<TR><TD><font size=1><BR></td></tr>';
      for (r=1; r<13; r++){
        rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
          rows[r][i] = parseInt(Seed.units[cityID]['unt'+r]);
        }
      }
      m += _row ('<img height=20 title="'+unsafeWindow.unitcost['unt1'][0]+'" src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_30_s34.jpg>', rows[1]);
      m += _row ('<img height=20 title="'+unsafeWindow.unitcost['unt7'][0]+'" src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_30_s34.jpg>', rows[7]);
      m += _row ('<img height=20 title="'+unsafeWindow.unitcost['unt8'][0]+'" src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_30_s34.jpg>', rows[8]);
      m += _row ('<img height=20 title="'+unsafeWindow.unitcost['unt9'][0]+'" src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_30_s34.jpg>', rows[9]);
          row = [];
    for(i=0; i<Cities.numCities; i++) {
    	        var cityId = 'city'+ Cities.cities[i].id;
    	        var slots = 0;
    	        for (var k in Seed.queue_atkp[cityId]){   
    	         march = Seed.queue_atkp[cityId][k];
    	         if (typeof (march) == 'object'){
    	           slots++;
    	         }
    	        }
	var niveauPointRall=parseInt(getCityBuilding (Cities.cities[i].id, 12).maxLevel);
	if (niveauPointRall==12) niveauPointRall=11;
    	row[i] = '<SPAN><B>'+ slots +'/'+ niveauPointRall +'</b></span>';
     }
    m += _row ('PR', row, true, 0);   m += "</table>";
     t.statpourTr.innerHTML = m;
     clearTimeout (t.displayTimer);
     t.displayTimer = setTimeout (t.showManuel, 4000);
  },
  
  SelectFavoris:function() {
   var t = Tabs.TranspAuto;
   if (t.listeFavoris.value!='') {
    var valeur=t.listeFavoris.value;
    var x=valeur.substr(0, valeur.lastIndexOf(','));
    var y=valeur.substr(valeur.lastIndexOf(',')+1, valeur.length);
    t.destinationCityx.value = x;
    t.destinationCityy.value = y;
   }
   t.estimerRes();
  },
  
  chercherFavoris: function() {
   var t = Tabs.TranspAuto;
   var myA = getMyAlliance ();
   if (myA[0]!=0) {
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      params.perPage = 100;
      params.allianceId = myA[0];
          new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
	        method: "post",
	        parameters: params,
	        onSuccess: function (rslt) {
	          if (rslt.ok){
	           var z=0;
	           var m="";
	           for (var i=0; i<rslt.results.length; i++){
     		      p = rslt.results[i];
		      if (p.userId != 0){
		       for (var c=0; c<p.cities.length; c++){
		         if (Seed.player.name!=p.displayName) {
		          m += "<option value='" + p.cities[c].xCoord + ","+ p.cities[c].yCoord+"'>" + p.displayName + " - "+unsafeWindow.g_js_strings.commonstr.city+" " + (c+1) + " - " + p.cities[c].xCoord + "," + p.cities[c].yCoord+"</option>";
		         }
		       }  	       
		      } 
      	            } 
      	            t.listeFavoris.innerHTML="<option value=''>select...</option>"+m;
	          }
	        },
	        onFailure: function (rslt) {
	          t.listeFavoris.innerHTML="<option>Error</option>";
	        },
    	});
   } else {
     t.listeFavoris.innerHTML="<option>It is not the alliance!</option>";
   }   
  },
  verifierWagons: function() {
   var t = Tabs.TranspAuto;
   var maxw=parseInt(rows[t.typetrp.value][t.sourceCity.idx]);
   var saisw=parseInt(t.Choixnbwagon.value);
   if (saisw > maxw) {
      t.Choixnbwagon.value=maxw;
      t.divTranportStatus.innerHTML = '<FONT COLOR=#550000>The amount can not exceed '+maxw+' !.</font>';
   }
   t.estimerRes();
  },
  estimerRes: function() {
   var t = Tabs.TranspAuto;
   var cityID = 'city'+ t.sourceCity.id,ic=0,resact=0,ic_ty="gold",ic_text="d'or";
   if (ById("ChoixRess1").checked) { ic_ty="rec1";ic=1;ic_text="de "+unsafeWindow.g_js_strings.commonstr.food; }
   if (ById("ChoixRess2").checked) { ic_ty="rec2";ic=2;ic_text="de bois"; }
   if (ById("ChoixRess3").checked) { ic_ty="rec3";ic=3;ic_text="de pierre"; }
   if (ById("ChoixRess4").checked) { ic_ty="rec4";ic=4;ic_text="de minerais"; }
   if (ById("ChoixRess5").checked) { ic_ty="rec5";ic=5;ic_text="de "+uW.g_js_strings.commonstr.aetherstone; }
   if (ById("ChoixRess0").checked) { ic_ty="gold";ic=0;ic_text="d'or"; } 
   var esti = 0;
   
   var total_units=t.Choixnbwagon.value;
   var untid=t.typetrp.value;
   var techLoadBoost=parseInt(Seed.tech.tch10)*0.1;
   var loadEffectBoost=0;
   if(Seed.playerEffects.loadExpire>uW.unixtime()){loadEffectBoost=0.25}
   var loadBoostBase=(uW.cm.ThroneController.effectBonus(6)*0.01)+loadEffectBoost+techLoadBoost;
   var loadBoost=loadBoostBase;
   if(uW.cm.unitFrontendType[untid]=="siege"){
    //loadBoost+=(uW.cm.ThroneController.effectBonus(59)*0.01)
   }else{
    if(uW.cm.unitFrontendType[untid]=="horsed"){
     loadBoost+=(uW.cm.ThroneController.effectBonus(48)*0.01)
    }
   }
   esti=parseInt(total_units*parseInt(uW.unitstats["unt"+untid][5])*(1+loadBoost));

   if (ic==5) {
    esti = parseInt(esti / 5);
   }
   var x1 = parseInt(t.sourceCity.x);
   var x2 = parseInt(t.destinationCityx.value);
   var y1 = parseInt(t.sourceCity.y);
   var y2 = parseInt(t.destinationCityy.value);
   var dist = distance (x1, y1, x2, y2);
   var m = estETA(dist,ById('typetrp').value,t.sourceCity.id,1);
   var a="";
   switch(ic){
    case 0:a=unsafeWindow.g_js_strings.commonstr.gold;break;
    case 1:a=unsafeWindow.g_js_strings.commonstr.food;break;
    case 2:a=unsafeWindow.g_js_strings.commonstr.wood;break;
    case 3:a=unsafeWindow.g_js_strings.commonstr.stone;break;
    case 4:a=unsafeWindow.g_js_strings.commonstr.ore;break;
    case 5:a=unsafeWindow.g_js_strings.commonstr.aetherstone;break;
   }
   t.estimationRes.innerHTML = "<b>" + addCommas(esti) + " "+a+"</b>";
   t.estimationRes.innerHTML += "<br>estimated time : <b>" + m.friendEtaStr + "</b>" ; 
   
     if (ic==5)
      resact = parseIntNan(Seed.resources[cityID][ic_ty][0]);
     else {
      if (ic==0)
       resact = parseIntNan(Seed.citystats[cityID].gold[0]);
      else
       resact = parseIntNan(Seed.resources[cityID][ic_ty][0] / 3600);
     } 
    if (resact < esti) {
     var untid=t.typetrp.value;
     		     var techLoadBoost=parseInt(Seed.tech.tch10)*0.1;
     		     var loadEffectBoost=0;
     		     if(Seed.playerEffects.loadExpire>uW.unixtime()){loadEffectBoost=0.25}
     		     var loadBoostBase=(uW.cm.ThroneController.effectBonus(6)*0.01)+loadEffectBoost+techLoadBoost;
     		     var loadBoost=loadBoostBase;
     		     if(uW.cm.unitFrontendType[untid]=="siege"){
     		      //loadBoost+=(uW.cm.ThroneController.effectBonus(59)*0.01)
     		     }else{
     		      if(uW.cm.unitFrontendType[untid]=="horsed"){
     		       loadBoost+=(uW.cm.ThroneController.effectBonus(48)*0.01)
     		      }
    }
    var nbparunit=parseInt(uW.unitstats["unt"+untid][5])*(1+loadBoost);
    if (ic==5) nbparunit=nbparunit/5;
    var uniteness = Math.floor(resact / nbparunit);
    if (uniteness<1) uniteness=0;
    t.Choixnbwagon.value = uniteness;
    t.TTbutTransport.disabled = false;  
    t.estimerRes();
   }
  }, 
  clickUniteMax: function() {
    var t = Tabs.TranspAuto;
    var maxw=parseInt(rows[t.typetrp.value][t.sourceCity.idx]);
    var niveauPointRall=parseInt(getCityBuilding (t.sourceCity.id, 12).maxLevel); 
        var e=1;
      var f=unsafeWindow.unixtime();
      if(Seed.playerEffects.aurasExpire){
      if(Seed.playerEffects.aurasExpire>f){e=1.15}}
      if(Seed.playerEffects.auras2Expire){if(Seed.playerEffects.auras2Expire>f){e=1.3}}  
    var maxtroupe=parseInt(niveauPointRall*10000*e);
    if (niveauPointRall==11) maxtroupe=parseInt(150000*e);
    if (niveauPointRall==12) maxtroupe=parseInt(200000*e);
    var q=uW.cm.ThroneController.effectBonus(66);
    maxtroupe=Math.floor(maxtroupe*(1+q/100));
    
    if (maxw>maxtroupe) maxw=maxtroupe;
    t.Choixnbwagon.value=maxw;
    t.estimerRes();
  },
  clickTransportDo: function() { 
   var t = Tabs.TranspAuto;
   var SourceId = t.sourceCity.id;
   var DestinationId = t.destinationCity.id;
   if (!ById("ChoixRess0").checked && !ById("ChoixRess1").checked && !ById("ChoixRess2").checked && !ById("ChoixRess3").checked && !ById("ChoixRess4").checked && !ById("ChoixRess5").checked) {
       t.divTranportStatus.innerHTML = '<FONT COLOR=#550000>Please choose a resource type !</font>';
      return;
   }
   if (t.sourceCity.x==t.destinationCityx.value && t.sourceCity.y==t.destinationCityy.value) {
      t.divTranportStatus.innerHTML = '<FONT COLOR=#550000>Impossible for the same city !.</font>';
     return;
   }
   if (parseInt(t.Choixnbwagon.value)=="0") {
   t.divTranportStatus.innerHTML = '<FONT COLOR=#550000>Impossible to carry with 0 units... pfff !.</font>';
     return;
   }
   var x=t.destinationCityx.value;
   var y=t.destinationCityy.value;
   if (x == 0 && y == 0) {
      t.divTranportStatus.innerHTML = '<FONT COLOR=#550000>Impossible to transport to the destination 0,0 !.</font>';
     return;
   }
   t.TTbutTransport.disabled=true; 
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.kid = 0;
   params.cid= t.sourceCity.id;
   params.type = "1";
   params.xcoord = x;
   params.ycoord = y;
   params.r1 = 0;
   params.r2 = 0; 
   params.r3 = 0; 
   params.r4 = 0; 
   params.r5 = 0; 
   params.gold = 0; 
   params.u9 = 0;
   var untid=t.typetrp.value
   var techLoadBoost=parseInt(Seed.tech.tch10)*0.1;
   var loadEffectBoost=0;
    if(Seed.playerEffects.loadExpire>uW.unixtime()){loadEffectBoost=0.25}
   		     var loadBoostBase=(uW.cm.ThroneController.effectBonus(6)*0.01)+loadEffectBoost+techLoadBoost;
   		     var loadBoost=loadBoostBase;
   		     if(uW.cm.unitFrontendType[untid]=="siege"){
   		      //loadBoost+=(uW.cm.ThroneController.effectBonus(59)*0.01)
   		     }else{
   		      if(uW.cm.unitFrontendType[untid]=="horsed"){
   		       loadBoost+=(uW.cm.ThroneController.effectBonus(48)*0.01)
   		      }
   }
   var esti=parseInt(t.Choixnbwagon.value * parseInt(uW.unitstats["unt"+untid][5])*(1+loadBoost));
   if (ById("ChoixRess5").checked) { 
    esti = parseInt(esti / 5);
   }
   if (ById("ChoixRess0").checked) { params.gold = esti; }
   if (ById("ChoixRess1").checked) { params.r1 = esti; }
   if (ById("ChoixRess2").checked) { params.r2 = esti; }
   if (ById("ChoixRess3").checked) { params.r3 = esti; }
   if (ById("ChoixRess4").checked) { params.r4 = esti; }
   if (ById("ChoixRess5").checked) { params.r5 = esti; }	
   if (t.typetrp.value==1)  params.u1 = t.Choixnbwagon.value;
   if (t.typetrp.value==9)  params.u9 = t.Choixnbwagon.value;
   if (t.typetrp.value==7)  params.u7 = t.Choixnbwagon.value;
   if (t.typetrp.value==8)  params.u8 = t.Choixnbwagon.value;

  t.divTranportStatus.innerHTML = "<i><b>"+uW.g_js_strings.commonstr.loadingddd+"....</b></i>";
   new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
              method: "post",
              parameters: params,
              loading: true,
              onSuccess: function (transport) {
                  var t = Tabs.TranspAuto;  
                  var rslt = transport;
                  if (rslt.ok) {
		   var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
                   var ut = unsafeWindow.unixtime();
                   var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
                   for(i = 0; i <= unitsarr.length; i++){
                   	if(params["u"+i]){
                  	unitsarr[i] = params["u"+i];
                  	}
                   }
                   var resources=new Array();
                   resources[0] = params.gold;
                   for(i=1; i<=4; i++){
                  	resources[i] = params["r"+i];
                   }
                   var currentcityid =  t.sourceCity.id;
                   unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
                   //unsafeWindow.update_seed(rslt.updateSeed)
                   if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
                   t.divTranportStatus.innerHTML = "<font size='3px'><b>transportation conducted</b>";
                   t.TTbutTransport.disabled=false;
                  } else {
		    t.divTranportStatus.innerHTML ="<font color=red size='3px'><b>Can not send!!!<b></font>";
		     if (rslt.msg) {
		       t.divTranportStatus.innerHTML +="<br><font color=black size='2px'>" + rslt.msg +"</font>";
		       t.TTbutTransport.disabled=false;
         	     } else {
         	      t.divTranportStatus.innerHTML +="<br>Retry in 2 seconds !</font>";
         	      setTimeout(function() { t.clickTransportDo(); }, 2000);
         	     }
                  }
                  },
                  onFailure: function (rslt) {
                   var t = Tabs.TranspAuto;
                   if (rslt.user_action) {
                    t.divTranportStatus.innerHTML ="<font color=red size='3px'><b>CAPTCHA ALERT !<b></font>";
                   } else {
                    
                    t.divTranportStatus.innerHTML ="<font color=red size='3px'><b>Error, try again!<b></font>";
                   }
                    t.TTbutTransport.disabled=false;
                  }
          });
  },
  clickCitySourceSelect : function (city){
    var t = Tabs.TranspAuto;
    t.sourceCity = city;
    t.TTbutTransport.disabled=false;
    var maxw=parseInt(rows[t.typetrp.value][t.sourceCity.idx]);
    var saisw=parseInt(t.Choixnbwagon.value);
    if (saisw > maxw)  t.Choixnbwagon.value=maxw;
    t.estimerRes();
   },
   clickCityDestinationSelect : function (city){
    var t = Tabs.TranspAuto;
    t.destinationCity = city;
    t.destinationCityx.value=t.destinationCity.x;
    t.destinationCityy.value=t.destinationCity.y;
    t.TTbutTransport.disabled=false;
    t.estimerRes();
   }, 
 
}



/*********************************  Raid Tab ***********************************/


 Tabs.Raid = {
  tabDisabled : false,
  tabOrder : 7,
  myDiv : null,
  rallypointlevel:null,
  knt:{},
  Troops:{},
  city:0,
  raidtimer:null,
  rslt:{},
  save:{},
  stopping:false,
  resuming:false,
  deleting:false,
  stopprogress:0,
  stopcount:0,
  activecount:0,
  count:0,

  init : function (div){
    var t = Tabs.Raid;
    t.myDiv = div;
	t.raidtimer = setTimeout(t.checkRaids, 30000);
	setInterval(t.lookup, 2500);
	setInterval(t.sendreport, 1*60*1000);
	AddSubTabLink('Parar Raid', t.StopAllRaids, 'pbraidtab');
	AddSubTabLink('Reanudar Raid', t.ResumeAllRaids, 'pbraidtabRes');
	AddSubTabLink('Borrar Raid', t.DeleteAllRaids, 'pbraidtabDel');
	var m = '<DIV class=pbStat>RAID Functions</div><TABLE width=100% height=0% class=pbTab><TR align="center">';
	    m += '<TD><INPUT id=pbRaidStart type=submit value="Auto Reset = '+ (Options.RaidRunning?'ON':'OFF') +'" ></td>';
 	    m += '<TD><INPUT id=pbsendraidreport type=checkbox '+ (Options.foodreport?'CHECKED':'') +'\> Send the report of raids ';
	    m += 'every <INPUT id=pbsendreportint value='+ Options.MsgInterval +' type=text size=3 \> hours </td>';
	    m += '</tr></table></div>';
	    m += '<DIV class=pbStat>RAID ON</div><TABLE width=100% height=0% class=pbTab><TR align="center">';
	    m += '<TD><DIV style="margin-bottom:10px;"><span id=ptRaidCity></span></div></td></tr>';
	    m+='<TR><TD><DIV style="margin-bottom:10px;"><span id=ptRaidTimer></span></div></td></tr></table>';
	    m += '<DIV id=PaintRaids></div>';
	    m += '<DIV class=pbStat>BEWARE RAID</div><TABLE width=100% height=0% class=pbTab><TR align="center">';
	    m += '<DIV id=SavedRaids></div>';
	t.myDiv.innerHTML = m;
	t.from = new CdispCityPicker ('ptRaidpicker', document.getElementById('ptRaidCity'), true, t.clickCitySelect, 0);
	document.getElementById('pbRaidStart').addEventListener('click', t.toggleRaidState, false);
	document.getElementById('pbsendraidreport').addEventListener('change', function(){
        Options.foodreport = document.getElementById('pbsendraidreport').checked; 
		saveOptions();
	}, false);
	document.getElementById('pbsendreportint').addEventListener('change', function(){
		Options.MsgInterval = parseInt(document.getElementById('pbsendreportint').value);
		saveOptions();
	}, false);
	var serverID = getServerId();
	t.save = GM_getValue ('SavedRaids_'+serverID);
	if (t.save != undefined) t.save = JSON2.parse (t.save);
	setInterval (t.paint,1000);
  },

  lookup : function (){
		var t = Tabs.Raid;
		t.activecount=0;
      	t.stopcount=0;
      	for (c=0; c< Seed.cities.length;c++) {
      			cityID = 'city' + Seed.cities[c][0];
   				for (b in Seed.queue_atkp[cityID]){
   					destinationUnixTime = Seed.queue_atkp[cityID][b]['destinationUnixTime'];
   					MarchStatus = Seed.queue_atkp[cityID][b]['marchStatus'];
   					MarchType = Seed.queue_atkp[cityID][b]['marchType'];
   					botMarchStatus = Seed.queue_atkp[cityID][b]['botMarchStatus'];
   					if (MarchType == 9 &&  MarchStatus == 3 || MarchStatus==10) t.stopcount++;
   					else if (MarchType == 9) t.activecount++;
					//alert(MarchType +'/'+  MarchStatus);
   				}
   		}
	   	if (t.resuming == false && t.stopping == false && t.deleting == false && t.activecount != 0)
			document.getElementById('pbraidtab').innerHTML = '<span style="color: #ff6">stop ('+ t.activecount + ') Raid</span>';
	   	else if (t.resuming == false && t.stopping == false && t.deleting == false)
			document.getElementById('pbraidtab').innerHTML = '<span style="color: #CCC">stop ('+ t.activecount + ') Raid</span>';
   		if (t.resuming == false && t.resuming == false && t.deleting == false && t.stopcount !=0)
			document.getElementById('pbraidtabRes').innerHTML = '<span style="color: #ff6">resume ('+ t.stopcount + ') Raid</span>';
   		else if (t.resuming == false && t.stopping == false && t.deleting == false)
			document.getElementById('pbraidtabRes').innerHTML = '<span style="color: #CCC">resume ('+ t.stopcount + ') Raid</span>';
   		if (t.resuming == false && t.stopping == false && t.deleting == false && t.stopcount !=0)
			document.getElementById('pbraidtabDel').innerHTML = '<span style="color: #ff6">delete('+ t.stopcount + ') Raid</span>';
   		else if (t.resuming == false && t.stopping == false && t.deleting == false)
			document.getElementById('pbraidtabDel').innerHTML = '<span style="color: #CCC">delete ('+ t.stopcount + ') Raid</span>';
   },

  paint : function ()	{
	var t = Tabs.Raid;
	var botMarchStat = {0:'Inactive',
  						1:'Attacking',
  						2:'Returning',
  						3:'Stopped',
  						4:'resting',
  						5:'unknown',
  						7:'Change in status',
  						8:'Returning',
  						9:'aborting'};
  	var botStat = {0:'indefinite',
  						1:'marching',
  						2:'Returning',
  						3:'Stopped',
  						4:'insufficient troops',
  						5:'Exceeded max. raid',
  						7:'Timeout',
  						8:'resting'};
        var o = '';
  	if (t.rslt.settings != undefined) o+= '<FONT size=2px><B>Raid time: '+ timestr( 86400 - ( unixTime() - t.rslt.settings.lastUpdated )) +'</b></font>';
    	document.getElementById('ptRaidTimer').innerHTML = o;
  	var z ='<TABLE class=pbTab><TR><TD width=60px align=center><A onclick="pbStopAll()">STOP</a></td><TD width=70px>time</td><TD width=85px>Coord.</td><TD width=50px>level</td><TD width=50px></td><TD width=50px><A onclick="pbDeleteAll()">DELETE</a></td></TR>';
  	if (t.rslt['queue'] != ""){
  		for (y in t.rslt['queue']) {
  			if (t.rslt['queue'][y]['botMarches'] != undefined) {
  				for (k in Seed.queue_atkp['city' + t.cityId]){
  					if (Seed.queue_atkp['city' + t.cityId][k]['marchId'] == t.rslt['queue'][y]['botMarches']['marchId']) {
  						botMarchStatus = Seed.queue_atkp['city' + t.cityId][k]['botMarchStatus'];
  						MarchStatus = Seed.queue_atkp['city' + t.cityId][k]['marchStatus'];
  						restPeriod = (Seed.queue_atkp['city' + t.cityId][k]['restPeriod']/60);
  						destinationUnixTime = Seed.queue_atkp['city' + t.cityId][k]['destinationUnixTime'];
  						returnUnixTime = Seed.queue_atkp['city' + t.cityId][k]['returnUnixTime']
  						now = unixTime();
						z+='<TR>';
  						if (MarchStatus ==1) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg></td>';
  						if (MarchStatus ==8 && (destinationUnixTime - now) <= 0 && botMarchStatus !=3 && returnUnixTime > now) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg></td>';
  						if (MarchStatus == 3) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_stopped_desat.png></td>';
  						if (MarchStatus == 4 || (returnUnixTime < now  && botMarchStatus !=3)) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png></td>';
  						if (destinationUnixTime >= now) z+='<TD>'+ timestr(Seed.queue_atkp['city' + t.cityId][k]['destinationUnixTime'] - unixTime())+'</td>';
  						if (destinationUnixTime <= now) {
  							if ((destinationUnixTime - now) <= 0 && returnUnixTime > now) z+='<TD>'+ timestr(returnUnixTime - now)+'</td>';
  							if (returnUnixTime <= now) z+='<TD>'+ timestr(now - returnUnixTime)+'</td>';
  						}
  					}
  				}
  				z+='<TD>('+ t.rslt['queue'][y]['botMarches']['toXCoord'] +','+ t.rslt['queue'][y]['botMarches']['toYCoord']+')</td>';
  				z+='<TD align=center>'+ t.rslt['queue'][y]['botMarches']['toTileLevel'] +'</td>';
  				if (botMarchStatus == 3) z+='<TD><A onclick="pbEditRaid('+ y +')">edit</a></td>';
	  				else z+='<TD><FONT COLOR= "CCCCCC">edit</font></td>';
  				if (botMarchStatus == 3) z+='<TD align=center><A onclick="pbDeleteRaid('+ t.rslt['queue'][y]['botMarches']['marchId']+')">DELETE</a></td>';
  				        else z+='<TD align=center><FONT COLOR= "CCCCCC">DELETE</font></td>';
  				z +='<TD width=25px></td><TD>Time-Out: '+ timestr(restPeriod) +'</td>';
  				z+='</tr>';
  			}
  		}
  	}
  	z+='</table>';
  	if (t.rslt['queue'] == "") z ='<TABLE class=pbTab><TR><TD>No raids in the city!</td></TR>';
  	document.getElementById('PaintRaids').innerHTML = z;
 	var check = true;
  		if (t.save != ""){
  			var a ='<TABLE class=pbTab><TR><TD width=60px></td><TD width=70px></td><TD width=85px>Coords.</td><TD width=50px>level</td><TD width=50px></td><TD width=50px></td></tr>';
  			for (y in t.save){
  				if (t.save[y] != undefined && t.cityId == t.save[y]['cityId']){
  					a +='<TR><TD align=center><A onclick="pbDeleteSavedRaid('+ t.save[y]['marchId'] +')">DELETE</a></td>';
  					a +='<TD></td><TD><FONT COLOR= "CC0000">('+t.save[y]['toXCoord']+','+t.save[y]['toYCoord']+')</font></td>';
  					a +='<TD align=center>'+t.save[y]['toTileLevel']+'</td>';
  					a +='<TD><A onclick="pbEditSavedRaid('+ y +')">edit</a></td>';
  					a +='<TD align=center><A onclick="pbAddRaid('+ t.save[y]['marchId']+')">add</a></td></tr>';
  					check = false;
  				}
  			}
  			m+='</table>';
  		}
  	if (check) a ='<TABLE class=pbTab><TR><TD>No raids saved in this city! (If you delete the really cool the stored here).</td></TR>';
        	document.getElementById('SavedRaids').innerHTML = a;
        	unsafeWindow.pbDeleteRaid = t.DeleteRaid;
	  	unsafeWindow.pbEditRaid = t.EditRaid;
	  	unsafeWindow.pbAddRaid = t.AddRaid;
	  	unsafeWindow.pbDeleteSavedRaid = t.DeleteSavedRaid;
	  	unsafeWindow.pbEditSavedRaid = t.EditSavedRaid;
	  	unsafeWindow.pbStopAll = t.StopCityRaids;
 	 	unsafeWindow.pbDeleteAll = t.DeleteCityRaids;
  },

  DeleteSavedRaid : function (Id){
    	  var t = Tabs.Raid;
    	  for (yy=0;yy<t.save.length;yy++){
    	  	if (t.save[yy]['marchId'] == Id){
    	  		  t.save.splice (yy,1);
    	  	}
    	  }
    	  var serverID = getServerId();
    	  setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
    	  t.paint();
    },

  EditSavedRaid : function (y){
      var t = Tabs.Raid;
	  var pop = new CPopup ('pbEditRaid', 0,0, 750,350, true);
	  if (t.popFirst){
	    pop.centerMe (mainPop.getMainDiv());
	    t.popFirst = false;
	  }
	  pop.getTopDiv().innerHTML = '<div class=showBadged><center>Saved Raids</center></div>';
	  cityId =  t.save[y]['cityId'];
		  var m = '<BR><TABLE id=pbRaidAdd height=0% class=pbTab><TR align="center">';
		  m+='<TR></tr><TR><TD width=25px>X= <INPUT id=toXCoord type=text size=3 maxlength=3 value='+t.save[y]['toXCoord']+'></td>';
		  m+='<TD width=10px></td><TD widht=25px>Y= <INPUT id=toYCoord type=text size=3 maxlength=3 value='+ t.save[y]['toYCoord'] +'></td>';
		  m+='<TD width=25px></td><TD>Ida y vuelta: '+ timestr((t.save[y]['returnUnixTime'] - t.save[y]['destinationUnixTime'])*2)+ '</td></tr></table>';
		  m += '<BR><TABLE id=pbRaidAdd width=100% height=0% class=pbTab><TR align="center">';
		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_50.jpg?6545"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt1']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt2']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt3']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt4']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit1 type=text size=6 maxlength=6 value="'+ t.save[y]['unit1Count']+'"></td>';
		  m += '<TD><INPUT id=Unit2 type=text size=6 maxlength=6 value="'+ t.save[y]['unit2Count']+'"></td>';
		  m += '<TD><INPUT id=Unit3 type=text size=6 maxlength=6 value="'+ t.save[y]['unit3Count']+'"></td>';
		  m += '<TD><INPUT id=Unit4 type=text size=6 maxlength=6 value="'+ t.save[y]['unit4Count']+'"></td></tr>';
		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_50.jpg?6545"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt5']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt6']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt7']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt8']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit5 type=text size=6 maxlength=6 value="'+ t.save[y]['unit5Count']+'"></td>';
		  m += '<TD><INPUT id=Unit6 type=text size=6 maxlength=6 value="'+ t.save[y]['unit6Count']+'"></td>';
		  m += '<TD><INPUT id=Unit7 type=text size=6 maxlength=6 value="'+ t.save[y]['unit7Count']+'"></td>';
		  m += '<TD><INPUT id=Unit8 type=text size=6 maxlength=6 value="'+ t.save[y]['unit8Count']+'"></td></tr>';
		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_50.jpg?6545"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt9']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt10']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt11']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_50.jpg?6545"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt12']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit9 type=text size=6 maxlength=6 value="'+ t.save[y]['unit9Count']+'"></td>';
		  m += '<TD><INPUT id=Unit10 type=text size=6 maxlength=6 value="'+ t.save[y]['unit10Count']+'"></td>';
		  m += '<TD><INPUT id=Unit11 type=text size=6 maxlength=6 value="'+ t.save[y]['unit11Count']+'"></td>';
		  m += '<TD><INPUT id=Unit12 type=text size=6 maxlength=6 value="'+ t.save[y]['unit12Count']+'"></td></tr></table>';
		  m += '<BR><CENTER><SELECT id=AddKnights type=list></select></center>';
		  m+= '<BR><CENTER>'+ strButton20('Save', 'id=pbSaveRaid') +'</center>';
	  pop.getMainDiv().innerHTML = m;
	  t.getKnights(cityId);
	  document.getElementById ('AddKnights').value =  t.save[y]['knightId'];
	  document.getElementById ('pbSaveRaid').addEventListener ('click', function(){
	  			t.save[y]['knightId'] = parseInt(document.getElementById ('AddKnights').value);
	  			t.save[y]['toXCoord'] = parseInt(document.getElementById ('toXCoord').value);
	  			t.save[y]['toYCoord'] = parseInt(document.getElementById ('toYCoord').value);
	  			t.save[y]['unit1Count'] = parseInt(document.getElementById ('Unit1').value);
	  			t.save[y]['unit2Count'] = parseInt(document.getElementById ('Unit2').value);
	  			t.save[y]['unit3Count'] = parseInt(document.getElementById ('Unit3').value);
	  			t.save[y]['unit4Count'] = parseInt(document.getElementById ('Unit4').value);
	  			t.save[y]['unit5Count'] = parseInt(document.getElementById ('Unit5').value);
	  			t.save[y]['unit6Count'] = parseInt(document.getElementById ('Unit6').value);
	  			t.save[y]['unit7Count'] = parseInt(document.getElementById ('Unit7').value);
	  			t.save[y]['unit8Count'] = parseInt(document.getElementById ('Unit8').value);
	  			t.save[y]['unit9Count'] = parseInt(document.getElementById ('Unit9').value);
	  			t.save[y]['unit10Count'] = parseInt(document.getElementById ('Unit10').value);
	  			t.save[y]['unit11Count'] = parseInt(document.getElementById ('Unit11').value);
	  			t.save[y]['unit12Count'] = parseInt(document.getElementById ('Unit12').value);
	  			var serverID = getServerId();
	  			setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
	  			pop.show (false);
	  }, false);
	  pop.show (true);
    },

  EditRaid : function (y){
 	  var t = Tabs.Raid;
  	  var pop = new CPopup ('pbEditRaid', 0,0, 750,350, true);
  	  if (t.popFirst){
  	    pop.centerMe (mainPop.getMainDiv());
  	    t.popFirst = false;
  	  }
  	  pop.getTopDiv().innerHTML = '<div class=showBadged><center>RAID Function</center></div>';
  	  cityId = t.rslt['queue'][y]['botMarches']['cityId'];
  		  var m = '<BR><TABLE id=pbRaidAdd height=0% class=pbTab><TR align="center">';
  		  m+='<TR></tr><TR><TD width=25px>X= <INPUT id=toXCoord type=text size=3 maxlength=3 value='+t.rslt['queue'][y]['botMarches']['toXCoord']+'></td>';
  		  m+='<TD width=10px></td><TD widht=25px>Y= <INPUT id=toYCoord type=text size=3 maxlength=3 value='+ t.rslt['queue'][y]['botMarches']['toYCoord'] +'></td>';
  		  m+='<TD width=25px></td><TD>Ida y vuelta: '+ timestr((t.rslt['queue'][y]['botMarches']['returnUnixTime'] - t.rslt['queue'][y]['botMarches']['destinationUnixTime'])*2)+ '</td></tr></table>';
  		  m += '<BR><TABLE id=pbRaidAdd width=100% height=0% class=pbTab><TR align="center">';
  		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_50.jpg?6545"></td>';
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt1']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt2']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt3']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt4']) +'</td></tr>'
  		  m += '<TR><TD><INPUT id=Unit1 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit1Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit2 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit2Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit3 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit3Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit4 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit4Count']+'"></td></tr>';
  		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_50.jpg?6545"></td>';
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt5']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt6']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt7']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt8']) +'</td></tr>'
  		  m += '<TR><TD><INPUT id=Unit5 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit5Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit6 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit6Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit7 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit7Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit8 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit8Count']+'"></td></tr>';
  		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_50.jpg?6545"></td>';
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt9']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt10']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt11']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_50.jpg?6545"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt12']) +'</td></tr>'
  		  m += '<TR><TD><INPUT id=Unit9 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit9Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit10 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit10Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit11 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit11Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit12 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit12Count']+'"></td></tr></table>';
  		  m += '<BR><CENTER><SELECT id=AddKnights type=list></select></center>';
  		  m+= '<BR><CENTER>'+ strButton20('Save', 'id=pbRaidSave') +'</center>';
  	  pop.getMainDiv().innerHTML = m;
  	  t.getKnights(cityId);
  	  document.getElementById ('AddKnights').value =  t.rslt['queue'][y]['botMarches']['knightId'];
  	  document.getElementById ('pbRaidSave').addEventListener ('click', function(){
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		params.pf = 0;
  		params.ctrl = 'BotManager';
  		params.action = 'editMarch';
		params.settings = {};
  		params.settings.cityId = t.rslt['queue'][y]['botMarches']['fromCityId'];
  	  	params.queue = {0:{botMarches:{botMarchStatus:1,botState:1},cityMarches:{}}};
  	  	params.queue[0].cityMarches.knightId = parseInt(document.getElementById ('AddKnights').value);
  	  	params.queue[0].cityMarches.toXCoord =  parseInt(document.getElementById ('toXCoord').value);
  	  	params.queue[0].cityMarches.toYCoord =  parseInt(document.getElementById ('toYCoord').value);
  	  	params.queue[0].cityMarches.unit0Count = 0; //document.getElementById ('Unit0').value;
  	  	params.queue[0].cityMarches.unit1Count =  parseInt(document.getElementById ('Unit1').value);
  	  	params.queue[0].cityMarches.unit2Count = parseInt(document.getElementById ('Unit2').value);
  	  	params.queue[0].cityMarches.unit3Count = parseInt(document.getElementById ('Unit3').value);
  	  	params.queue[0].cityMarches.unit4Count = parseInt(document.getElementById ('Unit4').value);
  	  	params.queue[0].cityMarches.unit5Count = parseInt(document.getElementById ('Unit5').value);
  	  	params.queue[0].cityMarches.unit6Count = parseInt(document.getElementById ('Unit6').value);
  	  	params.queue[0].cityMarches.unit7Count = parseInt(document.getElementById ('Unit7').value);
  	  	params.queue[0].cityMarches.unit8Count = parseInt(document.getElementById ('Unit8').value);
  	  	params.queue[0].cityMarches.unit9Count = parseInt(document.getElementById ('Unit9').value);
  	  	params.queue[0].cityMarches.unit10Count = parseInt(document.getElementById ('Unit10').value);
  	  	params.queue[0].cityMarches.unit11Count = parseInt(document.getElementById ('Unit11').value);
  	  	params.queue[0].cityMarches.unit12Count = parseInt(document.getElementById ('Unit12').value);
  	  	params.queue[0].cityMarches.marchId =  t.rslt['queue'][y]['botMarches']['marchId'];
  		new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
				 loading: true,
				 onSuccess: function(transport){
					var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
							pop.show (false);
							unsafeWindow.cityinfo_army();
                            setTimeout(unsafeWindow.update_seed_ajax, 250);
							setTimeout(t.GetRaids, (750),Seed.cities[i][0]);
						}
				 },
  		 });
  }, false);
  	  pop.show (true);
  },
   DeleteRaid : function (Id){
    var t = Tabs.Raid;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	for (y in t.rslt['queue']) {
  		if (t.rslt['queue'][y]['botMarches'] != undefined) {
	  		if (t.rslt['queue'][y]['botMarches']['marchId'] == Id) {
	  				marchId = t.rslt['queue'][y]['botMarches']['marchId'];
	  				cityId = t.rslt['queue'][y]['botMarches']['cityId'];
	  				knightId = t.rslt['queue'][y]['botMarches']['knightId'];
	  				toTileLevel = t.rslt['queue'][y]['botMarches']['toTileLevel'];
	  				returnUnixTime = t.rslt['queue'][y]['botMarches']['returnUnixTime'];
	  				destinationUnixTime = t.rslt['queue'][y]['botMarches']['destinationUnixTime'];
	  				toXCoord = t.rslt['queue'][y]['botMarches']['toXCoord'];
	  				toYCoord = t.rslt['queue'][y]['botMarches']['toYCoord'];
	  				var units = {};
	  				for (i=1;i<13;i++) units[i] = t.rslt['queue'][y]['botMarches']['unit'+i+'Count'];
	  		}
		}
    }
  	params.pf = 0;
  	params.ctrl = 'BotManager';
  	params.action = 'deleteMarch';
  	params.marchId = marchId;
  	params.settings = {};
  	params.settings.cityId = cityId;
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  	         method: "post",
  	         parameters: params,
  			 loading: true,
  			 onSuccess: function(transport){
  				var rslt = eval("(" + transport.responseText + ")");
  	              if (rslt.ok) {
  	              	  var serverID = getServerId();
  	              	  t.save = GM_getValue ('SavedRaids_'+serverID);
  	              	  if (t.save == undefined) t.save =new Array();
					  else t.save = JSON2.parse (t.save);
  	              	  t.save.push ({
  	              	  	marchId:		marchId,
  	              	  	cityId:   		cityId,
  	              	  	knightId:		knightId,
  	              	  	toTileLevel:	toTileLevel,
  	              	  	returnUnixTime:	destinationUnixTime,
  	              	  	toXCoord:		toXCoord,
  	              	  	toYCoord:		toYCoord,
  	              	  	unit1Count: 	units[1],
  	              	  	unit2Count: 	units[2],
  	              	  	unit3Count: 	units[3],
  	              	  	unit4Count: 	units[4],
  	              	  	unit5Count: 	units[5],
  	              	  	unit6Count: 	units[6],
  	              	  	unit7Count: 	units[7],
  	              	  	unit8Count: 	units[8],
  	              	  	unit9Count: 	units[9],
  	              	  	unit10Count: 	units[10],
  	              	  	unit11Count: 	units[11],
  	              	  	unit12Count: 	units[12],
  	              	  });
  	              	  var troops = Seed.units["city" + cityId];
                      for (var u = 1; u <= 12; ++u) {
                          var troop_number = parseInt(rslt["unit" + u + "Return"]);
                          if (isNaN(troop_number)) {
                              troop_number = parseInt(Seed.units["city" + cityId]["unt" + u]);
                          } else troop_number = parseInt(rslt["unit" + u + "Return"]) + parseInt(Seed.units["city" + cityId]["unt" + u]);
                          troops["unt" + u] = troop_number;
                      }
                      for (u in Seed.queue_atkp['city' + cityId]){
                      	if (Seed.queue_atkp['city' + cityId][u]['marchId'] == marchId){
							Seed.queue_atkp['city' + cityId][u] = "";
                      		unsafeWindow.seed.queue_atkp['city' + cityId] = Seed.queue_atkp['city' + cityId];
                      	}
                      }

                      for (u in Seed.knights['city' + cityId]){
                      	if (Seed.knights['city' + cityId][u]['knightId'] == knightId){
                      		Seed.knights['city' + cityId][u]["knightStatus"] = 1;
                      		unsafeWindow.seed.knights['city' + cityId] = Seed.knights['city' + cityId];
                      	}
                      }
  	              	  GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));
  	              	  t.save = null;
                          unsafeWindow.cityinfo_army();
  	                  setTimeout(unsafeWindow.update_seed_ajax, 250);
  	                  t.GetRaids(cityId);
  					}
  			 },
  	 });
  },

  StopCityRaids : function (cityId){
    	var t = Tabs.Raid;
    	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    	params.pf = 0;
    	params.ctrl = 'BotManager';
    	params.action = 'stopAll';
    	params.settings = {};
  	params.settings.cityId = cityId;
    	new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
    		  method: "post",
    		  parameters: params,
    	          loading: true,
    		  onSuccess: function(transport){
    		  var rslt = eval("(" + transport.responseText + ")");
    	          if (rslt.ok) {

    					  }
    				 },
    		 });
    setTimeout(t.GetRaids, (750), cityId);
    },

  StopAllRaids : function (){
      	var t = Tabs.Raid;
      	if (t.stopping == true || t.resuming == true || t.deleting == true) return;
      	if (t.activecount == 0) return;
	    t.stopping = true;
	      	for (i=0;i<Seed.cities.length;i++){
		      	setTimeout(t.DoAllStop, (i*1500),i);
		     }
   },

   ResumeAllRaids : function (){
       	var t = Tabs.Raid;
       	if (t.stopping == true || t.resuming == true || t.deleting == true) return;
       	if (t.stopcount == 0) return;
       	t.resuming = true;
   			for (i=0;i<Seed.cities.length;i++){
   			    setTimeout(t.DoAllResume, (i*1500),i);
   			}
    },


   DeleteAllRaids : function (){
       	var t = Tabs.Raid;
       	if (t.stopping == true || t.resuming == true || t.deleting == true) return;
       	if (t.stopcount == 0) return;
       	t.deleting = true;
       	count=0;
       	t.count = t.stopcount;
				for (d=0; d< Seed.cities.length;d++) {
						cityID = 'city' + Seed.cities[d][0];
							for (e in Seed.queue_atkp[cityID]){
								destinationUnixTime = Seed.queue_atkp[cityID][e]['destinationUnixTime'];
								MarchStatus = Seed.queue_atkp[cityID][e]['marchStatus'];
								MarchType = Seed.queue_atkp[cityID][e]['marchType'];
								if (MarchType == 9 && (botMarchStatus == 3 || MarchStatus == 3)) {
									count++;
									setTimeout(t.DoAllDelete, (count*1250), (Seed.queue_atkp[cityID][e]['marchId']),d,count);
				}
			 }
		}
   },


  DoAllStop: function(i) {
    var t = Tabs.Raid;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	params.pf = 0;
  	params.ctrl = 'BotManager';
  	params.action = 'stopAll';
  	params.settings = {};
  	params.settings.cityId = Seed.cities[i][0];

  		 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  			  		method: "post",
  			         parameters: params,
  					 loading: true,
  					 onSuccess: function(transport){
  						var rslt = eval("(" + transport.responseText + ")");
  		                  if (rslt.ok) {
  		                  		t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  		                  		actionLog('Parando: '+ Seed.cities[i][1]);
  		                  		updatebotbutton('Parando: '+ t.stopprogress.toFixed(0) + '%', 'pbraidtab');
								if (t.stopprogress.toFixed(0) == 100) {
  		                  			t.stopprogress = 0;
  		                  			setTimeout(function(){updatebotbutton(' ('+ t.activecount + ')Stop Raid ', 'pbraidtab');t.stopping = false;}, (5000));
								}
  						  }
  						  else {
  						  		if (rslt.msg == "The system is busy, please try again later") setTimeout (t.DoAllStop, (2000),i);
  						  		else {
  					 	  			t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  					 	  			actionLog('Parando: '+ Seed.cities[i][1] + ' - ' + rslt.msg);
  					 	  			updatebotbutton('Parando: '+ t.stopprogress.toFixed(0) + '%', 'pbraidtab')
									if (t.stopprogress.toFixed(0) == 100) {
  					 	  				 t.stopprogress = 0;
										 setTimeout(function(){updatebotbutton(' ('+ t.activecount + ') Stopped Raid', 'pbraidtab');t.stopping = false;}, (5000));
									}
								}
						  }
					},
		 });
   },

  DoAllResume: function(i) {
    var t = Tabs.Raid;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	params.pf = 0;
  	params.ctrl = 'BotManager';
  	params.action = 'resumeAll';
  	params.settings = {};
    params.settings.cityId = Seed.cities[i][0];

  		 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  			  		method: "post",
  			         parameters: params,
  					 loading: true,
  					 onSuccess: function(transport){
  						var rslt = eval("(" + transport.responseText + ")");
  		                  if (rslt.ok) {
  		                  		t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  		                  		actionLog('Reanudando: '+ Seed.cities[i][1]);
								updatebotbutton('Reanudando: '+ t.stopprogress.toFixed(0) + '%', 'pbraidtabRes');
  		                  		if (t.stopprogress.toFixed(0) == 100) {
  		                  			 t.stopprogress = 0;
	    							setTimeout(function(){updatebotbutton('Reanudar ('+ t.stopcount + ') redadas', 'pbraidtabRes');t.resuming = false;}, (5000));
				}
		}
  						  else {
  						  		if (rslt.msg == "El sistema est ocupado, por favor intente ms tarde") setTimeout (t.DoAllResume, (2000),i);
  						  		else {
  					 	  			t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  					 	  			actionLog('Parando: '+ Seed.cities[i][1]  + ' - ' + rslt.msg);
  					 	  			updatebotbutton('Reanudando: '+ t.stopprogress.toFixed(0) + '%', 'pbraidtabRes')
  					 	  			if (t.stopprogress.toFixed(0) == 100) {
  					 	  				 t.stopprogress = 0;
  					 	  				 setTimeout(function(){updatebotbutton('Reanudar ('+ t.stopcount + ') redadas', 'pbraidtabRes');t.resuming = false;}, (5000));
  					 	  			}
								}
						  }
  					 },
		 });
  },

  DoAllDelete : function (Id,city,count){
		var t = Tabs.Raid;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

		cityID = 'city'+ Seed.cities[city][0];

    	for (f in Seed.queue_atkp[cityID]){
    		if (Seed.queue_atkp[cityID][f]['marchId'] == Id) {
    				marchId = Seed.queue_atkp[cityID][f]['marchId'];
    				cityId = Seed.queue_atkp[cityID][f]['cityId'];
    				knightId = Seed.queue_atkp[cityID][f]['knightId'];
    				toTileLevel = Seed.queue_atkp[cityID][f]['toTileLevel'];
    				returnUnixTime = Seed.queue_atkp[cityID][f]['returnUnixTime'];
    				destinationUnixTime = Seed.queue_atkp[cityID][f]['destinationUnixTime'];
    				toXCoord = Seed.queue_atkp[cityID][f]['toXCoord'];
    				toYCoord = Seed.queue_atkp[cityID][f]['toYCoord'];
    				var units = {};
    				for (i=1;i<13;i++) units[i] = Seed.queue_atkp[cityID][f]['unit'+i+'Count'];
  			}
      }

    	params.pf = 0;
    	params.ctrl = 'BotManager';
    	params.action = 'deleteMarch';
    	params.marchId = marchId;
    	params.settings = {};
    	params.settings.cityId = cityId;

      new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
    	         method: "post",
    	         parameters: params,
    			 loading: true,
    			 onSuccess: function(transport){
    				var rslt = eval("(" + transport.responseText + ")");
    	              if (rslt != "") {
    	              	  var serverID = getServerId();
    	              	  t.save = GM_getValue ('SavedRaids_'+serverID, "[]");
    	              	  if (t.save != undefined) t.save = JSON2.parse (t.save);
    	              	  if (t.save == undefined) t.save =new Array();

    	              	  t.save.push ({
    	              	  	marchId:		marchId,
    	              	  	cityId:   		cityId,
    	              	  	knightId:		knightId,
    	              	  	toTileLevel:	toTileLevel,
    	              	  	returnUnixTime:	destinationUnixTime,
    	              	  	toXCoord:		toXCoord,
    	              	  	toYCoord:		toYCoord,
    	              	  	unit1Count: 	units[1],
    	              	  	unit2Count: 	units[2],
    	              	  	unit3Count: 	units[3],
    	              	  	unit4Count: 	units[4],
    	              	  	unit5Count: 	units[5],
    	              	  	unit6Count: 	units[6],
    	              	  	unit7Count: 	units[7],
    	              	  	unit8Count: 	units[8],
    	              	  	unit9Count: 	units[9],
    	              	  	unit10Count: 	units[10],
    	              	  	unit11Count: 	units[11],
    	              	  	unit12Count: 	units[12],
    	              	  });

    	              	  var troops = Seed.units["city" + cityId];
    	              	  for (var u = 1; u <= 12; ++u) {
    	              	      var troop_number = parseInt(rslt["unit" + u + "Return"]);
    	              	      if (isNaN(troop_number)) {
    	              	          troop_number = parseInt(Seed.units["city" + cityId]["unt" + u]);
    	              	      } else troop_number = parseInt(rslt["unit" + u + "Return"]) + parseInt(Seed.units["city" + cityId]["unt" + u]);
    	              	      troops["unt" + u] = troop_number;
    	              	  }

    	              	  setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
                          unsafeWindow.cityinfo_army();
    	                  setTimeout(unsafeWindow.update_seed_ajax, 250);
    					}
    			 },
    	 });
  		  	 t.stopprogress = count * (100/t.count);
  		  	 actionLog('deleting: '+ Seed.cities[city][1]);
  		  	 updatebotbutton('deleting: '+ t.stopprogress.toFixed(0) + '%', 'pbraidtabDel');
  		  	 if (t.stopprogress.toFixed(0) == 100) {
  		  	 	 t.stopprogress = 0;
  		  	 	 t.GetRaids(cityId);
  		  	 	 setTimeout(function(){updatebotbutton('deleting ('+ t.stopcount + ') Raid', 'pbraidtabDel');t.deleting  = false;}, (5000));
  	}

},


  DeleteCityRaids : function (){
      	var t = Tabs.Raid;
      	alert('This button needs to be added...');
      	/*var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);


      	params.pf = 0;
      	params.ctrl = 'BotManager';
      	params.action = 'stopAll';
      	params.settings = {};

    	    params.settings.cityId = t.cityId;

      	 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
      		  		method: "post",
      		         parameters: params,
      				 loading: true,
      				 onSuccess: function(transport){
      					var rslt = eval("(" + transport.responseText + ")");
      	                  if (rslt.ok) {

      					  }
      				 },
      		 }); */
      },


  AddRaid : function (Id){
    	var t = Tabs.Raid;
    	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    	update = {};
    	params.pf = 0;
    	params.ctrl = 'BotManager';
    	params.action = 'saveMarch';
    	params.settings = {};
    	params.queue = {0:{botMarches:{botMarchStatus:1,botState:1},cityMarches:{}}};
    	for (y in t.save){
    		if (t.save[y]['marchId'] == Id){
	    		params.settings.cityId = t.save[y]['cityId'];
	    		params.queue[0].cityMarches.knightId = t.save[y]['knightId']; 
	    		params.queue[0].cityMarches.toXCoord = t.save[y]['toXCoord'];
	    		params.queue[0].cityMarches.toYCoord = t.save[y]['toYCoord'];
	    		params.queue[0].cityMarches.unit0Count = 0;
	    		params.queue[0].cityMarches.unit1Count = t.save[y]['unit1Count'];
	    		params.queue[0].cityMarches.unit2Count = t.save[y]['unit2Count'];
	    		params.queue[0].cityMarches.unit3Count = t.save[y]['unit3Count'];
	    		params.queue[0].cityMarches.unit4Count = t.save[y]['unit4Count'];
	    		params.queue[0].cityMarches.unit5Count = t.save[y]['unit5Count'];
	    		params.queue[0].cityMarches.unit6Count = t.save[y]['unit6Count'];
	    		params.queue[0].cityMarches.unit7Count = t.save[y]['unit7Count'];
	    		params.queue[0].cityMarches.unit8Count = t.save[y]['unit8Count'];
	    		params.queue[0].cityMarches.unit9Count = t.save[y]['unit9Count'];
	    		params.queue[0].cityMarches.unit10Count = t.save[y]['unit10Count'];
	    		params.queue[0].cityMarches.unit11Count = t.save[y]['unit12Count'];
	    		params.queue[0].cityMarches.unit12Count = t.save[y]['unit12Count'];
 			}
 			}

    	 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
    		  		method: "post",
    		         parameters: params,
    				 loading: true,
    				 onSuccess: function(transport){
    					var rslt = eval("(" + transport.responseText + ")");
    	                  if (rslt.ok) {
								t.GetRaids(params.settings.cityId);
      					        unsafeWindow.cityinfo_army();
      	                  		setTimeout(unsafeWindow.update_seed_ajax, 250);
      	                  		for (yy=0;yy<t.save.length;yy++){
      	                  			if (t.save[yy]['marchId'] == Id){
      	                  				  t.save.splice (yy,1);
			}
		}
      	                  		var serverID = getServerId();
      	                  		setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
      	                  		t.paint();
 		} else {
    					 	 /* var pop = new CPopup ('pbEditRaid', 0,0, 750,250, true);
				 		  	  if (t.popFirst){
				 		  	    pop.centerMe (mainPop.getMainDiv());
				 		  	    t.popFirst = false;
				 		  	  }
				 		  	  pop.getTopDiv().innerHTML = '<div class=showBadged><center>ERROR</center></div>';
				 		  	  var m= '<TABLE id=pbRaidAdd width=100% height=0% class=pbTab><TR align="center">';
				 			  m +=  '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/merlin_img.jpg"></td>';
				 			  m+='<TD style="align;left; max-width:200px; text-wrap:normal;word-wrap:break-word"><B>'+ rslt.msg+'</b></td>';
				 		  	  m+='<TD><CENTER>'+ strButton20('OK', 'id=pbOK') +'</center></td></tr>';
				 		  	  pop.getMainDiv().innerHTML = m;
				 			  document.getElementById('pbOK').addEventListener ('click', function(){pop.show (false)},false);
				 		  	  pop.show (true);*/
				 		  	  alert('Error: '+ rslt.msg);
 		}
 		},
 	});
   },


  getKnights : function(cityId){
         var t = Tabs.Raid;
         var knt = new Array();
         var status ="";
         for (k in Seed.knights['city' + cityId]){
         		if ( Seed.leaders['city' + cityId]["resourcefulnessKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["politicsKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["combatKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["intelligenceKnightId"] != Seed.knights['city' + cityId][k]["knightId"]){
         		   if (Seed.knights['city' + cityId][k]["knightStatus"] == 1 ) status = "Free";
         		   else status = "Marching";
         			knt.push ({
         				Name:   Seed.knights['city' + cityId][k]["knightName"],
         				Combat:	parseInt(Seed.knights['city' + cityId][k]["combat"]),
         				ID:		Seed.knights['city' + cityId][k]["knightId"],
         				Status: status,
         			});
         		}
         }
         knt = knt.sort(function sort(a,b) {a = a['Combat'];b = b['Combat'];return a == b ? 0 : (a > b ? -1 : 1);});
         document.getElementById('AddKnights').options.length=0;
  		var o = document.createElement("option");
  		o.text = '--Choose a Knight--';
  		o.value = 0;
  		document.getElementById("AddKnights").options.add(o);
         for (k in knt){
      			if (knt[k]["Name"] !=undefined){
  	    			var o = document.createElement("option");
  	    			o.text = (knt[k]["Name"] + ' (' + knt[k]["Combat"] +') (' + knt[k]["Status"] +')');
  	    			o.value = knt[k]["ID"];
  	    			document.getElementById("AddKnights").options.add(o);
      			}
      	}
      },


  clickCitySelect : function (city){
  	var t = Tabs.Raid;
  	t.cityId = city['id'];
  	t.GetRaids(t.cityId);
  },

  checkRaids : function (){
	var t = Tabs.Raid;
	var now = unixTime();
	if(!Options.RaidRunning) return;
	if ( (now - Options.RaidReset) > 7200 ) {
		Options.RaidReset = now;
		saveOptions();
		for (g=0;g<Seed.cities.length;g++){
				t.citiesdone = "";
				setTimeout(t.resetRaids, (1500*g), Seed.cities[g][0],Seed.cities[g][1]);
		}
		setTimeout(t.postLog, 30000);
	}
	t.raidtimer = setTimeout(t.checkRaids, 900000);
  },

  GetRaids : function(cityId){
  		var t = Tabs.Raid;
  		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

  		params.pf = 0;
  		params.ctrl = 'BotManager';
  		params.action = 'getMarches';
  		params.settings = {};
  		params.settings.cityId = cityId;


   		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  				 loading: true,
  				 onSuccess: function(transport){
  					var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                        	t.rslt = rslt;
  							t.paint();
  							unsafeWindow.cityinfo_army();
  							setTimeout(unsafeWindow.update_seed_ajax, 250);
  						}
  				 },
  		 });
  },


  resetRaids : function(cityId,cityName){
  		var t = Tabs.Raid;
  		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

  		params.pf = 0;
  		params.ctrl = 'BotManager';
  		params.action = 'resetRaidTimer';
		params.settings = {};
  		params.settings.cityId = cityId;


   		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
				 loading: true,
				 onSuccess: function(transport){
					var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
							unsafeWindow.cityinfo_army();
                            setTimeout(unsafeWindow.update_seed_ajax, 250);
                            t.citiesdone += cityName + ' ';
						}
				 },
  		 });
  },

  postLog : function (){
  		var t = Tabs.Raid;
  		actionLog('Reset Raidtimer: ' + t.citiesdone);
  },

   sendreport: function(){
	  var t = Tabs.Raid;
	  if(!Options.foodreport) return;
	  var now = new Date().getTime()/1000.0;
      now = now.toFixed(0);
      if (now < (parseInt(Options.LastReport)+(Options.MsgInterval*60*60))) return;

	var total = 0;
    var message = 'Raid Stats: %0A';
    message += '%0A Livestock Feed (during '+ Options.MsgInterval +' hours of raids) %0A';
    for (q=1;q<=Seed.cities.length;q++){
    	var cityID = 'city' + Seed.cities[q-1][0];
    	var gain = parseInt(Seed.resources[cityID]['rec1'][0] / 3600) - Options.Foodstatus[q];
    	message+= Seed.cities[q-1][1] + ': Inicio: ' + addCommas(Options.Foodstatus[q]) + ' Fin :' + addCommas(parseInt(Seed.resources[cityID]['rec1'][0] / 3600)) + ' Ganancia: ';    	message+= Seed.cities[q-1][1] + ': Inicio: ' + addCommas(Options.Foodstatus[q]) + ' Fin :' + addCommas(parseInt(Seed.resources[cityID]['rec1'][0] / 3600)) + ' Ganancia: ';
    	message += addCommas(gain)  + '%0A';
		total += gain;
		Options.Foodstatus[q] = parseInt(Seed.resources[cityID]['rec1'][0] / 3600);
    }
	message += '%0A Alimento total ganado : '+addCommas(total)+'%0A';

    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.emailTo = Seed.player['name'];
    params.subject = "Informe de Raid General";
    params.message = message;
    params.requestType = "COMPOSED_MAIL";
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
            } else {
            }
        },
        onFailure: function () {
        },
    });

	Options.LastReport = now;
    saveOptions();
  },

  toggleRaidState : function (){
  	var t = Tabs.Raid;
  	if(Options.RaidRunning){
  		Options.RaidRunning = false;
  		t.raidtimer = null;
  		document.getElementById('pbRaidStart').value = 'Auto Reset = OFF';
  	} else {
  		Options.RaidRunning = true;
  		t.raidtimer = setTimeout(t.checkRaids, 5000);
  		document.getElementById('pbRaidStart').value = 'Auto Reset = ON';
  	}
	saveOptions();
  },


  hide : function (){
  },

  show : function (){
  },
};



/*********************************** Log Tab ***********************************/
Tabs.ActionLog = {
  tabOrder: 120,
  tabDisabled : !ENABLE_TEST_TAB,
  tabLabel : 'Log',
  myDiv : null,
  logTab : null,
  maxEntries: 300,
  last50 : [],
  state : null,
    
  init : function (div){
    var t = Tabs.ActionLog;
    t.myDiv = div;
    t.myDiv.innerHTML = '<DIV class=pbStat>ACTION LOG - VERSION: '+ Version+'</div><DIV style="height:535px; max-height:535px; overflow-y:auto">\
      <TABLE cellpadding=0 cellspacing=0 id=pbactionlog class=pbTabLined><TR><TD></td><TD width=95%></td></table></div>';
    t.logTab = document.getElementById('pbactionlog');  
    t.state = 1;
    var a = JSON2.parse(GM_getValue ('log_'+getServerId(), '[]'));
    if (matTypeof(a) == 'array'){
      t.last50 = a;
      for (var i=0; i<t.last50.length; i++)
        t._addTab (t.last50[i].msg, t.last50[i].ts);
    }
    window.addEventListener('unload', t.onUnload, false);
  },

  hide : function (){
  },

  show : function (){
  },

  onUnload : function (){
    var t = Tabs.ActionLog;
    if (!ResetAll) GM_setValue ('log_'+getServerId(), JSON2.stringify(t.last50));
  },
    
  _addTab : function (msg, ts){
    var t = Tabs.ActionLog;
    if (t.state != 1)
      return;
    if (t.logTab.rows.length >= t.maxEntries)
      t.logTab.deleteRow(t.maxEntries-1);
    var row = t.logTab.insertRow(0);
    row.vAlign = 'top';
    row.insertCell(0).innerHTML = ts;
    row.insertCell(1).innerHTML = msg;
  },
  
  log : function (msg){
    var t = Tabs.ActionLog;
    var ts = new Date().toTimeString().substring (0,8);
    t._addTab (msg, ts);
    while (t.last50.length >= 50)
      t.last50.shift();
    t.last50.push ({msg:msg, ts:ts});
  },
}

function actionLog (msg){
  if (!Tabs.ActionLog.tabDisabled)
    Tabs.ActionLog.log (msg);  
}

/*********************************  Farm Tab ***********************************/

Tabs.farm = {
  tabLabel: 'Auto Farm',
  tabDisabled : true,	
  tabOrder : 612,
  myDiv : null,
  MapAjax : new CMapAjax(),
  popFirst : true,
  opt : {},
  nextattack : null,
  updateSeedTimer: null,
  searchRunning : false,
  tilesSearched : 0,
  tilesFound : 0,
  curX : 0,
  curY : 0,
  lastX : 0,
  firstX : 0,
  firstY : 0,
  lastY : 0,
  rallypointlevel:0,
  knt:{},
  helpArray:{},
  FarmArray:{},
  marchArray:[],
  lookup:1,
  city:0,
  deleting:false,
  DipArray: ["friendly","hostile","friendlyToThem","friendlyToYou","neutral","unallied"],
  interval: ["Continuously","1 Hour","2 Hours","3 Hours","6 Hours","12 Hours","24 Hours"],
	
  init : function (div){
    var t = Tabs.farm;
    t.myDiv = div;

    var m = '<DIV id=pbTowrtDivF class=pbStat>AUTOMATED FARMING FUNCTION</div><TABLE id=pbbarbingfunctions width=100% height=0% class=pbTab><TR align="center">';
	 if (FarmOptions.Running == false) {
	       m += '<TD><INPUT id=FarmAttSearch type=submit value="Farming = OFF"></td>';
	   } else {
	       m += '<TD><INPUT id=FarmAttSearch type=submit value="Farming = ON"></td>';
	   }
	  m +='<TD><INPUT id=pbpaintFarms type=submit value="Show Farms">';
      m += '<SELECT id=pbFarmcity type=list></td></tr></table>'; 
	  m += '</tr></table></div>';
	  
	  m += '<DIV id=pbTraderDivD class=pbStat>FARMING STATS</div>';
	
	  m += '<TABLE id=pbfarmstats width=95% height=0% class=pbTab><TR align="left"><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD>' + Seed.cities[i][1] +'</td>';
	  }
	  m+='</tr><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pdtotalFarm' + i +'></span></div></td>';
	  }
	  m+='</tr><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pddataFarm' + i +'></span></div></td>';
	  }
	  m+='</tr><TR>'
	   for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pddataFarmarray' + i +'></span></div></td>';
	 }
	 m+='</tr></table>';
	 
	m+='<DIV id=FarmCheck></div>';

	m += '<DIV id=pbTraderDivD class=pbStat>FARMING OPTIONS</div>';
	m += '<TABLE id=pbfarmstats width=90% height=0% class=pbTab>';
	m += '<TR><TD width=180>Keep rallypoint slot(s) free: </td><TD><INPUT id=FarmRallyClip type=text size=2 maxlength=2 value=' + FarmOptions.RallyClip +'></td></tr>';
	m += '<TR><TD>Farm Interval</td><TD><SELECT id=FarmInterval type=list></td></tr>'; 
	m += '<TR><TD>Delete reports:</td><TD><INPUT id=FarmReports type=checkbox '+(FarmOptions.DeleteReports?'CHECKED':'')+'></td><tr>';
	m += '<TR><TD>Search distance:</td><TD><INPUT type=text id=FarmRadius size=3 maxlength=3 value='+ FarmOptions.MaxDistance +'><INPUT id=FarmSearch type=submit value="Search again"></td><tr>';
	m += '<TR><TD>Might:</td>';
	m += '<TD width=50>Min.:<INPUT type=text id=FarmMinMight size=8 maxlength=8 value='+ FarmOptions.MinMight +'></td>';
	m += '<TD>Max.:<INPUT type=text id=FarmMaxMight size=9 maxlength=9 value='+ FarmOptions.MaxMight +'></td></tr>';
	m += '<TR><TD>Farm if inactive for more then: </td>';
	m += '<TD><INPUT type=text id=FarmInactive size=3 value='+ FarmOptions.Inactive +'> days (checked every 6 hours)</td></table>';
	m += '<TABLE id=pbfarmstats width=90% height=0% class=pbTab><TR align="left"><TR><TD width=100>City:</td>';
	for (i=1;i<=Seed.cities.length;i++) {
	 	m+='<TD class=pbCityEn><INPUT id=CityEnable'+ i +'  type=checkbox '+(FarmOptions.CityEnable[i]?'CHECKED':'')+'>'+ Seed.cities[i-1][1] +'</td>';
     }
	m += '</tr></table><TABLE id=pbfarmstats width=90% height=0% class=pbTab><TR align="left"><TD width=100>City Level:</td>';
	for (i=1;i<=12;i++) {
	 	m+='<TD class=pbCityOpt><INPUT id=CityLevel'+ i +'  type=checkbox '+(FarmOptions.CityLevel[i]?'CHECKED':'')+'>'+ i +'</td>';
     }
	m += '</tr></table><TABLE id=pbfarmstats width=90% height=0% class=pbTab><TR align="left"><TR><TD width=100>Diplomacy:</td>';
	for (i=0;i<t.DipArray.length;i++) {
	 	m+='<TD class=pbDipOpt><INPUT id=Diplomacy'+ t.DipArray[i] +'  type=checkbox '+(FarmOptions.Diplomacy[t.DipArray[i]]?'CHECKED':'')+'>'+ t.DipArray[i] +'</td>';
     }
	m+='</tr></table>';
	
     m += '<DIV id=pbTraderDivD class=pbStat>FARMING TROOPS</div>';
     m += '<TABLE id=pbaddreasignroute width=100% height=0% class=pbTab><TR align="center">';
        m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_50.jpg?6545"></td>';
        m += '<TD>Supply Troop</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_50.jpg?6545"></td>'
        m += '<TD>Militiaman</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_50.jpg?6545"></td>'
        m += '<TD>Scout</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_50.jpg?6545"></td>'
        m += '<TD>Pikeman</td></tr>'
        m += '<TR><TD  class=pbTroopOpt><INPUT id=FarmTroop1  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[1] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop2  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[2] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop3  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[3] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop4  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[4] +'\></td></tr>';
        m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_50.jpg?6545"></td>';
        m += '<TD>Swordsman</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_50.jpg?6545"></td>'
        m += '<TD>Archer</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_50.jpg?6545"></td>'
        m += '<TD>Cavalry</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_50.jpg?6545"></td>'
        m += '<TD>Heavy Cavalry</td></tr>'
        m += '<TR><TD  class=pbTroopOpt><INPUT id=FarmTroop5  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[5] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop6  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[6] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop7  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[7] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop8  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[8] +'\></td></tr>';
        m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_50.jpg?6545"></td>';
        m += '<TD>Supply Wagon</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_50.jpg?6545"></td>'
        m += '<TD>Ballista</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_50.jpg?6545"></td>'
        m += '<TD>Battering Ram</td>'
        m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_50.jpg?6545"></td>'
        m += '<TD>Catapult</td></tr>'
        m += '<TR><TD  class=pbTroopOpt><INPUT id=FarmTroop9  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[9] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop10  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[10] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop11  type=text size=10 maxlength=10 value='+ FarmOptions.Troops[11] +'\></td>';
        m += '<TD  class=pbTroopOpt><INPUT id=FarmTroop12 type=text size=10 maxlength=10 value='+ FarmOptions.Troops[12] +'\></td></tr></table>';
    
     t.myDiv.innerHTML = m;
	  t.checkFarmData();
	   if(t.nextattack == null) t.nextattack = setInterval(t.getnextCity, FarmOptions.SendInterval*1000);
     setInterval(t.startdeletereports,(120000));
     setInterval( t.checkMarches ,2000);
     document.getElementById('pbFarmcity').options.length=0;
		for (i=0;i<Seed.cities.length;i++){
			var o = document.createElement("option");
			o.text = Seed.cities[i][1]
			o.value = i+1;
			document.getElementById("pbFarmcity").options.add(o);
	}
	document.getElementById('FarmInterval').options.length=0;
		for (i=0;i<t.interval.length;i++){
			var o = document.createElement("option");
			o.text = t.interval[i];
			o.value = i;
			document.getElementById("FarmInterval").options.add(o);
	}
	document.getElementById('FarmInterval').value = FarmOptions.Interval;	
    for(i=0;i<Seed.cities.length;i++){
    		var elem = 'pdtotalFarm'+i;
    		if (t.FarmArray[i+1] == undefined) document.getElementById(elem).innerHTML = 'No Data';
    		else document.getElementById(elem).innerHTML =  'Farms :' + t.FarmArray[i+1].length +'/'+ t.helpArray[i+1].length;
    }
    document.getElementById('FarmInterval').addEventListener('change', function(){
			FarmOptions.Interval = document.getElementById('FarmInterval').value;
			saveFarmOptions();
	} , false);
	document.getElementById('FarmRallyClip').addEventListener('change', function(){
			FarmOptions.RallyClip = document.getElementById('FarmRallyClip').value;
			saveFarmOptions();
	} , false);
	document.getElementById('FarmReports').addEventListener('change', function(){
			FarmOptions.DeleteReports = document.getElementById('FarmReports').checked;
			saveFarmOptions();
	} , false);
	document.getElementById('FarmRadius').addEventListener('change', function(){
			FarmOptions.MaxDistance = parseInt(document.getElementById('FarmRadius').value);
			saveFarmOptions();
	} , false);
	document.getElementById('FarmAttSearch').addEventListener('click', function(){t.toggleBarbState(this)} , false);
	document.getElementById('FarmSearch').addEventListener('click', function(){
		for (i=1;i<=Seed.cities.length;i++) GM_deleteValue('Farms_' + Seed.player['name'] + '_city_' + i + '_' + getServerId());
		for(i=0;i<Seed.cities.length;i++){
	    		var elem = 'pdtotalFarm'+i;
	    		document.getElementById(elem).innerHTML = 'No Data';
	    }
		t.checkFarmData();
	} , false);
	document.getElementById('pbpaintFarms').addEventListener('click', function(){t.showFarms(document.getElementById("pbFarmcity").value,Seed.cities[document.getElementById("pbFarmcity").value -1][1]);},false);  
  
	document.getElementById('FarmMinMight').addEventListener('change', function(){
			FarmOptions.MinMight = parseInt(document.getElementById('FarmMinMight').value);
			t.FilterFarms();
			saveFarmOptions(); 
	} , false);
	document.getElementById('FarmMaxMight').addEventListener('change', function(){
			FarmOptions.MaxMight = parseInt(document.getElementById('FarmMaxMight').value);
			t.FilterFarms();
			saveFarmOptions(); 
	} , false);
	document.getElementById('FarmInactive').addEventListener('change', function(){
			FarmOptions.Inactive = parseInt(document.getElementById('FarmInactive').value);
			t.FilterFarms();
			saveFarmOptions(); 
	} , false);
  
	var element = document.getElementsByClassName('pbTroopOpt');
	 for (k=0;k<element.length;k++){
	    	element[k].addEventListener('change', function(){
					for (i=1;i<=10;i++){
						FarmOptions.Troops[i] = document.getElementById('FarmTroop' + i).value;
						saveFarmOptions(); 
					}
			}, false);
	  }
	
	element = document.getElementsByClassName('pbCityOpt');
	 for (k=0;k<element.length;k++){
	    	element[k].addEventListener('change', function(){
					for (i=1;i<=12;i++){
						FarmOptions.CityLevel[i] = document.getElementById('CityLevel' + i).checked;
            			saveFarmOptions(); 
					}
					t.FilterFarms();
			}, false);
	  }
	
	element = document.getElementsByClassName('pbCityEn');
	 for (k=0;k<element.length;k++){
	    	element[k].addEventListener('change', function(){
					for (i=1;i<=Seed.cities.length;i++){
						FarmOptions.CityEnable[i] = document.getElementById('CityEnable' + i).checked;
            			saveFarmOptions(); 
					}
					t.FilterFarms();
			}, false);
	  }
	
	element = document.getElementsByClassName('pbDipOpt');
	 for (k=0;k<element.length;k++){
	    	element[k].addEventListener('change', function(){
					for (i=0;i<t.DipArray.length;i++){
						FarmOptions.Diplomacy[t.DipArray[i]] = document.getElementById('Diplomacy' + t.DipArray[i]).checked;
            			saveFarmOptions();
					}
					t.FilterFarms();
			}, false);
      
	  }
	
   },
   

	checkMarches: function () {
		var t = Tabs.farm;
		for (i=0;i<FarmOptions.FarmMarches.length;i++){
				var cityId = "city"+ FarmOptions.FarmMarches[i]["cityId"];
				var city = FarmOptions.FarmMarches[i]["city"];
				var marchId = "m" + FarmOptions.FarmMarches[i]["marchId"];
				if (Seed.queue_atkp[cityId][marchId] !=undefined){
							if (Seed.queue_atkp[cityId][marchId].marchStatus == 8  && Seed.queue_atkp[cityId][marchId].hasUpdated) {
									FarmOptions.Checks++;
									saveFarmOptions();
									document.getElementById('FarmCheck').innerHTML = "Attacks: " + FarmOptions.Attacks + " - Checks:" + FarmOptions.Checks;
									for(u=1;u<=12;u++) if (parseInt(Seed.queue_atkp[cityId][marchId]["unit"+u+"Return"]) < parseInt(Seed.queue_atkp[cityId][marchId]["unit"+u+"Count"])){
												t.FarmArray[FarmOptions.FarmMarches[i]["city"]][FarmOptions.FarmMarches[i]["number"]]["lost"] = true;
												t.FarmArray[FarmOptions.FarmMarches[i]["city"]][FarmOptions.FarmMarches[i]["number"]]["enabled"] = false;
									}
									for (a=0;a<t.helpArray[FarmOptions.FarmMarches[i]["city"]].length;a++){
											for (b=0;b<t.FarmArray[FarmOptions.FarmMarches[i]["city"]].length;b++){
												 if (parseInt(t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['x']) == parseInt(t.helpArray[FarmOptions.FarmMarches[i]["city"]][b]['x']) && parseInt(t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['y']) == parseInt(t.helpArray[FarmOptions.FarmMarches[i]["city"]][b]['y'])){
							           					t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['gold'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['gold'];
							           					t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['resource1'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['resource1'];
														t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['resource2'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['resource2'];
														t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['resource3'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['resource3'];
														t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['resource4'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['resource4'];
														t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['empty'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['empty'];
														t.helpArray[FarmOptions.FarmMarches[i]["city"]][a]['lost'] = t.FarmArray[FarmOptions.FarmMarches[i]["city"]][b]['lost'];
							       					}    
											}
									}
									GM_setValue('Farms_' + Seed.player['name'] + '_city_' + FarmOptions.FarmMarches[i]["city"] + '_' + getServerId(), JSON2.stringify(t.helpArray[FarmOptions.FarmMarches[i]["city"]]));
									FarmOptions.FarmMarches.splice(i,1);
									saveFarmOptions();
							}
				} else {
					FarmOptions.FarmMarches.splice(i,1);
					saveFarmOptions();
				}	
		}
	 },	
	
   checkInactives : function (citynumber,city,FarmNumber,xcoord,ycoord,kid,uid,u1,u2,u3,u4,u5,u6,u7,u8,u9,u10,u11,u12){
        var t = Tabs.farm;
        var now = new Date().getTime()/1000.0;
		var hours = (now - t.FarmArray[city][FarmOptions.FarmNumber[city]]['LastCheck']) / 3600;
        if (t.FarmArray[city][FarmOptions.FarmNumber[city]]['DaysInactive'] == "?" || hours > 6){
				var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		        params.pid = uid;
		        new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
		                 method: "post",
		                  parameters: params,
		                  onSuccess: function (transport) {
		                            var rslt = eval("(" + transport.responseText + ")");
		                            var lastLogin = rslt.playerInfo.lastLogin;
									var fullDate = lastLogin.substr(0,4) +", "+ lastLogin.substr(5,2) +", "+ lastLogin.substr(8,2) ;
									var time = new Date (fullDate).getTime()/1000;
		                            var days = Math.floor((now - time) / 86400); 
									t.FarmArray[city][FarmOptions.FarmNumber[city]]['DaysInactive'] = days;
									for (i=0;i<t.helpArray[city].length;i++){
												 if (xcoord == parseInt(t.helpArray[city][i]['x']) && ycoord == parseInt(t.helpArray[city][i]['y'])){
					                   			 t.helpArray[city][i]['DaysInactive'] = days;
					                   			 t.helpArray[city][i]['LastCheck'] = now;
					               				}    
									}
									GM_setValue('Farms_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.helpArray[city]));
									if (days > FarmOptions.Inactive) {
										t.doBarb(citynumber,city,FarmNumber,xcoord,ycoord,kid,u1,u2,u3,u4,u5,u6,u7,u8,u9,u10,u11,u12);
		                            } else 	{
												FarmOptions.FarmNumber[city]++;
												saveFarmOptions();
												t.barbing();
											}
		                   },
		                  onFailure: function (rslt) {
		                            notify (rslt);
		                  },
		        });
		} else {
			if (t.FarmArray[city][FarmOptions.FarmNumber[city]]['DaysInactive'] > FarmOptions.Inactive) {
				t.doBarb(citynumber,city,FarmNumber,xcoord,ycoord,kid,u1,u2,u3,u4,u5,u6,u7,u8,u9,u10,u11,u12);
			 } 	else{
					FarmOptions.FarmNumber[city]++;
					saveFarmOptions();
					t.barbing();
				}
		}
    },
    
  	showFarms: function (citynumber,cityname) {
		var t = Tabs.farm;
		var popTradeRoutes = null;
		t.popTradeRoutes = new pbPopup('pbShowFarms', 0, 0, 1100, 485, true, function() {clearTimeout (1000);});
		var m = '<DIV style="max-height:460px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbShowBarbs" id="pbBars">';       
		t.popTradeRoutes.getMainDiv().innerHTML = '</table></div>' + m;
		t.popTradeRoutes.getTopDiv().innerHTML = '<TD><center><B>Farms for city: '+cityname+'</center></td>';
		t.paintFarms(citynumber,cityname);
		t._addTabHeader(citynumber,cityname);
		t.popTradeRoutes.show(true)	;
	 },
	
	
		ToggleFarms: function(citynumber) {
			var t = Tabs.farm;
			var id=0;
			var element_class = document.getElementsByClassName('Farm');
			       for (d = 1; d <= t.FarmArray[citynumber].length; d++) {
				        id = d-1;
						var ele = document.getElementById('FarmToggle' + d);
			      if (ele.checked) {
                t.FarmArray[citynumber][id].enabled = true;
                t.FarmArray[citynumber][id].lost = false;
                t.FarmArray[citynumber][id].empty = 0;   
            }
						else t.FarmArray[citynumber][id].enabled = false;
				}
			for (i=0;i<t.helpArray[citynumber].length;i++){
					for (j=0;j<t.FarmArray[citynumber].length;j++){
						 if (parseInt(t.FarmArray[citynumber][j]['x']) == parseInt(t.helpArray[citynumber][i]['x']) && parseInt(t.FarmArray[citynumber][j]['y']) == parseInt(t.helpArray[citynumber][i]['y'])) t.helpArray[citynumber][i].enabled = t.FarmArray[citynumber][j].enabled;
					}
			}
			GM_setValue('Farms_' + Seed.player['name'] + '_city_' + citynumber + '_' + getServerId(), JSON2.stringify(t.helpArray[citynumber]));
		},
		
 	paintFarms: function(i,cityname){
	        var t = Tabs.farm;
			for (k=(t.FarmArray[i].length-1);k>=0;k--){t._addTab(i,cityname,k+1,t.FarmArray[i][k]['enabled'], t.FarmArray[i][k]['x'], t.FarmArray[i][k]['y'],t.FarmArray[i][k]['dist'], t.FarmArray[i][k]['level'],t.FarmArray[i][k]['AllianceName'], t.FarmArray[i][k]['Diplomacy'], t.FarmArray[i][k]['PlayerName'], t.FarmArray[i][k]['cityName'],t.FarmArray[i][k]['might'], t.FarmArray[i][k]['cityNumber'], t.FarmArray[i][k]['attacked'],t.FarmArray[i][k]['DaysInactive'],t.FarmArray[i][k]['lost'],t.FarmArray[i][k]['empty'],t.FarmArray[i][k]['gold'],t.FarmArray[i][k]['resource1'],t.FarmArray[i][k]['resource2'],t.FarmArray[i][k]['resource3'],t.FarmArray[i][k]['resource4']);}
	    },


  		_addTab: function(citynumber,cityname,queueId,status,X,Y,dist,level,AllianceName,diplomacy,playerName,cityName,might,cityNumber,attacked,DaysInactive,lost,empty,gold,rec1,rec2,rec3,rec4){
		 	var t = Tabs.farm;
		     var row = document.getElementById('pbBars').insertRow(0);
		     row.vAlign = 'top';	 
         	 if (lost) row.style.color = "red";
		     if (!lost && empty == 0) row.style.color = "black";
		   	 if (FarmOptions.Inactive > DaysInactive) row.style.color = "orange";
		     row.insertCell(0).innerHTML = queueId;
			 row.insertCell(1).innerHTML = coordLink(X,Y);
		     row.insertCell(2).innerHTML = dist;
		   	 row.insertCell(3).innerHTML = level;
		  	 row.insertCell(4).innerHTML = AllianceName;
		  	 row.insertCell(5).innerHTML = diplomacy;    
		   	 row.insertCell(6).innerHTML = playerName;
		  	 row.insertCell(7).innerHTML = cityName;
	   	   	 row.insertCell(8).innerHTML = addCommas(might);
	   		 row.insertCell(9).innerHTML = DaysInactive;
       	 	 row.insertCell(10).innerHTML = attacked;
		     row.insertCell(11).innerHTML = '<INPUT class=Farm id="FarmToggle' + queueId + '" type=checkbox>';
		     
			var element_class = document.getElementsByClassName('Farm');
			       for (c = 0; c < element_class.length; c++) {
						element_class[c].checked = t.FarmArray[citynumber][c].enabled;
			            element_class[c].addEventListener('click', function(){t.ToggleFarms(citynumber)}, false);
					}
		 },
		
		 _addTabHeader: function(citynumber,cityname) {
		 var t = Tabs.farm;
		     var row = document.getElementById('pbBars').insertRow(0);
		     row.vAlign = 'top';
		     row.insertCell(0).innerHTML = "Id";
		     row.insertCell(1).innerHTML = "Coords";
		     row.insertCell(2).innerHTML = "Dist.";
		     row.insertCell(3).innerHTML = "Level";
		     row.insertCell(4).innerHTML = "Allaince Name";
			row.insertCell(5).innerHTML = "Diplomacy";
			row.insertCell(6).innerHTML = "Player Name";
			row.insertCell(7).innerHTML = "City Name";
			row.insertCell(8).innerHTML = "Might";
			row.insertCell(9).innerHTML = "Inactive";
      		row.insertCell(10).innerHTML = "# Attacks";
		   },
		
		
  startdeletereports : function (){
	var t = Tabs.farm;
	if (!FarmOptions.DeleteReports) return;
	if(!t.deleting){
		t.deleting = true;
		t.fetchbarbreports(0, t.checkbarbreports);
	}
  },
  fetchbarbreports : function (pageNo, callback){
	var t = Tabs.farm;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	if(pageNo > 0)
		params.pageNo = pageNo;
	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
			callback(rslt);
        },
        onFailure: function () {
        },
    });
  },
  checkbarbreports : function (rslt){
	var t = Tabs.farm;
	if(!rslt.ok){
		return;
	}
	if(rslt.arReports.length < 1){
		return;
	}
	var reports = rslt.arReports;
	var totalPages = rslt.totalPages;
		var deletes1 = new Array();
		for(k in reports){
			for (i=1;i<=Seed.cities.length;i++){
					var x=Seed.cities[i-1]["2"];
					var y=Seed.cities[i-1]["3"];
					for (j=0;j<t.FarmArray[i].length;j++){
								if (reports[k].side1XCoord == x && reports[k].side1YCoord == y && reports[k].side0XCoord == t.FarmArray[i][j]["x"] && reports[k].side0YCoord == t.FarmArray[i][j]["y"]) deletes1.push(k.substr(2));
					}
			}	
		}
		if(deletes1.length > 0){
			t.deletereports(deletes1);
		} else {
			t.deleting = false;
			return;
		}
  },

  deletereports : function (deletes1){
	var t = Tabs.farm;
	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	params.s1rids = deletes1.join(",");
	params.s0rids = '';
	params.cityrids = '';
	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
		method: "post",
		parameters: params,
		onSuccess: function (rslt) {
			Seed.newReportCount = parseInt(Seed.newReportCount) - parseInt(deletes1.length);
			t.fetchbarbreports(0, t.checkbarbreports);
		},
		onFailure: function () {
		},
	});
  },

  isMyself: function(userID){
	if(!Seed.players["u"+userID])
		return false;
	if(Seed.players["u"+userID].n == Seed.player.name)
		return true;
	else
		return false;
	return false;
  },

  checkFarmData: function(){
  	var t = Tabs.farm;
	  for (i=1;i<=Seed.cities.length;i++){
		t.helpArray[i] = [];
	  	var myarray = (GM_getValue('Farms_' + Seed.player['name'] + '_city_' + i + '_' + getServerId()));
		if (myarray == undefined && t.searchRunning==false) {
			t.searchRunning = true;
	  		t.lookup=i;
	  		t.opt.startX=parseInt(Seed.cities[(i-1)][2]);
	  		t.opt.startY=parseInt(Seed.cities[(i-1)][3]);  
	  		t.clickedSearch();
	  	}
		if (myarray != undefined){
			myarray = JSON2.parse(myarray);
			//if(AttackOptions.Method == 'distance') 
			t.helpArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['dist'];b = b['dist'];return a == b ? 0 : (a < b ? -1 : 1);});
			//if(AttackOptions.Method == 'level') t.helpArray[i] = myarray.sort(function function (a,b) {a = parseInt(a['level']);b = parseInt(b['level']);return (a > b )? -1 : ((a < b ? 1 : t.SortDist(a,b)));});
			//if(AttackOptions.Method == 'lowlevel') t.helpArray[i] = myarray.sort(function function (a,b) {a = parseInt(a['level']);b = parseInt(b['level']);return (a < b )? -1 : ((a > b ? 1 : t.SortDist(a,b)));});
	  		GM_setValue('Farms_' + Seed.player['name'] + '_city_' + i + '_' + getServerId(), JSON2.stringify(t.helpArray[i]));
	  		}
	  	}
	t.FilterFarms();
  },
  
  FilterFarms: function() {
	var t = Tabs.farm;
	if (t.searchRunning) return;
    t.FarmArray = new Array();
	t.FarmArray["1"] = new Array();
	t.FarmArray["2"] = new Array();
	t.FarmArray["3"] = new Array();
	t.FarmArray["4"] = new Array();
	t.FarmArray["5"] = new Array();
	t.FarmArray["6"] = new Array();
	t.FarmArray["7"] = new Array();
	t.FarmArray["8"] = new Array();	
	for (u=1;u<=Seed.cities.length;u++){		
		for (i=0;i<t.helpArray[u].length;i++){
			var checkLvl = false;
			var checkMight = false;
			var checkDip = false;
			var checkAlliance = false;
			var AllianceName = "";
			for (j=1;j<=12;j++) if (FarmOptions.CityLevel[j] && t.helpArray[u][i].level == j) checkLvl=true;
			if (Seed.allianceDiplomacies.allianceName != undefined) AllianceName = Seed.allianceDiplomacies.allianceName;
			if (t.helpArray[u][i].AllianceName != AllianceName) checkAlliance = true;
			if (t.helpArray[u][i].might >= FarmOptions.MinMight && t.helpArray[u][i].might <= FarmOptions.MaxMight) checkMight = true;
			for (j in FarmOptions.Diplomacy) if (FarmOptions.Diplomacy[j] && t.helpArray[u][i].Diplomacy == j) checkDip=true;
			if (checkLvl && checkMight && checkDip && checkAlliance) t.FarmArray[u].push (t.helpArray[u][i]);
		}
    	var elem = 'pdtotalFarm'+(u-1);
    	if (t.FarmArray[u] == undefined) document.getElementById(elem).innerHTML = 'No Data';
    	else document.getElementById(elem).innerHTML =  'Farms :' + t.FarmArray[u].length +'/'+ t.helpArray[u].length;
	}
  },


  SortDist: function(a,b) {
  	a = parseFloat(a['dist']);
  	b = parseFloat(b['dist']);
  	return (a < b )? -1 : ((a > b ? 1 : 0));
  },
  
  toggleBarbState: function(obj){
	var t = Tabs.farm;
	if (FarmOptions.Running == true) {
		FarmOptions.Running = false;
		obj.value = "Farm = OFF";
		saveFarmOptions();
		t.nextattack = null;
    t.updateSeedTimer = null;
	} else {
		FarmOptions.Running = true;
		obj.value = "Farm = ON";
		saveFarmOptions();
		t.checkFarmData();
		t.nextattack = setInterval(t.getnextCity,(FarmOptions.SendInterval*1000));
	}
  },
  
  barbing : function(){
  	   var t = Tabs.farm;
	   var city = t.city;
	   var u1 = FarmOptions.Troops[1];
	   var u2 = FarmOptions.Troops[2];
	   var u3 = FarmOptions.Troops[3];
	   var u4 = FarmOptions.Troops[4];
	   var u5 = FarmOptions.Troops[5];
	   var u6 = FarmOptions.Troops[6];
	   var u7 = FarmOptions.Troops[7];
       var u8 = FarmOptions.Troops[8];
       var u9 = FarmOptions.Troops[9];
       var u10 = FarmOptions.Troops[10];
       var u11 = FarmOptions.Troops[11];
       var u12 = FarmOptions.Troops[12];
       var now = new Date().getTime()/1000.0;
       now = now.toFixed(0);
       citynumber = Seed.cities[city-1][0];
       cityID = 'city' + citynumber; 
	   
       t.getAtkKnight(cityID);
       t.getRallypointLevel(cityID);
	   var slots=0;
	   if (Seed.queue_atkp[cityID] != undefined){
	       for(var k in Seed.queue_atkp[cityID])
		      slots++;
		      if(Seed.queue_atkp[cityID].toSource() == "[]")
		  slots = 0;
		}
	  else slots=0; 
       
       var element2 = 'pddataFarmarray'+(city-1); 
       document.getElementById(element2).innerHTML =  'RP: (' + slots + '/' + t.rallypointlevel +')';
	   
	   if (!FarmOptions.CityEnable[city]) return;
	   if ((t.rallypointlevel-FarmOptions.RallyClip) <= slots) return;
	   if (t.knt.toSource() == "[]") return; 
		if (u1 > parseInt(Seed.units[cityID]['unt1']) || u2 > parseInt(Seed.units[cityID]['unt2']) || u3 > parseInt(Seed.units[cityID]['unt3']) || u4 > parseInt(Seed.units[cityID]['unt4']) || u5 > parseInt(Seed.units[cityID]['unt5']) || u6 > parseInt(Seed.units[cityID]['unt6']) || u7 > parseInt(Seed.units[cityID]['unt7']) || u8 > parseInt(Seed.units[cityID]['unt8']) || u9 > parseInt(Seed.units[cityID]['unt9']) || u10 > parseInt(Seed.units[cityID]['unt10']) || u11 > parseInt(Seed.units[cityID]['unt11']) || u12 > parseInt(Seed.units[cityID]['unt12'])) return;
		if (FarmOptions.FarmNumber[city]>=t.FarmArray[city].length) FarmOptions.FarmNumber[city]=0;
	    var kid = t.knt[0].ID;

		 var interval = 0;
		 switch(FarmOptions.Interval){
				case "1":interval = 1;break;
				case "2":interval = 2;break;
				case "3":interval = 3;break;
				case "4":interval = 6;break;
				case "5":interval = 12;break;
				case "6":interval = 24;break;
		}
		
         var check=0;
         while (check == 0){
         check=1;
      		 for (i=1;i<=12;i++){
      				if (FarmOptions.Troops[i] > parseInt(Seed.units[cityID]['unt'+i])) check=0;
      		 } 
           if (FarmOptions.Troops[1] == 0 && FarmOptions.Troops[2] == 0 && FarmOptions.Troops[3] == 0 && FarmOptions.Troops[4] == 0 && FarmOptions.Troops[5] == 0 && FarmOptions.Troops[6] == 0 && FarmOptions.Troops[7] == 0 && FarmOptions.Troops[8] == 0 && FarmOptions.Troops[9] == 0 &&FarmOptions.Troops[10] == 0 && FarmOptions.Troops[11] == 0 && FarmOptions.Troops[12] == 0) check=0;
           if (!t.FarmArray[city][FarmOptions.FarmNumber[city]]['enabled']) check=0;
		       if (now < (parseInt(t.FarmArray[city][FarmOptions.FarmNumber[city]]['time']) + (3600 * interval))) check=0;
           if (check ==0) FarmOptions.FarmNumber[city]++;
           if (FarmOptions.FarmNumber[city]>=t.FarmArray[city].length) {
	               FarmOptions.FarmNumber[city]=0;
         		   break;
            }
       }
       	if (check == 0) return;
	   
	    var xcoord = t.FarmArray[city][FarmOptions.FarmNumber[city]]['x'];
        var ycoord = t.FarmArray[city][FarmOptions.FarmNumber[city]]['y'];
        var uid = t.FarmArray[city][FarmOptions.FarmNumber[city]]['UserId'];
		saveFarmOptions();
       	if ((t.rallypointlevel - FarmOptions.RallyClip) > slots) t.checkInactives(citynumber,city,FarmOptions.FarmNumber[city],xcoord,ycoord,kid,uid,u1,u2,u3,u4,u5,u6,u7,u8,u9,u10,u11,u12);
  },
  
  getnextCity: function(){
	var t = Tabs.farm;
    if (!FarmOptions.Running) return;
	if(t.searchRunning) return;
	var city = t.city+1;
	if (city>Seed.cities.length){
		city=1;
	}
	t.city = city;
	t.barbing();
  },
  
  getRallypointLevel: function(cityId){
    var t = Tabs.farm;
    for (var o in Seed.buildings[cityId]){
  	var buildingType = parseInt(Seed.buildings[cityId][o][0]);
  	var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
  	if (buildingType == 12) t.rallypointlevel=parseInt(buildingLevel);
     }
  }, 
  
  getAtkKnight : function(cityID){
     var t = Tabs.farm;
     t.knt = new Array();
     t.getRallypointLevel(cityID);
     for (k in Seed.knights[cityID]){
     		if (Seed.knights[cityID][k]["knightStatus"] == 1 && Seed.leaders[cityID]["resourcefulnessKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["politicsKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["combatKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["intelligenceKnightId"] != Seed.knights[cityID][k]["knightId"]){
     			t.knt.push ({
     				Name:   Seed.knights[cityID][k]["knightName"],
     				Combat:	Seed.knights[cityID][k]["combat"],
     				ID:		Seed.knights[cityID][k]["knightId"],
     			});
     		}
     }
     t.knt = t.knt.sort(function sort(a,b) {a = a['Combat'];b = b['Combat'];return a == b ? 0 : (a > b ? -1 : 1);});
  },
  
  doBarb: function(cityID,counter,number,xcoord,ycoord,kid,u1,u2,u3,u4,u5,u6,u7,u8,u9,u10,u11,u12){
  		var t = Tabs.farm;
  		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		params.cid=cityID;
  		params.type=4;
  	  params.kid=kid;
  		params.xcoord = xcoord;
  		params.ycoord = ycoord;
  		if (u1>0) params.u1=u1;
		  if (u2>0)params.u2=u2;
		  if (u3>0)params.u3=u3;
		  if (u4>0)params.u4=u4;
		  if (u5>0)params.u5=u5;
		  if (u6>0)params.u6=u6;
  		if (u7>0)params.u7=u7;
  		if (u8>0)params.u8=u8;
  		if (u9>0)params.u9=u9;
  		if (u10>0)params.u10=u10;
  		if (u11>0)params.u11=u11;
  		if (u12>0)params.u12=u12;
  		params.gold =0;
      params.r1=0;
      params.r2=0,
      params.r3=0;
      params.r4=0;
      params.r5=0;
      
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  		         loading: true,
  		         onSuccess: function (transport) {
  		         var rslt = eval("(" + transport.responseText + ")");
				 if (rslt.ok) {
  		         var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
  		         var ut = unsafeWindow.unixtime();
  		         var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
  		         var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
  		         for(i = 0; i <= unitsarr.length; i++){
  		         	if(params["u"+i]){
  		         	unitsarr[i] = params["u"+i];
  		         	}
  		         }
  		         var currentcityid = params.cid;
  		         unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
                 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
				 var slots=0;
			     for(var k in Seed.queue_atkp['city'+cityID]) slots++;
			     if(Seed.queue_atkp['city'+cityID].toSource() == "[]") slots = 0;
				 var element1 = 'pddataFarmarray'+(counter-1); 
				 document.getElementById(element1).innerHTML =  'RP: (' + slots + '/' + t.rallypointlevel +')';
  		         var now = new Date().getTime()/1000.0;
  		         now = now.toFixed(0);
  		         t.FarmArray[counter][number]['time'] = now;
                 t.FarmArray[counter][number]['attacked']++;
				 FarmOptions.FarmMarches.push ({city:counter,cityId:cityID,marchId:rslt.marchId,number:number});
                 FarmOptions.FarmNumber[counter]++;
				 FarmOptions.Attacks++;
				 saveFarmOptions();
				 document.getElementById('FarmCheck').innerHTML = "Attacks: " + FarmOptions.Attacks + " - Checks:" + FarmOptions.Checks;
				 for (i=0;i<t.helpArray[counter].length;i++){
						for (j=0;j<t.FarmArray[counter].length;j++){
							 if (parseInt(t.FarmArray[counter][j]['x']) == parseInt(t.helpArray[counter][i]['x']) && parseInt(t.FarmArray[counter][j]['y']) == parseInt(t.helpArray[counter][i]['y'])){
                   					t.helpArray[counter][i]['time'] = t.FarmArray[counter][j]['time'];
                   					t.helpArray[counter][i]['attacked'] = t.FarmArray[counter][j]['attacked'];
               					}    
						}
				}
				GM_setValue('Farms_' + Seed.player['name'] + '_city_' + counter + '_' + getServerId(), JSON2.stringify(t.helpArray[counter]));
               } 
  		         },
  		         onFailure: function () {}
  		 });
  	 saveFarmOptions();
  },

  clickedSearch : function (){
    var t = Tabs.farm;
    t.opt.searchType = 0; 
    t.opt.maxDistance = FarmOptions.MaxDistance; 
    t.opt.searchShape = 'circle'; 
    t.mapDat = [];
    t.firstX =  t.opt.startX - t.opt.maxDistance;
    t.lastX = t.opt.startX + t.opt.maxDistance;
    t.firstY =  t.opt.startY - t.opt.maxDistance;
    t.lastY = t.opt.startY + t.opt.maxDistance;
    t.tilesSearched = 0;
    t.tilesFound = 0;
    t.curX = t.firstX;
    t.curY = t.firstY;
    var xxx = t.MapAjax.normalize(t.curX);
    var yyy = t.MapAjax.normalize(t.curY);
    var element = 'pddataFarm'+(t.lookup-1);
    document.getElementById(element).innerHTML = 'Searching at '+ xxx +','+ yyy;
   
    setTimeout (function(){t.MapAjax.request (xxx, yyy, 15, t.mapCallback)}, MAP_DELAY);
  },
  
  mapCallback : function (left, top, width, rslt){
    var t = Tabs.farm;
    if (!t.searchRunning)
      return;
    if (!rslt.ok){
      t.stopSearch ('ERROR: '+ rslt.errorMsg);
      return;
    }
    map = rslt.data;
    for (k in map){
      var dist = distance (t.opt.startX, t.opt.startY, map[k].xCoord, map[k].yCoord); 
      var CityCheck = true;
	  var who = "u" + map[k].tileUserId;
	  var AllianceName = "";
 	  if (map[k].cityName == null && map[k].misted ==false) CityCheck = false;
	 if (t.isMyself(map[k].tileUserId)) CityCheck = false;
	 if (map[k].tileType== 51 && CityCheck) {
			var Diplomacy = "neutral";
			for (DipStatus in t.DipArray) {
				var AllianceId = 0;
				if (rslt.userInfo[who] != undefined) AllianceId = "a" + rslt.userInfo[who].a;				
				for (alliance in Seed.allianceDiplomacies[t.DipArray[DipStatus]]) if (Seed.allianceDiplomacies[t.DipArray[DipStatus]][AllianceId] != undefined) Diplomacy = t.DipArray[DipStatus];
			}
			if (rslt.allianceNames[AllianceId] != undefined) AllianceName = rslt.allianceNames[AllianceId];
			if (Diplomacy == "neutral" && AllianceName =="") Diplomacy = "unallied";
			t.mapDat.push ({time:0,empty:0,lost:false,enabled:'true',attacked:0,DaysInactive:"?",LastCheck:0,Diplomacy:Diplomacy,UserId:map[k].tileUserId,AllianceName:AllianceName,x:map[k].xCoord,y:map[k].yCoord,dist:dist,level:map[k].tileLevel,PlayerName:rslt.userInfo[who].n,cityName:map[k].cityName,might:rslt.userInfo[who].m,cityNumber:map[k].cityNum});
	  }
	}
    t.tilesSearched += (15*15);

    t.curX += 15;
    if (t.curX > t.lastX){
      t.curX = t.firstX;
      t.curY += 15;
      if (t.curY > t.lastY){
        var element = 'pdtotalFarm'+(t.lookup-1);
        document.getElementById(element).innerHTML = 'Found: ' + t.mapDat.length;
        var element = 'pddataFarm'+(t.lookup-1);
        document.getElementById(element).innerHTML = "";
        GM_setValue('Farms_' + Seed.player['name'] + '_city_' + t.lookup + '_' + getServerId(), JSON2.stringify(t.mapDat));
        t.searchRunning = false;
        for (y=1;y<=8;y++) FarmOptions.FarmNumber[y] = 0;
        t.checkFarmData();
        return;
      }
    }
    var x = t.MapAjax.normalize(t.curX);
    var y = t.MapAjax.normalize(t.curY);
    var element = 'pddataFarm'+(t.lookup-1);
    document.getElementById(element).innerHTML = 'Searching at '+ x +','+ y;
    setTimeout (function(){t.MapAjax.request (x, y, 15, t.mapCallback)}, MAP_DELAY);
  },
  
  stopSearch : function (msg){
    var t = Tabs.farm;
	var element = 'pddataFarm'+(t.lookup-1);
        document.getElementById(element).innerHTML = msg;
    t.searchRunning = false;
  },
  
  hide : function (){
  
  },

  show : function (){
  
  },

}; 


/*********************************** Options Tab ***********************************/
Tabs.Options = {
  tabOrder: 30,
  tabLabel : 'Options',
  cont : null,
  curTabBut : null,
  curTabName : null,
  fixAvailable : {},

  init : function (div){
    var t = Tabs.Options;
	var chat = document.getElementById('kocmain_bottom').childNodes[1];
	 if (chat) {
	 var channel_input = nHtml.FindByXPath(chat,".//div[contains(@class,'mod_comm_forum')]");
	 logit(channel_input);
 	 var ab = document.createElement('a');
	 ab.className="mod_comm_set";
	 channel_input.appendChild(ab);
	 ab.innerHTML="Smileys";
		
	 ab.addEventListener ('click', function() {
	 t.EmoHelp();
	 }, false);
}
    t.cont = div; 
    var main = '<TABLE class=ptTab align=center><TR><TD><INPUT class=pbSubtab ID=ptmrchSubU type=submit value="options"></td>';    
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubV type=submit value="Colores"></td></tr></table><HR class=ptThin>';
    main += '<TD width = "100px" ; border:none"><a href="http://code.google.com/p/koc-power-tools/wiki/HowToOptions" target="_blank">Help</a></td></tr>';
    main +='<DIV id=ptOptOutput style="margin-top:10px; margin-left:150px; background-color:white; maxheight:500px; height:500px; width:800px; overflow-y:auto;"></div>';
	
    t.cont.innerHTML = main;
    t.Overv = document.getElementById('ptOptOutput');
    
    document.getElementById('ptmrchSubU').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubV').addEventListener('click', e_butSubtab, false);

    
    changeSubtab (document.getElementById('ptmrchSub'+Options.curOptTab));
    
    function e_butSubtab (evt){            
      changeSubtab (evt.target);   
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pbSubtab'; 
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pbSubtab pbSubtabSel'; 
      but.disabled=true;
      t.curTabName = but.id.substr(9);
	  Options.curOptTab = t.curTabName;
      t.show ();
    }
    },


    Options : function (){ 
    var t = Tabs.Options; 

    try {  
       m = '<TABLE class=ptTab>';
        m+='<TR><TD colspan=2><U><B>Configuring PowerKoc:</b></u></td></tr>';
        m+='<TR><TD><INPUT id=ptAllowWinMove type=checkbox /></td><TD>Enable dragging of the window (move the window by dragging the top bar with the mouse).</td></tr>';
        m+='<TR><TD><INPUT id=pbTrackWinOpen type=checkbox /></td><TD>Remember window position after refresh.</td></tr>';
        m+='<TR><TD><INPUT id=ptHideOnGoto type=checkbox /></td><TD>Hide window by clicking on the map coordinates</td></tr>';
        m+='<TR><TD><INPUT id=pbWideOpt type=checkbox '+ (GlobalOptions.pbWideScreen?'CHECKED ':'') +'/></td><TD>Enable display style: '+ htmlSelector({normal:'Normal', wide:'wide', ultra:'Ultra'},GlobalOptions.pbWideScreenStyle,'id=selectScreenMode') +' (requires cooling in all domains.)</td></tr>';
	m+='<TR><TD><INPUT id=ptEnableFoodWarn type=checkbox /></td><TD>Remaining food show in red if it will end in less than';
        m+='<INPUT id=optFoodHours type=text size=3 value="'+ Options.foodWarnHours +'"> hours, this does not affect the food alert!!!</td></tr>';
        m+='<TR><TD><INPUT id=ptEnableFoodTower type=checkbox /></td><TD>Turn on food alert in the chat (Established in 6 hours, checking every half hour)</td></tr>';
        m+='<TR><TD><INPUT id=ptEnableWisperAlert type=checkbox /></td><TD>turn sound on whisper</td></tr>';
        m+='<TR><TD><INPUT id=ptEnableTowerAlert type=checkbox /></td><TD>Enable sound alerts the tower in chat</td></tr></table>';

        m+='<TABLE class=ptTab><TR><TD colspan=2><U><B>general Options:</b></u></td></tr>';
        m+='<TR><TD><INPUT id=pbFairie type=checkbox /></td><TD>Disable all pop-KOC</td></tr>';
        m+='<TR><TD><INPUT id=pbWatchEnable type=checkbox '+ (GlobalOptions.pbWatchdog?'CHECKED ':'') +'/></td><TD>KOC Refresh if no charges in 1 minute</td></tr>';
        m+='<TR><TD><INPUT id=pbEveryEnable type=checkbox /></td><TD>Refresh every KOC<INPUT id=pbeverymins type=text size=2 maxlength=3 \> minutes</td></tr>';
        m+='<TR><TD><INPUT id=pbChatREnable type=checkbox /></td><TD>Put chat right (requires Widescreen)</td></tr>';
        m+='<TR><TD><INPUT id=pbGoldEnable type=checkbox /></td><TD>Auto pick up gold when happiness comes to <INPUT id=pbgoldLimit type=text size=2 maxlength=3 \>%</td></tr>';
	m+='<TR><TD><INPUT id=pbWMapEnable type=checkbox /></td><TD>Use map width (requires Widescreen)</td></tr>';
        m+='<TR><TD><INPUT id=togSmiley type=checkbox /></td><TD>Smileys <INPUT id=EmoHelp type=submit value="HELP"></td></tr></table>';

        m+='<TABLE class=ptTab><TR><TD colspan=2><U><B>features:</b></u></td></tr>';
	m+='<TR><TD><INPUT id=ptEnableReportNumber type=checkbox /></td><TD>Number of report</td></tr>';
	m+='<TR><TD><INPUT id=ptAtkAlliance type=checkbox /></td><TD>Alliance attacker</td></tr>';
	m+='<TR><TD><INPUT id=ptTgtAlliance type=checkbox /></td><TD>Alliance attacked</td></tr>';
	m+='<TR><TD></TD><TD>city ??attacker: <SELECT id=ptAtkCityName>';
	m+='<OPTION value="no" '+ (Options.atkCityName=='no'?'SELECTED':'') +'>No</option><OPTION value="same" '+ (Options.atkCityName=='same'?'SELECTED':'') +'>on the same line</option>';
	m+='<OPTION value="new" '+ (Options.atkCityName=='new'?'SELECTED':'') +'>in another line</option></select>&nbsp;&nbsp;&nbsp;city ??attacked: <SELECT id=ptTgtCityName>';
	m+='<OPTION value="no" '+ (Options.tgtCityName=='no'?'SELECTED':'') +'>No</option><OPTION value="same" '+ (Options.tgtCityName=='same'?'SELECTED':'') +'>on the same line</option>';
	m+='<OPTION value="new" '+ (Options.tgtCityName=='new'?'SELECTED':'') +'>in another line</option></select></td></tr>';
	m+='<TR><TD><INPUT id=togAllowAlter type=checkbox /></td><TD>Allow other scripts change to change the format of the reports of the alliance.</td></tr>';
        m+='<TR><TD><INPUT id=togGmtClock type=checkbox /></td><TD>Enable GMT relog next to the camelot </td></tr>';
        m+='<TR><TD><INPUT id=togCoordBox type=checkbox /></td><TD>Favorite maintain map box above the activity of the troops</td></tr>';
        m+='<TR><TD><INPUT id=HelReq type=checkbox /></td><TD>Automatically help in the literature (Const. / Invest.) Of our fellow.</td></tr>';
        m+='<TR><TD><INPUT id=DelReq type=checkbox /></td><TD>Hide publications (Const. / Invest) in the chat</td></tr>';
        m+='<TR><TD><INPUT id=PubReq type=checkbox '+ (GlobalOptions.autoPublishGamePopups?'CHECKED ':'') +'/></td><TD>Auto post to facebook posts '+ htmlSelector({0:'----', 80:'Everyone', 50:'Friends of Friends', 40:'Friends Only', 10:'Only Me'},GlobalOptions.autoPublishPrivacySetting,'id=selectprivacymode') +' (I recommend "just Friends")</td>';
	m+='<TR><TD><INPUT id=pbsendmeaway type=checkbox '+ (GlobalOptions.pbNoMoreKabam?'CHECKED ':'')+'/></td><TD>Im out!!!<sup><span class="boldRed">(Only Kabam!)</span></sup></td></tr>';
        m+='<TR><TD><INPUT id=MapExtra type=checkbox /></td><TD>Show power and players on the map.</td></tr></table>';

        m+='<TABLE class=ptTab><TR><TD colspan=2><U><B>Automatic Clearing reports:</b></u></td></tr>';
        m+='<TR><TD><INPUT id=deletetoggle type=checkbox /></td><TD>Barb / Transport</td></tr>';
        m+='<TR><TD><INPUT id=deletes0toggle type=checkbox /></td><TD>Transportation (To you)</td></tr>';
        m+='<TR><TD><INPUT id=deletes1toggle type=checkbox /></td><TD>land</td></tr>';
        m+='<TR><TD><INPUT id=deletes2toggle type=checkbox /></td><TD>forests dark</td></tr>';
        m+='<TR><TD><INPUT id=deletes3toggle type=checkbox /></td><TD>reinforcement</td></tr>';
        m+='<TR><TD><INPUT id=delete4toggle type=checkbox /></td><TD>exploration(the enemy)</td></tr>';
        m+='<TR><TD><INPUT id=deletes5toggle type=checkbox /></td><TD>attacks</td></tr>';
        m+='<TR><TD><INPUT id=deletes6toggle type=checkbox /></td><TD>Blasoneo city</td></tr>';
	m+='<TR><TD></td><td>Intervalo: <input type=text size=1 id=Ksdeletetimer value="' + Options.DeleteTimerMinute + '"> Minutes (Minimum 2, but may delete before you go slower).</td></tr></table>';
        m+='<TR><TD><INPUT id="optResetOverviewOptions" type=submit value="Reset Options General tab"\></td></tr>';
        m+='<TR><TD><BR><BR><HR>Note that if a box is gray, it is because Provably has been a change of code in KOC, which makes that option not available.</td></tr>';
        m+= strButton20('Reset "ALL" Options', 'id=ResetALL');
      t.Overv.innerHTML = m;

                            document.getElementById('optResetOverviewOptions').addEventListener ('click', function () {
				Options.showBuildings = false;
				Options.showDefenses = false;
				Options.includeMarching = false;
				Options.showPopulation = false;
				Options.resourceProd = false;
				Options.showTroops = false;
				Options.wrapCityName = false;
				Options.includeCityHome = false;
				Options.includeCityMarch = false;
				Options.includeCityRaid = false;
				Options.includeCityTrain = false;
			}, false);
			document.getElementById('ptAtkCityName').addEventListener ('change', function () {
				Options.atkCityName = document.getElementById('ptAtkCityName').value;
				saveOptions();
			}, false);
			document.getElementById('ptTgtCityName').addEventListener ('change', function () {
				Options.tgtCityName = document.getElementById('ptTgtCityName').value;
				saveOptions();
			}, false);
      document.getElementById('optFoodHours').addEventListener ('change', function () {
          var x = document.getElementById('optFoodHours').value; 
          if (isNaN(x) || x<0.01 || x>99999){
            document.getElementById('optFoodHours').value = Options.foodWarnHours;
            return;
          }
          Options.foodWarnHours = x; 
          saveOptions();
        }, false);
      document.getElementById('selectScreenMode').addEventListener ('change', function(){
      		GlobalOptions.pbWideScreenStyle = document.getElementById('selectScreenMode').value;
      		GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));
      },false);	

      ById('Ksdeletetimer').addEventListener ('change', function () {
	  if (parseInt(ById('Ksdeletetimer').value) < 2) {
	    ById('Ksdeletetimer').value=2;
	  }
	  Options.DeleteTimerMinute = ById('Ksdeletetimer').value;
	  saveOptions();
	}, false);

      document.getElementById('selectprivacymode').addEventListener ('change', function(){
      		GlobalOptions.autoPublishPrivacySetting = document.getElementById('selectprivacymode').value;
			GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));
      },false);
	  document.getElementById('PubReq').addEventListener ('change', function(){
      		GlobalOptions.autoPublishGamePopups = document.getElementById('PubReq').checked;
			GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));
      },false);	
          document.getElementById('ResetALL').addEventListener ('click', function(){
	  		var serverID = getServerId();
	  		RemoveList = (GM_listValues());
	  		for (i=0;i<RemoveList.length;i++){
	  			logit(RemoveList[i]);
	  			GM_deleteValue(RemoveList[i]);
	  		}
	  		ResetAll=true;
	  		reloadKOC();
	  },false);	
//      	  document.getElementById('selecttil').addEventListener ('change', function(){
//		Options.ThroneDeleteLevel = this.value;
//		saveOptions();
//      },false);

     document.getElementById('pbsendmeaway').addEventListener ('click', function(){
       GlobalOptions.pbNoMoreKabam = document.getElementById('pbsendmeaway').checked;
       GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));
     },false);

      document.getElementById('pbWatchEnable').addEventListener ('change', t.e_watchChanged, false);
      document.getElementById('pbWideOpt').addEventListener ('change', t.e_wideChanged, false);	  
      document.getElementById('EmoHelp').addEventListener('click', function(){ t.EmoHelp(); }, false);
      t.togOpt ('togSmiley', 'Smiley');
      t.togOpt ('ptEnableFoodWarn', 'enableFoodWarn'); 
      t.togOpt ('ptEnableFoodTower', 'enableFoodTower');
      t.togOpt ('ptEnableWisperAlert', 'enableWhisperAlert');  
      t.togOpt ('ptEnableTowerAlert', 'enableTowerAlert'); 	
      t.togOpt ('ptHideOnGoto', 'hideOnGoto');
      t.togOpt ('ptAllowWinMove', 'pbWinDrag', mainPop.setEnableDrag);
      t.togOpt ('togAllowAlter', 'allowAlterAR');
      t.togOpt ('pbTrackWinOpen', 'pbTrackOpen');
      t.togOpt ('pbFairie', 'pbKillFairie', FairieKiller.setEnable);
      t.togOpt ('pbGoldEnable', 'pbGoldEnable', CollectGold.setEnable);
      t.changeOpt ('pbgoldLimit', 'pbGoldHappy');
      t.changeOpt ('pbeverymins', 'pbEveryMins' , RefreshEvery.setTimer);
      t.togOpt ('pbChatREnable', 'pbChatOnRight', WideScreen.setChatOnRight);
      t.togOpt ('pbWMapEnable', 'pbWideMap', WideScreen.useWideMap);
      t.togOpt ('pbEveryEnable', 'pbEveryEnable', RefreshEvery.setEnable);
      t.togOpt ('HelReq', 'HelpRequest');
      t.togOpt ('DelReq', 'DeleteRequest');
      t.togOpt ('MapExtra', 'MapShowExtra');
      t.togOpt ('deletetoggle', 'DeleteMsg');
      t.togOpt ('deletes0toggle', 'DeleteMsgs0');
      t.togOpt ('deletes1toggle', 'DeleteMsgs1'); 
      t.togOpt ('deletes2toggle', 'DeleteMsgs2');
      t.togOpt ('deletes3toggle', 'DeleteMsgs3');
      t.togOpt ('delete4toggle', 'DeleteMsgs4');
      t.togOpt ('deletes5toggle', 'DeleteMsgs5');
      t.togOpt ('deletes6toggle', 'DeleteMsgs6');
      t.togOpt ('togGmtClock', 'gmtClock', GMTclock.setEnable);
      t.togOpt ('togCoordBox', 'mapCoordsTop', CoordBox.setEnable, CoordBox.isAvailable);
      t.togOpt ('ptEnableReportNumber', 'enableReportNumber');
      t.togOpt ('ptAtkAlliance', 'atkAlliance');
      t.togOpt ('ptTgtAlliance', 'tgtAlliance');
      document.getElementById('optFoodHours').addEventListener ('change', function () {
          var x = document.getElementById('optFoodHours').value; 
          if (isNaN(x) || x<0.01 || x>99999){
            document.getElementById('optFoodHours').value = Options.foodWarnHours;
            return;
          }
          Options.foodWarnHours = x; 
          saveOptions();
        }, false);
    } catch (e) {
      t.Overv.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';  
    }      
  },

  Layout :function (){
    var t = Tabs.Options;  
    try {      
      m= '<TABLE class=ptTab>';
	  m+='<TR><TD colspan=2><U><B>Chat Layout:</b></u></td></tr>';
          m+='<TR><TD><INPUT id=togChatGlobal type=checkbox /></td><TD>Enable overall background color.</td></tr>';
          m+='<TR><TD><INPUT id=togChatAlliance type=checkbox /></td><TD>Toggle background color of the Alliance chat.</td></tr>';
          m+='<TR><TD><INPUT id=togChatWhisper type=checkbox /></td><TD>Toggle Background color whispers.</td></tr>';
	  m+='<TR><TD><INPUT id=togChatBold type=checkbox /></td><TD>Enable chat in bold.</td></tr>';
	  m+='<TR><TD><INPUT id=togChatAttack type=checkbox /></td><TD>Toggle background color alerts of attacks.</td></tr>';
	  m+='<TR><TD><INPUT id=togChatLead type=checkbox /></td><TD>Toggle background color for leadership.</td></tr></table>';

      m+='<TABLE class=ptTab><BR><TR><TD colspan=2><U><B>Colores:</b></u></td></tr>';
      m+='<TR><TD>Chat Color - Global: </td><TD><INPUT id=togGlobal type=text size=7 maxlength=7 value="'+Colors.ChatGlobal+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatGlobal+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Chat Color - Aliance: </td><TD><INPUT id=togAll type=text size=7 maxlength=7 value="'+Colors.ChatAll+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatAll+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Chat Color - alert tower: </td><TD><INPUT id=togChatAtt type=text size=7 maxlength=7 value="'+Colors.ChatAtt+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatAtt+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Chat Color - whisper: </td><TD><INPUT id=togWhisper type=text size=7 maxlength=7 value="'+Colors.ChatWhisper+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatWhisper+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Chat Color - chancellor: </td><TD><INPUT id=togChatC type=text size=7 maxlength=7 value="'+Colors.ChatChancy+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatChancy+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Chat Color - Vice-C: </td><TD><INPUT id=togChatVC type=text size=7 maxlength=7 value="'+Colors.ChatVC+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatVC+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Chat Color - Officer: </td><TD><INPUT id=togChatLeaders type=text size=7 maxlength=7 value="'+Colors.ChatLeaders+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatLeaders+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>General - titles: </td><TD><INPUT id=togChatMainTiltle type=text size=7 maxlength=7 value="'+Colors.MainTitle+'"></td>&nbsp;<TD style="background-color:'+Colors.MainTitle+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>General - Dark Row: </td><TD><INPUT id=togDarkRow type=text size=7 maxlength=7 value="'+Colors.DarkRow+'"></td>&nbsp;<TD style="background-color:'+Colors.DarkRow+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>General - selected button: </td><TD><INPUT id=togButClick type=text size=7 maxlength=7 value="'+Colors.ButtonSelected+'"></td>&nbsp;<TD style="background-color:'+Colors.ButtonSelected+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>General - Tab On: </td><TD><INPUT id=togTabClick type=text size=7 maxlength=7 value="'+Colors.TabClicked+'"></td>&nbsp;<TD style="background-color:'+Colors.TabClicked+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>General - background tabs: </td><TD><INPUT id=togTab type=text size=7 maxlength=7 value="'+Colors.Tabs+'"></td>&nbsp;<TD style="background-color:'+Colors.Tabs+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>General - Send tabs: </td><TD><INPUT id=togTabFont type=text size=7 maxlength=7 value="'+Colors.TabFont+'"></td>&nbsp;<TD style="background-color:'+Colors.TabFont+'" width=30px>&nbsp;</td></tr>';
      m+='<TR><TD>Overview rows:</td><TD><INPUT id=togOverDarkRow type=text size=7 maxlength=7 value="'+Colors.OverviewDarkRow+'"></td>&nbsp;<TD style="background-color:'+Colors.OverviewDarkRow+'" width=30px>&nbsp;</td></tr>';
      m+='</table><BR><BR><DIV>HTML colors:&nbsp;&nbsp;&nbsp;';
      m+='<a href="http://www.colorpicker.com/" target="_blank">Color Picker</a>&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;';
      m+='<a href="http://www.w3schools.com/html/html_colors.asp" target="_blank">Colors</a>';
      m+='</table><BR><BR><HR>To apply the colors need a refresher!<BR>';
      m+= strButton20('reset Colors', 'id=ResetALL');
      t.Overv.innerHTML = m;
      t.togOpt ('togChatGlobal', 'chatglobal');
      t.togOpt ('togChatAlliance', 'chatalliance');
      t.togOpt ('togChatWhisper', 'chatwhisper');	
      t.togOpt ('togChatBold', 'chatbold');
      t.togOpt ('togChatAttack', 'chatAttack');
      t.togOpt ('togChatLead', 'chatLeaders');
      
      document.getElementById('togGlobal').addEventListener('change', function(){Colors.ChatGlobal = document.getElementById('togGlobal').value;t.Layout()}, false);
      document.getElementById('togChatLeaders').addEventListener('change', function(){Colors.ChatLeaders = document.getElementById('togChatLeaders').value;t.Layout()}, false);
      document.getElementById('togChatC').addEventListener('change', function(){Colors.ChatChancy = document.getElementById('togChatC').value;t.Layout()}, false);
      document.getElementById('togChatVC').addEventListener('change', function(){Colors.ChatVC = document.getElementById('togChatVC').value;t.Layout()}, false);
      document.getElementById('togChatMainTiltle').addEventListener('change', function(){Colors.MainTitle = document.getElementById('togChatMainTiltle').value;t.Layout()}, false);
      document.getElementById('togDarkRow').addEventListener('change', function(){Colors.DarkRow = document.getElementById('togDarkRow').value;t.Layout()}, false);
      document.getElementById('togButClick').addEventListener('change', function(){Colors.ButtonSelected = document.getElementById('togButClick').value;t.Layout()}, false);
      document.getElementById('togTabClick').addEventListener('change', function(){Colors.TabClicked = document.getElementById('togTabClick').value;t.Layout()}, false);
      document.getElementById('togTab').addEventListener('change', function(){Colors.Tabs = document.getElementById('togTab').value;t.Layout()}, false);
      document.getElementById('togOverDarkRow').addEventListener('change', function(){Colors.OverviewDarkRow = document.getElementById('togOverDarkRow').value;t.Layout()}, false);
      document.getElementById('togTabFont').addEventListener('change', function(){Colors.TabFont = document.getElementById('togTabFont').value;t.Layout()}, false);
      document.getElementById('togAll').addEventListener('change', function(){Colors.ChatAll = document.getElementById('togAll').value;t.Layout()}, false);
      document.getElementById('togChatAtt').addEventListener('change', function(){Colors.ChatAtt = document.getElementById('togChatAtt').value;t.Layout()}, false);
      document.getElementById('togWhisper').addEventListener('change', function(){Colors.ChatWhisper = document.getElementById('togWhisper').value;t.Layout()}, false);
      document.getElementById('ResetALL').addEventListener ('click', function(){
      		RemoveList = (GM_listValues());
      		for (i=0;i<RemoveList.length;i++){
      			if (RemoveList[i] == "Colors") GM_deleteValue(RemoveList[i]);
      		}
      		ResetColors=true;
      		reloadKOC();
      },false);	
       saveColors();
    } catch (e) {
      t.cont.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';  
    }
  },

  hide : function (){
  },

  show : function (){
        var t = Tabs.Options;
    if (t.curTabName == 'U') 
         t.Options();
    else if (t.curTabName == 'V')
      t.Layout();
  },

    togOpt : function (checkboxId, optionName, callOnChange){
      var t = Tabs.Options;
      var checkbox = ById(checkboxId);
      if (Options[optionName])
        checkbox.checked = true;
      checkbox.addEventListener ('change', eventHandler, false);
      function eventHandler (){
        Options[optionName] = this.checked;
        saveOptions();
        if (callOnChange)
          callOnChange (this.checked);
        
        if (optionName=="DeleteMsgs5" || optionName=="DeleteMsgs6" || "DeleteMsgs4" || optionName=="DeleteMsg" || optionName=="DeleteMsgs0" || optionName=="DeleteMsgs1" || optionName=="DeleteMsgs2" || optionName=="DeleteMsgs3") {
           DeleteReports.init();
        }
      }
    },
  
  changeOpt : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Options[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.value;
      saveOptions();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
  
  e_watchChanged : function (){
    GlobalOptions.pbWatchdog = document.getElementById('pbWatchEnable').checked;
    GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));  
  },
  
  e_wideChanged : function (){
    GlobalOptions.pbWideScreen = document.getElementById('pbWideOpt').checked;
    GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));  
  },

    EmoClick: function(what) {
  document.getElementById ("mod_comm_input").value += " " + what + " ";
  }, 

  EmoHelp : function (){
	var t = Tabs.Options;
	unsafeWindow.pdxEmoClick = t.EmoClick;
	var helpText = '<DIV style="max-height:295px; overflow-y:auto">';
	helpText += '<TABLE width=95% cellspacing=0 cellpadding=4 border=1 bordercolor=black>';
	helpText += '<TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00100-smile.gif\" onclick="pdxEmoClick(\':-)\')"></td><TD>:) :-) :=) ^^</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00101-sadsmile.gif\" onclick="pdxEmoClick(\':-(\')"></td><TD>:-( :=(</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\" onclick="pdxEmoClick(\':-D\')"></td><TD>:D :-D :=D</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00106-crying.gif\" onclick="pdxEmoClick(\';-(\')"></td><TD>;-( ;=(</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00109-kiss.gif\" onclick="pdxEmoClick(\':-*\')"></td><TD>:-* :=*</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00112-wondering.gif\" onclick="pdxEmoClick(\':^)\')"></td><TD>:^)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00105-wink.gif\" onclick="pdxEmoClick(\';-)\')"></td><TD>;-) ;=)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\" onclick="pdxEmoClick(\'I-)\')"></td><TD>I-) I=)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\" onclick="pdxEmoClick(\'8-)\')"></td><TD>8-) 8=) B-) B=)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\" onclick="pdxEmoClick(\'x=(\')"></td><TD>x=( x-( :-@ :=@</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00119-puke.gif\" onclick="pdxEmoClick(\':-& \')"></td><TD>:-& :=&</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00107-sweating.gif\" onclick="pdxEmoClick(\'(:I\')"></td><TD>(:I</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\" onclick="pdxEmoClick(\':=P\')"></td><TD>:P :=P :-P :=p</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\" onclick="pdxEmoClick(\':-$\')"></td><TD>:-$ :=$ :"></td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00123-party.gif\" onclick="pdxEmoClick(\'(party)\')"></td><TD>(party)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\" onclick="pdxEmoClick(\'(ci)\')"></td><TD>(smoke) (smoking) (ci) (rauchen)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00181-fubar.gif\" onclick="pdxEmoClick(\'(fubar)\')"></td><TD>(fubar)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00115-inlove.gif\" onclick="pdxEmoClick(\'(inlove)\')"></td><TD>(inlove)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00152-heart.gif\" onclick="pdxEmoClick(\'(heart)\')"></td><TD>(heart)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00128-hi.gif\" onclick="pdxEmoClick(\'(hi)\')"></td><TD>(hi)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\" onclick="pdxEmoClick(\'(clap)\')"></td><TD>(clap) (bravo) (klatschen)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00140-rofl.gif\" onclick="pdxEmoClick(\'(rofl)\')"></td><TD>(rofl)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00168-drink.gif\" onclick="pdxEmoClick(\'(drink)\')"></td><TD>(drink)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\" onclick="pdxEmoClick(\'(cafe)\')"></td><TD>(cafe) (kaffee) (coffee)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00154-mail.gif\" onclick="pdxEmoClick(\'(m)\')"></td><TD>(m) (e)</td></tr><TR><TD><img class=emoicon src=\"http://factoryjoe.s3.amazonaws.com/emoticons/emoticon-0180-bug.gif\" onclick="pdxEmoClick(\'(bug)\')"></td><TD>(bug)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00134-bear.gif\" onclick="pdxEmoClick(\'(bear)\')"></td><TD>(bear)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00118-yawn.gif\" onclick="pdxEmoClick(\'I()\')"></td><TD>I()</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/like.gif\" onclick="pdxEmoClick(\'(like)\')"></td><TD>(like)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00116-evilgrin.gif\" onclick="pdxEmoClick(\'>:)\')"></td><TD>]: >:) </td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/poolparty.gif\" onclick="pdxEmoClick(\'(pool)\')"></td><TD>(pool)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_bandit.gif\" onclick="pdxEmoClick(\'(bandit)\')"></td><TD>(bandit)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_drunk.gif\" onclick="pdxEmoClick(\'(drunk)\')"></td><TD>(drunk)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_finger.gif\" onclick="pdxEmoClick(\'(finger)\')"></td><TD>(finger)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_mooning.gif\" onclick="pdxEmoClick(\'(mooning)\')"></td><TD>(mooning)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_rock.gif\" onclick="pdxEmoClick(\'(rock)\')"></td><TD>(rock)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/swear.gif\" onclick="pdxEmoClick(\'(swear)\')"></td><TD>(swear)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/tmi.gif\" onclick="pdxEmoClick(\'(tmi)\')"></td><TD>(tmi)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_toivo.gif\" onclick="pdxEmoClick(\'(toivo)\')"></td><TD>(toivo)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype-wackyb-0139-1-bow.gif\" onclick="pdxEmoClick(\'(bow)\')"></td><TD>(bow)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00170-ninja.gif\" onclick="pdxEmoClick(\'(ninja)\')"></td><TD>(ninja)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00167-beer.gif\" onclick="pdxEmoClick(\'(beer)\')"></td><TD>(beer)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00165-muscle.gif\" onclick="pdxEmoClick(\'(muscle)\')"></td><TD>(muscle)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00163-pizza.gif\" onclick="pdxEmoClick(\'(pizza)\')"></td><TD>(pizza)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00159-music.gif\" onclick="pdxEmoClick(\'(music)\')"></td><TD>(music)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00146-punch.gif\" onclick="pdxEmoClick(\'(punch)\')"></td><TD>(punch)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00148-yes.gif\" onclick="pdxEmoClick(\'(yes)\')"></td><TD>(yes)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00150-handshake.gif\" onclick="pdxEmoClick(\'(handshake)\')"></td><TD>(handshake)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00149-no.gif\" onclick="pdxEmoClick(\'(no)\')"></td><TD>(no)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00155-flower.gif\" onclick="pdxEmoClick(\'(flower)\')"></td><TD>(flower)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00161-phone.gif\" onclick="pdxEmoClick(\'(phone)\')"></td><TD>(phone)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_headbang.gif\" onclick="pdxEmoClick(\'(headbang)\')"></td><TD>(headbang)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_kissing.gif\" onclick="pdxEmoClick(\'(beso)\')"></td><TD>(beso)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_angel.gif\" onclick="pdxEmoClick(\'(angel)\')"></td><TD>(angel)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_beer.gif\" onclick="pdxEmoClick(\'(beer2)\')"></td><TD>(beer2)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_blushing.gif\" onclick="pdxEmoClick(\'(blushing)\')"></td><TD>(blushing)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_bomb.gif\" onclick="pdxEmoClick(\'(bomb)\')"></td><TD>(bomb)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_cool.gif\" onclick="pdxEmoClick(\'(cool)\')"></td><TD>(cool)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_crying.gif\" onclick="pdxEmoClick(\'(crying)\')"></td><TD>(crying)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_devil.gif\" onclick="pdxEmoClick(\'(devil)\')"></td><TD>(devil)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_gross.gif\" onclick="pdxEmoClick(\'(gross)\')"></td><TD>(gross)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_kiss.gif\" onclick="pdxEmoClick(\'(kiss)\')"></td><TD>(kiss)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_kissed.gif\" onclick="pdxEmoClick(\'(kissed)\')"></td><TD>(kissed)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_laughing.gif\" onclick="pdxEmoClick(\'(laughing)\')"></td><TD>(laughing)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_lol.gif\" onclick="pdxEmoClick(\'(lol)\')"></td><TD>(lol)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_love.gif\" onclick="pdxEmoClick(\'(love)\')"></td><TD>(love)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_mad.gif\" onclick="pdxEmoClick(\'(mad)\')"></td><TD>(mad)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_music.gif\" onclick="pdxEmoClick(\'(cascos)\')"></td><TD>(cascos)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_nothingtosay.gif\" onclick="pdxEmoClick(\'(nothingtosay)\')"></td><TD>(nothingtosay)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_sad.gif\" onclick="pdxEmoClick(\'(sad)\')"></td><TD>(sad)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_scream.gif\" onclick="pdxEmoClick(\'(scream)\')"></td><TD>(scream)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_shutup.gif\" onclick="pdxEmoClick(\'(shutup)\')"></td><TD>(shutup)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_smile.gif\" onclick="pdxEmoClick(\'(smile)\')"></td><TD>(smile)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_stop.gif\" onclick="pdxEmoClick(\'(stop)\')"></td><TD>(stop)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_surprised.gif\" onclick="pdxEmoClick(\'(surprised)\')"></td><TD>(surprised)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_thankyou.gif\" onclick="pdxEmoClick(\'(thankyou)\')"></td><TD>(thankyou)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_thumbsup.gif\" onclick="pdxEmoClick(\'(thumbsup)\')"></td><TD>(thumbsup)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_tired.gif\" onclick="pdxEmoClick(\'(tired)\')"></td><TD>(tired)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_tongueout.gif\" onclick="pdxEmoClick(\'(tongueout)\')"></td><TD>(tongueout)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/icq_winkblink.gif\" onclick="pdxEmoClick(\'(winkblink)\')"></td><TD>(winkblink)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00114-dull.gif\" onclick="pdxEmoClick(\'(dull)\')"></td><TD>(dull)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00117-talking.gif\" onclick="pdxEmoClick(\'(talking)\')"></td><TD>(talking)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00120-doh.gif\" onclick="pdxEmoClick(\'(doh)\')"></td><TD>(doh)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00122-itwasntme.gif\" onclick="pdxEmoClick(\'(itwasntme)\')"></td><TD>(itwasntme)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00124-worried.gif\" onclick="pdxEmoClick(\'(worried)\')"></td><TD>(worried)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00125-mmm.gif\" onclick="pdxEmoClick(\'(mmm)\')"></td><TD>(mmm)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00126-nerd.gif\" onclick="pdxEmoClick(\'(nerd)\')"></td><TD>(nerd)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00127-lipssealed.gif\" onclick="pdxEmoClick(\'(lipssealed)\')"></td><TD>(lipssealed)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00129-call.gif\" onclick="pdxEmoClick(\'(call)\')"></td><TD>(call)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00130-devil.gif\" onclick="pdxEmoClick(\'(devil)\')"></td><TD>(devil)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00131-angel.gif\" onclick="pdxEmoClick(\'(angel)\')"></td><TD>(angel)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00132-envy.gif\" onclick="pdxEmoClick(\'(envy)\')"></td><TD>(envy)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00133-wait.gif\" onclick="pdxEmoClick(\'(wait)\')"></td><TD>(wait)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00135-makeup.gif\" onclick="pdxEmoClick(\'(makeup)\')"></td><TD>(makeup)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00136-giggle.gif\" onclick="pdxEmoClick(\'(giggle)\')"></td><TD>(giggle)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00138-thinking.gif\" onclick="pdxEmoClick(\'(thinking)\')"></td><TD>(thinking)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00141-whew.gif\" onclick="pdxEmoClick(\'(whew)\')"></td><TD>(whew)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00142-happy.gif\" onclick="pdxEmoClick(\'(happy)\')"></td><TD>(happy)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00143-smirk.gif\" onclick="pdxEmoClick(\'(smirk)\')"></td><TD>(smirk)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00144-nod.gif\" onclick="pdxEmoClick(\'(nod)\')"></td><TD>(nod)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00145-shake.gif\" onclick="pdxEmoClick(\'(shake)\')"></td><TD>(shake)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00147-emo.gif\" onclick="pdxEmoClick(\'(emo)\')"></td><TD>(emo)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00153-brokenheart.gif\" onclick="pdxEmoClick(\'(brokenheart)\')"></td><TD>(brokenheart)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00156-rain.gif\" onclick="pdxEmoClick(\'(rain)\')"></td><TD>(rain)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00157-sun.gif\" onclick="pdxEmoClick(\'(sun)\')"></td><TD>(sun)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00158-time.gif\" onclick="pdxEmoClick(\'(time)\')"></td><TD>(time)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00160-movie.gif\" onclick="pdxEmoClick(\'(movie)\')"></td><TD>(movie)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00164-cash.gif\" onclick="pdxEmoClick(\'(cash)\')"></td><TD>(cash)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00166-cake.gif\" onclick="pdxEmoClick(\'(cake)\')"></td><TD>(cake)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00169-dance.gif\" onclick="pdxEmoClick(\'(dance)\')"></td><TD>(dance)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00170-ninja.gif\" onclick="pdxEmoClick(\'(ninja)\')"></td><TD>(ninja)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00171-star.gif\" onclick="pdxEmoClick(\'(star)\')"></td><TD>(star)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00185-heidy.gif\" onclick="pdxEmoClick(\'(heidy)\')"></td><TD>(heidy)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/abrazo.gif\" onclick="pdxEmoClick(\'(abrazo)\')"></td><TD>(abrazo)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/afeitado.gif\" onclick="pdxEmoClick(\'(afeitado)\')"></td><TD>(afeitado)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/amoroso.gif\" onclick="pdxEmoClick(\'(amoroso)\')"></td><TD>(amoroso)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/aplauso.gif\" onclick="pdxEmoClick(\'(aplauso)\')"></td><TD>(aplauso)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/bebe.gif\" onclick="pdxEmoClick(\'(bebe)\')"></td><TD>(bebe)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/besazo.gif\" onclick="pdxEmoClick(\'(besazo)\')"></td><TD>(besazo)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cabezazo.gif\" onclick="pdxEmoClick(\'(cabezazo)\')"></td><TD>(cabezazo)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/callate.gif\" onclick="pdxEmoClick(\'(callate)\')"></td><TD>(callate)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cama.gif\" onclick="pdxEmoClick(\'(cama)\')"></td><TD>(cama)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/camina.gif\" onclick="pdxEmoClick(\'(camina)\')"></td><TD>(camina)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cansado.jpg\" onclick="pdxEmoClick(\'(cansado)\')"></td><TD>(cansado)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/cari.gif\" onclick="pdxEmoClick(\'(cari)\')"></td><TD>(cari)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/chulo.gif\" onclick="pdxEmoClick(\'(chulo)\')"></td><TD>(chulo)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/corazonrisa.gif\" onclick="pdxEmoClick(\'(corazonrisa)\')"></td><TD>(corazonrisa)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/enamorado.gif\" onclick="pdxEmoClick(\'(enamorado)\')"></td><TD>(enamorado)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/enamorado2.gif\" onclick="pdxEmoClick(\'(enamorado2)\')"></td><TD>(enamorado2)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/enamorados.gif\" onclick="pdxEmoClick(\'(enamorados)\')"></td><TD>(enamorados)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/estampa.gif\" onclick="pdxEmoClick(\'(estampa)\')"></td><TD>(estampa)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/fumador.gif\" onclick="pdxEmoClick(\'(fumador)\')"></td><TD>(fumador)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/gato.gif\" onclick="pdxEmoClick(\'(gato)\')"></td><TD>(gato)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/gesto.gif\" onclick="pdxEmoClick(\'(gesto)\')"></td><TD>(gesto)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/gira.gif\" onclick="pdxEmoClick(\'(gira)\')"></td><TD>(gira)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/guinha.gif\" onclick="pdxEmoClick(\'(guinha)\')"></td><TD>(guinha)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lanzabeso.gif\" onclick="pdxEmoClick(\'(lanzabeso)\')"></td><TD>(lanzabeso)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lengua.gif\" onclick="pdxEmoClick(\'(lengua)\')"></td><TD>(lengua)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lengua2.gif\" onclick="pdxEmoClick(\'(lengua2)\')"></td><TD>(lengua2)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/lenguaguino.jpg\" onclick="pdxEmoClick(\'(lenguaguino)\')"></td><TD>(lenguaguino)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/llora.gif\" onclick="pdxEmoClick(\'(llora)\')"></td><TD>(llora)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/llora2.gif\" onclick="pdxEmoClick(\'(llora2)\')"></td><TD>(llora2)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/madrid.jpg\" onclick="pdxEmoClick(\'(madrid)\')"></td><TD>(madrid)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/maria.gif\" onclick="pdxEmoClick(\'(maria)\')"></td><TD>(maria)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nenahola.gif\" onclick="pdxEmoClick(\'(nenahola)\')"></td><TD>(nenahola)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nenallora.gif\" onclick="pdxEmoClick(\'(nenallora)\')"></td><TD>(nenallora)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nocabreo.gif\" onclick="pdxEmoClick(\'(nocabreo)\')"></td><TD>(nocabreo)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/nono.gif\" onclick="pdxEmoClick(\'(nono)\')"></td><TD>(nono)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/parte2.gif\" onclick="pdxEmoClick(\'(parte2)\')"></td><TD>(parte2)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/pistolas.gif\" onclick="pdxEmoClick(\'(pistolas)\')"></td><TD>(pistolas)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/pregunta.gif\" onclick="pdxEmoClick(\'(pregunta)\')"></td><TD>(pregunta)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/puerta.gif\" onclick="pdxEmoClick(\'(puerta)\')"></td><TD>(puerta)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/quteden.gif\" onclick="pdxEmoClick(\'(quteden)\')"></td><TD>(quteden)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/raro.gif\" onclick="pdxEmoClick(\'(raro)\')"></td><TD>(raro)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/recibebeso.gif\" onclick="pdxEmoClick(\'(recibebeso)\')"></td><TD>(recibebeso)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/relame.gif\" onclick="pdxEmoClick(\'(relame)\')"></td><TD>(relame)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/reverencia.gif\" onclick="pdxEmoClick(\'(reverencia)\')"></td><TD>(reverencia)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/rosas.gif\" onclick="pdxEmoClick(\'(rosas)\')"></td><TD>(rosas)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/saludo.gif\" onclick="pdxEmoClick(\'(saludo)\')"></td><TD>(saludo)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/separte.gif\" onclick="pdxEmoClick(\'(separte)\')"></td><TD>(separte)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/sisi.gif\" onclick="pdxEmoClick(\'(sisi)\')"></td><TD>(sisi)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/siva.gif\" onclick="pdxEmoClick(\'(siva)\')"></td><TD>(siva)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/sorprendido.gif\" onclick="pdxEmoClick(\'(sorprendido)\')"></td><TD>(sorprendido)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/sorpresa.gif\" onclick="pdxEmoClick(\'(sorpresa)\')"></td><TD>(sorpresa)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/tequiero.gif\" onclick="pdxEmoClick(\'(tequiero)\')"></td><TD>(tequiero)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/timido.gif\" onclick="pdxEmoClick(\'(timido)\')"></td><TD>(timido)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/triste.gif\" onclick="pdxEmoClick(\'(triste)\')"></td><TD>(triste)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/tuu.gif\" onclick="pdxEmoClick(\'(tuu)\')"></td><TD>(tuu)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/XD.gif\" onclick="pdxEmoClick(\'(XD)\')"></td><TD>(XD)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/zumbao.gif\" onclick="pdxEmoClick(\'(zumbao)\')"></td><TD>(zumbao)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/avatar-amor-378.gif\" onclick="pdxEmoClick(\'(besocorazon)\')"></td><TD>(besocorazon)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/abrazomortal.gif\" onclick="pdxEmoClick(\'(abrazomortal)\')"></td><TD>(abrazomortal)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/partidura.gif\" onclick="pdxEmoClick(\'(partidura)\')"></td><TD>(partidura)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/wc.gif\" onclick="pdxEmoClick(\'(wc)\')"></td><TD>(wc)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/comida.gif\" onclick="pdxEmoClick(\'(comida)\')"></td><TD>(comida)</td></tr><TR><TD><img class=emoicon src=\"http://thorastur.99h.com.ar/Emoticones/bull.gif\" onclick="pdxEmoClick(\'(bull)\')"></td><TD>(bull)</td></tr>';
	helpText += '</table></div>';

	var inputtext=document.getElementById('mod_comm_input');
	var pop = new CPopup ('EmoHelp', 280, 200, 350, 350, true);
	pop.getMainDiv().innerHTML = helpText;
	pop.getTopDiv().innerHTML = '<div class=showBadged><center>SMILEYS</center></div>';
	pop.show (true);
  },
};


/****************************  Reassign Implementation  *******************************/
var troops = {1:'SupplyTroops',
			  2:'Militiaman',
			  3:'Scout',
			  4:'Pikeman',
			  5:'Swordsman',
			  6:'Archer',
			  7:'Cavalry',
			  8:'HeavyCavalry',
			  9:'SupplyWagon',
			  10:'Ballista',
			  11:'BatteringRam',
			  12:'Catapult'};
Tabs.Reassign = {
  tabOrder: 20,
  tabLabel: 'Reasigner',
  myDiv: null,
  timer: null,
  reassignState: [],
  lRE: [],
  reassignRoutes: [],
  rallypointlevel:null,
  count:0,
  check:false,

    init: function(div){
		var t = Tabs.Reassign;
        t.myDiv = div;
		t.reassignState = {
            running: false,
        };
        t.readReassignState();
		t.readReassignRoutes();
		t.e_reassignRoutes();


      var m = '<DIV id=pbReMainDivF class=pbStat>FUNCTION AUTOMATICA OF REASSIGNMENT OF TROOPS</div><TABLE id=pbtraderfunctions width=100% height=0% class=pbTab><TR align="center">';
      if (t.reassignState.running == false) {
          m += '<TD><INPUT id=pbReassignState type=submit value="Reasigner = OFF"></td>';
                updatebotbutton('Reasignar-OFF', 'pbsigntab');
      } else {
          m += '<TD><INPUT id=pbReassignState type=submit value="Reasigner = ON"></td>';
                updatebotbutton('Reasignar-ON', 'pbsigntab');
      }
      m += '<TD><INPUT id=pbReassShowRoutes type=submit value="Show Routes"></td>';
      m += '<TD><INPUT id=pbReassHelp type=submit value="help"></td>';
	  m += '</tr></table></div>';
      m += '<DIV id=pbReassignDivD class=pbStat>ROUTE ADD REASSIGNING</div>';

      m += '<TABLE id=pbaddreasignroute width=95% height=0% class=pbTab><TR align="left">';
      m += '<TD width=20px>from City:</td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptassigncity></span></div></td></tr>';

      m += '<TR align="left">';
      m += '<TD width=20px>A City:</td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptassigncityTo></span></div></td>';

	    m += '<TR align="left">';
	    m += '<TD colspan=4>Time between reallocations: <INPUT id=pbreassigninterval type=text size=2 value="'+Options.reassigninterval+'"\> minutes</td></tr>';
      m += '<TR><TD><INPUT id=autofilloff type=checkbox unchecked=true\> FREEZE VALUES OF TROOPS</TR></TD></table>';

      m += '<DIV style="margin-top:10px;margin-bottom:5px;">Number of troops who want to keep a city:</div>';
      m += '<TABLE id=pbaddreasignroute width=100% height=0% class=pbTab><TR align="center">';

      m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_50.jpg?6545"></td>';
      m += '<TD>SupplyTroop.</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_50.jpg?6545"></td>'
      m += '<TD>Militiaman</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_3_50.jpg?6545"></td>'
      m += '<TD>Scout</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_50.jpg?6545"></td>'
      m += '<TD>Pikeman</td></tr>'
      m += '<TR><TD><INPUT id=pbSupplyTroops type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetSupplyTroops disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbMilitiaman type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetMilitiaman disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbScout type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetScout disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbPikeman type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetPikeman disabled=true type=text size=10 maxlength=10 value="0"\></td></tr>';

      m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_50.jpg?6545"></td>';
      m += '<TD>Swordsman</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_50.jpg?6545"></td>'
      m += '<TD>Archers</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_7_50.jpg?6545"></td>'
      m += '<TD>Cavalry</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_8_50.jpg?6545"></td>'
      m += '<TD>HeavyCavalry/td></tr>'
      m += '<TR><TD><INPUT id=pbSwordsman type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetSwordsman disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbArcher type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetArcher disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbCavalry type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetCavalry disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbHeavyCavalry type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetHeavyCavalry disabled=true type=text size=10 maxlength=10 value="0"\></td></tr>';

      m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_9_50.jpg?6545"></td>';
      m += '<TD>SupplyWagons</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_50.jpg?6545"></td>'
      m += '<TD>Ballista</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_50.jpg?6545"></td>'
      m += '<TD>BatteringRam</td>'
      m += '<TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_50.jpg?6545"></td>'
      m += '<TD>Catapult</td></tr>'
      m += '<TR><TD><INPUT id=pbSupplyWagon type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetSupplyWagon disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbBallista type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetBallista disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbBatteringRam type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetBatteringRam disabled=true type=text size=10 maxlength=10 value="0"\></td>';
      m += '<TD><INPUT id=pbCatapult type=checkbox unchecked=true\>';
      m += '<INPUT id=pbtargetCatapult disabled=true type=text size=10 maxlength=10 value="0"\></td></tr></table>';

      m += '<DIV style="text-align:center; margin-top:15px"><INPUT id=pbSaveRouteReassign type=submit value="Add Route"></div>';

      t.myDiv.innerHTML = m;

      t.tcp = new CdispCityPicker ('ptreassign', document.getElementById('ptassigncity'), true, null, 0);
	  t.tcpto = new CdispCityPicker ('ptreassignTo', document.getElementById('ptassigncityTo'), true);
	  for(var k in troops){
      document.getElementById('pbtarget'+troops[k]).value = parseInt(Seed.units['city' + t.tcp.city.id]['unt'+k]);
	  }

      document.getElementById('ptassigncity').addEventListener('click', function(){

if(document.getElementById('autofilloff').checked == false)
	    for(var k in troops){
        document.getElementById('pbtarget'+troops[k]).value = parseInt(Seed.units['city' + t.tcp.city.id]['unt'+k]);
	    }
      }, false);
      document.getElementById('pbReassHelp').addEventListener('click', function(){t.pbReassHelp();} , false);
      document.getElementById('pbReassignState').addEventListener('click', t.toggleReassignState, false);
      	
      document.getElementById('pbSaveRouteReassign').addEventListener('click', function(){
      t.addReassignRoute();
      }, false);
      document.getElementById('pbReassShowRoutes').addEventListener('click', function(){
      t.showReassignRoutes();
      }, false);

      document.getElementById('pbreassigninterval').addEventListener('keyup', function(){
		if (isNaN(document.getElementById('pbreassigninterval').value)){ document.getElementById('pbreassigninterval').value=0 ;}
		Options.reassigninterval = document.getElementById('pbreassigninterval').value;
		saveOptions();
      }, false);

      document.getElementById('pbtargetSupplyTroops').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetSupplyTroops').value)) document.getElementById('pbtargetSupplyTroops').value=0 ;
      }, false);
      document.getElementById('pbtargetMilitiaman').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetMilitiaman').value)) document.getElementById('pbtargetMilitiaman').value=0 ;
      }, false);
      document.getElementById('pbtargetScout').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetScout').value)) document.getElementById('pbtargetScout').value=0 ;
      }, false);
      document.getElementById('pbtargetPikeman').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetPikeman').value)) document.getElementById('pbtargetPikeman').value=0 ;
      }, false);
      document.getElementById('pbtargetSwordsman').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetSwordsman').value)) document.getElementById('pbtargetSwordsman').value=0 ;
      }, false);
      document.getElementById('pbtargetArcher').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetArcher').value)) document.getElementById('pbtargetArcher').value=0 ;
      }, false);
      document.getElementById('pbtargetCavalry').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetCavalry').value)) document.getElementById('pbtargetCavalry').value=0 ;
      }, false);
      document.getElementById('pbtargetHeavyCavalry').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetHeavyCavalry').value)) document.getElementById('pbtargetHeavyCavalry').value=0 ;
      }, false);
      document.getElementById('pbtargetSupplyWagon').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetSupplyWagon').value)) document.getElementById('pbtargetSupplyWagon').value=0 ;
      }, false);
      document.getElementById('pbtargetBallista').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetBallista').value)) document.getElementById('pbtargetBallista').value=0 ;
      }, false);
     document.getElementById('pbtargetBatteringRam').addEventListener('keyup', function(){
         if (isNaN(document.getElementById('pbtargetBatteringRam').value)) document.getElementById('pbtargetBatteringRam').value=0 ;
     }, false);
     document.getElementById('pbtargetCatapult').addEventListener('keyup', function(){
         if (isNaN(document.getElementById('pbtargetCatapult').value)) document.getElementById('pbtargetCatapult').value=0 ;
     }, false);


      document.getElementById('pbSupplyTroops').addEventListener('click', function(){
          if (document.getElementById('pbSupplyTroops').checked==false) {
              document.getElementById('pbtargetSupplyTroops').disabled = true;
          }
          else {
            document.getElementById('pbtargetSupplyTroops').disabled = false;
          }
      },false);
      document.getElementById('pbMilitiaman').addEventListener('click', function(){
          if (document.getElementById('pbMilitiaman').checked==false) {
              document.getElementById('pbtargetMilitiaman').disabled = true;
          }
          else {
            document.getElementById('pbtargetMilitiaman').disabled = false;
          }
      },false);
      document.getElementById('pbScout').addEventListener('click', function(){
          if (document.getElementById('pbScout').checked==false) {
              document.getElementById('pbtargetScout').disabled = true;
          }
          else {
            document.getElementById('pbtargetScout').disabled = false;
          }
      },false);
      document.getElementById('pbPikeman').addEventListener('click', function(){
          if (document.getElementById('pbPikeman').checked==false) {
              document.getElementById('pbtargetPikeman').disabled = true;
          }
          else {
            document.getElementById('pbtargetPikeman').disabled = false;
          }
      },false);
      document.getElementById('pbSwordsman').addEventListener('click', function(){
          if (document.getElementById('pbSwordsman').checked==false) {
              document.getElementById('pbtargetSwordsman').disabled = true;
          }
          else {
            document.getElementById('pbtargetSwordsman').disabled = false;
          }
      },false);
      document.getElementById('pbArcher').addEventListener('click', function(){
          if (document.getElementById('pbArcher').checked==false) {
              document.getElementById('pbtargetArcher').disabled = true;
          }
          else {
            document.getElementById('pbtargetArcher').disabled = false;
          }
      },false);
      document.getElementById('pbCavalry').addEventListener('click', function(){
          if (document.getElementById('pbCavalry').checked==false) {
              document.getElementById('pbtargetCavalry').disabled = true;
          }
          else {
            document.getElementById('pbtargetCavalry').disabled = false;
          }
      },false);
      document.getElementById('pbHeavyCavalry').addEventListener('click', function(){
          if (document.getElementById('pbHeavyCavalry').checked==false) {
              document.getElementById('pbtargetHeavyCavalry').disabled = true;
          }
          else {
            document.getElementById('pbtargetHeavyCavalry').disabled = false;
          }
      },false);
      document.getElementById('pbSupplyWagon').addEventListener('click', function(){
          if (document.getElementById('pbSupplyWagon').checked==false) {
              document.getElementById('pbtargetSupplyWagon').disabled = true;
          }
          else {
            document.getElementById('pbtargetSupplyWagon').disabled = false;
          }
      },false);
      document.getElementById('pbBallista').addEventListener('click', function(){
          if (document.getElementById('pbBallista').checked==false) {
              document.getElementById('pbtargetBallista').disabled = true;
          }
          else {
            document.getElementById('pbtargetBallista').disabled = false;
          }
      },false);
      document.getElementById('pbBatteringRam').addEventListener('click', function(){
          if (document.getElementById('pbBatteringRam').checked==false) {
              document.getElementById('pbtargetBatteringRam').disabled = true;
          }
          else {
            document.getElementById('pbtargetBatteringRam').disabled = false;
          }
      },false);
      document.getElementById('pbCatapult').addEventListener('click', function(){
          if (document.getElementById('pbCatapult').checked==false) {
              document.getElementById('pbtargetCatapult').disabled = true;
          }
          else {
            document.getElementById('pbtargetCatapult').disabled = false;
          }
      },false);


      window.addEventListener('unload', t.onUnload, false);
    },

    getRallypoint: function(cityId){
      var t = Tabs.Reassign;
      for (var o in Seed.buildings[cityId]){
		var buildingType = parseInt(Seed.buildings[cityId][o][0]);
		var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
		if (buildingType == 12) t.rallypointlevel=parseInt(buildingLevel);
    	  }
 },

 pbReassHelp : function (){
    var helpText = '<BR>Designed to redeploy troops between cities.<BR>';
    helpText += 'Marks the city from which troops depart.<BR>';
    helpText += 'then select the city where you want to reassign!<BR>';
    helpText += 'Check the boxes of the troops you want to reassign.<BR>';
    helpText += 'If you do not want to leave any unit of the troops, leaving the amount to zero<BR>';
    helpText += 'but if instead you want to leave troops, specifies how much<BR>';
    helpText += 'of troops in the city want to stop and take only the amounts <BR>';
	helpText += 'exceeding those that you specified<BR>';
	helpText += 'Finally chop the Add button and active route to the Reassign button';

    var pop = new CPopup ('pbReassHelp', 0, 0, 585, 230, true);
    pop.centerMe (mainPop.getMainDiv());
    pop.getMainDiv().innerHTML = helpText;
    pop.getTopDiv().innerHTML = '<div class=showBadged><center>Help PowerKoc: Reassigning troops between cities</center></div>';
    pop.show (true);
  },



 e_reassignRoutes: function(){
      var t = Tabs.Reassign;
      var now = new Date();
      if (t.reassignState.running == true)    {
      	var now = new Date().getTime()/1000.0;
      	now = now.toFixed(0);
      	var last = Options.lastreassign;
       		if ( now > (parseInt(last) + (Options.reassigninterval*60))){
    			  t.checkdoReassign();
      		}
      }
      setTimeout(function(){ t.e_reassignRoutes();}, Options.reassigninterval*1000);

    },

	delReassignRoutes: function() {

		var t = Tabs.Reassign;

		t.reassignRoutes= [];

	},
	checkcoords : function (obj){
		var t = Tabs.Reassign;
		if(obj.id == 'pbok'){
			t.check = true;
			t.addReassignRoute();
		}
		return;
	},
	addReassignRoute: function () {
		var t = Tabs.Reassign;
		var city = t.tcp.city.id;
		if(t.tcpto.city == null){
			new CdialogCancelContinue('<SPAN class=boldRed>No destination selected!</span>', null, null, mainPop.getMainDiv);
			return;
		}
		if(t.tcp.city.id == t.tcpto.city.id){
			new CdialogCancelContinue('<SPAN class=boldRed>You may not assign the same city!</span>', null, null, mainPop.getMainDiv);
			return;
		}
		if ((t.tcpto.city.x == 0 && t.tcpto.city.y == 0)&& !t.check)
		{
			new CdialogConfirm ('<SPAN class=boldRed>You are about to establish a route to the location 0,0!</span>', t.checkcoords, unsafeWindow.modal_attack_check, mainPop.getMainDiv);
			return;
		}
		t.check = false;

		var SendSupplyTroop = document.getElementById('pbSupplyTroops').checked;
		var SendMilitiaman = document.getElementById('pbMilitiaman').checked;
		var SendScout = document.getElementById('pbScout').checked;
		var SendPikeman = document.getElementById('pbPikeman').checked;
		var SendSwordsman = document.getElementById('pbSwordsman').checked;
		var SendArchers = document.getElementById('pbArcher').checked;
		var SendCavalry = document.getElementById('pbCavalry').checked;
		var SendHeavyCavalry = document.getElementById('pbHeavyCavalry').checked;
		var SendSupplyWagons = document.getElementById('pbSupplyWagon').checked;
		var SendBallista = document.getElementById('pbBallista').checked;
		var SendBatteringRam = document.getElementById('pbBatteringRam').checked;
		var SendCatapult = document.getElementById('pbCatapult').checked;
		var SupplyTroop = document.getElementById('pbtargetSupplyTroops').value;
		var Militiaman = document.getElementById('pbtargetMilitiaman').value;
		var Scout = document.getElementById('pbtargetScout').value;
		var Pikeman = document.getElementById('pbtargetPikeman').value;
		var Swordsman = document.getElementById('pbtargetSwordsman').value;
		var Archers = document.getElementById('pbtargetArcher').value;
		var Cavalry = document.getElementById('pbtargetCavalry').value;
		var HeavyCavalry = document.getElementById('pbtargetHeavyCavalry').value;
		var SupplyWagons = document.getElementById('pbtargetSupplyWagon').value;
		var Ballista = document.getElementById('pbtargetBallista').value;
		var BatteringRam = document.getElementById('pbtargetBatteringRam').value;
		var Catapult = document.getElementById('pbtargetCatapult').value;
		var target_x = t.tcpto.city.x;
		var target_y = t.tcpto.city.y;

		var lRE = t.reassignRoutes;
			lRE.push({
				city:				city,
				target_x:			target_x,
				target_y:			target_y,
				SendSupplyTroop:	SendSupplyTroop,
				SupplyTroop:		SupplyTroop,
				SendMilitiaman:		SendMilitiaman,
				Militiaman:			Militiaman,
				SendScout:			SendScout,
				Scout:				Scout,
				SendPikeman: 		SendPikeman,
				Pikeman: 			Pikeman,
				SendSwordsman:		SendSwordsman,
				Swordsman:			Swordsman,
				SendArchers:		SendArchers,
				Archers:			Archers,
				SendCavalry: 		SendCavalry,
				Cavalry: 			Cavalry,
				SendHeavyCavalry:	SendHeavyCavalry,
				HeavyCavalry:		HeavyCavalry,
				SendSupplyWagons:	SendSupplyWagons,
				SupplyWagons:		SupplyWagons,
				SendBallista: 		SendBallista,
				Ballista: 			Ballista,
				SendBatteringRam:	SendBatteringRam,
				BatteringRam:		BatteringRam,
				SendCatapult:		SendCatapult,
				Catapult:			Catapult,
			});
		document.getElementById('pbReassignDivD').style.background ='#99FF99';
		setTimeout(function(){ (document.getElementById('pbReassignDivD').style.background =''); }, 1000);
	},
	showReassignRoutes: function () {
		var t = Tabs.Reassign;
		var popReassignRoutes = null;
		t.popReassignRoutes = new CPopup('pbShowTrade', 0, 0, 1200, 500, true, function() {clearTimeout (1000);});
		var m = '<DIV style="max-height:460px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbShowReassignRoutes" id="pbRoutesQueue">';
		t.popReassignRoutes.getMainDiv().innerHTML = '</table></div>' + m;
		t.popReassignRoutes.getTopDiv().innerHTML = '<div class=showBadged><center>ROUTES FOR REASSIGNING</center></div>';
		t.paintReassignRoutes();
		t._addTabHeader();
		t.popReassignRoutes.show(true)	;
	},
	paintReassignRoutes: function(){
	        var t = Tabs.Reassign;
	        var r = t.reassignRoutes;
	        var cityname;
			for (var i = (r.length-1); i>=0; i--) {
				for (var y=0; y< Seed.cities.length;y++) {
					if ( parseInt(Seed.cities[y][0]) == r[i].city) var cityname = Seed.cities[y][1];
				}
				var queueId = i;
				t._addTab(queueId,cityname, r[i].target_x, r[i].target_y, r[i].SendSupplyTroop,r[i].SupplyTroop, r[i].SendMilitiaman, r[i].Militiaman, r[i].SendScout, r[i].Scout, r[i].SendPikeman, r[i].Pikeman, r[i].SendSwordsman, r[i].Swordsman, r[i].SendArchers, r[i].Archers, r[i].SendCavalry, r[i].Cavalry, r[i].SendHeavyCavalry, r[i].HeavyCavalry, r[i].SendSupplyWagons, r[i].SupplyWagons, r[i].SendBallista, r[i].Ballista, r[i].SendBatteringRam, r[i].BatteringRam, r[i].SendCatapult, r[i].Catapult);
	        }
	    },

	 _addTab: function(queueId,cityname,target_x,target_y,SendSupplyTroop,SupplyTroop,SendMilitiaman,Militiaman,SendScout,Scout,SendPikeman,Pikeman,SendSwordsman,Swordsman,SendArchers,Archers,SendCavalry,Cavalry,SendHeavyCavalry,HeavyCavalry,SendSupplyWagons,SupplyWagons,SendBallista,Ballista,SendBatteringRam,BatteringRam,SendCatapult,Catapult){
	 	var t = Tabs.Reassign;
	     var row = document.getElementById('pbRoutesQueue').insertRow(0);
	     row.vAlign = 'top';
	     row.insertCell(0).innerHTML = queueId;
	     row.insertCell(1).innerHTML = cityname;
	     row.insertCell(2).innerHTML = target_x + ',' + target_y;
	     row.insertCell(3).innerHTML = SendSupplyTroop;
	     row.insertCell(4).innerHTML = addCommas(SupplyTroop);
	     row.insertCell(5).innerHTML = SendMilitiaman;
	     row.insertCell(6).innerHTML = addCommas(Militiaman);
	 	 row.insertCell(7).innerHTML = SendScout;
	 	 row.insertCell(8).innerHTML = addCommas(Scout);
	 	 row.insertCell(9).innerHTML = SendPikeman;
	 	 row.insertCell(10).innerHTML = addCommas(Pikeman);
	 	 row.insertCell(11).innerHTML = SendSwordsman;
	 	 row.insertCell(12).innerHTML = addCommas(Swordsman);
	 	 row.insertCell(13).innerHTML = SendArchers;
	 	 row.insertCell(14).innerHTML = addCommas(Archers);
	 	 row.insertCell(15).innerHTML = SendCavalry;
	 	 row.insertCell(16).innerHTML = addCommas(Cavalry);
	 	 row.insertCell(17).innerHTML = SendHeavyCavalry;
	 	 row.insertCell(18).innerHTML = addCommas(HeavyCavalry);
	 	 row.insertCell(19).innerHTML = SendSupplyWagons;
	 	 row.insertCell(20).innerHTML = addCommas(SupplyWagons);
	 	 row.insertCell(21).innerHTML = SendBallista;
	 	 row.insertCell(22).innerHTML = addCommas(Ballista);
	 	 row.insertCell(23).innerHTML = SendBatteringRam;
	 	 row.insertCell(24).innerHTML = addCommas(BatteringRam);
	 	 row.insertCell(25).innerHTML = SendCatapult;
	 	 row.insertCell(26).innerHTML = addCommas(Catapult);
	     row.insertCell(27).innerHTML = '<a class="button20" id="tradecancel_' + queueId + '"><span>delete</span></a>';
	     document.getElementById('tradecancel_' + queueId).addEventListener('click', function(){
	        t.cancelQueueElement(queueId);
	     }, false);
	 },

	 _addTabHeader: function() {
	 var t = Tabs.transport;
	     var row = document.getElementById('pbRoutesQueue').insertRow(0);
	     row.vAlign = 'top';
	     row.insertCell(0).innerHTML = "ID";
	     row.insertCell(1).innerHTML = "from";
	     row.insertCell(2).innerHTML = "a";
	     row.insertCell(3).innerHTML = "supply Troop.";
	     row.insertCell(4).innerHTML = "";
	     row.insertCell(5).innerHTML = "militants";
	     row.insertCell(6).innerHTML = "";
	 	 row.insertCell(7).innerHTML = "scouts";
	     row.insertCell(8).innerHTML = "";
	     row.insertCell(9).innerHTML = "Pikeman";
	     row.insertCell(10).innerHTML = "";
	     row.insertCell(11).innerHTML = "swordsman";
	     row.insertCell(12).innerHTML = "";
	     row.insertCell(13).innerHTML = "archer";
	     row.insertCell(14).innerHTML = "";
	     row.insertCell(15).innerHTML = "Light cav.";
	     row.insertCell(16).innerHTML = "";
	     row.insertCell(17).innerHTML = "Heavey cav.";
	     row.insertCell(18).innerHTML = "";
	     row.insertCell(19).innerHTML = "supply wagon";
	     row.insertCell(20).innerHTML = "";
	     row.insertCell(21).innerHTML = "Ballista";
	     row.insertCell(22).innerHTML = "";
	     row.insertCell(23).innerHTML = "Battering rams";
	     row.insertCell(24).innerHTML = "";
	     row.insertCell(25).innerHTML = "Catapultas";
	     row.insertCell(26).innerHTML = "";
	     row.insertCell(27).innerHTML = "Delete";
	   },

	 cancelQueueElement: function(queueId){
	     var t = Tabs.Reassign;
	     var queueId = parseInt(queueId);
	     t.reassignRoutes.splice(queueId, 1);
	     t.showReassignRoutes();
	 },

	saveReassignRoutes: function(){
		var t = Tabs.Reassign;
        var serverID = getServerId();
        GM_setValue('reassignRoutes_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(t.reassignRoutes));
    },
    readReassignRoutes: function(){
        var t = Tabs.Reassign;
        var serverID = getServerId();
        s = GM_getValue('reassignRoutes_' + Seed.player['name'] + '_' +serverID);
        if (s != null) {
            route = JSON2.parse(s);
            for (k in route)
                t.reassignRoutes[k] = route[k];
        }
    },
	saveReassignState: function(){
		var t = Tabs.Reassign;
        var serverID = getServerId();
        GM_setValue('reassignState_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(t.reassignState));
    },
    readReassignState: function(){
        var t = Tabs.Reassign;
        var serverID = getServerId();
        s = GM_getValue('reassignState_' + Seed.player['name'] + '_' +serverID);
        if (s != null) {
            state = JSON2.parse(s);
            for (k in state)
                t.reassignState[k] = state[k];
        }
    },
    toggleReassignState: function(obj){
		var t = Tabs.Reassign;
        obj = document.getElementById('pbReassignState');
        if (t.reassignState.running == true) {
            t.reassignState.running = false;
            obj.value = "Reasigner = OFF";
		  updatebotbutton('Reasigner-OFF', 'pbsigntab');
			t.checkdoreassigntimeout = null;
			t.count = 0;
        }
        else {
            t.reassignState.running = true;
            obj.value = "Reasigner = ON";
		 updatebotbutton('Reasigner-ON', 'pbsigntab');
			t.e_reassignRoutes();
        }
    },

	checkdoReassign: function(){
	var t = Tabs.Reassign;
	t.doReassign(t.count);
	t.count++;
		if(t.count < t.reassignRoutes.length && t.reassignState.running){
		  t.checkdoreassigntimeout = setTimeout(function() { t.checkdoReassign();}, 5000);
		} else {
		  var now = new Date().getTime()/1000.0;
		  now = now.toFixed(0);
		  Options.lastreassign = now;
		  saveOptions();
		  t.count = 0;
		}
	},

    doReassign: function(count){
    	var t = Tabs.Reassign;
   		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   		if(t.reassignRoutes.length==0) return;
   		var send=[];
   		var citytotal=0;
   		var totalsend=0;
		params.u1 = 0;
		params.u2 = 0;
		params.u3 = 0;
		params.u4 = 0;
		params.u5 = 0;
		params.u6 = 0;
		params.u7 = 0;
		params.u8 = 0;
		params.u9 = 0;
		params.u10 = 0;
		params.u11 = 0;
		params.u12 = 0;

   	 	var city = t.reassignRoutes[count]["city"];
   	 	var xcoord = t.reassignRoutes[count]["target_x"];
   	 	var ycoord = t.reassignRoutes[count]["target_y"];

    	var cityID = 'city' + city;
                if(!Cities.byID[city]) return;
		var marching = getMarchInfo(cityID);
    	t.getRallypoint(cityID);
		if(t.rallypointlevel == 11) t.rallypointlevel = 15;
                 else if(t.rallypointlevel == 12) t.rallypointlevel = 20;
    	var maxsend = (t.rallypointlevel * 10000);
    	totalsend=0;

    	var troopsselect=["SupplyTroop","Militiaman","Scout","Pikeman","Swordsman","Archers","Cavalry","HeavyCavalry","SupplyWagons","Ballista","BatteringRam","Catapult"];
    	for (k=0; k<troopsselect.length; k++) {
    		var citytroops = Seed.units[cityID]['unt'+(parseInt(k)+1)];
			var marchtroops = marching.marchUnits[parseInt(k)+1];
			citytotal = parseInt(citytroops) + parseInt(marchtroops);
			if(t.reassignRoutes[count]['Send'+troopsselect[k]]==false) {continue; }
			if(citytotal > t.reassignRoutes[count][troopsselect[k]]){
				var sendtroops = parseInt(citytotal) - parseInt(t.reassignRoutes[count][troopsselect[k]]);
				if (parseInt(sendtroops) > parseInt(citytroops)) sendtroops = citytroops;
				if (parseInt(sendtroops) < 0) sendtroops = 0;
				send[(parseInt(k)+1)] = sendtroops;
				totalsend += send[(parseInt(k)+1)];
			}
			if(totalsend > maxsend){
				totalsend -= send[(parseInt(k)+1)];
				send[(parseInt(k)+1)] = parseInt(maxsend-totalsend);
				totalsend += send[(parseInt(k)+1)];
				break;
			}
       	}
    	for (var t=0; t< Seed.cities.length;t++) {
    		if ( parseInt(Seed.cities[t][0]) == city) var cityname = Seed.cities[t][1];
    	}
  		params.cid= city;
		params.type = "5";
		params.kid=0;
		params.xcoord = xcoord;
		params.ycoord = ycoord;
		params.u1 = send[1];
		params.u2 = send[2];
		params.u3 = send[3];
		params.u4 = send[4];
		params.u5 = send[5];
		params.u6 = send[6];
		params.u7 = send[7];
		params.u8 = send[8];
		params.u9 = send[9];
		params.u10 = send[10];
		params.u11 = send[11];
		params.u12 = send[12];
   		if (totalsend >0) {
      		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
                  method: "post",
                  parameters: params,
                  loading: true,
                  onSuccess: function (transport) {
                  var rslt = eval("(" + transport.responseText + ")");
                  if (rslt.ok) {
                  actionLog('reassigning from: ' + cityname + "   a: " + xcoord + ',' + ycoord + "    ->   troops: " + totalsend);
		  var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
                  var ut = unixTime();
                  var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
                  					for(i = 0; i <= unitsarr.length; i++){
                  						if(params["u"+i]){
                  								unitsarr[i] = params["u"+i];
                  						}
                  					}
                  var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
                  var currentcityid = city;
                  unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
                  if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
                  } else {
                  actionLog('REASSIGNING FAILURE :' + cityname + ' - ' + rslt.error_code + ' -  ' + rslt.msg + ' -  ' + rslt.feedback);
                  }
                  },
                  onFailure: function () {}
          });
   	 }
	},

show: function(){
		var t = Tabs.Reassign;
    },
	
hide: function(){
        var t = Tabs.Reassign;
    },
    
onUnload: function(){
        var t = Tabs.Reassign;
        if (!ResetAll) t.saveReassignRoutes();
		if (!ResetAll) t.saveReassignState();
    },
}

function getMarchInfo (cityID){
  var ret = {};
  ret.marchUnits = [];
  ret.returnUnits = [];
  ret.resources = [];
  for (i=0; i<13; i++){
    ret.marchUnits[i] = 0;
    ret.returnUnits[i] = 0;
  }
  for (i=0; i<5; i++){
    ret.resources[i] = 0;
  }
  for (k in Seed.queue_atkp[cityID]){   // each march
      march = Seed.queue_atkp[cityID][k];
	  if(march.marchType != 5){
		  if (typeof (march) == 'object'){
			for (ii=0; ii<13; ii++){
			  ret.marchUnits[ii] += parseInt (march['unit'+ ii +'Count']);
			  ret.returnUnits[ii] += parseInt (march['unit'+ ii +'Return']);
			}
			for (ii=1; ii<5; ii++){
			  ret.resources[ii] += parseInt (march['resource'+ ii]);
			}
			  ret.resources[0] += parseInt (march['gold']);
		  }
	  }
    }
  return ret;
}

/****************************  Spam Tab  ******************************/
Tabs.Spam = {
  tabOrder : 28,                    // order to place tab in top bar
  tabLabel : 'Spam',            // label to show in main window tabs
  myDiv : null,
  timer : null,

  init : function (div){    // called once, upon script startup
    var t = Tabs.Spam;
    t.myDiv = div;
    var m = '<DIV class=pbStat>advertising</div><TABLE class=pbTab width=100% height=0% ><TR align="center">';

       if (Options.spamconfig.aspam == true) {
        m += '<TD><INPUT id=pbSpamEnable type=submit value="Spam On"></td>';
       }
       else {
        m += '<TD><INPUT id=pbSpamEnable type=submit value="Spam Off"></td>';
       }

       if (Options.spamconfig.spamstate == 'a') {
        m += '<TD><INPUT id=pbSpamState type=submit value="Send to Aliance"></td>';
       }
       else {
        m += '<TD><INPUT id=pbSpamState type=submit value="Send to Global "></td>';
       }
        m += '</tr></table></div>';
       m += '<DIV class=pbStat>configuration</div><TABLE class=pbTab>';
        m += '<tr><td>Automatically post all each <INPUT id=pbSpamMin type=text size=2 maxlength=3 value="'+ Options.spamconfig.spammins +'"  \> minutes</td></tr><BR>\
              <tr><TD><TABLE cellpadding=0 cellspacing=0>\
              <TD align=left>your Message: &nbsp; </td><TD><INPUT id=pbSpamAd type=text size=60 maxlength=500 value="'+ Options.spamconfig.spamvert +'" \></td></tr>\
              </table><BR>';

    t.myDiv.innerHTML = m;

    document.getElementById('pbSpamEnable').addEventListener ('click', function(){t.toggleon(this);}, false);
    document.getElementById('pbSpamAd').addEventListener ('change', t.e_spamOptChanged, false);
    document.getElementById('pbSpamMin').addEventListener ('change', t.e_spamOptChanged, false);
    document.getElementById('pbSpamState').addEventListener ('click', function(){t.togglespam(this);}, false);
 },

  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.Spam;
  },

  show : function (){         // called whenever this tab is shown
    var t = Tabs.Spam;

  },

 e_spamOptChanged : function (){
  var t = Tabs.Spam;
  Options.spamconfig.spamvert = document.getElementById('pbSpamAd').value;
  Options.spamconfig.spammins = document.getElementById('pbSpamMin').value;
 },

 togglespam: function(obj){
  var t = Tabs.Spam;
  if (Options.spamconfig.spamstate == 'a') {
   Options.spamconfig.spamstate = 'g';
   obj.value = "send to Global ";
  }
  else {
   Options.spamconfig.spamstate = 'a';
   obj.value = "Send to Alliance";
  }
  saveOptions ();

 },

 toggleon: function(obj){
  var t = Tabs.Spam;
  if (Options.spamconfig.aspam == true) {
   Options.spamconfig.aspam = false;
   obj.value = "Spam Off";
  }
  else {
   Options.spamconfig.aspam = true;
   obj.value = "Spam On";
   SpamEvery.init();
  }
  saveOptions ();

 },
};

var SpamEvery  = {
  timer : null,
  init : function (){
    if (Options.spamconfig.spammins < 1)
      Options.spamconfig.spammins = 1;
    SpamEvery.setEnable (Options.spamconfig.aspam);
  },
  setEnable : function (tf){
    var t = SpamEvery;
    clearTimeout (t.timer);
    if (tf)
      t.timer = setTimeout (t.count, 60*1000);
  },
  count : function (){
   var t = SpamEvery;
   if (Options.spamconfig.atime > Options.spamconfig.spammins) {  
    Options.spamconfig.atime = 2;
    t.doit ();
   } else {
    Options.spamconfig.atime = (Options.spamconfig.atime + 1);
    SpamEvery.init ();
   }
  },
  doit : function (){
    actionLog ('Espameando ('+ Options.spamconfig.spammins +' minutos caducado)');
    sendChat ("/" + Options.spamconfig.spamstate + " " +  Options.spamconfig.spamvert);
    SpamEvery.init ();
  }
}

/************** ChatPane **********/
var ChatPane = {
  init : function(){
    var t = ChatPane;
	setInterval(t.HandleChatPane, 2500);
  },
  
  HandleChatPane : function() {
	var DisplayName = GetDisplayName();
	var AllianceChatBox=document.getElementById('mod_comm_list2');
	
	if(AllianceChatBox){
		var chatPosts = document.evaluate(".//div[contains(@class,'chatwrap')]", AllianceChatBox, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
		if(chatPosts){
			for (var i = 0; i < chatPosts.snapshotLength; i++) {
				thisPost = chatPosts.snapshotItem(i);
				if(Options.HelpRequest){
					var postAuthor = document.evaluate('.//*[@class="nm"]', thisPost, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
					if(postAuthor.snapshotItem(0)){
						var postAuthorName = postAuthor.snapshotItem(0).innerHTML;
						if(postAuthorName != DisplayName){
							var helpAllianceLinks=document.evaluate(".//a[contains(@onclick,'claimAllianceChatHelp')]", thisPost, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );  
							if(helpAllianceLinks){
								for (var j = 0; j < helpAllianceLinks.snapshotLength; j++) {
									thisLink = helpAllianceLinks.snapshotItem(j);
									var alreadyClicked = thisLink.getAttribute("clicked");
									if(!alreadyClicked){
										thisLink.setAttribute('clicked', 'true');
										var myregexp = /(claimAllianceChatHelp\(.*\);)/;
										var match = myregexp.exec(thisLink.getAttribute("onclick"));
										
										if (match != null) {
											onclickCode = match[0];
											if(true){
												DoUnsafeWindow(onclickCode);
											}
										}
									}
								}
							}
						}
					}
				}
				// Hide alliance requests in chat
				if(Options.DeleteRequest){
					var helpAllianceLinks=document.evaluate(".//a[contains(@onclick,'claimAllianceChatHelp')]", thisPost, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
					if(helpAllianceLinks){
						for (var j = 0; j < helpAllianceLinks.snapshotLength; j++) {
							thisLink = helpAllianceLinks.snapshotItem(j);
							thisLink.parentNode.parentNode.parentNode.parentNode.parentNode.removeChild(thisLink.parentNode.parentNode.parentNode.parentNode);
						}
					}
				// Hide alliance reports in chat
					var myregexp1 = /You are # [1-5] of 5 to help/i;
					var myregexp2 = /\'s Kingdom does not need help\./i;
					var myregexp3 = /\'s project has already been completed\./i;
					var myregexp4 = /\'s project has received the maximum amount of help\./i;
					var myregexp5 = /You already helped with (.*?)\'s project\./i;
                                        if (thisPost.innerHTML.match(myregexp1) || thisPost.innerHTML.match(myregexp2) || thisPost.innerHTML.match(myregexp3) || thisPost.innerHTML.match(myregexp4) || thisPost.innerHTML.match(myregexp5)) { 
						thisPost.parentNode.removeChild(thisPost);
					}
				}
			}	
		}	
	}
  },

}


/************************************************************************************
*			         TAB THRONE										*
************************************************************************************/
Tabs.Throne = {
  tabLabel: 'Throne',
  tabOrder: 14,
  myDiv: null,
  cont : null,
  timer : null, 
  filtre:"",
  filtre2:"",
  filtre3:"",
  filtre4:false,
  init : function (div){ 
   var t = Tabs.Throne;
	t.cont = div;	   
	t.cont.innerHTML = '';	
  },

  hide : function (){
    var t = Tabs.Throne;
     t.state = null;       
	 clearTimeout (t.displayTimer);
  },

  show : function (){
     var t = Tabs.Throne;
     unsafeWindow.itemSalvage=t.salvage;
     unsafeWindow.itemEquip=t.equipItem;
     unsafeWindow.UnequipItem=t.UnequipItem;
     uW.Repair = t.Repair;
     uW.upgradeQualite = t.upgradeQualite;
     uW.upgradeLevel = t.upgradeLevel;
     t.cont.innerHTML = m;
     var m = '<DIV style="max-height:500px; overflow-y:auto"><TABLE width=80% class=pbTab><TR align="center">';
     var k=Seed.throne.slotEquip[Seed.throne.activeSlot],i=Seed.throne.inventory,e,faction,sl=0,i = unsafeWindow.kocThroneItems;
      m += '</tr></table>';
      m += '<DIV class=pbStat>THRONE - INVENTORY</div><center>';
     var B=0, w={}, x;
          for (var K in k) {
           var F = unsafeWindow.kocThroneItems[k[K]];
           if (F) {
           x=0;
           for (var M in F.effects) {
           x++;
           if (F.quality >= x) {
            B++;
            I = unsafeWindow.cm.thronestats.effects[F.effects[M].id];
            z = unsafeWindow.cm.thronestats.tiers[F.effects[M].id][F.effects[M].tier];
            C = + z.base + F.level * + z.growth;
            if (!w[F.effects[M].id]) {w[F.effects[M].id] = {};}
	                if (!w[F.effects[M].id].percent) {
	                 w[F.effects[M].id].percent = C;
	                } else {
	                 w[F.effects[M].id].percent += C;
	                }
             w[F.effects[M].id].name = I[1];
             }
            }
           }
          }
        B = 0;
        for (var K in w) {
            
            G="<b>"+ w[K].percent + "% </b>" + w[K].name + "<br>";
            
             m+=G;
         }
   m+="</table></center>";

          m +='<DIV class=pbStat><b>EQUIPPED</b></div><center><DIV id=BOTroneE style="width:80%;height:33px;max-height:33px;"></DIV></center>';
 
	  m += '<DIV class=pbStat>TEMS OF THE THRONE (<span id=TotalItems></span> Objetos)</div><center>group: <select id=ThroneGroupFilter><option value="">all</option><option value="briton">Briton</option><option value="druid">Druid</option><option value="fey">Fey</option></select>\
         type: <select id=ThroneTypeFilter><option value="">all</option><option value="advisor">adviser</option><option value="banner">banner</option><option value="chair">chair</option><option value="table">table</option><option value="window">window</option></select>\
         level: <select id=ThroneLevelFilter><option value="">all</option><option value="0">simple</option><option value="1">comon</option><option value="2">uncommon</option><option value="3">rare</option><option value="4">epic</option><option value="5">wondrous</option></select>\
         <input type=checkbox id=ThroneAllEffects>Show all effects<br><table style="background-color:transparent;max-width:80%;width:80%;" cellspacing=2 cellpadding=2><tr><td colspan=1><b><u>object</u></b></td><td><b><u>level</u></b></td><td><b><u>name</u></b></td>\
         <td><b><u>group</u></b></td>\
         <td><b><u>type</u></b></td><td><b><u>effects</u></b></td><td><b><u>action</u></b></td></tr>';
     nb=0;
     t.tableau=[];

     for (var z in i) {
           if (i[z].id) {
            e=uW.kocThroneItems[i[z].id];
            if (e) {
              
              t.tableau[sl]=i[z].id;
              sl++
            }
           }
     }

     var lignauto = Seed.throne.rowNum * 5;
     t.tableau.reverse();
      var pastoucher = [];
       for (var nbslot=1;nbslot<=Seed.throne.slotNum;nbslot++) {
        B = Seed.throne.slotEquip[nbslot];
        for (var zzz in B) {
         if (uW.kocThroneItems[B[zzz]]) {
          pastoucher.push(B[zzz]);
         }
        }
       } 
     var nbl=t.tableau.length+1;

     var BOtimeLeft=-1;
     if (Seed.queue_throne) {
      if (Seed.queue_throne.end)
          BOtimeLeft = Seed.queue_throne.end - uW.unixtime();
     }
     
     for (var z=0;z<t.tableau.length;z++) {
       e=unsafeWindow.kocThroneItems[t.tableau[z]];
       nb++;
       faction=e.faction;
       x=0;
       nbl--;
       if ( (t.filtre=="" || t.filtre==faction) && (t.filtre2=="" || t.filtre2==e.quality) && (t.filtre3=="" || t.filtre3==e.type) )  {
       if (e.isEquipped) 
        equip="equip";
       else
        equip="normal";
        
        m+="<tr><td><img title='"+e.name+"' width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/30/"+ faction.replace('briton','britton') +"/"+ faction.replace('briton','britton') +"_"+e.type+"_"+equip+"_1.png></td>\
        <td>"+ e.createPrefix() + "</td><td>"+ e.createSuffix() + "</td><td>"+e.faction+"</td><td> "+e.type+"</td>";
        
        m+="<td>";
        for (var u in e.effects) {
           x++;
           if ((e.quality >= x && !t.filtre4) || t.filtre4) {
          var coleur="";
          var stylee="";
          if (e.quality < x) 
           stylee="text-decoration:line-through";
          if (e.effects[u].id==66) { // troupes max
            coleur="#AAAA11";
          }
         if (e.effects[u].id==77) { // build
          coleur="#AA1111";
         }
         if (e.effects[u].id==78) { // construction
	           coleur="#AA11AA";
         }
         if (e.effects[u].id>=67 && e.effects[u].id<=72) { // boost marches
	           coleur="#11AA11";
         }
           if (e.effects[u].id==6 || e.effects[u].id==48 || e.effects[u].id==59) { // boost transport
	 	           coleur="#1111AA";
         }
         m+="<span style='"+stylee+"'><font color="+coleur+">" + unsafeWindow.cm.thronestats.tiers[e.effects[u].id][e.effects[u].tier].base + "% " + unsafeWindow.cm.thronestats.effects[e.effects[u].id][1]+ "</font></span><bR>";
         }
        }
        m+="</td>"
       
     if (nbl<=lignauto) {
        m+="<td><a onclick='itemSalvage("+t.tableau[z]+")' class='buttonv2 h20 brown'>Salvage</a>";
       if (equip=="normal")
           m+="&nbsp;<a onclick='itemEquip("+t.tableau[z]+")' class='buttonv2 h20 blue'>equip</a></td></tr>";
        else
           m+="<a onclick='UnequipItem("+t.tableau[z]+")' class='buttonv2 h20 blue'>Unequip</a>";
       } else {
           m+="<td><font color=red>Not available</font></td></tr>";
       }
      }
     }
     m+="</table>";
     m+="</div>";
     t.cont.innerHTML = m;  
     
     document.getElementById("TotalItems").innerHTML= nb;
     document.getElementById('ThroneGroupFilter').value=t.filtre;
     document.getElementById('ThroneGroupFilter').addEventListener ('change', t.filtreaction, false);
     document.getElementById('ThroneLevelFilter').value=t.filtre2;
     document.getElementById('ThroneLevelFilter').addEventListener ('change', t.filtreaction, false);
     document.getElementById('ThroneTypeFilter').value=t.filtre3;
     document.getElementById('ThroneTypeFilter').addEventListener ('change', t.filtreaction, false);
     document.getElementById('ThroneAllEffects').checked=t.filtre4;
     document.getElementById('ThroneAllEffects').addEventListener ('click', t.filtreaction, false); 

   // Equipados
     var effft="",faction={0:'advisor',1:'banner',2:'chair',3:'table',4:'window'};
     var zz="<center><table width=100%><TR></center>";
     for (var fp in faction) {
      equip="normal";
      effft="";
      var k=Seed.throne.slotEquip[Seed.throne.activeSlot];
      for (var tt in k) {
      if (uW.kocThroneItems[k[tt]])
       if (uW.kocThroneItems[k[tt]].type==faction[fp]) {
        equip="equip";
        x=0;
        for (var u in uW.kocThroneItems[k[tt]].effects) {
          x++;
          if (uW.kocThroneItems[k[tt]].quality >= x) {
            var ww=uW.cm.thronestats.tiers[uW.kocThroneItems[k[tt]].effects[u].id][uW.kocThroneItems[k[tt]].effects[u].tier];
            var pourc = + ww.base + (uW.kocThroneItems[k[tt]].level * uW.kocThroneItems[k[tt]].level + uW.kocThroneItems[k[tt]].level) * + ww.growth * 0.5;
            pourc = Math.ceil(pourc);
            effft+= pourc + "% " + uW.cm.thronestats.effects[uW.kocThroneItems[k[tt]].effects[u].id][1]+ "&#013;";
            
            }
        }
       }
      }
      zz+="<td><img title='"+effft+"' align=absmiddle width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/30/britton/britton_"+faction[fp]+"_"+equip+"_1.png><td>"+faction[fp]+"</td>";
     }
     zz+="</tr></table>";
     ById("BOTroneE").innerHTML=zz;
  },



    filtreaction: function() {
    var t = Tabs.Throne;
    t.filtre = document.getElementById('ThroneGroupFilter').value;
    t.filtre2 = document.getElementById('ThroneLevelFilter').value;
    t.filtre3 = document.getElementById('ThroneTypeFilter').value;
    t.filtre4 = document.getElementById('ThroneAllEffects').checked;
    t.show();
  
  },


  setPreset:function(e) {
     var t = Tabs.Throne;
     var params = uW.Object.clone(uW.g_ajaxparams);
     params.action="setPreset";
     params.ctrl="throneRoom\\ThroneRoomServiceAjax";
     params.presetId=e; 
     uW.ajax.Request(uW.g_ajaxpath+"ajax/_dispatch53.php"+uW.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
      onSuccess:function(transport)
      {
       var m = eval("(" + transport.responseText + ")");
       if (m.ok === true){
         B = Seed.throne.slotEquip[e];
         Seed.throne.activeSlot = e;
	 for (var c in uW.kocThroneItems) {
	  D = uW.kocThroneItems[c];
	  if (B[D.id]) {
	     D.isEquipped = true;
	  } else {
	    D.isEquipped = false;
	  }
	 }
         t.show();
       }
      }
     });
  },

  upgradeQualite:function(id) {
    var t = Tabs.Throne;
    
    var currentcityid = Seed.cities[Options.salvageconfig.CityCity][0];
    
    var params = uW.Object.clone(uW.g_ajaxparams);
       params.action="upgradeQuality";
       params.ctrl="throneRoom\\ThroneRoomServiceAjax";
       params.throneRoomItemId=id; 
       params.buffItemId=0;
       params.payment="aetherstone";
       params.cityId=currentcityid;
       uW.ajax.Request(uW.g_ajaxpath+"ajax/_dispatch53.php"+uW.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
        onSuccess:function(transport) {
         var m = eval("(" + transport.responseText + ")");
         if (m.ok === true){
          Seed.resources["city" + currentcityid].rec5[0] = Seed.resources["city" + currentcityid].rec5[0] - m.aetherstones;
         
          var s = uW.kocThroneItems[id];
          if (m.success) {
           s.quality = m.item.quality;s.level = m.item.level;s.name = s.createName();
          } else {
           s.quality = m.item.quality;s.level = m.item.level;s.name = s.createName();
           if (m.break) { s.brokenType = "quality"; }
           s.isBroken = true;
           s.name = s.createName();
          }
          t.show();
         }
        }
   });
    
  },

  upgradeLevel:function(id) {
    var t = Tabs.Throne;
        var currentcityid = Seed.cities[Options.salvageconfig.CityCity][0];
        
        var params = uW.Object.clone(uW.g_ajaxparams);
           params.action="upgradeLevel";
           params.ctrl="throneRoom\\ThroneRoomServiceAjax";
           params.throneRoomItemId=id; 
           params.buffItemId=0;
           params.payment="aetherstone";
           params.cityId=currentcityid;
           uW.ajax.Request(uW.g_ajaxpath+"ajax/_dispatch53.php"+uW.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
            onSuccess:function(transport) {
             var m = eval("(" + transport.responseText + ")");
             if (m.ok === true){
              Seed.resources["city" + currentcityid].rec5[0] = Seed.resources["city" + currentcityid].rec5[0] - m.aetherstones;
                        var s = uW.kocThroneItems[id];
	                if (m.success) {
	                 s.quality = m.item.quality;s.level = m.item.level;s.name = s.createName();
	                } else {
	                 s.quality = m.item.quality;s.level = m.item.level;s.name = s.createName();
	                 if (m.break) { s.brokenType = "level"; }
	                 s.isBroken = true;
	                 s.name = s.createName();
	                }
          		t.show();
             }
            }
   });
    
  },

  Repair:function(id) {
   var t = Tabs.Throne;
   var params = uW.Object.clone(uW.g_ajaxparams);
   params.action="timeRepair";
   params.ctrl="throneRoom\\ThroneRoomServiceAjax";
   params.throneRoomItemId=id; 
   uW.ajax.Request(uW.g_ajaxpath+"ajax/_dispatch53.php"+uW.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
    onSuccess:function(transport) {
     var m = eval("(" + transport.responseText + ")");
     if (m.ok === true){
      Seed.queue_throne.start = uW.unixtime();
      Seed.queue_throne.end = m.eta;
      Seed.queue_throne.itemId = id;
      uW.kocThroneItems[id].isBroken = false;
      unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
      t.show();
     }
    }
   });

  },
 
  equipItem: function(id) {
   var t = Tabs.Throne;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.action="equipItem";
   params.ctrl="throneRoom\\ThroneRoomServiceAjax";
   params.itemId=id; 
   params.presetId=Seed.throne.activeSlot;//unsafeWindow.currentcityid;
   unsafeWindow.ajax.Request(unsafeWindow.g_ajaxpath+"ajax/_dispatch53.php"+unsafeWindow.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
    onSuccess:function(transport) {
     var m = eval("(" + transport.responseText + ")");
     if (m.ok === true){
      // unsafeWindow.ThroneView.clickItemEquip(unsafeWindow.kocThroneItems[id]);
      unsafeWindow.cm.ThroneView.clickItemEquip(unsafeWindow.kocThroneItems[id]);
      t.show();
     }
    }
   });
  },

  UnequipItem: function(id) {
     var t = Tabs.Throne;
      var params = uW.Object.clone(uW.g_ajaxparams);
     params.action="unequipItem";
     params.ctrl="throneRoom\\ThroneRoomServiceAjax";
     params.itemId=id; 
     params.presetId=Seed.throne.activeSlot;
     uW.ajax.Request(uW.g_ajaxpath+"ajax/_dispatch53.php"+uW.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
      onSuccess:function(transport) {
       var m = eval("(" + transport.responseText + ")");
       if (m.ok === true){
        unsafeWindow.cm.ThroneView.clickItemUnequip(uW.kocThroneItems[id]);
        t.show();
       }
      }
     });
  },

  salvage: function(id) {
   var t = Tabs.Throne;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.action="salvage";
   params.ctrl="throneRoom\\ThroneRoomServiceAjax";
   params.itemId=id; 
   params.cityId=Seed.cities[Options.salvageconfig.CityCity][0];
   unsafeWindow.ajax.Request(unsafeWindow.g_ajaxpath+"ajax/_dispatch53.php"+unsafeWindow.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
    onSuccess:function(transport) {
     var m = eval("(" + transport.responseText + ")");
     if (m.ok){ 
      unsafeWindow.kocThroneItems[id].salvage();
      t.show();
     }
    }
   });
  }
}

/******************* Throne upgrade **********************/



Tabs.upgrader = {   
	tabOrder: 500,
    tabLabel: 'Upgrader',
    tabDisabled : false,
	myDiv : null,
	timer : null,
	repairId : 0,
	repairEnd : 0,
		
	init : function (div){
       var t = Tabs.upgrader;
       t.myDiv = div;
 
       // header stuff
       var m = '<Div><DIV id=pbUpgrader class=pbStat>AUTOMATED UPGRADER</div><TABLE id=pbupgrader width=100% height=0% class=pbTab><TR align="center">';
	   if (upgradeData.active == false) {
	       m += '<TD><INPUT id=UpgraderPower type=submit value="Upgrade = OFF"></td>';
	   } else {
	       m += '<TD><INPUT id=UpgraderPower type=submit value="Upgrader = ON"></td>';
	   }
	   
	   if (upgradeData.enhanceAction == false) {
	       m += '<TD><INPUT id=UpgraderSelect type=submit value="Action = Upgrade"></td>';
	   } else {
	       m += '<TD><INPUT id=UpgraderSelect type=submit value="Action = Enhance"></td>';
	   }
	   
	   // retry interval entry
 	   m += '<td>Retry interval (seconds): <INPUT id=pbUpRefresh type=text size=3 maxlength=3 value="' +upgradeData.retryInterval+ '"></td>';
 	   m += '</tr>';
 	   m += '<tr><td><div><br></div></td></tr></table></div>';
	   
 	   // upgrade selector
 	   m += '<TABLE  class=pbTabPad2><tr align="center"><td><div><span>Item to upgrade: <select id="UpgradeList">';
 	   m += '<option value="0">--Items--</option>';
	   for (k in unsafeWindow.kocThroneItems) {
         var throne_item = unsafeWindow.kocThroneItems[k];
         m += '<option value="'+k+'">'+throne_item.name+'</option>';
	   }
       m += '</select></span></div></td>';
       m += '</tr></table>';
       
       m += '<tr><td><div> <br> </div></td></tr>';
       
       // enhance selector
 	   m += '<TABLE  class=pbTabPad2><tr align="center"><td><div><span>Item to enhance: <select id="EnhanceList">';
 	   m += '<option value="0">--Items--</option>';
	   for (k in unsafeWindow.kocThroneItems) {
         var throne_item = unsafeWindow.kocThroneItems[k];
         m += '<option value="'+k+'">'+throne_item.name+'</option>';
	   }
       m += '</select></span></div></td>';
       m += '<td><div> Maximum quality: <select id="MaxQuality">';
       m += '<option value="1">Common</option>';
       m += '<option value="2">Uncommon</option>';
       m += '<option value="3">Rare</option>';
       m += '<option value="4">Epic</option>';
       m += '<option value="5">Wonderous</option>';
       m += '</select></div></td></tr>';
       
       m += '<tr><TD><INPUT id=pbSwithUpgrade type=checkbox '+ (upgradeData.switchToUpgrade?' CHECKED':'') +'\>  Switch from enchance to upgrade when complete</td></tr>';
       m += '</tr></table>';
       
       m += '<tr><td><div> <br> </div></td></tr>';
       m += '<tr align="center"><td><div id=pbLastResult class=indent25> <br> </div></td></tr>';
       m += '<tr align="center"><td><div id=pbUpgradeStatus class=indent25> <br> </div></td></tr>';
       m += '<tr><td><div> <br> </div></td></tr>';
       
       m+='</div>';
       t.myDiv.innerHTML = m;
       
       document.getElementById ('UpgradeList').addEventListener ('click', function() {
    	  if (this.value >= 1) {
    		  logit(" Item selected to upgrade: " + this.value + "/" + unsafeWindow.kocThroneItems[this.value].name);
    		  upgradeData.item = this.value;
    		  saveUpgradeData();
    	  }
	    }, false);
	    
	    document.getElementById ('EnhanceList').addEventListener ('click', function() {
    	  if (this.value >= 1) {
    		  logit(" Item selected to enhance: " + this.value + "/" + unsafeWindow.kocThroneItems[this.value].name);
    		  upgradeData.enhanceItem = this.value;
    		  saveUpgradeData();
    	  }
	    }, false);
	    
	   document.getElementById ('MaxQuality').addEventListener ('click', function() {
    	  if (this.value >= 0) {
    		  logit(" Enhance max set to: " + this.value);
    		  upgradeData.enhanceMax = this.value;
    		  saveUpgradeData();
    	  }
	    }, false);
	    
	   document.getElementById('pbUpRefresh').addEventListener('change', function(){
		  upgradeData.retryInterval = parseInt(document.getElementById('pbUpRefresh').value);
		  if (upgradeData.retryInterval < 15) upgradeData.retryInterval = 15;
		  saveUpgradeData();
	    }, false);

	   document.getElementById('UpgraderPower').addEventListener('click', function(){t.togglePower(this)} , false);
	   document.getElementById('UpgraderSelect').addEventListener('click', function(){t.toggleSelect(this)} , false);
	   
	   if (unsafeWindow.kocThroneItems[upgradeData.item] != null)
	     document.getElementById('UpgradeList').value = upgradeData.item;
	     
	   if (unsafeWindow.kocThroneItems[upgradeData.enhanceItem] != null)
	     document.getElementById('EnhanceList').value = upgradeData.enhanceItem;
	   
	   document.getElementById('MaxQuality').value = upgradeData.enhanceMax;
	   
	   document.getElementById('pbSwithUpgrade').addEventListener('change', function(){
		  upgradeData.switchToUpgrade = document.getElementById('pbSwithUpgrade').checked;
		  saveUpgradeData();
	    }, false); 
	   
	   // wait for the current repair to finish before starting  
	   var d = 5;
	   
	   t.setStatus("Loading ....");
	   if (Seed.queue_throne != null && Seed.queue_throne.end != null)
	   {
	      var repairTimeLeft = Seed.queue_throne.end- unixTime();
	      //logit("repair time left: " + repairTimeLeft);
	          
	      t.repairEnd = Seed.queue_throne.end;
	      t.repairId = Seed.queue_throne.itemId;
	      var n = new Date(t.repairEnd *1000);

	      t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete");
	      setTimeout(t.clearRepair, (repairTimeLeft+1)*1000);
	      if (repairTimeLeft >0) d += repairTimeLeft;
      }
	  setTimeout(t.doAction, d*1000);
   },
	
	togglePower: function(obj){
	 var t = Tabs.upgrader;
	 if (upgradeData.active == true) {
		upgradeData.active = false;
		obj.value = "Upgrade = OFF";
		t.setStatus("Powered off");
	} else {
		upgradeData.active = true;
		obj.value = "Upgrade = ON";
		t.setStatus("Power on");
	}
	
	if (upgradeData.active == false)
	{
	   logit("Current stats: " + inspect(upgradeStats,4,1));
    }
    
	saveUpgradeData();
  },
  
  	toggleSelect: function(obj){
	 var t = Tabs.upgrader;
	 if (upgradeData.enhanceAction == true) {
		upgradeData.enhanceAction = false;
		obj.value = "Action = Upgrade";
	} else {
		upgradeData.enhanceAction = true;
		obj.value = "Action = Enhance";
	}
	saveUpgradeData();
  },
  
  setStatus : function (s)
  {
	  document.getElementById('pbUpgradeStatus').innerHTML = "<div>" + s + "</div>";
  },
  
   setResult : function (s)
  {
	  document.getElementById('pbLastResult').innerHTML = "<div>" + s + "</div>";
  },
  
  doAction :function ()
  {
	  var t = Tabs.upgrader;
	  var retryTime = upgradeData.retryInterval;
	  //logit("do action");
	  try {
		// check if repair is done
		var ti = t.clearRepair();
	    if ( ti <= 0)
	    {
	      // do something
          if (upgradeData.enhanceAction == true)
          {
	        t.doEnhance();
          }	  
          else
          {
	        t.doUpgrade();
          }
        } else {
	        // come back after repair is complete 
	        retryTime = ti + 5;	        
	        var n = new Date(t.repairEnd *1000);
	        t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete");
        }
        unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
      } catch(e) {
	      logit ("exception: " + inspect(e,3,1));
      }
      // recycle
      setTimeout(t.doAction, retryTime*1000);
  },
  
  doEnhance : function() {
	    //logit("enhance");
		var t = Tabs.upgrader;
		var eItem = upgradeData.enhanceItem;
		try {
		if (upgradeData.active == false || upgradeData.enhanceAction == false || eItem ==0)
		{ 
			t.setStatus("Powered off");
			return;
		}
		var y = unsafeWindow.kocThroneItems[eItem];
		
		if (!y) return;
		if ( y.quality >= upgradeData.enhanceMax)
		{
			t.setStatus("Enhancing complete");
			actionLog('Throne room item '+unsafeWindow.kocThroneItems[eItem].name + ' is already at quality ' + y.quality);
			
			// switch to upgrade
			if (upgradeData.switchToUpgrade == true && upgradeData.enhanceAction == true)
			{
			  t.toggleSelect(document.getElementById('UpgraderSelect'));
		    }
			return;
		}
		if (y.isBroken) 
		{
			// repair and then try again later
			t.doRepair(eItem);
			return;
		}
		
		if ( Seed.resources["city" + Seed.cities[0][0]]["rec5"][0] < upgradeData.minStones)
		{
		   t.setStatus("Not enough aetherstones to enhance.  Waiting for more ...");
		   return;	
		}
		
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
		params.action = 'upgradeQuality';
		params.throneRoomItemId = eItem;
		params.buffItemId = 0;
		params.payment = "aetherstone";
		params.cityId = Seed.cities[0][0];
		
	    t.setStatus("Sending enhance request");
      	new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			loading: true,
			onSuccess: function (transport) {
				var rslt = eval("(" + transport.responseText + ")");
				//logit("rslt: " + inspect(rslt,3,1));
				if(rslt.ok){
					Seed.resources["city" + Seed.cities[0][0]]["rec5"][0] -= rslt.aetherstones;

					if (rslt.success)
					{					
					   actionLog('Enhanced Throne room item '+unsafeWindow.kocThroneItems[eItem].name + ' to quality ' + rslt.item.quality);
					   upgradeStats.enhanceSuccess[y.quality][y.level]++;
					   y.level = rslt.item.level;
	                   y.quality = rslt.item.quality
					   y.status = rslt.item.status;
					   saveUpgradeStats();
					   y.name = y.createName();
					   t.setResult("Enhance successful");
					   t.setStatus("Waiting for next cycle");
				    }
				    else
				    {
					   actionLog('Enhance failed Throne room item '+unsafeWindow.kocThroneItems[eItem].name);
					   upgradeStats.enhanceFailure[y.quality][y.level]++;
					   y.level = rslt.item.level;
	                   y.quality = rslt.item.quality
					   y.status = rslt.item.status;
					   saveUpgradeStats();
					   y.isBroken = true;
					   y.brokenType = "quality";
					   y.name = y.createName();
					   t.setResult("Enhance failed");
					   t.setStatus("Starting repair ...");
					   t.doRepair(y.id);
				    }
				    if (rslt.gems > 0)
				    {
					    actionLog('Upgrader accidentally spent gems!  Turning upgrader off');
					    t.setStatus("Error ... shutting down");
					    upgradeData.active = false;
					    saveUpgradeData();
				    }
				    unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
				}
				else
			    {
				  logit("Enhance result:" + inspect (rslt, 3, 1));
				  t.setStatus("Unable to enhance at this time ... waiting for next cycle");
			    }
			    return;
			},
			onFailure: function () {
			   logit("Enhance error.  Waiting for next cycle.");
			   t.setStatus("Unable to send enhance request.  Waiting for next cycle");
			   return;
			},
		});
	} catch (e) {
		logit ("excpetion: "+ inspect(e,3,1));
	}
	   return;
	},
	   
	doUpgrade : function() {
		var t = Tabs.upgrader;
		var uItem = upgradeData.item;
		var y = unsafeWindow.kocThroneItems[uItem];
		if (upgradeData.active == false || upgradeData.enhanceAction == true || uItem ==0 || y == null)
		{ 
			t.setStatus("Powered off.");
			return;
		}
		if (y.isBroken) 
		{
			// repair and then try again later
			t.doRepair(uItem);
			return;
		}
		if ( Seed.resources["city" + Seed.cities[0][0]]["rec5"][0] < upgradeData.minStones)
		{
		   t.setStatus("Not enough aetherstones to upgrade.  Waiting for more ...");
		   return;	
		}
		
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
		params.action = 'upgradeLevel';
		params.throneRoomItemId = uItem;
		params.buffItemId = 0;
		params.payment = "aetherstone";
		params.cityId = Seed.cities[0][0];
		t.setStatus("Sending upgrade request ...");
      	new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			loading: true,
			onSuccess: function (transport) {
				var rslt = eval("(" + transport.responseText + ")");
				//logit("rslt: " + inspect(rslt,3,1));
				if(rslt.ok){
					Seed.resources["city" + Seed.cities[0][0]]["rec5"][0] -= rslt.aetherstones;
					if (rslt.success)
					{
					   actionLog('Upgraded Throne room item '+unsafeWindow.kocThroneItems[uItem].name + ' to level ' + rslt.item.level);
					   upgradeStats.upgradeSuccess[y.quality][y.level]++;
					   saveUpgradeStats();
					   y.level = rslt.item.level;
					   y.quality = rslt.item.quality;
					   y.name = y.createName();
					   t.setResult("Upgrade successful");
					   t.setStatus("Waiting for next cycle");
				    }
				    else
				    {
					   actionLog('Upgrade failed Throne room item '+unsafeWindow.kocThroneItems[uItem].name);
					   upgradeStats.upgradeFailure[y.quality][y.level]++;
					   saveUpgradeStats();
					   y.isBroken = true;
					   y.brokenType = "level";
					   y.status = rslt.item.status;
                       y.name = y.createName();
                       t.setResult("Upgrade failed");
                       t.setStatus("Starting repair ... ");
                       t.doRepair(uItem);  //fix item
				    }
				    unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);				    
				    if (rslt.gems > 0)
				    {
					    t.setStatus("Error .... Shutting down.");
					    actionLog('Upgrader accidentally spent gems!  Turning upgrader off');
					    upgradeData.active = false;
					    saveUpgradeData();
				    }
				    return;
				}
				else
				{
					t.setStatus("Upgrade request not accepted.  Waiting for next cycle.");
				    logit("Upgrade result:" + inspect (rslt, 3, 1));
			    }
			    //unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
			    return;
			},
			onFailure: function () {
			   t.setStatus("Unable to transmitt upgrade request.  Waiting for next cycle.");
			   unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
			   return;
			},
		});
		
		return;
	},
		
	 doRepair : function( rItem) {
		var t = Tabs.upgrader;	
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		
		//logit ("repair");
		if (upgradeData.active == false || rItem == 0 || unsafeWindow.kocThroneItems[rItem] == null)
		{ 
			logit("repair is turned off");
			return;
		}
		var theItem = unsafeWindow.kocThroneItems[rItem];
	
		//var rItem = upgradeData.item;
		params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
		params.action = 'timeRepair';
		params.throneRoomItemId = rItem;
		params.cityId = Seed.cities[0][0];
	    
      	new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			loading: true,
			onSuccess: function (transport) {
				var rslt = eval("(" + transport.responseText + ")");
				   //logit("rslt: " + inspect(rslt,3,1));
				   if(rslt.ok){
				 	 actionLog('Starting repair for Throne room item '+unsafeWindow.kocThroneItems[rItem].name);
				 	 Seed.queue_throne.itemId= rItem;
		             Seed.queue_throne.start=unixTime();
					 Seed.queue_throne.end= rslt.eta;
					 t.repairId = rItem;
					 t.repairEnd = rslt.eta;
					 var n = new Date(t.repairEnd *1000);
	                 t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString());
					 var x = rslt.eta - unixTime();
					 unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
					 setTimeout(t.clearRepair, (x+1)*1000);
				   }
				   else
				   {
					   if (rslt.msg == "Item is not broken")
					   {
						   t.setStatus("Item is repaired.");
						   t.repairId = rItem;
						   t.repairEnd = 0;
						   t.clearRepair();
					   }
				   }
				   return;
			},
			onFailure: function () {
			    logit("repair error");
			    // this usually means a repair is in progress (such as a manual repair).  Grab the seed data (if possible)
			    if (Seed.queue_throne && Seed.queue_throne.Seed.queue_throne.end)
			    {
				    t.repairEnd = Seed.queue_throne.end;
				    t.repairId = Seed.queue_throne.itemId;
			    }
			   return;
			},
		});
		return;
	},
	
	clearRepair : function () {
		var t = Tabs.upgrader;
		var timeUntilDone = 0;
		//logit(" time, end, id: " + unixTime() +", " + t.repairEnd + ", " + t.repairId);
		
		if (t.repairEnd == 0)
		{
			return timeUntilDone;
		}
		timeUntilDone = t.repairEnd - unixTime();
		   
	    if (timeUntilDone <= 0)
		{
	      //logit("clearing repair");
	      if (t.repairId != 0 && unsafeWindow.kocThroneItems[t.repairId]  != null)
	      {
		     if (unsafeWindow.kocThroneItems[t.repairId].isBroken == true)
	         {
		        t.setStatus("Repair time complete.");
	         }
		     unsafeWindow.kocThroneItems[t.repairId].isBroken = false;
		     unsafeWindow.kocThroneItems[t.repairId].brokenType = "";
		     t.repairId = 0;
	      } 
	      
      }
      unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
      return timeUntilDone;
	},
		
	show: function(){
	},
	
	hide: function(){
	},		
};




/******************* Combat Tab **********************/
Tabs.Combat = {
        tabLabel: 'Combat',
        tabOrder: 24,
	myDiv: null,
	troops: [{},{}], //Array[Defender, Attacker]
	active: [{},{}],
	lost: [{},{}],
	total: [],
	stats: unsafeWindow.unitstats,   //  Life, Attack, Defense, Speed, Range, Load
	priority: [[3,7,8,4,5,6,2,1,9,11,10,12],[12,10,6,3,7,8,4,5,2,1,9,11]],
	round: 0,
	range: [0,0,0], //[Defender, Attacker, Max]
	distance: [{},{}], // [Defender, Attacker]
	speed: [0,0], // [Defender max, Attacker max]
	start: 0,
	pop : null,
	
	init: function(div){
		var t = Tabs.Combat;
		t.myDiv = div;
		var m = '<table><TR><TD colspan=2><b>Attcker</b>&nbsp;&nbsp;<INPUT id=pbcombat_1 type=submit value=research></td><TD colspan=2><b>Defender</b>&nbsp;&nbsp;<INPUT id=pbcombat_0 type=submit value=research></td></TR>';
		for(var troops in unsafeWindow.unitcost){
			var name = unsafeWindow.unitcost[troops][0];
			m+='<tr><td>'+name+' :</td><td><input type=text id="pbcombata_'+troops+'" /></td><td>'+name+' :</td><td><input type=text id="pbcombatd_'+troops+'" /></td></tr>';
		}
		m+='</table><DIV id=pbcombat_rslt></div>';
		t.myDiv.innerHTML = m;
		
		for(var troops in unsafeWindow.unitcost){
			document.getElementById('pbcombata_'+troops).addEventListener('change', t.e_calculate, false);
			document.getElementById('pbcombatd_'+troops).addEventListener('change', t.e_calculate, false);
		}
		document.getElementById('pbcombat_1').addEventListener('click', function() t.e_research(1),false);
		document.getElementById('pbcombat_0').addEventListener('click', function() t.e_research(0),false);
	},
	
	e_research : function(side){
		var t = Tabs.Combat;
		t.pop = new CPopup ('pbcombatresearch', 0, 0, 275, 300, true, function(){t.c_ratio(); t.pop.destroy();});
		t.pop.centerMe (mainPop.getMainDiv()); 
		t.pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>Research levels</b>: '+ (side?'Attacker':'defender') +'</center></div>';
		var m = '<DIV><TABLE>';
		for(var k in CombatOptions.research[side]){
			m += '<TR><TD>'+unsafeWindow.techcost[k][0]+':</td><td><input id="pbcombat_'+k+'" /></td></tr>';
		}
		m += '<TR><TD>Combat.knight:</td><td><input id="pbcombat_knt" value='+ CombatOptions.knt[side] +' /></td></tr>';
		m += '<TR><TD>Guardian: </td><td> \
			  <table><tr><td>Tipo: </td><td>'+ htmlSelector({wood:'wood',ore:'ore'},CombatOptions.guardian[side][0],'id=pbcombat_guartype') +'</td></tr><tr>\
			  <td>Nivel: </td><td><input id="pbcombat_guarlvl" value='+ CombatOptions.guardian[side][1] +' size=4 /></td></tr></table>\
			  </td></tr>';
		m += '<TR><TD colspan=2><CENTER><button id=pbcombatresearchsave>Guardar</button></CENTER></td></tr></table></div>';
		t.pop.getMainDiv().innerHTML = m;
		t.pop.centerMe (mainPop.getMainDiv());  
		t.pop.show (true);
		for(var k in CombatOptions.research[side]){
			t.e_saveresearch('pbcombat_'+k, k, side);
		}
		document.getElementById('pbcombat_knt').addEventListener('change',function(){
			CombatOptions.knt[side] = parseInt(document.getElementById('pbcombat_knt').value);
			saveCombatOptions();
		},false);
		document.getElementById('pbcombat_guartype').addEventListener('change',function(){
			CombatOptions.guardian[side][0] = document.getElementById('pbcombat_guartype').value;
			saveCombatOptions();
		},false);
		document.getElementById('pbcombat_guarlvl').addEventListener('change',function(){
			CombatOptions.guardian[side][1] = parseInt(document.getElementById('pbcombat_guarlvl').value);
			saveCombatOptions();
		},false);
		document.getElementById('pbcombatresearchsave').addEventListener('click',t.c_ratio,false);
	},
	
	e_saveresearch : function(checkboxId, optionName, side){
		var t = Tabs.Combat;
		var checkbox = document.getElementById(checkboxId);
		if (CombatOptions.research[side][optionName])
		  checkbox.value = CombatOptions.research[side][optionName];
		checkbox.addEventListener ('change', new eventToggle(checkboxId, optionName, side).handler, false);
		function eventToggle (checkboxId, optionName, side){
		  this.handler = handler;
		  var optName = optionName;
		  function handler(event){
			CombatOptions.research[side][optionName] = parseInt(this.value);
			saveCombatOptions();
		  }
		}
	},
	
	c_ratio : function (){
		var t = Tabs.Combat;
		for(var k in CombatOptions.ratio[0]){
			var attack = parseFloat(t.c_attack(k,0));
			for(var tr in unsafeWindow.unitcost){
				var defense = parseFloat(t.c_defense(tr,1));
				var life = parseFloat(t.c_life(tr,1));
				var ratio = ((life+defense)/attack);
				CombatOptions.ratio[0][k][tr] = ratio.toFixed(20);
			}
		}
		for(var k in CombatOptions.ratio[1]){
			var attack = parseFloat(t.c_attack(k,1));
			for(var tr in unsafeWindow.unitcost){
				var defense = parseFloat(t.c_defense(tr,0));
				var life = parseFloat(t.c_life(tr,0));
				var ratio = ((life+defense)/attack);
				CombatOptions.ratio[1][k][tr] = ratio.toFixed(20);
			}
		}
	},
	
	e_calculate: function(){
		var t = Tabs.Combat;
		t.round = 0;
		t.total[0] = 0;
		t.total[1] = 0;
		t.range[0] = 0
		t.range[1] = 0;
		t.speed[0] = 0;
		t.speed[1] = 0;
		for(var tr in unsafeWindow.unitcost){
			var name = unsafeWindow.unitcost[tr][0];
			t.troops[0][tr] = parseIntNan(document.getElementById('pbcombatd_'+tr).value);
			t.troops[1][tr] = parseIntNan(document.getElementById('pbcombata_'+tr).value);
			t.total[0] += t.troops[0][tr];
			t.total[1] += t.troops[1][tr];
			t.lost[0][tr] = 0;
			t.lost[1][tr] = 0;
			t.active[0][tr] = 0;
			t.active[1][tr] = 0;
			if(t.troops[0][tr]>0 && parseInt(t.stats[tr][4]) > t.range[0]) t.range[0] = parseInt(t.stats[tr][4]);
			if(t.troops[1][tr]>0 && parseInt(t.stats[tr][4]) > t.range[1]) t.range[1] = parseInt(t.stats[tr][4]);
			if(t.troops[0][tr]>0 && parseInt(t.stats[tr][3]) > t.speed[0]) t.speed[0] = parseInt(t.stats[tr][3]);
			if(t.troops[1][tr]>0 && parseInt(t.stats[tr][3]) > t.speed[1]) t.speed[1] = parseInt(t.stats[tr][3]);
		}
		if(t.range[1]>t.range[0]){
			t.start = 1; //Attacker starts first if range is longer than defender
			t.range[2] = t.range[1];
		} else {
			t.start = 0;
			t.range[2] = t.range[0];
		}
		for(var tr in unsafeWindow.unitcost){
			if(t.troops[0][tr]>0)
				t.distance[0][tr] = parseInt(t.range[2]/((t.speed[1]/t.speed[0])+1));
			else
				t.distance[0][tr] = 0;
			if(t.troops[1][tr]>0)
				t.distance[1][tr] = parseInt(t.range[2]/((t.speed[0]/t.speed[1])+1));
			else
				t.distance[1][tr] = 0;
		}
		t.c_rounds();
	},
	
	c_rounds: function(){
		var t = Tabs.Combat;
		if(t.total[0]<1 || t.total[1]<1 || t.round>99){
			t.print();
			return;
		}
		t.round++;
		if(t.round>1){
			for(var tr in t.distance[0]){
				t.distance[0][tr] -= t.stats[tr][3];
				if(t.distance[0][tr] < 1) t.distance[0][tr] = 0;
			}
			for(var tr in t.distance[1]){
				t.distance[1][tr] -= t.stats[tr][3];
				if(t.distance[1][tr] < 1) t.distance[1][tr] = 0;
			}
		}
		t.c_remainder();
	},
	
	c_remainder: function(){  //  Life, Attack, Defense, Speed, Range, Load
		var t = Tabs.Combat;
		for(var tr in t.troops[0]){ //Only troops in range are counted
			if(t.stats[tr][4] >= (t.distance[0][tr]))
				t.active[0][tr] = t.troops[0][tr];
		}
		for(var tr in t.troops[1]){
			if(t.stats[tr][4] >= (t.distance[1][tr]))
				t.active[1][tr] = t.troops[1][tr];
		}
		//Defender
		for(var tr in t.active[0]){
			if(t.active[0][tr] < 1) continue;
			var range = t.stats[tr][4] - t.distance[0][tr];
			var count = 0;
			var type = 0;
			if(tr == 'unt6' || tr == 'unt10' || tr == 'unt12') type = 1;
			while(t.active[0][tr] > 0 && count<t.priority[type].length){
				var trr = 'unt'+t.priority[type][count];
				if((t.troops[1][trr] < 1) || (range < t.distance[1][trr])){
					count++;
					continue;
				}
				if(parseInt(CombatOptions.ratio[0][tr][trr]) < 1){
					if(t.active[0][tr] > t.troops[1][trr]){
						t.active[0][tr] -= t.troops[1][trr];
						t.lost[1][trr] += t.troops[1][trr];
						t.total[1] -= t.troops[1][trr];
						t.troops[1][trr] = 0;
					}else {
						t.lost[1][trr] += t.active[0][tr];
						t.total[1] -= t.active[0][tr];
						t.troops[1][trr] -= t.active[0][tr];
						t.active[0][tr] = 0;
					}
				} else {
					var killed = parseInt(t.active[0][tr]/CombatOptions.ratio[0][tr][trr]);
					if(killed > t.troops[1][trr]){
						t.lost[1][trr] += t.troops[1][trr];
						t.total[1] -= t.troops[1][trr];
						t.active[0][tr] -= parseInt(CombatOptions.ratio[0][tr][trr]* t.troops[1][trr]);
						t.troops[1][trr] = 0;
					} else {
						t.lost[1][trr] += killed;
						t.total[1] -= killed;
						t.troops[1][trr] -= killed;
						t.active[0][tr] = 0;
					}
				}
				count++;
			}
		}
		
		//Attacker
		for(var tr in t.active[1]){
			if(t.active[1][tr] < 1) continue;
			var range = t.stats[tr][4] - t.distance[1][tr];
			var count = 0;
			var type = 0;
			if(tr == 'unt6' || tr == 'unt10' || tr == 'unt12') type = 1;
			while(t.active[1][tr] > 0 && count<t.priority[type].length){
				var trr = 'unt'+t.priority[type][count];
				if((t.troops[0][trr] < 1) || (range < t.distance[0][trr])){
					count++;
					continue;
				}
				if(parseInt(CombatOptions.ratio[1][tr][trr]) < 1){
					if(t.active[1][tr] > t.troops[0][trr]){
						t.active[1][tr] -= t.troops[0][trr];
						t.lost[0][trr] += t.troops[0][trr];
						t.total[0] -= t.troops[0][trr];
						t.troops[0][trr] = 0;
					}else {
						t.lost[0][trr] += t.active[1][tr];
						t.total[0] -= t.active[1][tr];
						t.troops[0][trr] -= t.active[1][tr];
						t.active[1][tr] = 0;
					}
				} else {
					var killed = parseInt(t.active[1][tr]/CombatOptions.ratio[1][tr][trr]);
					if(killed > t.troops[0][trr]){
						t.lost[0][trr] += t.troops[0][trr];
						t.total[0] -= t.troops[0][trr];
						t.active[1][tr] -= parseInt(CombatOptions.ratio[1][tr][trr]* t.troops[0][trr]);
						t.troops[0][trr] = 0;
					} else {
						t.lost[0][trr] += killed;
						t.total[0] -= killed;
						t.troops[0][trr] -= killed;
						t.active[1][tr] = 0;
					}
				}
				count++;
			}
		}
		t.c_rounds();
	},
	
	c_attack: function(tr,side){
		var t = Tabs.Combat;
		var att = t.stats[tr][1];
		if(CombatOptions.research[side].tch8) //Add Poison Edge
			att += t.stats[tr][1]*parseFloat(CombatOptions.research[side].tch8*5/100);
		if(CombatOptions.guardian[side][0] == 'ore' && side == 1){ //Add Guardian Boost
			var boost = 0;
			switch(CombatOptions.guardian[side][1]){
				case 1:
					boost = 0.02;
					break;
				case 2:
					boost = 0.04;
					break;
				case 3:
					boost = 0.06;
					break;
				case 4:
					boost = 0.08;
					break;
				case 5:
					boost = 0.12;
					break;
				case 6:
					boost = 0.16;
					break;
				case 7:
					boost = 0.20;
					break;
				case 8:
					boost = 0.26;
					break;
				case 9:
					boost = 0.32;
					break;
				case 10:
					boost = 0.40;
					break;
				default:
					boost = 0;
			}
			att += t.stats[tr][1]*boost;
		}
		if(CombatOptions.knt[side]) //Add knight boost
			att += t.stats[tr][1]*parseFloat((CombatOptions.knt[side]/2)/100);
		return att;
	},
	c_defense: function(tr,side){
		var t = Tabs.Combat;
		var def = t.stats[tr][2];
		if(CombatOptions.research[side].tch9) //Add Metal Alloy
			def += t.stats[tr][2]*parseFloat(CombatOptions.research[side].tch9*5/100);
		if(CombatOptions.knt[side]) //Add knight boost
			def += t.stats[tr][2]*parseFloat((CombatOptions.knt[side]/2)/100);
		return def;
	},
	c_life: function(tr,side){
		var t = Tabs.Combat;
		var life = t.stats[tr][0];
		if(CombatOptions.research[side].tch15) //Add Healing Potions
			life += t.stats[tr][0]*parseFloat(CombatOptions.research[side].tch15*5/100);
		if(CombatOptions.guardian[side][0] == 'wood' && side == 0){ //Add Guardian Boost
			var boost = 0;
			switch(CombatOptions.guardian[side][1]){
				case 1:
					boost = 0.01;
					break;
				case 2:
					boost = 0.02;
					break;
				case 3:
					boost = 0.03;
					break;
				case 4:
					boost = 0.04;
					break;
				case 5:
					boost = 0.06;
					break;
				case 6:
					boost = 0.08;
					break;
				case 7:
					boost = 0.10;
					break;
				case 8:
					boost = 0.13;
					break;
				case 9:
					boost = 0.16;
					break;
				case 10:
					boost = 0.20;
					break;
				default:
					boost = 0;
			}
			life += t.stats[tr][0]*boost;
		}
		return life;
	},
	
	print: function (){
		var t = Tabs.Combat;
		var m = '<div class=pbStat>results</div><table><TR><TD colspan=3><b>Attacker</b></td><TD colspan=3><b>defender</b></td><TD>round  :'+t.round+'</td></TR>';
		for(var tr in unsafeWindow.unitcost){
			var name = unsafeWindow.unitcost[tr][0];
			m+='<tr><td>'+name+' :</td><td>'+ t.troops[1][tr] +'</td><td><span class=boldRed>'+ t.lost[1][tr] +'</span></td><td>'+name+' :</td><td>'+ t.troops[0][tr] +'</td><td><span class=boldRed>'+ t.lost[0][tr] +'</span></td></tr>';
		}
		m+='</table>';
		document.getElementById('pbcombat_rslt').innerHTML = m;
	},
	show: function(){
	
	},
	
	hide: function(){
	
	},
}

/************************************** END Tabs   ***************************************/


/************  LIB classes/functions .... **************/

function distance (d, f, c, e) {
  var a = 750;
  var g = a / 2;
  var b = Math.abs(c - d);
  if (b > g)
    b = a - b;
  var h = Math.abs(e - f);
  if (h > g)
    h = a - h;
  return Math.round(100 * Math.sqrt(b * b + h * h)) / 100;
};

var MapDistanceFix = {
  popSlotsFunc : null,
  init : function (){
    var t = MapDistanceFix;
    t.popSlotsFunc = new CalterUwFunc ('MapObject.prototype.populateSlots', [['this.distance', 'fixMapDistance_hook']]);
    if (t.popSlotsFunc.isAvailable()){
      unsafeWindow.fixMapDistance_hook = t.fixMapDistance_hook;
      if (Options.fixMapDistance)
        t.enable (true);

    }
  },
  fixMapDistance_hook : function (cityX, cityY, tileX, tileY){
    var city = Cities.byID[unsafeWindow.currentcityid];
    return distance (city.x, city.y, tileX, tileY);
  },
  enable : function (tf){
    var t = MapDistanceFix;
    t.popSlotsFunc.setEnable (tf);
  },
  isAvailable : function (){
    var t = MapDistanceFix;
    return false;
  },
}

    

var GMTclock = {
  span : null,
  timer : null,
  
  init : function (){
    this.span = document.createElement ('span');
    this.span.style.fontWeight = 'bold';
    document.getElementById('kochead_time').parentNode.appendChild (this.span);
    this.setEnable (Options.gmtClock);
  },

  setEnable : function (tf){
    var t = GMTclock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
    
  everySecond : function (){
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*60000));
    GMTclock.span.innerHTML = ' &nbsp; ('+ now.toLocaleFormat('%H:%M:%S') +' GMT)';
  },
}

function getResourceProduction (cityId){
  var ret = [0,0,0,0,0];
  var now = unixTime ();
  
  var wilds = [0, 0, 0, 0, 0];
  var w = Seed.wilderness["city" + cityId];
  for (var k in w){
    var type = parseInt(w[k].tileType);

    if (type==10 || type==11)
	      wilds[1] += parseInt(w[k].tileLevel);
	    else 
	      wilds[type/10] += parseInt(w[k].tileLevel);
  }  
  knight = 0;       
  var s = Seed.knights["city" + cityId];
  if (s) {
    s = s["knt" + Seed.leaders["city" + cityId].resourcefulnessKnightId];
    if (s){
      var knight = parseInt(s.resourcefulness);
      if (s.resourcefulnessBoostExpireUnixtime > now)
        knight *= 1.25;
    }
  }
  var workerFactor = 1;
  var c = parseInt(Seed.citystats["city" + cityId]["pop"][0]);  // Current  population
  var w = parseInt(Seed.citystats["city" + cityId]["pop"][3]);  // Labor force
  if (w > c)
    workerFactor = c / w;
  
  for (var i=1; i<5; i++){
    var usage = Seed.resources["city" + cityId]["rec" + i];
    var items = 0;
    if (parseInt(Seed.playerEffects["r" + i + "BstExp"]) > now) {
      items = 0.25;
    }
    var tech = Seed.tech["tch" + i];
    ret[i] = parseInt((usage[2] * (1 + tech/10 + knight/100 + items + 0.05 * wilds[i]) * workerFactor + 100));
  }
  return ret;  
}

/************************ Gold Collector ************************/
var CollectGold = {
  timer : null,
  lastCollect : {},
      
  init : function (){
    var t = CollectGold;
    for (var c=0; c<Cities.numCities; c++)
      t.lastCollect['c'+ Cities.cities[c].id] = 0;
    if (Options.pbGoldEnable)
      t.setEnable (true);
  },
  
  setEnable : function (tf){
    var t = CollectGold;
    clearTimeout (t.timer);
    if (tf)
      t.tick();
  },

  colCityName : null,
  colHappy : 0,  
  tick : function (){
    var t = CollectGold;
    for (var c=0; c<Cities.numCities; c++){
      var city = Cities.cities[c];
      var happy = Seed.citystats['city'+ city.id].pop[2];
      var since = unixTime() - t.lastCollect['c'+city.id];
      if (happy>=Options.pbGoldHappy && since>15*60){
        t.lastCollect['c'+city.id] = unixTime();
        t.colCityName = city.name;
        t.colHappy = happy;
        t.ajaxCollectGold (city, t.e_ajaxDone);
        break;
      }
    }
    t.timer = setTimeout (t.tick, 15000);    
  },

  e_ajaxDone : function (rslt){
    var t = CollectGold;
    if (rslt.ok)
      actionLog ('Collected '+ rslt.goldGained +' gold for '+ t.colCityName +' (happiness was '+ t.colHappy +')');
    else
      actionLog ('Error collecting gold for '+ t.colCityName +': <SPAN class=boldRed>'+ rslt.errorMsg +'</span>');
  },
  
  ajaxCollectGold : function (city, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = city.id;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/levyGold.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (notify)  
          notify (rslt);
      },
      onFailure: function (rslt) {
        if (notify)  
          notify (rslt);
      }
    });
  },
}

/************************ Refresh Every X minutes ************************/
var RefreshEvery  = {
  timer : null,
  PaintTimer : null,
  NextRefresh : 0,
  content : null,
  Original : null,
  alliance: null,
  
  init : function (){
    var t = RefreshEvery;
    t.Original = ById('comm_tabs').innerHTML;
    t.alliance = getMyAlliance()[1];
    if (t.alliance.length >19) t.alliance = t.alliance.substr(0,19);
      if (Options.pbEveryMins < 1)
        Options.pbEveryMins = 1;
      RefreshEvery.setEnable (Options.pbEveryEnable);
  },

  creatediv : function(){
		var t = RefreshEvery;
		t.target = ById('comm_tabs');
		if(t.target == null){
			setTimeout(t.creatediv, 2000);
			return;
		}
		t.box = document.createElement('div');
		t.target.appendChild(t.box);
	},

  setEnable : function (tf){
    var t = RefreshEvery;
    clearTimeout (t.timer);
    if (tf) {
      t.NextRefresh = unixTime() + (Options.pbEveryMins*60); 
      t.timer = setTimeout (t.Paint, 1000);
    }else {
        clearTimeout (t.PaintTimer);
        t.content = t.Original;
        t.content += '<DIV><BR><FONT color=white><B>&nbsp;&nbsp;&nbsp;&nbsp;'+ t.alliance + ' (' + GetServerId() +')</b></font>';
        ById('comm_tabs').innerHTML = t.content;
    }
  },

  doit : function (){
    actionLog ('Refreshing ('+ Options.pbEveryMins +' minutes expired)');
    reloadKOC();
  },

  setTimer : function (){
    var t = RefreshEvery;
    clearTimeout (t.timer);
    if (Options.pbEveryMins < 1) Options.pbEveryMins = 1;
    RefreshEvery.setEnable (Options.pbEveryEnable);
  },

  Paint : function(){
     if (Options.pbEveryEnable){
     var t = RefreshEvery;
     if(t.timer == null) return;
     now = unixTime();
     var Left = parseInt(t.NextRefresh - now);
     if ( Left < 0) {
       Left = 0;
       t.doit();
      }
     t.content = t.Original;
     t.content += '<DIV><BR><FONT color=white><B>&nbsp;&nbsp;&nbsp;&nbsp;'+ t.alliance+ ' (' + GetServerId() +')</b></font>';
     if ( Left < 60) t.content += '<BR><blink><B>Time to refresh: </b></blink><span class=boldRed>'+ timestr(Left) +'</span></div>';
     else t.content += '<BR><B>Time to refresh: </b><span class=boldGreen>'+ timestr(Left) +'</span></div>';
     ById('comm_tabs').innerHTML = t.content;
     t.Timer = setTimeout (t.Paint, 1000);
     }
  },
}

/************************ Fairie Killer ************************/
var FairieKiller  = {
  saveFunc : null,
  init : function (tf){
    FairieKiller.saveFunc = unsafeWindow.Modal.showModalUEP;
    FairieKiller.setEnable (tf);
  },
  setEnable : function (tf){
    if (tf)
      unsafeWindow.Modal.showModalUEP = eval ('function FairieKiller (a,b,c) {actionLog ("Blocked Faire popup");}');
    else
      unsafeWindow.Modal.showModalUEP = FairieKiller.saveFunc;
  },
}

function KOCnotFound(secs){
  var div;
  var countdownTimer = null;
  var endSecs = (new Date().getTime()/1000) + secs;
  div = document.createElement('div');
  div.innerHTML = '<DIV style="font-size:18px; background-color:#a00; color:#fff"><CENTER><BR>KOC KOC PowerKoc detected that is not loaded<BR>\
      refreshing in <SPAN id=pbwdsecs></span><BR><INPUT id=pbwdcan type=submit value="Cancel Refresh"><BR><BR></div>';
  document.body.insertBefore (div, document.body.firstChild);
  document.getElementById('pbwdcan').addEventListener('click', cancel, false);
  countdown();
      
  function countdown (){
    var secsLeft = endSecs - (new Date().getTime()/1000);
    document.getElementById('pbwdsecs').innerHTML = timestr(secsLeft);
    if (secsLeft < 0)
      reloadKOC();
    countdownTimer = setTimeout (countdown, 1000);
  }
  function cancel (){
    clearTimeout (countdownTimer);
    document.body.removeChild (div);
  }
}

var WideScreen = {
  chatIsRight : false,
  rail : null,
  
  init : function (){
    t = WideScreen;
    if (GlobalOptions.pbWideScreen){
      t.rail = searchDOM (document.getElementById('mod_maparea'), 'node.className=="maparea_rrail"', 10);
      GM_addStyle ('.modalCurtain {width:760px !important} .mod_comm_mmb{z-index:0 !important}');  
      try {
        document.getElementById('progressBar').parentNode.removeChild(document.getElementById('progressBar'));
        document.getElementById('crossPromoBarContainer').parentNode.removeChild(document.getElementById('crossPromoBarContainer'));
      } catch (e) {
      }
    }
  },
        
  setChatOnRight : function (tf){
    t = WideScreen;
    if (tf == t.chatIsRight || !GlobalOptions.pbWideScreen)
      return;
    if (tf){
      var chat = document.getElementById('kocmain_bottom').childNodes[1];
      if (!chat || chat.className!='mod_comm')
        setTimeout (function (){t.setChatOnRight(tf)}, 1000);
      chat.style.top = '-637px';
      chat.style.left = '760px';
      chat.style.height = '785px';
      chat.style.background = 'url("'+ CHAT_BG_IMAGE +'")';
      document.getElementById('mod_comm_list1').style.height = '562px'; // 562
      document.getElementById('mod_comm_list2').style.height = '562px';
    } else {
      var chat = document.getElementById('kocmain_bottom').childNodes[1];
      chat.style.top = '0px';
      chat.style.left = '0px';
      chat.style.height = '';
      chat.style.background = '';
      document.getElementById('mod_comm_list1').style.height = '287px';
      document.getElementById('mod_comm_list2').style.height = '287px';
    }
    t.chatIsRight = tf;
  },
  
  useWideMap : function (tf) {
  	t = WideScreen;
  	if (tf == t.useWideMap || !GlobalOptions.pbWideScreen)
  		return;
  	if (tf){
      t.rail.style.display = 'none';
      document.getElementById('mapwindow').style.height = "436px";
      document.getElementById('mapwindow').style.width = "1220px";
      document.getElementById('mapwindow').style.zIndex = "50";
  	} else {
      t.rail.style.display = 'block';
      document.getElementById('mapwindow').style.height = "439px";
      document.getElementById('mapwindow').style.width = "760px";
      document.getElementById('mapwindow').style.zIndex = "";
  	}
  },
}



/*******************   KOC Map interface ****************/
// 0:bog, 10:grassland, 11:lake, 20:woods, 30:hills, 40:mountain, 50:plain, 51:city / barb, 53:misted city
function CMapAjax (){
  this.normalize = normalize;  
  this.request = request;

  function request (left, top, width, notify){    
    var left = parseInt(left / 5) * 5;
    var top = parseInt(top / 5) * 5;
    var width = parseInt((width+4) / 5) * 5;
    
    var blockString = generateBlockList(left, top, width);
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.blocks = blockString;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fetchMapTiles.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify(left, top, width, rslt);
      },
      onFailure: function (rslt) {
        notify(left, top, width, rslt);
      }
    });
    function generateBlockList (left, top, width) {
      var width5 = parseInt(width / 5);
      var bl = [];
      for (x=0; x<width5; x++){
        var xx = left + (x*5);
        if (xx > 745)
          xx -= 750;
        for (y=0; y<width5; y++){
          var yy = top + (y*5);
          if (yy > 745)
            yy -= 750;
          bl.push ('bl_'+ xx +'_bt_'+ yy);
        }
      }
      return bl.join(",");
    }
  }
 
  function normalize  (x){
    if ( x >= 750)
      x -= 750;
    else if (x < 0)
      x += 750;
    return parseInt (x/5) * 5;
  }
}

var WarnZeroAttack = {
  modalAttackFunc : null,  
  
  init : function (){
    var t = WarnZeroAttack;
    t.modalAttackFunc = new CalterUwFunc ('modal_attack', [['modal_attack_check()', 'modalAttack_hook()']]);
    uW.modalAttack_hook = t.hook;
    t.modalAttackFunc.setEnable(Options.fixWarnZero);
  },
   
  setEnable : function (tf){
    var t = WarnZeroAttack;
    t.modalAttackFunc.setEnable (tf);
  },
  
  isAvailable : function (){
    var t = WarnZeroAttack;
    return t.modalAttackFunc.isAvailable();
  },
    
  hook : function (){
    var t = WarnZeroAttack;
    if (parseIntZero(document.getElementById('modal_attack_target_coords_x').value) == 0
    && parseIntZero(document.getElementById('modal_attack_target_coords_y').value) == 0){
      new CdialogCancelContinue ('<SPAN class=boldRed>You are about to march to location 0,0!</span>', null, uW.modal_attack_check, document.getElementById('modalInner1'));      
    } else {
      uW.modal_attack_check();
    }
  },
  
}



var tabManager = {
  tabList : {},           // {name, obj, div}
  currentTab : null,
  
  init : function (mainDiv){
    var t = tabManager;
    var sorter = [];
    for (k in Tabs){
      if (!Tabs[k].tabDisabled){  
        t.tabList[k] = {};
        t.tabList[k].name = k;
        t.tabList[k].obj = Tabs[k];
        if (Tabs[k].tabLabel != null)
          t.tabList[k].label = Tabs[k].tabLabel;
        else
          t.tabList[k].label = k;
        if (Tabs[k].tabOrder != null)
          sorter.push([Tabs[k].tabOrder, t.tabList[k]]);
        else
          sorter.push([1000, t.tabList[k]]);
        t.tabList[k].div = document.createElement('div');
      }
    }

 sorter.sort (function (a,b){return a[0]-b[0]});   // cambia la distribucion de las pestaas
    var m = '<TABLE cellspacing=3 class=ptMainTab><TR>';
    for (var i=0; i<sorter.length; i++) {
      m += '<TD align=center class=notSel id=pbtc'+ sorter[i][1].name +' ><A><SPAN>'+ sorter[i][1].label +'</span></a></td>';
      if (i==13 || i==27) m+='</tr><TR>';   // indica el numero de pestaas por fila
    }
    m+='</tr></table>';  
    mainPop.getMainTopDiv().innerHTML = m;
    t.currentTab = null;
    for (k in t.tabList) {
      if (t.tabList[k].name == Options.currentTab)
        t.currentTab =t.tabList[k] ;
      document.getElementById('pbtc'+ k).addEventListener('click', this.e_clickedTab, false);
      var div = t.tabList[k].div;
      div.style.display = 'none';
      div.style.height = '100%';
      div.style.maxWidth = '1300px';
      div.style.overflowX = 'auto';
      mainDiv.appendChild(div);
      try {
        t.tabList[k].obj.init(div);
      } catch (e){
        div.innerHTML = "INIT ERROR: "+ e;
      }
    }
    if (t.currentTab == null)
      t.currentTab = sorter[0][1];    
    t.setTabStyle (document.getElementById ('pbtc'+ t.currentTab.name), true);
    t.currentTab.div.style.display = 'block';
  },
  
  hideTab : function (){
    var t = tabManager;
    t.currentTab.obj.hide();
  },
  
  showTab : function (){
    var t = tabManager;
    t.currentTab.obj.show();
  },
    
  setTabStyle : function (e, selected){
    if (selected){
      e.className = 'sel';
    } else {
      e.className = 'notSel';
    }
  },
  
  e_clickedTab : function (e){
    var t = tabManager;
    var newTab = t.tabList[e.target.parentNode.parentNode.id.substring(4)];
    if (t.currentTab.name != newTab.name){
      t.setTabStyle (document.getElementById ('pbtc'+ t.currentTab.name), false);
      t.setTabStyle (document.getElementById ('pbtc'+ newTab.name), true);
      t.currentTab.obj.hide ();
      t.currentTab.div.style.display = 'none';
      t.currentTab = newTab;
      newTab.div.style.display = 'block';
      Options.currentTab = newTab.name;      
    }
    newTab.obj.show();
  },
}

function onUnload (){
  Options.pbWinPos = mainPop.getLocation();
  saveOptions();
  if (!ResetColors) saveColors();
}

function mouseMainTab (me){   // right-click on main button resets window location
  if (me.button == 2){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    mainPop.setLocation ({x: c.x+4, y: c.y+c.height});
  }
}

function eventHideShow (){
  if (mainPop.toggleHide(mainPop)){
    tabManager.showTab();
    Options.pbWinIsOpen = true;
  } else {
    tabManager.hideTab();
    Options.pbWinIsOpen = false;
  }
  saveOptions();
}

function hideMe (){
  mainPop.show (false);
  tabManager.hideTab();
  Options.pbWinIsOpen = false;
  saveOptions();
}

function showMe (){
  mainPop.show (true);
  tabManager.showTab();
  Options.pbWinIsOpen = true;
  saveOptions();
}

function addMyFunction (func){      // add function to run in our own scope
  unsafeWindow[func.name] = func;
}

function addUwFunction (func){      // add function to run in unsafeWindow's scope
  var scr = document.createElement('script');
	scr.innerHTML = func.toString();
	document.body.appendChild(scr);
}

function alterUwFunction (funcName, frArray){
  try {
    funcText = unsafeWindow[funcName].toString();
    rt = funcText.replace ('function '+funcName, 'function');
    for (i=0; i<frArray.length; i++){
      x = rt.replace(frArray[i][0], frArray[i][1]);
      if (x == rt)
        return false;
      rt = x;
    }
    js = funcName +' = '+ rt;
  	var scr=document.createElement('script');
  	scr.innerHTML=js;
  	document.body.appendChild(scr);
  	return true;
  } catch (err) {
    return false;
  }
}

function getResearchLevels () {
	for (var t=1; t < 17; t++) {
		if (t != 7) {
			researchLevels[t] = {};
			researchLevels[t].Id = t;
			researchLevels[t].Name = unsafeWindow.techcost['tch'+t][0].replace (/&#39;/img, '\'');
			researchLevels[t].Level = parseInt(Seed.tech['tch'+t]);
			researchLevels[t].NextLevelETA = 0;
		}
	}
	var q;
	var now = unixTime();
	for(var i=0; i<Cities.numCities; i++) { // each city
		var cityID = 'city'+ Cities.cities[i].id;
		q = Seed.queue_tch[cityID];
		if (q[0] != undefined)
			researchLevels[parseInt(q[0][0])].NextLevelETA = parseInt(q[0][3]) - now;
	}
}

function highlightLowBuilding (noBuildings, buildingLevel, buildingPrefix){
	var ret = '';
	if (buildingLevel<9)
		ret += '<SPAN class=boldRed>';
	if (noBuildings>1)
		ret += noBuildings + ' x ';
	if (buildingPrefix)
		ret += buildingPrefix;
	ret += 'lvl ' + buildingLevel;
	if (buildingLevel<9)
		ret += '</SPAN>';
	return ret;
}

function getAllCityBuildings (cityID){
	var b = Seed.buildings[cityID];
	var castleLevel = parseInt(b['pos0'][1]);
	var noFields = 10 + 3 * castleLevel;
	if (castleLevel==11)
	noFields = 40;
	sumCastle = highlightLowBuilding(1,castleLevel);
	sumCottage = '';
	sumTavern = '';
	sumKnightsHall = '';
	sumEmbassy = '';
	sumStorehouse = '';
	sumMarket = '';
	sumAlchemyLab = '';
	sumRallyPoint = '';
	sumBarracks = '';
	sumWatchTower = '';
	sumBlacksmith = '';
	sumWorkshop = '';
	sumStable = '';
	sumReliefStation = '';
	sumWall = '';
	sumGuardian = '';
	sumInside = 0;
	sumFarm = '';
	sumSawmill = '';
	sumQuarry = '';
	sumMine = '';
	sumOutside = 0;
	arrCottage = [];
	arrBarracks = [];
	arrFarm = [];
	arrSawmill = [];
	arrQuarry = [];
	arrMine = [];
	for (var i=1; i<12; i++){
		arrCottage[i]=0;
		arrBarracks[i]=0;
		arrFarm[i]=0;
		arrSawmill[i]=0;
		arrQuarry[i]=0;
		arrMine[i]=0;
	}
	for (var i=1; i<33; i++){
		if (b['pos'+i]) {
			bname = b['pos'+i][0];
			blvl = b['pos'+i][1];
			if (bname==5)
				arrCottage[blvl]++;
			if (bname==6)
				sumTavern = highlightLowBuilding(1,blvl);
			if (bname==7)
				sumKnightsHall = highlightLowBuilding(1,blvl);
			if (bname==8)
				sumEmbassy = highlightLowBuilding(1,blvl);
			if (bname==9)
				sumStorehouse = highlightLowBuilding(1,blvl);
			if (bname==10)
				sumMarket = highlightLowBuilding(1,blvl);
			if (bname==11)
				sumAlchemyLab = highlightLowBuilding(1,blvl);
			if (bname==12)
				sumRallyPoint = highlightLowBuilding(1,blvl);
			if (bname==13)
				arrBarracks[blvl]++;
			if (bname==14)
				sumWatchTower = highlightLowBuilding(1,blvl);
			if (bname==15)
				sumBlacksmith = highlightLowBuilding(1,blvl);
			if (bname==16)
				sumWorkshop = highlightLowBuilding(1,blvl);
			if (bname==17)
				sumStable = highlightLowBuilding(1,blvl);
			if (bname==18)
				sumReliefStation = highlightLowBuilding(1,blvl);
			if (bname==19)
				sumWall = highlightLowBuilding(1,blvl);
		}
		else
			sumInside += 1;
	}
	for (var i=100; i<100+noFields; i++){
		if (b['pos'+i]) {
			bname = b['pos'+i][0];
			blvl = b['pos'+i][1];
			if (bname==1) arrFarm[blvl]++;
			if (bname==2) arrSawmill[blvl]++;
			if (bname==3) arrQuarry[blvl]++;
			if (bname==4) arrMine[blvl]++;
		}
		else
			sumOutside += 1;
	}
	for (var i=1; i<12; i++){
		if(arrCottage[i]>0)
			sumCottage+=highlightLowBuilding(arrCottage[i],i)+'<BR>';
		if(arrBarracks[i]>0)
			sumBarracks+=highlightLowBuilding(arrBarracks[i],i)+'<BR>';
		if(arrFarm[i]>0)
			sumFarm+=highlightLowBuilding(arrFarm[i],i)+'<BR>';
		if(arrSawmill[i]>0)
			sumSawmill+=highlightLowBuilding(arrSawmill[i],i)+'<BR>';
		if(arrQuarry[i]>0)
			sumQuarry+=highlightLowBuilding(arrQuarry[i],i)+'<BR>';
		if(arrMine[i]>0)
			sumMine+=highlightLowBuilding(arrMine[i],i)+'<BR>';
	}
	if (sumCottage.length>0)
		sumCottage=sumCottage.substring (0,sumCottage.length-4);
	if (sumBarracks.length>0)
		sumBarracks=sumBarracks.substring (0,sumBarracks.length-4);
	if (sumFarm.length>0)
		sumFarm=sumFarm.substring (0,sumFarm.length-4);
	if (sumSawmill.length>0)
		sumSawmill=sumSawmill.substring (0,sumSawmill.length-4);
	if (sumQuarry.length>0)
		sumQuarry=sumQuarry.substring (0,sumQuarry.length-4);
	if (sumMine.length>0)
		sumMine=sumMine.substring (0,sumMine.length-4);
	if (b['pos500']) {
		blvl = b['pos500'][1];
		bname = unsafeWindow.buildingcost['bdg' + b['pos500'][0]][0];
		bname = bname.substr(0,bname.length-8);
		sumGuardian = highlightLowBuilding(1,blvl,bname);
	}
	else
		sumInside += 1;
	if (sumInside==0)
		sumInside='Full';
	else
		sumInside='<SPAN class=boldRed>'+sumInside+' empty</SPAN>';
	if (sumOutside==0)
		sumOutside='Full';
	else
		sumOutside='<SPAN class=boldRed>'+sumOutside+' empty</SPAN>';
}

function getBuildingLevels (cityID){
	var b = Seed.buildings[cityID];
	city.levelTavern = 0;
	city.levelKnightsHall = 0;
	city.levelEmbassy = 0;
	city.levelStorehouse = 0;
	city.levelMarket = 0;
	city.levelAlchemyLab = 0;
	city.levelRallyPoint = 0;
	city.slotsRallyPoint = 0;
	city.troopsRallyPoint = 0;
	city.numBarracks = 0;
	city.maxBarracks = 0;
	city.totLevelsBarracks = 0;
	city.levelWatchTower = 0;
	city.levelBlacksmith = 0;
	city.levelWorkshop = 0;
	city.levelStable = 0;
	city.levelReliefStation = 0;
	city.levelWall = 0;
	for (var j=1; j<33; j++){
		if (b['pos'+j]) {
			var bname = parseInt(b['pos'+j][0]);
			var blvl = parseInt(b['pos'+j][1]);
			if (bname==6)
				city.levelTavern = blvl;
			else if (bname==7)
				city.levelKnightsHall = blvl;
			else if (bname==8)
				city.levelEmbassy = blvl;
			else if (bname==9)
				city.levelStorehouse = blvl;
			else if (bname==10)
				city.levelMarket = blvl;
			else if (bname==11)
				city.levelAlchemyLab = blvl;
			if (bname==12) {
				city.levelRallyPoint = blvl;
				if (blvl < 11) {
					city.slotsRallyPoint = blvl;
					city.troopsRallyPoint = blvl * 10000;
				} else if (blvl == 11) {
					city.slotsRallyPoint = 11;
					city.troopsRallyPoint = 150000;
				} else {
					city.slotsRallyPoint = 11;
					city.troopsRallyPoint = 200000;
				}
			} else if (bname==13) {
				city.numBarracks++;
				city.totLevelsBarracks += parseInt(blvl);
				if (blvl>city.maxBarracks)
					city.maxBarracks=blvl;
			} else if (bname==14)
				city.levelWatchTower = blvl;
			else if (bname==15)
				city.levelBlacksmith = blvl;
			else if (bname==16)
				city.levelWorkshop = blvl;
			else if (bname==17)
				city.levelStable = blvl;
			else if (bname==18)
				city.levelReliefStation = blvl;
			else if (bname==19)
				city.levelWall = blvl;
		}
	}
}

function getRaidTroops (cityID){
	city.raidMarch = {};
	for (var r in Seed.queue_atkp[cityID]){
		march = Seed.queue_atkp[cityID][r];
		if (typeof (march) == 'object'){
			if (march.botMarchStatus != undefined) {
				city.raidMarch[r] = [];
				for (ii=0; ii<13; ii++)
					city.raidMarch[r][ii] = parseInt (march['unit'+ ii +'Count']);
			}
		}
	}
}

function getTroopDefTrainEstimates (cityID,cityId){
	var b = Seed.buildings[cityID];
	city.numBarracks = 0;
	city.maxBarracks = 0;
	city.totLevelsBarracks = 0;
	city.blacksmithLevel = 0;
	city.stableLevel = 0;
	city.workshopLevel = 0;
	city.wallLevel = 0;
	for (var j=1; j<33; j++){
		if (b['pos'+j]) {
			var bname = parseIntNan(b['pos'+j][0]);
			var blvl = parseIntNan(b['pos'+j][1]);
			if (bname==13) {
				city.numBarracks++;
				city.totLevelsBarracks += parseInt(blvl);
				if (blvl>city.maxBarracks) city.maxBarracks=blvl;
			}
			if (bname==16)
				city.blacksmithLevel = blvl;
			if (bname==15)
				city.workshopLevel = blvl;
			if (bname==17)
				city.stableLevel = blvl;
			if (bname==19)
				city.wallLevel = blvl;
		}
	}

	var now = unixTime();
	city.marshallCombatScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].combatKnightId];
		if (s){
			city.marshallCombatScore = s.combat;
			if (s.combatBoostExpireUnixtime > now)
				city.marshallCombatScore *= 1.25;
		}
	}
	city.foremanBasePoliticsScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].politicsKnightId];
		if (s) {
			city.foremanBasePoliticsScore = s.politics;
	 	     if (s.politicsBoostExpireUnixtime > now)
				city.foremanBasePoliticsScore *= 1.25;
	 }
	}

	city.loggingLevel = parseInt(Seed.tech["tch2"]);
	city.geometryLevel = parseInt(Seed.tech["tch5"]);
	city.eagleEyesLevel = parseInt(Seed.tech["tch6"]);
	city.poisonedEdgeLevel = parseInt(Seed.tech["tch8"]);
	city.metalAlloysLevel = parseInt(Seed.tech["tch9"]);
	city.featherweightPowderLevel = parseInt(Seed.tech["tch10"]);
	city.alloyHorseshoesLevel = parseInt(Seed.tech["tch12"]);
	city.fletchingLevel = parseInt(Seed.tech["tch13"]);
	city.giantsStrengthLevel = parseInt(Seed.tech["tch16"]);
	var bm = city.numBarracks + 0.1 * (city.totLevelsBarracks - city.numBarracks);
	var mf = city.marshallCombatScore/200;
	var gf = city.geometryLevel/10;
	var sf = city.stableLevel/10;
	var wf = city.blacksmithLevel/10;
	var isf = bm * (1+mf+gf);
	var csf = bm * (1+mf+gf+sf);
	var ssf = bm * (1+mf+gf+sf+wf);
	var pf = city.foremanBasePoliticsScore/200;
	var gsf = city.giantsStrengthLevel/10;
	var dsf = 1+pf+gsf;
	var h=EffetTronePrc(77).percent;
	var boost=(1+(h/100));
        if(uW.cm.WorldSettings.isOn("GUARDIAN_MARCH_EFFECT")){
        var SPD={0:0,1:1,2:1,3:2,4:2,5:3,6:3,7:4,8:5,9:7,10:10};
          var b=0,y=false,v=false,w=0;
          var mm=Seed.guardian;
          for (var ii in mm) {
           var ww = mm[ii];
            if (ww.cityId==cityId) {
            if (ww.type== "stone") y=true;
            if (ww.guardianCount==4) v=true;
            var level=0;
            if (ww.cityGuardianLevels.stone!=undefined) level = ww.cityGuardianLevels.stone;
            w = SPD[level] / 100;
            var bx = 0;
                if (y && v) {
                    bx = 1.5;
                }
                if (y && !v) {
                    bx = 1;
                }
                if (!y && v) {
                    bx = 0.5;
                }
                if (!y && !v) {
                    bx = 0;
                }
                b = w * bx;
                
                
                boost=boost*(1+b);
           }     
         
         }
       }

	city.Troop1Time = ((city.maxBarracks > 0)?((parseInt(unsafeWindow.unitcost["unt1"][7])/boost)/isf):0);
	city.Troop2Time = ((city.maxBarracks > 0)?((parseInt(unsafeWindow.unitcost["unt2"][7])/boost)/isf):0);
	city.Troop3Time = ((city.maxBarracks > 1 && city.eagleEyesLevel > 0)?((parseInt(unsafeWindow.unitcost["unt3"][7])/boost)/isf):0);
	city.Troop4Time = ((city.maxBarracks > 1 && city.poisonedEdgeLevel > 0)?((parseInt(unsafeWindow.unitcost["unt4"][7])/boost)/isf):0);
	city.Troop5Time = ((city.maxBarracks > 2 && city.workshopLevel > 0 && city.metalAlloysLevel > 0)?((parseInt(unsafeWindow.unitcost["unt5"][7])/boost)/isf):0);
	city.Troop6Time = ((city.maxBarracks > 3 && city.fletchingLevel > 0)?((parseInt(unsafeWindow.unitcost["unt6"][7])/boost)/isf):0);
	city.Troop7Time = ((city.maxBarracks > 4 && city.stableLevel > 0 && city.alloyHorseshoesLevel > 0)?((parseInt(unsafeWindow.unitcost["unt7"][7])/boost)/csf):0);
	city.Troop8Time = ((city.maxBarracks > 6 && city.workshopLevel > 4 && city.stableLevel > 4 && city.alloyHorseshoesLevel > 4)?((parseInt(unsafeWindow.unitcost["unt8"][7])/boost)/csf):0);
	city.Troop9Time = ((city.maxBarracks > 5 && city.stableLevel > 0 && city.blacksmithLevel > 2 && city.featherweightPowderLevel > 0)?((parseInt(unsafeWindow.unitcost["unt9"][7])/boost)/ssf):0);
	city.Troop10Time = ((city.maxBarracks > 7 && city.stableLevel > 1 && city.blacksmithLevel > 4 && city.geometryLevel > 4 && city.fletchingLevel > 5)?((parseInt(unsafeWindow.unitcost["unt10"][7])/boost)/ssf):0);
	city.Troop11Time = ((city.maxBarracks > 8 && city.workshopLevel > 4 && city.stableLevel > 2 && city.blacksmithLevel > 6 && city.metalAlloysLevel > 7 && city.geometryLevel > 6)?((parseInt(unsafeWindow.unitcost["unt11"][7])/boost)/ssf):0);
	city.Troop12Time = ((city.maxBarracks > 9 && city.stableLevel > 1 && city.blacksmithLevel > 8 && city.geometryLevel > 9 && city.fletchingLevel > 9)?((parseInt(unsafeWindow.unitcost["unt12"][7])/boost)/ssf):0);

	city.Def53Time = ((city.wallLevel > 5 && city.blacksmithLevel > 5 && city.fletchingLevel > 4)?(180/dsf):0);
	city.Def55Time = ((city.wallLevel > 7 && city.blacksmithLevel > 7 && city.fletchingLevel > 6 && city.geometryLevel > 6)?(135/dsf):0);
	city.Def60Time = ((city.wallLevel > 3 && city.blacksmithLevel > 3 && city.poisonedEdgeLevel > 1)?(90/dsf):0);
	city.Def61Time = ((city.wallLevel > 0 && city.metalAlloysLevel > 0)?(30/dsf):0);
	city.Def62Time = ((city.wallLevel > 1 && city.blacksmithLevel > 1 && city.loggingLevel > 1)?(60/dsf):0);
}


function estimateTroopETA (dist, cityId, troopId, fhFlag) { // Need Relief Station Levels to estimate transport, reinf, or reassign times.
	var ret = {ETAstr: '', hsec: 0, fsec: 0};
	if (dist < 0.1 || parseInt(troopId) == 0) {
		ret.ETAstr = 'No ETA';
	} else {
		var baseSpeed = unsafeWindow.unitstats['unt'+troopId][3];
		var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
		var Speed;
		if (troopId > 6) { // HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20)
			var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
			Speed = baseSpeed * (1.0 + 0.1*mmLvl) * (1.0 + 0.05*hsLvl);
		} else {
			//FootSpeed = Base * (1 + MM/10)
			Speed = baseSpeed * (1 + 0.1*mmLvl);
		}
		var gSpeed = Speed / 6000; // Grid Speed (tiles/second) = Speed (100ths/min) / 6000
		ret.hsec = (30 + dist/gSpeed).toFixed(0);
		if (fhFlag == 'FH' || fhFlag == 'H') {
			ret.ETAstr = 'Attack ETA: <B>' + timestr(ret.hsec, 1) +'</B>';
		}
		if (cityId > -1) {
			var building = getCityBuilding (cityId, 18);
			if (building) {
				fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
				gSpeed = fSpeed/6000;
				ret.fsec = (30 + dist/gSpeed).toFixed(0);
				var friendTimestr = 'Friendly ETA: <B>' + timestr(ret.fsec, 1) +'</B>';
				if (fhFlag == 'F')
					ret.ETAstr = friendTimestr;
				else if (fhFlag == 'FH')
					ret.ETAstr = friendTimestr + ', ' + ret.ETAstr;
			}
		}
	}
	return ret;
}

function formatUnixTime (unixTimeString,format){
	var rtn = unsafeWindow.formatDateByUnixTime (unixTimeString);
	return rtn;
}

function officerId2String (oid){
  if (oid==null)
    return '';
 else if (oid==3) 	
    return uW.allianceOfficerTypeMapping[3];
  else if (oid==2)
    return uW.allianceOfficerTypeMapping[2];
  else if (oid==1)
    return uW.allianceOfficerTypeMapping[1];
     else if (oid==4)
    return uW.allianceOfficerTypeMapping[4];
  return '';
}

function officerId2FullString (oid){
	if (oid==null)
		return '';
	else if (oid==4)
		return 'MEMBER';
	else if (oid==3)
		return 'Officer';
	else if (oid==2)
		return 'Vice Chance';
	else if (oid==1)
		return 'Chancellor';
	return '';
}

// returns: 'neutral', 'friendly', ally, or 'hostile'
function getDiplomacy2 (aid) {
  if (Seed.allianceDiplomacies == null)
    return 'Neutral';
  if (Seed.allianceDiplomacies.friendly && Seed.allianceDiplomacies.friendly['a'+aid] != null)
    return 'friendly';
  if (Seed.allianceDiplomacies.hostile && Seed.allianceDiplomacies.hostile['a'+aid] != null)
    return 'Hostile';
  if(getMyAlliance()[0] == aid)
  return 'ally'; 
  return 'Neutral';
};

// returns {count, maxlevel}
function getCityBuilding (cityId, buildingId){
  var b = Seed.buildings['city'+cityId];
  var ret = {count:0, maxLevel:0};
  for (var i=1; i<33; i++){
    if (b['pos'+i] && b['pos'+i][0] == buildingId){
      ++ret.count;
      if (parseInt(b['pos'+i][1]) > ret.maxLevel)
        ret.maxLevel = parseInt(b['pos'+i][1]);
    }
  }
  return ret;
}

/************ DEBUG WIN *************/
var debugWin = {
	popDebug:			null,
	dbDefaultNot:	'tech,tutorial,items,quests,wilderness,wildDef,buildings,knights,allianceDiplomacies,appFriends,players',
	dbSelect:			{},
	sortSeed:			[],
	sortNonSeed:	[],

	doit: function (){
		var t = debugWin;

		function syncBoxes (){
			for (var i=0; i<t.sortSeed.length; i++){
				var name = t.sortSeed[i];
				var box = document.getElementById('dbpop_'+name);
				box.checked = t.dbSelect[name];
			}
		}
		function clickedAll (){
			for (var k in t.dbSelect)
				t.dbSelect[k] = true;
			syncBoxes();
		}
		function clickedNone (){
			for (var k in t.dbSelect)
				t.dbSelect[k] = false;
			syncBoxes();
		}
		function clickedDefaults (){
			for (k in t.dbSelect)
				t.dbSelect[k] = true;
			var not = t.dbDefaultNot.split(',');
			for (var i=0; i<not.length; i++)
				t.dbSelect[not[i]] = false;
			syncBoxes();
		}
		function clickedShow (){
			var resultsDiv = document.getElementById('idDebugResultsDiv')
			var s = '<PRE>';
			for (var i=0; i<t.sortSeed.length; i++){
				var name = t.sortSeed[i];
				var box = document.getElementById('dbpop_'+name);
				if (box.checked)
					s += name + " =\n" + inspect (Seed[name], 10, 1);
			}
			resultsDiv.innerHTML = s + '</PRE>';
		}

		function clickedShowNonSeed (){
			var resultsDiv = document.getElementById('idDebugResultsDiv');
			nsvalue = document.getElementById('dbnonseed').value;
			if (nsvalue != '') {
				val = unsafeWindow[nsvalue];
				valtype = typeof(val);
				resultsDiv.innerHTML = '<PRE>(' + valtype + ') ' + nsvalue + ((valtype == 'string')?(" = " + val):(" =\n" + inspect (val, 10, 1))) + '</PRE>';
			}
		}

		function clickedShowScripts (){
			var resultsDiv = document.getElementById('idDebugResultsDiv')
			var scripts = document.getElementsByTagName('script');
			var s = '';
			for (var i=0; i<scripts.length; i++)
				if (scripts[i].src!=null && scripts[i].src!='')
					s+='<A TARGET=_tab HREF="'+ scripts[i].src +'">'+ scripts[i].src +'</A><BR />';
			resultsDiv.innerHTML = s;
		}

		if (t.popDebug == null){
			t.popDebug = new CPopup ('db', 0, 45, 749, 900, true);
			t.popDebug.getTopDiv().innerHTML = '<DIV align=center><B>DEBUG</B></DIV>';
			var sl = 0;
			for (var k in Seed) {
				t.dbSelect[k] = true;
				t.sortSeed[sl] = k;
				sl++;
			}
			t.sortSeed.sort();
			sl = 0;
			for (var k in unsafeWindow) {
				kType = typeof(unsafeWindow[k]);
				if ((k.indexOf('actionlink_data') != 0) && (k != 'content') && (k != 'document') && (k.indexOf('feed') != 0) && (k.indexOf('frame') != 0) && (k != 'globalStorage') &&
					(k != 'g_mapObject') && (k != 'history') && (k != 'Modal') && (k != 'navigator') && (k != 'parent') && (k.indexOf('pb') != 0) && (k.indexOf('pt') != 0) && (k != 'seed') &&
					(k != 'self') && (k.indexOf('template_data') != 0) && (k != 'that') && (k != 'window') && (k != '_htmlElement') && (kType != 'function') && (kType != 'undefined')) {
					t.sortNonSeed[sl] = k;
					sl++;
				}
			}
			t.sortNonSeed.sort(function(x,y) {var a = String(x).toUpperCase(); var b = String(y).toUpperCase(); if (a > b) return 1; else if (a < b) return -1; else return 0;});
			var nsSelect = '<SELECT id="dbnonseed"><OPTION value="" ></option>';
			for (var i=0; i<t.sortNonSeed.length; i++)
				nsSelect += '<OPTION value="' + t.sortNonSeed[i] + '" >' + t.sortNonSeed[i] + '</option>';
			nsSelect += '</SELECT>';
			var not = t.dbDefaultNot.split(',');
			for (var i=0; i<not.length; i++)
				t.dbSelect[not[i]] = false;
			var m = '<DIV class=ptentry><B>Seed: </B><INPUT type=submit id=dbsuball value=ALL>&nbsp;<INPUT type=submit id=dbsubnone value=NONE>&nbsp;' +
				'<INPUT type=submit id=dbdefaults value=DEFAULTS>&nbsp;<INPUT type=submit id=dbsubdo value=SHOW>&nbsp;<INPUT type=submit id=dbsubscripts value=SCRIPTS><BR /><TABLE width=100%>';
			var cols = 5;
			var entries = t.sortSeed.length;
			var rows = parseInt (0.99 + entries / cols);
			for (var rowno=1; rowno<=rows; rowno++) {
				m += '<TR>';
				for (colno=1; colno<=cols; colno++) {
					var slvalue = rows*(colno-1)+rowno-1;
					m += ((slvalue < entries)?('<TD class=xtab><INPUT type=checkbox id="dbpop_'+t.sortSeed[slvalue]+'">&nbsp;'+t.sortSeed[slvalue]+'</TD>'):'<TD class=xtab></TD>');
				}
				m += '</TR>';
			}
			m += '</TABLE><B>Non-Seed: </B>' + nsSelect + '</DIV><DIV id="idDebugResultsDiv" style="width:738px; height:600px; max-height:600px; overflow-y:auto; white-space:pre-wrap;"></DIV>';
			t.popDebug.getMainDiv().innerHTML = m;
			document.getElementById('dbsuball').addEventListener('click', clickedAll, false);
			document.getElementById('dbsubnone').addEventListener('click', clickedNone, false);
			document.getElementById('dbdefaults').addEventListener('click', clickedDefaults, false);
			document.getElementById('dbsubdo').addEventListener('click', clickedShow, false);
			document.getElementById('dbsubscripts').addEventListener('click', clickedShowScripts, false);
			document.getElementById('dbnonseed').addEventListener('change', clickedShowNonSeed, false);
			syncBoxes();
		}
		t.popDebug.show (true);
	},
}

function getTrainInfo (){
  var ret = {};

  ret.trainUnts = [];
  for (i=0; i<13; i++){
    ret.trainUnts[i] = 0;
  }
  
  var q = Seed.queue_unt;
  for(i=0; i<Cities.numCities; i++) {   // each city
    cityID = 'city'+ Cities.cities[i].id;
	q = Seed.queue_unt[cityID];
	if (q && q.length>0){
	  for (qi=0; qi<q.length; qi++)
          ret.trainUnts[q[qi][0]] += parseInt(q[qi][1]);
	  }
    }
  return ret;
}

var fortNamesShort = {
  53: "crossbows",
  55: "trebuchets",
  60: "trap",
  61: "Caltrop",
  62: "Spiked Barrier",
}

// onClick (city{name, id, x, y}, x, y)   city may be null!
function CdispCityPicker (id, span, dispName, notify, selbut){
  function CcityButHandler (t){
    var that = t;
    this.clickedCityBut = clickedCityBut;
    function clickedCityBut (e){
      if (that.selected != null)
        that.selected.className = "castleBut castleButNon";
      that.city = Cities.cities[e.target.id.substr(that.prefixLen)];
      if (that.dispName)
        document.getElementById(that.id+'cname').innerHTML = that.city.name;
      e.target.className = "castleBut castleButSel";
      that.selected = e.target;
      if (that.coordBoxX){
        that.coordBoxX.value = that.city.x;
        that.coordBoxY.value = that.city.y;
        var evt = document.createEvent("HTMLEvents");
        evt.initEvent('change', true, true ); // event type,bubbling,cancelable
        that.coordBoxX.dispatchEvent(evt);
        that.coordBoxY.dispatchEvent(evt);
        that.coordBoxX.style.backgroundColor = '#ffffff';
        that.coordBoxY.style.backgroundColor = '#ffffff';
      }
      if (that.notify != null)
        that.notify(that.city, that.city.x, that.city.y);
    }
  }

  function selectBut (idx){
    document.getElementById(this.id+'_'+idx).click();
  }

  function bindToXYboxes (eX, eY){
    function CboxHandler (t){
      var that = t;
      this.eventChange = eventChange;
      if (that.city){
        eX.value = that.city.x;
        eY.value = that.city.y;
      }
      function eventChange (){
		var xValue=that.coordBoxX.value.trim();
			var xI=/^\s*([0-9]+)[\s|,|-|.]+([0-9]+)/.exec(xValue); 				
			if(xI) {
				that.coordBoxX.value=xI[1]
				that.coordBoxY.value=xI[2]
			}
        var x = parseInt(that.coordBoxX.value, 10);
        var y = parseInt(that.coordBoxY.value, 10);
        if (isNaN(x) || x<0 || x>750){
          that.coordBoxX.style.backgroundColor = '#ff8888';
          return;
        }
        if (isNaN(y) || y<0 || y>750){
          that.coordBoxY.style.backgroundColor = '#ff8888';
          return;
        }
        that.coordBoxX.style.backgroundColor = '#ffffff';
        that.coordBoxY.style.backgroundColor = '#ffffff';
        if (that.notify != null)
          that.notify (null, x, y);
      }
      return false;
    }
    this.coordBoxX = eX;
    this.coordBoxY = eY;
    var bh = new CboxHandler(this);
    eX.maxLength=8;
    eY.maxLength=3;
    eX.style.width='2em';    
    eY.style.width='2em';    
    eX.addEventListener('change', bh.eventChange, false);
    eY.addEventListener('change', bh.eventChange, false);
  }

  this.selectBut = selectBut;
  this.bindToXYboxes = bindToXYboxes;
  this.coordBoxX = null;
  this.coordBoxY = null;
  this.id = id;
  this.dispName = dispName;
  this.prefixLen = id.length+1;
  this.notify = notify;
  this.selected = null;
  this.city = null;
  var m = '';
  for (var i=0; i<Cities.cities.length; i++)
    m += '<INPUT class="castleBut castleButNon" id="'+ id +'_'+ i +'" value="'+ (i+1) +'" type=submit \>';
  if (dispName)
    m += ' &nbsp; <SPAN style="display:inline-block; width:85px; font-weight:bold;" id='+ id +'cname' +'></span>';
  span.innerHTML = m;
  var handler = new CcityButHandler(this);
  for (var i=0; i<Cities.cities.length; i++)
    document.getElementById (id+'_'+i).addEventListener('click', handler.clickedCityBut, false);
  if (selbut != null)
    this.selectBut(selbut);
};

function setCities(){
	var il = unsafeWindow.itemlist, cityID;
	for (var i=1101; i < 1115; i++)
		crestname[i] = il['i'+i].name
	getResearchLevels();
	Cities.numCities = Seed.cities.length;
	Cities.cities = [];
	Cities.byID = {};
	for (i=0; i<Cities.numCities; i++){
		city = {};
		city.idx = i;
		city.id = parseInt(Seed.cities[i][0]);
		cityID = 'city'+ city.id
		city.name = Seed.cities[i][1];
		city.x = parseInt(Seed.cities[i][2]);
		city.y = parseInt(Seed.cities[i][3]);
		city.tileId = parseInt(Seed.cities[i][5]);
		city.provId = parseInt(Seed.cities[i][4]);
		getTroopDefTrainEstimates('city'+ city.id, city);
		getRaidTroops(cityID);
		Cities.cities[i] = city;
		Cities.byID[Seed.cities[i][0]] = city;
	}
}



function getCityIdFromXY(x, y) {
	for(var i=0; i<Cities.numCities; i++) {
		if (Cities.cities[i].x == x && Cities.cities[i].y == y) {
			return Cities.cities[i].id;
		}
	}
	return -1;
}


function dialogRetry (errMsg, seconds, onRetry, onCancel, errCode){
  seconds = parseInt(seconds);
  var pop = new CPopup ('pbretry', 0, 0, 400,200, true);
  pop.centerMe(mainPop.getMainDiv());
  pop.getTopDiv().innerHTML = '<div class=showBadged><center>PowerKoc</center></div>';
  pop.getMainDiv().innerHTML = '<CENTER><BR><FONT COLOR=#550000><B>An error occurred:</b></font><BR><BR><DIV id=paretryErrMsg></div>\
      <BR><BR><B>Automatic retry on <SPAN id=paretrySeconds></b></span> second ...<BR><BR><INPUT id=paretryCancel type=submit value="CANCEL retry" \>';
  document.getElementById('paretryCancel').addEventListener ('click', doCancel, false);
  pop.show(true);
  
  if(errCode && unsafeWindow.g_js_strings.errorcode['err_'+errCode])
	document.getElementById('paretryErrMsg').innerHTML = unsafeWindow.g_js_strings.errorcode['err_'+errCode];
  else
  document.getElementById('paretryErrMsg').innerHTML = errMsg;
  document.getElementById('paretrySeconds').innerHTML = seconds;
  var rTimer = setTimeout (doRetry, seconds*1000);
  countdown ();

  function countdown (){
    document.getElementById('paretrySeconds').innerHTML = seconds--;
    if (seconds > 0)
      cdTimer = setTimeout (countdown, 1000);
  }
  function doCancel(){
    clearTimeout (rTimer);
    clearTimeout (cdTimer);
    pop.destroy();
    onCancel ();
  }
  function doRetry (){
    clearTimeout (rTimer);
    clearTimeout (cdTimer);
    pop.show(false);
    onRetry();
  }
}

function implodeUrlArgs (obj){
  var a = [];
  for (var k in obj)
    a.push (k +'='+ encodeURI(obj[k]) );
  return a.join ('&');    
}

// NOTA: args can be either a string which will be appended as is to url or an object of name->values
function addUrlArgs (url, args){
  if (!args)
    return url;
  if (url.indexOf('?') < 0)
    url += '?';
  else if (url.substr(url.length-1) != '&')
    url += '&';    
  if (matTypeof(args == 'object'))
    return url + implodeUrlArgs (args);    
  return url + args;
}

function GM_AjaxGet (url, args, notify, label){
	GM_xmlhttpRequest({
		method: "get",
		url: addUrlArgs(url, args),
		onload: function (rslt) {
			notify (rslt.responseText);
		},
		onerror: function () {
			notify (null);
		},
	});
}

function GM_AjaxPost (url, args, notify, label){
	GM_xmlhttpRequest({
		method: "post",
		url: url,
		data: implodeUrlArgs(args),
		headers: { "Content-Type": "application/x-www-form-urlencoded", 'X-Requested-With': 'XMLHttpRequest', 'X-Prototype-Version': '1.6.1',
			'Accept': 'text/javascript, text/html, application/xml, text/xml, */*' },
		onload: function (rslt) {
			notify (rslt.responseText);
		},
		onerror: function () {
			notify (null);
		},
	});
}

// emulate protoype's Ajax.Request ...
function AjaxRequest (url, opts){
  var headers = {
    'X-Requested-With': 'XMLHttpRequest',
    'X-Prototype-Version': '1.6.1',
    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
  };
  var ajax = null;

if (DEBUG_TRACE_AJAX) logit ("AJAX: "+ url +"\n" + inspect (opts, 3, 1));  
    
  if (window.XMLHttpRequest)
    ajax=new XMLHttpRequest();
  else
    ajax=new ActiveXObject("Microsoft.XMLHTTP");
  
  if (opts.method==null || opts.method=='')
    method = 'GET';
  else
    method = opts.method.toUpperCase();  
    
  if (method == 'POST'){
    headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
  } else if (method == 'GET'){
    addUrlArgs (url, opts.parameters);
  }

  ajax.onreadystatechange = function(){
//  ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
    if (ajax.readyState==4) {
      if (ajax.status >= 200 && ajax.status < 305)
        if (opts.onSuccess) opts.onSuccess(ajax);
      else
        if (opts.onFailure) opts.onFailure(ajax);
    } else {
      if (opts.onChange) opts.onChange (ajax);
    }
  }  
    
  ajax.open(method, url, true);   // always async!

  for (var k in headers)
    ajax.setRequestHeader (k, headers[k]);
  if (matTypeof(opts.requestHeaders)=='object')
    for (var k in opts.requestHeaders)
      ajax.setRequestHeader (k, opts.requestHeaders[k]);

  if (method == 'POST'){
    var a = [];
    for (k in opts.parameters){
	  if(matTypeof(opts.parameters[k]) == 'object')
		for(var h in opts.parameters[k])
			a.push (k+'['+h+'] ='+ opts.parameters[k][h] );
	  else
        a.push (k +'='+ opts.parameters[k] );
	}
    ajax.send (a.join ('&'));
  } else               {
    ajax.send();
  }
}         

function MyAjaxRequest (url, o, noRetryX){
  //logit (" 0 myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  var opts = unsafeWindow.Object.clone(o);
  var wasSuccess = o.onSuccess;
  var wasFailure = o.onFailure;
  var retry = 0;
  var delay = 3;
  var show=true;
  var silentTimer;
  var noRetry = noRetry===true?true:false;
  opts.onSuccess = mySuccess;
  opts.onFailure = myFailure;
  new AjaxRequest(url, opts);
  return;

  function myRetry(){
    ++retry;
    if (retry>5) {
       actionLog(error, "<font color=res>retrying</font>");
       return false;
       }
    new AjaxRequest(url, opts);
  
    delay = delay * 1.25;
  }
  function myFailure(){
    var o = {};
    o.ok = false;
    o.errorMsg = "AJAX Communication Failure";
    wasFailure (o);
  }
  function mySuccess (msg){
  //logit(msg);
    var rslt;
   try {
    rslt = JSON2.parse(msg.responseText);
   } catch(e) {
   
    if (retry<2) {
      rslt = {"ok":false,"error_code":9,"errorMsg":"Failed due to invalid json"}
    } else {
      rslt = {"ok":true,"error_code":9,"data":[]};
    }
    
    }
    var x;
    if (window.EmulateAjaxError){
      rslt.ok = false;  
      rslt.error_code=8;
    }
    if (rslt.ok){
      if (rslt.updateSeed)
        unsafeWindow.update_seed(rslt.updateSeed);
      wasSuccess (rslt);
      return;
    }
    
    rslt.errorMsg = unsafeWindow.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));

    if (!noRetry && (rslt.error_code==0 ||rslt.error_code==8 || rslt.error_code==1 || rslt.error_code==3)){
      actionLog(error, "<font color=res>"+ msg.responseText +"</font>");
      dialogRetry (inspect(rslt.errorMsg), delay, function(){myRetry()}, function(){wasSuccess (rslt)}, rslt.error_code);
    } else if (!noRetry && rslt.error_code==9) {
      silentTimer = setTimeout(silentRetry, delay*100);  
    } else {
      wasSuccess (rslt);
    }
  }

  function silentRetry() {
   	    clearTimeout(silentTimer);
   	    myRetry();
   }
}

function getDiplomacy (aid) { // returns: 'neutral', 'friendly', 'ally', or 'hostile'
	if (Seed.allianceDiplomacies == null)
		return 'Neutral';
	if (Seed.allianceDiplomacies.friendly && Seed.allianceDiplomacies.friendly['a'+aid] != null)
		return 'friendly';
	if (Seed.allianceDiplomacies.hostile && Seed.allianceDiplomacies.hostile['a'+aid] != null)
		return 'Hostile';
	if (aid == Seed.allianceDiplomacies.allianceId)
		return 'alliance';
	return 'neutral';
};

function getMyAlliance (){
  if (Seed.allianceDiplomacies==null || Seed.allianceDiplomacies.allianceName==null)
    return [0, 'None'];
  else
    return [Seed.allianceDiplomacies.allianceId, Seed.allianceDiplomacies.allianceName];
}

function getMyUserId (){
	return parseInt([Seed.tutorial.userId]);
}

function ShowExtraInfo(){
  alert('ineter');
  content = document.getElementById('mod_citylist').innerHTML
  content += "O";
	document.getElementById('mod_citylist').innerHTML = content; 
}

function distance (d, f, c, e) {
  var a = 750;
  var g = a / 2;
  var b = Math.abs(c - d);
  if (b > g)
    b = a - b;
  var h = Math.abs(e - f);
  if (h > g)
    h = a - h;
  return Math.round(100 * Math.sqrt(b * b + h * h)) / 100;
};

// example: http://www150.kingdomsofcamelot.com
function GetServerId() {
  var m=/^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
  if(m)
    return m[1];
  return '';
}

function logit (msg){
  var serverID = GetServerId();
  var now = new Date();
  GM_log (serverID +' @ '+ now.toTimeString().substring (0,8) +'.' + now.getMilliseconds() +': '+  msg);
}

function saveOptions (){
  var serverID = GetServerId();
  GM_setValue ('Options_'+serverID, JSON2.stringify(Options));
}

function saveChatOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('ChatOptions_'+serverID, JSON2.stringify(ChatOptions));}, 0);
}

function saveTrainOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('TrainOptions_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(TrainOptions));}, 0);
}

function saveCombatOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('CombatOptions_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(CombatOptions));}, 0);
}

function saveAttackOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('AttackOptions_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(AttackOptions));}, 0);
}

function saveColors (){
  var serverID = GetServerId();
  GM_setValue ('Colors_'+serverID, JSON2.stringify(Colors));
}

function saveUpgradeData (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('UpgradeData_'+serverID, JSON2.stringify(upgradeData));}, 0);
}



function readWallTrainOptions (){
var serverID = getServerId();
	s = GM_getValue ('WallTrainOptions_' + Seed.player['name'] + '_' +serverID);
	if (s != null){
		opts = JSON2.parse (s);
		for (k in opts){
			if (WallTrainOptions[k] != undefined) {
				if (matTypeof(opts[k]) == 'object') {
					for (kk in opts[k])
						if (WallTrainOptions[k][kk] != undefined)
							WallTrainOptions[k][kk] = opts[k][kk];
				} else
					WallTrainOptions[k] = opts[k];
			}
		}
	}
}

function saveWallTrainOptions (){
var serverID = getServerId();	
GM_setValue ('WallTrainOptions_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(WallTrainOptions));}


function saveCrestData (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('CrestData_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(CrestData));}, 0);
}

function saveTrainingOptions(){
   var serverID =getServerId();
     setTimeout(function(){GM_setValue("TrainOptions_" + Seed.player['name'] + '_' +serverID, JSON2.stringify(TrainOptions))},0)}


function saveThroneOptions() {
   var serverID = getServerId();
   setTimeout(function () { GM_setValue('ThroneOptions_' + Seed.player['name'] + '_' + serverID, JSON2.stringify(ThroneOptions)); }, 0);}

function readColors (){
  var serverID = GetServerId();
  s = GM_getValue ('Colors_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts)
      Colors[k] = opts[k];
  }else{
	s = GM_getValue ('Colors');
	if (s != null){
		opts = JSON2.parse (s);
		for (k in opts)
		  Colors[k] = opts[k];
	}
  }
}

function readOptions (){
  var serverID = GetServerId();
  s = GM_getValue ('Options_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts) Options[k] = opts[k];
     }
}

function readChatOptions (){
  var serverID = getServerId();
  s = GM_getValue ('ChatOptions_'+serverID, '[]');
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          ChatOptions[k][kk] = opts[k][kk];
      else
        ChatOptions[k] = opts[k];
    }
  }
}

function readCrestData (){
  var serverID = getServerId();
  s = GM_getValue ('CrestData_' + Seed.player['name'] + '_' +serverID);

  if (s != null) {
    opts = JSON2.parse (s);

	for (var i = 0; i < opts.length; i++) {
		CrestData[i] = new CrestFunc(opts[i]);
	}
  }
}

function readThroneOptions() {
    var serverID = getServerId();
    s = GM_getValue('ThroneOptions_' + Seed.player['name'] + '_' +serverID);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object') for (kk in opts[k])
            ThroneOptions[k][kk] = opts[k][kk];
            else ThroneOptions[k] = opts[k];
        }
    }
}

function readCombatOptions (){
  var serverID = getServerId();
  s = GM_getValue ('CombatOptions_' + Seed.player['name'] + '_' +serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
			if (matTypeof(opts[k][kk]) == 'object')
				for (kkk in opts[k][kk])
				  CombatOptions[k][kk][kkk] = opts[k][kk][kkk];
			else
				CombatOptions[k][kk] = opts[k][kk];
      else
        CombatOptions[k] = opts[k];
    }
  }
}

function readTrainingOptions (){
  var serverID = getServerId();
  s = GM_getValue ('TrainOptions_' + Seed.player['name'] + '_' +serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          TrainOptions[k][kk] = opts[k][kk];
      else
        TrainOptions[k] = opts[k];
    }
  }
}

function readAttackOptions (){
  var serverID = getServerId();
  s = GM_getValue ('AttackOptions_' + Seed.player['name'] + '_' +serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          AttackOptions[k][kk] = opts[k][kk];
      else
        AttackOptions[k] = opts[k];
    }
  }
}

var myServers = {   // incomplete, untested
  serverlist : null,
  
  get : function (notify){
    if (myServers.serverlist){
      notify (myServers.serverlist);
      return;
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/myServers.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function(rslt) {
logit (inspect (rslt, 3, 1));  
        if (notify)      
          notify (myServers.serverlist);
      },
      onFailure: function(rslt) {
      }
    });
  },
};

function createButton (label,id){
  var a=document.createElement('a');
  a.className='button20';
  a.id = id;
  a.innerHTML='<span style="color: #1EFF00">'+ label +'</span>';
  return a;
}

function updatebotbutton2(a,b){var c=ById(b);if(c)c.innerHTML='<span style="color: #F71F02">'+a.replace("-ON",butON).replace("-OFF",butOFF)+"</span>"}
function updatebotbutton(a,b){var c=ById(b);if(c)c.innerHTML='<span style="color: #ff6">'+a.replace("-ON",butON).replace("-OFF",butOFF)+"</span>"}

function createYellowButton (label,id){
  var a=document.createElement("label");
  a.className='button20';
  a.id = id;
  a.innerHTML='<span style="color: #ff6">'+label.replace("-ON",butON).replace("-OFF",butOFF)+'</span>';
  return a;
}

function createRedButton (label,id){
  var a=document.createElement('a');
  a.className='button20';
  a.id = id;
  a.innerHTML='<span style="color: #F71F02">'+ label +'</span>';
  return a;
}

function AddMainTabLink(text, eventListener, mouseListener) {
  var a = createButton (text,'botbutton');
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      gmTabs.style.background='#ca5';
      tabs.parentNode.insertBefore (gmTabs, tabs);
      gmTabs.style.whiteSpace='nowrap';
      gmTabs.style.width='735px';
	  gmTabs.style.height='60px';
      gmTabs.lang = 'en_PB';
    }
    gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (mouseListener != null)
      a.addEventListener('mousedown',mouseListener, true);
    return a;
  }
  return null;
}

function AddSubTabLink(text, eventListener, id) {
  var a = createYellowButton (text,'botbutton');
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      gmTabs.style.background='#ca5';
      tabs.parentNode.insertBefore (gmTabs, tabs);
      gmTabs.style.whiteSpace='nowrap';
      gmTabs.style.width='735px';
	  gmTabs.style.height='60px';
      gmTabs.lang = 'en_PB';
    }
    gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (id != null)
      a.id = id;
    return a;
  }
  return null;
}

function AddTowerTab(text, eventListener, id) {
  var a = createRedButton (text,'botbutton');
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      gmTabs.style.background='#ca5';
      tabs.parentNode.insertBefore (gmTabs, tabs);
      gmTabs.style.whiteSpace='nowrap';
      gmTabs.style.width='735px';
	  gmTabs.style.height='60px';
      gmTabs.lang = 'en_PB';
    }
    gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (id != null)
      a.id = id;
    return a;
  }
  return null;
}

function coordLink (x, y){
  var m = [];
  m.push ('(<a onclick="pbGotoMap (');
  m.push (x);
  m.push (',');
  m.push (y);
  m.push ('); return false">');
  m.push (x);
  m.push (',');
  m.push (y);
  m.push ('</a>)');  
  return m.join('');
}

unsafeWindow.pbGotoMap = function (x, y){
  if (Options.hideOnGoto)
    hideMe ();
  setTimeout (function (){
    document.getElementById('mapXCoor').value = x;
    document.getElementById('mapYCoor').value = y;
    unsafeWindow.reCenterMapWithCoor();
    var a = document.getElementById("mod_views").getElementsByTagName("a");
    for (var b = 0; b < a.length; b++) {
        a[b].className = ""
    }
    document.getElementById('mod_views_map').className = "sel";
    document.getElementById("maparea_city").style.display = 'none';
    document.getElementById("maparea_fields").style.display = 'none';
    document.getElementById("maparea_map").style.display = 'block';
    unsafeWindow.tutorialClear()
  }, 0);
};

unsafeWindow.ptGotoMapHide = function (x, y){
	try {
		unsafeWindow.Modal.hideModal();
	} catch (e){ }
	try {
		Modal.hideModal();
	} catch (e){ }
	unsafeWindow.ptGotoMap (x, y);
}

unsafeWindow.ptGotoMap = function (x, y, gotoCityNum){
	if (Options.hideOnGoto)
		hideMe ();
	if (gotoCityNum != undefined)
		setTimeout (function(){unsafeWindow.citysel_click(document.getElementById('citysel_'+gotoCityNum));}, 0);
	setTimeout (function (){
		document.getElementById('mapXCoor').value = x;
		document.getElementById('mapYCoor').value = y;
		unsafeWindow.reCenterMapWithCoor();
		var a = document.getElementById("mod_views").getElementsByTagName("a");
		for (var b = 0; b < a.length; b++) {
				a[b].className = ""
		}
		document.getElementById('mod_views_map').className = "sel";
		document.getElementById("maparea_city").style.display = 'none';
		document.getElementById("maparea_fields").style.display = 'none';
		document.getElementById("maparea_map").style.display = 'block';
		unsafeWindow.tutorialClear()
	}, 0);
};

unsafeWindow.ptGotoCity = function (gotoCityNum){
	setTimeout (function(){unsafeWindow.citysel_click(document.getElementById('citysel_'+gotoCityNum));}, 0);
}


function addScript (scriptText){
	var scr = document.createElement('script');   
	scr.innerHTML = scriptText;
	document.body.appendChild(scr);
}
addScript ('uwuwuwFunc = function (text){ eval (text);  }');  

var CalterUwFunc = function (funcName, findReplace) {
  var t = this;
  this.isEnabled = false;
  this.isAvailable = isAvailable;
  this.setEnable = setEnable;
  this.funcOld = null;  
  this.funcNew = null;
  try {
    var x = funcName.split('.');
    var f = unsafeWindow;
    for (var i=0; i<x.length; i++)
      f = f[x[i]];
    ft = f.toString();
    this.funcOld = f;
    var rt = f.toString().replace ('function '+ funcName, 'function');
    for (var i=0; i<findReplace.length; i++){
      x = rt.replace(findReplace[i][0], findReplace[i][1]);
      if (x == rt)  // if not found
        return;
      rt = x;
    }
    this.funcNew = rt;
  } catch (err) {
  }
      
  function setEnable (tf){
    if (t.funcNew == null)
      return;
    if (t.isEnabled != tf){
      if (tf){
        var scr = document.createElement('script');    // <== need to remove on disable!!!
        scr.innerHTML = funcName +' = '+ t.funcNew;
        document.body.appendChild(scr);
        setTimeout ( function (){document.body.removeChild(scr);}, 500);
        t.isEnabled = true;
      } else {
      var x = funcName.split('.');
      var f = unsafeWindow;
      for (var i=0; i<x.length-1; i++)
        f = f[x[i]];
      f[x[x.length-1]] = this.funcOld;
        t.isEnabled = false;
      }
    }
  }

  function isAvailable (){
    if (t.funcNew == null)
      return false;
    return true;
  }
};

function makeButton20 (label){
  var a = document.createElement('a');
  a.className = "button20 ptButton20";
  var s = document.createElement('span');
  s.innerHTML = label;
  a.appendChild (s);
  return a;
}

function strButton20 (label, tags){
  if (tags == null)
    tags = '';
  return ('<TABLE class=ptNoPad><TR><TD><A class="button20 ptButton20" '+ tags +'><SPAN>'+ label +'</span></a></td></tr></table>' );
}

function strButton14 (label, tags){
  if (tags == null)
    tags = '';
  return ('<A class="button14 ptButton20" '+ tags +'><SPAN>'+ label +'</span></a>' );
}

function reloadKOC (){
  var serverId = getServerId();
  if(serverId == '??') window.location.reload(true);
  var goto = window.location.protocol+'//apps.facebook.com/kingdomsofcamelot/?s='+serverId;
  if(document.URL.match(/standalone=1/i)){
	goto = window.location.protocol+'//www.kabam.com/kingdoms-of-camelot/play?s='+serverId;
  }
  var t = '<FORM target="_top" action="'+ goto +'" method=post><INPUT id=xxpbButReload type=submit value=RELOAD><INPUT type=hidden name=s value="'+ serverId +'"</form>';
  var e = document.createElement ('div');
  e.innerHTML = t;
  document.body.appendChild (e);
  setTimeout (function (){document.getElementById('xxpbButReload').click();}, 0);
}
  
function htmlSelector (valNameObj, curVal, tags){
  var m = [];
  m.push ('<SELECT');
  if (tags){
    m.push (' ');
    m.push (tags);
  }  
  for (var k in valNameObj){
    m.push ('><OPTION ');
    if (k == curVal)
      m.push ('SELECTED ');
    m.push ('value="');
    m.push (k);
    m.push ('">');
    m.push (valNameObj[k]);
    m.push ('</option>');
  }
  m.push ('</select>');
  return m.join ('');
}

function cityStatusString (cs){
  if (cs==4)
    return 'Vacation';
  if (cs==3)
    return 'Truce';
  if (cs==2)
    return 'Beg Protection';
  return 'Normal';
}    

// Simple method, as if it were typed in thru DOM
function sendChat (msg){
  document.getElementById ("mod_comm_input").value = msg;
  uW.Chat.sendChat ();
}

// works well, but message is not echoed back to local client
Chat = {
  params : null,

  sendWhisper : function (msg, who, notify){
    this.params = uW.Object.clone(uW.g_ajaxparams);
    this.params.ctype = 3;
    this.params.name = who;
    this._sendit (msg, notify);
  },

  sendGlobal : function (msg, notify){
    this.params = uW.Object.clone(uW.g_ajaxparams);
    this.params.ctype = 1;
    this._sendit (msg, notify);
  },

  sendAlliance : function (msg, notify){
    this.params = uW.Object.clone(uW.g_ajaxparams);
    this.params.ctype = 2;
    this._sendit (msg, notify);
  },

  _sendit : function (msg, notify){
    function strip(s) {
       return s.replace(/^\s+/, '').replace(/\s+$/, '');
    }
    this.params.comment = strip (msg);
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/sendChat.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: this.params,
      onSuccess: function(transport) {
        if (notify)
          notify ();
      },
      onFailure: function(transport) {
        if (notify)
          notify ();
      }
    });
  },
}

function doDefTrain (cityId, unitId, num, notify){
  var time = unsafeWindow.modal_walls_traintime(unitId, num);
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.type = unitId;
  params.quant = num;
  params.items = 0;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fortify.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok) {
          unsafeWindow.seed.queue_fort["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, rslt.fortifyId]);
          if (notify != null)
            setTimeout (function (){notify(null);}, 500);
        } else {
          if (notify != null)
            setTimeout (function (){notify(rslt.errorMsg);}, 500);
        }
      },
      onFailure: function () {
        if (notify != null)
          notify(rslt.errorMsg);
      },
  });
}
function doTrain (cityId, tut, gamble, unitId, num, notify){
  var time = unsafeWindow.modal_barracks_traintime(unitId, num);
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.type = unitId;
  params.quant = num;
  params.items = tut;
  params.gambleId = gamble;

  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/train.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function(rslt) {
      if (rslt.ok) {
        for (var i = 1; i < 5; i++) {
                  var resourceLost = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(num);
		  if(rslt.gamble) resourceLost = resourceLost*rslt.gamble[i];
          unsafeWindow.seed.resources["city" + cityId]["rec" + i][0] = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]) - resourceLost;
        }
        unsafeWindow.seed.citystats["city" + cityId].gold[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].gold[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][5]) * parseInt(num);
        unsafeWindow.seed.citystats["city" + cityId].pop[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].pop[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][6]) * parseInt(num);
        unsafeWindow.seed.queue_unt["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, null]);
        if (notify != null)
          setTimeout (function (){notify(null);}, 500);
      } else {
        if (notify != null){
          setTimeout (function (){notify(rslt.errorMsg);}, 500);
        }
      }
    },
    onFailure: function(o) {
      if (notify != null)
        notify(rslt.errorMsg);
    }
  });
}

function getAbsoluteOffsets (e){
  ret = {left:0, top:0};
  while (e.offsetParent){
    if (e.style.position == 'absolute')
      break;
    ret.left += e.offsetLeft;
    ret.top += e.offsetTop;
    e = e.offsetParent;
  }      
  return ret;  
}

DebugTimer = {
  startTime : 0,
  start : function (){
    now = new Date();
    DebugTimer.startTime = now.getTime();
  },
  getMillis : function (){
    now = new Date();
    return now.getTime() - DebugTimer.startTime;
  },
  display : function (label, noReset){
    now = new Date();
    elapsed = now.getTime() - DebugTimer.startTime;
    logit (label +": "+ elapsed/1000);
    if (noReset===null || !noReset)
      DebugTimer.startTime = now.getTime();
  },
};

function debugPos  (e){
  return '['+ e.tagName +'] client - offset: '+ e.clientLeft +','+ e.clientTop +','+ e.clientWidth +','+ e.clientHeight
          +' - '+ e.offsetLeft +','+ e.offsetTop +','+ e.offsetWidth +','+ e.offsetHeight +' '+ e +' --OP--> '+ e.offsetParent;
}

function CwaitForElement (id, timeout, notify){
  this.check = check;
  this.end = new Date().getTime() + timeout;
  var t = this;
  this.check();
  function check(){
    if (document.getElementById (id))
      notify (true);
    else if (new Date().getTime() > t.end)
      notify (false);
    else
      setTimeout (t.check, 500);
  }
}

function clickWin (win,obj,evtName) {
	var evt = win.document.createEvent("MouseEvents");
	evt.initMouseEvent(evtName, true, true, win, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
	return !obj.dispatchEvent(evt);
}
    
function debugElement  (e){
  var x = unsafeWindow.Object.clone (e.wrappedJSObject);
  x.innerHTML = '';
  x.innerText = '';
  x.textContent = '';
  return inspect (x, 1, 1);
}     

function getClientCoords(e){
  if (e==null)
    return {x:null, y:null, width:null, height:null};
  var x=0, y=0;
  ret = {x:0, y:0, width:e.clientWidth, height:e.clientHeight};
  while (e.offsetParent != null){
    ret.x += e.offsetLeft;
    ret.y += e.offsetTop;
    e = e.offsetParent;
  }
  return ret;
}

function DOMtree (e, levels){
  var m = [];
  level (e, levels, 0);
  
  function level (e, levels, cur){
    try {        
      for (var i=0; i<cur; i++)
        m.push('  ');
      if (!e.tagName)
        m.push ('?');
      else
        m.push (e.tagName);
      if (e.id){
        m.push (' id=');
        m.push (e.id);
      }
      if (e.name){
        m.push (' name=');
        m.push (e.name);
      }
      if (e.className){
        m.push (' class=');
        m.push (e.className);
      }
      if (e.style && e.style.display && e.style.display.indexOf('none')>0)
        m.push (' hidden');
       m.push ('\n');
      if (cur < levels){
        for (var c=0; c<e.childNodes.length; c++){
          level (e.childNodes[c], levels, cur+1);
        }
      }
    } catch (e) {
      m.push ('UNAVAILBLE!\n');
    }
  }
  return m.join('');  
}

function parseIntNan (n){
  x = parseInt(n, 10);
  if (isNaN(x))
    return 0;
  return x;
}

function parseIntCommas (n){
 n = n.split(',');
 n = n.join('');
 x = parseInt(n, 10);
 if (isNaN(x))
 return 0;
 return x;
} 

function parseIntZero (n){  
  if (n == '')
    return 0;
  return parseInt(n, 10);
}

function show2DPs(num) {
	if (num == parseInt(num))
		return num + '.00';
	else if (10*num == parseInt(10*num))
		return num + '0';
	else
		return num;
};

function getFirefoxVersion (){
  var ver='', i;
  var ua = navigator.userAgent;  
  if (ua==null || (i = ua.indexOf('Firefox/'))<0)
    return;
  return ua.substr(i+8);
}

function htmlTitleLine (msg){
  return '<TABLE width=100% cellspacing=0><TR><TD style="padding:0px" width=50%><HR></td><TD style="padding:0px">[ '+ msg +' ]</td><TD style="padding:0px" width=50%><HR></td></tr></table>';  
}

var WinManager = {
  wins : {},    // prefix : CPopup obj
  didHide : [],
  
  
  get : function (prefix){
    var t = WinManager;
    return t.wins[prefix];
  },
  
  add : function (prefix, pop){
    var t = WinManager;
    t.wins[prefix] = pop;
    if (unsafeWindow.cpopupWins == null)
      unsafeWindow.cpopupWins = {};
    unsafeWindow.cpopupWins[prefix] = pop;
  },
  
  hideAll : function (){
    var t = WinManager;
    t.didHide = [];
    for (k in t.wins){
      if (t.wins[k].isShown()){
        t.didHide.push (t.wins[k]);
        t.wins[k].show (false);
      }
    }
  },
  restoreAll : function (){
    var t = WinManager;
    for (var i=0; i<t.didHide.length; i++)
      t.didHide[i].show (true);
  },
  
  delete : function (prefix){
    var t = WinManager;
    delete t.wins[prefix];
    delete unsafeWindow.cpopupWins[prefix];
  }    
}

function CPopup (prefix, x, y, width, height, enableDrag, onClose) {
  var pop = WinManager.get(prefix);
  if (pop){
    pop.show (false);
    return pop;
  }
  this.BASE_ZINDEX = 123457;
  this.stmaxh = height;
  this.stmaxw = width;
  this.show = show;
  this.toggleHide = toggleHide;
  this.getTopDiv = getTopDiv;
  this.getMainTopDiv = getMainTopDiv;
  this.getMainDiv = getMainDiv;
  this.getLayer = getLayer;
  this.setLayer = setLayer;
  this.setEnableDrag = setEnableDrag;
  this.getLocation = getLocation;
  this.setLocation = setLocation;
  this.focusMe = focusMe;
  this.isShown = isShown;
  this.unfocusMe = unfocusMe;
  this.centerMe = centerMe;
  this.destroy = destroy;
  this.autoHeight = autoHeight;
  this.autoWidth = autoWidth;
  // object vars ...
  this.div = document.createElement('div');
  this.prefix = prefix;
  this.onClose = onClose;
  
  var t = this;
  this.div.className = 'CPopup '+ prefix +'_CPopup';
  this.div.id = prefix +'_outer';
  this.div.style.background = "#fff";
  this.div.style.zIndex = this.BASE_ZINDEX        // KOC modal is 100210 ?
  this.div.style.display = 'none';
  this.div.style.width = width + 'px';
  this.div.style.height = height + 'px';
  this.div.style.maxHeight = height + 'px';
  this.div.style.overflowY = 'show';
  this.div.style.position = "absolute";
  this.div.style.top = y +'px';
  this.div.style.left = x + 'px';
  this.div.style.maxWidth = width + 'px';
  if (CPopUpTopClass==null)
    topClass = 'CPopupTop '+ prefix +'_CPopupTop';
  else
    topClass = CPopUpTopClass +' '+ prefix +'_'+ CPopUpTopClass;
    
  var m = '<TABLE cellspacing=0 width=100% height=100%><TR id="'+ prefix +'_bar" class="'+ topClass +'"><TD width=99% valign=bottom><SPAN id="'+ prefix +'_top"></span></td>\
      <TD id='+ prefix +'_X align=right valign=middle onmouseover="this.style.cursor=\'pointer\'" style="color:#fff; background:#333; font-weight:bold; font-size:14px; padding:0px 5px">X</td></tr>\
      <TR><TD height=100% valign=top class="CPopMain '+ prefix +'_CPopMain" colspan=2 id="'+ prefix +'_main"></td></tr></table>';
  document.body.appendChild(this.div);
  this.div.innerHTML = m;
  document.getElementById(prefix+'_X').addEventListener ('click', e_XClose, false);
  this.dragger = new CWinDrag (document.getElementById(prefix+'_bar'), this.div, enableDrag);
  this.div.addEventListener ('mousedown', e_divClicked, false);
  WinManager.add(prefix, this);
  
  function e_divClicked (){
    t.focusMe();
  }  
  function e_XClose (){
    t.show(false);
    if (t.onClose != null)
      t.onClose();
  }

  function autoHeight (onoff){
     if (onoff) {
       t.div.style.height = '';  
       t.div.style.maxHeight ='';
    } else{
       t.div.style.height = t.stmaxh;
       t.div.style.maxHeight = t.stmaxh;
       }
  }

  function autoWidth (onoff){
         if (onoff) {
           t.div.style.width = '';  
           t.div.style.maxWidth ='';
        } else{
           t.div.style.width = t.stmaxw;
           t.div.style.maxWidth = t.stmaxw;
           }
  }

  function focusMe (){
    t.setLayer(5);
    for (k in unsafeWindow.cpopupWins){
      if (k != t.prefix)
        unsafeWindow.cpopupWins[k].unfocusMe();
    }
  }
  function unfocusMe (){
    t.setLayer(-5);
  }
  function getLocation (){
    return {x: parseInt(this.div.style.left), y: parseInt(this.div.style.top)};
  }
  function setLocation (loc){
    t.div.style.left = loc.x +'px';
    t.div.style.top = loc.y +'px';
  }
  function destroy (){
    document.body.removeChild(t.div);
    WinManager.delete (t.prefix);
  }
  function centerMe (parent){
    if (parent == null){
      var coords = getClientCoords(document.body);
    } else
      var coords = getClientCoords(parent);
    var x = ((coords.width - parseInt(t.div.style.width)) / 2) + coords.x;
    var y = ((coords.height - parseInt(t.div.style.height)) / 2) + coords.y;
    if (x<0)
      x = 0;
    if (y<0)
      y = 0;
    t.div.style.left = x +'px';
    t.div.style.top = y +'px';
  }
  function setEnableDrag (tf){
    t.dragger.setEnable(tf);
  }
  function setLayer(zi){
    t.div.style.zIndex = ''+ (this.BASE_ZINDEX + zi);
  }
  function getLayer(){
    return parseInt(t.div.style.zIndex) - this.BASE_ZINDEX;
  }
  function getTopDiv(){
    return document.getElementById(this.prefix+'_top');
  }
  function getMainDiv(){
    return document.getElementById(this.prefix+'_main');
  }
  function getMainTopDiv(){
  	return document.getElementById(this.prefix+'_top');
  }
  function isShown (){
    return t.div.style.display == 'block';
  }
  function show(tf){
    if (tf){
      t.div.style.display = 'block';
      t.focusMe ();
    } else {
      t.div.style.display = 'none';
    }
    return tf;
  }
  function toggleHide(t){
    if (t.div.style.display == 'block') {
      return t.show (false);
    } else {
      return t.show (true);
    }
  }
}

function CWinDrag (clickableElement, movingDiv, enabled) {
  var t=this;
  this.setEnable = setEnable;
  this.setBoundRect = setBoundRect;
  this.debug = debug;
  this.dispEvent = dispEvent;
  this.lastX = null;
  this.lastY = null;
  this.enabled = true;
  this.moving = false;
  this.theDiv = movingDiv;
  this.body = document.body;
  this.ce = clickableElement;
  this.moveHandler = new CeventMove(this).handler;
  this.outHandler = new CeventOut(this).handler;
  this.upHandler = new CeventUp(this).handler;
  this.downHandler = new CeventDown(this).handler;
  this.clickableRect = null;
  this.boundRect = null;
  this.bounds = null;
  this.enabled = false;
  if (enabled == null)
    enabled = true;
  this.setEnable (enabled);

  function setBoundRect (b){    // this rect (client coords) will not go outside of current body
    this.boundRect = boundRect;
    this.bounds = null;
  }

  function setEnable (enable){
    if (enable == t.enabled)
      return;
    if (enable){
      clickableElement.addEventListener('mousedown',  t.downHandler, false);
      t.body.addEventListener('mouseup', t.upHandler, false);
    } else {
      clickableElement.removeEventListener('mousedown', t.downHandler, false);
      t.body.removeEventListener('mouseup', t.upHandler, false);
    }
    t.enabled = enable;
  }

  function CeventDown (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (t.bounds == null){
        t.clickableRect = getClientCoords(clickableElement);
        t.bodyRect = getClientCoords(document.body);
        if (t.boundRect == null)
          t.boundRect = t.clickableRect;
        t.bounds = {top:10-t.clickableRect.height, bot:t.bodyRect.height-25, left:40-t.clickableRect.width, right:t.bodyRect.width-25};
      }
      if (me.button==0 && t.enabled){
        t.body.addEventListener('mousemove', t.moveHandler, true);
        t.body.addEventListener('mouseout', t.outHandler, true);
        t.lastX = me.clientX;
        t.lastY = me.clientY;
        t.moving = true;
      }
    }
  }

  function CeventUp  (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (me.button==0 && t.moving)
        _doneMoving(t);
    }
  }

  function _doneMoving (t){
    t.body.removeEventListener('mousemove', t.moveHandler, true);
    t.body.removeEventListener('mouseout', t.outHandler, true);
    t.moving = false;
  }

  function CeventOut  (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (me.button==0){
        t.moveHandler (me);
      }
    }
  }
  
  function CeventMove (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (t.enabled && !t.wentOut){
        var newTop = parseInt(t.theDiv.style.top) + me.clientY - t.lastY;
        var newLeft = parseInt(t.theDiv.style.left) + me.clientX - t.lastX;
        if (newTop < t.bounds.top){     // if out-of-bounds...
          newTop = t.bounds.top;
          _doneMoving(t);
        } else if (newLeft < t.bounds.left){
          newLeft = t.bounds.left;
          _doneMoving(t);
        } else if (newLeft > t.bounds.right){
          newLeft = t.bounds.right;
          _doneMoving(t);
        } else if (newTop > t.bounds.bot){
          newTop = t.bounds.bot;
          _doneMoving(t);
        }
        t.theDiv.style.top = newTop + 'px';
        t.theDiv.style.left = newLeft + 'px';
        t.lastX = me.clientX;
        t.lastY = me.clientY;
      }
    }
  }

  function debug  (msg, e){
    logit ("*************** "+ msg +" ****************");
    logit ('clientWidth, Height: '+ e.clientWidth +','+ e.clientHeight);
    logit ('offsetLeft, Top, Width, Height (parent): '+ e.offsetLeft +','+ e.offsetTop +','+ e.offsetWidth +','+ e.offsetHeight +' ('+ e.offsetParent +')');
    logit ('scrollLeft, Top, Width, Height: '+ e.scrollLeft +','+ e.scrollTop +','+ e.scrollWidth +','+ e.scrollHeight);
  }

  function dispEvent (msg, me){
    logit (msg + ' Button:'+ me.button +' Screen:'+ me.screenX +','+ me.screenY +' client:'+  me.clientX +','+ me.clientY +' rTarget: '+ me.relatedTarget);
  }
}

function entier_1dec (nombre){
	if (parseInt(nombre*10)!=0){
		return parseInt(nombre*10)/10;
	} else {
	return nombre;
	}	
}

function inspect(obj, maxLevels, level, doFunctions){
  var str = '', type, msg;
  if(level == null)  level = 0;
  if(maxLevels == null) maxLevels = 1;
  if(maxLevels < 1)
      return 'Inspect Error: Levels number must be > 0';
  if(obj == null)
    return 'ERROR: Object is NULL\n';
  var indent = '';
  for (var i=0; i<level; i++)
    indent += '  ';
  for(property in obj) {
    try {
        type =  matTypeof(obj[property]);
        if (doFunctions==true && (type == 'function')){
          str += indent + '(' + type + ') ' + property + "[FUNCTION]\n";
        } else if (type != 'function') {
          str += indent + '(' + type + ') ' + property + ( (obj[property]==null)?(': null'):('')) +' = '+ obj[property] +"\n";
        }
        if((type=='object' || type=='array') && (obj[property] != null) && (level+1 < maxLevels))
          str += inspect(obj[property], maxLevels, level+1, doFunctions);  // recurse
    }
    catch(err) {
      // Is there some properties in obj we can't access? Print it red.
      if(typeof(err) == 'string') msg = err;
      else if(err.message)        msg = err.message;
      else if(err.description)    msg = err.description;
      else                        msg = 'Unknown';
      str += '(Error) ' + property + ': ' + msg +"\n";
    }
  }
  str += "\n";
  return str;
}

Array.prototype.compare = function(testArr) {
    if (this.length != testArr.length) return false;
    for (var i = 0; i < testArr.length; i++) {
        if (this[i].compare) {
            if (!this[i].compare(testArr[i])) return false;
        }
        if (this[i] !== testArr[i]) return false;
    }
    return true;
}
String.prototype.StripQuotes = function() {
	return this.replace(/"/g,'');
}
String.prototype.entityTrans = { '&':'&amp;', '<':'&lt;',  '>':'&gt;',  '\"':'&quot;', '\'':'&#039', '<':'\\u003c', '/':'\\/', '\\':'\\\\', '\"':'\\\"'};
String.prototype.htmlSpecialChars = function() {
  var ret = this.toString();
  for (k in this.entityTrans)
     ret  = ret.split(k).join(this.entityTrans[k]);
  return ret;
}
String.prototype.htmlSpecialCharsDecode = function() {
  var ret = this.toString();
  for (k in this.entityTrans)
     ret = ret.split(this.entityTrans[k]).join(k);
  return ret;
}
String.prototype.trim = function () {
    return this.replace(/^\s*/, "").replace(/\s*$/, "");
}
String.prototype.stripTags = function(){
	return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi, '');
}

String.prototype.capitalize = function(){
	return this.charAt(0).toUpperCase() + this.substring(1).toLowerCase();
}

String.prototype.htmlEntities = function() {
  var ret = this.toString();
  for (k in this.entityTrans)
     ret  = ret.split(k).join(this.entityTrans[k]);
  return ret;
}

function objectName (o){
  var s = o.toString();
  return s.substr(7,s.length-8);
}

function matTypeof (v){
  if (v == undefined)
    return 'undefined';
  if (typeof (v) == 'object'){
    if (!v)
      return 'null';
    else if (v.constructor.toString().indexOf("Array")>=0 && typeof(v.splice)=='function')
      return 'array';
    else return 'object';
  }
  return typeof (v);
}

function tbodyScroller (tbody, maxHeight){  
  tbody.style.maxHeight = '';
  tbody.style.height = '';
  tbody.style.overflowX = 'hidden';
  if (parseInt(tbody.clientHeight) > maxHeight){
    tbody.style.height = maxHeight + 'px';
    tbody.style.maxHeight = maxHeight + 'px';
    tbody.style.overflowY = 'auto';
  }
}
function getRemainingHeight (e, cont){
  var ec = getClientCoords(e);
  var cc = getClientCoords(cont);
  return cont.clientHeight - (ec.y - cc.y);
}

function addCommasInt(n){
  nStr = parseInt(n) + '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(nStr)) {
    nStr = nStr.replace(rgx, '$1' + ',' + '$2');
  }
  return nStr;
}

function addCommas(nStr){
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1 + x2;
}



function unixTime (){
  return parseInt (new Date().getTime() / 1000) + unsafeWindow.g_timeoff;
}
function htmlOptions (a, curVal){
  m = '';
  for (k in a)
    m += '<OPTION value="'+ k +'"'+ (k==curVal?' SELECTED':'')  +'>'+ a[k] +'</option>';
  return m;
}
function getFunctionName (func){
  var name=/\W*function\s+([\w\$]+)\(/.exec(func);
  if (!name)
    return '';
  return name[1];
}

function DateStringToSortString(sDate, sFormat) {
	// sFormat: 'DD Mon YYYY' or 'Mon DD, HH:MM AM'
	var ShortMths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
	if (sFormat == 'DD Mon YYYY') {
		var DD = sDate.substr(0,2);
		var Mon = sDate.substr(3,3);
		var Year = sDate.substr(7,4);
		var Hour = '00';
		var Min = '00';
	} else if (sFormat == 'Mon DD, HH:MM AM') {
		var DD = sDate.substr(4,2);
		var Mon = sDate.substr(0,3);
		var Year = '0000';
		var Hour = sDate.substr(8,2);
		var Min = sDate.substr(11,2);
		if (sDate.substr(14,2) == 'PM')
			Hour = '' + (12 + parseInt(Hour));
	}
	var i = ShortMths.indexOf(Mon) + 1
	Mon = '' + ((i < 10)?"0" + i:"" + i);
	return Year+Mon+DD+Hour+Min;
}

function thouormil(value,roundToK){
	if (value == 0)
		return '0';
	else if (value == '')
		return '';
	else if (value != parseFloat(value))
		return value;
	var val=value;
	if (roundToK && val > 9999)
		val = 1000 * Math.round(val/1000);
	if ((val%1000000)==0)
		return addCommas(val/1000000)+'m';
	else if ((val%1000)==0)
		return addCommas(val/1000)+'k';
	else
		return addCommas(val);
}

function shorten(value){
	var myvalue = parseInt(value);
	if (myvalue < 99999999)
		return addCommasInt(myvalue);
	else if (myvalue == '')
		return '';
	else
		return addCommasInt(myvalue/1000000) + 'm';
}

function findAllBetween (txt, find1, find2){
  var m = [];
  var last = 0;
  while ( (i1=txt.indexOf(find1, last))>=0 && (i2=txt.indexOf (find2, i1))>=0 ) {
    m.push (txt.substring(i1+find1.length, i2));
    last = i2 + find2.length;
  }
  return m;
}

function strUpTo (s, find){
  var i = s.indexOf(find);
  if (i > 0)
    return s.substr(0, i);
  return s;
}

/********
 Xd Xh
 Xh Xm
 Xm Xs
 Xs
********/
function timestrShort(time) {
  time = parseInt (time);
  if (time > 86400){
    var m = [];
    time /= 3600;
    m.push (parseInt(time/24));
    m.push ('d ');
    m.push (parseInt(time%24));
    m.push ('h ');
    return m.join ('');    
  } else
    return timestr (time);
}

/**********************
 part       full
 Xd Xh Xm   Xd Xh Xm Xs
 Xh Xm      Xh Xm Xs
 Xm Xs      Xm Xs
 Xs         Xs
**********************/
function timestr(time, full) {
  time = parseInt (time);
  var m = [];
  var t = time;
  if (t < 61)
    return  t + 's';
  if (t > 86400){
    m.push (parseInt(t/86400));
    m.push ('d ');
    t %= 86400;
  }  
  if (t>3600 || time>3600){
    m.push (parseInt(t/3600));
    m.push ('h ');
    t %= 3600;
  }  
  m.push (parseInt(t/60));
  m.push ('m');
  if (full || time<=3600 ){
    m.push (' ');
    m.push (t%60);
    m.push ('s');  
  }
  return m.join ('');
}

function timestrcolon(time) {
	seconds = parseInt (time);
	var t, u;
	var secs86400 = seconds % 86400;
	var numhours = Math.floor(secs86400 / 3600);
	t = '00' + numhours;
	t = t.substr(t.length-2,2) + ':';
	var numminutes = Math.floor((secs86400 % 3600) / 60);
	u = '00' + numminutes;
	t += u.substr(u.length-2,2) + ':';
	var numseconds = (secs86400 % 3600) % 60;
	u = '00' + numseconds;
	t += u.substr(u.length-2,2);
	return t;
}

function tidyKnightCombat (cityId, knightId, knightCombat) {
	var tidyCombat = '???';
	if (typeof (knightCombat) == 'string')
		tidyCombat = ((knightId == 0)?'':knightCombat);
	else {
		var k = Seed.knights['city'+cityId]['knt'+knightId];
		if (k == undefined)
			tidyCombat = '';
		else
			tidyCombat = k.combat;
	}
	return tidyCombat;
}

function fetchOtherAllianceInfo(pageNum, notify) { // as in alliance list, sorted by rank, 10 per page
	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	params.pageNo = pageNum;
	params.cityId = unsafeWindow.currentcityid;
	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetOtherInfo.php" + unsafeWindow.g_ajaxsuffix, {
		method: "post",
		parameters: params,
		onSuccess: function (rslt) {
			notify (rslt);
		},
		onFailure: function (rslt) {
			notify ({errorMsg:'AJAX error'});
		},
	});
}

function storeAllianceNames(rslt) {
	if (!rslt.ok){
		document.getElementById('allListOut').innerHTML = rslt.errorMsg;
		return;
	}
	var currentPage=parseInt(rslt.currentPage);
	var maxPage=parseInt(rslt.noOfPages);

	for (var i=0; i<rslt.otherAlliances.length; i++) {
		allianceName[parseInt(rslt.otherAlliances[i].allianceId)]=rslt.otherAlliances[i].name;
	}
	GM_log(currentPage+' of '+maxPage);
	if (currentPage < 5) // maxPage
		fetchOtherAllianceInfo(currentPage+1,storeAllianceNames);
	else {
		for (var k=0; k<allianceName.length; k++) {
			if (allianceName[k] != undefined)
				GM_log(k+':'+allianceName[k]);
		}
	}
}

/************  LIB singletons .... **************/
// TODO: fix REopening window
var WINLOG_MAX_ENTRIES = 1000;     // TODO
var WinLog = {
  state : null,
  win: null,
  eOut : null,
  lastE : null,
  enabled : true,
  reverse : true,
  busy : false,
isOpening : false,

  open : function (){
    var t = WinLog;

    function eventButClear(){
      var t = WinLog;
      t.lastE = null;
      t.eOut.innerHTML ='';
    }
    function eventButReverse(){
      var t = WinLog;
      if (t.busy)
        return;
      t.busy = true;
      if (t.reverse){
        t.win.document.getElementById('wlRev').value= 'Top';
        t.reverse = false;
      } else{
        t.win.document.getElementById('wlRev').value= 'Bottom';
        t.reverse = true;
      }
      var n = t.eOut.childNodes.length;
      if (n < 2)
        return;
      for (i=n-2; i>=0; i--){
        t.eOut.appendChild (t.eOut.childNodes[i]);
      }
      t.busy = false;
    }
    
    if (!t.win || t.win.closed){
t.isOpening = true;  
// Firefox bug??? It appears as if a new thread is started on open, withOUT reusing same window? huh?
      t.win = window.open('', 'uwtrace', 'top=30,left=0,width=900,height=700,scrollbars=no,location=no,menubar=no,directories=no,status=no');
	  t.win.show(true);
t.isOpening = false;
t.state = null;
    }
    
    if (t.state == null){
      t.win.document.body.innerHTML = '<STYLE>pre{margin:0px} hr{margin:3px; height:1px; border:0px; color:#cee; background-color:#cee}</style>\
        <BODY style="margin:0px; padding:0px; border:none">\
        <DIV id=winlogtop style="background-color:#d0d0d0; margin:0px; padding:0px; border:1px solid">\
        <INPUT id=wlClear type=submit value="Clear"> &nbsp; <INPUT id=wlRev type=submit value="Bottom"></div>\
        <DIV id=wlOut style="overflow-y:auto; height:100%; max-height:100%"></div></body>';
      t.win.document.getElementById('wlClear').addEventListener('click', eventButClear, false);
      t.win.document.getElementById('wlRev').addEventListener('click', eventButReverse, false);
      t.eOut =  t.win.document.getElementById('wlOut');
      t.lastE = null;
      t.state = 1;
    }
  },

  writeText : function (msg){
    WinLog.write (msg.htmlEntities()); 
  },
  
  write : function (msg){
    var t = WinLog;
    if (!t.enabled || t.isOpening)
      return;
    t.open();
    var te = document.createElement('pre');
    var now = new Date();
    var m = [];
    var millis = now.getMilliseconds();
    m.push (now.toTimeString().substring (0,8));
    m.push ('.');
    if (millis<100)
      m.push('0');
    if (millis<10)
      m.push('0');
    m.push(millis);
    m.push (': ');
    m.push (msg);
    te.innerHTML = m.join('');
    if (t.reverse){
      if (t.lastE == null){
        t.eOut.appendChild(te);
        t.lastE = te;
      } else {
        t.eOut.insertBefore(te, t.lastE);
      }
      var hr = document.createElement('hr');
      t.eOut.insertBefore(hr, te);
      t.lastE = hr;
    } else {
      t.eOut.appendChild(te);
      t.eOut.appendChild(document.createElement('hr'));
    }
  },

};

function getAllianceLeaders (){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetLeaders.php" + unsafeWindow.g_ajaxsuffix, {
		 method: "post",
		 parameters: params,
		 loading: true,
		 onSuccess: function (rslt) {
		 rslt = eval("(" + rslt.responseText + ")");
		 if (rslt.officers) {
			 Options.AllianceLeaders = [];
      		 for (add in rslt.officers) Options.AllianceLeaders.push(rslt.officers[add]['userId']);
       
     } 
     else {
			  setTimeout(function(){getAllianceLeaders;}, 1500);
		  }
		},
		onFailure: function () {}
  		});
};

function addCommasWhole(nStr){
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1;
}

function encode_utf8( s ){
  return unescape( encodeURIComponent( s ) );
}

function decode_utf8( s ){
  return decodeURIComponent( escape( s ) );
}

function CdialogCancelContinue (msg, canNotify, contNotify, centerElement){
  var pop = new CPopup ('ptcancont', 10, 10, 400,200, true, canNotify);
  if (centerElement)
    pop.centerMe(centerElement);
  else
    pop.centerMe(document.body);
  pop.getTopDiv().innerHTML = '<div class=showBadged><center>Koc PowerKoc</center></div>';
  pop.getMainDiv().innerHTML = '<TABLE class=ptTab align=center style="height: 100%"><TR align=center height=90%><TD>'+ msg +'</td></tr>\
      <TR align=center><TD><INPUT id=ptok type=submit value="OK" \> &nbsp; &nbsp; </td></tr></table>';
  document.getElementById('ptok').addEventListener ('click', function (){pop.destroy(false); if (canNotify) canNotify();}, false);
  pop.show(true);
}

function CdialogConfirm (msg, canNotify, contNotify, centerElement){
  var pop = new CPopup ('ptcancont', 10, 10, 400,200, true, canNotify);
  if (centerElement)
    pop.centerMe(centerElement);
  else
    pop.centerMe(document.body);
  pop.getTopDiv().innerHTML = '<div class=showBadged><center>PowerKoc</center></div>';
  pop.getMainDiv().innerHTML = '<TABLE class=ptTab align=center style="height: 100%"><TR align=center height=90%><TD colspan=2>'+ msg +'</td></tr>\
      <TR align=center><TD><INPUT id=pbok type=submit value="OK" \> &nbsp; &nbsp; </td><TD><INPUT id=pbcancel type=submit value="CANCEL" \> &nbsp; &nbsp; </td></tr></table>';
  document.getElementById('pbok').addEventListener ('click', function (){pop.destroy(false); if (canNotify) canNotify(this);}, false);
  document.getElementById('pbcancel').addEventListener ('click', function (){pop.destroy(false); if (canNotify) canNotify(this);}, false);
  pop.show(true);
}

function hexDump (dat){
  var i = 0;
  var s = [];
  while (i < dat.length) {
    asc = [];
    s.push (hex4(i));
    s.push (': ');
    for (var ii=0; ii<16; ii++) {
      c = dat.charCodeAt(i+ii);
      s.push (hex2(c));
      s.push (' ');
      if (c>31 && c<128)
        asc.push (dat.charAt(i+ii));
      else
        asc.push ('.');
    }
    s.push ('  ');
    s.push (asc.join(''))
    s.push ('\n');
    i += 16;
  }
  return s.join ('');
  function hex4(d){
    return hexDig(d>>12) + hexDig(d>>8) + hexDig(d>>4) + hexDig(d&15);
  }
  function hex2(d){
    return hexDig(d>>4) + hexDig(d&15);
  }
  function hexDig (d){
    hexdigs = '0123456789ABCDEF';
    return hexdigs.charAt(d&15);      
  }
}
 
function SliderBar (container, width, height, value, classPrefix, margin){
  var self = this;
  this.listener = null;
  if (value==null)
    value = 0;
  if (!margin)
    margin = parseInt(width*.05);
  this.value = value;
  if (width<20) width=20;
  if (height<5) height=5;
  if (classPrefix == null){
    classPrefix = 'slider';
    var noClass = true;
  }      
  var sliderHeight = parseInt(height/2);  
  var sliderTop = parseInt(height/4);
  this.sliderWidth = width - (margin*2);
    
  this.div = document.createElement ('div');  
  this.div.style.height = height +'px';
  this.div.style.width = width +'px';
  this.div.className = classPrefix +'Cont';
  if (noClass)
    this.div.style.backgroundColor='#ddd';
  
  this.slider = document.createElement ('div');
  this.slider.setAttribute ('style', 'position:relative;');
  this.slider.style.height = sliderHeight + 'px'
  this.slider.style.top = sliderTop + 'px';
  this.slider.style.width = this.sliderWidth +'px';
  this.slider.style.left = margin +'px';   
  this.slider.className = classPrefix +'Bar';
  this.slider.draggable = true;
  if (noClass)
    this.slider.style.backgroundColor='#fff';
  
  this.sliderL = document.createElement ('div');
  this.sliderL.setAttribute ('style', 'width:100px; height:100%; position:relative; ');
  this.sliderL.className = classPrefix +'Part';
  this.sliderL.draggable = true;
  if (noClass)
    this.sliderL.style.backgroundColor='#0c0';
  
  this.knob = document.createElement ('div');
  this.knob.setAttribute ('style', 'width:3px; position:relative; left:0px; background-color:#222');
  this.knob.style.height = height +'px';
  this.knob.style.top = (0-sliderTop) +'px';
  this.knob.className = classPrefix +'Knob';
  this.knob.draggable = true;
  this.slider.appendChild(this.sliderL);
  this.sliderL.appendChild (this.knob);
  this.div.appendChild (this.slider);
  container.appendChild (this.div);
  this.div.addEventListener('mousedown',  mouseDown, false);

  this.getValue = function (){
    return self.value;
  }

  this.setValue = function (val){   // todo: range check
    var relX = (val * self.sliderWidth);
    self.sliderL.style.width = relX + 'px';
    self.knob.style.left =  relX + 'px';
    self.value = val;
    if (self.listener)
      self.listener(self.value);
  }
  
  this.setChangeListener = function (listener){
    self.listener = listener;
  }

  function moveKnob (me){
    var relX = me.clientX - self.divLeft;
    if (relX < 0)
      relX = 0;
    if (relX > self.sliderWidth)
      relX = self.sliderWidth;
    self.knob.style.left = (relX - (self.knob.clientWidth/2) ) +'px';   // - half knob width !?!?
    self.sliderL.style.width = relX + 'px';
    self.value =  relX / self.sliderWidth;   
    if (self.listener)
      self.listener(self.value);
  }
  function doneMoving (){
    self.div.removeEventListener('mousemove', mouseMove, true);
    document.removeEventListener('mouseup', mouseUp, true);
  }  
  function mouseUp (me){
    moveKnob (me);
    doneMoving();
  }
  
  function mouseDown(me){
    var e = self.slider;
    self.divLeft = 0;
    while (e.offsetParent){   // determine actual clientX
      self.divLeft += e.offsetLeft;
      e = e.offsetParent;
    }
    moveKnob (me);
    document.addEventListener('mouseup',  mouseUp, true);
    self.div.addEventListener('mousemove',  mouseMove, true);
  }
  function mouseMove(me){
    moveKnob (me);
  }
}

function pause(milliseconds) {
	var dt = new Date();
	while ((new Date()) - dt <= milliseconds) { /* Do nothing */ }
}


function CmatSimpleSound (playerUrl, container, attrs, onLoad, flashVars) {
  var self = this;
  this.player = null;
  this.volume = 100;
  this.isLoaded = false;
  this.onSwfLoaded = null;
  
  var div = document.createElement ('div');
  this.onSwfLoaded = onLoad;
  if (navigator.appName.toLowerCase().indexOf('microsoft')+1) {
    div.innerHTML = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="movie" value="'+playerUrl+'"><param name="quality" value="high"></object>';
    this.player = div.getElementsByTagName('object')[0];
  } else {
    div.innerHTML = '<embed src="'+playerUrl+'"  bgcolor="#eeeeee" allowfullscreen=false FlashVars="'+ flashVars +'" quality="high" allowscriptaccess="always" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" ></embed>';
    this.player = div.getElementsByTagName('embed')[0].wrappedJSObject;
  }
  if (container)
    container.appendChild (div);
  else
    document.body.appendChild (div);
  for (k in attrs)
    this.player.setAttribute(k, attrs[k]);
       
  this.setVolume = function (chanNum, vol){
    if (!self.isLoaded)
      return;
    self.player.jsSetVolume (chanNum, vol);
    volume = vol;
  }
  
  this.load = function (chanNum, url, bStream, bAutoplay, bUsePolicyFile){   // loop ?
    self.player.jsLoad (chanNum, url, bStream, bAutoplay, bUsePolicyFile);
  }
  
  this.play = function (chanNum, position){
    self.player.jsPlay (chanNum, position);
  }
    
  this.stop = function (chanNum){
    self.player.jsStop (chanNum);
  }
    
  this.getStatus = function (chanNum){           // returns null if sound channel is 'empty'
    return self.player.jsGetStatus (chanNum);
  }
  
  this.debugFunc = function (msg){  // overload to use
  }
      
  this.swfDebug = function (msg){    // called by plugin
    self.debugFunc('SWF: '+ msg);
  }
  this.swfLoaded = function (){    // called by plugin when ready to go!
    self.isLoaded = true;
    self.debugFunc ('playerIsReady');
    if (self.onSwfLoaded)
      self.onSwfLoaded();
  }
  this.swfPlayComplete = function (chanNum){    // called by plugin when a sound finishes playing (overload to be notified)
  }
  this.swfLoadComplete = function (chanNum, isError){    // called by plugin when a sound finishes loading  (overload to be notified)
  }
}
	
function DoUnsafeWindow(func, execute_by_embed) {
	if(this.isChrome || execute_by_embed) {
		var scr=document.createElement('script');
		scr.innerHTML=func;
		document.body.appendChild(scr);
	} else {
		try {  
			eval("unsafeWindow."+func);
		} catch (error) {
			logit("A javascript error has occurred when executing a function via DoUnsafeWindow. Error description: "+error.description);
		}
	}
}	

function GetDisplayName(){
	var DisplayName = document.getElementById('topnavDisplayName');
	if(DisplayName){
		DisplayName = DisplayName.innerHTML;
	}else{
		DisplayName = null;
	}
	return DisplayName
}

function DrawLevelIcons() {
	var maptileRe = /modal_maptile.([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+)/;
	var mapwindow=document.getElementById('mapwindow');
	if(!mapwindow) return;
	var levelIcons=document.getElementById('LevelIcons');
	if(levelIcons) return;

	var ss=document.evaluate(".//a[contains(@class,'slot')]",mapwindow,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
	var lvRe=/_([0-9]+)/;
	var idDone=false;
	for(var s=0; s<ss.snapshotLength; s++) {
		var a=ss.snapshotItem(s);
		var onclick=a.getAttribute('onclick');
		var owner='';
		if(onclick) {
			var onclickM=maptileRe.exec(onclick);
			if(onclickM && onclickM[6]!='"null"') {
				var might=onclickM[7].StripQuotes();
				var alliance=onclickM[15].StripQuotes();
				var dip=getDiplomacy(alliance);
				owner=" "+onclickM[6].StripQuotes();
			}
		}
		var m=lvRe.exec(a.className);
		if(!m) continue;
		var sp=a.getElementsByTagName('span');
		if(sp.length==0) continue;

		if(!idDone) { a.id='levelIcons'; idDone=true; }
		sp[0].style.color='#cc0';
		
		if (alliance == 'null' && onclickM[12]=='"city"') sp[0].style.color='#33CCFF';
		if (dip == 'hostile' && onclickM[12]=='"city"') sp[0].style.color='#FF0000';
		if (onclickM[12]!='"city"' &&  onclickM[6]!='"null"') sp[0].style.color='#FF9900';
		if (onclickM[12]!='"city"' &&  onclickM[5]=='"null"' && onclickM[6]=='"null"' && onclickM[7]=='"null"' && onclickM[8]=='"null"' && onclickM[15]=='"null"' && onclickM[10]=='"null"') sp[0].style.color='#CC0033';
		if (Options.MapShowExtra) {
			if (onclickM && onclickM[6]!='"null"' ) sp[0].innerHTML='&nbsp;'+m[1]+owner+'<br />Might:'+addCommas(might);
			else sp[0].innerHTML='&nbsp;'+m[1]+addCommas(owner);
		}
		else {  
			if (onclickM && onclickM[6]!='"null"' ) sp[0].innerHTML='&nbsp;'+m[1];
			else sp[0].innerHTML='&nbsp;'+m[1]+addCommas(owner);
		}
		
	}

}

function ThroneItemName(e) {

  return e.createPrefix()+" "+e.type+" "+e.faction+" +"+e.level;
 
}

function getMarchInfo (){
  var ret = {};

  ret.marchUnits = [];
  ret.returnUnits = [];
  ret.resources = [];
  for (i=0; i<13; i++){
    ret.marchUnits[i] = 0;
    ret.returnUnits[i] = 0;
  }
  for (i=0; i<5; i++){
    ret.resources[i] = 0;
  }

  var now = unixTime();

  for(i=0; i<Cities.numCities; i++) {   // each city
    cityID = 'city'+ Cities.cities[i].id;
    for (k in Seed.queue_atkp[cityID]){   // each march
      march = Seed.queue_atkp[cityID][k];
      if (typeof (march) == 'object'){
        for (ii=0; ii<13; ii++){
          ret.marchUnits[ii] += parseInt (march['unit'+ ii +'Count']);
          ret.returnUnits[ii] += parseInt (march['unit'+ ii +'Return']);
        }
        for (ii=1; ii<5; ii++){
          ret.resources[ii] += parseInt (march['resource'+ ii]);
        }
          ret.resources[0] += parseInt (march['gold']);
      }
    }
  }
  return ret;
}

function AjaxRequest2 (url, opts){
    var headers = {
        'X-Requested-With': 'XMLHttpRequest',
        'X-Prototype-Version': '1.6.1',
        'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
    };
    var ajax = null;   
    if (window.XMLHttpRequest)
      ajax=new XMLHttpRequest();
    else
      ajax=new ActiveXObject("Microsoft.XMLHTTP");   
    if (opts.method==null || opts.method=='')
      method = 'GET';
    else
      method = opts.method.toUpperCase();    
    if (method == 'POST'){
        headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
    } else if (method == 'GET'){
        addUrlArgs (url, opts.parameters);
    }    
    ajax.onreadystatechange = function(){
        if (ajax.readyState==4) {
            if (ajax.status >= 200 && ajax.status < 305)
            if (opts.onSuccess) opts.onSuccess(ajax);
            else
                if (opts.onFailure) opts.onFailure(ajax);
            } else {
                if (opts.onChange) opts.onChange (ajax);
            }
    }    
    ajax.open(method, url, true); // always async!
    for (var k in headers)
      ajax.setRequestHeader (k, headers[k]);
     if (matTypeof(opts.requestHeaders)=='object')
          for (var k in opts.requestHeaders)
            ajax.setRequestHeader (k, opts.requestHeaders[k]);
    if (method == 'POST'){
        var a = [];
        for (k in opts.parameters){
              if(matTypeof(opts.parameters[k]) == 'object'){
                  for(var h in opts.parameters[k]){
                      if(matTypeof(opts.parameters[k][h]) == 'object'){
                          for(var i in opts.parameters[k][h]){
                              if(matTypeof(opts.parameters[k][h][i]) == 'object'){
                              for(var j in opts.parameters[k][h][i]){
                                  a.push (k+'['+h+']['+i+']['+j+'] ='+ opts.parameters[k][h][i][j] );
                              }
                              } else
                              	a.push (k+'['+h+']['+i+']'+' ='+ opts.parameters[k][h][i]);
                          }
                      } else
                      a.push (k+'['+h+'] ='+ opts.parameters[k][h] );
                  }
              } else
              a.push (k +'='+ opts.parameters[k] );
        }
        ajax.send (a.join ('&'));
    } else {
        ajax.send();
    }
}

var DeleteReports = {
    deleting : false,
    deletes1 : new Array(),
    deletes0 : new Array(),
    timer:null,
    init : function(){
		var t = DeleteReports;
		clearInterval(t.timer);
		if(!t.deleting && (Options.DeleteMsg || Options.DeleteMsgs0 || Options.DeleteMsgs4 || Options.DeleteMsgs5 || Options.DeleteMsgs6 || Options.DeleteMsgs1 || Options.DeleteMsgs2 || Options.DeleteMsgs3)){
		 if (parseIntNan(Options.DeleteTimerMinute)<2) Options.DeleteTimerMinute=2;
		 t.timer = setInterval(t.startdeletereports, Options.DeleteTimerMinute*60000);
		}
    },	
	
    startdeletereports : function(){
		var t = DeleteReports;
		t.deletes1 = new Array();
		t.deletes0 = new Array();
	  	if(!t.deleting && (Options.DeleteMsg || Options.DeleteMsgs0 || Options.DeleteMsgs4 || Options.DeleteMsgs5 || Options.DeleteMsgs6 || Options.DeleteMsgs1 || Options.DeleteMsgs2 || Options.DeleteMsgs3)){
	  		t.deleting = true;
	  		t.fetchreport(0, t.checkreports);
	  	}
    },
    
    fetchreport : function(pageNo, callback){
		var t = DeleteReports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		if(pageNo > 1)
			params.pageNo = pageNo;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				callback(rslt,pageNo);
			},
				onFailure: function () {
				callback();
			},
		});
    },
	
    checkreports : function(rslt, pageNo){
		var t = DeleteReports;
//		actionLog("Informes", ""+culang.reportDelete+" "+(pageNo+1)+"/"+rslt.totalPages+" "+culang.reportDelete2+"");
		if(!rslt.ok){
			return;
		}
		if(rslt.arReports.length < 1){
			return;
		}
		var reports = rslt.arReports;
		var totalPages = rslt.totalPages;
	
		for(k in reports){
			if(Options.DeleteMsg){
				if((reports[k].marchType==9 || reports[k].marchType==4) && reports[k].side0PlayerId==0 && reports[k].side0TileType > 50)
					t.deletes1.push(k.substr(2));
				else if(reports[k].marchType==1 && t.isMyself(reports[k].side1PlayerId))
					t.deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs0){
				if(reports[k].marchType==1 && !t.isMyself(reports[k].side1PlayerId)) {
					t.deletes0.push(k.substr(2));
				}
			}
			if (Options.DeleteMsgs1){
				if(reports[k].marchType==4 && (reports[k].side0TileType <= 50)&& reports[k].side0PlayerId==0)
					t.deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs2){
				if(reports[k].side0TileType==54)
					t.deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs3){
				if(reports[k].side0TileType==51 && reports[k].marchType==2 && t.isMyself(reports[k].side0PlayerId))
					t.deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs4){
				if(reports[k].side0TileType==51 && reports[k].marchType==3)
					t.deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs5){
				if(reports[k].side0TileType==51 && reports[k].marchType==4)
					t.deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs6){
		         for(var i = 0; i < CrestData.length; i++) {
					x= CrestData[i].X;
					y= CrestData[i].Y;
					if (reports[k].side0XCoord == x && reports[k].side0YCoord == y) {
					 t.deletes1.push(k.substr(2));
					}
		
					
		         }
		        }
		}
		if ((pageNo+1)==totalPages || parseInt(pageNo+1)>10) {
		
		if(t.deletes1.length > 0 || t.deletes0.length > 0){
			t.deleteCheckedReports(t.deletes1, t.deletes0);
		} else {
			actionLog("Report", "No removal of required reports");
			t.deleting = false;
			return;
		}
		
		} else {
		  t.fetchreport(pageNo+1, t.checkreports);
		}
    },

    deleteCheckedReports : function(deletes1, deletes0){
		var t = DeleteReports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.s1rids = deletes1.join(",");
		params.s0rids = deletes0.join(",");
		params.cityrids = '';
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if(rslt.ok){
					Seed.newReportCount = parseInt(Seed.newReportCount) - parseInt(deletes1.length) - parseInt(deletes0.length);
					actionLog("report", "Clearing "+(parseInt(deletes1.length)+parseInt(deletes0.length))+" automatically reports");
				} else {
				  actionLog("report", "Error deleting reports : "+ rslt.msg);
				}
				t.deleting = false;
			},
			onFailure: function () {
			 actionLog("Report "," Error deleting reports : "+ rslt.msg);
			 t.deleting = false;
			},
		});
    },	
    isMyself: function(userID){
		var t = DeleteReports;
		if(!Seed.players["u"+userID])
			return false;
		if(Seed.players["u"+userID].n == Seed.player.name)
			return true;
		else
			return false;
		return false;
    },
}

   

var RepairAuto = {
 timer : null,
 repairtimer: null,
 init: function (){
     if (!Options.salvageconfig.Repairrunning) return;
     if (upgradeData.active == true) { 
      upgradeData.active = false;
      saveUpgradeData();
      //return;
     }
     RepairAuto.setEnable();
  },
 setEnable: function (){
     var t = RepairAuto;
     clearTimeout (t.repairtimer);
     t.tableau=[];
     t.repairtimer = setTimeout (t.count, 1*1000);
 },
 
 count:function() {
  var t = RepairAuto;
  var lignauto = Seed.throne.rowNum * 5, i=uW.kocThroneItems;
  var nbl=0;
  t.tableau=[];
  clearTimeout (t.repairtimer);
   if (!Options.salvageconfig.Repairrunning) return;
   
  for (var z in i) {
       if (i[z].id) {
        e=uW.kocThroneItems[i[z].id];
        if (e) {
	nbl++;
	if (e.isBroken && nbl<=lignauto ) {
	  if (Seed.queue_throne) {
	   if (Seed.queue_throne.itemId!=e.id)
	     t.tableau.push(i[z].id); 
	  } else {
	   t.tableau.push(i[z].id);
	  }
	}   
       }
    }	
  }
  var timeLeft=-1;
  if (Seed.queue_throne) {
         if (Seed.queue_throne.end)
            timeLeft = Seed.queue_throne.end - uW.unixtime();
  }
  if (t.tableau.length>0 && timeLeft<0) {
     var itemId = t.tableau[Math.floor(Math.random()*t.tableau.length)];
     actionLog("Throne", "Repair " + uW.kocThroneItems[itemId].name + " - are: " + t.tableau.length + "");
     t.repair(itemId);
  } else {
   if (timeLeft>0) {
    actionLog("Throne", "You can only repair 1 item, wait "+timeLeft+"s +5");
    t.repairtimer = setTimeout (t.count, (timeLeft+5)*1000);
   } else {
    actionLog("Throne", "There are no items to clear - wait 5 minutes...");
    t.repairtimer = setTimeout (t.count, (5*60)*1000);   
   }
  }
 },
 
 repairId:0,
 repariend:null,
 countRepair:0,
 clearRepair:function() {
   var t = RepairAuto;
     if (t.repairId != 0) {
		unsafeWindow.kocThroneItems[t.repairId].isBroken = false;
		unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
		t.repairId = 0;
   	      }
 },
 repair: function(id) {
    var t = RepairAuto; 
    clearTimeout (t.repairtimer);
    if (!Options.salvageconfig.Repairrunning) return;
    if (uW.kocThroneItems[id]) {
        var params = uW.Object.clone(uW.g_ajaxparams);
        params.action="timeRepair";
        params.ctrl="throneRoom\\ThroneRoomServiceAjax";
        params.throneRoomItemId=id; 
        uW.ajax.Request(uW.g_ajaxpath+"ajax/_dispatch53.php"+uW.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
         onSuccess:function(transport) {
          var m = eval("(" + transport.responseText + ")");
          if (m.ok === true){
           Seed.queue_throne.start = uW.unixtime();
           Seed.queue_throne.end = m.eta; //uW.unixtime() + L;
           Seed.queue_throne.itemId = id;
           t.repairId = id;
	   t.repairend = m.eta;
	   unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
	   var x = m.eta - unixTime();
	   setTimeout(t.clearRepair, (x+1)*1000);
           t.countRepair=0;
           duree= Seed.queue_throne.end - Seed.queue_throne.start + 5;
           actionLog("throne", "Repair ok " + ThroneItemName(uW.kocThroneItems[id]) + " - are: " +duree +"sec");
            t.repairtimer = setTimeout (t.count, (duree)*1000);
           } else {
            t.countRepair++;
            actionLog("throne", "<font color=red>Failed to repair</font> " + ThroneItemName(uW.kocThroneItems[id]) );
            if (t.countRepair>5) {
              t.countRepair=0; 
              t.repairtimer = setTimeout (t.count, (2*60)*1000);
            } else {
              setTimeout(function() { t.repair(id); },2000);
            }
            
           }
         }
    });
    
   } else {
     actionLog("throne", "Not found repair ID");
     t.repairtimer = setTimeout (t.count, (2*60)*1000);
   }
  },
}


   /****Request**/
   var KoC = {
	_ServerID: null,
	getServerId: function () {
		if (this._ServerID == null) {
			var m = /^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
			if (m)
				this._ServerId = m[1];
			else
				this._ServerId = '??';
		}
		return this._ServerId;
	},

	_PlayerName: null,
	getPlayerName: function () {
		if (this._PlayerName == null) {
			var e = Tools.getElementByXPath("//*[@id='topnavDisplayName']");
			_PlayerName = e.text;
		};
		return this._PlayerName;
	}
};


   var Tools = {
	getElementByXPath: function (expr) {
		var d = document;
		var elmFirstResult = d.evaluate(expr, document,
			null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
		return elmFirstResult;
	},

	click: function (element) {
		if (element == null) throw "Element not specified!";
		var evt = document.createEvent("MouseEvents");
		evt.initMouseEvent("click", true, true, window,
			0, 0, 0, 0, 0, false, false, false, false, 0, null);
		var canceled = !element.dispatchEvent(evt);
		if (canceled) {
			// A handler called preventDefault
		} else {
			// None of the handlers called preventDefault
		}
	},

	typeKeys: function (element, char) {
		try {
			for (var i = 0; i < char.length; i++) {
				// Create the key press event.
				var pressEvent = document.createEvent('KeyboardEvent');
				pressEvent.initKeyEvent("keypress", true, true, window,
					false, false, false, false,
					0, char.charCodeAt(i));

				element.dispatchEvent(pressEvent); // Press the key.
			}
		}
		catch (e) {
			alert("Your browser does not support this example!");
		}
	},

	type: function (element, char) {
		try {
			if (element.type == 'text') {
				element.focus();
				element.value = char;
			} else {
				alert("Unknown element!");
			}
		} catch (e) {
			alert("Your browser does not support this example!");
		}
	}
};

   
   ResourceRequest = {
	Destination: "xxx,yyy",
	Type:"Mineral",
	Amount:"50 kk"
};

var Selenium = {

	click: function (locator) {
		logit("Selenium: click | " + locator);
		var elmt = this.getElementNoLog(locator);
		if (elmt == null) {
			throw "Element not found (" + locator + ")";
		}
		Tools.click(elmt);
	},

	getAttribute: function (attributeLocator) {
		logit("Selenium: getAttribute | " + attributeLocator);
		var index = attributeLocator.lastIndexOf('@');
		var locator = attributeLocator.substr(0, index);
		var attribute = attributeLocator.substring(index + 1, attributeLocator.length);
		var elmt = this.getElement(locator);
		var attrValue = elmt.getAttribute(attribute);
		return attrValue;
	},

	getElementNoLog: function (locator) {
		if (locator.search('//') == 0) return Tools.getElementByXPath(locator);
		if (locator.search('xpath=') == 0) return Tools.getElementByXPath(locator.substr(6, locator.length - 6));
		var elmt = document.getElementById(locator); if (elmt != null) return elmt;
		return document.getElementsByName(locator);
	},

	getElement: function (locator) {
		logit("Selenium: getElement | " + locator);
		return this.getElementNoLog(locator);
	},

	getElementPresentNoLog: function (locator) {
		return this.getElementNoLog(locator) != null;
	},
	getElementPresent: function (locator) {
		logit("Selenium: getElementPresent | " + locator);
		return this.getElementNoLog(locator) != null;
	},

	waitforElementPresent: function (locator) {
		logit("Selenium: waitforElementPresent | " + locator);
		var tot = new Date().getTime() + 30000;
		do {
			if (this.getElementPresentNoLog(locator)) return true;
		} while (new Date().getTime() < tot)
		throw "Timeout on waiting for element!";
	}

};

var Builder = {
	BlueButton: function (caption, onclick) {
		var a = document.createElement('a');
		if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
		else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
		else throw "Invalid argument!";
		a.setAttribute("class", "button20");
		var span = document.createElement('span');
		a.appendChild(span);
		span.appendChild(document.createTextNode(caption));
		return a;
	},
	BlueTab: function (caption, onclick) {
		var a = document.createElement('a');
		a.addEventListener("click", onclick, true);
		a.setAttribute("class", "tab");
		a.appendChild(document.createTextNode(caption));
		return a;
	},

	Html: function (html) {
		var span = document.createElement('span');
		span.innerHTML = html;
		return span;
	},

	Element: function (elementName, innerElement) {
		var elmt = document.createElement(elementName);
		if (innerElement != null) elmt.appendChild(innerElement);
		return elmt;
	}
};

 function InitResourceRequest() {
	var div = document.createElement('div');
	div.style.fontSize = 'small';
	div.style.textAlign = 'left';
	div.style.borderBottom = '1px solid silver';
	div.style.margin = '0 0 0 10px';
	div.appendChild(Builder.BlueButton(" request ", atResourceRequestClick));
		div.appendChild(Builder.Html("<input id='rrDestination' type='text' size='7' maxlength='7' /><select id='rrType' ><option>gold</option><option>food</option><option>wood</option><option>stone</option><option selected='selected'>Ore</option></select><input id='rrAmount' type='text' size='7' maxlength='7'/>"));

	var e = Tools.getElementByXPath("//*[@class='comm_body comm_global']/form");
	e.parentNode.insertBefore(div, e);
	
	var s = GM_getValue("ResourceRequest_" + KoC.getServerId());
	var rrDestination = Tools.getElementByXPath("//*[@id='rrDestination']");
	var rrType        = Tools.getElementByXPath("//*[@id='rrType']");
	var rrAmount      = Tools.getElementByXPath("//*[@id='rrAmount']");
	if (s != null) {
		var rr = JSON2.parse(s);
		rrDestination.value = rr.Destination;
		rrType       .value = rr.Type;
		rrAmount     .value = rr.Amount;
	} else {
		rrDestination.value = "xxx,yyy";
		rrType       .value = "Mineral";
		rrAmount     .value = "50 kk";
	}
};

function atResourceRequestClick() {
	var rrDestination = Tools.getElementByXPath("//*[@id='rrDestination']").value;
	var rrType        = Tools.getElementByXPath("//*[@id='rrType']").value;
	var rrAmount      = Tools.getElementByXPath("//*[@id='rrAmount']").value;

	ResourceRequest.Amount = rrAmount;
	ResourceRequest.Type = rrType;
	ResourceRequest.Destination = rrDestination;

	GM_setValue("ResourceRequest_" + KoC.getServerId(), JSON2.stringify(ResourceRequest));

	var e = Tools.getElementByXPath("//*[@id='mod_comm_input']");
	if (e == null) { alert("XPath no encontrado!"); return; }
	Tools.type(e, "/a need someone to send me " + rrType + " a " + rrDestination + " if possible " + rrAmount + ", thank you !!");
	var b = e.nextSibling;
	Tools.click(b);
}

function estETA(dist, unit, cityID, typemarche) {
 var ret={ETA:0,etaStr:'N/D',friendETA:0,friendEtaStr:'N/D'};    
 if (dist <= 0) return ret;
 var troop_type = unit;
 var horse=0;
 if(troop_type>6) horse=1;
 var troop_speed=parseInt(unsafeWindow.unitstats["unt"+troop_type][3])*(1+0.1*parseInt(Seed.tech.tch11));
 if (horse){
               troop_speed=troop_speed*(1+0.05*parseInt(Seed.tech.tch12))
 } 
 var Speed = troop_speed;
  var throne67=EffetTronePrc(67).percent;
  var throne68,throne69,throne70,throne71,throne72;throne68=throne69=throne70=throne71=throne72=0;
  if(typemarche==4){
   throne68=EffetTronePrc(68).percent // attaque
  }else{
   if(typemarche==3){ //eclaireur
    throne72=EffetTronePrc(72).percent
   }else{
    if(typemarche==2){ //renforce
     throne69=EffetTronePrc(69).percent
    }else{
     if(typemarche==5){ // reassign
      throne71=EffetTronePrc(71).percent
     }else{
      if(typemarche==1){ // transport
       throne70=EffetTronePrc(70).percent
       }}}}}
       
  var throneBoost=throne67+throne68+throne69+throne70+throne71+throne72;
 
 Speed=Speed*(1+(throneBoost*0.01));
 
 var gi=unsafeWindow.cm.guardianModalModel.getMarchBonus();
 var multiplier=1+(gi*0.01);
 Speed=Speed*multiplier;
 var gSpeed = 0;
 var estSec;
 if (Speed>0) {
  gSpeed = Speed/6000;
  estSec = Math.ceil(parseFloat(dist)/gSpeed);
 }

 var e=1;
 if (ById("BOitem_55")) {
  var l_elem=ById("BOitem_55");
  if(l_elem&&l_elem.checked>0){ e=0.75;     }
 }
 if (ById("BOitem_57")) {
  var l_elem=ById("BOitem_57");
  if(l_elem&&l_elem.checked){   e=0.5;   }
 }
 ret.ETA = (parseInt((estSec*e+''))+30); 
 if(Seed.playerEffects.returnExpire>unsafeWindow.unixtime()){
  ret.ETA=parseInt(ret.ETA*0.5);
 }
 ret.etaStr = timestr (ret.ETA,1);
 if (cityID!=0) {
  var building = getCityBuilding (cityID, 18);
  if (building) {
   fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
   gSpeed = fSpeed/6000;
   estSec = (dist/gSpeed).toFixed(0);
   ret.friendETA = parseInt((estSec*e+''))+30; 
   ret.friendEtaStr = timestr ((ret.friendETA+''),1);
  }
 } else {
  ret.friendETA = ret.ETA; 
  ret.friendEtaStr = timestr ((ret.friendETA+''),1);
 }
 return ret;
}

function EffetTronePrc(effet) {
  var k=Seed.throne.slotEquip[Seed.throne.activeSlot],i=Seed.throne.inventory,e,faction;
  var B=0, w={}, x, C;
  for (var K in k) {
 	     var F = uW.kocThroneItems[k[K]];
 	     if (F) {
 	               x=0;
 	               for (var M in F.effects) {
 	               x++;
 	               if (F.quality >= x) {
 	                B++;
 	                I = uW.cm.thronestats.effects[F.effects[M].id];
 	                z = uW.cm.thronestats.tiers[F.effects[M].id][F.effects[M].tier];
 	                C = + z.base + (F.level * F.level + F.level) * + z.growth * 0.5;
 	                //C = C;
 	                if (!F.isBroken) { 
 	                   if (!w[F.effects[M].id]) {
 	                     w[F.effects[M].id] = {};
 	                     w[F.effects[M].id].nameitem="";
 	                   }
 	                   if (!w[F.effects[M].id].percent) { 
 	                     w[F.effects[M].id].percent = C; 
 	                   } else {
 	                    w[F.effects[M].id].percent += C; 
 	                   }
 	                   w[F.effects[M].id].name = I[1];
 	                }
 	               }
 	               }
 	               }
           }
           if (!w[effet]) {
           
            w[effet]={};
            w[effet].percent=0;
            
           }
 return w[effet];
}

function scan_allianceChat() {
	try {		
		var reqStyle = "background: lightgreen";

		div = Selenium.getElement("mod_comm_list2");
		for (var i = 0; i < div.childNodes.length; i++) {
			var msgdiv = div.childNodes[i];
			if (msgdiv.getAttribute("style") == reqStyle) return;
			if (msgdiv.innerHTML.indexOf('*Request*')==-1) continue;
			for (var j = 0; j < msgdiv.childNodes.length; j++) {
				var txdiv = msgdiv.childNodes[j];
				if (txdiv.innerHTML.indexOf('*Request*') == -1) continue;
				var actiondiv = document.createElement('div');
				var tReq = txdiv.textContent;
				var t1 = tReq.indexOf("*Request*");
				tReq = tReq.substring(t1, tReq.length);
				var t2 = tReq.indexOf("'");
				if (t2 >= 0) tReq = tReq.substr(0, t2);
				
				var tAck = tReq.replace('*Request*', "*Confirmed*");
				var tDly = tReq.replace('*Request*', "*Delivered*");
				var cA = "var chat = document.getElementById('mod_comm_input'); chat.value = '" + tAck + "';chat.focus();return false;";
				var cD = "var chat = document.getElementById('mod_comm_input'); chat.value = '" + tDly + " / ??min';chat.focus();return false;";
				actiondiv.appendChild(Builder.BlueButton("*Confirmed*", cA));
				actiondiv.appendChild(Builder.BlueButton("*Delivered*", cD));
				msgdiv.appendChild(actiondiv);
				msgdiv.setAttribute("style", reqStyle);
			}
		}
	} catch (err) {
		alert(err);
	}
}

/*********************************** DOMAIN BREAK IN TAB ***********************************/
Tabs.DbIn = {
tabOrder: 10000,
tabDisabled : false,
tabLabel : 'Domain',
myDiv : null,
init: function(div){
var t = Tabs.DbIn;
t.myDiv = div;
var m = '<DIV class=pbStat>Domain Breakin!!</div><TABLE width=100% height=0% class=pbTab><TR align="center">';
m += '<CENTER><br> Lord or Lady?: <INPUT id=pbLordLadyt type=submit value="Lord"></center>';
m += '<CENTER><br> Name: <INPUT id=pbNewName type=text size=10 value="YourNameHere" maxlength=10 \> </center>';
m += '<CENTER><br>Domain: <INPUT id=pbNewDomain type=text size=3 value="0" maxlength=3 \> </center>';
m += '<CENTER><br><INPUT id=pbJoinDomain type=submit value="Join"></center>';
t.myDiv.innerHTML = m
document.getElementById('pbLordLadyt').addEventListener('click', function(){if (this.value == "Lord") {this.value = "Lady"} else {this.value = "Lord"}},false);
document.getElementById('pbJoinDomain').addEventListener ('click', function(){t.newdomain(document.getElementById('pbLordLadyt').value,document.getElementById('pbNewName').value,document.getElementById('pbNewDomain').value)}, false);
},
hide : function (){
},
show : function (){
},
toggleLordLady: function(obj){
},
newdomain : function (Sex,Name,Domain){
var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
params.pf =0;
params.displayname=Name;
if (Sex == "Lord") {
params.gender='M';
} else {
params.gender='F';
};
params.portrait=1;
params.server=Domain;
params.inviter=0;
params.gid=0;
params.hid=0;
GM_xmlhttpRequest({
method: 'POST',
url: "http://www"+Domain+".kingdomsofcamelot.com/fb/e2/src/ajax/initPlayer.php" + unsafeWindow.g_ajaxsuffix,
headers: {
'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
},
onload:function(rslt) {
alert(rslt.responseText);
},
data: implodeUrlArgs(params),
});
},
}

/*********************************** Stealth TAB ***********************************/
Tabs.ss = {
tabOrder: 800,
tabDisabled : false,
tabLabel : 'Smokescreen',
MyCities	:	new Array(),
myDiv : null,
xcoord : 0,
ycoord : 0,
init: function(div){
var t = Tabs.ss;
t.myDiv = div;
var m = '<DIV class=pbStat>FLOOD A TARGETS TOWERS WITH SCOUTS!!</div><TABLE width=100% height=30% class=pbTab><TR align="center">';
m += '<CENTER><br>x coords? <INPUT id=pbssxcoords type=text size=3 value="0" maxlength=3 \> </center>';
m += '<CENTER><br>y coords? <INPUT id=pbssycoords type=text size=3 value="0" maxlength=3 \> </center>';
m += '<CENTER><br><INPUT id=pbssattack type=submit value="LAUNCH SMOKESCREEN ATTACKS"> </center>';
m += '<TD align=right><INPUT id=pbShowStealthHelp type=submit value="HELP"></td>';
t.myDiv.innerHTML = m;
document.getElementById('pbShowStealthHelp').addEventListener('click', function(){
		t.helpPop(this);
    }, false);
       
    document.getElementById('pbssattack').addEventListener ('click', function(){t.smokescreen(document.getElementById('pbssxcoords').value,document.getElementById('pbssycoords').value)}, false);
},
  
  
  helpPop : function (){
    var helpText = '<BR><DL><dt>Stealth:<dd><LI>If you want to have a better shot at getting kills you may try to hide your main attack force....</dd>\
    	<dd><LI>This lets you enter the location of an enemy and then flood them with many many many waves of 1 troop marches to hide your real force.</dd>\
        <dd><LI>Fill in the X and Y coord of your target.</dd>\
          <dd><LI>Click the Launch Smoke Screen Attacks button and it launches a batch of multiple wave smokescreen attacks to clog the enemies towers.</dd></ul>';
    var pop = new pbPopup ('giftHelp', 0, 0, 550, 250, true);
    pop.centerMe (mainPop.getMainDiv());  
    pop.getMainDiv().innerHTML = helpText;
    pop.getTopDiv().innerHTML = '<CENTER><B>Power Bot Help</b>:  Stealth Attacking</center>';
    pop.show (true);
  },
hide : function (){
},
show : function (){
},
smokescreen : function (xcoord, ycoord) {
var t = Tabs.ss;
t.xcoord = xcoord;
t.ycoord = ycoord;
for (var i=0;i<Seed.cities.length;i++){
var sccity = Seed.cities[i][0];
var rallypointlevel = 0;
for (var o in Seed.buildings['city'+sccity]){
var buildingType = parseInt(Seed.buildings['city'+sccity][o][0]);
var buildingLevel = parseInt(Seed.buildings['city'+sccity][o][1]);
if (buildingType == 12) rallypointlevel=parseInt(buildingLevel);
};
var slots=0;
for (aa in Seed.queue_atkp['city'+sccity]) {
slots++;
};
if (slots == 39)
slots = 12;
for (var aa = slots; aa <= rallypointlevel;aa++) {
	if (parseInt(Seed.units['city'+sccity]['unt3']) > 10) 
t.MyCities.push(sccity);
};


};
t.doattack();
},
doattack : function () {
var t = Tabs.ss;
if(t.MyCities[0] == null)
return;

var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
params.cid=t.MyCities.shift();
params.type=3;
params.xcoord = t.xcoord;
params.ycoord = t.ycoord;
params.u3= 1;
		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
			 method: "post",
			 parameters: params,
			 loading: true,
			 onSuccess: function (transport) {
			 var rslt = eval("(" + transport.responseText + ")");
			 if (rslt.ok) {
			 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
			 var ut = unsafeWindow.unixtime();
			 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 for(i = 0; i <= unitsarr.length; i++){
				if(params["u"+i]){
				unitsarr[i] = params["u"+i];
				}
			 }
			 var currentcityid = params.cid;
			 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, 0, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
			 unsafeWindow.update_seed(rslt.updateSeed)
			 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
		   } else {
			if(rslt.user_action){
				new CdialogCancelContinue('<SPAN class=boldRed>CAPTCHA ALERT! You have been sending too many attacks!</span>', null, null, mainPop.getMainDiv);

			}
			 }
			 },
			 onFailure: function () {
				 }
			 
			 
  		 });
setTimeout (function() {t.doattack()}, 5000);
},
}

/****************************  Population Control Tab  ******************************/
Tabs.popcontrol = {
  tabOrder : 850,
  tabDisabled : false,
  tabLabel : 'Pop Control',
  myDiv : null,
  timer : null,
  timer_del : null,
  timer_cycle : null,
	del_count : 0,
	cycle_running : false,
	busy : false,
	cycle_step : 0,

  logtable : null,
  logmaxEntries: 300,
  loglast99 : [],
  poptab_troop_dismiss : 1,
  last_ran : 'train',


  init : function (div)
  	{
		var t = Tabs.popcontrol;
		t.myDiv = div;
		var selbut=0;
		
		var m = '<DIV class=pbStat>Population Control</div>';

		m += '<table border=0 width="100%">';	
		m += '<tr align=center>';
		m += '<td align=left><input type=submit id=pophelp_button value="HELP!"></td>';
		m += '<td align=center>Pick City:<span id=popcity></span></td>';
		m += '<td align=center>Population Gain per cycle: <span id=poptab_cycle_pop></span></td>';
		m += '<td align=center> Troops to dismiss: <select id=poptab_troop_dismiss><option value=1>ST</option><option value=2>MM</option><option value=3>Scout</option><option value=4>Pike</option><option value=5>Sword</option><option value=6>Archer</option></select>';
		m += '</tr>';
		m += '</table>';
		
		m += '<DIV class=pbStat>City Requirements:</div>';
		m += '<table border="0" width="100%">';		
		m += '<tr>';
		m += '<td>Current Food: &nbsp<span id=poptab_cur_food></span></td>';
		m += '<td>Current Wood: &nbsp<span id=poptab_cur_wood></span></td>';
		m += '<td>Current Ore: &nbsp&nbsp<span id=poptab_cur_ore></span></td>';
		m += '<td>Current dismissable troops: <span id=poptab_cur_mm></span></td>';
		m += '</tr>';
		m += '<tr>';
		m += '<td>Needed Food: &nbsp<span id=poptab_needed_food></span></td>';
		m += '<td>Needed Wood: &nbsp<span id=poptab_needed_wood></span></td>';
		m += '<td>Needed Ore: &nbsp&nbsp<span id=poptab_needed_ore></span></td>';
		m += '<td>Needed dismissable troops: <span id=poptab_needed_mm></span></td>';
		m += '</tr>';
		m += '</table>';

		m += '<DIV class=pbStat>City Status:</div>';
		m += '<table border="0" width="100%">';	
		m += '<tr align=center>';
		m += '<td>Maximum Idle Population: <span id=poptab_max_idle_pop></span></td>';
		m += '<td># Slots Used: <span id=poptab_slots_used></span><br></td>';
		m += '<td># of barracks: <span id=poptab_barracks></span></td>';
		//m += '<td> </td>';
		m += '</tr>';
		m += '<tr align=center>';
		m += '<td>Current Idle Population: <span id=poptab_cur_idle_pop></span></td>';
		m += '<td># Slots Free: <span id=poptab_slots_free></span></td>';
		m += '<td># of cottages: <span id=poptab_cottages></span></td>';
		//m += '<td> </td>';
		m += '</tr>';		
		m += '</table>';

		m += '<DIV class=pbStat>Commands:</div>';
		m += '<table border="0" width="100%">';	
		m += '<tr align=center>';
		m += '<td><input type="submit" id="poptab_dismiss_mm" value="Dismiss troops" disabled></td>';
		m += '<td><input type="submit" id="poptab_queue_st" value="Queue Supply Troops" disabled></td>';
		m += '<td><input type="submit" id="poptab_del_queues" value="Delete All Queues" disabled></td>';
		m += '<td><input type="submit" id="poptab_run_cycle" value="Run cycle" disabled></td>';
		//m += '<td><input type="submit" id="poptab_test" value="Test"></td>';
		m += '</tr>';		
		m += '</table>';
	
		m += '<DIV class=pbStat>Action Log:</div>';

		m += '<DIV style="height:250px; max-height:250px; overflow-y:auto">';
		m += '<TABLE cellpadding=0 cellspacing=0 id=poptab_log class=pbTabLined>';
		m += '<TR><TD></td><TD width=95%></td>';
		m += '</table></div>';

		t.myDiv.innerHTML = m;

		t.logtable = document.getElementById('poptab_log');  
		var a = JSON2.parse(GM_getValue ('poptab_log_'+getServerId(), '[]'));
		if (matTypeof(a) == 'array')
			{
			t.loglast99 = a;
			for (var i=0; i<t.loglast99.length; i++)		t.addlogrow (t.loglast99[i].msg, t.loglast99[i].ts);
			}
		window.addEventListener('unload', t.onUnload, false);

		t.tcp = new CdispCityPicker ('popcityselect', document.getElementById('popcity'), true, null, selbut);
		
		document.getElementById('pophelp_button').addEventListener		('click', function(){	t.helpPop(this);							} , false);
		document.getElementById('popcity').addEventListener						('click', function(){	t.show_city	(t.tcp.city.id);	} , false);
		document.getElementById('poptab_dismiss_mm').addEventListener	('click', function(){	t.dismiss_mm(t.tcp.city.id);	} , false);
		document.getElementById('poptab_queue_st').addEventListener		('click', function(){	t.queue_st	(t.tcp.city.id);	} , false);
		document.getElementById('poptab_del_queues').addEventListener	('click', function(){	t.del_queues_start(t.tcp.city.id);	} , false);
		document.getElementById('poptab_run_cycle').addEventListener	('click', function(){	t.run_cycle	(t.tcp.city.id);	} , false);
		//document.getElementById('poptab_test').addEventListener	('click', function(){	t.btest	();	} , false);
 	    	document.getElementById('poptab_troop_dismiss').addEventListener('change', function(){t.poptab_troop_dismiss = document.getElementById('poptab_troop_dismiss').value;} , false);
  
  	},

	disable_btns : function ()
		{
		var t = Tabs.popcontrol;
		t.busy = true;
		document.getElementById('poptab_del_queues'	).disabled = true;
		document.getElementById('poptab_queue_st').disabled = true;
		document.getElementById('poptab_dismiss_mm').disabled = true;
		document.getElementById('poptab_run_cycle').disabled = true; 
		},

	onUnload : function ()
		{
		var t = Tabs.popcontrol;
		//if (!ResetAll) GM_setValue ('log_'+getServerId(), JSON2.stringify(t.last50));
		GM_setValue ('poptab_log_'+getServerId(), JSON2.stringify(t.loglast99));
		},
    
	addlogrow : function (msg, ts)
		{
		var t = Tabs.popcontrol;
		if (t.logtable.rows.length >= t.maxEntries)	t.logtable.deleteRow(t.maxEntries-1);
		var row = t.logtable.insertRow(0);
		row.vAlign = 'top';
		row.insertCell(0).innerHTML = ts;
		row.insertCell(1).innerHTML = msg;
		},
  
	log : function (msg)
		{
		var t = Tabs.popcontrol;
		var ts = new Date().toTimeString().substring (0,8);
		for (postcity in Seed.cities) if (Seed.cities[postcity][0] == t.tcp.city.id) logcity = Seed.cities[postcity][1];
		msg = logcity + ": " + msg;
		t.addlogrow (msg, ts);
		while (t.loglast99.length >= 99)
		t.loglast99.shift();
		t.loglast99.push ({msg:msg, ts:ts});
		},

  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.popcontrol;
    clearTimeout (t.timer);
  },
  
  show : function (){         // called whenever this tab is shown
    var t = Tabs.popcontrol;
    clearTimeout (t.timer);
    t.timer = setTimeout (t.show, 2000);
		t.show_city(t.tcp.city.id);
  },

	helpPop : function ()
		{
		var helpText = "";
		
		helpText += '<p>** This is a work in progress... If it gets stuck, refresh. By ADABman / Lurkin **';
		helpText += 'Probably a good idea to temporarily turn off auto transport, auto reassign, and auto train, when using this.';
		
		helpText += '<p>POPULATION CONTROL tab will help you convert your excess/useless millitiamen ';
		helpText += 'into massive amounts of idle population. Massive idle population is very useful ';
		helpText += 'to have before a might tournament starts, or if you want to do a massive siege ';
		helpText += 'build with a Merlins tutelage.';
		helpText += '</p>';
		
		helpText += '<p>The CITY REQUIREMENTS area displays the amount of resouces and Militiamen ';
		helpText += 'required for a \'full cycle\' of building massive idle population. If any of these ';
		helpText += 'requirements are not met, they will be displayed in red.';
		helpText += '</p>';
		
		helpText += '<p>The CITY STATUS area displays the maximum amount of population your cottages ';
		helpText += 'provide, and the current amount of idle population in your city. This area also ';
		helpText += 'shows the number of training queue slots total and in use.';
		helpText += '</p>';
		
		helpText += '<p>The COMMANDS area displays the buttons that automate this process:';
		helpText += '</p>';

		helpText += '<UL>';
		
		helpText += 'DISMISS MM BUTTON<BR><li>' + dismissBtn_help1 + '</li>';
		helpText += '<li>' + dismissBtn_help2 + '</li><BR>';
		
		helpText += 'QUEUE SUPPLY TROOP BUTTON<BR><li>' + queueBtn_help1 + '</li>';
		helpText += '<li>' + queueBtn_help2 + '</li><BR>';
		
		helpText += 'DELETE QUEUE BUTTON<BR><li>' + deleteBtn_help1 + '</li>';
		helpText += '<li>' + deleteBtn_help2 + '</li>';
		helpText += '<li>' + deleteBtn_help3 + '</li><BR>';
		
		helpText += 'RUN CYCLE BUTTON<BR><li>' + runcycleBtn_help1 + '</li>';
		helpText += '<li>' + runcycleBtn_help2 + '</li>';
		helpText += '<li>' + runcycleBtn_help3 + '</li><BR>';
	
		helpText += '</UL><BR>';
		
		//function CPopup (prefix, x, y, width, height, enableDrag, onClose)
		var pop = new pbPopup ('popcontrol_Help', 0, 0, 740, 600, true);
		pop.centerMe (mainPop.getMainDiv());  
		pop.getMainDiv().innerHTML = helpText;
		pop.getTopDiv().innerHTML = '<CENTER><B>Power Bot Help</b>:  Population Control</center>';
		pop.show (true);
		},

	show_city : function (cityId)
		{
		var t = Tabs.popcontrol;

		t.st_food = 50;
		t.st_wood = 150;
		//t.st_stone = 0;
		t.st_ore = 10;
		
		var green = '#03F003';
		var red =   '#F0303';

		t.max_idle_pop = (parseInt(Seed.citystats['city'+cityId].pop[1])).toFixed(0);
		t.cur_idle_pop = (parseInt(Seed.citystats['city'+cityId].pop[0])).toFixed(0);
		document.getElementById('poptab_max_idle_pop').innerHTML	= t.max_idle_pop;
		document.getElementById('poptab_cur_idle_pop').innerHTML	= t.cur_idle_pop;

		t.barracks = parseInt(getCityBuilding(cityId, 13).count);
		t.cottages = parseInt(getCityBuilding(cityId, 5).count);
		t.slots_used = parseInt(Seed.queue_unt['city'+cityId].length);
		t.slots_free = parseInt(t.barracks - t.slots_used);
		document.getElementById('poptab_barracks').innerHTML = t.barracks;
		document.getElementById('poptab_cottages').innerHTML = t.cottages;
		document.getElementById('poptab_slots_used').innerHTML = t.slots_used;
		document.getElementById('poptab_slots_free').innerHTML = t.slots_free;

		t.cycle_pop = (parseInt(t.barracks) * parseInt(t.max_idle_pop)) + (parseInt(t.max_idle_pop) * 2);
		document.getElementById('poptab_cycle_pop').innerHTML	= addCommas( t.cycle_pop / 2 );

//		var now = unixTime();
//		var knights = Seed.knights["city" + cityId];
//		if (knights)
//			{
//			var comKniId = parseInt(Seed.leaders['city' + cityId].combatKnightId);
//			if (comKniId)
//				{
//				var comValue = parseInt(Seed.knights['city' + cityId]['knt' + comKniId].combat);
//				var comBoost = parseInt(Seed.knights['city' + cityId]['knt' + comKniId].combatBoostExpireUnixtime);
//				if ((comBoost - now) > 0)	{	comValue = parseInt(comValue * 1.25);	}
//				} 
//			else	{	comValue = 0;	}
//			}
//		else	{	comValue = 0;	}
//		t.marshal_combat = comValue;
//		document.getElementById('poptab_marshal').innerHTML = t.marshal_combat;

		t.cur_food = parseInt(Seed.resources['city'+cityId].rec1[0]/3600);
		t.cur_wood = parseInt(Seed.resources['city'+cityId].rec2[0]/3600);
		//t.cur_stone = parseInt(Seed.resources['city'+cityId].rec3[0]/3600);
		t.cur_ore = parseInt(Seed.resources['city'+cityId].rec4[0]/3600);
		
		document.getElementById('poptab_cur_food').innerHTML = addCommas (t.cur_food);
		document.getElementById('poptab_cur_wood').innerHTML = addCommas (t.cur_wood);
		//document.getElementById('poptab_cur_stone').innerHTML = addCommas (t.cur_stone);
		document.getElementById('poptab_cur_ore').innerHTML = addCommas (t.cur_ore);
		
		t.needed_food = parseInt(t.cycle_pop) * parseInt(t.st_food);
		t.needed_wood = parseInt(t.cycle_pop) * parseInt(t.st_wood);
		//t.needed_stone = 0;//parseInt(t.cycle_pop) * parseInt(t.st_Stone);
		t.needed_ore = parseInt(t.cycle_pop) * parseInt(t.st_ore);
		
		document.getElementById('poptab_needed_food').innerHTML = addCommas (t.needed_food);
		document.getElementById('poptab_needed_wood').innerHTML = addCommas (t.needed_wood);
		//document.getElementById('poptab_needed_stone').innerHTML = addCommas (t.needed_stone);
		document.getElementById('poptab_needed_ore').innerHTML = addCommas (t.needed_ore);
		
		document.getElementById('poptab_needed_food').style.color = (t.needed_food  > t.cur_food?'red':'green');
		document.getElementById('poptab_cur_food').style.color = (t.needed_food  > t.cur_food?'red':'green');
		document.getElementById('poptab_needed_wood').style.color  = (t.needed_wood  > t.cur_wood?'red':'green');
		document.getElementById('poptab_cur_wood').style.color = (t.needed_wood  > t.cur_wood?'red':'green');
		//document.getElementById('poptab_needed_stone').style.color = (t.needed_stone > t.cur_stone?'red':'green');
		//document.getElementById('poptab_cur_stone').style.color = (t.needed_stone > t.cur_stone?'red':'green');
		document.getElementById('poptab_needed_ore').style.color = (t.needed_ore  > t.cur_ore?'red':'green');
		document.getElementById('poptab_cur_ore').style.color = (t.needed_ore  > t.cur_ore?'red':'green');

		t.needed_mm = t.cycle_pop;
		t.cur_mm = parseInt(Seed.units['city'+cityId]['unt' + t.poptab_troop_dismiss]);
		document.getElementById('poptab_needed_mm').innerHTML = addCommas(t.needed_mm);
		document.getElementById('poptab_cur_mm').innerHTML = addCommas(t.cur_mm);
		
		document.getElementById('poptab_needed_mm').style.color = (t.needed_mm  > t.cur_mm?'red':'green')
		document.getElementById('poptab_cur_mm').style.color = (t.needed_mm  > t.cur_mm?'red':'green')
		
		dismissBtn_help1 = "This button is used to quickly get your city to its maximum idle population allowed by dismissing just the right amount of militiamen.";
		dismissBtn_help2 = "This button will only light up when when your city is not at its maximum population, and then only if you have enough MM in your city to dismiss.";
		need_to_dismiss = parseInt(t.max_idle_pop - t.cur_idle_pop);
		dismissBtn = document.getElementById('poptab_dismiss_mm');
		if(parseInt(need_to_dismiss) > 0 && parseInt(need_to_dismiss) <= parseInt(t.cur_mm) && !t.busy && !t.cycle_running)
			{
			dismissBtn.disabled = false;
			dismissBtn.value = "Dismiss " + addCommas(need_to_dismiss) + " Troops";
			}
		else
			{
			dismissBtn.disabled = true;
			dismissBtn.value = "Dismiss Troops";
			}

		queueBtn_help1 = "This button is used to train all the idle population into Supply Troops.";
		queueBtn_help2 = "This button will only light up when your city is at full idle population, and then only if you have enough resources to train all those Supply Troops and at least 1 free training slot.";
		unitId = 1;	
		var res_ok = 0;
		for (var i = 1; i < 5; i++)
			{
			var res_need = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(t.cur_idle_pop);
			var res_have = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]);
			if(parseInt(res_need) > parseInt(res_have))	{	res_ok++;	}
			}
		queueBtn = document.getElementById('poptab_queue_st');
		if(parseInt(t.slots_free) > 0 && parseInt(t.cur_idle_pop) >= parseInt(t.max_idle_pop) && parseInt(res_ok)==0 && !t.busy && !t.cycle_running)
			{
			queueBtn.disabled = false;
			queueBtn.value = "Queue " + addCommas(t.cur_idle_pop) + " Supply Troops";
			}
		else
			{
			queueBtn.disabled = true;
			queueBtn.value = "Queue Supply Troops";
			}

		deleteBtn_help1 = "This button is used to quickly delete all those queued up Supply Troops, returning 1/2 the used population (and resources?).";
		deleteBtn_help2 = "This button will only light up when there is at least 1 training queue slot used.";
		//deleteBtn_help3 = "** Due to a bug, you should refresh your game before using this button! **";
		deleteBtn_help3 = "If you have any problems with this button, refresh and try again.";
		deletebtn = document.getElementById('poptab_del_queues'	);
		if(Seed.queue_unt['city'+cityId].length > 0 && !t.busy && !t.cycle_running)
			{
			deletebtn.disabled = false;
			deletebtn.value = " Delete " + Seed.queue_unt['city'+cityId].length + " Queues";
			}
		else
			{
			deletebtn.disabled = true;
			deletebtn.value = "Delete All Queues";
			}

		runcycleBtn_help1 = "This button is used to automate the entire process of repeatedly dismissing Militiamen then queueing Supply Troops, and then finally delete all of those queues.";
		runcycleBtn_help2 = "This button will only light up when your city has the required amount of resources and Militiamen";
		//runcycleBtn_help3 = "------ This button is disabled for now. -----";
		runcycleBtn_help3 = "If the queue slots wont delete, refresh and hit the 'Delete All Queues' button.";
		res_ok = 0;
		t.cycle_pop_continue = (parseInt(t.slots_free) * parseInt(t.max_idle_pop)) + (parseInt(t.max_idle_pop) * 2);
		for (var i = 1; i < 5; i++)
			{
			var res_need = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(t.cycle_pop_continue);
			var res_have = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]);
			if(parseInt(res_need) > parseInt(res_have))	{	res_ok++;	}
			}
		runcycleBtn = document.getElementById('poptab_run_cycle');
		//if(parseInt(t.cur_idle_pop) >= parseInt(t.max_idle_pop) && parseInt(res_ok)==0 && !t.busy && !t.cycle_running)
		t.needed_mm_continue = t.cycle_pop_continue;
		if(parseInt(t.needed_mm) <= parseInt(t.cur_mm) && parseInt(res_ok)==0 && !t.busy && !t.cycle_running)
			{
			runcycleBtn.disabled = false;
			}
		else
			{
			runcycleBtn.disabled = true; 
			}
		
		},

	run_cycle : function (cityId)
		{
		// Temp disable auto train for this city & auto reassign & auto transport & auto refresh
		// log all that
		// here dan
		
		var t = Tabs.popcontrol;
		clearTimeout (t.timer);
		clearTimeout (t.timer_cycle);
		t.disable_btns();
		if(!t.cycle_running)
			{
			t.log("Starting population build cycle. Population at start: " + t.cur_idle_pop);
			t.cycle_running = true;
			t.cycle_step = 1;
			}
		
		//t.actionlog("1");
		t.max_idle_pop = (parseInt(Seed.citystats['city'+cityId].pop[1])).toFixed(0);
		t.cur_idle_pop = (parseInt(Seed.citystats['city'+cityId].pop[0])).toFixed(0);
		//num = parseInt(t.max_idle_pop) - parseInt(t.cur_idle_pop);
		if(parseInt(t.cur_idle_pop) < parseInt(t.max_idle_pop))	// Need to Dismiss MM
			{
			if (t.cycle_running && t.last_ran == 'train') {
				t.dismiss_mm(cityId);
				t.last_ran = 'dismiss';
			} else {
				t.timer_cycle = setTimeout (function() {t.run_cycle(cityId)}, 1500);
			}
				
			
			//t.actionlog("2");
			}
		else if(parseInt(t.slots_free) > 0 && parseInt(t.cur_idle_pop) >= parseInt(t.max_idle_pop)) // Need to queue supply troops
			{
			if (t.cycle_running)	{
				t.queue_st(cityId);
				t.last_ran = 'train';
			}
			//t.actionlog("3");
			}
		else if(parseInt(t.slots_free) == 0)	// Delete all the queues
			{
			//t.actionlog("4");
			t.cycle_running = false;
			setTimeout(unsafeWindow.update_seed_ajax, 250);
			t.del_queues_start(t.tcp.city.id);
			t.timer = setTimeout (t.show, 1000);
			return;
			}
		else
			{
			t.log("Waiting...");	// Wait
			}
		//t.actionlog("5");
		setTimeout(unsafeWindow.update_seed_ajax, 250);
		t.timer_cycle = setTimeout (function() {t.run_cycle(cityId)}, 1500);
		},

	dismiss_mm : function (cityId)
		{
		var t = Tabs.popcontrol;
		t.disable_btns();
		
		unitId = t.poptab_troop_dismiss;

		t.max_idle_pop = (parseInt(Seed.citystats['city'+cityId].pop[1])).toFixed(0);
		t.cur_idle_pop = (parseInt(Seed.citystats['city'+cityId].pop[0])).toFixed(0);
		num = parseInt(t.max_idle_pop) - parseInt(t.cur_idle_pop);
		//t.log(num);
		
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.cid = cityId;
		params.type = unitId;
		params.quant = num;

		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/dismissUnits.php" + unsafeWindow.g_ajaxsuffix,
			{
			method: "post",
			parameters: params,
			onSuccess: function(rslt)
				{
				if (rslt.ok) 
					{
 					//t.log("Dismissed "+ addCommas(num) +" "+ troops[unitId]);
					t.log("Dismissed "+ addCommas(num) +" Troops");
					Seed.units['city'+cityId]['unt'+unitId] -= num;
					if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
					//setTimeout(unsafeWindow.update_seed_ajax, 250);
					t.busy = false;
					t.show_city(cityId);
					
					// Dismiss gets back 1/2 res ?
					//for (var i = 1; i < 5; i++)
					//	{
					//	var resourceGain = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(num) / 2;
					//	unsafeWindow.seed.resources["city" + cityId]["rec" + i][0] = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]) + resourceGain;
					//	}
					}
				else
					{
					//t.log("FAILED to dismiss "+ addCommas(num) +" "+ troops[unitId] + " :(");
					t.log("FAILED to dismiss "+ addCommas(num) +" Militiamen :(");
					t.busy = false;
					}
				},
			});		
		setTimeout(unsafeWindow.update_seed_ajax, 250);
		},

	queue_st : function (cityId)
		{
		var t = Tabs.popcontrol;
		t.disable_btns();

		unitId = 1;
		num = t.cur_idle_pop;
		//num = 15;
		
		var time = unsafeWindow.modal_barracks_traintime(unitId, num);
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.cid = cityId;
		params.type = unitId;
		params.quant = num;
		params.gambleId = 0;

		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/train.php" + unsafeWindow.g_ajaxsuffix,
			{
			method: "post",
			parameters: params,
			onSuccess: function(rslt)
				{
				if (rslt.ok) 
					{
					//t.log("Trained "+ addCommas(num) +" "+ troops[unitId]);
					t.log("Trained "+ addCommas(num) +" Supply Troops");
					if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
					for (var i = 1; i < 5; i++)
						{
						var resourceLost = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(num);
						if(rslt.gamble) resourceLost = resourceLost*rslt.gamble[i];
						unsafeWindow.seed.resources["city" + cityId]["rec" + i][0] = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]) - resourceLost;
						}
					unsafeWindow.seed.citystats["city" + cityId].gold[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].gold[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][5]) * parseInt(num);
					unsafeWindow.seed.citystats["city" + cityId].pop[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].pop[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][6]) * parseInt(num);
					//unsafeWindow.seed.queue_unt["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, null]);
					unsafeWindow.seed.queue_unt["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, rslt.ticksNeeded, null]);
					t.busy = false;
					t.show_city(cityId);
					}
				else
					{
					//t.log("FAILED to train "+ addCommas(num) +" "+ troops[unitId] + " :(");
					t.log("FAILED to train "+ addCommas(num) +" Supply Troops :(");
					t.busy = false;
					}
				},
			});
		setTimeout(unsafeWindow.update_seed_ajax, 250);
		},


	del_queues_start : function (cityId)
		{
		var t = Tabs.popcontrol;
		t.disable_btns();

		t.del_count = Seed.queue_unt['city'+cityId].length;
		t.log("Attempting to delete " + t.del_count + " Queue slots...");
		t.del_queues(cityId);
		},

 	del_queues : function (cityId)
		{
		var t = Tabs.popcontrol;
		clearTimeout (t.timer_del);

		var q = Seed.queue_unt['city'+cityId];
		var qs = q.toString();

		if(q.length > 0 || t.del_count > 0)
			{
			t.del_count -= 1;
			typetrn =		q[0][0];
			numtrptrn =	q[0][1];
			trnTmp =		q[0][2];
			trnETA = 		q[0][3];
			trnNeeded =	q[0][5];
			trainingId = 0;

			t.delete_queue_slot(typetrn, numtrptrn, trnTmp, trnETA, trnNeeded, cityId, trainingId)
			t.delete_queue_slot(typetrn, numtrptrn, trnTmp, parseInt(trnETA)-1, trnNeeded, cityId, trainingId)	//?!
						}
		else
			{
			t.log("No more queue slots to delete.");
			t.del_count = 0;
			t.busy = false;
			return;
			}
		setTimeout(unsafeWindow.update_seed_ajax, 250);
		t.timer_del = setTimeout (function() {t.del_queues(cityId)}, 1500);
		},

	delete_queue_slot : function (typetrn, numtrptrn, trnTmp, trnETA, trnNeeded, cityId, trainingId)
		{
		var t = Tabs.popcontrol;
		var uW = unsafeWindow;
		var params = uW.Object.clone(uW.g_ajaxparams);
		params.pf =0;
		params.requestType = "CANCEL_TRAINING";
		params.cityId = cityId;
		params.typetrn = typetrn;
		params.numtrptrn = numtrptrn;
		params.trnETA = trnETA;
		params.trnTmp = trnTmp;
		params.trnNeeded = trnNeeded;

		new AjaxRequest(uW.g_ajaxpath + "ajax/cancelTraining.php" + uW.g_ajaxsuffix,
			{
			method: "post",
			parameters: params,
			onSuccess: function (message)
				{
				var rslt=eval("("+message.responseText+")");
				if (rslt.ok)
					{
					t.log("Deleted queue of "+ addCommas(numtrptrn) +" "+ troops[typetrn]);
					if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
					var k=0;
					for(var j=0;j<Seed.queue_unt["city"+cityId].length;j++)
						{
						if(j>trainingId)
							{
							Seed.queue_unt["city"+cityId][j][2]=parseInt(rslt.dateTraining[k]["start"]);
							Seed.queue_unt["city"+cityId][j][3]=parseInt(rslt.dateTraining[k]["end"]);
							k++;
							}
						}
					Seed.queue_unt["city"+cityId].splice(trainingId,1);
					for(var i=1;i<5;i++)
						{
						var totalReturn=parseInt(uW.unitcost["unt"+typetrn][i])*parseInt(numtrptrn)*3600/2;
						Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
						}
					}
				else
					{
					}
				},
			onFailure: function ()
				{
				},
			});
		},


}
	
 
pbStartup ();
