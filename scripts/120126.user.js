// ==UserScript==
// @name           Grepolis marlikstools
// @namespace      .
// @description    Private Toolsammlung für Grepolis (My)
// @version        0.1.14
// @require        http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js
// @include        http://*.grepolis.*/game/index*
// @updateURL      http://userscripts.org/scripts/source/120126.user.js
// ==/UserScript==

if(typeof $=="undefined"){var $=unsafeWindow.jQuery}$(function(){var a=$('<div id="mgt" />').appendTo("body");a.GameData=unsafeWindow.GameData;a.HidesOverview=unsafeWindow.HidesOverview;a.server=/([a-zA-Z0-9]*)\./.exec(document.location.href)[1];a.GPWM=unsafeWindow.GPWindowMgr;a.GPL=unsafeWindow.Layout;a.Debug=false;a.DebugContent=new Array;a.DebugRefresh=function(){if(!a.Debug)return;var b=a.GPWM.getOpenFirst(a.GPL.wnd.TYPE_CUSTOM);if(!b){a.GPL.wnd.Create(a.GPL.wnd.TYPE_CUSTOM);b=a.GPWM.getOpenFirst(a.GPL.wnd.TYPE_CUSTOM)}if(a.DebugContent.length==10)a.DebugContent.shift();var c="";for(var d=0;d<a.DebugContent.length;d++)c+=a.DebugContent[d];b.setContent(c)};a.DebugWrite=function(b){a.DebugContent.push((new Date).toString()+":<br>"+b+"<br><br>");a.DebugRefresh()};if(a.Debug){window.setTimeout(a.DebugRefresh,3e3)}a.ajaxSuccess(function(b,c,d){var e=d.url.split(/&/)[0];a.DebugWrite(e);var g;if(d.data!=undefined){g=$.parseJSON(unescape(d.data).replace(/json=/,""))}switch(e){case"/game/report?action=view":{a.reportView(b,c,d);break};case"/game/town_overviews?action=hides_overview":{if(d.type=="GET")a.hidesOverview();break};case"/game/town_overviews?action=command_overview":{if(d.type=="GET")a.commandOverview(b,c,d);break};case"/game/building_place?action=simulate":{if(d.type=="POST")a.simulateView(b,c,d);break};case"/game/building_hide?action=index":{if(d.type=="GET")a.hidesIndex();break};case"/game/town_info?action=info":{a.townGSButton();break};case"/game/player?action=get_profile_html":{f=d.url.match(/player_id%22%3A(\d*)%2C/);if(f!=null){a.playerGSButton(f[1])}break};case"/game/player?action=index":{a.playerSettingsInit();break};case"/game/alliance?action=profile":{f=d.url.match(/alliance_id%22%3A(\d*)%2C/);if(f!=null){a.allianceGSButton(f[1])}break};case"/game/town_overviews?action=culture_overview":{if(d.type=="GET")a.cultureOverview()}}});a.playerSettingsInit=function(){var b=a.GPWM.getOpenFirst(a.GPL.wnd.TYPE_PLAYER_SETTINGS);if(!b)return;var c=$("DIV#gpwnd_"+b.getID()+" .settings-menu ul:last");$(c[0]).append('<li><a id="marlik-grepotools" class="settings-link" href="#">marlikstools</a></li>');$("a#marlik-grepotools").click(function(){return false})};a.hidesOverview=function(){var b=$("#hides_overview_towns");var c=b.find(".town_item");for(var d=0;d<c.length;d++){var e=$(c[d]);var f=e.find(".iron");var g=Number(f.text().trim());var h=e.find("input");if(g>15e3){h.val(g-15e3).change();e.find(".iron_img").click();var i=a.HidesOverview.spinners[e.find(".iron_img").attr("name")];i.setValue(g-15e3)}}};a.hidesIndex=function(){var a=parseInt($("#iron_count").text());if(a>15e3)$("#hide_order_input").val(a-15e3).change()};a.simulateView=function(b,c,d){var e=c.responseText.match(/{(.+)}/);var f=$.parseJSON("{"+e[1]+"}");var g={wood:0,stone:0,iron:0,favor:0,pop:0};var h={wood:0,stone:0,iron:0,favor:0,pop:0};units=a.GameData.units;for(unit in units){if(unit!="militia"){h.wood+=units[unit].resources.wood*f.att_losses[unit];h.stone+=units[unit].resources.stone*f.att_losses[unit];h.iron+=units[unit].resources.iron*f.att_losses[unit];h.favor+=units[unit].favor*f.att_losses[unit];h.pop+=units[unit].population*f.att_losses[unit]}}for(unit in units){if(unit!="militia"){g.wood+=units[unit].resources.wood*f.def_losses[unit];g.stone+=units[unit].resources.stone*f.def_losses[unit];g.iron+=units[unit].resources.iron*f.def_losses[unit];g.favor+=units[unit].favor*f.def_losses[unit];g.pop+=units[unit].population*f.def_losses[unit]}}$("#simulator_body").css("position","relative");$("#place_sim_lost_res").css("position","absolute").css("right","8px").css("bottom","34px").css("text-align","center").html('<h4>Verluste</h4><table width="235"><tr><th>Angreifer</th><th> </th><th>Verteidiger</th></tr><tr><td width="50%">'+h.wood+'</td><td><img class="unit_order_res wood" alt="'+a.GameData.resources.wood+'" src="http://cdn.grepolis.com/images/game/res/wood.png" width="20" height="20"/></td><td width="50%">'+g.wood+"</td></tr><tr><td>"+h.stone+'</td><td><img class="unit_order_res stone" alt="'+a.GameData.resources.stone+'" src="http://cdn.grepolis.com/images/game/res/stone.png" width="20" height="20"/></td><td>'+g.stone+"</td></tr><tr><td>"+h.iron+'</td><td><img class="unit_order_res iron" alt="'+a.GameData.resources.iron+'" src="http://cdn.grepolis.com/images/game/res/iron.png" width="20" height="20"/></td><td>'+g.iron+"</td></tr><tr><td>"+h.favor+'</td><td><img class="unit_order_res favor" alt="'+a.GameData.favor+'" src="http://cdn.grepolis.com/images/game/res/favor.png" width="20" height="20"/></td><td>'+g.favor+"</td></tr><tr><td>"+h.pop+'</td><td><img class="unit_order_res population" alt="'+a.GameData.poplation+'" src="http://cdn.grepolis.com/images/game/res/pop.png" width="20" height="20"/></td><td>'+g.pop+"</td></tr></table>")};a.reportView=function(b,c,d){var e=c.responseText.match(/ReportViewer\.initialize\((.+)\);/);if(e!=null){e[1]=e[1].replace(/"3":/g,'"x":');e[1]=e[1].replace(/"2":/g,'"y":');e[1]=e[1].replace(/"1":/g,'"z":');var f=$.parseJSON(e[1]);var g=a.calculateTroopCosts(f.result.att_units);var h=a.calculateTroopCosts(f.result.def_units);$("#resources").append('<hr /><h4>Verluste:</h4><table><tr><td width="50%">'+g.wood+'</td><td><img class="unit_order_res wood" alt="'+a.GameData.resources.wood+'" src="http://cdn.grepolis.com/images/game/res/wood.png" width="20" height="20"/></td><td width="50%">'+h.wood+"</td></tr><tr><td>"+g.stone+'</td><td><img class="unit_order_res stone" alt="'+a.GameData.resources.stone+'" src="http://cdn.grepolis.com/images/game/res/stone.png" width="20" height="20"/></td><td>'+h.stone+"</td></tr><tr><td>"+g.iron+'</td><td><img class="unit_order_res iron" alt="'+a.GameData.resources.iron+'" src="http://cdn.grepolis.com/images/game/res/iron.png" width="20" height="20"/></td><td>'+h.iron+"</td></tr><tr><td>"+g.favor+'</td><td><img class="unit_order_res favor" alt="'+a.GameData.favor+'" src="http://cdn.grepolis.com/images/game/res/favor.png" width="20" height="20"/></td><td>'+h.favor+"</td></tr><tr><td>"+g.pop+'</td><td><img class="unit_order_res population" alt="'+a.GameData.poplation+'" src="http://cdn.grepolis.com/images/game/res/pop.png" width="20" height="20"/></td><td>'+h.pop+"</td></tr></table>")}else if($(c.responseText).find(".report_side_defender").length>0){var h={wood:0,stone:0,iron:0,favor:0,pop:0};units=a.GameData.units;for(unit in units){if(unit!="militia"){if($(c.responseText).find(".unit_"+unit).length!=0){gdunit=$(c.responseText).find(".unit_"+unit).parent().find(".report_losts").text()*-1;h.wood+=units[unit].resources.wood*gdunit;h.stone+=units[unit].resources.stone*gdunit;h.iron+=units[unit].resources.iron*gdunit;h.favor+=units[unit].favor*gdunit;h.pop+=units[unit].population*gdunit}}}$("#report_booty_bonus_fight").prepend('<h4>Verluste:</h4><table><tr><td width="50%"> </td><td><img class="unit_order_res wood" alt="'+a.GameData.resources.wood+'" src="http://cdn.grepolis.com/images/game/res/wood.png" width="20" height="20"/></td><td width="50%">'+h.wood+'</td></tr><tr><td> </td><td><img class="unit_order_res stone" alt="'+a.GameData.resources.stone+'" src="http://cdn.grepolis.com/images/game/res/stone.png" width="20" height="20"/></td><td>'+h.stone+'</td></tr><tr><td> </td><td><img class="unit_order_res iron" alt="'+a.GameData.resources.iron+'" src="http://cdn.grepolis.com/images/game/res/iron.png" width="20" height="20"/></td><td>'+h.iron+'</td></tr><tr><td> </td><td><img class="unit_order_res favor" alt="'+a.GameData.favor+'" src="http://cdn.grepolis.com/images/game/res/favor.png" width="20" height="20"/></td><td>'+h.favor+'</td></tr><tr><td> </td><td><img class="unit_order_res population" alt="'+a.GameData.poplation+'" src="http://cdn.grepolis.com/images/game/res/pop.png" width="20" height="20"/></td><td>'+h.pop+"</td></tr></table>")}};a.calculateTroopCosts=function(b){var c=0;var d=0;var e=0;var f=0;var g=0;var h=a.GameData;if(typeof b.x!=="undefined"){if(b.x.lost!=null&&Object.keys(b.x.lost).length!=0){var i=b.x.lost;for(unit in i){if(unit!="militia"){gdunit=h.units[unit];c+=gdunit.resources.wood*i[unit];d+=gdunit.resources.stone*i[unit];e+=gdunit.resources.iron*i[unit];g+=gdunit.favor*i[unit];f+=gdunit.population*i[unit]}}}}if(typeof b.y!=="undefined"){if(b.y.lost!=null&&Object.keys(b.y.lost).length!=0){var i=b.y.lost;for(unit in i){if(unit!="militia"){gdunit=h.units[unit];c+=gdunit.resources.wood*i[unit];d+=gdunit.resources.stone*i[unit];e+=gdunit.resources.iron*i[unit];g+=gdunit.favor*i[unit];f+=gdunit.population*i[unit]}}}}if(typeof b.z!=="undefined"){if(b.z.lost!=null&&Object.keys(b.z.lost).length!=0){var i=b.z.lost;for(unit in i){if(unit!="militia"){gdunit=h.units[unit];c+=gdunit.resources.wood*i[unit];d+=gdunit.resources.stone*i[unit];e+=gdunit.resources.iron*i[unit];g+=gdunit.favor*i[unit];f+=gdunit.population*i[unit]}}}}return{wood:c,stone:d,iron:e,favor:g,pop:f}};a.townGSButton=function(){var b=a.GPWM.getOpen(a.GPL.wnd.TYPE_TOWN);if(b.length==0)return;wnd=b[b.length-1];var c=wnd.getID();var d=$("DIV#gpwnd_"+c+" DIV#towninfo_towninfo UL.game_list DIV.list_item_right SPAN.gt_gsbutton");if(d.length>0)return;var e=$("DIV#gpwnd_"+c+" DIV#towninfo_towninfo A.gp_player_link").attr("href");var f=e.split(/#/);var g=$.parseJSON(atob(f[1]||f[0]));var h=window.location.host.replace(/.grepolis.com.*$/,"");var i=h.replace(/\d+/,"");var j=$("DIV#gpwnd_"+c+" DIV#towninfo_towninfo UL.game_list DIV.list_item_right");$(j[1]).append('<span class="gt_gsbutton"><a target="_blank" href="http://'+i+".grepostats.com/world/"+h+"/player/"+g.id+'"><img src="http://grepo.faark.de/faarksGrepoTools/resources/view_on_grepostats.png" style="padding-top:1px; padding-left:3px"></a></span>');$(j[1]).css("width","100px");var k=$('a[onclick^="Layout.allianceProfile"]').attr("onclick").replace(")","").split(",")[1];var l=$('a[onclick^="Layout.allianceProfile"]').parent().find(".list_item_right");l.prepend('<span class="gt_gsbutton"><a target="_blank" href="http://'+i+".grepostats.com/world/"+h+"/alliance/"+k+'"><img src="http://grepo.faark.de/faarksGrepoTools/resources/view_on_grepostats.png" style="padding-top:1px; padding-left:3px"></a></span>');l.css("width","50px")};a.playerGSButton=function(b){var c=a.GPWM.getOpenFirst(a.GPL.wnd.TYPE_PLAYER_PROFILE);if(!c)return;var d=$("DIV#gpwnd_"+c.getID()+" DIV#player_buttons ");var e=a.server.replace(/\d+/,"");$(d[0]).append("<a target=_blank href=http://"+e+".grepostats.com/world/"+a.server+"/player/"+b+'><img src=http://grepo.faark.de/faarksGrepoTools/resources/view_on_grepostats.png style="padding-top:1px; padding-left:3px"></a>')};a.allianceGSButton=function(b){var c=a.GPWM.getOpenFirst(a.GPL.wnd.TYPE_ALLIANCE_PROFILE);if(!c)return;var d=$("DIV#gpwnd_"+c.getID()+" DIV#player_buttons ");var e=a.server.replace(/\d+/,"");$(d[0]).append("<a target=_blank href=http://"+e+".grepostats.com/world/"+a.server+"/alliance/"+b+'><img src=http://grepo.faark.de/faarksGrepoTools/resources/view_on_grepostats.png style="padding-bottom: 2px;padding-left:2px"></a>')};a.cultureOverview=function(){var a=$("ul#cultur_overview_towns");var b,c,d,e;e=0;b=$('a[class~="confirm"][class~="type_theater"]');d=$('a[class~="confirm"][class~="type_theater"][class~="disabled"]');if(d.length>0){for(var f=0;f<b.length;f++){if($(b[f]).attr("class").indexOf("disabled")>1)continue;c=$(b[f]).parents('li[id^="ov_town_"]');eltext=c[0].previousSibling;$(c).insertBefore($(d[0]).parents('li[id^="ov_town_"]'));$(eltext).insertBefore($(d[0]).parents('li[id^="ov_town_"]'))}}e=0;b=$('a[class~="confirm"][class~="type_party"]');d=$('a[class~="confirm"][class~="type_party"][class~="disabled"]');if(d.length>0){for(var f=0;f<b.length;f++){if($(b[f]).attr("class").indexOf("disabled")>1)continue;c=$(b[f]).parents('li[id^="ov_town_"]');eltext=c[0].previousSibling;$(c).insertBefore($(d[0]).parents('li[id^="ov_town_"]'));$(eltext).insertBefore($(d[0]).parents('li[id^="ov_town_"]'))}}var g=$("ul#culture_overview_towns span.eta");var h=$("div#place_culture_count").text();if(h.indexOf("[")<1){var i=h.split("/");var j=parseInt(i[0])+g.length;var k=parseInt(i[1])-j;if(k>0){$("DIV#place_culture_count").text(i[0]+"/"+i[1]+" [-"+k+"]")}else{var l=new Array;for(var f=0;f<g.length;f++)l.push($(g[f]).text());l.sort();var m=l[l.length+k-1];$("div#place_culture_count").html(i[0]+"/"+i[1]+" [<span></span>]").find("span").countdown(m).mousePopup(new unsafeWindow.MousePopup("Zeit bis zum Erreichen der nächsten Stufe"))}}};a.commandOverview=function(a,b,c){var d=b.responseText.match(/{(.+)}/);var e=$.parseJSON("{"+d[1]+"}");if(e.data!=undefined){if(e.data.commands.length>0)$("div.game_header").html($("div.game_header").html().split(" (")[0]+" ("+e.data.commands.length+")");var f={attack_land:0,support:0,attack_sea:0,attack_spy:0,farm_attack:0,abort:0,attack_takeover:0};for(var g=0;g<e.data.commands.length;g++)f[e.data.commands[g].type]++;var h=$("div .support_filter");$(h[0]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.attack_land));$(h[1]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.support));$(h[2]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.attack_sea));$(h[3]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.attack_spy));$(h[4]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.farm_attack));$(h[5]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.abort));$(h[6]).mousePopup(new unsafeWindow.MousePopup("Befehle: "+f.attack_takeover))}};a.gttr={config:{okLogo:'<img style="width:10px;height:10px;float:left;padding: 2pt 5px 0 2px;" src="http://grepo.faark.de/grexGrepoTownReservation/resources/green.png">',warningLogo:'<img style="width:10px;height:10px;float:left;padding: 2pt 5px 0 2px;" src="http://grepo.faark.de/grexGrepoTownReservation/resources/red.png">',loadingLogo:'<img style="width:10px;height:10px;float:left;padding: 2pt 5px 0 2px;" src="http://faark.bplaced.net/projects/faarksGrepoPicSaver/resources/loading.gif">',errorLogo:'<img style="width:10px;height:10px;float:left;padding: 2pt 5px 0 2px;" src="http://grepo.faark.de/grexGrepoTownReservation/resources/red.png">'},strings:{content:{de:{nologin:"Keine Login-Daten verfügbar",multiplelogin:"Für diese Allianz sind mehrere<br/>Accounts eingetragen. Bitte lösche<br/>alle bis auf das Aktuelle.",reservedby:'<span style="color:red;">Reserviert von<br/>[[PLAYERLIST]]</span>',loading:"Lade Reservierungen...",loading_tooltip:'<span style="font-size:80%; color:grey;">Überprüfe Reservierung...</span>',aviablewithlink:'<span style="display:inline-block">Nicht reserviert <a target="_blank" href="[[URL]]" style="font-size:60%">(für mich reservieren)</a></span>',reservedwithlink:'<span style="display:inline-block;max-width:300px;">Reserviert von [[URLPLAYERLIST]]</span>',mouseover_loading:"Reservierung wird vom Server<br/>geladen, bitte warten...",mouseover_reserved:"Dieses Dorf wurde von [[PLAYER]] reserviert.<br/>Weitere Infos erhälst du von ihm...",mouseover_reserve:"Dieses Dorf wird noch von keinem<br/>anderen Spieler beansprucht.<br/><br/>Du dürftest es dir selber<br/>reservieren oder Gefahrlos farmen können",mouseover_error:"Beim ermitteln der Reservierungen ist ein Fehler aufgetreten!<br/>Eventuell musst du das GM-Script neu installieren.<br/>Sollte das auch nix bringt, kannst du dich an Grex oder Faark wenden.",mouseover_extending:"<br/><span style='float:right;color: gray;font-size: 60%;'>by Grex & Faark</span>",error:'<span style="color:red"><span style="text-decoration:underline;">Fehler beim Überprüfen der Reservierung:</span><br/>[[ERRORTEXT]]</span>'},en:{nologin:"No login-information available",multiplelogin:"You have multiple login-infos<br/>for this alliance. please delete<br/>all except for the current.",reservedby:'<span style="color:red;">Reserved by <br/>[[PLAYERLIST]]</span>',loading:"Loading reservations...",loading_tooltip:'<span style="font-size:80%; color:grey;">Checking reservation...</span>',aviablewithlink:'<span style="display:inline-block">Not reserved <a target="_blank" href="[[URL]]" style="font-size:60%">(reserve it for me)</a></span>',reservedwithlink:'<span style="display:inline-block;max-width:300px;">Reserved by [[URLPLAYERLIST]]</span>',mouseover_loading:"Loading reservation-data from<br/>server, please wait...",mouseover_reserved:"This village is reserved by [[PLAYER]].<br/>Ask him for more information...",mouseover_reserve:"This village isn't claimed by<br/>any allied player.<br/><br/>You can reserve it for your self<br/>or ask for resources, if you want",mouseover_error:"There was an error while getting reservation-informations!<br/>re-install that GM-Script can solve that problem.<br/>you can ask Grex oder Faark for help, if not.(german forum)",mouseover_extending:"<br/><span style='float:right;color: gray;font-size: 60%;'>by Grex & Faark</span>",error:'<span style="color:red"><span style="text-decoration:underline;">Error checking reservations state:</span><br/>[[ERRORTEXT]]</span>'}},lang:"en",defaultReplacements:[{find:/\[\[now\]\]/gi,replace:function(){return(new Date).toLocaleString()}}],get:function(a,b){try{var c=this.defaultReplacements;var d=this.content[this.lang][a];if(b){var e=[];if(b.length)e=b;else for(var f in b)e.push({find:new RegExp("\\[\\["+f+"\\]\\]","gi"),replace:b[f]})}for(var f=0;f<c.length;f++)d=d.replace(c[f].find,c[f].replace)}catch(g){DebugWrite("Could not load String ["+a+"]")}},init:function(){var b=/([a-zA-Z]*)/.exec(a.server)[1];if(this.content[b])this.lang=b}},account:{init:function(){}},init:function(){this.strings.init();this.account.init()}};a.gttr.init()})