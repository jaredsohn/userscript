// ==UserScript==
// @name		MediaPublik
// @version		0.060
// @description	MediaPublik - Multimedia and multitool script for eRepublik
// @author		eCitizen AnHeLLiDo
// @require		http://jqueryjs.googlecode.com/files/jquery-1.3.1.min.js
// @include		http://ww*.erepublik.com/*
// ==/UserScript==


var textES=new Array();
textES["cabecera"]=			"Cabecera";
textES["firma"]=			"Firma";
textES["previsualizar"]=	"Previsualizar";
textES["cerrar"]=			"CERRAR";
textES["generada"]=			"Previsualizci&oacute;n generada por MediaPublik";
textES["idioma"]=			"Idioma";
textES["guardar"]=			"Guardar";
textES["notexto"]=			"Art&iacute;culo sin t&iacute;tulo";
textES["nocabecera"]=		"Debes configurar la cabecera desde tu bandeja de mensajes.";
textES["nofirma"]=			"Debes configurar la firma desde tu bandeja de mensajes.";
textES["seleccionar"]=		"Seleccionar idioma";
textES["soporte"]=			"Ayuda a MediaPublik";
textES["suscribe"]=			"Suscripci&oacute;n &amp; actualizaciones";

var textEN=new Array();
textEN["cabecera"]=			"Header";
textEN["firma"]=			"Signature";
textEN["previsualizar"]=	"Preview";
textEN["cerrar"]=			"CLOSE";
textEN["generada"]=			"Preview generated by MediaPublik";
textEN["idioma"]=			"Language";
textEN["guardar"]=			"Save";
textEN["notexto"]=			"No title";
textEN["nocabecera"]=		"You must set up your header at your inbox.";
textEN["nofirma"]=			"You must set up your signature at your inbox.";
textEN["seleccionar"]=		"Select language";
textEN["soporte"]=			"Support MediaPublik";
textEN["suscribe"]=			"Subscribe &amp; update";

var textPL=new Array();
textPL["cabecera"]=			"Nag&#322;&oacute;wek";
textPL["firma"]=			"Podpis";
textPL["previsualizar"]=	"Podgl&#261;d";
textPL["cerrar"]=			"ZAMKNIJ";
textPL["generada"]=			"Podgl&#261;d wygenerowany przez MediaPublik";
textPL["idioma"]=			"J&#281;zyk";
textPL["guardar"]=			"Zapisz";
textPL["notexto"]=			"Bez tytu&#322;u";
textPL["nocabecera"]=		"Musisz ustawi&#263; sw&oacute;j nag&#322;&oacute;wek w swojej skrzynce inbox.";
textPL["nofirma"]=			"Musisz ustawi&#263; sw&oacute;j podpis w swojej skrzynce inbox.";
textPL["seleccionar"]=		"Wybierz j&#281;zyk";
textPL["soporte"]=			"Wesprzyj MediaPublik";
textPL["suscribe"]=			"Subskrybuj i od&#347;wie&#380;";

var textFR=new Array();
textFR["cabecera"]=			"En-t&ecirc;te";
textFR["firma"]=			"Signature";
textFR["previsualizar"]=	"Pr&eacute;visualiser";
textFR["cerrar"]=			"FERMER";
textFR["generada"]=			"Pr&eacute;visualisation g&eacute;n&eacute;r&eacute;e par MediaPublik";
textFR["idioma"]=			"Langage";
textFR["guardar"]=			"Sauvegarder";
textFR["notexto"]=			"Aucun titre";
textFR["nocabecera"]=		"Vous devez configurer l'en-t&ecirc;te de votre bo&icirc;te de r&eacute;ception.";
textFR["nofirma"]=			"Vous devez configurer la signature de votre bo&icirc;te de r&eacute;ception.";
textFR["seleccionar"]=		"S&eacute;lection du langage";
textFR["soporte"]=			"Support MediaPublik";
textFR["suscribe"]=			"S'abonner &amp; Mise &agrave; jour";

var textDU=new Array();
textDU["cabecera"]=			"Hoofding";
textDU["firma"]=			"Handtekening";
textDU["previsualizar"]=	"Voorbeeld";
textDU["cerrar"]=			"SLUITEN";
textDU["generada"]=			"Voorbeeld gegenereerd door MediaPublik";
textDU["idioma"]=			"Taal";
textDU["guardar"]=			"Opslaan";
textDU["notexto"]=			"Geen titel";
textDU["nocabecera"]=		"Je moet een hoofding instellen bij je inbox.";
textDU["nofirma"]=			"Je moet een handtekening instellen bij je inbox.";
textDU["seleccionar"]=		"Selecteer je taal";
textDU["soporte"]=			"Steun MediaPublik";
textDU["suscribe"]=			"Abonneer &amp; update";

var textHU=new Array();
textHU["cabecera"]=			"Fejl&eacute;c";
textHU["firma"]=			"Al&aacute;&iacute;r&aacute;s";
textHU["previsualizar"]=	"El&#337;n&eacute;zet";
textHU["cerrar"]=			"LEZ&Aacute;R&Aacute;S";
textHU["generada"]=			"Az el&#337;n&eacute;zetet a MediaPublik gener&aacute;lta";
textHU["idioma"]=			"Nyelv";
textHU["guardar"]=			"Ment&eacute;s";
textHU["notexto"]=			"Nincs c&iacute;m";
textHU["nocabecera"]=		"&Aacute;ll&iacute;tsd be a fejl&eacute;cet az inboxban.";
textHU["nofirma"]=			"&Aacute;ll&iacute;tsd be az al&aacute;&iacute;r&aacute;sod az inboxban.";
textHU["seleccionar"]=		"Nyelv v&aacute;laszt&aacute;s";
textHU["soporte"]=			"MediaPublik t&aacute;mogat&aacute;sa";
textHU["suscribe"]=			"Feliratkoz&aacute;s &eacute;s friss&iacute;t&eacute;s";


var textVA=new Array();
textVA["cabecera"]=			"Eskutitzen goiburukoa";
textVA["firma"]=			"Erabiltzailearen sinadura";
textVA["previsualizar"]=	"Aurreikuste";
textVA["cerrar"]=			"ITXI";
textVA["generada"]=			"Aurreikuste sortu zehar MediaPublik";
textVA["idioma"]=			"Hizkuntza";
textVA["guardar"]=			"Jagon";
textVA["notexto"]=			"Artikulu gabe titulu";
textVA["nocabecera"]=		"Ez izan eskutitzen goiburukoa.";
textVA["nofirma"]=			"Ez izan erabiltzailearen sinadura.";
textVA["seleccionar"]=		"Select languaje";
textVA["soporte"]=			"Support MediaPublik";
textVA["suscribe"]=			"Subscribe &amp; update";

var textCA=new Array();
textCA["cabecera"]=			"Cap&ccedil;alera";
textCA["firma"]=			"Signatura";
textCA["previsualizar"]=	"Previsualitzar";
textCA["cerrar"]=			"TANCAR";
textCA["generada"]=			"Previsualitzaci&oacute; generada per MediaPublik";
textCA["idioma"]=			"Idioma";
textCA["guardar"]=			"Desar";
textCA["notexto"]=			"Article sense t&iacute;tol";
textCA["nocabecera"]=		"Has de configurar la cap&ccedil;alera des de la teva safata de missatges.";
textCA["nofirma"]=			"Has de configurar la signatura des de la teva safata de missatges.";
textCA["seleccionar"]=		"Selecciona idioma";
textCA["soporte"]=			"Ajuda a MediaPublik";
textCA["suscribe"]=			"Subscripci&oacute; i actualitzacions";

var textHO=new Array();
textHO["cabecera"]=			"KABESERRA";
textHO["firma"]=			"FRIMA";
textHO["previsualizar"]=	"PERBISUALISAR";
textHO["cerrar"]=			"XAPAR";
textHO["generada"]=			"PERBISUALISASIOM JENERRADA PR MediaPublik";
textHO["idioma"]=			"HINDOIMA";
textHO["guardar"]=			"JAURDAR";
textHO["notexto"]=			"HARTIKULO SN TISTULO";
textHO["nocabecera"]=		"HOYGAN DEVE HUSTE KONFIJURA LA KAVESERA DSD SU VANDEGA D MNSAGS";
textHO["nofirma"]=			"HOYGAN DEVE HUSTE KONFIJURA L FRIMA DSD SU VANDEGA D MNSAGS";
textHO["seleccionar"]=		"SLEKSIONAR HINDIOMA";
textHO["soporte"]=			"HOYGAN HALLUDN A MediaPublik!!!!!11";
textHO["suscribe"]=			"SUKRISIOM I HAKTUALISISIOMES";

var textGL=new Array();
textGL["cabecera"]= "Cabeceira";
textGL["firma"]= "Firma";
textGL["previsualizar"]= "Previsualizar";
textGL["cerrar"]= "PECHAR";
textGL["generada"]= "Previsualización xerada por MediaPublik";
textGL["idioma"]= "Idioma";
textGL["guardar"]= "Gardar";
textGL["notexto"]= "Artigo sen t&iacute;tulo";
textGL["nocabecera"]= "Debes configurar a cabeceira dende a t&uacute;a bandexa de mensaxes.";
textGL["nofirma"]= "Debes configurar a firma dende a t&uacute;a bandexa de mensaxes.";
textGL["seleccionar"]= "Seleccionar idioma";
textGL["soporte"]= "Axuda a MediaPublik";
textGL["suscribe"]= "Suscripci&oacute;n e actualizaci&oacute;ns";

var textIT=new Array();
textIT["cabecera"]= "Testata";
textIT["firma"]= "Firma";
textIT["previsualizar"]= "Previsualizzazione";
textIT["cerrar"]= "Chiudi";
textIT["generada"]= "Previsualzzazione generata da MediaPublik";
textIT["idioma"]= "Linguaggio";
textIT["guardar"]= "Salva";
textIT["notexto"]= "No titolo";
textIT["nocabecera"]= "Devi impostare la testata nella tua casella postale.";
textIT["nofirma"]= "Devi impostare la firma nella tua casella postale";
textIT["seleccionar"]= "Seleziona Linguaggio";
textIT["soporte"]= "Supporta MediaPublik";
textIT["suscribe"]= "Sottoscrivi il giornale per ulterori Aggiornamenti"; 

var textGK=new Array();
textGK["cabecera"]= "&Epsilon;&pi;&iota;&kappa;&epsilon;&phi;&alpha;&lambda;&#943;&delta;&alpha;";
textGK["firma"]= "&Upsilon;&pi;&omicron;&gamma;&rho;&alpha;&phi;&#942;";
textGK["previsualizar"]= "&Pi;&rho;&omicron;&epsilon;&pi;&iota;&sigma;&kappa;&#972;&pi;&eta;&sigma;&eta;";
textGK["cerrar"]= "&Kappa;&Lambda;&Epsilon;&Iota;&Sigma;&Epsilon;";
textGK["generada"]= "&Eta; &epsilon;&pi;&iota;&sigma;&kappa;&#972;&pi;&eta;&sigma;&eta; &delta;&eta;&mu;&iota;&omicron;&upsilon;&rho;&gamma;&#942;&theta;&eta;&kappa;&epsilon; &alpha;&pi;&#972; &tau;&omicron; MediaPublik";
textGK["idioma"]= "&Gamma;&lambda;&#974;&sigma;&sigma;&alpha;";
textGK["guardar"]= "&Alpha;&pi;&omicron;&theta;&#942;&kappa;&epsilon;&upsilon;&sigma;&eta;";
textGK["notexto"]= "&Chi;&omega;&rho;&#943;&sigmaf; &tau;&#943;&tau;&lambda;&omicron;";
textGK["nocabecera"]= "&Pi;&rho;&#941;&pi;&epsilon;&iota; &nu;&alpha; &rho;&upsilon;&theta;&mu;&#943;&sigma;&epsilon;&tau;&epsilon; &tau;&eta;&nu; &epsilon;&pi;&iota;&kappa;&epsilon;&phi;&alpha;&lambda;&#943;&delta;&alpha; &sigma;&alpha;&sigmaf; &sigma;&tau;&omicron; inbox.";
textGK["nofirma"]= "&Pi;&rho;&#941;&pi;&epsilon;&iota; &nu;&alpha; &rho;&upsilon;&theta;&mu;&#943;&sigma;&epsilon;&tau;&epsilon; &tau;&eta;&nu; &upsilon;&pi;&omicron;&gamma;&rho;&alpha;&phi;&#942; &sigma;&alpha;&sigmaf; &sigma;&tau;&omicron; inbox.";
textGK["seleccionar"]= "&Delta;&iota;&#940;&lambda;&epsilon;&xi;&epsilon; &gamma;&lambda;&#974;&sigma;&sigma;&alpha;";
textGK["soporte"]= "&Upsilon;&pi;&omicron;&sigma;&tau;&#942;&rho;&iota;&xi;&epsilon; MediaPublik";
textGK["suscribe"]= "Suscribe &amp; update"; 

var textRO=new Array();
textRO["cabecera"] ="Antet";
textRO["firma"]="Semnatura";
textRO["previsualizar"]="Previzualizare";
textRO["cerrar"]="INCHIDE";
textRO["generada"]="Previzualizare generata de MediaPublik";
textRO["idioma"]="Limba";
textRO["guardar"]="Salveaza";
textRO["notexto"]="Fara titlu";
textRO["nocabecera"]="Trebuie setat antetul in casuta postala";
textRO["nofirma"]="Trebuie setata semnatura in casuta postala";
textRO["seleccionar"]="Selecteaza limba";
textRO["soporte"]="Sustine MediaPublik";
textRO["suscribe"]="Aboneaza-te pentru noutati";

var textSR=new Array();
textSR["cabecera"]= "Zaglavlje";
textSR["firma"]= "Potpis";
textSR["previsualizar"]= "Pregled";
textSR["cerrar"]= "ZATVORITI";
textSR["generada"]= "Pregled napravljen od MediaPublik";
textSR["idioma"]= "Jezik";
textSR["guardar"]= "Sa&#269;uvaj";
textSR["notexto"]= "Bez naslova";
textSR["nocabecera"]= "Morate napraviti zaglavlje u inboxu.";
textSR["nofirma"]= "Morate napraviti va&scaron; potpis u inboxu.";
textSR["seleccionar"]= "Iyaberite jezik";
textSR["soporte"]= "Podr&#382;ite MediaPublik";
textSR["suscribe"]= "Pretplatite se na update";

var lang = GM_getValue("MPLang", "EN");
eval("var text=text"+lang);


var articleTool='<div id="articleToolPanel"><span id="aTPTitle">MediaPublik ToolBox:</span> <span id="cabecera" class="atpMenu">'+text["cabecera"]+'</span> <span id="firma" class="atpMenu">'+text["firma"]+'</span> <span id="preview" class="atpMenu">'+text["previsualizar"]+'</span></div>';


var id=Math.floor(Math.random()*1000000);
var tinypic_layout = 'narrow';
var tinypic_type = 'images';
var tinypic_links = 'url';
var tinypiclang= GM_getValue("MPLang", "EN");
var tinypic_language = tinypiclang.toLowerCase();
var tinypic_search = 'false';
var tinypic_autoload = true;

var configTab='<li id="latesttab"><a href="#" id="MPTab"><span>MediaPublik</span></a></li>';

var configContent='<div id="configContent"><div class="mptabtitle">'+text["idioma"]+'</div><span class="mplang">'+text["seleccionar"]+': </span><select name="languaje" id="languaje"><option value="ES">Spanish</option><option value="EN">English</option><option value="DU">Dutch</option><option value="PL">Polish</option><option value="GL">Galician</option><option value="CA">Catalan</option><option value="VA">Euskara</option><option value="HO">HOYGAN</option><option value="HU">Hungarian</option><option value="FR">French</option><option value="IT">Italian</option><option value="GK">Greek</option><option value="RO">Romanian</option><option value="SR">Serbian</option></select><div class="mptabtitle">'+text["cabecera"]+'</div><textarea id="mpcabecera"></textarea><div class="mptabtitle">'+text["firma"]+'</div><textarea id="mpfirma"></textarea><br><div id="mpguardar">'+text["guardar"]+'</div><div id="mpsupport"><a href="http://www.erepublik.com/es/citizen/donate/items/1814784">'+text["soporte"]+'</a></div><div id="mpsuscribe"><a href="http://www2.erepublik.com/es/newspaper/what-the-faq-197983/1">'+text["suscribe"]+'</a></div></div>';

var currURL = location.href;
var LOCALE = 'es/';
var arrURL = currURL.split('/');
var BASE_URL = arrURL[0] + '/' + arrURL[1] + '/' + arrURL[2] + '/';

var subURL = currURL.substr(BASE_URL.length);
LOCALE = subURL.substring(0, 2) + '/';
BASE_URL += LOCALE;
subURL = currURL.substr(BASE_URL.length);



var pagesFunctions = [
	{p: 'messages/', 			f: addConfigTab},
	/*{p: 'messages/compose/', 	f: addMesageBox},
	{p: 'messages/read/inbox/',	f: addMesageBox},*/
	{p: 'write-article', 		f: addArticleTool},
	{p: 'edit-article/',		f: addArticleTool},
	/*{p: 'forum',				f: addArticleTool},*/
	{p: 'article/',				f: addVideoPublik},
	{p: 'newspaper/',			f: addVideoPublik}
];

pagesFunctions.forEach(function(v) {
	if (subURL.substr(0, v.p.length) == v.p){
		v.f();
	}
});

function addConfigTab(){
	$("div.holder ul.tabs:has(#topratedtab)").append(configTab);
	$("div.holder ul.tabs li a").css({"width":"135px"});
	$("div.holder ul.tabs li").css({"width":"135px"});
	$("div.holder ul.tabs li a span").css({"width":"135px"});
	$("#MPTab").click(function(){
		$("div.holder ul.tabs li a").removeClass("on");
		$(this).addClass("on");
		$("div.holder:has(form:has(table.messages))").html(configContent);
		$("#mpfirma").val(GM_getValue("firma"));
		$("#mpcabecera").val(GM_getValue("cabecera"));
		$("#languaje").val(GM_getValue("MPLang", "ES"));
		
		$("#configContent").css({"background":"url(http://img180.imageshack.us/img180/8831/backgroundcopiacopia.jpg) right center no-repeat", "padding":"10px", "width":"100%"});
		$(".mptabtitle").css({"color":"#666", "fontWeight":"bold", "marginTop":"20px", "marginBottom":"5px", "fontSize":"16px"});
		$("#mpcabecera, #mpfirma").css({"border":"#999 1px solid", "width":"300px", "height":"100px"});
		$("#mpguardar").css({"color":"#fff", "fontWeight":"bold", "backgroundColor":"#777", "padding":"5px", "cursor":"pointer", "marginTop":"30px", "width":"100px", "textAlign":"center", "float":"left"});
		$("#mpsupport, #mpsuscribe").css({"cursor":"pointer","color":"#06f", "float":"left", "marginLeft":"20px", "marginTop":"30px", "padding":"5px"});

		$("#mpguardar").click(function(){
			GM_setValue("firma", $("#mpfirma").val());
			GM_setValue("cabecera", $("#mpcabecera").val());
			GM_setValue("MPLang", $("#languaje option:selected").attr("value"));
			alert("OK");
			return false;
		});
		
		return false;
	});
}



function addArticleTool(){
	//Obtener Cabecera y Firma
	//Añadir panel con Cabecera, Firma y Preview
	//Despues de body
	if($("#articleToolPanel").find("").size() < 1){
		//Evitamos doble carga de contenedor
		$(".inputholder:has(textarea.textarea)").append(articleTool);
	}
	//$("#publi").css({"width":"50px","marginRight":"15px"});	
	/*$("#publi").click(function(){
			$(".textarea:input").text($(".textarea:input").text+publi);	
			return false;								   
	});	*/
	$("span.atpMenu").css({"paddingLeft":"10px","paddingRight":"10px","textDecoration":"underline", "color":"#06F", "cursor":"pointer"});	
	//$("#cabecera, #firma").css({"cursor":"wait"});
	$("#preview").click(function(){
		//Previsualización de arículo
		var previewPanel=formaPreview();
		$("body").append(previewPanel);
		$("#previewPanel").css({"width":"100%","height":"100%","position":"fixed","top":"0", "left":"0", "margin":"0", "backgroundColor":"#000", "filter":"alpha(opacity=80)", "opacity":".8", "zIndex":"999999998"});
			
		$("#cuadro").css({"width":"70%","height":"100%","position":"fixed","marginLeft":"15%", "marginRight":"15%", "marginTop":"auto", "marginBottom":"10%", "backgroundColor":"#fff", "filter":"alpha(opacity=100)", "opacity":"1", "zIndex":"999999999", "padding":"20px"});//,"overflow":"auto"
		$("#cuadro div").css({"overflow":"auto", "width":"90%","height":"70%","marginTop":"5%", "border":"#06F 1px solid", "paddingLeft":"20px", "paddingTop":"20px", "paddingBottom":"20px"});
		$("#cuadro h2").css({"color":"#222", "fontSize":"32px", "marginBottom":"30px"});
		$("#cuadro img").css({"maxWidht":"150px", "maxHeight":"200px"});

		$("#closePreview").css({"color":"#06F", "cursor":"pointer", "textDecoration":"underline", "float":"right"});
		$("#generado").css({"color":"#00F", "float":"left", "fontSize":"18", "fontWeight":"bold"});
		
	
		$("#closePreview").click(function(){	
			$("#previewPanel, #cuadro").remove();	
		});
		return false;
	});
	
	$("#cabecera").click(function(){
		//Añadir cabecera
		var cabecera=GM_getValue("cabecera", "");
		if(cabecera==""){
			alert(text["nocabecera"]);
			return false;
		}
		cabecera+= "\n";
		addText("textarea.textarea", cabecera, "pre");
		return false;
	});
	
	$("#firma").click(function(){
		//Añadir cabecera
		var firma=GM_getValue("firma", "");
		if(firma==""){
			alert(text["nofirma"]);
			return false;
		}
		firma = "\n" + firma;
		addText("textarea.textarea", firma, "ap");
		return false;
	});
	$(".uploadfile").html("<iframe id='tinypic_plugin_"+id+"' frameborder='0' style='display: none;' scrolling='no'></iframe><br/>");
	
	showTinypicPlugin();
}

function formaPreview(){
	var titulo=$("#article_name").val();
	if(titulo==""){titulo=text["notexto"];}
	var panel='<div id="previewPanel"></div><div id="cuadro" class="article"><span id="generado">'+text["generada"]+'</span><span id="closePreview">'+text["cerrar"]+'</span><div class="articlecontent"><h2 class="padded">'+ titulo +'</h2>';
	var texto=$("textarea.textarea").val();

	texto=bbReplace(texto);
	
	texto=texto.replace(/\n/g, '<br />\n' );
	
	texto=videoReplace(texto);
	
	var contenido='<p class="preview">'+texto+"</p>";
	
	panel+=contenido;
	panel+='</div></div>';
	return panel;
}

function bbReplace(texto){
	search = new Array(
          /\[img\](.*?)\[\/img\]/,
          /\[url=(.*?)\](.*?)\[\/url\]/,   
          /\[b\](.*?)\[\/b\]/,
		  /\[size=([\d]*?)\](.*?)\[\/size\]/,
		  /\[u\](.*?)\[\/u\]/,
		  /\[i\](.*?)\[\/i\]/);

	replace = new Array(
          "<img src=\"$1\" >",
          "<a href=\"$1\" target=\"blank\">$2</a>",          
          "<b>$1</b>",
		  "<span style=\"font-size:$1px\">$2</span>",
		  "<span style=\"text-decoration: underline;\">$1</span>",
		  "<span style=\"font-style: italic;\">$1</span>");
	
	for(i = 0; i < search.length; i++) {
		texto = tagReplace(texto, search[i], replace[i]);
	}	
	return texto;
}

/*
function addToolBar(){
	if($("#MPToolBar").find("").size() < 1){
		//Evitamos doble carga de contenedor
		$("#menu").before('<div id="MPToolBar"><span id="MPtitulo">MediaPublik Config Toolbar</span><div id="panelConfiguracion" style="display:none;"><div class="MPconfig"><h3>Idiomas</h3>Elije idioma<select name="idiomas"><option value="es">Spanish</option><option value="en">English</option></select></div><div class="MPconfig"><h3>Art&iacute;culos</h3>Cabecera<br />Firma</div></div></div>');
	}	
	$("#MPToolBar").css({"width":"954px", "height":"30px", "color":"#fff", "textAlign":"center"});
	$("#MPToolBar span").css({"backgroundImage":"url(http://www.soundtrash.com/eRe/MediaPublikBackGround.png)", "backgroundRepeat":"repeat-x", "backgroundPosition":"bottom", "width":"954px", "fontWeight":"bold", "display":"block", "cursor":"pointer"});
	$("#panelConfiguracion").css({"width":"954px", "height":"120px", "color":"#006", "position":"absolute"});
	$(".MPconfig").css({"width":"150px", "position":"relative", "float":"left"});
	$("#menu").css({"marginTop":"20px"});
	
	var desplegado=false;
	$("#MPtitulo").click(function(){
			$("#panelConfiguracion").toggle(600);
			if(!desplegado){
				$("#menu").animate({ 
					marginTop: "140"
				}, 600);
				desplegado=true;
			}else{
				$("#menu").animate({ 
					marginTop: "20"
				}, 600);
				desplegado=false;
			}
			//alert("");
	});
}*/

function addVideoPublik(){
	$("p.preview").each(function(){
		$(this).html(videoReplace($(this).html()));	
	});
	lightImg();
}

function addBoxAndVideo(){
	addVideoPublik();
}

function videoReplace(texto){
	search = new Array(
          /\<a href=\"(.*?)youtube.com\/watch\?v=(.*?)\".*\>(.*?)\<\/a\>/,
		  /\<a href=\"(.*?)overstream.net\/view.php\?oid=(.*?)\".*\>(.*?)\<\/a\>/,
		  /\<a href=\"(.*?)goear.com\/listen\/(.*?)\/.*\".*\>(.*?)\<\/a\>/,
		  /\<a href=\"(.*?)megavideo.com\/\?v\=(.*?)\/.*\".*\>(.*?)\<\/a\>/);

	replace = new Array(
          '<object width="425" height="344"><param name="movie" value="$1youtube.com/v/$2"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="$1youtube.com/v/$2" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object>',
		  '<object width="402" height="377"><param name="movie" value="$1overstream.net/swf/player/oplx?oid=$2' + '&noplay=1"></param><param name="allowFullScreen" value="true"></param><embed src="$1overstream.net/swf/player/oplx?oid=$2' + '&noplay=1" type="application/x-shockwave-flash" width="402" height="377" allowFullScreen="true"></embed></object>',
		  '<object width="353" height="132"><embed src="http://www.goear.com/files/external.swf?file=$2" type="application/x-shockwave-flash" wmode="transparent" quality="high" width="353" height="132"></embed></object>',
		  '<object width="640" height="480"><param name="movie" value="$1megavideo.com/v/$2"></param><param name="allowFullScreen" value="true"></param><embed src="$1megavideo.com/v/$2" type="application/x-shockwave-flash" allowfullscreen="true" width="640" height="480"></embed></object>');
	
	for(i = 0; i < search.length; i++) {
		texto = tagReplace(texto, search[i], replace[i]);
	}	
	return texto;
}

function tagReplace(texto, reg, replac){
	texto = texto.replace(reg,replac);
	if(texto.match(search[i])){
		texto = tagReplace(texto, reg, replac);		
	}
	return texto;
}

function addText(contenedor, texto, pos){
	if(pos=="ap"){
		//Al final .append
		$(contenedor).val($(contenedor).val() + texto);
	}else{
		//Al principio .prepend
		$(contenedor).val(texto + $(contenedor).val());
	}
}

function lightImg(){
	//Añadir evento a todos los enlaces
	//Animación fundido a gris
	//Animacion Aparece cuadro
	//Precarga, carga de la imagen

	var regExp = /(.*)(\.jpg|\.jpeg|\.gif|\.png)/gi;

	$("p.preview a").each(function(){
		if($(this).attr("href").match(regExp)){
			$(this).click(function(){
				loadLight($(this).attr("href"));
				return false;
			});
		}
	});
}

function loadLight(url){
	var posAlt = $(window).scrollTop();
	var posAnch = $(window).scrollLeft();
	var alto = $(window).height();
	var ancho = $(window).width();
	var margen = 30;
	var altoCuadro = alto - (margen*2);
	var anchoCuadro = ancho - (margen*2);
	var margenArriba= posAlt + margen;
	var margenIz= posAnch + margen;
	
	var X=235;
	var topPX= posAlt + ((alto - X)/2);
	var leftPX= posAnch + ((ancho - X)/2);
	
	
	var backG='<div id="backG"></div><div id="cuadroImg"><div id="carga" class="loading"></div></div>';
	$("body").append(backG);
	$("#backG").css({"width":"100%","height":"100%","position":"fixed","top":"0", "left":"0", "margin":"0", "backgroundColor":"#000", "filter":"alpha(opacity=00)", "opacity":".0", "zIndex":"999999998"});

	$("#cuadroImg").css({"width":X + "px","height":X + "px","position":"absolute","top": topPX +"px", "left": leftPX + "px" , "margin":"auto", "zIndex":"999999999", "backgroundColor":"#fff", "cursor":"pointer", "padding":"20px"});
	$("#carga").css({"width": "100%", "height":"100%"});
	$("#carga.loading").css({"background":"url(http://www.shougun.it/images/loading.gif) center no-repeat"});//http://jqueryfordesigners.com/images/spinner.gif
	$("#backG").animate({ 
		opacity: ".8",
		filter:"alpha(opacity=80)"
	}, 600, function(){
		var img = new Image();
		$(img).load(function () {
			$(this).hide();
			var altoIMG = $(this).attr("height");
			var anchoIMG = $(this).attr("width");
			var topPX= posAlt + ((alto - altoIMG)/2);
			var leftPX= posAnch + ((ancho - anchoIMG)/2);
			$("#cuadroImg").animate({ 
				width: 	anchoIMG + "px",
				height:	altoIMG + "px",
				top:	(topPX - 20) + "px",
				left:	(leftPX - 20) + "px"
			},600, function(){	
				$("#carga").removeClass('loading').append($(img));
				$(img).fadeIn();
			});	
		}).error(function () {
			// notify the user that the image could not be loaded
		}).attr('src', url);
	});
	$("#cuadroImg, #backG, #carga").click(function(){
			$("#cuadroImg, #backG").remove();				   
	});
	
}
function showTinypicPlugin(){
    var el = document.getElementById('tinypic_plugin_'+id);
    el.style.display = '';
    if (el.src != '')
    {
        return;
    }
    var w = 260;
    var h = 350;
    curl = '';
    ctxt = '';
        
    if (typeof(tinypic_language) == 'undefined')
        tinypic_language = 'en';
    if (typeof(tinypic_callback_url) != 'undefined')
        curl = "|cu,"+tinypic_callback_url.replace(/\&/g, '%26');;
    if (typeof(tinypic_callback_text) != 'undefined')
        ctxt = "|ct,"+tinypic_callback_text.replace(/\&/g, '%26');;
    
    el.setAttribute("height", h);
    el.setAttribute("width", w);
    el.setAttribute("scrolling", "no");

    var tpurl = "http://plugin.tinypic.com/plugin/index.php?popts=l,"+tinypic_layout+"|t,"+tinypic_type+"|c,"+tinypic_links+"|i,"+tinypic_language+"|s,"+tinypic_search;
    if (curl)
        tpurl += curl;
    if (ctxt)
        tpurl += ctxt;
    el.src = tpurl;
}

function hideTinypicPlugin(){
    var el = document.getElementById('tinypic_plugin_'+id);
    el.style.display = 'none';
}
