// ==UserScript==
// @name        Download video from mail.ru
// @version     2.01
// @date        2010-06-18
// @author      Mike Samokhvalov <mikivanch@gmail.com>
// @download    http://www.puzzleclub.ru/files/mail_ru_video.js
// @include     http://mail.ru/*
// @include     http://*.mail.ru/*
// ==/UserScript==

(function(){
  var hash = '#ujs_mail_ru_video_helper';
  var msgPrefix = 'ujs_mail_ru_video_helper_msg';
  var frameId = 'ujs_mail_ru_video_helper_frame';

function A(e){e.preventDefault()}function J(e,f,g){window.postMessage?g.postMessage(e,"*"):f.postMessage(e,"*")}function C(e){var f="",g="",k=0,h=e.match(/\$key\s*=\s*([\da-f]+)/i);if(h&&h.length>1)f=h[1];if((h=e.match(/\$srv\s*=\s*(video\d+)/i))&&h.length>1)g=h[1];if(e.match(/\$hdexist\s*=\s*1/i))k=1;return[f,g,k]}function D(e,f,g,k){hd_link="";if(g==1)hd_link=e.replace(/v-(\w+\.flv)/i,"hv-$1");e='\u0421\u043a\u0430\u0447\u0430\u0442\u044c:&nbsp;<a href="'+e+'" style="'+h+'">FLV</a>';
if(hd_link)e+=',&nbsp;<a href="'+hd_link+'" style="'+h+'">MP4</a>';if(k){var h="text-decoration: none; color: #00468c; background-color: #fff; border: 1px solid #00468c; outline: 1px solid #fff; padding: 0 10px;";h=document.createElement("div");h.setAttribute("style","color: #000; display: block; border-bottom: 5px solid transparent; font-size: 12pt; padding: 0; margin: 0 auto; text-align: "+E+";",false);h.innerHTML=e;k.insertBefore(h,k.firstChild)}else{h=document.createElement("div");h.setAttribute("style",
"display:  block; color: #003399; background-color: #e7eefa; border: 1px solid #c3d0ec; padding: 5px 0; text-align: center;",false);h.innerHTML=e;document.body.insertBefore(h,document.body.firstChild)}}function F(e){e=e.replace(/(\d+)$/,"v-$1.flv");if(e.charAt(0)!="/")e="/"+e;if(e.search(/^http:\/\//i)==-1){var f=location.hostname;if(f.search(/video\.mail\.ru$/i)==-1)f="video.mail.ru";e="http://"+f+e}return e}function y(e){if(!e)return"";if(e.search(/moviesrc=/i)!=-1){var f=e.match(/(?:\?|\&)moviesrc=([^\s\&\"\<\>]+)/i);
if(f&&f.length>1)return F(f[1])}if(e.search(/http:\/\/img\.mail\.ru\/r\/video\d*\/player/i)==-1)return"";if(e.indexOf("par=http://")==-1)return"";e=e.match(/(?:\?|\&)par=(http:\/\/.+)/i);if(!e||e.length<2)return"";return e=e[1].replace(/\$(\d+)(?:\$\d+)*/i,"v-$1.flv")}function G(e){return e}function H(e){var f;f="";for(i=0;i<5;i++)f+=Math.round(Math.random()*15).toString(16);f=f;e=f+e;e=G(e);return v=e.substr(0,11)+f}function I(e){var f=s[e][0].replace(/v-(\w+)\.flv.*/,"$1.lite?ext=1"),g=document.createElement("iframe");
g.src=f+hash+e;g.id=frameId;g.width=0;g.height=0;g.frameBorder="no";g.scrolling="no";g.setAttribute("ujs_external_unblocked","1",false);document.documentElement.appendChild(g)}function z(e,f,g){var k=e.replace(/v-(\w+)\.flv.*/,"$1.lite?ext=1");if(location.host.search(/\.?video\.mail\.ru/i)!=-1)k=location.href.replace(/\.html.*/i,".lite?ext=1");else if(e.toLowerCase().indexOf("http://"+location.host.toLowerCase()+"/")==-1){s.push([e,g]);return}K(k,function(h){if((h=C(h.responseText))&&h.length>2){key=
h[0];srv=h[1];hd=h[2];key=H(key);e+="?k="+key;if(srv)e+="&"+srv;D(e,f,hd,g)}},"",location.href)}function B(){s.length>0&&I(0)}function K(e,f,g,k,h,n,t,m){var l=new XMLHttpRequest;if(l){t=t?t:navigator.userAgent;l.open(g?g:h?"POST":"GET",e,true);l.setRequestHeader("User-Agent",t);k&&l.setRequestHeader("Referer",k);n&&l.setRequestHeader("Cookie",n);if(h){l.setRequestHeader("Content-type","application/x-www-form-urlencoded");l.setRequestHeader("Content-Length",h.length)}if(m)for(e=0;e<m.length;e++)l.setRequestHeader(m[e][0],
m[e][1]);l.onreadystatechange=function(){l.readyState==4&&f(l)};if(l.readyState!=4)h?l.send(h):l.send()}}var s=[],E="inherit",o=null;o=false;try{if(window.parent!=window)o=true}catch(L){o=true}if(o&&location.hash.indexOf(hash)==0){window.opera.addEventListener("BeforeEventListener.DOMContentLoaded",A,false);window.opera.addEventListener("BeforeEventListener.load",A,false);window.opera.addEventListener("BeforeEventListener.message",A,false);o=location.hash.substr(hash.length);var v="";if(document&&
document.documentElement)if(v=C(document.documentElement.innerHTML))v=v.join("|");o=msgPrefix+"\n"+encodeURIComponent(v)+"\n"+o;J(o,window.parent.document,window.parent)}else{(function(){function e(m){str="";for(j=0;j<=3;j++)str+=t.charAt(m>>j*8+4&15)+t.charAt(m>>j*8&15);return str}function f(m,l){var p=(m&65535)+(l&65535);return(m>>16)+(l>>16)+(p>>16)<<16|p&65535}function g(m,l,p,q,r,u){m=f(f(l,m),f(q,u));return f(m<<r|m>>>32-r,p)}function k(m,l,p,q,r,u,w){return g(l&p|~l&q,m,l,r,u,w)}function h(m,
l,p,q,r,u,w){return g(l&q|p&~q,m,l,r,u,w)}function n(m,l,p,q,r,u,w){return g(p^(l|~q),m,l,r,u,w)}var t="0123456789abcdef";G=function(m){nblk=(m.length+8>>6)+1;blks=new Array(nblk*16);for(i=0;i<nblk*16;i++)blks[i]=0;for(i=0;i<m.length;i++)blks[i>>2]|=m.charCodeAt(i)<<i%4*8;blks[i>>2]|=128<<i%4*8;blks[nblk*16-2]=m.length*8;x=blks;a=1732584193;b=-271733879;c=-1732584194;d=271733878;for(i=0;i<x.length;i+=16){olda=a;oldb=b;oldc=c;oldd=d;a=k(a,b,c,d,x[i+0],7,-680876936);d=k(d,a,b,c,x[i+1],12,-389564586);
c=k(c,d,a,b,x[i+2],17,606105819);b=k(b,c,d,a,x[i+3],22,-1044525330);a=k(a,b,c,d,x[i+4],7,-176418897);d=k(d,a,b,c,x[i+5],12,1200080426);c=k(c,d,a,b,x[i+6],17,-1473231341);b=k(b,c,d,a,x[i+7],22,-45705983);a=k(a,b,c,d,x[i+8],7,1770035416);d=k(d,a,b,c,x[i+9],12,-1958414417);c=k(c,d,a,b,x[i+10],17,-42063);b=k(b,c,d,a,x[i+11],22,-1990404162);a=k(a,b,c,d,x[i+12],7,1804603682);d=k(d,a,b,c,x[i+13],12,-40341101);c=k(c,d,a,b,x[i+14],17,-1502002290);b=k(b,c,d,a,x[i+15],22,1236535329);a=h(a,b,c,d,x[i+1],5,-165796510);
d=h(d,a,b,c,x[i+6],9,-1069501632);c=h(c,d,a,b,x[i+11],14,643717713);b=h(b,c,d,a,x[i+0],20,-373897302);a=h(a,b,c,d,x[i+5],5,-701558691);d=h(d,a,b,c,x[i+10],9,38016083);c=h(c,d,a,b,x[i+15],14,-660478335);b=h(b,c,d,a,x[i+4],20,-405537848);a=h(a,b,c,d,x[i+9],5,568446438);d=h(d,a,b,c,x[i+14],9,-1019803690);c=h(c,d,a,b,x[i+3],14,-187363961);b=h(b,c,d,a,x[i+8],20,1163531501);a=h(a,b,c,d,x[i+13],5,-1444681467);d=h(d,a,b,c,x[i+2],9,-51403784);c=h(c,d,a,b,x[i+7],14,1735328473);b=h(b,c,d,a,x[i+12],20,-1926607734);
a=g(b^c^d,a,b,x[i+5],4,-378558);d=g(a^b^c,d,a,x[i+8],11,-2022574463);c=g(d^a^b,c,d,x[i+11],16,1839030562);b=g(c^d^a,b,c,x[i+14],23,-35309556);a=g(b^c^d,a,b,x[i+1],4,-1530992060);d=g(a^b^c,d,a,x[i+4],11,1272893353);c=g(d^a^b,c,d,x[i+7],16,-155497632);b=g(c^d^a,b,c,x[i+10],23,-1094730640);a=g(b^c^d,a,b,x[i+13],4,681279174);d=g(a^b^c,d,a,x[i+0],11,-358537222);c=g(d^a^b,c,d,x[i+3],16,-722521979);b=g(c^d^a,b,c,x[i+6],23,76029189);a=g(b^c^d,a,b,x[i+9],4,-640364487);d=g(a^b^c,d,a,x[i+12],11,-421815835);
c=g(d^a^b,c,d,x[i+15],16,530742520);b=g(c^d^a,b,c,x[i+2],23,-995338651);a=n(a,b,c,d,x[i+0],6,-198630844);d=n(d,a,b,c,x[i+7],10,1126891415);c=n(c,d,a,b,x[i+14],15,-1416354905);b=n(b,c,d,a,x[i+5],21,-57434055);a=n(a,b,c,d,x[i+12],6,1700485571);d=n(d,a,b,c,x[i+3],10,-1894986606);c=n(c,d,a,b,x[i+10],15,-1051523);b=n(b,c,d,a,x[i+1],21,-2054922799);a=n(a,b,c,d,x[i+8],6,1873313359);d=n(d,a,b,c,x[i+15],10,-30611744);c=n(c,d,a,b,x[i+6],15,-1560198380);b=n(b,c,d,a,x[i+13],21,1309151649);a=n(a,b,c,d,x[i+4],
6,-145523070);d=n(d,a,b,c,x[i+11],10,-1120210379);c=n(c,d,a,b,x[i+2],15,718787259);b=n(b,c,d,a,x[i+9],21,-343485551);a=f(a,olda);b=f(b,oldb);c=f(c,oldc);d=f(d,oldd)}return e(a)+e(b)+e(c)+e(d)}})();if(location.href.indexOf("http://img.mail.ru/r/video/player_full_size.swf")!=-1&&location.search.indexOf("par=")!=-1){E="center";o=function(){var e=y(location.href);if(e){z(e,"",document.body?document.body:document.documentElement);B();if((e=document.getElementsByTagName("embed"))&&e.length>0){e[0].setAttribute("width",
"640",false);e[0].setAttribute("height","385",false);e[0].setAttribute("style","display: block; margin: 0 auto;",false)}}}}else o=function(){for(var e=false,f=document.getElementsByTagName("embed"),g=0;g<f.length;g++){var k=f[g].getAttribute("src",false);if(k)if(k=y(k)){e=true;z(k,"",f[g].parentNode.parentNode)}}if(!e&&window.flashvars&&flashvars.movieSrc){e=true;z(F(flashvars.movieSrc),"",null)}if(e)B();else{e="";if(window.userAndFotoInfo&&window.userAndFotoInfo.title)e=window.userAndFotoInfo.title;
f="";if(window.DefswfURL)f=y(window.DefswfURL);if(!f){k=document.getElementsByTagName("param");for(g=0;g<k.length;g++)if(k[g].value)if(f=y(k[g].value))break}if(f){z(f,e,null);B()}}};(function(e){(typeof window.opera.version=="function"&&window.opera.version()>=10?true:false)?window.addEventListener("message",e,false):document.addEventListener("message",e,false)})(function(e){if(e.data&&e.data.indexOf(msgPrefix)==0){var f=e.data.split("\n");if(f.length==0)return false;if(f[0]==msgPrefix){if(f.length>
2){e=decodeURIComponent(f[2]);if(s[e]){params=decodeURIComponent(f[1]);if((params=params.split("|"))&&params.length>2){f=s[e][0];key=params[0];srv=params[1];hd=params[2];if(key&&srv){key=H(key);f+="?k="+key;if(srv)f+="&"+srv;D(f,"",hd,s[e][1])}}}e++;s.length>e&&I(e)}(e=document.getElementById(frameId))&&e.parentNode.removeChild(e)}}});if(o)(typeof window.opera.version=="function"&&window.opera.version()>=9?true:false)?document.addEventListener("DOMContentLoaded",o,false):document.addEventListener("load",
o,false)}
})();