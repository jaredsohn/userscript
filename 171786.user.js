// ==UserScript==
// @name         mb. EDIT RECORDINGS
// @version      2013.625.1247
// @description  musicbrainz.org release page: Add an edit link to the recordings and allow some editing inline.
// @namespace    http://userscripts.org/scripts/show/171786
// @author       Mathieu Arnold (mat/mat813)
// @licence      CC BY-NC-SA 3.0 FR (http://creativecommons.org/licenses/by-nc-sa/3.0/fr/)
// @since        2013.06.24.
// @grant        none
// @include      *://*musicbrainz.org/release/*
// @exclude      *://*musicbrainz.org/release/add
// @exclude      *://*musicbrainz.org/release/add?artist*
// @exclude      *://*musicbrainz.org/release/add?release-group*
// @exclude      *://*musicbrainz.org/release/*annotation*
// @exclude      *://*musicbrainz.org/release/*cover-art*
// @exclude      *://*musicbrainz.org/release/*/relationships
// @exclude      *://*musicbrainz.org/release/*/discids
// @exclude      *://*musicbrainz.org/release/*/tags
// @exclude      *://*musicbrainz.org/release/*/details
// @exclude      *://*musicbrainz.org/release/*/edit
// @exclude      *://blog.musicbrainz.org*
// @exclude      *://bugs.musicbrainz.org*
// @exclude      *://forums.musicbrainz.org*
// @exclude      *://lists.musicbrainz.org*
// @exclude      *://tickets.musicbrainz.org*
// @exclude      *://wiki.musicbrainz.org*
// @run-at       document-end
// ==/UserScript==
// Generated by CoffeeScript 1.3.3
(function() {
  var addAfter, createA, editRecordingText, getRelMBID, rec, relMBID, s, track, tracksHtml, _i, _len;

  editRecordingText = "edit";

  getRelMBID = function() {
    var mbid;
    mbid = self.location.href.match(/musicbrainz\.org\/[^/]+\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i);
    if (mbid) {
      return mbid[1];
    } else {
      return null;
    }
  };

  addAfter = function(n, e) {
    if (n && e) {
      if (e.nextSibling) {
        return e.parentNode.insertBefore(n, e.nextSibling);
      } else {
        return e.parentNode.appendChild(n);
      }
    } else {
      return null;
    }
  };

  createA = function(text, link, title, target) {
    var a;
    a = document.createElement("a");
    if (link) {
      a.setAttribute("href", link);
    } else {
      a.style.setProperty("cursor", "pointer");
    }
    if (typeof text === "string") {
      a.appendChild(document.createTextNode(text));
    } else {
      a.appendChild(text);
    }
    if (title) {
      a.setAttribute("title", title);
    }
    if (target) {
      a.setAttribute("target", target);
    }
    return a;
  };

  relMBID = getRelMBID();

  if (relMBID && (tracksHtml = document.querySelectorAll("div#content tbody[about^='[mbz:release/'] tr[typeof='mo:Track']")).length > 0) {
    for (_i = 0, _len = tracksHtml.length; _i < _len; _i++) {
      track = tracksHtml[_i];
      if (rec = track.querySelector("a[rel='mo:publication_of']")) {
        s = document.createElement("span");
        s.style.setProperty('float', 'right');
        s.style.setProperty('font-size', '80%');
        s.appendChild(document.createTextNode("("));
        s.appendChild(createA(editRecordingText, rec.getAttribute("href") + "/edit", "edit this recording"));
        s.appendChild(document.createTextNode(")"));
        addAfter(s, rec);
      }
    }
  }

}).call(this);
